cscope 15 $HOME/MUFIT/mainline/original -q 0000004814 0000799734
	@fs/f2fs/acl.c

15 
	~<lšux/f2fs_fs.h
>

16 
	~"f2fs.h
"

17 
	~"x©Œ.h
"

18 
	~"aş.h
"

20 
šlše
 
size_t
 
	$f2fs_aş_size
(
couÁ
)

22 ià(
couÁ
 <= 4) {

23  (
f2fs_aş_h—d”
) +

24 
couÁ
 * (
f2fs_aş_’Œy_shÜt
);

26  (
f2fs_aş_h—d”
) +

27 4 * (
f2fs_aş_’Œy_shÜt
) +

28 (
couÁ
 - 4è* (
f2fs_aş_’Œy
);

30 
	}
}

32 
šlše
 
	$f2fs_aş_couÁ
(
size_t
 
size
)

34 
ssize_t
 
s
;

35 
size
 -ğ(
f2fs_aş_h—d”
);

36 
s
 = 
size
 - 4 * (
f2fs_aş_’Œy_shÜt
);

37 ià(
s
 < 0) {

38 ià(
size
 % (
f2fs_aş_’Œy_shÜt
))

40  
size
 / (
f2fs_aş_’Œy_shÜt
);

42 ià(
s
 % (
f2fs_aş_’Œy
))

44  
s
 / (
f2fs_aş_’Œy
) + 4;

46 
	}
}

48 
posix_aş
 *
	$f2fs_aş_äom_disk
(cÚ¡ *
v®ue
, 
size_t
 
size
)

50 
i
, 
couÁ
;

51 
posix_aş
 *
aş
;

52 
f2fs_aş_h—d”
 *
hdr
 = (f2fs_aş_h—d” *)
v®ue
;

53 
f2fs_aş_’Œy
 *
’Œy
 = (f2fs_aş_’Œy *)(
hdr
 + 1);

54 cÚ¡ *
’d
 = 
v®ue
 + 
size
;

56 ià(
hdr
->
a_v”siÚ
 !ğ
	`ıu_to_Ë32
(
F2FS_ACL_VERSION
))

57  
	`ERR_PTR
(-
EINVAL
);

59 
couÁ
 = 
	`f2fs_aş_couÁ
(
size
);

60 ià(
couÁ
 < 0)

61  
	`ERR_PTR
(-
EINVAL
);

62 ià(
couÁ
 == 0)

63  
NULL
;

65 
aş
 = 
	`posix_aş_®loc
(
couÁ
, 
GFP_NOFS
);

66 ià(!
aş
)

67  
	`ERR_PTR
(-
ENOMEM
);

69 
i
 = 0; i < 
couÁ
; i++) {

71 ià((*)
’Œy
 > 
’d
)

72 
ç
;

74 
aş
->
a_’Œ›s
[
i
].
e_g
 = 
	`Ë16_to_ıu
(
’Œy
->e_tag);

75 
aş
->
a_’Œ›s
[
i
].
e_³rm
 = 
	`Ë16_to_ıu
(
’Œy
->e_perm);

77 
aş
->
a_’Œ›s
[
i
].
e_g
) {

78 
ACL_USER_OBJ
:

79 
ACL_GROUP_OBJ
:

80 
ACL_MASK
:

81 
ACL_OTHER
:

82 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

83 (
f2fs_aş_’Œy_shÜt
));

86 
ACL_USER
:

87 
aş
->
a_’Œ›s
[
i
].
e_uid
 =

88 
	`make_kuid
(&
š™_u£r_ns
,

89 
	`Ë32_to_ıu
(
’Œy
->
e_id
));

90 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

91 (
f2fs_aş_’Œy
));

93 
ACL_GROUP
:

94 
aş
->
a_’Œ›s
[
i
].
e_gid
 =

95 
	`make_kgid
(&
š™_u£r_ns
,

96 
	`Ë32_to_ıu
(
’Œy
->
e_id
));

97 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

98 (
f2fs_aş_’Œy
));

101 
ç
;

104 ià((*)
’Œy
 !ğ
’d
)

105 
ç
;

106  
aş
;

107 
ç
:

108 
	`posix_aş_»Ëa£
(
aş
);

109  
	`ERR_PTR
(-
EINVAL
);

110 
	}
}

112 *
	$f2fs_aş_to_disk
(
f2fs_sb_šfo
 *
sbi
,

113 cÚ¡ 
posix_aş
 *
aş
, 
size_t
 *
size
)

115 
f2fs_aş_h—d”
 *
f2fs_aş
;

116 
f2fs_aş_’Œy
 *
’Œy
;

117 
i
;

119 
f2fs_aş
 = 
	`f2fs_km®loc
(
sbi
, (
f2fs_aş_h—d”
) +

120 
aş
->
a_couÁ
 * (
f2fs_aş_’Œy
),

121 
GFP_NOFS
);

122 ià(!
f2fs_aş
)

123  
	`ERR_PTR
(-
ENOMEM
);

125 
f2fs_aş
->
a_v”siÚ
 = 
	`ıu_to_Ë32
(
F2FS_ACL_VERSION
);

126 
’Œy
 = (
f2fs_aş_’Œy
 *)(
f2fs_aş
 + 1);

128 
i
 = 0; i < 
aş
->
a_couÁ
; i++) {

130 
’Œy
->
e_g
 = 
	`ıu_to_Ë16
(
aş
->
a_’Œ›s
[
i
].e_tag);

131 
’Œy
->
e_³rm
 = 
	`ıu_to_Ë16
(
aş
->
a_’Œ›s
[
i
].e_perm);

133 
aş
->
a_’Œ›s
[
i
].
e_g
) {

134 
ACL_USER
:

135 
’Œy
->
e_id
 = 
	`ıu_to_Ë32
(

136 
	`äom_kuid
(&
š™_u£r_ns
,

137 
aş
->
a_’Œ›s
[
i
].
e_uid
));

138 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

139 (
f2fs_aş_’Œy
));

141 
ACL_GROUP
:

142 
’Œy
->
e_id
 = 
	`ıu_to_Ë32
(

143 
	`äom_kgid
(&
š™_u£r_ns
,

144 
aş
->
a_’Œ›s
[
i
].
e_gid
));

145 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

146 (
f2fs_aş_’Œy
));

148 
ACL_USER_OBJ
:

149 
ACL_GROUP_OBJ
:

150 
ACL_MASK
:

151 
ACL_OTHER
:

152 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

153 (
f2fs_aş_’Œy_shÜt
));

156 
ç
;

159 *
size
 = 
	`f2fs_aş_size
(
aş
->
a_couÁ
);

160  (*)
f2fs_aş
;

162 
ç
:

163 
	`kä“
(
f2fs_aş
);

164  
	`ERR_PTR
(-
EINVAL
);

165 
	}
}

167 
posix_aş
 *
	$__f2fs_g‘_aş
(
šode
 *šode, 
ty³
,

168 
·ge
 *
d·ge
)

170 
Çme_šdex
 = 
F2FS_XATTR_INDEX_POSIX_ACL_DEFAULT
;

171 *
v®ue
 = 
NULL
;

172 
posix_aş
 *
aş
;

173 
»tv®
;

175 ià(
ty³
 =ğ
ACL_TYPE_ACCESS
)

176 
Çme_šdex
 = 
F2FS_XATTR_INDEX_POSIX_ACL_ACCESS
;

178 
»tv®
 = 
	`f2fs_g‘x©Œ
(
šode
, 
Çme_šdex
, "", 
NULL
, 0, 
d·ge
);

179 ià(
»tv®
 > 0) {

180 
v®ue
 = 
	`f2fs_km®loc
(
	`F2FS_I_SB
(
šode
), 
»tv®
, 
GFP_F2FS_ZERO
);

181 ià(!
v®ue
)

182  
	`ERR_PTR
(-
ENOMEM
);

183 
»tv®
 = 
	`f2fs_g‘x©Œ
(
šode
, 
Çme_šdex
, "", 
v®ue
,

184 
»tv®
, 
d·ge
);

187 ià(
»tv®
 > 0)

188 
aş
 = 
	`f2fs_aş_äom_disk
(
v®ue
, 
»tv®
);

189 ià(
»tv®
 =ğ-
ENODATA
)

190 
aş
 = 
NULL
;

192 
aş
 = 
	`ERR_PTR
(
»tv®
);

193 
	`kä“
(
v®ue
);

195  
aş
;

196 
	}
}

198 
posix_aş
 *
	$f2fs_g‘_aş
(
šode
 *šode, 
ty³
)

200  
	`__f2fs_g‘_aş
(
šode
, 
ty³
, 
NULL
);

201 
	}
}

203 
	$__f2fs_£t_aş
(
šode
 *šode, 
ty³
,

204 
posix_aş
 *
aş
, 
·ge
 *
age
)

206 
Çme_šdex
;

207 *
v®ue
 = 
NULL
;

208 
size_t
 
size
 = 0;

209 
”rÜ
;

210 
umode_t
 
mode
 = 
šode
->
i_mode
;

212 
ty³
) {

213 
ACL_TYPE_ACCESS
:

214 
Çme_šdex
 = 
F2FS_XATTR_INDEX_POSIX_ACL_ACCESS
;

215 ià(
aş
 && !
age
) {

216 
”rÜ
 = 
	`posix_aş_upd©e_mode
(
šode
, &
mode
, &
aş
);

217 ià(
”rÜ
)

218  
”rÜ
;

219 
	`£t_aş_šode
(
šode
, 
mode
);

223 
ACL_TYPE_DEFAULT
:

224 
Çme_šdex
 = 
F2FS_XATTR_INDEX_POSIX_ACL_DEFAULT
;

225 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

226  
aş
 ? -
EACCES
 : 0;

230  -
EINVAL
;

233 ià(
aş
) {

234 
v®ue
 = 
	`f2fs_aş_to_disk
(
	`F2FS_I_SB
(
šode
), 
aş
, &
size
);

235 ià(
	`IS_ERR
(
v®ue
)) {

236 
	`ş—r_šode_æag
(
šode
, 
FI_ACL_MODE
);

237  
	`PTR_ERR
(
v®ue
);

241 
”rÜ
 = 
	`f2fs_£tx©Œ
(
šode
, 
Çme_šdex
, "", 
v®ue
, 
size
, 
age
, 0);

243 
	`kä“
(
v®ue
);

244 ià(!
”rÜ
)

245 
	`£t_ÿched_aş
(
šode
, 
ty³
, 
aş
);

247 
	`ş—r_šode_æag
(
šode
, 
FI_ACL_MODE
);

248  
”rÜ
;

249 
	}
}

251 
	$f2fs_£t_aş
(
šode
 *šode, 
posix_aş
 *
aş
, 
ty³
)

253 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
))))

254  -
EIO
;

256  
	`__f2fs_£t_aş
(
šode
, 
ty³
, 
aş
, 
NULL
);

257 
	}
}

263 
posix_aş
 *
	$f2fs_aş_şÚe
(cÚ¡ 
posix_aş
 *
aş
,

264 
gå_t
 
æags
)

266 
posix_aş
 *
şÚe
 = 
NULL
;

268 ià(
aş
) {

269 
size
 = (
posix_aş
è+ 
aş
->
a_couÁ
 *

270 (
posix_aş_’Œy
);

271 
şÚe
 = 
	`kmemdup
(
aş
, 
size
, 
æags
);

272 ià(
şÚe
)

273 
	`»fcouÁ_£t
(&
şÚe
->
a_»fcouÁ
, 1);

275  
şÚe
;

276 
	}
}

278 
	$f2fs_aş_ü—‹_masq
(
posix_aş
 *
aş
, 
umode_t
 *
mode_p
)

280 
posix_aş_’Œy
 *
·
, *
³
;

281 
posix_aş_’Œy
 *
group_obj
 = 
NULL
, *
mask_obj
 = NULL;

282 
umode_t
 
mode
 = *
mode_p
;

283 
nÙ_equiv
 = 0;

287 
	`FOREACH_ACL_ENTRY
(
·
, 
aş
, 
³
) {

288 
·
->
e_g
) {

289 
ACL_USER_OBJ
:

290 
·
->
e_³rm
 &ğ(
mode
 >> 6è| ~
S_IRWXO
;

291 
mode
 &ğ(
·
->
e_³rm
 << 6è| ~
S_IRWXU
;

294 
ACL_USER
:

295 
ACL_GROUP
:

296 
nÙ_equiv
 = 1;

299 
ACL_GROUP_OBJ
:

300 
group_obj
 = 
·
;

303 
ACL_OTHER
:

304 
·
->
e_³rm
 &ğ
mode
 | ~
S_IRWXO
;

305 
mode
 &ğ
·
->
e_³rm
 | ~
S_IRWXO
;

308 
ACL_MASK
:

309 
mask_obj
 = 
·
;

310 
nÙ_equiv
 = 1;

314  -
EIO
;

318 ià(
mask_obj
) {

319 
mask_obj
->
e_³rm
 &ğ(
mode
 >> 3è| ~
S_IRWXO
;

320 
mode
 &ğ(
mask_obj
->
e_³rm
 << 3è| ~
S_IRWXG
;

322 ià(!
group_obj
)

323  -
EIO
;

324 
group_obj
->
e_³rm
 &ğ(
mode
 >> 3è| ~
S_IRWXO
;

325 
mode
 &ğ(
group_obj
->
e_³rm
 << 3è| ~
S_IRWXG
;

328 *
mode_p
 = (*mode_°& ~
S_IRWXUGO
è| 
mode
;

329  
nÙ_equiv
;

330 
	}
}

332 
	$f2fs_aş_ü—‹
(
šode
 *
dœ
, 
umode_t
 *
mode
,

333 
posix_aş
 **
deçuÉ_aş
, posix_aş **
aş
,

334 
·ge
 *
d·ge
)

336 
posix_aş
 *
p
;

337 
posix_aş
 *
şÚe
;

338 
»t
;

340 *
aş
 = 
NULL
;

341 *
deçuÉ_aş
 = 
NULL
;

343 ià(
	`S_ISLNK
(*
mode
è|| !
	`IS_POSIXACL
(
dœ
))

346 
p
 = 
	`__f2fs_g‘_aş
(
dœ
, 
ACL_TYPE_DEFAULT
, 
d·ge
);

347 ià(!
p
 ||… =ğ
	`ERR_PTR
(-
EOPNOTSUPP
)) {

348 *
mode
 &ğ~
	`cu¼’t_umask
();

351 ià(
	`IS_ERR
(
p
))

352  
	`PTR_ERR
(
p
);

354 
şÚe
 = 
	`f2fs_aş_şÚe
(
p
, 
GFP_NOFS
);

355 ià(!
şÚe
)

356 
no_mem
;

358 
»t
 = 
	`f2fs_aş_ü—‹_masq
(
şÚe
, 
mode
);

359 ià(
»t
 < 0)

360 
no_mem_şÚe
;

362 ià(
»t
 == 0)

363 
	`posix_aş_»Ëa£
(
şÚe
);

365 *
aş
 = 
şÚe
;

367 ià(!
	`S_ISDIR
(*
mode
))

368 
	`posix_aş_»Ëa£
(
p
);

370 *
deçuÉ_aş
 = 
p
;

374 
no_mem_şÚe
:

375 
	`posix_aş_»Ëa£
(
şÚe
);

376 
no_mem
:

377 
	`posix_aş_»Ëa£
(
p
);

378  -
ENOMEM
;

379 
	}
}

381 
	$f2fs_š™_aş
(
šode
 *šode, šod*
dœ
, 
·ge
 *
age
,

382 
·ge
 *
d·ge
)

384 
posix_aş
 *
deçuÉ_aş
 = 
NULL
, *
aş
 = NULL;

385 
”rÜ
 = 0;

387 
”rÜ
 = 
	`f2fs_aş_ü—‹
(
dœ
, &
šode
->
i_mode
, &
deçuÉ_aş
, &
aş
, 
d·ge
);

388 ià(
”rÜ
)

389  
”rÜ
;

391 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

393 ià(
deçuÉ_aş
) {

394 
”rÜ
 = 
	`__f2fs_£t_aş
(
šode
, 
ACL_TYPE_DEFAULT
, 
deçuÉ_aş
,

395 
age
);

396 
	`posix_aş_»Ëa£
(
deçuÉ_aş
);

398 ià(
aş
) {

399 ià(!
”rÜ
)

400 
”rÜ
 = 
	`__f2fs_£t_aş
(
šode
, 
ACL_TYPE_ACCESS
, 
aş
,

401 
age
);

402 
	`posix_aş_»Ëa£
(
aş
);

405  
”rÜ
;

406 
	}
}

	@fs/f2fs/acl.h

15 #iâdeà
__F2FS_ACL_H__


16 
	#__F2FS_ACL_H__


	)

18 
	~<lšux/posix_aş_x©Œ.h
>

20 
	#F2FS_ACL_VERSION
 0x0001

	)

22 
	sf2fs_aş_’Œy
 {

23 
__Ë16
 
	me_g
;

24 
__Ë16
 
	me_³rm
;

25 
__Ë32
 
	me_id
;

28 
	sf2fs_aş_’Œy_shÜt
 {

29 
__Ë16
 
	me_g
;

30 
__Ë16
 
	me_³rm
;

33 
	sf2fs_aş_h—d”
 {

34 
__Ë32
 
	ma_v”siÚ
;

37 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


39 
posix_aş
 *
f2fs_g‘_aş
(
šode
 *, );

40 
f2fs_£t_aş
(
šode
 *, 
posix_aş
 *, );

41 
f2fs_š™_aş
(
šode
 *, šod*, 
·ge
 *,

42 
·ge
 *);

44 
	#f2fs_g‘_aş
 
NULL


	)

45 
	#f2fs_£t_aş
 
NULL


	)

47 
šlše
 
	$f2fs_š™_aş
(
šode
 *šode, šod*
dœ
,

48 
·ge
 *
age
, ·g*
d·ge
)

51 
	}
}

	@fs/f2fs/checkpoint.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/bio.h
>

13 
	~<lšux/m·ge.h
>

14 
	~<lšux/wr™eback.h
>

15 
	~<lšux/blkdev.h
>

16 
	~<lšux/f2fs_fs.h
>

17 
	~<lšux/·gevec.h
>

18 
	~<lšux/sw­.h
>

20 
	~"f2fs.h
"

21 
	~"node.h
"

22 
	~"£gm’t.h
"

23 
	~"Œaû.h
"

24 
	~<Œaû/ev’ts/f2fs.h
>

26 
kmem_ÿche
 *
	gšo_’Œy_¦ab
;

27 
kmem_ÿche
 *
	gf2fs_šode_’Œy_¦ab
;

29 
	$f2fs_¡İ_checkpošt
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
’d_io
)

31 
	`£t_ck±_æags
(
sbi
, 
CP_ERROR_FLAG
);

32 ià(!
’d_io
)

33 
	`f2fs_æush_m”ged_wr™es
(
sbi
);

34 
	}
}

39 
·ge
 *
	$f2fs_g¿b_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
)

41 
add»ss_¥aû
 *
m­pšg
 = 
	`META_MAPPING
(
sbi
);

42 
·ge
 *·gğ
NULL
;

43 
»³©
:

44 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
m­pšg
, 
šdex
, 
çl£
);

45 ià(!
·ge
) {

46 
	`cÚd_»sched
();

47 
»³©
;

49 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
META
, 
Œue
);

50 ià(!
	`PageU±od©e
(
·ge
))

51 
	`S‘PageU±od©e
(
·ge
);

52  
·ge
;

53 
	}
}

58 
·ge
 *
	$__g‘_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
,

59 
boŞ
 
is_m‘a
)

61 
add»ss_¥aû
 *
m­pšg
 = 
	`META_MAPPING
(
sbi
);

62 
·ge
 *page;

63 
f2fs_io_šfo
 
fio
 = {

64 .
sbi
 = sbi,

65 .
ty³
 = 
META
,

66 .
İ
 = 
REQ_OP_READ
,

67 .
İ_æags
 = 
REQ_META
 | 
REQ_PRIO
,

68 .
Şd_blkaddr
 = 
šdex
,

69 .
Ãw_blkaddr
 = 
šdex
,

70 .
’üy±ed_·ge
 = 
NULL
,

71 .
is_m‘a
 = is_meta,

74 ià(
	`uÆik–y
(!
is_m‘a
))

75 
fio
.
İ_æags
 &ğ~
REQ_META
;

76 
»³©
:

77 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
m­pšg
, 
šdex
, 
çl£
);

78 ià(!
·ge
) {

79 
	`cÚd_»sched
();

80 
»³©
;

82 ià(
	`PageU±od©e
(
·ge
))

83 
out
;

85 
fio
.
·ge
 =…age;

87 ià(
	`f2fs_subm™_·ge_bio
(&
fio
)) {

88 
	`f2fs_put_·ge
(
·ge
, 1);

89 
»³©
;

92 
	`lock_·ge
(
·ge
);

93 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

94 
	`f2fs_put_·ge
(
·ge
, 1);

95 
»³©
;

103 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

104 
	`mem£t
(
	`·ge_add»ss
(
·ge
), 0, 
PAGE_SIZE
);

105 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

107 
out
:

108  
·ge
;

109 
	}
}

111 
·ge
 *
	$f2fs_g‘_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
)

113  
	`__g‘_m‘a_·ge
(
sbi
, 
šdex
, 
Œue
);

114 
	}
}

117 
·ge
 *
	$f2fs_g‘_tmp_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
)

119  
	`__g‘_m‘a_·ge
(
sbi
, 
šdex
, 
çl£
);

120 
	}
}

122 
boŞ
 
	$f2fs_is_v®id_m‘a_blkaddr
(
f2fs_sb_šfo
 *
sbi
,

123 
block_t
 
blkaddr
, 
ty³
)

125 
ty³
) {

126 
META_NAT
:

128 
META_SIT
:

129 ià(
	`uÆik–y
(
blkaddr
 >ğ
	`SIT_BLK_CNT
(
sbi
)))

130  
çl£
;

132 
META_SSA
:

133 ià(
	`uÆik–y
(
blkaddr
 >ğ
	`MAIN_BLKADDR
(
sbi
) ||

134 
blkaddr
 < 
	`SM_I
(
sbi
)->
s§_blkaddr
))

135  
çl£
;

137 
META_CP
:

138 ià(
	`uÆik–y
(
blkaddr
 >ğ
	`SIT_I
(
sbi
)->
s™_ba£_addr
 ||

139 
blkaddr
 < 
	`__¡¬t_ı_addr
(
sbi
)))

140  
çl£
;

142 
META_POR
:

143 ià(
	`uÆik–y
(
blkaddr
 >ğ
	`MAX_BLKADDR
(
sbi
) ||

144 
blkaddr
 < 
	`MAIN_BLKADDR
(
sbi
)))

145  
çl£
;

148 
	`BUG
();

151  
Œue
;

152 
	}
}

157 
	$f2fs_¿_m‘a_·ges
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t
, 
Ä·ges
,

158 
ty³
, 
boŞ
 
sync
)

160 
·ge
 *page;

161 
block_t
 
blkno
 = 
¡¬t
;

162 
f2fs_io_šfo
 
fio
 = {

163 .
sbi
 = sbi,

164 .
ty³
 = 
META
,

165 .
İ
 = 
REQ_OP_READ
,

166 .
İ_æags
 = 
sync
 ? (
REQ_META
 | 
REQ_PRIO
è: 
REQ_RAHEAD
,

167 .
’üy±ed_·ge
 = 
NULL
,

168 .
š_li¡
 = 
çl£
,

169 .
is_m‘a
 = (
ty³
 !ğ
META_POR
),

171 
blk_¶ug
 
¶ug
;

173 ià(
	`uÆik–y
(
ty³
 =ğ
META_POR
))

174 
fio
.
İ_æags
 &ğ~
REQ_META
;

176 
	`blk_¡¬t_¶ug
(&
¶ug
);

177 ; 
Ä·ges
-- > 0; 
blkno
++) {

179 ià(!
	`f2fs_is_v®id_m‘a_blkaddr
(
sbi
, 
blkno
, 
ty³
))

180 
out
;

182 
ty³
) {

183 
META_NAT
:

184 ià(
	`uÆik–y
(
blkno
 >=

185 
	`NAT_BLOCK_OFFSET
(
	`NM_I
(
sbi
)->
max_nid
)))

186 
blkno
 = 0;

188 
fio
.
Ãw_blkaddr
 = 
	`cu¼’t_Çt_addr
(
sbi
,

189 
blkno
 * 
NAT_ENTRY_PER_BLOCK
);

191 
META_SIT
:

193 
fio
.
Ãw_blkaddr
 = 
	`cu¼’t_s™_addr
(
sbi
,

194 
blkno
 * 
SIT_ENTRY_PER_BLOCK
);

196 
META_SSA
:

197 
META_CP
:

198 
META_POR
:

199 
fio
.
Ãw_blkaddr
 = 
blkno
;

202 
	`BUG
();

205 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`META_MAPPING
(
sbi
),

206 
fio
.
Ãw_blkaddr
, 
çl£
);

207 ià(!
·ge
)

209 ià(
	`PageU±od©e
(
·ge
)) {

210 
	`f2fs_put_·ge
(
·ge
, 1);

214 
fio
.
·ge
 =…age;

215 
	`f2fs_subm™_·ge_bio
(&
fio
);

216 
	`f2fs_put_·ge
(
·ge
, 0);

218 
out
:

219 
	`blk_fšish_¶ug
(&
¶ug
);

220  
blkno
 - 
¡¬t
;

221 
	}
}

223 
	$f2fs_¿_m‘a_·ges_cÚd
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
)

225 
·ge
 *page;

226 
boŞ
 
»adah—d
 = 
çl£
;

228 
·ge
 = 
	`fšd_g‘_·ge
(
	`META_MAPPING
(
sbi
), 
šdex
);

229 ià(!
·ge
 || !
	`PageU±od©e
(page))

230 
»adah—d
 = 
Œue
;

231 
	`f2fs_put_·ge
(
·ge
, 0);

233 ià(
»adah—d
)

234 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
šdex
, 
BIO_MAX_PAGES
, 
META_POR
, 
Œue
);

235 
	}
}

237 
	$__f2fs_wr™e_m‘a_·ge
(
·ge
 *page,

238 
wr™eback_cÚŒŞ
 *
wbc
,

239 
io¡©_ty³
 
io_ty³
)

241 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

243 
	`Œaû_f2fs_wr™•age
(
·ge
, 
META
);

245 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

246 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_META
);

247 
	`uÆock_·ge
(
·ge
);

250 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

251 
»dœty_out
;

252 ià(
wbc
->
fÜ_»şaim
 && 
·ge
->
šdex
 < 
	`GET_SUM_BLOCK
(
sbi
, 0))

253 
»dœty_out
;

255 
	`f2fs_do_wr™e_m‘a_·ge
(
sbi
, 
·ge
, 
io_ty³
);

256 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_META
);

258 ià(
wbc
->
fÜ_»şaim
)

259 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
sbi
, 
·ge
->
m­pšg
->
ho¡
,

260 0, 
·ge
->
šdex
, 
META
);

262 
	`uÆock_·ge
(
·ge
);

264 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

265 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
META
);

269 
»dœty_out
:

270 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

271  
AOP_WRITEPAGE_ACTIVATE
;

272 
	}
}

274 
	$f2fs_wr™e_m‘a_·ge
(
·ge
 *page,

275 
wr™eback_cÚŒŞ
 *
wbc
)

277  
	`__f2fs_wr™e_m‘a_·ge
(
·ge
, 
wbc
, 
FS_META_IO
);

278 
	}
}

280 
	$f2fs_wr™e_m‘a_·ges
(
add»ss_¥aû
 *
m­pšg
,

281 
wr™eback_cÚŒŞ
 *
wbc
)

283 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_M_SB
(
m­pšg
);

284 
diff
, 
wr™‹n
;

286 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

287 
sk_wr™e
;

290 ià(
wbc
->
fÜ_kupd©e
 ||

291 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
è< 
	`Ä_·ges_to_sk
(sbi, 
META
))

292 
sk_wr™e
;

295 ià(!
	`mu‹x_Œylock
(&
sbi
->
ı_mu‹x
))

296 
sk_wr™e
;

298 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
META
);

299 
diff
 = 
	`Ä_·ges_to_wr™e
(
sbi
, 
META
, 
wbc
);

300 
wr™‹n
 = 
	`f2fs_sync_m‘a_·ges
(
sbi
, 
META
, 
wbc
->
Ä_to_wr™e
, 
FS_META_IO
);

301 
	`mu‹x_uÆock
(&
sbi
->
ı_mu‹x
);

302 
wbc
->
Ä_to_wr™e
 = 
	`max
(()0, wbc->Ä_to_wr™- 
wr™‹n
 - 
diff
);

305 
sk_wr™e
:

306 
wbc
->
·ges_sk³d
 +ğ
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
);

307 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
META
);

309 
	}
}

311 
	$f2fs_sync_m‘a_·ges
(
f2fs_sb_šfo
 *
sbi
, 
·ge_ty³
 
ty³
,

312 
Ä_to_wr™e
, 
io¡©_ty³
 
io_ty³
)

314 
add»ss_¥aû
 *
m­pšg
 = 
	`META_MAPPING
(
sbi
);

315 
pgoff_t
 
šdex
 = 0, 
´ev
 = 
ULONG_MAX
;

316 
·gevec
 
pvec
;

317 
nwr™‹n
 = 0;

318 
Ä_·ges
;

319 
wr™eback_cÚŒŞ
 
wbc
 = {

320 .
fÜ_»şaim
 = 0,

322 
blk_¶ug
 
¶ug
;

324 
	`·gevec_š™
(&
pvec
);

326 
	`blk_¡¬t_¶ug
(&
¶ug
);

328 (
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
m­pšg
, &
šdex
,

329 
PAGECACHE_TAG_DIRTY
))) {

330 
i
;

332 
i
 = 0; i < 
Ä_·ges
; i++) {

333 
·ge
 *·gğ
pvec
.
·ges
[
i
];

335 ià(
´ev
 =ğ
ULONG_MAX
)

336 
´ev
 = 
·ge
->
šdex
 - 1;

337 ià(
Ä_to_wr™e
 !ğ
LONG_MAX
 && 
·ge
->
šdex
 !ğ
´ev
 + 1) {

338 
	`·gevec_»Ëa£
(&
pvec
);

339 
¡İ
;

342 
	`lock_·ge
(
·ge
);

344 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

345 
cÚtšue_uÆock
:

346 
	`uÆock_·ge
(
·ge
);

349 ià(!
	`PageDœty
(
·ge
)) {

351 
cÚtšue_uÆock
;

354 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
META
, 
Œue
);

356 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

357 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

358 
cÚtšue_uÆock
;

360 ià(
	`__f2fs_wr™e_m‘a_·ge
(
·ge
, &
wbc
, 
io_ty³
)) {

361 
	`uÆock_·ge
(
·ge
);

364 
nwr™‹n
++;

365 
´ev
 = 
·ge
->
šdex
;

366 ià(
	`uÆik–y
(
nwr™‹n
 >ğ
Ä_to_wr™e
))

369 
	`·gevec_»Ëa£
(&
pvec
);

370 
	`cÚd_»sched
();

372 
¡İ
:

373 ià(
nwr™‹n
)

374 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
ty³
);

376 
	`blk_fšish_¶ug
(&
¶ug
);

378  
nwr™‹n
;

379 
	}
}

381 
	$f2fs_£t_m‘a_·ge_dœty
(
·ge
 *page)

383 
	`Œaû_f2fs_£t_·ge_dœty
(
·ge
, 
META
);

385 ià(!
	`PageU±od©e
(
·ge
))

386 
	`S‘PageU±od©e
(
·ge
);

387 ià(!
	`PageDœty
(
·ge
)) {

388 
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

389 
	`šc_·ge_couÁ
(
	`F2FS_P_SB
(
·ge
), 
F2FS_DIRTY_META
);

390 
	`S‘PagePriv©e
(
·ge
);

391 
	`f2fs_Œaû_pid
(
·ge
);

395 
	}
}

397 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gf2fs_m‘a_aİs
 = {

398 .
wr™•age
 = 
f2fs_wr™e_m‘a_·ge
,

399 .
	gwr™•ages
 = 
f2fs_wr™e_m‘a_·ges
,

400 .
	g£t_·ge_dœty
 = 
f2fs_£t_m‘a_·ge_dœty
,

401 .
	gšv®id©•age
 = 
f2fs_šv®id©e_·ge
,

402 .
	g»Ëa£·ge
 = 
f2fs_»Ëa£_·ge
,

403 #ifdeà
CONFIG_MIGRATION


404 .
	gmig¿‹·ge
 = 
f2fs_mig¿‹_·ge
,

408 
	$__add_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
,

409 
devidx
, 
ty³
)

411 
šode_mªagem’t
 *
im
 = &
sbi
->im[
ty³
];

412 
šo_’Œy
 *
e
, *
tmp
;

414 
tmp
 = 
	`f2fs_kmem_ÿche_®loc
(
šo_’Œy_¦ab
, 
GFP_NOFS
);

416 
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
 | 
__GFP_NOFAIL
);

418 
	`¥š_lock
(&
im
->
šo_lock
);

419 
e
 = 
	`¿dix_Œ“_lookup
(&
im
->
šo_roÙ
, 
šo
);

420 ià(!
e
) {

421 
e
 = 
tmp
;

422 ià(
	`uÆik–y
(
	`¿dix_Œ“_š£¹
(&
im
->
šo_roÙ
, 
šo
, 
e
)))

423 
	`f2fs_bug_Ú
(
sbi
, 1);

425 
	`mem£t
(
e
, 0, (
šo_’Œy
));

426 
e
->
šo
 = ino;

428 
	`li¡_add_
(&
e
->
li¡
, &
im
->
šo_li¡
);

429 ià(
ty³
 !ğ
ORPHAN_INO
)

430 
im
->
šo_num
++;

433 ià(
ty³
 =ğ
FLUSH_INO
)

434 
	`f2fs_£t_b™
(
devidx
, (*)&
e
->
dœty_deviû
);

436 
	`¥š_uÆock
(&
im
->
šo_lock
);

437 
	`¿dix_Œ“_´–ßd_’d
();

439 ià(
e
 !ğ
tmp
)

440 
	`kmem_ÿche_ä“
(
šo_’Œy_¦ab
, 
tmp
);

441 
	}
}

443 
	$__»move_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
)

445 
šode_mªagem’t
 *
im
 = &
sbi
->im[
ty³
];

446 
šo_’Œy
 *
e
;

448 
	`¥š_lock
(&
im
->
šo_lock
);

449 
e
 = 
	`¿dix_Œ“_lookup
(&
im
->
šo_roÙ
, 
šo
);

450 ià(
e
) {

451 
	`li¡_d–
(&
e
->
li¡
);

452 
	`¿dix_Œ“_d–‘e
(&
im
->
šo_roÙ
, 
šo
);

453 
im
->
šo_num
--;

454 
	`¥š_uÆock
(&
im
->
šo_lock
);

455 
	`kmem_ÿche_ä“
(
šo_’Œy_¦ab
, 
e
);

458 
	`¥š_uÆock
(&
im
->
šo_lock
);

459 
	}
}

461 
	$f2fs_add_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
)

464 
	`__add_šo_’Œy
(
sbi
, 
šo
, 0, 
ty³
);

465 
	}
}

467 
	$f2fs_»move_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
)

470 
	`__»move_šo_’Œy
(
sbi
, 
šo
, 
ty³
);

471 
	}
}

474 
boŞ
 
	$f2fs_exi¡_wr™‹n_d©a
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
mode
)

476 
šode_mªagem’t
 *
im
 = &
sbi
->im[
mode
];

477 
šo_’Œy
 *
e
;

479 
	`¥š_lock
(&
im
->
šo_lock
);

480 
e
 = 
	`¿dix_Œ“_lookup
(&
im
->
šo_roÙ
, 
šo
);

481 
	`¥š_uÆock
(&
im
->
šo_lock
);

482  
e
 ? 
Œue
 : 
çl£
;

483 
	}
}

485 
	$f2fs_»Ëa£_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
®l
)

487 
šo_’Œy
 *
e
, *
tmp
;

488 
i
;

490 
i
 = 
®l
 ? 
ORPHAN_INO
 : 
APPEND_INO
; i < 
MAX_INO_ENTRY
; i++) {

491 
šode_mªagem’t
 *
im
 = &
sbi
->im[
i
];

493 
	`¥š_lock
(&
im
->
šo_lock
);

494 
	`li¡_fÜ_—ch_’Œy_§ã
(
e
, 
tmp
, &
im
->
šo_li¡
, 
li¡
) {

495 
	`li¡_d–
(&
e
->
li¡
);

496 
	`¿dix_Œ“_d–‘e
(&
im
->
šo_roÙ
, 
e
->
šo
);

497 
	`kmem_ÿche_ä“
(
šo_’Œy_¦ab
, 
e
);

498 
im
->
šo_num
--;

500 
	`¥š_uÆock
(&
im
->
šo_lock
);

502 
	}
}

504 
	$f2fs_£t_dœty_deviû
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
,

505 
devidx
, 
ty³
)

507 
	`__add_šo_’Œy
(
sbi
, 
šo
, 
devidx
, 
ty³
);

508 
	}
}

510 
boŞ
 
	$f2fs_is_dœty_deviû
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
,

511 
devidx
, 
ty³
)

513 
šode_mªagem’t
 *
im
 = &
sbi
->im[
ty³
];

514 
šo_’Œy
 *
e
;

515 
boŞ
 
is_dœty
 = 
çl£
;

517 
	`¥š_lock
(&
im
->
šo_lock
);

518 
e
 = 
	`¿dix_Œ“_lookup
(&
im
->
šo_roÙ
, 
šo
);

519 ià(
e
 && 
	`f2fs_‹¡_b™
(
devidx
, (*)&e->
dœty_deviû
))

520 
is_dœty
 = 
Œue
;

521 
	`¥š_uÆock
(&
im
->
šo_lock
);

522  
is_dœty
;

523 
	}
}

525 
	$f2fs_acquœe_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
)

527 
šode_mªagem’t
 *
im
 = &
sbi
->im[
ORPHAN_INO
];

528 
”r
 = 0;

530 
	`¥š_lock
(&
im
->
šo_lock
);

532 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


533 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_ORPHAN
)) {

534 
	`¥š_uÆock
(&
im
->
šo_lock
);

535 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_ORPHAN
);

536  -
ENOSPC
;

539 ià(
	`uÆik–y
(
im
->
šo_num
 >ğ
sbi
->
max_Üphªs
))

540 
”r
 = -
ENOSPC
;

542 
im
->
šo_num
++;

543 
	`¥š_uÆock
(&
im
->
šo_lock
);

545  
”r
;

546 
	}
}

548 
	$f2fs_»Ëa£_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
)

550 
šode_mªagem’t
 *
im
 = &
sbi
->im[
ORPHAN_INO
];

552 
	`¥š_lock
(&
im
->
šo_lock
);

553 
	`f2fs_bug_Ú
(
sbi
, 
im
->
šo_num
 == 0);

554 
im
->
šo_num
--;

555 
	`¥š_uÆock
(&
im
->
šo_lock
);

556 
	}
}

558 
	$f2fs_add_Üphª_šode
(
šode
 *inode)

561 
	`__add_šo_’Œy
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
, 0, 
ORPHAN_INO
);

562 
	`f2fs_upd©e_šode_·ge
(
šode
);

563 
	}
}

565 
	$f2fs_»move_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

568 
	`__»move_šo_’Œy
(
sbi
, 
šo
, 
ORPHAN_INO
);

569 
	}
}

571 
	$»cov”_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

573 
šode
 *inode;

574 
node_šfo
 
ni
;

575 
”r
 = 
	`f2fs_acquœe_Üphª_šode
(
sbi
);

577 ià(
”r
)

578 
”r_out
;

580 
	`__add_šo_’Œy
(
sbi
, 
šo
, 0, 
ORPHAN_INO
);

582 
šode
 = 
	`f2fs_ig‘_»Œy
(
sbi
->
sb
, 
šo
);

583 ià(
	`IS_ERR
(
šode
)) {

588 
	`f2fs_bug_Ú
(
sbi
, 
	`PTR_ERR
(
šode
è=ğ-
ENOENT
);

589  
	`PTR_ERR
(
šode
);

592 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

593 ià(
”r
) {

594 
	`ut
(
šode
);

595 
”r_out
;

598 
	`ş—r_Æšk
(
šode
);

601 
	`ut
(
šode
);

603 
	`f2fs_g‘_node_šfo
(
sbi
, 
šo
, &
ni
);

606 ià(
ni
.
blk_addr
 !ğ
NULL_ADDR
) {

607 
”r
 = -
EIO
;

608 
”r_out
;

610 
	`__»move_šo_’Œy
(
sbi
, 
šo
, 
ORPHAN_INO
);

613 
”r_out
:

614 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

615 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

617 
__func__
, 
šo
);

618  
”r
;

619 
	}
}

621 
	$f2fs_»cov”_Üphª_šodes
(
f2fs_sb_šfo
 *
sbi
)

623 
block_t
 
¡¬t_blk
, 
Üphª_blocks
, 
i
, 
j
;

624 
s_æags
 = 
sbi
->
sb
->s_flags;

625 
”r
 = 0;

626 #ifdeà
CONFIG_QUOTA


627 
quÙa_’abËd
;

630 ià(!
	`is_£t_ck±_æags
(
sbi
, 
CP_ORPHAN_PRESENT_FLAG
))

633 ià(
s_æags
 & 
SB_RDONLY
) {

634 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
, "orphan cleanup on„eadonly fs");

635 
sbi
->
sb
->
s_æags
 &ğ~
SB_RDONLY
;

638 #ifdeà
CONFIG_QUOTA


640 
sbi
->
sb
->
s_æags
 |ğ
SB_ACTIVE
;

643 
quÙa_’abËd
 = 
	`f2fs_’abË_quÙa_fes
(
sbi
, 
s_æags
 & 
SB_RDONLY
);

646 
¡¬t_blk
 = 
	`__¡¬t_ı_addr
(
sbi
è+ 1 + 
	`__ı_·ylßd
(sbi);

647 
Üphª_blocks
 = 
	`__¡¬t_sum_addr
(
sbi
è- 1 - 
	`__ı_·ylßd
(sbi);

649 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
¡¬t_blk
, 
Üphª_blocks
, 
META_CP
, 
Œue
);

651 
i
 = 0; i < 
Üphª_blocks
; i++) {

652 
·ge
 *·gğ
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
¡¬t_blk
 + 
i
);

653 
f2fs_Üphª_block
 *
Üphª_blk
;

655 
Üphª_blk
 = (
f2fs_Üphª_block
 *)
	`·ge_add»ss
(
·ge
);

656 
j
 = 0; j < 
	`Ë32_to_ıu
(
Üphª_blk
->
’Œy_couÁ
); j++) {

657 
nid_t
 
šo
 = 
	`Ë32_to_ıu
(
Üphª_blk
->šo[
j
]);

658 
”r
 = 
	`»cov”_Üphª_šode
(
sbi
, 
šo
);

659 ià(
”r
) {

660 
	`f2fs_put_·ge
(
·ge
, 1);

661 
out
;

664 
	`f2fs_put_·ge
(
·ge
, 1);

667 
	`ş—r_ck±_æags
(
sbi
, 
CP_ORPHAN_PRESENT_FLAG
);

668 
out
:

669 #ifdeà
CONFIG_QUOTA


671 ià(
quÙa_’abËd
)

672 
	`f2fs_quÙa_off_umouÁ
(
sbi
->
sb
);

674 
sbi
->
sb
->
s_æags
 = s_flags;

676  
”r
;

677 
	}
}

679 
	$wr™e_Üphª_šodes
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
)

681 
li¡_h—d
 *
h—d
;

682 
f2fs_Üphª_block
 *
Üphª_blk
 = 
NULL
;

683 
ÃÁr›s
 = 0;

684 
šdex
 = 1;

685 
Üphª_blocks
;

686 
·ge
 *·gğ
NULL
;

687 
šo_’Œy
 *
Üphª
 = 
NULL
;

688 
šode_mªagem’t
 *
im
 = &
sbi
->im[
ORPHAN_INO
];

690 
Üphª_blocks
 = 
	`GET_ORPHAN_BLOCKS
(
im
->
šo_num
);

697 
h—d
 = &
im
->
šo_li¡
;

700 
	`li¡_fÜ_—ch_’Œy
(
Üphª
, 
h—d
, 
li¡
) {

701 ià(!
·ge
) {

702 
·ge
 = 
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
¡¬t_blk
++);

703 
Üphª_blk
 =

704 (
f2fs_Üphª_block
 *)
	`·ge_add»ss
(
·ge
);

705 
	`mem£t
(
Üphª_blk
, 0, (*orphan_blk));

708 
Üphª_blk
->
šo
[
ÃÁr›s
++] = 
	`ıu_to_Ë32
(
Üphª
->ino);

710 ià(
ÃÁr›s
 =ğ
F2FS_ORPHANS_PER_BLOCK
) {

716 
Üphª_blk
->
blk_addr
 = 
	`ıu_to_Ë16
(
šdex
);

717 
Üphª_blk
->
blk_couÁ
 = 
	`ıu_to_Ë16
(
Üphª_blocks
);

718 
Üphª_blk
->
’Œy_couÁ
 = 
	`ıu_to_Ë32
(
ÃÁr›s
);

719 
	`£t_·ge_dœty
(
·ge
);

720 
	`f2fs_put_·ge
(
·ge
, 1);

721 
šdex
++;

722 
ÃÁr›s
 = 0;

723 
·ge
 = 
NULL
;

727 ià(
·ge
) {

728 
Üphª_blk
->
blk_addr
 = 
	`ıu_to_Ë16
(
šdex
);

729 
Üphª_blk
->
blk_couÁ
 = 
	`ıu_to_Ë16
(
Üphª_blocks
);

730 
Üphª_blk
->
’Œy_couÁ
 = 
	`ıu_to_Ë32
(
ÃÁr›s
);

731 
	`£t_·ge_dœty
(
·ge
);

732 
	`f2fs_put_·ge
(
·ge
, 1);

734 
	}
}

736 
	$g‘_checkpošt_v”siÚ
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
ı_addr
,

737 
f2fs_checkpošt
 **
ı_block
, 
·ge
 **
ı_·ge
,

738 *
v”siÚ
)

740 
blk_size
 = 
sbi
->
blocksize
;

741 
size_t
 
üc_off£t
 = 0;

742 
__u32
 
üc
 = 0;

744 *
ı_·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
ı_addr
);

745 *
ı_block
 = (
f2fs_checkpošt
 *)
	`·ge_add»ss
(*
ı_·ge
);

747 
üc_off£t
 = 
	`Ë32_to_ıu
((*
ı_block
)->
checksum_off£t
);

748 ià(
üc_off£t
 > (
blk_size
 - (
__Ë32
))) {

749 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

750 "šv®id crc_off£t: %zu", 
üc_off£t
);

751  -
EINVAL
;

754 
üc
 = 
	`cur_ı_üc
(*
ı_block
);

755 ià(!
	`f2fs_üc_v®id
(
sbi
, 
üc
, *
ı_block
, 
üc_off£t
)) {

756 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
, "invalid crc value");

757  -
EINVAL
;

760 *
v”siÚ
 = 
	`cur_ı_v”siÚ
(*
ı_block
);

762 
	}
}

764 
·ge
 *
	$v®id©e_checkpošt
(
f2fs_sb_šfo
 *
sbi
,

765 
block_t
 
ı_addr
, *
v”siÚ
)

767 
·ge
 *
ı_·ge_1
 = 
NULL
, *
ı_·ge_2
 = NULL;

768 
f2fs_checkpošt
 *
ı_block
 = 
NULL
;

769 
cur_v”siÚ
 = 0, 
´e_v”siÚ
 = 0;

770 
”r
;

772 
”r
 = 
	`g‘_checkpošt_v”siÚ
(
sbi
, 
ı_addr
, &
ı_block
,

773 &
ı_·ge_1
, 
v”siÚ
);

774 ià(
”r
)

775 
šv®id_ı1
;

776 
´e_v”siÚ
 = *
v”siÚ
;

778 
ı_addr
 +ğ
	`Ë32_to_ıu
(
ı_block
->
ı_·ck_tÙ®_block_couÁ
) - 1;

779 
”r
 = 
	`g‘_checkpošt_v”siÚ
(
sbi
, 
ı_addr
, &
ı_block
,

780 &
ı_·ge_2
, 
v”siÚ
);

781 ià(
”r
)

782 
šv®id_ı2
;

783 
cur_v”siÚ
 = *
v”siÚ
;

785 ià(
cur_v”siÚ
 =ğ
´e_v”siÚ
) {

786 *
v”siÚ
 = 
cur_v”siÚ
;

787 
	`f2fs_put_·ge
(
ı_·ge_2
, 1);

788  
ı_·ge_1
;

790 
šv®id_ı2
:

791 
	`f2fs_put_·ge
(
ı_·ge_2
, 1);

792 
šv®id_ı1
:

793 
	`f2fs_put_·ge
(
ı_·ge_1
, 1);

794  
NULL
;

795 
	}
}

797 
	$f2fs_g‘_v®id_checkpošt
(
f2fs_sb_šfo
 *
sbi
)

799 
f2fs_checkpošt
 *
ı_block
;

800 
f2fs_su³r_block
 *
fsb
 = 
sbi
->
¿w_su³r
;

801 
·ge
 *
ı1
, *
ı2
, *
cur_·ge
;

802 
blk_size
 = 
sbi
->
blocksize
;

803 
ı1_v”siÚ
 = 0, 
ı2_v”siÚ
 = 0;

804 
ı_¡¬t_blk_no
;

805 
ı_blks
 = 1 + 
	`__ı_·ylßd
(
sbi
);

806 
block_t
 
ı_blk_no
;

807 
i
;

809 
sbi
->
ck±
 = 
	`f2fs_kz®loc
(sbi, 
	`¬¿y_size
(
blk_size
, 
ı_blks
),

810 
GFP_KERNEL
);

811 ià(!
sbi
->
ck±
)

812  -
ENOMEM
;

817 
ı_¡¬t_blk_no
 = 
	`Ë32_to_ıu
(
fsb
->
ı_blkaddr
);

818 
ı1
 = 
	`v®id©e_checkpošt
(
sbi
, 
ı_¡¬t_blk_no
, &
ı1_v”siÚ
);

821 
ı_¡¬t_blk_no
 += (()1) <<

822 
	`Ë32_to_ıu
(
fsb
->
log_blocks_³r_£g
);

823 
ı2
 = 
	`v®id©e_checkpošt
(
sbi
, 
ı_¡¬t_blk_no
, &
ı2_v”siÚ
);

825 ià(
ı1
 && 
ı2
) {

826 ià(
	`v”_aá”
(
ı2_v”siÚ
, 
ı1_v”siÚ
))

827 
cur_·ge
 = 
ı2
;

829 
cur_·ge
 = 
ı1
;

830 } ià(
ı1
) {

831 
cur_·ge
 = 
ı1
;

832 } ià(
ı2
) {

833 
cur_·ge
 = 
ı2
;

835 
ç_no_ı
;

838 
ı_block
 = (
f2fs_checkpošt
 *)
	`·ge_add»ss
(
cur_·ge
);

839 
	`memıy
(
sbi
->
ck±
, 
ı_block
, 
blk_size
);

842 ià(
	`f2fs_§n™y_check_ck±
(
sbi
))

843 
ä“_ç_no_ı
;

845 ià(
cur_·ge
 =ğ
ı1
)

846 
sbi
->
cur_ı_·ck
 = 1;

848 
sbi
->
cur_ı_·ck
 = 2;

850 ià(
ı_blks
 <= 1)

851 
dÚe
;

853 
ı_blk_no
 = 
	`Ë32_to_ıu
(
fsb
->
ı_blkaddr
);

854 ià(
cur_·ge
 =ğ
ı2
)

855 
ı_blk_no
 +ğ1 << 
	`Ë32_to_ıu
(
fsb
->
log_blocks_³r_£g
);

857 
i
 = 1; i < 
ı_blks
; i++) {

858 *
s™_b™m­_±r
;

859 *
ck±
 = (*)
sbi
->ckpt;

861 
cur_·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
ı_blk_no
 + 
i
);

862 
s™_b™m­_±r
 = 
	`·ge_add»ss
(
cur_·ge
);

863 
	`memıy
(
ck±
 + 
i
 * 
blk_size
, 
s™_b™m­_±r
, blk_size);

864 
	`f2fs_put_·ge
(
cur_·ge
, 1);

866 
dÚe
:

867 
	`f2fs_put_·ge
(
ı1
, 1);

868 
	`f2fs_put_·ge
(
ı2
, 1);

871 
ä“_ç_no_ı
:

872 
	`f2fs_put_·ge
(
ı1
, 1);

873 
	`f2fs_put_·ge
(
ı2
, 1);

874 
ç_no_ı
:

875 
	`kä“
(
sbi
->
ck±
);

876  -
EINVAL
;

877 
	}
}

879 
	$__add_dœty_šode
(
šode
 *šode, 
šode_ty³
 
ty³
)

881 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

882 
æag
 = (
ty³
 =ğ
DIR_INODE
è? 
FI_DIRTY_DIR
 : 
FI_DIRTY_FILE
;

884 ià(
	`is_šode_æag_£t
(
šode
, 
æag
))

887 
	`£t_šode_æag
(
šode
, 
æag
);

888 ià(!
	`f2fs_is_vŞ©e_fe
(
šode
))

889 
	`li¡_add_
(&
	`F2FS_I
(
šode
)->
dœty_li¡
,

890 &
sbi
->
šode_li¡
[
ty³
]);

891 
	`¡©_šc_dœty_šode
(
sbi
, 
ty³
);

892 
	}
}

894 
	$__»move_dœty_šode
(
šode
 *šode, 
šode_ty³
 
ty³
)

896 
æag
 = (
ty³
 =ğ
DIR_INODE
è? 
FI_DIRTY_DIR
 : 
FI_DIRTY_FILE
;

898 ià(
	`g‘_dœty_·ges
(
šode
è|| !
	`is_šode_æag_£t
(šode, 
æag
))

901 
	`li¡_d–_š™
(&
	`F2FS_I
(
šode
)->
dœty_li¡
);

902 
	`ş—r_šode_æag
(
šode
, 
æag
);

903 
	`¡©_dec_dœty_šode
(
	`F2FS_I_SB
(
šode
), 
ty³
);

904 
	}
}

906 
	$f2fs_upd©e_dœty_·ge
(
šode
 *šode, 
·ge
 *page)

908 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

909 
šode_ty³
 
ty³
 = 
	`S_ISDIR
(
šode
->
i_mode
è? 
DIR_INODE
 : 
FILE_INODE
;

911 ià(!
	`S_ISDIR
(
šode
->
i_mode
è&& !
	`S_ISREG
(inode->i_mode) &&

912 !
	`S_ISLNK
(
šode
->
i_mode
))

915 
	`¥š_lock
(&
sbi
->
šode_lock
[
ty³
]);

916 ià(
ty³
 !ğ
FILE_INODE
 || 
	`‹¡_İt
(
sbi
, 
DATA_FLUSH
))

917 
	`__add_dœty_šode
(
šode
, 
ty³
);

918 
	`šode_šc_dœty_·ges
(
šode
);

919 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ty³
]);

921 
	`S‘PagePriv©e
(
·ge
);

922 
	`f2fs_Œaû_pid
(
·ge
);

923 
	}
}

925 
	$f2fs_»move_dœty_šode
(
šode
 *inode)

927 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

928 
šode_ty³
 
ty³
 = 
	`S_ISDIR
(
šode
->
i_mode
è? 
DIR_INODE
 : 
FILE_INODE
;

930 ià(!
	`S_ISDIR
(
šode
->
i_mode
è&& !
	`S_ISREG
(inode->i_mode) &&

931 !
	`S_ISLNK
(
šode
->
i_mode
))

934 ià(
ty³
 =ğ
FILE_INODE
 && !
	`‹¡_İt
(
sbi
, 
DATA_FLUSH
))

937 
	`¥š_lock
(&
sbi
->
šode_lock
[
ty³
]);

938 
	`__»move_dœty_šode
(
šode
, 
ty³
);

939 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ty³
]);

940 
	}
}

942 
	$f2fs_sync_dœty_šodes
(
f2fs_sb_šfo
 *
sbi
, 
šode_ty³
 
ty³
)

944 
li¡_h—d
 *
h—d
;

945 
šode
 *inode;

946 
f2fs_šode_šfo
 *
fi
;

947 
boŞ
 
is_dœ
 = (
ty³
 =ğ
DIR_INODE
);

948 
šo
 = 0;

950 
	`Œaû_f2fs_sync_dœty_šodes_’‹r
(
sbi
->
sb
, 
is_dœ
,

951 
	`g‘_·ges
(
sbi
, 
is_dœ
 ?

952 
F2FS_DIRTY_DENTS
 : 
F2FS_DIRTY_DATA
));

953 
»Œy
:

954 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

955  -
EIO
;

957 
	`¥š_lock
(&
sbi
->
šode_lock
[
ty³
]);

959 
h—d
 = &
sbi
->
šode_li¡
[
ty³
];

960 ià(
	`li¡_em±y
(
h—d
)) {

961 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ty³
]);

962 
	`Œaû_f2fs_sync_dœty_šodes_ex™
(
sbi
->
sb
, 
is_dœ
,

963 
	`g‘_·ges
(
sbi
, 
is_dœ
 ?

964 
F2FS_DIRTY_DENTS
 : 
F2FS_DIRTY_DATA
));

967 
fi
 = 
	`li¡_fœ¡_’Œy
(
h—d
, 
f2fs_šode_šfo
, 
dœty_li¡
);

968 
šode
 = 
	`ig¿b
(&
fi
->
vfs_šode
);

969 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ty³
]);

970 ià(
šode
) {

971 
cur_šo
 = 
šode
->
i_šo
;

973 ià(
is_dœ
)

974 
	`F2FS_I
(
šode
)->
ı_sk
 = 
cu¼’t
;

976 
	`fem­_fd©awr™e
(
šode
->
i_m­pšg
);

978 ià(
is_dœ
)

979 
	`F2FS_I
(
šode
)->
ı_sk
 = 
NULL
;

981 
	`ut
(
šode
);

983 ià(
šo
 =ğ
cur_šo
) {

984 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

985 
	`cÚd_»sched
();

987 
šo
 = 
cur_šo
;

994 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
DATA
);

995 
	`cÚd_»sched
();

997 
»Œy
;

998 
	}
}

1000 
	$f2fs_sync_šode_m‘a
(
f2fs_sb_šfo
 *
sbi
)

1002 
li¡_h—d
 *
h—d
 = &
sbi
->
šode_li¡
[
DIRTY_META
];

1003 
šode
 *inode;

1004 
f2fs_šode_šfo
 *
fi
;

1005 
s64
 
tÙ®
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_IMETA
);

1007 
tÙ®
--) {

1008 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1009  -
EIO
;

1011 
	`¥š_lock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

1012 ià(
	`li¡_em±y
(
h—d
)) {

1013 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

1016 
fi
 = 
	`li¡_fœ¡_’Œy
(
h—d
, 
f2fs_šode_šfo
,

1017 
gdœty_li¡
);

1018 
šode
 = 
	`ig¿b
(&
fi
->
vfs_šode
);

1019 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

1020 ià(
šode
) {

1021 
	`sync_šode_m‘ad©a
(
šode
, 0);

1024 ià(
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
))

1025 
	`f2fs_upd©e_šode_·ge
(
šode
);

1026 
	`ut
(
šode
);

1030 
	}
}

1032 
	$__´•¬e_ı_block
(
f2fs_sb_šfo
 *
sbi
)

1034 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1035 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1036 
nid_t
 
Ï¡_nid
 = 
nm_i
->
Ãxt_sÿn_nid
;

1038 
	`Ãxt_ä“_nid
(
sbi
, &
Ï¡_nid
);

1039 
ck±
->
v®id_block_couÁ
 = 
	`ıu_to_Ë64
(
	`v®id_u£r_blocks
(
sbi
));

1040 
ck±
->
v®id_node_couÁ
 = 
	`ıu_to_Ë32
(
	`v®id_node_couÁ
(
sbi
));

1041 
ck±
->
v®id_šode_couÁ
 = 
	`ıu_to_Ë32
(
	`v®id_šode_couÁ
(
sbi
));

1042 
ck±
->
Ãxt_ä“_nid
 = 
	`ıu_to_Ë32
(
Ï¡_nid
);

1043 
	}
}

1048 
	$block_İ”©iÚs
(
f2fs_sb_šfo
 *
sbi
)

1050 
wr™eback_cÚŒŞ
 
wbc
 = {

1051 .
sync_mode
 = 
WB_SYNC_ALL
,

1052 .
Ä_to_wr™e
 = 
LONG_MAX
,

1053 .
fÜ_»şaim
 = 0,

1055 
blk_¶ug
 
¶ug
;

1056 
”r
 = 0;

1058 
	`blk_¡¬t_¶ug
(&
¶ug
);

1060 
»Œy_æush_d’ts
:

1061 
	`f2fs_lock_®l
(
sbi
);

1063 ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
)) {

1064 
	`f2fs_uÆock_®l
(
sbi
);

1065 
”r
 = 
	`f2fs_sync_dœty_šodes
(
sbi
, 
DIR_INODE
);

1066 ià(
”r
)

1067 
out
;

1068 
	`cÚd_»sched
();

1069 
»Œy_æush_d’ts
;

1076 
	`down_wr™e
(&
sbi
->
node_chªge
);

1078 ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_IMETA
)) {

1079 
	`up_wr™e
(&
sbi
->
node_chªge
);

1080 
	`f2fs_uÆock_®l
(
sbi
);

1081 
”r
 = 
	`f2fs_sync_šode_m‘a
(
sbi
);

1082 ià(
”r
)

1083 
out
;

1084 
	`cÚd_»sched
();

1085 
»Œy_æush_d’ts
;

1088 
»Œy_æush_nodes
:

1089 
	`down_wr™e
(&
sbi
->
node_wr™e
);

1091 ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
)) {

1092 
	`up_wr™e
(&
sbi
->
node_wr™e
);

1093 
	`©omic_šc
(&
sbi
->
wb_sync_»q
[
NODE
]);

1094 
”r
 = 
	`f2fs_sync_node_·ges
(
sbi
, &
wbc
, 
çl£
, 
FS_CP_NODE_IO
);

1095 
	`©omic_dec
(&
sbi
->
wb_sync_»q
[
NODE
]);

1096 ià(
”r
) {

1097 
	`up_wr™e
(&
sbi
->
node_chªge
);

1098 
	`f2fs_uÆock_®l
(
sbi
);

1099 
out
;

1101 
	`cÚd_»sched
();

1102 
»Œy_æush_nodes
;

1109 
	`__´•¬e_ı_block
(
sbi
);

1110 
	`up_wr™e
(&
sbi
->
node_chªge
);

1111 
out
:

1112 
	`blk_fšish_¶ug
(&
¶ug
);

1113  
”r
;

1114 
	}
}

1116 
	$unblock_İ”©iÚs
(
f2fs_sb_šfo
 *
sbi
)

1118 
	`up_wr™e
(&
sbi
->
node_wr™e
);

1119 
	`f2fs_uÆock_®l
(
sbi
);

1120 
	}
}

1122 
	$wa™_Ú_®l_·ges_wr™eback
(
f2fs_sb_šfo
 *
sbi
)

1124 
	`DEFINE_WAIT
(
wa™
);

1127 
	`´•¬e_to_wa™
(&
sbi
->
ı_wa™
, &
wa™
, 
TASK_UNINTERRUPTIBLE
);

1129 ià(!
	`g‘_·ges
(
sbi
, 
F2FS_WB_CP_DATA
))

1132 
	`io_scheduË_timeout
(5*
HZ
);

1134 
	`fšish_wa™
(&
sbi
->
ı_wa™
, &
wa™
);

1135 
	}
}

1137 
	$upd©e_ck±_æags
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

1139 
Üphª_num
 = 
sbi
->
im
[
ORPHAN_INO
].
šo_num
;

1140 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1141 
æags
;

1143 
	`¥š_lock_œq§ve
(&
sbi
->
ı_lock
, 
æags
);

1145 ià((
ıc
->
»asÚ
 & 
CP_UMOUNT
) &&

1146 
	`Ë32_to_ıu
(
ck±
->
ı_·ck_tÙ®_block_couÁ
) >

1147 
sbi
->
blocks_³r_£g
 - 
	`NM_I
(sbi)->
Çt_b™s_blocks
)

1148 
	`di§bË_Çt_b™s
(
sbi
, 
çl£
);

1150 ià(
ıc
->
»asÚ
 & 
CP_TRIMMED
)

1151 
	`__£t_ck±_æags
(
ck±
, 
CP_TRIMMED_FLAG
);

1153 
	`__ş—r_ck±_æags
(
ck±
, 
CP_TRIMMED_FLAG
);

1155 ià(
ıc
->
»asÚ
 & 
CP_UMOUNT
)

1156 
	`__£t_ck±_æags
(
ck±
, 
CP_UMOUNT_FLAG
);

1158 
	`__ş—r_ck±_æags
(
ck±
, 
CP_UMOUNT_FLAG
);

1160 ià(
ıc
->
»asÚ
 & 
CP_FASTBOOT
)

1161 
	`__£t_ck±_æags
(
ck±
, 
CP_FASTBOOT_FLAG
);

1163 
	`__ş—r_ck±_æags
(
ck±
, 
CP_FASTBOOT_FLAG
);

1165 ià(
Üphª_num
)

1166 
	`__£t_ck±_æags
(
ck±
, 
CP_ORPHAN_PRESENT_FLAG
);

1168 
	`__ş—r_ck±_æags
(
ck±
, 
CP_ORPHAN_PRESENT_FLAG
);

1170 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_FSCK
))

1171 
	`__£t_ck±_æags
(
ck±
, 
CP_FSCK_FLAG
);

1174 
	`__£t_ck±_æags
(
ck±
, 
CP_CRC_RECOVERY_FLAG
);

1175 
	`__ş—r_ck±_æags
(
ck±
, 
CP_NOCRC_RECOVERY_FLAG
);

1177 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
ı_lock
, 
æags
);

1178 
	}
}

1180 
	$comm™_checkpošt
(
f2fs_sb_šfo
 *
sbi
,

1181 *
¤c
, 
block_t
 
blk_addr
)

1183 
wr™eback_cÚŒŞ
 
wbc
 = {

1184 .
fÜ_»şaim
 = 0,

1192 
·ge
 *·gğ
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
blk_addr
);

1193 
”r
;

1195 
	`memıy
(
	`·ge_add»ss
(
·ge
), 
¤c
, 
PAGE_SIZE
);

1196 
	`£t_·ge_dœty
(
·ge
);

1198 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
META
, 
Œue
);

1199 
	`f2fs_bug_Ú
(
sbi
, 
	`PageWr™eback
(
·ge
));

1200 ià(
	`uÆik–y
(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
)))

1201 
	`f2fs_bug_Ú
(
sbi
, 1);

1204 
”r
 = 
	`__f2fs_wr™e_m‘a_·ge
(
·ge
, &
wbc
, 
FS_CP_META_IO
);

1205 
	`f2fs_bug_Ú
(
sbi
, 
”r
);

1207 
	`f2fs_put_·ge
(
·ge
, 0);

1210 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
META_FLUSH
);

1211 
	}
}

1213 
	$do_checkpošt
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

1215 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1216 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1217 
Üphª_num
 = 
sbi
->
im
[
ORPHAN_INO
].
šo_num
, 
æags
;

1218 
block_t
 
¡¬t_blk
;

1219 
d©a_sum_blocks
, 
Üphª_blocks
;

1220 
__u32
 
üc32
 = 0;

1221 
i
;

1222 
ı_·ylßd_blks
 = 
	`__ı_·ylßd
(
sbi
);

1223 
su³r_block
 *
sb
 = 
sbi
->sb;

1224 
cur£g_šfo
 *
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_NODE
);

1225 
u64
 
kby‹s_wr™‹n
;

1226 
”r
;

1229 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
)) {

1230 
	`f2fs_sync_m‘a_·ges
(
sbi
, 
META
, 
LONG_MAX
, 
FS_CP_META_IO
);

1231 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1232  -
EIO
;

1239 
ck±
->
–­£d_time
 = 
	`ıu_to_Ë64
(
	`g‘_mtime
(
sbi
, 
Œue
));

1240 
ck±
->
ä“_£gm’t_couÁ
 = 
	`ıu_to_Ë32
(
	`ä“_£gm’ts
(
sbi
));

1241 
i
 = 0; i < 
NR_CURSEG_NODE_TYPE
; i++) {

1242 
ck±
->
cur_node_£gno
[
i
] =

1243 
	`ıu_to_Ë32
(
	`cur£g_£gno
(
sbi
, 
i
 + 
CURSEG_HOT_NODE
));

1244 
ck±
->
cur_node_blkoff
[
i
] =

1245 
	`ıu_to_Ë16
(
	`cur£g_blkoff
(
sbi
, 
i
 + 
CURSEG_HOT_NODE
));

1246 
ck±
->
®loc_ty³
[
i
 + 
CURSEG_HOT_NODE
] =

1247 
	`cur£g_®loc_ty³
(
sbi
, 
i
 + 
CURSEG_HOT_NODE
);

1249 
i
 = 0; i < 
NR_CURSEG_DATA_TYPE
; i++) {

1250 
ck±
->
cur_d©a_£gno
[
i
] =

1251 
	`ıu_to_Ë32
(
	`cur£g_£gno
(
sbi
, 
i
 + 
CURSEG_HOT_DATA
));

1252 
ck±
->
cur_d©a_blkoff
[
i
] =

1253 
	`ıu_to_Ë16
(
	`cur£g_blkoff
(
sbi
, 
i
 + 
CURSEG_HOT_DATA
));

1254 
ck±
->
®loc_ty³
[
i
 + 
CURSEG_HOT_DATA
] =

1255 
	`cur£g_®loc_ty³
(
sbi
, 
i
 + 
CURSEG_HOT_DATA
);

1259 
d©a_sum_blocks
 = 
	`f2fs_Åages_fÜ_summ¬y_æush
(
sbi
, 
çl£
);

1260 
	`¥š_lock_œq§ve
(&
sbi
->
ı_lock
, 
æags
);

1261 ià(
d©a_sum_blocks
 < 
NR_CURSEG_DATA_TYPE
)

1262 
	`__£t_ck±_æags
(
ck±
, 
CP_COMPACT_SUM_FLAG
);

1264 
	`__ş—r_ck±_æags
(
ck±
, 
CP_COMPACT_SUM_FLAG
);

1265 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
ı_lock
, 
æags
);

1267 
Üphª_blocks
 = 
	`GET_ORPHAN_BLOCKS
(
Üphª_num
);

1268 
ck±
->
ı_·ck_¡¬t_sum
 = 
	`ıu_to_Ë32
(1 + 
ı_·ylßd_blks
 +

1269 
Üphª_blocks
);

1271 ià(
	`__»maš_node_summ¬›s
(
ıc
->
»asÚ
))

1272 
ck±
->
ı_·ck_tÙ®_block_couÁ
 = 
	`ıu_to_Ë32
(
F2FS_CP_PACKS
+

1273 
ı_·ylßd_blks
 + 
d©a_sum_blocks
 +

1274 
Üphª_blocks
 + 
NR_CURSEG_NODE_TYPE
);

1276 
ck±
->
ı_·ck_tÙ®_block_couÁ
 = 
	`ıu_to_Ë32
(
F2FS_CP_PACKS
 +

1277 
ı_·ylßd_blks
 + 
d©a_sum_blocks
 +

1278 
Üphª_blocks
);

1281 
	`upd©e_ck±_æags
(
sbi
, 
ıc
);

1284 
	`g‘_s™_b™m­
(
sbi
, 
	`__b™m­_±r
(sbi, 
SIT_BITMAP
));

1285 
	`g‘_Çt_b™m­
(
sbi
, 
	`__b™m­_±r
(sbi, 
NAT_BITMAP
));

1287 
üc32
 = 
	`f2fs_üc32
(
sbi
, 
ck±
, 
	`Ë32_to_ıu
(ck±->
checksum_off£t
));

1288 *((
__Ë32
 *)((*)
ck±
 +

1289 
	`Ë32_to_ıu
(
ck±
->
checksum_off£t
)))

1290 ğ
	`ıu_to_Ë32
(
üc32
);

1292 
¡¬t_blk
 = 
	`__¡¬t_ı_Ãxt_addr
(
sbi
);

1295 ià(
	`’abËd_Çt_b™s
(
sbi
, 
ıc
)) {

1296 
__u64
 
ı_v”
 = 
	`cur_ı_v”siÚ
(
ck±
);

1297 
block_t
 
blk
;

1299 
ı_v”
 |ğ((
__u64
)
üc32
 << 32);

1300 *(
__Ë64
 *)
nm_i
->
Çt_b™s
 = 
	`ıu_to_Ë64
(
ı_v”
);

1302 
blk
 = 
¡¬t_blk
 + 
sbi
->
blocks_³r_£g
 - 
nm_i
->
Çt_b™s_blocks
;

1303 
i
 = 0; i < 
nm_i
->
Çt_b™s_blocks
; i++)

1304 
	`f2fs_upd©e_m‘a_·ge
(
sbi
, 
nm_i
->
Çt_b™s
 +

1305 (
i
 << 
F2FS_BLKSIZE_BITS
), 
blk
 + i);

1308 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
)) {

1309 
	`f2fs_sync_m‘a_·ges
(
sbi
, 
META
, 
LONG_MAX
,

1310 
FS_CP_META_IO
);

1311 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1312  -
EIO
;

1317 
	`f2fs_upd©e_m‘a_·ge
(
sbi
, 
ck±
, 
¡¬t_blk
++);

1319 
i
 = 1; i < 1 + 
ı_·ylßd_blks
; i++)

1320 
	`f2fs_upd©e_m‘a_·ge
(
sbi
, (*)
ck±
 + 
i
 * 
F2FS_BLKSIZE
,

1321 
¡¬t_blk
++);

1323 ià(
Üphª_num
) {

1324 
	`wr™e_Üphª_šodes
(
sbi
, 
¡¬t_blk
);

1325 
¡¬t_blk
 +ğ
Üphª_blocks
;

1328 
	`f2fs_wr™e_d©a_summ¬›s
(
sbi
, 
¡¬t_blk
);

1329 
¡¬t_blk
 +ğ
d©a_sum_blocks
;

1332 
kby‹s_wr™‹n
 = 
sbi
->kbytes_written;

1333 ià(
sb
->
s_bdev
->
bd_·¹
)

1334 
kby‹s_wr™‹n
 +ğ
	`BD_PART_WRITTEN
(
sbi
);

1336 
£g_i
->
jouº®
->
šfo
.
kby‹s_wr™‹n
 = 
	`ıu_to_Ë64
(kbytes_written);

1338 ià(
	`__»maš_node_summ¬›s
(
ıc
->
»asÚ
)) {

1339 
	`f2fs_wr™e_node_summ¬›s
(
sbi
, 
¡¬t_blk
);

1340 
¡¬t_blk
 +ğ
NR_CURSEG_NODE_TYPE
;

1344 
sbi
->
Ï¡_v®id_block_couÁ
 = sbi->
tÙ®_v®id_block_couÁ
;

1345 
	`³rıu_couÁ”_£t
(&
sbi
->
®loc_v®id_block_couÁ
, 0);

1348 
	`f2fs_sync_m‘a_·ges
(
sbi
, 
META
, 
LONG_MAX
, 
FS_CP_META_IO
);

1351 
	`wa™_Ú_®l_·ges_wr™eback
(
sbi
);

1353 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1354  -
EIO
;

1357 
”r
 = 
	`f2fs_æush_deviû_ÿche
(
sbi
);

1358 ià(
”r
)

1359  
”r
;

1362 
	`comm™_checkpošt
(
sbi
, 
ck±
, 
¡¬t_blk
);

1363 
	`wa™_Ú_®l_·ges_wr™eback
(
sbi
);

1365 
	`f2fs_»Ëa£_šo_’Œy
(
sbi
, 
çl£
);

1367 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1368  -
EIO
;

1370 
	`ş—r_sbi_æag
(
sbi
, 
SBI_IS_DIRTY
);

1371 
	`ş—r_sbi_æag
(
sbi
, 
SBI_NEED_CP
);

1372 
	`__£t_ı_Ãxt_·ck
(
sbi
);

1378 ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
) ||

1379 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_IMETA
))

1380 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_DIRTY
);

1382 
	`f2fs_bug_Ú
(
sbi
, 
	`g‘_·ges
(sbi, 
F2FS_DIRTY_DENTS
));

1385 
	}
}

1390 
	$f2fs_wr™e_checkpošt
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

1392 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1393 
ck±_v”
;

1394 
”r
 = 0;

1396 
	`mu‹x_lock
(&
sbi
->
ı_mu‹x
);

1398 ià(!
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_DIRTY
) &&

1399 ((
ıc
->
»asÚ
 & 
CP_FASTBOOT
è|| (ıc->»asÚ & 
CP_SYNC
) ||

1400 ((
ıc
->
»asÚ
 & 
CP_DISCARD
è&& !
sbi
->
disÿrd_blks
)))

1401 
out
;

1402 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1403 
”r
 = -
EIO
;

1404 
out
;

1406 ià(
	`f2fs_»adÚly
(
sbi
->
sb
)) {

1407 
”r
 = -
EROFS
;

1408 
out
;

1411 
	`Œaû_f2fs_wr™e_checkpošt
(
sbi
->
sb
, 
ıc
->
»asÚ
, "start block_ops");

1413 
”r
 = 
	`block_İ”©iÚs
(
sbi
);

1414 ià(
”r
)

1415 
out
;

1417 
	`Œaû_f2fs_wr™e_checkpošt
(
sbi
->
sb
, 
ıc
->
»asÚ
, "finish block_ops");

1419 
	`f2fs_æush_m”ged_wr™es
(
sbi
);

1422 ià(
ıc
->
»asÚ
 & 
CP_DISCARD
) {

1423 ià(!
	`f2fs_exi¡_Œim_ÿndid©es
(
sbi
, 
ıc
)) {

1424 
	`unblock_İ”©iÚs
(
sbi
);

1425 
out
;

1428 ià(
	`NM_I
(
sbi
)->
dœty_Çt_út
 == 0 &&

1429 
	`SIT_I
(
sbi
)->
dœty_£Ár›s
 == 0 &&

1430 
	`´eä“_£gm’ts
(
sbi
) == 0) {

1431 
	`f2fs_æush_s™_’Œ›s
(
sbi
, 
ıc
);

1432 
	`f2fs_ş—r_´eä“_£gm’ts
(
sbi
, 
ıc
);

1433 
	`unblock_İ”©iÚs
(
sbi
);

1434 
out
;

1443 
ck±_v”
 = 
	`cur_ı_v”siÚ
(
ck±
);

1444 
ck±
->
checkpošt_v”
 = 
	`ıu_to_Ë64
(++
ck±_v”
);

1447 
	`f2fs_æush_Çt_’Œ›s
(
sbi
, 
ıc
);

1448 
	`f2fs_æush_s™_’Œ›s
(
sbi
, 
ıc
);

1451 
”r
 = 
	`do_checkpošt
(
sbi
, 
ıc
);

1452 ià(
”r
)

1453 
	`f2fs_»Ëa£_disÿrd_addrs
(
sbi
);

1455 
	`f2fs_ş—r_´eä“_£gm’ts
(
sbi
, 
ıc
);

1457 
	`unblock_İ”©iÚs
(
sbi
);

1458 
	`¡©_šc_ı_couÁ
(
sbi
->
¡©_šfo
);

1460 ià(
ıc
->
»asÚ
 & 
CP_RECOVERY
)

1461 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_NOTICE
,

1462 "checkpošt: v”siÚ = %Îx", 
ck±_v”
);

1465 
	`f2fs_upd©e_time
(
sbi
, 
CP_TIME
);

1466 
	`Œaû_f2fs_wr™e_checkpošt
(
sbi
->
sb
, 
ıc
->
»asÚ
, "finish checkpoint");

1467 
out
:

1468 
	`mu‹x_uÆock
(&
sbi
->
ı_mu‹x
);

1469  
”r
;

1470 
	}
}

1472 
	$f2fs_š™_šo_’Œy_šfo
(
f2fs_sb_šfo
 *
sbi
)

1474 
i
;

1476 
i
 = 0; i < 
MAX_INO_ENTRY
; i++) {

1477 
šode_mªagem’t
 *
im
 = &
sbi
->im[
i
];

1479 
	`INIT_RADIX_TREE
(&
im
->
šo_roÙ
, 
GFP_ATOMIC
);

1480 
	`¥š_lock_š™
(&
im
->
šo_lock
);

1481 
	`INIT_LIST_HEAD
(&
im
->
šo_li¡
);

1482 
im
->
šo_num
 = 0;

1485 
sbi
->
max_Üphªs
 = (sbi->
blocks_³r_£g
 - 
F2FS_CP_PACKS
 -

1486 
NR_CURSEG_TYPE
 - 
	`__ı_·ylßd
(
sbi
)) *

1487 
F2FS_ORPHANS_PER_BLOCK
;

1488 
	}
}

1490 
__š™
 
	$f2fs_ü—‹_checkpošt_ÿches
()

1492 
šo_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_ino_entry",

1493 (
šo_’Œy
));

1494 ià(!
šo_’Œy_¦ab
)

1495  -
ENOMEM
;

1496 
f2fs_šode_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_inode_entry",

1497 (
šode_’Œy
));

1498 ià(!
f2fs_šode_’Œy_¦ab
) {

1499 
	`kmem_ÿche_de¡roy
(
šo_’Œy_¦ab
);

1500  -
ENOMEM
;

1503 
	}
}

1505 
	$f2fs_de¡roy_checkpošt_ÿches
()

1507 
	`kmem_ÿche_de¡roy
(
šo_’Œy_¦ab
);

1508 
	`kmem_ÿche_de¡roy
(
f2fs_šode_’Œy_¦ab
);

1509 
	}
}

	@fs/f2fs/data.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/bufãr_h—d.h
>

14 
	~<lšux/m·ge.h
>

15 
	~<lšux/wr™eback.h
>

16 
	~<lšux/backšg-dev.h
>

17 
	~<lšux/·gevec.h
>

18 
	~<lšux/blkdev.h
>

19 
	~<lšux/bio.h
>

20 
	~<lšux/´eãtch.h
>

21 
	~<lšux/uio.h
>

22 
	~<lšux/ş—nÿche.h
>

23 
	~<lšux/sched/sigÇl.h
>

25 
	~"f2fs.h
"

26 
	~"node.h
"

27 
	~"£gm’t.h
"

28 
	~"Œaû.h
"

29 
	~<Œaû/ev’ts/f2fs.h
>

31 
	#NUM_PREALLOC_POST_READ_CTXS
 128

	)

33 
kmem_ÿche
 *
	gbio_po¡_»ad_ùx_ÿche
;

34 
mempoŞ_t
 *
	gbio_po¡_»ad_ùx_poŞ
;

36 
boŞ
 
	$__is_ı_gu¬ª‹ed
(
·ge
 *page)

38 
add»ss_¥aû
 *
m­pšg
 = 
·ge
->mapping;

39 
šode
 *inode;

40 
f2fs_sb_šfo
 *
sbi
;

42 ià(!
m­pšg
)

43  
çl£
;

45 
šode
 = 
m­pšg
->
ho¡
;

46 
sbi
 = 
	`F2FS_I_SB
(
šode
);

48 ià(
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
) ||

49 
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
) ||

50 
	`S_ISDIR
(
šode
->
i_mode
) ||

51 (
	`S_ISREG
(
šode
->
i_mode
) &&

52 
	`is_šode_æag_£t
(
šode
, 
FI_ATOMIC_FILE
)) ||

53 
	`is_cŞd_d©a
(
·ge
))

54  
Œue
;

55  
çl£
;

56 
	}
}

59 
	ebio_po¡_»ad_¡•
 {

60 
	mSTEP_INITIAL
 = 0,

61 
	mSTEP_DECRYPT
,

64 
	sbio_po¡_»ad_ùx
 {

65 
bio
 *
	mbio
;

66 
wÜk_¡ruù
 
	mwÜk
;

67 
	mcur_¡•
;

68 
	m’abËd_¡•s
;

71 
	$__»ad_’d_io
(
bio
 *bio)

73 
·ge
 *page;

74 
bio_vec
 *
bv
;

75 
i
;

77 
	`bio_fÜ_—ch_£gm’t_®l
(
bv
, 
bio
, 
i
) {

78 
·ge
 = 
bv
->
bv_·ge
;

81 ià(
bio
->
bi_¡©us
 || 
	`PageE¼Ü
(
·ge
)) {

82 
	`CË¬PageU±od©e
(
·ge
);

83 
	`S‘PageE¼Ü
(
·ge
);

85 
	`S‘PageU±od©e
(
·ge
);

87 
	`uÆock_·ge
(
·ge
);

89 ià(
bio
->
bi_´iv©e
)

90 
	`mempoŞ_ä“
(
bio
->
bi_´iv©e
, 
bio_po¡_»ad_ùx_poŞ
);

91 
	`bio_put
(
bio
);

92 
	}
}

94 
bio_po¡_»ad_´oûssšg
(
bio_po¡_»ad_ùx
 *
ùx
);

96 
	$deüy±_wÜk
(
wÜk_¡ruù
 *
wÜk
)

98 
bio_po¡_»ad_ùx
 *
ùx
 =

99 
	`cÚš”_of
(
wÜk
, 
bio_po¡_»ad_ùx
, work);

101 
	`fsüy±_deüy±_bio
(
ùx
->
bio
);

103 
	`bio_po¡_»ad_´oûssšg
(
ùx
);

104 
	}
}

106 
	$bio_po¡_»ad_´oûssšg
(
bio_po¡_»ad_ùx
 *
ùx
)

108 ++
ùx
->
cur_¡•
) {

109 
STEP_DECRYPT
:

110 ià(
ùx
->
’abËd_¡•s
 & (1 << 
STEP_DECRYPT
)) {

111 
	`INIT_WORK
(&
ùx
->
wÜk
, 
deüy±_wÜk
);

112 
	`fsüy±_’queue_deüy±_wÜk
(&
ùx
->
wÜk
);

115 
ùx
->
cur_¡•
++;

118 
	`__»ad_’d_io
(
ùx
->
bio
);

120 
	}
}

122 
boŞ
 
	$f2fs_bio_po¡_»ad_»quœed
(
bio
 *bio)

124  
bio
->
bi_´iv©e
 && !bio->
bi_¡©us
;

125 
	}
}

127 
	$f2fs_»ad_’d_io
(
bio
 *bio)

129 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


130 ià(
	`time_to_šjeù
(
	`F2FS_P_SB
(
	`bio_fœ¡_·ge_®l
(
bio
)), 
FAULT_IO
)) {

131 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_IO
);

132 
bio
->
bi_¡©us
 = 
BLK_STS_IOERR
;

136 ià(
	`f2fs_bio_po¡_»ad_»quœed
(
bio
)) {

137 
bio_po¡_»ad_ùx
 *
ùx
 = 
bio
->
bi_´iv©e
;

139 
ùx
->
cur_¡•
 = 
STEP_INITIAL
;

140 
	`bio_po¡_»ad_´oûssšg
(
ùx
);

144 
	`__»ad_’d_io
(
bio
);

145 
	}
}

147 
	$f2fs_wr™e_’d_io
(
bio
 *bio)

149 
f2fs_sb_šfo
 *
sbi
 = 
bio
->
bi_´iv©e
;

150 
bio_vec
 *
bvec
;

151 
i
;

153 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
i
) {

154 
·ge
 *·gğ
bvec
->
bv_·ge
;

155 
couÁ_ty³
 
ty³
 = 
	`WB_DATA_TYPE
(
·ge
);

157 ià(
	`IS_DUMMY_WRITTEN_PAGE
(
·ge
)) {

158 
	`£t_·ge_´iv©e
(
·ge
, ()
NULL
);

159 
	`CË¬PagePriv©e
(
·ge
);

160 
	`uÆock_·ge
(
·ge
);

161 
	`mempoŞ_ä“
(
·ge
, 
sbi
->
wr™e_io_dummy
);

163 ià(
	`uÆik–y
(
bio
->
bi_¡©us
))

164 
	`f2fs_¡İ_checkpošt
(
sbi
, 
Œue
);

168 
	`fsüy±_puÎback_bio_·ge
(&
·ge
, 
Œue
);

170 ià(
	`uÆik–y
(
bio
->
bi_¡©us
)) {

171 
	`m­pšg_£t_”rÜ
(
·ge
->
m­pšg
, -
EIO
);

172 ià(
ty³
 =ğ
F2FS_WB_CP_DATA
)

173 
	`f2fs_¡İ_checkpošt
(
sbi
, 
Œue
);

176 
	`f2fs_bug_Ú
(
sbi
, 
·ge
->
m­pšg
 =ğ
	`NODE_MAPPING
(sbi) &&

177 
·ge
->
šdex
 !ğ
	`nid_of_node
(page));

179 
	`dec_·ge_couÁ
(
sbi
, 
ty³
);

180 
	`ş—r_cŞd_d©a
(
·ge
);

181 
	`’d_·ge_wr™eback
(
·ge
);

183 ià(!
	`g‘_·ges
(
sbi
, 
F2FS_WB_CP_DATA
) &&

184 
	`wq_has_¦“³r
(&
sbi
->
ı_wa™
))

185 
	`wake_up
(&
sbi
->
ı_wa™
);

187 
	`bio_put
(
bio
);

188 
	}
}

193 
block_deviû
 *
	$f2fs_rg‘_deviû
(
f2fs_sb_šfo
 *
sbi
,

194 
block_t
 
blk_addr
, 
bio
 *bio)

196 
block_deviû
 *
bdev
 = 
sbi
->
sb
->
s_bdev
;

197 
i
;

199 
i
 = 0; i < 
sbi
->
s_ndevs
; i++) {

200 ià(
	`FDEV
(
i
).
¡¬t_blk
 <ğ
blk_addr
 &&

201 
	`FDEV
(
i
).
’d_blk
 >ğ
blk_addr
) {

202 
blk_addr
 -ğ
	`FDEV
(
i
).
¡¬t_blk
;

203 
bdev
 = 
	`FDEV
(
i
).bdev;

207 ià(
bio
) {

208 
	`bio_£t_dev
(
bio
, 
bdev
);

209 
bio
->
bi_™”
.
bi_£ùÜ
 = 
	`SECTOR_FROM_BLOCK
(
blk_addr
);

211  
bdev
;

212 
	}
}

214 
	$f2fs_rg‘_deviû_šdex
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
)

216 
i
;

218 
i
 = 0; i < 
sbi
->
s_ndevs
; i++)

219 ià(
	`FDEV
(
i
).
¡¬t_blk
 <ğ
blkaddr
 && FDEV(i).
’d_blk
 >= blkaddr)

220  
i
;

222 
	}
}

224 
boŞ
 
	$__§me_bdev
(
f2fs_sb_šfo
 *
sbi
,

225 
block_t
 
blk_addr
, 
bio
 *bio)

227 
block_deviû
 *
b
 = 
	`f2fs_rg‘_deviû
(
sbi
, 
blk_addr
, 
NULL
);

228  
bio
->
bi_disk
 =ğ
b
->
bd_disk
 && bio->
bi_·¹no
 =ğb->
bd_·¹no
;

229 
	}
}

234 
bio
 *
	$__bio_®loc
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blk_addr
,

235 
wr™eback_cÚŒŞ
 *
wbc
,

236 
Åages
, 
boŞ
 
is_»ad
,

237 
·ge_ty³
 
ty³
, 
‹mp_ty³
 
‹mp
)

239 
bio
 *bio;

241 
bio
 = 
	`f2fs_bio_®loc
(
sbi
, 
Åages
, 
Œue
);

243 
	`f2fs_rg‘_deviû
(
sbi
, 
blk_addr
, 
bio
);

244 ià(
is_»ad
) {

245 
bio
->
bi_’d_io
 = 
f2fs_»ad_’d_io
;

246 
bio
->
bi_´iv©e
 = 
NULL
;

248 
bio
->
bi_’d_io
 = 
f2fs_wr™e_’d_io
;

249 
bio
->
bi_´iv©e
 = 
sbi
;

250 
bio
->
bi_wr™e_hšt
 = 
	`f2fs_io_ty³_to_rw_hšt
(
sbi
, 
ty³
, 
‹mp
);

252 ià(
wbc
)

253 
	`wbc_š™_bio
(
wbc
, 
bio
);

255  
bio
;

256 
	}
}

258 
šlše
 
	$__subm™_bio
(
f2fs_sb_šfo
 *
sbi
,

259 
bio
 *bio, 
·ge_ty³
 
ty³
)

261 ià(!
	`is_»ad_io
(
	`bio_İ
(
bio
))) {

262 
¡¬t
;

264 ià(
ty³
 !ğ
DATA
 &&y³ !ğ
NODE
)

265 
subm™_io
;

267 ià(
	`f2fs_sb_has_blkzÚed
(
sbi
->
sb
è&& 
cu¼’t
->
¶ug
)

268 
	`blk_fšish_¶ug
(
cu¼’t
->
¶ug
);

270 
¡¬t
 = 
bio
->
bi_™”
.
bi_size
 >> 
F2FS_BLKSIZE_BITS
;

271 
¡¬t
 %ğ
	`F2FS_IO_SIZE
(
sbi
);

273 ià(
¡¬t
 == 0)

274 
subm™_io
;

277 ; 
¡¬t
 < 
	`F2FS_IO_SIZE
(
sbi
); start++) {

278 
·ge
 *page =

279 
	`mempoŞ_®loc
(
sbi
->
wr™e_io_dummy
,

280 
GFP_NOIO
 | 
__GFP_ZERO
 | 
__GFP_NOFAIL
);

281 
	`f2fs_bug_Ú
(
sbi
, !
·ge
);

283 
	`S‘PagePriv©e
(
·ge
);

284 
	`£t_·ge_´iv©e
(
·ge
, ()
DUMMY_WRITTEN_PAGE
);

285 
	`lock_·ge
(
·ge
);

286 ià(
	`bio_add_·ge
(
bio
, 
·ge
, 
PAGE_SIZE
, 0) < PAGE_SIZE)

287 
	`f2fs_bug_Ú
(
sbi
, 1);

293 ià(
ty³
 =ğ
NODE
)

294 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_CP
);

296 
subm™_io
:

297 ià(
	`is_»ad_io
(
	`bio_İ
(
bio
)))

298 
	`Œaû_f2fs_subm™_»ad_bio
(
sbi
->
sb
, 
ty³
, 
bio
);

300 
	`Œaû_f2fs_subm™_wr™e_bio
(
sbi
->
sb
, 
ty³
, 
bio
);

301 
	`subm™_bio
(
bio
);

302 
	}
}

304 
	$__subm™_m”ged_bio
(
f2fs_bio_šfo
 *
io
)

306 
f2fs_io_šfo
 *
fio
 = &
io
->fio;

308 ià(!
io
->
bio
)

311 
	`bio_£t_İ_©Œs
(
io
->
bio
, 
fio
->
İ
, fio->
İ_æags
);

313 ià(
	`is_»ad_io
(
fio
->
İ
))

314 
	`Œaû_f2fs_´•¬e_»ad_bio
(
io
->
sbi
->
sb
, 
fio
->
ty³
, io->
bio
);

316 
	`Œaû_f2fs_´•¬e_wr™e_bio
(
io
->
sbi
->
sb
, 
fio
->
ty³
, io->
bio
);

318 
	`__subm™_bio
(
io
->
sbi
, io->
bio
, 
fio
->
ty³
);

319 
io
->
bio
 = 
NULL
;

320 
	}
}

322 
boŞ
 
	$__has_m”ged_·ge
(
f2fs_bio_šfo
 *
io
,

323 
šode
 *šode, 
nid_t
 
šo
, 
pgoff_t
 
idx
)

325 
bio_vec
 *
bvec
;

326 
·ge
 *
rg‘
;

327 
i
;

329 ià(!
io
->
bio
)

330  
çl£
;

332 ià(!
šode
 && !
šo
)

333  
Œue
;

335 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
io
->
bio
, 
i
) {

337 ià(
bvec
->
bv_·ge
->
m­pšg
)

338 
rg‘
 = 
bvec
->
bv_·ge
;

340 
rg‘
 = 
	`fsüy±_cÚŒŞ_·ge
(
bvec
->
bv_·ge
);

342 ià(
idx
 !ğ
rg‘
->
šdex
)

345 ià(
šode
 && inod=ğ
rg‘
->
m­pšg
->
ho¡
)

346  
Œue
;

347 ià(
šo
 && inØ=ğ
	`šo_of_node
(
rg‘
))

348  
Œue
;

351  
çl£
;

352 
	}
}

354 
boŞ
 
	$has_m”ged_·ge
(
f2fs_sb_šfo
 *
sbi
, 
šode
 *inode,

355 
nid_t
 
šo
, 
pgoff_t
 
idx
, 
·ge_ty³
 
ty³
)

357 
·ge_ty³
 
bty³
 = 
	`PAGE_TYPE_OF_BIO
(
ty³
);

358 
‹mp_ty³
 
‹mp
;

359 
f2fs_bio_šfo
 *
io
;

360 
boŞ
 
»t
 = 
çl£
;

362 
‹mp
 = 
HOT
;em°< 
NR_TEMP_TYPE
;emp++) {

363 
io
 = 
sbi
->
wr™e_io
[
bty³
] + 
‹mp
;

365 
	`down_»ad
(&
io
->
io_rw£m
);

366 
»t
 = 
	`__has_m”ged_·ge
(
io
, 
šode
, 
šo
, 
idx
);

367 
	`up_»ad
(&
io
->
io_rw£m
);

370 ià(
»t
 || 
bty³
 =ğ
META
)

373  
»t
;

374 
	}
}

376 
	$__f2fs_subm™_m”ged_wr™e
(
f2fs_sb_šfo
 *
sbi
,

377 
·ge_ty³
 
ty³
, 
‹mp_ty³
 
‹mp
)

379 
·ge_ty³
 
bty³
 = 
	`PAGE_TYPE_OF_BIO
(
ty³
);

380 
f2fs_bio_šfo
 *
io
 = 
sbi
->
wr™e_io
[
bty³
] + 
‹mp
;

382 
	`down_wr™e
(&
io
->
io_rw£m
);

385 ià(
ty³
 >ğ
META_FLUSH
) {

386 
io
->
fio
.
ty³
 = 
META_FLUSH
;

387 
io
->
fio
.
İ
 = 
REQ_OP_WRITE
;

388 
io
->
fio
.
İ_æags
 = 
REQ_META
 | 
REQ_PRIO
 | 
REQ_SYNC
;

389 ià(!
	`‹¡_İt
(
sbi
, 
NOBARRIER
))

390 
io
->
fio
.
İ_æags
 |ğ
REQ_PREFLUSH
 | 
REQ_FUA
;

392 
	`__subm™_m”ged_bio
(
io
);

393 
	`up_wr™e
(&
io
->
io_rw£m
);

394 
	}
}

396 
	$__subm™_m”ged_wr™e_cÚd
(
f2fs_sb_šfo
 *
sbi
,

397 
šode
 *šode, 
nid_t
 
šo
, 
pgoff_t
 
idx
,

398 
·ge_ty³
 
ty³
, 
boŞ
 
fÜû
)

400 
‹mp_ty³
 
‹mp
;

402 ià(!
fÜû
 && !
	`has_m”ged_·ge
(
sbi
, 
šode
, 
šo
, 
idx
, 
ty³
))

405 
‹mp
 = 
HOT
;em°< 
NR_TEMP_TYPE
;emp++) {

407 
	`__f2fs_subm™_m”ged_wr™e
(
sbi
, 
ty³
, 
‹mp
);

410 ià(
ty³
 >ğ
META
)

413 
	}
}

415 
	$f2fs_subm™_m”ged_wr™e
(
f2fs_sb_šfo
 *
sbi
, 
·ge_ty³
 
ty³
)

417 
	`__subm™_m”ged_wr™e_cÚd
(
sbi
, 
NULL
, 0, 0, 
ty³
, 
Œue
);

418 
	}
}

420 
	$f2fs_subm™_m”ged_wr™e_cÚd
(
f2fs_sb_šfo
 *
sbi
,

421 
šode
 *šode, 
nid_t
 
šo
, 
pgoff_t
 
idx
,

422 
·ge_ty³
 
ty³
)

424 
	`__subm™_m”ged_wr™e_cÚd
(
sbi
, 
šode
, 
šo
, 
idx
, 
ty³
, 
çl£
);

425 
	}
}

427 
	$f2fs_æush_m”ged_wr™es
(
f2fs_sb_šfo
 *
sbi
)

429 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
DATA
);

430 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
NODE
);

431 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
META
);

432 
	}
}

438 
	$f2fs_subm™_·ge_bio
(
f2fs_io_šfo
 *
fio
)

440 
bio
 *bio;

441 
·ge
 *·gğ
fio
->
’üy±ed_·ge
 ?

442 
fio
->
’üy±ed_·ge
 : fio->
·ge
;

444 
	`v”ify_block_addr
(
fio
, fio->
Ãw_blkaddr
);

445 
	`Œaû_f2fs_subm™_·ge_bio
(
·ge
, 
fio
);

446 
	`f2fs_Œaû_ios
(
fio
, 0);

449 
bio
 = 
	`__bio_®loc
(
fio
->
sbi
, fio->
Ãw_blkaddr
, fio->
io_wbc
,

450 1, 
	`is_»ad_io
(
fio
->
İ
), fio->
ty³
, fio->
‹mp
);

452 ià(
	`bio_add_·ge
(
bio
, 
·ge
, 
PAGE_SIZE
, 0) < PAGE_SIZE) {

453 
	`bio_put
(
bio
);

454  -
EFAULT
;

456 
	`bio_£t_İ_©Œs
(
bio
, 
fio
->
İ
, fio->
İ_æags
);

458 
	`__subm™_bio
(
fio
->
sbi
, 
bio
, fio->
ty³
);

460 ià(!
	`is_»ad_io
(
fio
->
İ
))

461 
	`šc_·ge_couÁ
(
fio
->
sbi
, 
	`WB_DATA_TYPE
(fio->
·ge
));

463 
	}
}

465 
	$f2fs_subm™_·ge_wr™e
(
f2fs_io_šfo
 *
fio
)

467 
f2fs_sb_šfo
 *
sbi
 = 
fio
->sbi;

468 
·ge_ty³
 
bty³
 = 
	`PAGE_TYPE_OF_BIO
(
fio
->
ty³
);

469 
f2fs_bio_šfo
 *
io
 = 
sbi
->
wr™e_io
[
bty³
] + 
fio
->
‹mp
;

470 
·ge
 *
bio_·ge
;

472 
	`f2fs_bug_Ú
(
sbi
, 
	`is_»ad_io
(
fio
->
İ
));

474 
	`down_wr™e
(&
io
->
io_rw£m
);

475 
Ãxt
:

476 ià(
fio
->
š_li¡
) {

477 
	`¥š_lock
(&
io
->
io_lock
);

478 ià(
	`li¡_em±y
(&
io
->
io_li¡
)) {

479 
	`¥š_uÆock
(&
io
->
io_lock
);

480 
out
;

482 
fio
 = 
	`li¡_fœ¡_’Œy
(&
io
->
io_li¡
,

483 
f2fs_io_šfo
, 
li¡
);

484 
	`li¡_d–
(&
fio
->
li¡
);

485 
	`¥š_uÆock
(&
io
->
io_lock
);

488 ià(
	`is_v®id_blkaddr
(
fio
->
Şd_blkaddr
))

489 
	`v”ify_block_addr
(
fio
, fio->
Şd_blkaddr
);

490 
	`v”ify_block_addr
(
fio
, fio->
Ãw_blkaddr
);

492 
bio_·ge
 = 
fio
->
’üy±ed_·ge
 ? fio->’üy±ed_·g: fio->
·ge
;

495 
fio
->
subm™‹d
 = 
Œue
;

497 
	`šc_·ge_couÁ
(
sbi
, 
	`WB_DATA_TYPE
(
bio_·ge
));

499 ià(
io
->
bio
 && (io->
Ï¡_block_š_bio
 !ğ
fio
->
Ãw_blkaddr
 - 1 ||

500 (
io
->
fio
.
İ
 !ğfio->İ || io->fio.
İ_æags
 != fio->op_flags) ||

501 !
	`__§me_bdev
(
sbi
, 
fio
->
Ãw_blkaddr
, 
io
->
bio
)))

502 
	`__subm™_m”ged_bio
(
io
);

503 
®loc_Ãw
:

504 ià(
io
->
bio
 =ğ
NULL
) {

505 ià((
fio
->
ty³
 =ğ
DATA
 || fio->ty³ =ğ
NODE
) &&

506 
fio
->
Ãw_blkaddr
 & 
	`F2FS_IO_SIZE_MASK
(
sbi
)) {

507 
	`dec_·ge_couÁ
(
sbi
, 
	`WB_DATA_TYPE
(
bio_·ge
));

508 
fio
->
»Œy
 = 
Œue
;

509 
sk
;

511 
io
->
bio
 = 
	`__bio_®loc
(
sbi
, 
fio
->
Ãw_blkaddr
, fio->
io_wbc
,

512 
BIO_MAX_PAGES
, 
çl£
,

513 
fio
->
ty³
, fio->
‹mp
);

514 
io
->
fio
 = *fio;

517 ià(
	`bio_add_·ge
(
io
->
bio
, 
bio_·ge
, 
PAGE_SIZE
, 0) < PAGE_SIZE) {

518 
	`__subm™_m”ged_bio
(
io
);

519 
®loc_Ãw
;

522 ià(
fio
->
io_wbc
)

523 
	`wbc_accouÁ_io
(
fio
->
io_wbc
, 
bio_·ge
, 
PAGE_SIZE
);

525 
io
->
Ï¡_block_š_bio
 = 
fio
->
Ãw_blkaddr
;

526 
	`f2fs_Œaû_ios
(
fio
, 0);

528 
	`Œaû_f2fs_subm™_·ge_wr™e
(
fio
->
·ge
, fio);

529 
sk
:

530 ià(
fio
->
š_li¡
)

531 
Ãxt
;

532 
out
:

533 
	`up_wr™e
(&
io
->
io_rw£m
);

534 
	}
}

536 
bio
 *
	$f2fs_g¿b_»ad_bio
(
šode
 *šode, 
block_t
 
blkaddr
,

537 
Ä_·ges
)

539 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

540 
bio
 *bio;

541 
bio_po¡_»ad_ùx
 *
ùx
;

542 
po¡_»ad_¡•s
 = 0;

544 
bio
 = 
	`f2fs_bio_®loc
(
sbi
, 
	`mš_t
(, 
Ä_·ges
, 
BIO_MAX_PAGES
), 
çl£
);

545 ià(!
bio
)

546  
	`ERR_PTR
(-
ENOMEM
);

547 
	`f2fs_rg‘_deviû
(
sbi
, 
blkaddr
, 
bio
);

548 
bio
->
bi_’d_io
 = 
f2fs_»ad_’d_io
;

549 
	`bio_£t_İ_©Œs
(
bio
, 
REQ_OP_READ
, 0);

551 ià(
	`f2fs_’üy±ed_fe
(
šode
))

552 
po¡_»ad_¡•s
 |ğ1 << 
STEP_DECRYPT
;

553 ià(
po¡_»ad_¡•s
) {

554 
ùx
 = 
	`mempoŞ_®loc
(
bio_po¡_»ad_ùx_poŞ
, 
GFP_NOFS
);

555 ià(!
ùx
) {

556 
	`bio_put
(
bio
);

557  
	`ERR_PTR
(-
ENOMEM
);

559 
ùx
->
bio
 = bio;

560 
ùx
->
’abËd_¡•s
 = 
po¡_»ad_¡•s
;

561 
bio
->
bi_´iv©e
 = 
ùx
;

564 
	`f2fs_wa™_Ú_block_wr™eback
(
sbi
, 
blkaddr
);

567  
bio
;

568 
	}
}

571 
	$f2fs_subm™_·ge_»ad
(
šode
 *šode, 
·ge
 *page,

572 
block_t
 
blkaddr
)

574 
bio
 *biØğ
	`f2fs_g¿b_»ad_bio
(
šode
, 
blkaddr
, 1);

576 ià(
	`IS_ERR
(
bio
))

577  
	`PTR_ERR
(
bio
);

579 ià(
	`bio_add_·ge
(
bio
, 
·ge
, 
PAGE_SIZE
, 0) < PAGE_SIZE) {

580 
	`bio_put
(
bio
);

581  -
EFAULT
;

583 
	`__subm™_bio
(
	`F2FS_I_SB
(
šode
), 
bio
, 
DATA
);

585 
	}
}

587 
	$__£t_d©a_blkaddr
(
dnode_of_d©a
 *
dn
)

589 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
dn
->
node_·ge
);

590 
__Ë32
 *
addr_¬¿y
;

591 
ba£
 = 0;

593 ià(
	`IS_INODE
(
dn
->
node_·ge
è&& 
	`f2fs_has_exŒa_©Œ
(dn->
šode
))

594 
ba£
 = 
	`g‘_exŒa_isize
(
dn
->
šode
);

597 
addr_¬¿y
 = 
	`blkaddr_š_node
(
º
);

598 
addr_¬¿y
[
ba£
 + 
dn
->
ofs_š_node
] = 
	`ıu_to_Ë32
(dn->
d©a_blkaddr
);

599 
	}
}

607 
	$f2fs_£t_d©a_blkaddr
(
dnode_of_d©a
 *
dn
)

609 
	`f2fs_wa™_Ú_·ge_wr™eback
(
dn
->
node_·ge
, 
NODE
, 
Œue
);

610 
	`__£t_d©a_blkaddr
(
dn
);

611 ià(
	`£t_·ge_dœty
(
dn
->
node_·ge
))

612 
dn
->
node_chªged
 = 
Œue
;

613 
	}
}

615 
	$f2fs_upd©e_d©a_blkaddr
(
dnode_of_d©a
 *
dn
, 
block_t
 
blkaddr
)

617 
dn
->
d©a_blkaddr
 = 
blkaddr
;

618 
	`f2fs_£t_d©a_blkaddr
(
dn
);

619 
	`f2fs_upd©e_ex‹Á_ÿche
(
dn
);

620 
	}
}

623 
	$f2fs_»£rve_Ãw_blocks
(
dnode_of_d©a
 *
dn
, 
blkút_t
 
couÁ
)

625 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

626 
”r
;

628 ià(!
couÁ
)

631 ià(
	`uÆik–y
(
	`is_šode_æag_£t
(
dn
->
šode
, 
FI_NO_ALLOC
)))

632  -
EPERM
;

633 ià(
	`uÆik–y
((
”r
 = 
	`šc_v®id_block_couÁ
(
sbi
, 
dn
->
šode
, &
couÁ
))))

634  
”r
;

636 
	`Œaû_f2fs_»£rve_Ãw_blocks
(
dn
->
šode
, dn->
nid
,

637 
dn
->
ofs_š_node
, 
couÁ
);

639 
	`f2fs_wa™_Ú_·ge_wr™eback
(
dn
->
node_·ge
, 
NODE
, 
Œue
);

641 ; 
couÁ
 > 0; 
dn
->
ofs_š_node
++) {

642 
block_t
 
blkaddr
 = 
	`d©ablock_addr
(
dn
->
šode
,

643 
dn
->
node_·ge
, dn->
ofs_š_node
);

644 ià(
blkaddr
 =ğ
NULL_ADDR
) {

645 
dn
->
d©a_blkaddr
 = 
NEW_ADDR
;

646 
	`__£t_d©a_blkaddr
(
dn
);

647 
couÁ
--;

651 ià(
	`£t_·ge_dœty
(
dn
->
node_·ge
))

652 
dn
->
node_chªged
 = 
Œue
;

654 
	}
}

657 
	$f2fs_»£rve_Ãw_block
(
dnode_of_d©a
 *
dn
)

659 
ofs_š_node
 = 
dn
->ofs_in_node;

660 
»t
;

662 
»t
 = 
	`f2fs_»£rve_Ãw_blocks
(
dn
, 1);

663 
dn
->
ofs_š_node
 = ofs_in_node;

664  
»t
;

665 
	}
}

667 
	$f2fs_»£rve_block
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
)

669 
boŞ
 
Ãed_put
 = 
dn
->
šode_·ge
 ? 
çl£
 : 
Œue
;

670 
”r
;

672 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(
dn
, 
šdex
, 
ALLOC_NODE
);

673 ià(
”r
)

674  
”r
;

676 ià(
dn
->
d©a_blkaddr
 =ğ
NULL_ADDR
)

677 
”r
 = 
	`f2fs_»£rve_Ãw_block
(
dn
);

678 ià(
”r
 || 
Ãed_put
)

679 
	`f2fs_put_dnode
(
dn
);

680  
”r
;

681 
	}
}

683 
	$f2fs_g‘_block
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
)

685 
ex‹Á_šfo
 
ei
 = {0,0,0};

686 
šode
 *šodğ
dn
->inode;

688 ià(
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
šdex
, &
ei
)) {

689 
dn
->
d©a_blkaddr
 = 
ei
.
blk
 + 
šdex
 -ƒi.
fofs
;

693  
	`f2fs_»£rve_block
(
dn
, 
šdex
);

694 
	}
}

696 
·ge
 *
	$f2fs_g‘_»ad_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
,

697 
İ_æags
, 
boŞ
 
fÜ_wr™e
)

699 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

700 
dnode_of_d©a
 
dn
;

701 
·ge
 *page;

702 
ex‹Á_šfo
 
ei
 = {0,0,0};

703 
”r
;

705 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
m­pšg
, 
šdex
, 
fÜ_wr™e
);

706 ià(!
·ge
)

707  
	`ERR_PTR
(-
ENOMEM
);

709 ià(
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
šdex
, &
ei
)) {

710 
dn
.
d©a_blkaddr
 = 
ei
.
blk
 + 
šdex
 -ƒi.
fofs
;

711 
gÙ_™
;

714 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

715 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
šdex
, 
LOOKUP_NODE
);

716 ià(
”r
)

717 
put_”r
;

718 
	`f2fs_put_dnode
(&
dn
);

720 ià(
	`uÆik–y
(
dn
.
d©a_blkaddr
 =ğ
NULL_ADDR
)) {

721 
”r
 = -
ENOENT
;

722 
put_”r
;

724 
gÙ_™
:

725 ià(
	`PageU±od©e
(
·ge
)) {

726 
	`uÆock_·ge
(
·ge
);

727  
·ge
;

737 ià(
dn
.
d©a_blkaddr
 =ğ
NEW_ADDR
) {

738 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

739 ià(!
	`PageU±od©e
(
·ge
))

740 
	`S‘PageU±od©e
(
·ge
);

741 
	`uÆock_·ge
(
·ge
);

742  
·ge
;

745 
”r
 = 
	`f2fs_subm™_·ge_»ad
(
šode
, 
·ge
, 
dn
.
d©a_blkaddr
);

746 ià(
”r
)

747 
put_”r
;

748  
·ge
;

750 
put_”r
:

751 
	`f2fs_put_·ge
(
·ge
, 1);

752  
	`ERR_PTR
(
”r
);

753 
	}
}

755 
·ge
 *
	$f2fs_fšd_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
)

757 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

758 
·ge
 *page;

760 
·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
šdex
);

761 ià(
·ge
 && 
	`PageU±od©e
(page))

762  
·ge
;

763 
	`f2fs_put_·ge
(
·ge
, 0);

765 
·ge
 = 
	`f2fs_g‘_»ad_d©a_·ge
(
šode
, 
šdex
, 0, 
çl£
);

766 ià(
	`IS_ERR
(
·ge
))

767  
·ge
;

769 ià(
	`PageU±od©e
(
·ge
))

770  
·ge
;

772 
	`wa™_Ú_·ge_locked
(
·ge
);

773 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

774 
	`f2fs_put_·ge
(
·ge
, 0);

775  
	`ERR_PTR
(-
EIO
);

777  
·ge
;

778 
	}
}

785 
·ge
 *
	$f2fs_g‘_lock_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
,

786 
boŞ
 
fÜ_wr™e
)

788 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

789 
·ge
 *page;

790 
»³©
:

791 
·ge
 = 
	`f2fs_g‘_»ad_d©a_·ge
(
šode
, 
šdex
, 0, 
fÜ_wr™e
);

792 ià(
	`IS_ERR
(
·ge
))

793  
·ge
;

796 
	`lock_·ge
(
·ge
);

797 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

798 
	`f2fs_put_·ge
(
·ge
, 1);

799 
»³©
;

801 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

802 
	`f2fs_put_·ge
(
·ge
, 1);

803  
	`ERR_PTR
(-
EIO
);

805  
·ge
;

806 
	}
}

817 
·ge
 *
	$f2fs_g‘_Ãw_d©a_·ge
(
šode
 *inode,

818 
·ge
 *
age
, 
pgoff_t
 
šdex
, 
boŞ
 
Ãw_i_size
)

820 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

821 
·ge
 *page;

822 
dnode_of_d©a
 
dn
;

823 
”r
;

825 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
m­pšg
, 
šdex
, 
Œue
);

826 ià(!
·ge
) {

831 
	`f2fs_put_·ge
(
age
, 1);

832  
	`ERR_PTR
(-
ENOMEM
);

835 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
age
, 
NULL
, 0);

836 
”r
 = 
	`f2fs_»£rve_block
(&
dn
, 
šdex
);

837 ià(
”r
) {

838 
	`f2fs_put_·ge
(
·ge
, 1);

839  
	`ERR_PTR
(
”r
);

841 ià(!
age
)

842 
	`f2fs_put_dnode
(&
dn
);

844 ià(
	`PageU±od©e
(
·ge
))

845 
gÙ_™
;

847 ià(
dn
.
d©a_blkaddr
 =ğ
NEW_ADDR
) {

848 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

849 ià(!
	`PageU±od©e
(
·ge
))

850 
	`S‘PageU±od©e
(
·ge
);

852 
	`f2fs_put_·ge
(
·ge
, 1);

855 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
), 
age
);

856 
·ge
 = 
	`f2fs_g‘_lock_d©a_·ge
(
šode
, 
šdex
, 
Œue
);

857 ià(
	`IS_ERR
(
·ge
))

858  
·ge
;

860 
gÙ_™
:

861 ià(
Ãw_i_size
 && 
	`i_size_»ad
(
šode
) <

862 ((
loff_t
)(
šdex
 + 1è<< 
PAGE_SHIFT
))

863 
	`f2fs_i_size_wr™e
(
šode
, ((
loff_t
)(
šdex
 + 1è<< 
PAGE_SHIFT
));

864  
·ge
;

865 
	}
}

867 
	$__®loÿ‹_d©a_block
(
dnode_of_d©a
 *
dn
, 
£g_ty³
)

869 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

870 
f2fs_summ¬y
 
sum
;

871 
node_šfo
 
ni
;

872 
pgoff_t
 
fofs
;

873 
blkút_t
 
couÁ
 = 1;

874 
”r
;

876 ià(
	`uÆik–y
(
	`is_šode_æag_£t
(
dn
->
šode
, 
FI_NO_ALLOC
)))

877  -
EPERM
;

879 
dn
->
d©a_blkaddr
 = 
	`d©ablock_addr
(dn->
šode
,

880 
dn
->
node_·ge
, dn->
ofs_š_node
);

881 ià(
dn
->
d©a_blkaddr
 =ğ
NEW_ADDR
)

882 
®loc
;

884 ià(
	`uÆik–y
((
”r
 = 
	`šc_v®id_block_couÁ
(
sbi
, 
dn
->
šode
, &
couÁ
))))

885  
”r
;

887 
®loc
:

888 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
->
nid
, &
ni
);

889 
	`£t_summ¬y
(&
sum
, 
dn
->
nid
, dn->
ofs_š_node
, 
ni
.
v”siÚ
);

891 
	`f2fs_®loÿ‹_d©a_block
(
sbi
, 
NULL
, 
dn
->
d©a_blkaddr
, &dn->data_blkaddr,

892 &
sum
, 
£g_ty³
, 
NULL
, 
çl£
);

893 
	`f2fs_£t_d©a_blkaddr
(
dn
);

896 
fofs
 = 
	`f2fs_¡¬t_bidx_of_node
(
	`ofs_of_node
(
dn
->
node_·ge
), dn->
šode
) +

897 
dn
->
ofs_š_node
;

898 ià(
	`i_size_»ad
(
dn
->
šode
è< ((
loff_t
)(
fofs
 + 1è<< 
PAGE_SHIFT
))

899 
	`f2fs_i_size_wr™e
(
dn
->
šode
,

900 ((
loff_t
)(
fofs
 + 1è<< 
PAGE_SHIFT
));

902 
	}
}

904 
	$f2fs_´—Îoÿ‹_blocks
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

906 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

907 
f2fs_m­_blocks
 
m­
;

908 
æag
;

909 
”r
 = 0;

910 
boŞ
 
dœeù_io
 = 
iocb
->
ki_æags
 & 
IOCB_DIRECT
;

913 ià(
dœeù_io
) {

914 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

915 ià(
”r
)

916  
”r
;

919 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NO_PREALLOC
))

922 
m­
.
m_lblk
 = 
	`F2FS_BLK_ALIGN
(
iocb
->
ki_pos
);

923 
m­
.
m_Ën
 = 
	`F2FS_BYTES_TO_BLK
(
iocb
->
ki_pos
 + 
	`iov_™”_couÁ
(
äom
));

924 ià(
m­
.
m_Ën
 > m­.
m_lblk
)

925 
m­
.
m_Ën
 -ğm­.
m_lblk
;

927 
m­
.
m_Ën
 = 0;

929 
m­
.
m_Ãxt_pgofs
 = 
NULL
;

930 
m­
.
m_Ãxt_ex‹Á
 = 
NULL
;

931 
m­
.
m_£g_ty³
 = 
NO_CHECK_TYPE
;

933 ià(
dœeù_io
) {

934 
m­
.
m_£g_ty³
 = 
	`f2fs_rw_hšt_to_£g_ty³
(
iocb
->
ki_hšt
);

935 
æag
 = 
	`f2fs_fÜû_bufã»d_io
(
šode
, 
WRITE
) ?

936 
F2FS_GET_BLOCK_PRE_AIO
 :

937 
F2FS_GET_BLOCK_PRE_DIO
;

938 
m­_blocks
;

940 ià(
iocb
->
ki_pos
 + 
	`iov_™”_couÁ
(
äom
è> 
	`MAX_INLINE_DATA
(
šode
)) {

941 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

942 ià(
”r
)

943  
”r
;

945 ià(
	`f2fs_has_šlše_d©a
(
šode
))

946  
”r
;

948 
æag
 = 
F2FS_GET_BLOCK_PRE_AIO
;

950 
m­_blocks
:

951 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 1, 
æag
);

952 ià(
m­
.
m_Ën
 > 0 && 
”r
 =ğ-
ENOSPC
) {

953 ià(!
dœeù_io
)

954 
	`£t_šode_æag
(
šode
, 
FI_NO_PREALLOC
);

955 
”r
 = 0;

957  
”r
;

958 
	}
}

960 
šlše
 
	$__do_m­_lock
(
f2fs_sb_šfo
 *
sbi
, 
æag
, 
boŞ
 
lock
)

962 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRE_AIO
) {

963 ià(
lock
)

964 
	`down_»ad
(&
sbi
->
node_chªge
);

966 
	`up_»ad
(&
sbi
->
node_chªge
);

968 ià(
lock
)

969 
	`f2fs_lock_İ
(
sbi
);

971 
	`f2fs_uÆock_İ
(
sbi
);

973 
	}
}

984 
	$f2fs_m­_blocks
(
šode
 *šode, 
f2fs_m­_blocks
 *
m­
,

985 
ü—‹
, 
æag
)

987 
maxblocks
 = 
m­
->
m_Ën
;

988 
dnode_of_d©a
 
dn
;

989 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

990 
mode
 = 
ü—‹
 ? 
ALLOC_NODE
 : 
LOOKUP_NODE
;

991 
pgoff_t
 
pgofs
, 
’d_off£t
, 
’d
;

992 
”r
 = 0, 
ofs
 = 1;

993 
ofs_š_node
, 
Ï¡_ofs_š_node
;

994 
blkút_t
 
´—Îoc
;

995 
ex‹Á_šfo
 
ei
 = {0,0,0};

996 
block_t
 
blkaddr
;

997 
¡¬t_pgofs
;

999 ià(!
maxblocks
)

1002 
m­
->
m_Ën
 = 0;

1003 
m­
->
m_æags
 = 0;

1006 
pgofs
 = (
pgoff_t
)
m­
->
m_lblk
;

1007 
’d
 = 
pgofs
 + 
maxblocks
;

1009 ià(!
ü—‹
 && 
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
pgofs
, &
ei
)) {

1010 
m­
->
m_pblk
 = 
ei
.
blk
 + 
pgofs
 -ƒi.
fofs
;

1011 
m­
->
m_Ën
 = 
	`mš
((
pgoff_t
)
maxblocks
, 
ei
.
fofs
 +ƒi.
Ën
 - 
pgofs
);

1012 
m­
->
m_æags
 = 
F2FS_MAP_MAPPED
;

1013 ià(
m­
->
m_Ãxt_ex‹Á
)

1014 *
m­
->
m_Ãxt_ex‹Á
 = 
pgofs
 + m­->
m_Ën
;

1015 
out
;

1018 
Ãxt_dnode
:

1019 ià(
ü—‹
)

1020 
	`__do_m­_lock
(
sbi
, 
æag
, 
Œue
);

1023 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

1024 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
pgofs
, 
mode
);

1025 ià(
”r
) {

1026 ià(
æag
 =ğ
F2FS_GET_BLOCK_BMAP
)

1027 
m­
->
m_pblk
 = 0;

1028 ià(
”r
 =ğ-
ENOENT
) {

1029 
”r
 = 0;

1030 ià(
m­
->
m_Ãxt_pgofs
)

1031 *
m­
->
m_Ãxt_pgofs
 =

1032 
	`f2fs_g‘_Ãxt_·ge_off£t
(&
dn
, 
pgofs
);

1033 ià(
m­
->
m_Ãxt_ex‹Á
)

1034 *
m­
->
m_Ãxt_ex‹Á
 =

1035 
	`f2fs_g‘_Ãxt_·ge_off£t
(&
dn
, 
pgofs
);

1037 
uÆock_out
;

1040 
¡¬t_pgofs
 = 
pgofs
;

1041 
´—Îoc
 = 0;

1042 
Ï¡_ofs_š_node
 = 
ofs_š_node
 = 
dn
.ofs_in_node;

1043 
’d_off£t
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
šode
);

1045 
Ãxt_block
:

1046 
blkaddr
 = 
	`d©ablock_addr
(
dn
.
šode
, dn.
node_·ge
, dn.
ofs_š_node
);

1048 ià(!
	`is_v®id_blkaddr
(
blkaddr
)) {

1049 ià(
ü—‹
) {

1050 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1051 
”r
 = -
EIO
;

1052 
sync_out
;

1054 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRE_AIO
) {

1055 ià(
blkaddr
 =ğ
NULL_ADDR
) {

1056 
´—Îoc
++;

1057 
Ï¡_ofs_š_node
 = 
dn
.
ofs_š_node
;

1060 
”r
 = 
	`__®loÿ‹_d©a_block
(&
dn
,

1061 
m­
->
m_£g_ty³
);

1062 ià(!
”r
)

1063 
	`£t_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

1065 ià(
”r
)

1066 
sync_out
;

1067 
m­
->
m_æags
 |ğ
F2FS_MAP_NEW
;

1068 
blkaddr
 = 
dn
.
d©a_blkaddr
;

1070 ià(
æag
 =ğ
F2FS_GET_BLOCK_BMAP
) {

1071 
m­
->
m_pblk
 = 0;

1072 
sync_out
;

1074 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRECACHE
)

1075 
sync_out
;

1076 ià(
æag
 =ğ
F2FS_GET_BLOCK_FIEMAP
 &&

1077 
blkaddr
 =ğ
NULL_ADDR
) {

1078 ià(
m­
->
m_Ãxt_pgofs
)

1079 *
m­
->
m_Ãxt_pgofs
 = 
pgofs
 + 1;

1080 
sync_out
;

1082 ià(
æag
 !ğ
F2FS_GET_BLOCK_FIEMAP
) {

1084 ià(
m­
->
m_Ãxt_pgofs
)

1085 *
m­
->
m_Ãxt_pgofs
 = 
pgofs
 + 1;

1086 
sync_out
;

1091 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRE_AIO
)

1092 
sk
;

1094 ià(
m­
->
m_Ën
 == 0) {

1096 ià(
blkaddr
 =ğ
NEW_ADDR
)

1097 
m­
->
m_æags
 |ğ
F2FS_MAP_UNWRITTEN
;

1098 
m­
->
m_æags
 |ğ
F2FS_MAP_MAPPED
;

1100 
m­
->
m_pblk
 = 
blkaddr
;

1101 
m­
->
m_Ën
 = 1;

1102 } ià((
m­
->
m_pblk
 !ğ
NEW_ADDR
 &&

1103 
blkaddr
 =ğ(
m­
->
m_pblk
 + 
ofs
)) ||

1104 (
m­
->
m_pblk
 =ğ
NEW_ADDR
 && 
blkaddr
 == NEW_ADDR) ||

1105 
æag
 =ğ
F2FS_GET_BLOCK_PRE_DIO
) {

1106 
ofs
++;

1107 
m­
->
m_Ën
++;

1109 
sync_out
;

1112 
sk
:

1113 
dn
.
ofs_š_node
++;

1114 
pgofs
++;

1117 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRE_AIO
 &&

1118 (
pgofs
 =ğ
’d
 || 
dn
.
ofs_š_node
 =ğ
’d_off£t
)) {

1120 
dn
.
ofs_š_node
 = ofs_in_node;

1121 
”r
 = 
	`f2fs_»£rve_Ãw_blocks
(&
dn
, 
´—Îoc
);

1122 ià(
”r
)

1123 
sync_out
;

1125 
m­
->
m_Ën
 +ğ
dn
.
ofs_š_node
 - ofs_in_node;

1126 ià(
´—Îoc
 && 
dn
.
ofs_š_node
 !ğ
Ï¡_ofs_š_node
 + 1) {

1127 
”r
 = -
ENOSPC
;

1128 
sync_out
;

1130 
dn
.
ofs_š_node
 = 
’d_off£t
;

1133 ià(
pgofs
 >ğ
’d
)

1134 
sync_out
;

1135 ià(
dn
.
ofs_š_node
 < 
’d_off£t
)

1136 
Ãxt_block
;

1138 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRECACHE
) {

1139 ià(
m­
->
m_æags
 & 
F2FS_MAP_MAPPED
) {

1140 
ofs
 = 
¡¬t_pgofs
 - 
m­
->
m_lblk
;

1142 
	`f2fs_upd©e_ex‹Á_ÿche_¿nge
(&
dn
,

1143 
¡¬t_pgofs
, 
m­
->
m_pblk
 + 
ofs
,

1144 
m­
->
m_Ën
 - 
ofs
);

1148 
	`f2fs_put_dnode
(&
dn
);

1150 ià(
ü—‹
) {

1151 
	`__do_m­_lock
(
sbi
, 
æag
, 
çl£
);

1152 
	`f2fs_b®ªû_fs
(
sbi
, 
dn
.
node_chªged
);

1154 
Ãxt_dnode
;

1156 
sync_out
:

1157 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRECACHE
) {

1158 ià(
m­
->
m_æags
 & 
F2FS_MAP_MAPPED
) {

1159 
ofs
 = 
¡¬t_pgofs
 - 
m­
->
m_lblk
;

1161 
	`f2fs_upd©e_ex‹Á_ÿche_¿nge
(&
dn
,

1162 
¡¬t_pgofs
, 
m­
->
m_pblk
 + 
ofs
,

1163 
m­
->
m_Ën
 - 
ofs
);

1165 ià(
m­
->
m_Ãxt_ex‹Á
)

1166 *
m­
->
m_Ãxt_ex‹Á
 = 
pgofs
 + 1;

1168 
	`f2fs_put_dnode
(&
dn
);

1169 
uÆock_out
:

1170 ià(
ü—‹
) {

1171 
	`__do_m­_lock
(
sbi
, 
æag
, 
çl£
);

1172 
	`f2fs_b®ªû_fs
(
sbi
, 
dn
.
node_chªged
);

1174 
out
:

1175 
	`Œaû_f2fs_m­_blocks
(
šode
, 
m­
, 
”r
);

1176  
”r
;

1177 
	}
}

1179 
boŞ
 
	$f2fs_ov”wr™e_io
(
šode
 *šode, 
loff_t
 
pos
, 
size_t
 
Ën
)

1181 
f2fs_m­_blocks
 
m­
;

1182 
block_t
 
Ï¡_lblk
;

1183 
”r
;

1185 ià(
pos
 + 
Ën
 > 
	`i_size_»ad
(
šode
))

1186  
çl£
;

1188 
m­
.
m_lblk
 = 
	`F2FS_BYTES_TO_BLK
(
pos
);

1189 
m­
.
m_Ãxt_pgofs
 = 
NULL
;

1190 
m­
.
m_Ãxt_ex‹Á
 = 
NULL
;

1191 
m­
.
m_£g_ty³
 = 
NO_CHECK_TYPE
;

1192 
Ï¡_lblk
 = 
	`F2FS_BLK_ALIGN
(
pos
 + 
Ën
);

1194 
m­
.
m_lblk
 < 
Ï¡_lblk
) {

1195 
m­
.
m_Ën
 = 
Ï¡_lblk
 - m­.
m_lblk
;

1196 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 0, 
F2FS_GET_BLOCK_DEFAULT
);

1197 ià(
”r
 || 
m­
.
m_Ën
 == 0)

1198  
çl£
;

1199 
m­
.
m_lblk
 +ğm­.
m_Ën
;

1201  
Œue
;

1202 
	}
}

1204 
	$__g‘_d©a_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1205 
bufãr_h—d
 *
bh
, 
ü—‹
, 
æag
,

1206 
pgoff_t
 *
Ãxt_pgofs
, 
£g_ty³
)

1208 
f2fs_m­_blocks
 
m­
;

1209 
”r
;

1211 
m­
.
m_lblk
 = 
iblock
;

1212 
m­
.
m_Ën
 = 
bh
->
b_size
 >> 
šode
->
i_blkb™s
;

1213 
m­
.
m_Ãxt_pgofs
 = 
Ãxt_pgofs
;

1214 
m­
.
m_Ãxt_ex‹Á
 = 
NULL
;

1215 
m­
.
m_£g_ty³
 = 
£g_ty³
;

1217 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 
ü—‹
, 
æag
);

1218 ià(!
”r
) {

1219 
	`m­_bh
(
bh
, 
šode
->
i_sb
, 
m­
.
m_pblk
);

1220 
bh
->
b_¡©e
 = (bh->b_¡©& ~
F2FS_MAP_FLAGS
è| 
m­
.
m_æags
;

1221 
bh
->
b_size
 = (
u64
)
m­
.
m_Ën
 << 
šode
->
i_blkb™s
;

1223  
”r
;

1224 
	}
}

1226 
	$g‘_d©a_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1227 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
, 
æag
,

1228 
pgoff_t
 *
Ãxt_pgofs
)

1230  
	`__g‘_d©a_block
(
šode
, 
iblock
, 
bh_»suÉ
, 
ü—‹
,

1231 
æag
, 
Ãxt_pgofs
,

1232 
NO_CHECK_TYPE
);

1233 
	}
}

1235 
	$g‘_d©a_block_dio
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1236 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

1238  
	`__g‘_d©a_block
(
šode
, 
iblock
, 
bh_»suÉ
, 
ü—‹
,

1239 
F2FS_GET_BLOCK_DEFAULT
, 
NULL
,

1240 
	`f2fs_rw_hšt_to_£g_ty³
(

1241 
šode
->
i_wr™e_hšt
));

1242 
	}
}

1244 
	$g‘_d©a_block_bm­
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1245 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

1248 ià(
	`uÆik–y
(
iblock
 >ğ
	`F2FS_I_SB
(
šode
)->
max_fe_blocks
))

1249  -
EFBIG
;

1251  
	`__g‘_d©a_block
(
šode
, 
iblock
, 
bh_»suÉ
, 
ü—‹
,

1252 
F2FS_GET_BLOCK_BMAP
, 
NULL
,

1253 
NO_CHECK_TYPE
);

1254 
	}
}

1256 
šlše
 
£ùÜ_t
 
	$logiÿl_to_blk
(
šode
 *šode, 
loff_t
 
off£t
)

1258  (
off£t
 >> 
šode
->
i_blkb™s
);

1259 
	}
}

1261 
šlše
 
loff_t
 
	$blk_to_logiÿl
(
šode
 *šode, 
£ùÜ_t
 
blk
)

1263  (
blk
 << 
šode
->
i_blkb™s
);

1264 
	}
}

1266 
	$f2fs_x©Œ_f›m­
(
šode
 *inode,

1267 
f›m­_ex‹Á_šfo
 *
f›šfo
)

1269 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1270 
·ge
 *page;

1271 
node_šfo
 
ni
;

1272 
__u64
 
phys
 = 0, 
Ën
;

1273 
__u32
 
æags
;

1274 
nid_t
 
xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

1275 
”r
 = 0;

1277 ià(
	`f2fs_has_šlše_x©Œ
(
šode
)) {

1278 
off£t
;

1280 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
),

1281 
šode
->
i_šo
, 
çl£
);

1282 ià(!
·ge
)

1283  -
ENOMEM
;

1285 
	`f2fs_g‘_node_šfo
(
sbi
, 
šode
->
i_šo
, &
ni
);

1287 
phys
 = (
__u64
)
	`blk_to_logiÿl
(
šode
, 
ni
.
blk_addr
);

1288 
off£t
 = 
	`off£tof
(
f2fs_šode
, 
i_addr
) +

1289 (
__Ë32
è* (
DEF_ADDRS_PER_INODE
 -

1290 
	`g‘_šlše_x©Œ_addrs
(
šode
));

1292 
phys
 +ğ
off£t
;

1293 
Ën
 = 
	`šlše_x©Œ_size
(
šode
);

1295 
	`f2fs_put_·ge
(
·ge
, 1);

1297 
æags
 = 
FIEMAP_EXTENT_DATA_INLINE
 | 
FIEMAP_EXTENT_NOT_ALIGNED
;

1299 ià(!
xnid
)

1300 
æags
 |ğ
FIEMAP_EXTENT_LAST
;

1302 
”r
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 0, 
phys
, 
Ën
, 
æags
);

1303 ià(
”r
 ||ƒrr == 1)

1304  
”r
;

1307 ià(
xnid
) {

1308 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
xnid
, 
çl£
);

1309 ià(!
·ge
)

1310  -
ENOMEM
;

1312 
	`f2fs_g‘_node_šfo
(
sbi
, 
xnid
, &
ni
);

1314 
phys
 = (
__u64
)
	`blk_to_logiÿl
(
šode
, 
ni
.
blk_addr
);

1315 
Ën
 = 
šode
->
i_sb
->
s_blocksize
;

1317 
	`f2fs_put_·ge
(
·ge
, 1);

1319 
æags
 = 
FIEMAP_EXTENT_LAST
;

1322 ià(
phys
)

1323 
”r
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 0, 
phys
, 
Ën
, 
æags
);

1325  (
”r
 < 0 ?ƒrr : 0);

1326 
	}
}

1328 
	$f2fs_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

1329 
u64
 
¡¬t
, u64 
Ën
)

1331 
bufãr_h—d
 
m­_bh
;

1332 
£ùÜ_t
 
¡¬t_blk
, 
Ï¡_blk
;

1333 
pgoff_t
 
Ãxt_pgofs
;

1334 
u64
 
logiÿl
 = 0, 
phys
 = 0, 
size
 = 0;

1335 
u32
 
æags
 = 0;

1336 
»t
 = 0;

1338 ià(
f›šfo
->
fi_æags
 & 
FIEMAP_FLAG_CACHE
) {

1339 
»t
 = 
	`f2fs_´eÿche_ex‹Ás
(
šode
);

1340 ià(
»t
)

1341  
»t
;

1344 
»t
 = 
	`f›m­_check_æags
(
f›šfo
, 
FIEMAP_FLAG_SYNC
 | 
FIEMAP_FLAG_XATTR
);

1345 ià(
»t
)

1346  
»t
;

1348 
	`šode_lock
(
šode
);

1350 ià(
f›šfo
->
fi_æags
 & 
FIEMAP_FLAG_XATTR
) {

1351 
»t
 = 
	`f2fs_x©Œ_f›m­
(
šode
, 
f›šfo
);

1352 
out
;

1355 ià(
	`f2fs_has_šlše_d©a
(
šode
)) {

1356 
»t
 = 
	`f2fs_šlše_d©a_f›m­
(
šode
, 
f›šfo
, 
¡¬t
, 
Ën
);

1357 ià(
»t
 !ğ-
EAGAIN
)

1358 
out
;

1361 ià(
	`logiÿl_to_blk
(
šode
, 
Ën
) == 0)

1362 
Ën
 = 
	`blk_to_logiÿl
(
šode
, 1);

1364 
¡¬t_blk
 = 
	`logiÿl_to_blk
(
šode
, 
¡¬t
);

1365 
Ï¡_blk
 = 
	`logiÿl_to_blk
(
šode
, 
¡¬t
 + 
Ën
 - 1);

1367 
Ãxt
:

1368 
	`mem£t
(&
m­_bh
, 0, (
bufãr_h—d
));

1369 
m­_bh
.
b_size
 = 
Ën
;

1371 
»t
 = 
	`g‘_d©a_block
(
šode
, 
¡¬t_blk
, &
m­_bh
, 0,

1372 
F2FS_GET_BLOCK_FIEMAP
, &
Ãxt_pgofs
);

1373 ià(
»t
)

1374 
out
;

1377 ià(!
	`bufãr_m­³d
(&
m­_bh
)) {

1378 
¡¬t_blk
 = 
Ãxt_pgofs
;

1380 ià(
	`blk_to_logiÿl
(
šode
, 
¡¬t_blk
) < blk_to_logical(inode,

1381 
	`F2FS_I_SB
(
šode
)->
max_fe_blocks
))

1382 
´•_Ãxt
;

1384 
æags
 |ğ
FIEMAP_EXTENT_LAST
;

1387 ià(
size
) {

1388 ià(
	`f2fs_’üy±ed_šode
(
šode
))

1389 
æags
 |ğ
FIEMAP_EXTENT_DATA_ENCRYPTED
;

1391 
»t
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 
logiÿl
,

1392 
phys
, 
size
, 
æags
);

1395 ià(
¡¬t_blk
 > 
Ï¡_blk
 || 
»t
)

1396 
out
;

1398 
logiÿl
 = 
	`blk_to_logiÿl
(
šode
, 
¡¬t_blk
);

1399 
phys
 = 
	`blk_to_logiÿl
(
šode
, 
m­_bh
.
b_blockÄ
);

1400 
size
 = 
m­_bh
.
b_size
;

1401 
æags
 = 0;

1402 ià(
	`bufãr_unwr™‹n
(&
m­_bh
))

1403 
æags
 = 
FIEMAP_EXTENT_UNWRITTEN
;

1405 
¡¬t_blk
 +ğ
	`logiÿl_to_blk
(
šode
, 
size
);

1407 
´•_Ãxt
:

1408 
	`cÚd_»sched
();

1409 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

1410 
»t
 = -
EINTR
;

1412 
Ãxt
;

1413 
out
:

1414 ià(
»t
 == 1)

1415 
»t
 = 0;

1417 
	`šode_uÆock
(
šode
);

1418  
»t
;

1419 
	}
}

1425 
	$f2fs_m·ge_»ad·ges
(
add»ss_¥aû
 *
m­pšg
,

1426 
li¡_h—d
 *
·ges
, 
·ge
 *page,

1427 
Ä_·ges
)

1429 
bio
 *biØğ
NULL
;

1430 
£ùÜ_t
 
Ï¡_block_š_bio
 = 0;

1431 
šode
 *šodğ
m­pšg
->
ho¡
;

1432 cÚ¡ 
blkb™s
 = 
šode
->
i_blkb™s
;

1433 cÚ¡ 
blocksize
 = 1 << 
blkb™s
;

1434 
£ùÜ_t
 
block_š_fe
;

1435 
£ùÜ_t
 
Ï¡_block
;

1436 
£ùÜ_t
 
Ï¡_block_š_fe
;

1437 
£ùÜ_t
 
block_Ä
;

1438 
f2fs_m­_blocks
 
m­
;

1440 
m­
.
m_pblk
 = 0;

1441 
m­
.
m_lblk
 = 0;

1442 
m­
.
m_Ën
 = 0;

1443 
m­
.
m_æags
 = 0;

1444 
m­
.
m_Ãxt_pgofs
 = 
NULL
;

1445 
m­
.
m_Ãxt_ex‹Á
 = 
NULL
;

1446 
m­
.
m_£g_ty³
 = 
NO_CHECK_TYPE
;

1448 ; 
Ä_·ges
;‚r_pages--) {

1449 ià(
·ges
) {

1450 
·ge
 = 
	`li¡_Ï¡_’Œy
(
·ges
, ·ge, 
Ìu
);

1452 
	`´eãtchw
(&
·ge
->
æags
);

1453 
	`li¡_d–
(&
·ge
->
Ìu
);

1454 ià(
	`add_to_·ge_ÿche_Ìu
(
·ge
, 
m­pšg
,

1455 
·ge
->
šdex
,

1456 
	`»adah—d_gå_mask
(
m­pšg
)))

1457 
Ãxt_·ge
;

1460 
block_š_fe
 = (
£ùÜ_t
)
·ge
->
šdex
;

1461 
Ï¡_block
 = 
block_š_fe
 + 
Ä_·ges
;

1462 
Ï¡_block_š_fe
 = (
	`i_size_»ad
(
šode
è+ 
blocksize
 - 1) >>

1463 
blkb™s
;

1464 ià(
Ï¡_block
 > 
Ï¡_block_š_fe
)

1465 
Ï¡_block
 = 
Ï¡_block_š_fe
;

1470 ià((
m­
.
m_æags
 & 
F2FS_MAP_MAPPED
) &&

1471 
block_š_fe
 > 
m­
.
m_lblk
 &&

1472 
block_š_fe
 < (
m­
.
m_lblk
 + m­.
m_Ën
))

1473 
gÙ_™
;

1479 
m­
.
m_æags
 = 0;

1481 ià(
block_š_fe
 < 
Ï¡_block
) {

1482 
m­
.
m_lblk
 = 
block_š_fe
;

1483 
m­
.
m_Ën
 = 
Ï¡_block
 - 
block_š_fe
;

1485 ià(
	`f2fs_m­_blocks
(
šode
, &
m­
, 0,

1486 
F2FS_GET_BLOCK_DEFAULT
))

1487 
£t_”rÜ_·ge
;

1489 
gÙ_™
:

1490 ià((
m­
.
m_æags
 & 
F2FS_MAP_MAPPED
)) {

1491 
block_Ä
 = 
m­
.
m_pblk
 + 
block_š_fe
 - m­.
m_lblk
;

1492 
	`S‘PageM­³dToDisk
(
·ge
);

1494 ià(!
	`PageU±od©e
(
·ge
è&& !
	`ş—nÿche_g‘_·ge
(page)) {

1495 
	`S‘PageU±od©e
(
·ge
);

1496 
cÚfu£d
;

1499 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

1500 ià(!
	`PageU±od©e
(
·ge
))

1501 
	`S‘PageU±od©e
(
·ge
);

1502 
	`uÆock_·ge
(
·ge
);

1503 
Ãxt_·ge
;

1510 ià(
bio
 && (
Ï¡_block_š_bio
 !ğ
block_Ä
 - 1 ||

1511 !
	`__§me_bdev
(
	`F2FS_I_SB
(
šode
), 
block_Ä
, 
bio
))) {

1512 
subm™_ªd_»®loc
:

1513 
	`__subm™_bio
(
	`F2FS_I_SB
(
šode
), 
bio
, 
DATA
);

1514 
bio
 = 
NULL
;

1516 ià(
bio
 =ğ
NULL
) {

1517 
bio
 = 
	`f2fs_g¿b_»ad_bio
(
šode
, 
block_Ä
, 
Ä_·ges
);

1518 ià(
	`IS_ERR
(
bio
)) {

1519 
bio
 = 
NULL
;

1520 
£t_”rÜ_·ge
;

1524 ià(
	`bio_add_·ge
(
bio
, 
·ge
, 
blocksize
, 0) < blocksize)

1525 
subm™_ªd_»®loc
;

1527 
Ï¡_block_š_bio
 = 
block_Ä
;

1528 
Ãxt_·ge
;

1529 
£t_”rÜ_·ge
:

1530 
	`S‘PageE¼Ü
(
·ge
);

1531 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

1532 
	`uÆock_·ge
(
·ge
);

1533 
Ãxt_·ge
;

1534 
cÚfu£d
:

1535 ià(
bio
) {

1536 
	`__subm™_bio
(
	`F2FS_I_SB
(
šode
), 
bio
, 
DATA
);

1537 
bio
 = 
NULL
;

1539 
	`uÆock_·ge
(
·ge
);

1540 
Ãxt_·ge
:

1541 ià(
·ges
)

1542 
	`put_·ge
(
·ge
);

1544 
	`BUG_ON
(
·ges
 && !
	`li¡_em±y
(pages));

1545 ià(
bio
)

1546 
	`__subm™_bio
(
	`F2FS_I_SB
(
šode
), 
bio
, 
DATA
);

1548 
	}
}

1550 
	$f2fs_»ad_d©a_·ge
(
fe
 *fe, 
·ge
 *page)

1552 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1553 
»t
 = -
EAGAIN
;

1555 
	`Œaû_f2fs_»ad·ge
(
·ge
, 
DATA
);

1558 ià(
	`f2fs_has_šlše_d©a
(
šode
))

1559 
»t
 = 
	`f2fs_»ad_šlše_d©a
(
šode
, 
·ge
);

1560 ià(
»t
 =ğ-
EAGAIN
)

1561 
»t
 = 
	`f2fs_m·ge_»ad·ges
(
·ge
->
m­pšg
, 
NULL
,…age, 1);

1562  
»t
;

1563 
	}
}

1565 
	$f2fs_»ad_d©a_·ges
(
fe
 *file,

1566 
add»ss_¥aû
 *
m­pšg
,

1567 
li¡_h—d
 *
·ges
, 
Ä_·ges
)

1569 
šode
 *šodğ
m­pšg
->
ho¡
;

1570 
·ge
 *·gğ
	`li¡_Ï¡_’Œy
(
·ges
, ·ge, 
Ìu
);

1572 
	`Œaû_f2fs_»ad·ges
(
šode
, 
·ge
, 
Ä_·ges
);

1575 ià(
	`f2fs_has_šlše_d©a
(
šode
))

1578  
	`f2fs_m·ge_»ad·ges
(
m­pšg
, 
·ges
, 
NULL
, 
Ä_·ges
);

1579 
	}
}

1581 
	$’üy±_Úe_·ge
(
f2fs_io_šfo
 *
fio
)

1583 
šode
 *šodğ
fio
->
·ge
->
m­pšg
->
ho¡
;

1584 
gå_t
 
gå_æags
 = 
GFP_NOFS
;

1586 ià(!
	`f2fs_’üy±ed_fe
(
šode
))

1590 
	`f2fs_wa™_Ú_block_wr™eback
(
fio
->
sbi
, fio->
Şd_blkaddr
);

1592 
»Œy_’üy±
:

1593 
fio
->
’üy±ed_·ge
 = 
	`fsüy±_’üy±_·ge
(
šode
, fio->
·ge
,

1594 
PAGE_SIZE
, 0, 
fio
->
·ge
->
šdex
, 
gå_æags
);

1595 ià(!
	`IS_ERR
(
fio
->
’üy±ed_·ge
))

1599 ià(
	`PTR_ERR
(
fio
->
’üy±ed_·ge
è=ğ-
ENOMEM
) {

1600 
	`f2fs_æush_m”ged_wr™es
(
fio
->
sbi
);

1601 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

1602 
gå_æags
 |ğ
__GFP_NOFAIL
;

1603 
»Œy_’üy±
;

1605  
	`PTR_ERR
(
fio
->
’üy±ed_·ge
);

1606 
	}
}

1608 
šlše
 
boŞ
 
	$check_š¶aû_upd©e_pŞicy
(
šode
 *inode,

1609 
f2fs_io_šfo
 *
fio
)

1611 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1612 
pŞicy
 = 
	`SM_I
(
sbi
)->
u_pŞicy
;

1614 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_FORCE
))

1615  
Œue
;

1616 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_SSR
è&& 
	`f2fs_Ãed_SSR
(
sbi
))

1617  
Œue
;

1618 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_UTIL
) &&

1619 
	`utiz©iÚ
(
sbi
è> 
	`SM_I
(sbi)->
mš_u_ut
)

1620  
Œue
;

1621 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_SSR_UTIL
è&& 
	`f2fs_Ãed_SSR
(
sbi
) &&

1622 
	`utiz©iÚ
(
sbi
è> 
	`SM_I
(sbi)->
mš_u_ut
)

1623  
Œue
;

1628 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_ASYNC
) &&

1629 
fio
 && fio->
İ
 =ğ
REQ_OP_WRITE
 &&

1630 !(
fio
->
İ_æags
 & 
REQ_SYNC
) &&

1631 !
	`f2fs_’üy±ed_šode
(
šode
))

1632  
Œue
;

1635 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_FSYNC
) &&

1636 
	`is_šode_æag_£t
(
šode
, 
FI_NEED_IPU
))

1637  
Œue
;

1639  
çl£
;

1640 
	}
}

1642 
boŞ
 
	$f2fs_should_upd©e_š¶aû
(
šode
 *šode, 
f2fs_io_šfo
 *
fio
)

1644 ià(
	`f2fs_is_pšÃd_fe
(
šode
))

1645  
Œue
;

1648 ià(
	`fe_is_cŞd
(
šode
))

1649  
Œue
;

1651  
	`check_š¶aû_upd©e_pŞicy
(
šode
, 
fio
);

1652 
	}
}

1654 
boŞ
 
	$f2fs_should_upd©e_ouÏû
(
šode
 *šode, 
f2fs_io_šfo
 *
fio
)

1656 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1658 ià(
	`‹¡_İt
(
sbi
, 
LFS
))

1659  
Œue
;

1660 ià(
	`S_ISDIR
(
šode
->
i_mode
))

1661  
Œue
;

1662 ià(
	`f2fs_is_©omic_fe
(
šode
))

1663  
Œue
;

1664 ià(
fio
) {

1665 ià(
	`is_cŞd_d©a
(
fio
->
·ge
))

1666  
Œue
;

1667 ià(
	`IS_ATOMIC_WRITTEN_PAGE
(
fio
->
·ge
))

1668  
Œue
;

1670  
çl£
;

1671 
	}
}

1673 
šlše
 
boŞ
 
	$Ãed_š¶aû_upd©e
(
f2fs_io_šfo
 *
fio
)

1675 
šode
 *šodğ
fio
->
·ge
->
m­pšg
->
ho¡
;

1677 ià(
	`f2fs_should_upd©e_ouÏû
(
šode
, 
fio
))

1678  
çl£
;

1680  
	`f2fs_should_upd©e_š¶aû
(
šode
, 
fio
);

1681 
	}
}

1683 
	$f2fs_do_wr™e_d©a_·ge
(
f2fs_io_šfo
 *
fio
)

1685 
·ge
 *·gğ
fio
->page;

1686 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1687 
dnode_of_d©a
 
dn
;

1688 
ex‹Á_šfo
 
ei
 = {0,0,0};

1689 
boŞ
 
u_fÜû
 = 
çl£
;

1690 
”r
 = 0;

1692 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

1693 ià(
	`Ãed_š¶aû_upd©e
(
fio
) &&

1694 
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
·ge
->
šdex
, &
ei
)) {

1695 
fio
->
Şd_blkaddr
 = 
ei
.
blk
 + 
·ge
->
šdex
 -ƒi.
fofs
;

1697 ià(
	`is_v®id_blkaddr
(
fio
->
Şd_blkaddr
)) {

1698 
u_fÜû
 = 
Œue
;

1699 
fio
->
Ãed_lock
 = 
LOCK_DONE
;

1700 
gÙ_™
;

1705 ià(
fio
->
Ãed_lock
 =ğ
LOCK_REQ
 && !
	`f2fs_Œylock_İ
(fio->
sbi
))

1706  -
EAGAIN
;

1708 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
·ge
->
šdex
, 
LOOKUP_NODE
);

1709 ià(
”r
)

1710 
out
;

1712 
fio
->
Şd_blkaddr
 = 
dn
.
d©a_blkaddr
;

1715 ià(
fio
->
Şd_blkaddr
 =ğ
NULL_ADDR
) {

1716 
	`CË¬PageU±od©e
(
·ge
);

1717 
out_wr™•age
;

1719 
gÙ_™
:

1724 ià(
u_fÜû
 || (
	`is_v®id_blkaddr
(
fio
->
Şd_blkaddr
) &&

1725 
	`Ãed_š¶aû_upd©e
(
fio
))) {

1726 
”r
 = 
	`’üy±_Úe_·ge
(
fio
);

1727 ià(
”r
)

1728 
out_wr™•age
;

1730 
	`£t_·ge_wr™eback
(
·ge
);

1731 
	`CË¬PageE¼Ü
(
·ge
);

1732 
	`f2fs_put_dnode
(&
dn
);

1733 ià(
fio
->
Ãed_lock
 =ğ
LOCK_REQ
)

1734 
	`f2fs_uÆock_İ
(
fio
->
sbi
);

1735 
”r
 = 
	`f2fs_š¶aû_wr™e_d©a
(
fio
);

1736 
	`Œaû_f2fs_do_wr™e_d©a_·ge
(
fio
->
·ge
, 
IPU
);

1737 
	`£t_šode_æag
(
šode
, 
FI_UPDATE_WRITE
);

1738  
”r
;

1741 ià(
fio
->
Ãed_lock
 =ğ
LOCK_RETRY
) {

1742 ià(!
	`f2fs_Œylock_İ
(
fio
->
sbi
)) {

1743 
”r
 = -
EAGAIN
;

1744 
out_wr™•age
;

1746 
fio
->
Ãed_lock
 = 
LOCK_REQ
;

1749 
”r
 = 
	`’üy±_Úe_·ge
(
fio
);

1750 ià(
”r
)

1751 
out_wr™•age
;

1753 
	`£t_·ge_wr™eback
(
·ge
);

1754 
	`CË¬PageE¼Ü
(
·ge
);

1757 
	`f2fs_ouÏû_wr™e_d©a
(&
dn
, 
fio
);

1758 
	`Œaû_f2fs_do_wr™e_d©a_·ge
(
·ge
, 
OPU
);

1759 
	`£t_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

1760 ià(
·ge
->
šdex
 == 0)

1761 
	`£t_šode_æag
(
šode
, 
FI_FIRST_BLOCK_WRITTEN
);

1762 
out_wr™•age
:

1763 
	`f2fs_put_dnode
(&
dn
);

1764 
out
:

1765 ià(
fio
->
Ãed_lock
 =ğ
LOCK_REQ
)

1766 
	`f2fs_uÆock_İ
(
fio
->
sbi
);

1767  
”r
;

1768 
	}
}

1770 
	$__wr™e_d©a_·ge
(
·ge
 *·ge, 
boŞ
 *
subm™‹d
,

1771 
wr™eback_cÚŒŞ
 *
wbc
,

1772 
io¡©_ty³
 
io_ty³
)

1774 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1775 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1776 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

1777 cÚ¡ 
pgoff_t
 
’d_šdex
 = ((è
i_size
)

1778 >> 
PAGE_SHIFT
;

1779 
loff_t
 
psize
 = (
·ge
->
šdex
 + 1è<< 
PAGE_SHIFT
;

1780 
off£t
 = 0;

1781 
boŞ
 
Ãed_b®ªû_fs
 = 
çl£
;

1782 
”r
 = 0;

1783 
f2fs_io_šfo
 
fio
 = {

1784 .
sbi
 = sbi,

1785 .
šo
 = 
šode
->
i_šo
,

1786 .
ty³
 = 
DATA
,

1787 .
İ
 = 
REQ_OP_WRITE
,

1788 .
İ_æags
 = 
	`wbc_to_wr™e_æags
(
wbc
),

1789 .
Şd_blkaddr
 = 
NULL_ADDR
,

1790 .
·ge
 =…age,

1791 .
’üy±ed_·ge
 = 
NULL
,

1792 .
subm™‹d
 = 
çl£
,

1793 .
Ãed_lock
 = 
LOCK_RETRY
,

1794 .
io_ty³
 = io_type,

1795 .
io_wbc
 = 
wbc
,

1798 
	`Œaû_f2fs_wr™•age
(
·ge
, 
DATA
);

1801 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1802 
	`m­pšg_£t_”rÜ
(
·ge
->
m­pšg
, -
EIO
);

1807 ià(
	`S_ISDIR
(
šode
->
i_mode
))

1808 
»dœty_out
;

1809 
out
;

1812 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

1813 
»dœty_out
;

1815 ià(
·ge
->
šdex
 < 
’d_šdex
)

1816 
wr™e
;

1822 
off£t
 = 
i_size
 & (
PAGE_SIZE
 - 1);

1823 ià((
·ge
->
šdex
 >ğ
’d_šdex
 + 1è|| !
off£t
)

1824 
out
;

1826 
	`z”o_u£r_£gm’t
(
·ge
, 
off£t
, 
PAGE_SIZE
);

1827 
wr™e
:

1828 ià(
	`f2fs_is_drİ_ÿche
(
šode
))

1829 
out
;

1831 ià(
	`f2fs_is_vŞ©e_fe
(
šode
è&& (!
·ge
->
šdex
 ||

1832 (!
wbc
->
fÜ_»şaim
 &&

1833 
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
BASE_CHECK
))))

1834 
»dœty_out
;

1837 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

1838 
fio
.
Ãed_lock
 = 
LOCK_DONE
;

1839 
”r
 = 
	`f2fs_do_wr™e_d©a_·ge
(&
fio
);

1840 
dÚe
;

1843 ià(!
wbc
->
fÜ_»şaim
)

1844 
Ãed_b®ªû_fs
 = 
Œue
;

1845 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0))

1846 
»dœty_out
;

1848 
	`£t_šode_æag
(
šode
, 
FI_HOT_DATA
);

1850 
”r
 = -
EAGAIN
;

1851 ià(
	`f2fs_has_šlše_d©a
(
šode
)) {

1852 
”r
 = 
	`f2fs_wr™e_šlše_d©a
(
šode
, 
·ge
);

1853 ià(!
”r
)

1854 
out
;

1857 ià(
”r
 =ğ-
EAGAIN
) {

1858 
”r
 = 
	`f2fs_do_wr™e_d©a_·ge
(&
fio
);

1859 ià(
”r
 =ğ-
EAGAIN
) {

1860 
fio
.
Ãed_lock
 = 
LOCK_REQ
;

1861 
”r
 = 
	`f2fs_do_wr™e_d©a_·ge
(&
fio
);

1865 ià(
”r
) {

1866 
	`fe_£t_k“p_isize
(
šode
);

1868 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

1869 ià(
	`F2FS_I
(
šode
)->
Ï¡_disk_size
 < 
psize
)

1870 
	`F2FS_I
(
šode
)->
Ï¡_disk_size
 = 
psize
;

1871 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

1874 
dÚe
:

1875 ià(
”r
 &&ƒ¼ !ğ-
ENOENT
)

1876 
»dœty_out
;

1878 
out
:

1879 
	`šode_dec_dœty_·ges
(
šode
);

1880 ià(
”r
)

1881 
	`CË¬PageU±od©e
(
·ge
);

1883 ià(
wbc
->
fÜ_»şaim
) {

1884 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
sbi
, 
šode
, 0, 
·ge
->
šdex
, 
DATA
);

1885 
	`ş—r_šode_æag
(
šode
, 
FI_HOT_DATA
);

1886 
	`f2fs_»move_dœty_šode
(
šode
);

1887 
subm™‹d
 = 
NULL
;

1890 
	`uÆock_·ge
(
·ge
);

1891 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

1892 
	`f2fs_b®ªû_fs
(
sbi
, 
Ãed_b®ªû_fs
);

1894 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1895 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
DATA
);

1896 
subm™‹d
 = 
NULL
;

1899 ià(
subm™‹d
)

1900 *
subm™‹d
 = 
fio
.submitted;

1904 
»dœty_out
:

1905 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

1912 ià(!
”r
 || 
wbc
->
fÜ_»şaim
)

1913  
AOP_WRITEPAGE_ACTIVATE
;

1914 
	`uÆock_·ge
(
·ge
);

1915  
”r
;

1916 
	}
}

1918 
	$f2fs_wr™e_d©a_·ge
(
·ge
 *page,

1919 
wr™eback_cÚŒŞ
 *
wbc
)

1921  
	`__wr™e_d©a_·ge
(
·ge
, 
NULL
, 
wbc
, 
FS_DATA_IO
);

1922 
	}
}

1929 
	$f2fs_wr™e_ÿche_·ges
(
add»ss_¥aû
 *
m­pšg
,

1930 
wr™eback_cÚŒŞ
 *
wbc
,

1931 
io¡©_ty³
 
io_ty³
)

1933 
»t
 = 0;

1934 
dÚe
 = 0;

1935 
·gevec
 
pvec
;

1936 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_M_SB
(
m­pšg
);

1937 
Ä_·ges
;

1938 
pgoff_t
 
	`unš™Ÿlized_v¬
(
wr™eback_šdex
);

1939 
pgoff_t
 
šdex
;

1940 
pgoff_t
 
’d
;

1941 
pgoff_t
 
dÚe_šdex
;

1942 
pgoff_t
 
Ï¡_idx
 = 
ULONG_MAX
;

1943 
cyşed
;

1944 
¿nge_whŞe
 = 0;

1945 
g
;

1947 
	`·gevec_š™
(&
pvec
);

1949 ià(
	`g‘_dœty_·ges
(
m­pšg
->
ho¡
) <=

1950 
	`SM_I
(
	`F2FS_M_SB
(
m­pšg
))->
mš_hÙ_blocks
)

1951 
	`£t_šode_æag
(
m­pšg
->
ho¡
, 
FI_HOT_DATA
);

1953 
	`ş—r_šode_æag
(
m­pšg
->
ho¡
, 
FI_HOT_DATA
);

1955 ià(
wbc
->
¿nge_cyşic
) {

1956 
wr™eback_šdex
 = 
m­pšg
->writeback_index;

1957 
šdex
 = 
wr™eback_šdex
;

1958 ià(
šdex
 == 0)

1959 
cyşed
 = 1;

1961 
cyşed
 = 0;

1962 
’d
 = -1;

1964 
šdex
 = 
wbc
->
¿nge_¡¬t
 >> 
PAGE_SHIFT
;

1965 
’d
 = 
wbc
->
¿nge_’d
 >> 
PAGE_SHIFT
;

1966 ià(
wbc
->
¿nge_¡¬t
 =ğ0 && wbc->
¿nge_’d
 =ğ
LLONG_MAX
)

1967 
¿nge_whŞe
 = 1;

1968 
cyşed
 = 1;

1970 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 || wbc->
gged_wr™•ages
)

1971 
g
 = 
PAGECACHE_TAG_TOWRITE
;

1973 
g
 = 
PAGECACHE_TAG_DIRTY
;

1974 
»Œy
:

1975 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 || wbc->
gged_wr™•ages
)

1976 
	`g_·ges_fÜ_wr™eback
(
m­pšg
, 
šdex
, 
’d
);

1977 
dÚe_šdex
 = 
šdex
;

1978 !
dÚe
 && (
šdex
 <ğ
’d
)) {

1979 
i
;

1981 
Ä_·ges
 = 
	`·gevec_lookup_¿nge_g
(&
pvec
, 
m­pšg
, &
šdex
, 
’d
,

1982 
g
);

1983 ià(
Ä_·ges
 == 0)

1986 
i
 = 0; i < 
Ä_·ges
; i++) {

1987 
·ge
 *·gğ
pvec
.
·ges
[
i
];

1988 
boŞ
 
subm™‹d
 = 
çl£
;

1991 ià(
	`©omic_»ad
(&
sbi
->
wb_sync_»q
[
DATA
]) &&

1992 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
) {

1993 
dÚe
 = 1;

1997 
dÚe_šdex
 = 
·ge
->
šdex
;

1998 
»Œy_wr™e
:

1999 
	`lock_·ge
(
·ge
);

2001 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

2002 
cÚtšue_uÆock
:

2003 
	`uÆock_·ge
(
·ge
);

2007 ià(!
	`PageDœty
(
·ge
)) {

2009 
cÚtšue_uÆock
;

2012 ià(
	`PageWr™eback
(
·ge
)) {

2013 ià(
wbc
->
sync_mode
 !ğ
WB_SYNC_NONE
)

2014 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
,

2015 
DATA
, 
Œue
);

2017 
cÚtšue_uÆock
;

2020 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

2021 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

2022 
cÚtšue_uÆock
;

2024 
»t
 = 
	`__wr™e_d©a_·ge
(
·ge
, &
subm™‹d
, 
wbc
, 
io_ty³
);

2025 ià(
	`uÆik–y
(
»t
)) {

2030 ià(
»t
 =ğ
AOP_WRITEPAGE_ACTIVATE
) {

2031 
	`uÆock_·ge
(
·ge
);

2032 
»t
 = 0;

2034 } ià(
»t
 =ğ-
EAGAIN
) {

2035 
»t
 = 0;

2036 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
) {

2037 
	`cÚd_»sched
();

2038 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
,

2039 
HZ
/50);

2040 
»Œy_wr™e
;

2044 
dÚe_šdex
 = 
·ge
->
šdex
 + 1;

2045 
dÚe
 = 1;

2047 } ià(
subm™‹d
) {

2048 
Ï¡_idx
 = 
·ge
->
šdex
;

2051 ià(--
wbc
->
Ä_to_wr™e
 <= 0 &&

2052 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
) {

2053 
dÚe
 = 1;

2057 
	`·gevec_»Ëa£
(&
pvec
);

2058 
	`cÚd_»sched
();

2061 ià(!
cyşed
 && !
dÚe
) {

2062 
cyşed
 = 1;

2063 
šdex
 = 0;

2064 
’d
 = 
wr™eback_šdex
 - 1;

2065 
»Œy
;

2067 ià(
wbc
->
¿nge_cyşic
 || (
¿nge_whŞe
 && wbc->
Ä_to_wr™e
 > 0))

2068 
m­pšg
->
wr™eback_šdex
 = 
dÚe_šdex
;

2070 ià(
Ï¡_idx
 !ğ
ULONG_MAX
)

2071 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
	`F2FS_M_SB
(
m­pšg
), m­pšg->
ho¡
,

2072 0, 
Ï¡_idx
, 
DATA
);

2074  
»t
;

2075 
	}
}

2077 
	$__f2fs_wr™e_d©a_·ges
(
add»ss_¥aû
 *
m­pšg
,

2078 
wr™eback_cÚŒŞ
 *
wbc
,

2079 
io¡©_ty³
 
io_ty³
)

2081 
šode
 *šodğ
m­pšg
->
ho¡
;

2082 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2083 
blk_¶ug
 
¶ug
;

2084 
»t
;

2087 ià(!
m­pšg
->
a_İs
->
wr™•age
)

2091 ià(!
	`g‘_dœty_·ges
(
šode
è&& 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
)

2095 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

2096 
sk_wr™e
;

2098 ià(
	`S_ISDIR
(
šode
->
i_mode
è&& 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
 &&

2099 
	`g‘_dœty_·ges
(
šode
è< 
	`Ä_·ges_to_sk
(
sbi
, 
DATA
) &&

2100 
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
DIRTY_DENTS
))

2101 
sk_wr™e
;

2104 ià(
	`is_šode_æag_£t
(
šode
, 
FI_DO_DEFRAG
))

2105 
sk_wr™e
;

2107 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
DATA
);

2110 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
)

2111 
	`©omic_šc
(&
sbi
->
wb_sync_»q
[
DATA
]);

2112 ià(
	`©omic_»ad
(&
sbi
->
wb_sync_»q
[
DATA
]))

2113 
sk_wr™e
;

2115 
	`blk_¡¬t_¶ug
(&
¶ug
);

2116 
»t
 = 
	`f2fs_wr™e_ÿche_·ges
(
m­pšg
, 
wbc
, 
io_ty³
);

2117 
	`blk_fšish_¶ug
(&
¶ug
);

2119 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
)

2120 
	`©omic_dec
(&
sbi
->
wb_sync_»q
[
DATA
]);

2126 
	`f2fs_»move_dœty_šode
(
šode
);

2127  
»t
;

2129 
sk_wr™e
:

2130 
wbc
->
·ges_sk³d
 +ğ
	`g‘_dœty_·ges
(
šode
);

2131 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
DATA
);

2133 
	}
}

2135 
	$f2fs_wr™e_d©a_·ges
(
add»ss_¥aû
 *
m­pšg
,

2136 
wr™eback_cÚŒŞ
 *
wbc
)

2138 
šode
 *šodğ
m­pšg
->
ho¡
;

2140  
	`__f2fs_wr™e_d©a_·ges
(
m­pšg
, 
wbc
,

2141 
	`F2FS_I
(
šode
)->
ı_sk
 =ğ
cu¼’t
 ?

2142 
FS_CP_DATA_IO
 : 
FS_DATA_IO
);

2143 
	}
}

2145 
	$f2fs_wr™e_çed
(
add»ss_¥aû
 *
m­pšg
, 
loff_t
 
to
)

2147 
šode
 *šodğ
m­pšg
->
ho¡
;

2148 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

2150 ià(
to
 > 
i_size
) {

2151 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

2152 
	`Œunÿ‹_·geÿche
(
šode
, 
i_size
);

2153 
	`f2fs_Œunÿ‹_blocks
(
šode
, 
i_size
, 
Œue
);

2154 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

2156 
	}
}

2158 
	$´•¬e_wr™e_begš
(
f2fs_sb_šfo
 *
sbi
,

2159 
·ge
 *·ge, 
loff_t
 
pos
, 
Ën
,

2160 
block_t
 *
blk_addr
, 
boŞ
 *
node_chªged
)

2162 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

2163 
pgoff_t
 
šdex
 = 
·ge
->index;

2164 
dnode_of_d©a
 
dn
;

2165 
·ge
 *
age
;

2166 
boŞ
 
locked
 = 
çl£
;

2167 
ex‹Á_šfo
 
ei
 = {0,0,0};

2168 
”r
 = 0;

2174 ià(!
	`f2fs_has_šlše_d©a
(
šode
è&& 
Ën
 =ğ
PAGE_SIZE
 &&

2175 !
	`is_šode_æag_£t
(
šode
, 
FI_NO_PREALLOC
))

2178 ià(
	`f2fs_has_šlše_d©a
(
šode
) ||

2179 (
pos
 & 
PAGE_MASK
è>ğ
	`i_size_»ad
(
šode
)) {

2180 
	`__do_m­_lock
(
sbi
, 
F2FS_GET_BLOCK_PRE_AIO
, 
Œue
);

2181 
locked
 = 
Œue
;

2183 
»¡¬t
:

2185 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

2186 ià(
	`IS_ERR
(
age
)) {

2187 
”r
 = 
	`PTR_ERR
(
age
);

2188 
uÆock_out
;

2191 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
age
, ipage, 0);

2193 ià(
	`f2fs_has_šlše_d©a
(
šode
)) {

2194 ià(
pos
 + 
Ën
 <ğ
	`MAX_INLINE_DATA
(
šode
)) {

2195 
	`f2fs_do_»ad_šlše_d©a
(
·ge
, 
age
);

2196 
	`£t_šode_æag
(
šode
, 
FI_DATA_EXIST
);

2197 ià(
šode
->
i_Æšk
)

2198 
	`£t_šlše_node
(
age
);

2200 
”r
 = 
	`f2fs_cÚv”t_šlše_·ge
(&
dn
, 
·ge
);

2201 ià(
”r
)

2202 
out
;

2203 ià(
dn
.
d©a_blkaddr
 =ğ
NULL_ADDR
)

2204 
”r
 = 
	`f2fs_g‘_block
(&
dn
, 
šdex
);

2206 } ià(
locked
) {

2207 
”r
 = 
	`f2fs_g‘_block
(&
dn
, 
šdex
);

2209 ià(
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
šdex
, &
ei
)) {

2210 
dn
.
d©a_blkaddr
 = 
ei
.
blk
 + 
šdex
 -ƒi.
fofs
;

2213 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
šdex
, 
LOOKUP_NODE
);

2214 ià(
”r
 || 
dn
.
d©a_blkaddr
 =ğ
NULL_ADDR
) {

2215 
	`f2fs_put_dnode
(&
dn
);

2216 
	`__do_m­_lock
(
sbi
, 
F2FS_GET_BLOCK_PRE_AIO
,

2217 
Œue
);

2218 
locked
 = 
Œue
;

2219 
»¡¬t
;

2225 *
blk_addr
 = 
dn
.
d©a_blkaddr
;

2226 *
node_chªged
 = 
dn
.node_changed;

2227 
out
:

2228 
	`f2fs_put_dnode
(&
dn
);

2229 
uÆock_out
:

2230 ià(
locked
)

2231 
	`__do_m­_lock
(
sbi
, 
F2FS_GET_BLOCK_PRE_AIO
, 
çl£
);

2232  
”r
;

2233 
	}
}

2235 
	$f2fs_wr™e_begš
(
fe
 *fe, 
add»ss_¥aû
 *
m­pšg
,

2236 
loff_t
 
pos
, 
Ën
, 
æags
,

2237 
·ge
 **
·g•
, **
fsd©a
)

2239 
šode
 *šodğ
m­pšg
->
ho¡
;

2240 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2241 
·ge
 *·gğ
NULL
;

2242 
pgoff_t
 
šdex
 = ((è
pos
è>> 
PAGE_SHIFT
;

2243 
boŞ
 
Ãed_b®ªû
 = 
çl£
, 
drİ_©omic
 = false;

2244 
block_t
 
blkaddr
 = 
NULL_ADDR
;

2245 
”r
 = 0;

2247 
	`Œaû_f2fs_wr™e_begš
(
šode
, 
pos
, 
Ën
, 
æags
);

2249 ià(
	`f2fs_is_©omic_fe
(
šode
) &&

2250 !
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
INMEM_PAGES
)) {

2251 
”r
 = -
ENOMEM
;

2252 
drİ_©omic
 = 
Œue
;

2253 
ç
;

2261 ià(
šdex
 != 0) {

2262 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

2263 ià(
”r
)

2264 
ç
;

2266 
»³©
:

2271 
·ge
 = 
	`f2fs_·geÿche_g‘_·ge
(
m­pšg
, 
šdex
,

2272 
FGP_LOCK
 | 
FGP_WRITE
 | 
FGP_CREAT
, 
GFP_NOFS
);

2273 ià(!
·ge
) {

2274 
”r
 = -
ENOMEM
;

2275 
ç
;

2278 *
·g•
 = 
·ge
;

2280 
”r
 = 
	`´•¬e_wr™e_begš
(
sbi
, 
·ge
, 
pos
, 
Ën
,

2281 &
blkaddr
, &
Ãed_b®ªû
);

2282 ià(
”r
)

2283 
ç
;

2285 ià(
Ãed_b®ªû
 && 
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0)) {

2286 
	`uÆock_·ge
(
·ge
);

2287 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

2288 
	`lock_·ge
(
·ge
);

2289 ià(
·ge
->
m­pšg
 != mapping) {

2291 
	`f2fs_put_·ge
(
·ge
, 1);

2292 
»³©
;

2296 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
çl£
);

2299 ià(
	`f2fs_po¡_»ad_»quœed
(
šode
))

2300 
	`f2fs_wa™_Ú_block_wr™eback
(
sbi
, 
blkaddr
);

2302 ià(
Ën
 =ğ
PAGE_SIZE
 || 
	`PageU±od©e
(
·ge
))

2305 ià(!(
pos
 & (
PAGE_SIZE
 - 1)è&& (po + 
Ën
è>ğ
	`i_size_»ad
(
šode
)) {

2306 
	`z”o_u£r_£gm’t
(
·ge
, 
Ën
, 
PAGE_SIZE
);

2310 ià(
blkaddr
 =ğ
NEW_ADDR
) {

2311 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

2312 
	`S‘PageU±od©e
(
·ge
);

2314 
”r
 = 
	`f2fs_subm™_·ge_»ad
(
šode
, 
·ge
, 
blkaddr
);

2315 ià(
”r
)

2316 
ç
;

2318 
	`lock_·ge
(
·ge
);

2319 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

2320 
	`f2fs_put_·ge
(
·ge
, 1);

2321 
»³©
;

2323 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

2324 
”r
 = -
EIO
;

2325 
ç
;

2330 
ç
:

2331 
	`f2fs_put_·ge
(
·ge
, 1);

2332 
	`f2fs_wr™e_çed
(
m­pšg
, 
pos
 + 
Ën
);

2333 ià(
drİ_©omic
)

2334 
	`f2fs_drİ_šmem_·ges_®l
(
sbi
, 
çl£
);

2335  
”r
;

2336 
	}
}

2338 
	$f2fs_wr™e_’d
(
fe
 *file,

2339 
add»ss_¥aû
 *
m­pšg
,

2340 
loff_t
 
pos
, 
Ën
, 
cİ›d
,

2341 
·ge
 *·ge, *
fsd©a
)

2343 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

2345 
	`Œaû_f2fs_wr™e_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
);

2352 ià(!
	`PageU±od©e
(
·ge
)) {

2353 ià(
	`uÆik–y
(
cİ›d
 !ğ
Ën
))

2354 
cİ›d
 = 0;

2356 
	`S‘PageU±od©e
(
·ge
);

2358 ià(!
cİ›d
)

2359 
uÆock_out
;

2361 
	`£t_·ge_dœty
(
·ge
);

2363 ià(
pos
 + 
cİ›d
 > 
	`i_size_»ad
(
šode
))

2364 
	`f2fs_i_size_wr™e
(
šode
, 
pos
 + 
cİ›d
);

2365 
uÆock_out
:

2366 
	`f2fs_put_·ge
(
·ge
, 1);

2367 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

2368  
cİ›d
;

2369 
	}
}

2371 
	$check_dœeù_IO
(
šode
 *šode, 
iov_™”
 *
™”
,

2372 
loff_t
 
off£t
)

2374 
blocksize_mask
 = 
šode
->
i_sb
->
s_blocksize
 - 1;

2376 ià(
off£t
 & 
blocksize_mask
)

2377  -
EINVAL
;

2379 ià(
	`iov_™”_®ignm’t
(
™”
è& 
blocksize_mask
)

2380  -
EINVAL
;

2383 
	}
}

2385 
ssize_t
 
	$f2fs_dœeù_IO
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
)

2387 
add»ss_¥aû
 *
m­pšg
 = 
iocb
->
ki_fp
->
f_m­pšg
;

2388 
šode
 *šodğ
m­pšg
->
ho¡
;

2389 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2390 
size_t
 
couÁ
 = 
	`iov_™”_couÁ
(
™”
);

2391 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

2392 
rw
 = 
	`iov_™”_rw
(
™”
);

2393 
”r
;

2394 
rw_hšt
 
hšt
 = 
iocb
->
ki_hšt
;

2395 
whšt_mode
 = 
	`F2FS_OPTION
(
sbi
).whint_mode;

2397 
”r
 = 
	`check_dœeù_IO
(
šode
, 
™”
, 
off£t
);

2398 ià(
”r
)

2399  
”r
;

2401 ià(
	`f2fs_fÜû_bufã»d_io
(
šode
, 
rw
))

2404 
	`Œaû_f2fs_dœeù_IO_’‹r
(
šode
, 
off£t
, 
couÁ
, 
rw
);

2406 ià(
rw
 =ğ
WRITE
 && 
whšt_mode
 =ğ
WHINT_MODE_OFF
)

2407 
iocb
->
ki_hšt
 = 
WRITE_LIFE_NOT_SET
;

2409 ià(!
	`down_»ad_Œylock
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
rw
])) {

2410 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
) {

2411 
iocb
->
ki_hšt
 = 
hšt
;

2412 
”r
 = -
EAGAIN
;

2413 
out
;

2415 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
rw
]);

2418 
”r
 = 
	`blockdev_dœeù_IO
(
iocb
, 
šode
, 
™”
, 
g‘_d©a_block_dio
);

2419 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
rw
]);

2421 ià(
rw
 =ğ
WRITE
) {

2422 ià(
whšt_mode
 =ğ
WHINT_MODE_OFF
)

2423 
iocb
->
ki_hšt
 = 
hšt
;

2424 ià(
”r
 > 0) {

2425 
	`f2fs_upd©e_io¡©
(
	`F2FS_I_SB
(
šode
), 
APP_DIRECT_IO
,

2426 
”r
);

2427 
	`£t_šode_æag
(
šode
, 
FI_UPDATE_WRITE
);

2428 } ià(
”r
 < 0) {

2429 
	`f2fs_wr™e_çed
(
m­pšg
, 
off£t
 + 
couÁ
);

2433 
out
:

2434 
	`Œaû_f2fs_dœeù_IO_ex™
(
šode
, 
off£t
, 
couÁ
, 
rw
, 
”r
);

2436  
”r
;

2437 
	}
}

2439 
	$f2fs_šv®id©e_·ge
(
·ge
 *·ge, 
off£t
,

2440 
Ëngth
)

2442 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

2443 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2445 ià(
šode
->
i_šo
 >ğ
	`F2FS_ROOT_INO
(
sbi
) &&

2446 (
off£t
 % 
PAGE_SIZE
 || 
Ëngth
 != PAGE_SIZE))

2449 ià(
	`PageDœty
(
·ge
)) {

2450 ià(
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
)) {

2451 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_META
);

2452 } ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
)) {

2453 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_NODES
);

2455 
	`šode_dec_dœty_·ges
(
šode
);

2456 
	`f2fs_»move_dœty_šode
(
šode
);

2461 ià(
	`IS_ATOMIC_WRITTEN_PAGE
(
·ge
))

2462  
	`f2fs_drİ_šmem_·ge
(
šode
, 
·ge
);

2464 
	`£t_·ge_´iv©e
(
·ge
, 0);

2465 
	`CË¬PagePriv©e
(
·ge
);

2466 
	}
}

2468 
	$f2fs_»Ëa£_·ge
(
·ge
 *·ge, 
gå_t
 
wa™
)

2471 ià(
	`PageDœty
(
·ge
))

2475 ià(
	`IS_ATOMIC_WRITTEN_PAGE
(
·ge
))

2478 
	`£t_·ge_´iv©e
(
·ge
, 0);

2479 
	`CË¬PagePriv©e
(
·ge
);

2481 
	}
}

2483 
	$f2fs_£t_d©a_·ge_dœty
(
·ge
 *page)

2485 
add»ss_¥aû
 *
m­pšg
 = 
·ge
->mapping;

2486 
šode
 *šodğ
m­pšg
->
ho¡
;

2488 
	`Œaû_f2fs_£t_·ge_dœty
(
·ge
, 
DATA
);

2490 ià(!
	`PageU±od©e
(
·ge
))

2491 
	`S‘PageU±od©e
(
·ge
);

2493 ià(
	`f2fs_is_©omic_fe
(
šode
è&& !
	`f2fs_is_comm™_©omic_wr™e
(inode)) {

2494 ià(!
	`IS_ATOMIC_WRITTEN_PAGE
(
·ge
)) {

2495 
	`f2fs_»gi¡”_šmem_·ge
(
šode
, 
·ge
);

2505 ià(!
	`PageDœty
(
·ge
)) {

2506 
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

2507 
	`f2fs_upd©e_dœty_·ge
(
šode
, 
·ge
);

2511 
	}
}

2513 
£ùÜ_t
 
	$f2fs_bm­
(
add»ss_¥aû
 *
m­pšg
, 
£ùÜ_t
 
block
)

2515 
šode
 *šodğ
m­pšg
->
ho¡
;

2517 ià(
	`f2fs_has_šlše_d©a
(
šode
))

2521 ià(
	`m­pšg_gged
(
m­pšg
, 
PAGECACHE_TAG_DIRTY
))

2522 
	`fem­_wr™e_ªd_wa™
(
m­pšg
);

2524  
	`g’”ic_block_bm­
(
m­pšg
, 
block
, 
g‘_d©a_block_bm­
);

2525 
	}
}

2527 #ifdeà
CONFIG_MIGRATION


2528 
	~<lšux/mig¿‹.h
>

2530 
	$f2fs_mig¿‹_·ge
(
add»ss_¥aû
 *
m­pšg
,

2531 
·ge
 *
Ãw·ge
, ·g*·ge, 
mig¿‹_mode
 
mode
)

2533 
rc
, 
exŒa_couÁ
;

2534 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
m­pšg
->
ho¡
);

2535 
boŞ
 
©omic_wr™‹n
 = 
	`IS_ATOMIC_WRITTEN_PAGE
(
·ge
);

2537 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

2540 ià(
©omic_wr™‹n
) {

2541 ià(
mode
 !ğ
MIGRATE_SYNC
)

2542  -
EBUSY
;

2543 ià(!
	`mu‹x_Œylock
(&
fi
->
šmem_lock
))

2544  -
EAGAIN
;

2552 
exŒa_couÁ
 = (
©omic_wr™‹n
 ? 1 : 0è- 
	`·ge_has_´iv©e
(
·ge
);

2553 
rc
 = 
	`mig¿‹_·ge_move_m­pšg
(
m­pšg
, 
Ãw·ge
,

2554 
·ge
, 
NULL
, 
mode
, 
exŒa_couÁ
);

2555 ià(
rc
 !ğ
MIGRATEPAGE_SUCCESS
) {

2556 ià(
©omic_wr™‹n
)

2557 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

2558  
rc
;

2561 ià(
©omic_wr™‹n
) {

2562 
šmem_·ges
 *
cur
;

2563 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
fi
->
šmem_·ges
, 
li¡
)

2564 ià(
cur
->
·ge
 ==…age) {

2565 
cur
->
·ge
 = 
Ãw·ge
;

2568 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

2569 
	`put_·ge
(
·ge
);

2570 
	`g‘_·ge
(
Ãw·ge
);

2573 ià(
	`PagePriv©e
(
·ge
))

2574 
	`S‘PagePriv©e
(
Ãw·ge
);

2575 
	`£t_·ge_´iv©e
(
Ãw·ge
, 
	`·ge_´iv©e
(
·ge
));

2577 ià(
mode
 !ğ
MIGRATE_SYNC_NO_COPY
)

2578 
	`mig¿‹_·ge_cİy
(
Ãw·ge
, 
·ge
);

2580 
	`mig¿‹_·ge_¡©es
(
Ãw·ge
, 
·ge
);

2582  
MIGRATEPAGE_SUCCESS
;

2583 
	}
}

2586 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gf2fs_dblock_aİs
 = {

2587 .
»ad·ge
 = 
f2fs_»ad_d©a_·ge
,

2588 .
	g»ad·ges
 = 
f2fs_»ad_d©a_·ges
,

2589 .
	gwr™•age
 = 
f2fs_wr™e_d©a_·ge
,

2590 .
	gwr™•ages
 = 
f2fs_wr™e_d©a_·ges
,

2591 .
	gwr™e_begš
 = 
f2fs_wr™e_begš
,

2592 .
	gwr™e_’d
 = 
f2fs_wr™e_’d
,

2593 .
	g£t_·ge_dœty
 = 
f2fs_£t_d©a_·ge_dœty
,

2594 .
	gšv®id©•age
 = 
f2fs_šv®id©e_·ge
,

2595 .
	g»Ëa£·ge
 = 
f2fs_»Ëa£_·ge
,

2596 .
	gdœeù_IO
 = 
f2fs_dœeù_IO
,

2597 .
	gbm­
 = 
f2fs_bm­
,

2598 #ifdeà
CONFIG_MIGRATION


2599 .
	gmig¿‹·ge
 = 
f2fs_mig¿‹_·ge
,

2603 
	$f2fs_ş—r_¿dix_Œ“_dœty_g
(
·ge
 *page)

2605 
add»ss_¥aû
 *
m­pšg
 = 
	`·ge_m­pšg
(
·ge
);

2606 
æags
;

2608 
	`xa_lock_œq§ve
(&
m­pšg
->
i_·ges
, 
æags
);

2609 
	`¿dix_Œ“_g_ş—r
(&
m­pšg
->
i_·ges
, 
	`·ge_šdex
(
·ge
),

2610 
PAGECACHE_TAG_DIRTY
);

2611 
	`xa_uÆock_œq»¡Üe
(&
m­pšg
->
i_·ges
, 
æags
);

2612 
	}
}

2614 
__š™
 
	$f2fs_š™_po¡_»ad_´oûssšg
()

2616 
bio_po¡_»ad_ùx_ÿche
 = 
	`KMEM_CACHE
(
bio_po¡_»ad_ùx
, 0);

2617 ià(!
bio_po¡_»ad_ùx_ÿche
)

2618 
ç
;

2619 
bio_po¡_»ad_ùx_poŞ
 =

2620 
	`mempoŞ_ü—‹_¦ab_poŞ
(
NUM_PREALLOC_POST_READ_CTXS
,

2621 
bio_po¡_»ad_ùx_ÿche
);

2622 ià(!
bio_po¡_»ad_ùx_poŞ
)

2623 
ç_ä“_ÿche
;

2626 
ç_ä“_ÿche
:

2627 
	`kmem_ÿche_de¡roy
(
bio_po¡_»ad_ùx_ÿche
);

2628 
ç
:

2629  -
ENOMEM
;

2630 
	}
}

2632 
__ex™
 
	$f2fs_de¡roy_po¡_»ad_´oûssšg
()

2634 
	`mempoŞ_de¡roy
(
bio_po¡_»ad_ùx_poŞ
);

2635 
	`kmem_ÿche_de¡roy
(
bio_po¡_»ad_ùx_ÿche
);

2636 
	}
}

	@fs/f2fs/debug.c

14 
	~<lšux/fs.h
>

15 
	~<lšux/backšg-dev.h
>

16 
	~<lšux/f2fs_fs.h
>

17 
	~<lšux/blkdev.h
>

18 
	~<lšux/debugfs.h
>

19 
	~<lšux/£q_fe.h
>

21 
	~"f2fs.h
"

22 
	~"node.h
"

23 
	~"£gm’t.h
"

24 
	~"gc.h
"

26 
LIST_HEAD
(
f2fs_¡©_li¡
);

27 
d’Œy
 *
	gf2fs_debugfs_roÙ
;

28 
DEFINE_MUTEX
(
f2fs_¡©_mu‹x
);

30 
	$upd©e_g’”®_¡©us
(
f2fs_sb_šfo
 *
sbi
)

32 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
);

33 
i
;

36 
si
->
h™_Ïrge¡
 = 
	`©omic64_»ad
(&
sbi
->
»ad_h™_Ïrge¡
);

37 
si
->
h™_ÿched
 = 
	`©omic64_»ad
(&
sbi
->
»ad_h™_ÿched
);

38 
si
->
h™_rbŒ“
 = 
	`©omic64_»ad
(&
sbi
->
»ad_h™_rbŒ“
);

39 
si
->
h™_tÙ®
 = si->
h™_Ïrge¡
 + si->
h™_ÿched
 + si->
h™_rbŒ“
;

40 
si
->
tÙ®_ext
 = 
	`©omic64_»ad
(&
sbi
->
tÙ®_h™_ext
);

41 
si
->
ext_Œ“
 = 
	`©omic_»ad
(&
sbi
->
tÙ®_ext_Œ“
);

42 
si
->
zomb›_Œ“
 = 
	`©omic_»ad
(&
sbi
->
tÙ®_zomb›_Œ“
);

43 
si
->
ext_node
 = 
	`©omic_»ad
(&
sbi
->
tÙ®_ext_node
);

44 
si
->
ndœty_node
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
);

45 
si
->
ndœty_d’t
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
);

46 
si
->
ndœty_m‘a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
);

47 
si
->
ndœty_d©a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DATA
);

48 
si
->
ndœty_qd©a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_QDATA
);

49 
si
->
ndœty_im‘a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_IMETA
);

50 
si
->
ndœty_dœs
 = 
sbi
->
ndœty_šode
[
DIR_INODE
];

51 
si
->
ndœty_fes
 = 
sbi
->
ndœty_šode
[
FILE_INODE
];

52 
si
->
nquÙa_fes
 = 
sbi
->nquota_files;

53 
si
->
ndœty_®l
 = 
sbi
->
ndœty_šode
[
DIRTY_META
];

54 
si
->
šmem_·ges
 = 
	`g‘_·ges
(
sbi
, 
F2FS_INMEM_PAGES
);

55 
si
->
aw_út
 = 
	`©omic_»ad
(&
sbi
->aw_cnt);

56 
si
->
vw_út
 = 
	`©omic_»ad
(&
sbi
->vw_cnt);

57 
si
->
max_aw_út
 = 
	`©omic_»ad
(&
sbi
->max_aw_cnt);

58 
si
->
max_vw_út
 = 
	`©omic_»ad
(&
sbi
->max_vw_cnt);

59 
si
->
Ä_wb_ı_d©a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_WB_CP_DATA
);

60 
si
->
Ä_wb_d©a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_WB_DATA
);

61 ià(
	`SM_I
(
sbi
è&& SM_I(sbi)->
fcc_šfo
) {

62 
si
->
Ä_æushed
 =

63 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
fcc_šfo
->
issued_æush
);

64 
si
->
Ä_æushšg
 =

65 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
fcc_šfo
->
issšg_æush
);

66 
si
->
æush_li¡_em±y
 =

67 
	`Îi¡_em±y
(&
	`SM_I
(
sbi
)->
fcc_šfo
->
issue_li¡
);

69 ià(
	`SM_I
(
sbi
è&& SM_I(sbi)->
dcc_šfo
) {

70 
si
->
Ä_disÿrded
 =

71 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
dcc_šfo
->
issued_disÿrd
);

72 
si
->
Ä_disÿrdšg
 =

73 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
dcc_šfo
->
issšg_disÿrd
);

74 
si
->
Ä_disÿrd_cmd
 =

75 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
dcc_šfo
->
disÿrd_cmd_út
);

76 
si
->
undisÿrd_blks
 = 
	`SM_I
(
sbi
)->
dcc_šfo
->undiscard_blks;

78 
si
->
tÙ®_couÁ
 = ()
sbi
->
u£r_block_couÁ
 / sbi->
blocks_³r_£g
;

79 
si
->
rsvd_£gs
 = 
	`»£rved_£gm’ts
(
sbi
);

80 
si
->
ov”p_£gs
 = 
	`ov”´ovisiÚ_£gm’ts
(
sbi
);

81 
si
->
v®id_couÁ
 = 
	`v®id_u£r_blocks
(
sbi
);

82 
si
->
disÿrd_blks
 = 
	`disÿrd_blocks
(
sbi
);

83 
si
->
v®id_node_couÁ
 = 
	`v®id_node_couÁ
(
sbi
);

84 
si
->
v®id_šode_couÁ
 = 
	`v®id_šode_couÁ
(
sbi
);

85 
si
->
šlše_x©Œ
 = 
	`©omic_»ad
(&
sbi
->inline_xattr);

86 
si
->
šlše_šode
 = 
	`©omic_»ad
(&
sbi
->inline_inode);

87 
si
->
šlše_dœ
 = 
	`©omic_»ad
(&
sbi
->inline_dir);

88 
si
->
­³nd
 = 
sbi
->
im
[
APPEND_INO
].
šo_num
;

89 
si
->
upd©e
 = 
sbi
->
im
[
UPDATE_INO
].
šo_num
;

90 
si
->
Üphªs
 = 
sbi
->
im
[
ORPHAN_INO
].
šo_num
;

91 
si
->
utiz©iÚ
 = 
	`utiz©iÚ
(
sbi
);

93 
si
->
ä“_£gs
 = 
	`ä“_£gm’ts
(
sbi
);

94 
si
->
ä“_£cs
 = 
	`ä“_£ùiÚs
(
sbi
);

95 
si
->
´eä“_couÁ
 = 
	`´eä“_£gm’ts
(
sbi
);

96 
si
->
dœty_couÁ
 = 
	`dœty_£gm’ts
(
sbi
);

97 
si
->
node_·ges
 = 
	`NODE_MAPPING
(
sbi
)->
Ä·ges
;

98 
si
->
m‘a_·ges
 = 
	`META_MAPPING
(
sbi
)->
Ä·ges
;

99 
si
->
Çts
 = 
	`NM_I
(
sbi
)->
Çt_út
;

100 
si
->
dœty_Çts
 = 
	`NM_I
(
sbi
)->
dœty_Çt_út
;

101 
si
->
s™s
 = 
	`MAIN_SEGS
(
sbi
);

102 
si
->
dœty_s™s
 = 
	`SIT_I
(
sbi
)->
dœty_£Ár›s
;

103 
si
->
ä“_nids
 = 
	`NM_I
(
sbi
)->
nid_út
[
FREE_NID
];

104 
si
->
ava_nids
 = 
	`NM_I
(
sbi
)->
avaabË_nids
;

105 
si
->
®loc_nids
 = 
	`NM_I
(
sbi
)->
nid_út
[
PREALLOC_NID
];

106 
si
->
bg_gc
 = 
sbi
->bg_gc;

107 
si
->
sk³d_©omic_fes
[
BG_GC
] = 
sbi
->skipped_atomic_files[BG_GC];

108 
si
->
sk³d_©omic_fes
[
FG_GC
] = 
sbi
->skipped_atomic_files[FG_GC];

109 
si
->
ut_ä“
 = ()(
	`ä“_u£r_blocks
(
sbi
è>> sbi->
log_blocks_³r_£g
)

110 * 100 / ()(
sbi
->
u£r_block_couÁ
 >> sbi->
log_blocks_³r_£g
)

112 
si
->
ut_v®id
 = ()(
	`wr™‹n_block_couÁ
(
sbi
) >>

113 
sbi
->
log_blocks_³r_£g
)

114 * 100 / ()(
sbi
->
u£r_block_couÁ
 >> sbi->
log_blocks_³r_£g
)

116 
si
->
ut_šv®id
 = 50 - si->
ut_ä“
 - si->
ut_v®id
;

117 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_NODE
; i++) {

118 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
i
);

119 
si
->
cur£g
[
i
] = cur£g->
£gno
;

120 
si
->
cur£c
[
i
] = 
	`GET_SEC_FROM_SEG
(
sbi
, 
cur£g
->
£gno
);

121 
si
->
curzÚe
[
i
] = 
	`GET_ZONE_FROM_SEC
(
sbi
, si->
cur£c
[i]);

124 
i
 = 0; i < 2; i++) {

125 
si
->
£gm’t_couÁ
[
i
] = 
sbi
->segment_count[i];

126 
si
->
block_couÁ
[
i
] = 
sbi
->block_count[i];

129 
si
->
š¶aû_couÁ
 = 
	`©omic_»ad
(&
sbi
->inplace_count);

130 
	}
}

135 
	$upd©e_s™_šfo
(
f2fs_sb_šfo
 *
sbi
)

137 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
);

138 
blks_³r_£c
, 
hblks_³r_£c
, 
tÙ®_vblocks
;

139 
bimod®
, 
di¡
;

140 
£gno
, 
vblocks
;

141 
ndœty
 = 0;

143 
bimod®
 = 0;

144 
tÙ®_vblocks
 = 0;

145 
blks_³r_£c
 = 
	`BLKS_PER_SEC
(
sbi
);

146 
hblks_³r_£c
 = 
blks_³r_£c
 / 2;

147 
£gno
 = 0; segnØ< 
	`MAIN_SEGS
(
sbi
); segnØ+ğsbi->
£gs_³r_£c
) {

148 
vblocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
Œue
);

149 
di¡
 = 
	`abs
(
vblocks
 - 
hblks_³r_£c
);

150 
bimod®
 +ğ
di¡
 * dist;

152 ià(
vblocks
 > 0 && vblock < 
blks_³r_£c
) {

153 
tÙ®_vblocks
 +ğ
vblocks
;

154 
ndœty
++;

157 
di¡
 = 
	`div_u64
(
	`MAIN_SECS
(
sbi
è* 
hblks_³r_£c
 * hblks_per_sec, 100);

158 
si
->
bimod®
 = 
	`div64_u64
(bimod®, 
di¡
);

159 ià(
si
->
dœty_couÁ
)

160 
si
->
avg_vblocks
 = 
	`div_u64
(
tÙ®_vblocks
, 
ndœty
);

162 
si
->
avg_vblocks
 = 0;

163 
	}
}

168 
	$upd©e_mem_šfo
(
f2fs_sb_šfo
 *
sbi
)

170 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
);

171 
Åages
;

172 
i
;

174 ià(
si
->
ba£_mem
)

175 
g‘_ÿche
;

178 
si
->
ba£_mem
 = (
f2fs_¡©_šfo
);

181 
si
->
ba£_mem
 +ğ(
f2fs_sb_šfo
è+ 
sbi
->
sb
->
s_blocksize
;

182 
si
->
ba£_mem
 +ğ2 * (
f2fs_šode_šfo
);

183 
si
->
ba£_mem
 +ğ(*
sbi
->
ck±
);

186 
si
->
ba£_mem
 +ğ(
f2fs_sm_šfo
);

189 
si
->
ba£_mem
 +ğ(
s™_šfo
);

190 
si
->
ba£_mem
 +ğ
	`MAIN_SEGS
(
sbi
è* (
£g_’Œy
);

191 
si
->
ba£_mem
 +ğ
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

192 
si
->
ba£_mem
 +ğ2 * 
SIT_VBLOCK_MAP_SIZE
 * 
	`MAIN_SEGS
(
sbi
);

193 ià(
	`f2fs_disÿrd_’
(
sbi
))

194 
si
->
ba£_mem
 +ğ
SIT_VBLOCK_MAP_SIZE
 * 
	`MAIN_SEGS
(
sbi
);

195 
si
->
ba£_mem
 +ğ
SIT_VBLOCK_MAP_SIZE
;

196 ià(
sbi
->
£gs_³r_£c
 > 1)

197 
si
->
ba£_mem
 +ğ
	`MAIN_SECS
(
sbi
è* (
£c_’Œy
);

198 
si
->
ba£_mem
 +ğ
	`__b™m­_size
(
sbi
, 
SIT_BITMAP
);

201 
si
->
ba£_mem
 +ğ(
ä“_£gm­_šfo
);

202 
si
->
ba£_mem
 +ğ
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

203 
si
->
ba£_mem
 +ğ
	`f2fs_b™m­_size
(
	`MAIN_SECS
(
sbi
));

206 
si
->
ba£_mem
 +ğ(
cur£g_šfo
è* 
NR_CURSEG_TYPE
;

207 
si
->
ba£_mem
 +ğ
PAGE_SIZE
 * 
NR_CURSEG_TYPE
;

210 
si
->
ba£_mem
 +ğ(
dœty_£gli¡_šfo
);

211 
si
->
ba£_mem
 +ğ
NR_DIRTY_TYPE
 * 
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

212 
si
->
ba£_mem
 +ğ
	`f2fs_b™m­_size
(
	`MAIN_SECS
(
sbi
));

215 
si
->
ba£_mem
 +ğ(
f2fs_nm_šfo
);

216 
si
->
ba£_mem
 +ğ
	`__b™m­_size
(
sbi
, 
NAT_BITMAP
);

217 
si
->
ba£_mem
 +ğ(
	`NM_I
(
sbi
)->
Çt_b™s_blocks
 << 
F2FS_BLKSIZE_BITS
);

218 
si
->
ba£_mem
 +ğ
	`NM_I
(
sbi
)->
Çt_blocks
 * 
NAT_ENTRY_BITMAP_SIZE
;

219 
si
->
ba£_mem
 +ğ
	`NM_I
(
sbi
)->
Çt_blocks
 / 8;

220 
si
->
ba£_mem
 +ğ
	`NM_I
(
sbi
)->
Çt_blocks
 * ();

222 
g‘_ÿche
:

223 
si
->
ÿche_mem
 = 0;

226 ià(
sbi
->
gc_th»ad
)

227 
si
->
ÿche_mem
 +ğ(
f2fs_gc_kth»ad
);

230 ià(
	`SM_I
(
sbi
)->
fcc_šfo
)

231 
si
->
ÿche_mem
 +ğ(
æush_cmd_cÚŒŞ
);

232 ià(
	`SM_I
(
sbi
)->
dcc_šfo
) {

233 
si
->
ÿche_mem
 +ğ(
disÿrd_cmd_cÚŒŞ
);

234 
si
->
ÿche_mem
 +ğ(
disÿrd_cmd
) *

235 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
dcc_šfo
->
disÿrd_cmd_út
);

239 
si
->
ÿche_mem
 +ğ(
	`NM_I
(
sbi
)->
nid_út
[
FREE_NID
] +

240 
	`NM_I
(
sbi
)->
nid_út
[
PREALLOC_NID
]) *

241 (
ä“_nid
);

242 
si
->
ÿche_mem
 +ğ
	`NM_I
(
sbi
)->
Çt_út
 * (
Çt_’Œy
);

243 
si
->
ÿche_mem
 +ğ
	`NM_I
(
sbi
)->
dœty_Çt_út
 *

244 (
Çt_’Œy_£t
);

245 
si
->
ÿche_mem
 +ğsi->
šmem_·ges
 * (inmem_pages);

246 
i
 = 0; i < 
MAX_INO_ENTRY
; i++)

247 
si
->
ÿche_mem
 +ğ
sbi
->
im
[
i
].
šo_num
 * (
šo_’Œy
);

248 
si
->
ÿche_mem
 +ğ
	`©omic_»ad
(&
sbi
->
tÙ®_ext_Œ“
) *

249 (
ex‹Á_Œ“
);

250 
si
->
ÿche_mem
 +ğ
	`©omic_»ad
(&
sbi
->
tÙ®_ext_node
) *

251 (
ex‹Á_node
);

253 
si
->
·ge_mem
 = 0;

254 
Åages
 = 
	`NODE_MAPPING
(
sbi
)->
Ä·ges
;

255 
si
->
·ge_mem
 +ğ()
Åages
 << 
PAGE_SHIFT
;

256 
Åages
 = 
	`META_MAPPING
(
sbi
)->
Ä·ges
;

257 
si
->
·ge_mem
 +ğ()
Åages
 << 
PAGE_SHIFT
;

258 
	}
}

260 
	$¡©_show
(
£q_fe
 *
s
, *
v
)

262 
f2fs_¡©_šfo
 *
si
;

263 
i
 = 0;

264 
j
;

266 
	`mu‹x_lock
(&
f2fs_¡©_mu‹x
);

267 
	`li¡_fÜ_—ch_’Œy
(
si
, &
f2fs_¡©_li¡
, 
¡©_li¡
) {

268 
	`upd©e_g’”®_¡©us
(
si
->
sbi
);

270 
	`£q_´štf
(
s
, "\n=====[…artition info(%pg). #%d, %s, CP: %s]=====\n",

271 
si
->
sbi
->
sb
->
s_bdev
, 
i
++,

272 
	`f2fs_»adÚly
(
si
->
sbi
->
sb
) ? "RO": "RW",

273 
	`f2fs_ı_”rÜ
(
si
->
sbi
) ? "Error": "Good");

274 
	`£q_´štf
(
s
, "[SB: 1] [CP: 2] [SIT: %d] [NAT: %d] ",

275 
si
->
s™_¬—_£gs
, si->
Çt_¬—_£gs
);

276 
	`£q_´štf
(
s
, "[SSA: %d] [MAIN: %d",

277 
si
->
s§_¬—_£gs
, si->
maš_¬—_£gs
);

278 
	`£q_´štf
(
s
, "(OverProv:%d Resv:%d)]\n\n",

279 
si
->
ov”p_£gs
, si->
rsvd_£gs
);

280 ià(
	`‹¡_İt
(
si
->
sbi
, 
DISCARD
))

281 
	`£q_´štf
(
s
, "Utilization: %u%% (%u valid blocks, %u discard blocks)\n",

282 
si
->
utiz©iÚ
, si->
v®id_couÁ
, si->
disÿrd_blks
);

284 
	`£q_´štf
(
s
, "Utilization: %u%% (%u valid blocks)\n",

285 
si
->
utiz©iÚ
, si->
v®id_couÁ
);

287 
	`£q_´štf
(
s
, " - Node: %u (Inode: %u, ",

288 
si
->
v®id_node_couÁ
, si->
v®id_šode_couÁ
);

289 
	`£q_´štf
(
s
, "Other: %u)\n - Data: %u\n",

290 
si
->
v®id_node_couÁ
 - si->
v®id_šode_couÁ
,

291 
si
->
v®id_couÁ
 - si->
v®id_node_couÁ
);

292 
	`£q_´štf
(
s
, " - Inline_xattr Inode: %u\n",

293 
si
->
šlše_x©Œ
);

294 
	`£q_´štf
(
s
, " - Inline_data Inode: %u\n",

295 
si
->
šlše_šode
);

296 
	`£q_´štf
(
s
, " - Inline_dentry Inode: %u\n",

297 
si
->
šlše_dœ
);

298 
	`£q_´štf
(
s
, " - Orphan/Append/Update Inode: %u, %u, %u\n",

299 
si
->
Üphªs
, si->
­³nd
, si->
upd©e
);

300 
	`£q_´štf
(
s
, "\nMain‡rea: %d segs, %d secs %d zones\n",

301 
si
->
maš_¬—_£gs
, si->
maš_¬—_£ùiÚs
,

302 
si
->
maš_¬—_zÚes
);

303 
	`£q_´štf
(
s
, " - COLD data: %d, %d, %d\n",

304 
si
->
cur£g
[
CURSEG_COLD_DATA
],

305 
si
->
cur£c
[
CURSEG_COLD_DATA
],

306 
si
->
curzÚe
[
CURSEG_COLD_DATA
]);

307 
	`£q_´štf
(
s
, " - WARM data: %d, %d, %d\n",

308 
si
->
cur£g
[
CURSEG_WARM_DATA
],

309 
si
->
cur£c
[
CURSEG_WARM_DATA
],

310 
si
->
curzÚe
[
CURSEG_WARM_DATA
]);

311 
	`£q_´štf
(
s
, " - HOT data: %d, %d, %d\n",

312 
si
->
cur£g
[
CURSEG_HOT_DATA
],

313 
si
->
cur£c
[
CURSEG_HOT_DATA
],

314 
si
->
curzÚe
[
CURSEG_HOT_DATA
]);

315 
	`£q_´štf
(
s
, " - Dir dnode: %d, %d, %d\n",

316 
si
->
cur£g
[
CURSEG_HOT_NODE
],

317 
si
->
cur£c
[
CURSEG_HOT_NODE
],

318 
si
->
curzÚe
[
CURSEG_HOT_NODE
]);

319 
	`£q_´štf
(
s
, " - File dnode: %d, %d, %d\n",

320 
si
->
cur£g
[
CURSEG_WARM_NODE
],

321 
si
->
cur£c
[
CURSEG_WARM_NODE
],

322 
si
->
curzÚe
[
CURSEG_WARM_NODE
]);

323 
	`£q_´štf
(
s
, " - Indir‚odes: %d, %d, %d\n",

324 
si
->
cur£g
[
CURSEG_COLD_NODE
],

325 
si
->
cur£c
[
CURSEG_COLD_NODE
],

326 
si
->
curzÚe
[
CURSEG_COLD_NODE
]);

327 
	`£q_´štf
(
s
, "\n - Valid: %d\n - Dirty: %d\n",

328 
si
->
maš_¬—_£gs
 - si->
dœty_couÁ
 -

329 
si
->
´eä“_couÁ
 - si->
ä“_£gs
,

330 
si
->
dœty_couÁ
);

331 
	`£q_´štf
(
s
, " - Prefree: %d\n - Free: %d (%d)\n\n",

332 
si
->
´eä“_couÁ
, si->
ä“_£gs
, si->
ä“_£cs
);

333 
	`£q_´štf
(
s
, "CP calls: %d (BG: %d)\n",

334 
si
->
ı_couÁ
, si->
bg_ı_couÁ
);

335 
	`£q_´štf
(
s
, "GC calls: %d (BG: %d)\n",

336 
si
->
ÿÎ_couÁ
, si->
bg_gc
);

337 
	`£q_´štf
(
s
, " - data segments : %d (%d)\n",

338 
si
->
d©a_£gs
, si->
bg_d©a_£gs
);

339 
	`£q_´štf
(
s
, " -‚ode segments : %d (%d)\n",

340 
si
->
node_£gs
, si->
bg_node_£gs
);

341 
	`£q_´štf
(
s
, "TryØmov%d block (BG: %d)\n", 
si
->
tÙ_blks
,

342 
si
->
bg_d©a_blks
 + si->
bg_node_blks
);

343 
	`£q_´štf
(
s
, " - d©¨block : %d (%d)\n", 
si
->
d©a_blks
,

344 
si
->
bg_d©a_blks
);

345 
	`£q_´štf
(
s
, " -‚odblock : %d (%d)\n", 
si
->
node_blks
,

346 
si
->
bg_node_blks
);

347 
	`£q_´štf
(
s
, "Skipped :‡tomic write %llu (%llu)\n",

348 
si
->
sk³d_©omic_fes
[
BG_GC
] +

349 
si
->
sk³d_©omic_fes
[
FG_GC
],

350 
si
->
sk³d_©omic_fes
[
BG_GC
]);

351 
	`£q_puts
(
s
, "\nExtent Cache:\n");

352 
	`£q_´štf
(
s
, " - Hit Count: L1-1:%llu L1-2:%llu L2:%llu\n",

353 
si
->
h™_Ïrge¡
, si->
h™_ÿched
,

354 
si
->
h™_rbŒ“
);

355 
	`£q_´štf
(
s
, " - Hit Ratio: %llu%% (%llu / %llu)\n",

356 !
si
->
tÙ®_ext
 ? 0 :

357 
	`div64_u64
(
si
->
h™_tÙ®
 * 100, si->
tÙ®_ext
),

358 
si
->
h™_tÙ®
, si->
tÙ®_ext
);

359 
	`£q_´štf
(
s
, " - Inner Struct Count:ree: %d(%d),‚ode: %d\n",

360 
si
->
ext_Œ“
, si->
zomb›_Œ“
, si->
ext_node
);

361 
	`£q_puts
(
s
, "\nBalancing F2FS Async:\n");

362 
	`£q_´štf
(
s
, " - IO (CP: %4d, Data: %4d, Flush: (%4d %4d %4d), "

364 
si
->
Ä_wb_ı_d©a
, si->
Ä_wb_d©a
,

365 
si
->
Ä_æushšg
, si->
Ä_æushed
,

366 
si
->
æush_li¡_em±y
,

367 
si
->
Ä_disÿrdšg
, si->
Ä_disÿrded
,

368 
si
->
Ä_disÿrd_cmd
, si->
undisÿrd_blks
);

369 
	`£q_´štf
(
s
, " - inmem: %4d,‡tomic IO: %4d (Max. %4d), "

371 
si
->
šmem_·ges
, si->
aw_út
, si->
max_aw_út
,

372 
si
->
vw_út
, si->
max_vw_út
);

373 
	`£q_´štf
(
s
, " -‚odes: %4d in %4d\n",

374 
si
->
ndœty_node
, si->
node_·ges
);

375 
	`£q_´štf
(
s
, " - dents: %4d in dirs:%4d (%4d)\n",

376 
si
->
ndœty_d’t
, si->
ndœty_dœs
, si->
ndœty_®l
);

377 
	`£q_´štf
(
s
, " - datas: %4d in files:%4d\n",

378 
si
->
ndœty_d©a
, si->
ndœty_fes
);

379 
	`£q_´štf
(
s
, " - quota datas: %4d in quota files:%4d\n",

380 
si
->
ndœty_qd©a
, si->
nquÙa_fes
);

381 
	`£q_´štf
(
s
, " - meta: %4d in %4d\n",

382 
si
->
ndœty_m‘a
, si->
m‘a_·ges
);

383 
	`£q_´štf
(
s
, " - imeta: %4d\n",

384 
si
->
ndœty_im‘a
);

385 
	`£q_´štf
(
s
, " - NATs: %9d/%9d\n - SITs: %9d/%9d\n",

386 
si
->
dœty_Çts
, si->
Çts
, si->
dœty_s™s
, si->
s™s
);

387 
	`£q_´štf
(
s
, " - free_nids: %9d/%9d\n -‡lloc_nids: %9d\n",

388 
si
->
ä“_nids
, si->
ava_nids
, si->
®loc_nids
);

389 
	`£q_puts
(
s
, "\nDistribution of User Blocks:");

390 
	`£q_puts
(
s
, " [ valid | invalid | free ]\n");

391 
	`£q_puts
(
s
, " [");

393 
j
 = 0; j < 
si
->
ut_v®id
; j++)

394 
	`£q_putc
(
s
, '-');

395 
	`£q_putc
(
s
, '|');

397 
j
 = 0; j < 
si
->
ut_šv®id
; j++)

398 
	`£q_putc
(
s
, '-');

399 
	`£q_putc
(
s
, '|');

401 
j
 = 0; j < 
si
->
ut_ä“
; j++)

402 
	`£q_putc
(
s
, '-');

403 
	`£q_puts
(
s
, "]\n\n");

404 
	`£q_´štf
(
s
, "IPU: %u blocks\n", 
si
->
š¶aû_couÁ
);

405 
	`£q_´štf
(
s
, "SSR: %u blocks in %u segments\n",

406 
si
->
block_couÁ
[
SSR
], si->
£gm’t_couÁ
[SSR]);

407 
	`£q_´štf
(
s
, "LFS: %u blocks in %u segments\n",

408 
si
->
block_couÁ
[
LFS
], si->
£gm’t_couÁ
[LFS]);

411 
	`upd©e_s™_šfo
(
si
->
sbi
);

412 
	`£q_´štf
(
s
, "\nBDF: %u,‡vg. vblocks: %u\n",

413 
si
->
bimod®
, si->
avg_vblocks
);

416 
	`upd©e_mem_šfo
(
si
->
sbi
);

417 
	`£q_´štf
(
s
, "\nMemory: %llu KB\n",

418 (
si
->
ba£_mem
 + si->
ÿche_mem
 + si->
·ge_mem
) >> 10);

419 
	`£q_´štf
(
s
, " - static: %llu KB\n",

420 
si
->
ba£_mem
 >> 10);

421 
	`£q_´štf
(
s
, " - cached: %llu KB\n",

422 
si
->
ÿche_mem
 >> 10);

423 
	`£q_´štf
(
s
, " -…aged : %llu KB\n",

424 
si
->
·ge_mem
 >> 10);

426 
	`mu‹x_uÆock
(&
f2fs_¡©_mu‹x
);

428 
	}
}

430 
	$¡©_İ’
(
šode
 *šode, 
fe
 *file)

432  
	`sšgË_İ’
(
fe
, 
¡©_show
, 
šode
->
i_´iv©e
);

433 
	}
}

435 cÚ¡ 
fe_İ”©iÚs
 
	g¡©_fİs
 = {

436 .
owÃr
 = 
THIS_MODULE
,

437 .
	gİ’
 = 
¡©_İ’
,

438 .
	g»ad
 = 
£q_»ad
,

439 .
	gÎ£ek
 = 
£q_l£ek
,

440 .
	g»Ëa£
 = 
sšgË_»Ëa£
,

443 
	$f2fs_bud_¡©s
(
f2fs_sb_šfo
 *
sbi
)

445 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

446 
f2fs_¡©_šfo
 *
si
;

448 
si
 = 
	`f2fs_kz®loc
(
sbi
, (
f2fs_¡©_šfo
), 
GFP_KERNEL
);

449 ià(!
si
)

450  -
ENOMEM
;

452 
si
->
®l_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ
);

453 
si
->
s™_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s™
);

454 
si
->
Çt_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_Çt
);

455 
si
->
s§_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s§
);

456 
si
->
maš_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_maš
);

457 
si
->
maš_¬—_£ùiÚs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£ùiÚ_couÁ
);

458 
si
->
maš_¬—_zÚes
 = si->
maš_¬—_£ùiÚs
 /

459 
	`Ë32_to_ıu
(
¿w_su³r
->
£cs_³r_zÚe
);

460 
si
->
sbi
 = sbi;

461 
sbi
->
¡©_šfo
 = 
si
;

463 
	`©omic64_£t
(&
sbi
->
tÙ®_h™_ext
, 0);

464 
	`©omic64_£t
(&
sbi
->
»ad_h™_rbŒ“
, 0);

465 
	`©omic64_£t
(&
sbi
->
»ad_h™_Ïrge¡
, 0);

466 
	`©omic64_£t
(&
sbi
->
»ad_h™_ÿched
, 0);

468 
	`©omic_£t
(&
sbi
->
šlše_x©Œ
, 0);

469 
	`©omic_£t
(&
sbi
->
šlše_šode
, 0);

470 
	`©omic_£t
(&
sbi
->
šlše_dœ
, 0);

471 
	`©omic_£t
(&
sbi
->
š¶aû_couÁ
, 0);

473 
	`©omic_£t
(&
sbi
->
aw_út
, 0);

474 
	`©omic_£t
(&
sbi
->
vw_út
, 0);

475 
	`©omic_£t
(&
sbi
->
max_aw_út
, 0);

476 
	`©omic_£t
(&
sbi
->
max_vw_út
, 0);

478 
	`mu‹x_lock
(&
f2fs_¡©_mu‹x
);

479 
	`li¡_add_
(&
si
->
¡©_li¡
, &
f2fs_¡©_li¡
);

480 
	`mu‹x_uÆock
(&
f2fs_¡©_mu‹x
);

483 
	}
}

485 
	$f2fs_de¡roy_¡©s
(
f2fs_sb_šfo
 *
sbi
)

487 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
);

489 
	`mu‹x_lock
(&
f2fs_¡©_mu‹x
);

490 
	`li¡_d–
(&
si
->
¡©_li¡
);

491 
	`mu‹x_uÆock
(&
f2fs_¡©_mu‹x
);

493 
	`kä“
(
si
);

494 
	}
}

496 
__š™
 
	$f2fs_ü—‹_roÙ_¡©s
()

498 
d’Œy
 *
fe
;

500 
f2fs_debugfs_roÙ
 = 
	`debugfs_ü—‹_dœ
("f2fs", 
NULL
);

501 ià(!
f2fs_debugfs_roÙ
)

502  -
ENOMEM
;

504 
fe
 = 
	`debugfs_ü—‹_fe
("¡©us", 
S_IRUGO
, 
f2fs_debugfs_roÙ
,

505 
NULL
, &
¡©_fİs
);

506 ià(!
fe
) {

507 
	`debugfs_»move
(
f2fs_debugfs_roÙ
);

508 
f2fs_debugfs_roÙ
 = 
NULL
;

509  -
ENOMEM
;

513 
	}
}

515 
	$f2fs_de¡roy_roÙ_¡©s
()

517 ià(!
f2fs_debugfs_roÙ
)

520 
	`debugfs_»move_»cursive
(
f2fs_debugfs_roÙ
);

521 
f2fs_debugfs_roÙ
 = 
NULL
;

522 
	}
}

	@fs/f2fs/dir.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/sched/sigÇl.h
>

14 
	~"f2fs.h
"

15 
	~"node.h
"

16 
	~"aş.h
"

17 
	~"x©Œ.h
"

18 
	~<Œaû/ev’ts/f2fs.h
>

20 
	$dœ_blocks
(
šode
 *inode)

22  ((è(
	`i_size_»ad
(
šode
è+ 
PAGE_SIZE
 - 1))

23 >> 
PAGE_SHIFT
;

24 
	}
}

26 
	$dœ_buck‘s
(
Ëv–
, 
dœ_Ëv–
)

28 ià(
Ëv–
 + 
dœ_Ëv–
 < 
MAX_DIR_HASH_DEPTH
 / 2)

29  1 << (
Ëv–
 + 
dœ_Ëv–
);

31  
MAX_DIR_BUCKETS
;

32 
	}
}

34 
	$buck‘_blocks
(
Ëv–
)

36 ià(
Ëv–
 < 
MAX_DIR_HASH_DEPTH
 / 2)

40 
	}
}

42 
	gf2fs_f‘y³_bË
[
F2FS_FT_MAX
] = {

43 [
F2FS_FT_UNKNOWN
] = 
DT_UNKNOWN
,

44 [
F2FS_FT_REG_FILE
] = 
DT_REG
,

45 [
F2FS_FT_DIR
] = 
DT_DIR
,

46 [
F2FS_FT_CHRDEV
] = 
DT_CHR
,

47 [
F2FS_FT_BLKDEV
] = 
DT_BLK
,

48 [
F2FS_FT_FIFO
] = 
DT_FIFO
,

49 [
F2FS_FT_SOCK
] = 
DT_SOCK
,

50 [
F2FS_FT_SYMLINK
] = 
DT_LNK
,

53 
	gf2fs_ty³_by_mode
[
S_IFMT
 >> 
S_SHIFT
] = {

54 [
S_IFREG
 >> 
S_SHIFT
] = 
F2FS_FT_REG_FILE
,

55 [
S_IFDIR
 >> 
S_SHIFT
] = 
F2FS_FT_DIR
,

56 [
S_IFCHR
 >> 
S_SHIFT
] = 
F2FS_FT_CHRDEV
,

57 [
S_IFBLK
 >> 
S_SHIFT
] = 
F2FS_FT_BLKDEV
,

58 [
S_IFIFO
 >> 
S_SHIFT
] = 
F2FS_FT_FIFO
,

59 [
S_IFSOCK
 >> 
S_SHIFT
] = 
F2FS_FT_SOCK
,

60 [
S_IFLNK
 >> 
S_SHIFT
] = 
F2FS_FT_SYMLINK
,

63 
	$£t_de_ty³
(
f2fs_dœ_’Œy
 *
de
, 
umode_t
 
mode
)

65 
de
->
fe_ty³
 = 
f2fs_ty³_by_mode
[(
mode
 & 
S_IFMT
è>> 
S_SHIFT
];

66 
	}
}

68 
	$f2fs_g‘_de_ty³
(
f2fs_dœ_’Œy
 *
de
)

70 ià(
de
->
fe_ty³
 < 
F2FS_FT_MAX
)

71  
f2fs_f‘y³_bË
[
de
->
fe_ty³
];

72  
DT_UNKNOWN
;

73 
	}
}

75 
	$dœ_block_šdex
(
Ëv–
,

76 
dœ_Ëv–
, 
idx
)

78 
i
;

79 
bidx
 = 0;

81 
i
 = 0; i < 
Ëv–
; i++)

82 
bidx
 +ğ
	`dœ_buck‘s
(
i
, 
dœ_Ëv–
è* 
	`buck‘_blocks
(i);

83 
bidx
 +ğ
idx
 * 
	`buck‘_blocks
(
Ëv–
);

84  
bidx
;

85 
	}
}

87 
f2fs_dœ_’Œy
 *
	$fšd_š_block
(
·ge
 *
d’Œy_·ge
,

88 
fsüy±_Çme
 *
âame
,

89 
f2fs_hash_t
 
Çmehash
,

90 *
max_¦Ùs
,

91 
·ge
 **
»s_·ge
)

93 
f2fs_d’Œy_block
 *
d’Œy_blk
;

94 
f2fs_dœ_’Œy
 *
de
;

95 
f2fs_d’Œy_±r
 
d
;

97 
d’Œy_blk
 = (
f2fs_d’Œy_block
 *)
	`·ge_add»ss
(
d’Œy_·ge
);

99 
	`make_d’Œy_±r_block
(
NULL
, &
d
, 
d’Œy_blk
);

100 
de
 = 
	`f2fs_fšd_rg‘_d’Œy
(
âame
, 
Çmehash
, 
max_¦Ùs
, &
d
);

101 ià(
de
)

102 *
»s_·ge
 = 
d’Œy_·ge
;

104  
de
;

105 
	}
}

107 
f2fs_dœ_’Œy
 *
	$f2fs_fšd_rg‘_d’Œy
(
fsüy±_Çme
 *
âame
,

108 
f2fs_hash_t
 
Çmehash
, *
max_¦Ùs
,

109 
f2fs_d’Œy_±r
 *
d
)

111 
f2fs_dœ_’Œy
 *
de
;

112 
b™_pos
 = 0;

113 
max_Ën
 = 0;

115 ià(
max_¦Ùs
)

116 *
max_¦Ùs
 = 0;

117 
b™_pos
 < 
d
->
max
) {

118 ià(!
	`‹¡_b™_Ë
(
b™_pos
, 
d
->
b™m­
)) {

119 
b™_pos
++;

120 
max_Ën
++;

124 
de
 = &
d
->
d’Œy
[
b™_pos
];

126 ià(
	`uÆik–y
(!
de
->
Çme_Ën
)) {

127 
b™_pos
++;

131 ià(
de
->
hash_code
 =ğ
Çmehash
 &&

132 
	`fsüy±_m©ch_Çme
(
âame
, 
d
->
f’ame
[
b™_pos
],

133 
	`Ë16_to_ıu
(
de
->
Çme_Ën
)))

134 
found
;

136 ià(
max_¦Ùs
 && 
max_Ën
 > *max_slots)

137 *
max_¦Ùs
 = 
max_Ën
;

138 
max_Ën
 = 0;

140 
b™_pos
 +ğ
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
de
->
Çme_Ën
));

143 
de
 = 
NULL
;

144 
found
:

145 ià(
max_¦Ùs
 && 
max_Ën
 > *max_slots)

146 *
max_¦Ùs
 = 
max_Ën
;

147  
de
;

148 
	}
}

150 
f2fs_dœ_’Œy
 *
	$fšd_š_Ëv–
(
šode
 *
dœ
,

151 
Ëv–
,

152 
fsüy±_Çme
 *
âame
,

153 
·ge
 **
»s_·ge
)

155 
q¡r
 
Çme
 = 
	`FSTR_TO_QSTR
(&
âame
->
disk_Çme
);

156 
s
 = 
	`GET_DENTRY_SLOTS
(
Çme
.
Ën
);

157 
nbuck‘
, 
nblock
;

158 
bidx
, 
’d_block
;

159 
·ge
 *
d’Œy_·ge
;

160 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

161 
boŞ
 
room
 = 
çl£
;

162 
max_¦Ùs
;

163 
f2fs_hash_t
 
Çmehash
 = 
	`f2fs_d’Œy_hash
(&
Çme
, 
âame
);

165 
nbuck‘
 = 
	`dœ_buck‘s
(
Ëv–
, 
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
);

166 
nblock
 = 
	`buck‘_blocks
(
Ëv–
);

168 
bidx
 = 
	`dœ_block_šdex
(
Ëv–
, 
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
,

169 
	`Ë32_to_ıu
(
Çmehash
è% 
nbuck‘
);

170 
’d_block
 = 
bidx
 + 
nblock
;

172 ; 
bidx
 < 
’d_block
; bidx++) {

174 
d’Œy_·ge
 = 
	`f2fs_fšd_d©a_·ge
(
dœ
, 
bidx
);

175 ià(
	`IS_ERR
(
d’Œy_·ge
)) {

176 ià(
	`PTR_ERR
(
d’Œy_·ge
è=ğ-
ENOENT
) {

177 
room
 = 
Œue
;

180 *
»s_·ge
 = 
d’Œy_·ge
;

185 
de
 = 
	`fšd_š_block
(
d’Œy_·ge
, 
âame
, 
Çmehash
, &
max_¦Ùs
,

186 
»s_·ge
);

187 ià(
de
)

190 ià(
max_¦Ùs
 >ğ
s
)

191 
room
 = 
Œue
;

192 
	`f2fs_put_·ge
(
d’Œy_·ge
, 0);

195 ià(!
de
 && 
room
 && 
	`F2FS_I
(
dœ
)->
chash
 !ğ
Çmehash
) {

196 
	`F2FS_I
(
dœ
)->
chash
 = 
Çmehash
;

197 
	`F2FS_I
(
dœ
)->
şev–
 = 
Ëv–
;

200  
de
;

201 
	}
}

203 
f2fs_dœ_’Œy
 *
	$__f2fs_fšd_’Œy
(
šode
 *
dœ
,

204 
fsüy±_Çme
 *
âame
, 
·ge
 **
»s_·ge
)

206 
Åages
 = 
	`dœ_blocks
(
dœ
);

207 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

208 
max_d•th
;

209 
Ëv–
;

211 ià(
	`f2fs_has_šlše_d’Œy
(
dœ
)) {

212 *
»s_·ge
 = 
NULL
;

213 
de
 = 
	`f2fs_fšd_š_šlše_dœ
(
dœ
, 
âame
, 
»s_·ge
);

214 
out
;

217 ià(
Åages
 == 0) {

218 *
»s_·ge
 = 
NULL
;

219 
out
;

222 
max_d•th
 = 
	`F2FS_I
(
dœ
)->
i_cu¼’t_d•th
;

223 ià(
	`uÆik–y
(
max_d•th
 > 
MAX_DIR_HASH_DEPTH
)) {

224 
	`f2fs_msg
(
	`F2FS_I_SB
(
dœ
)->
sb
, 
KERN_WARNING
,

226 
dœ
->
i_šo
, 
max_d•th
);

227 
max_d•th
 = 
MAX_DIR_HASH_DEPTH
;

228 
	`f2fs_i_d•th_wr™e
(
dœ
, 
max_d•th
);

231 
Ëv–
 = 0;†ev– < 
max_d•th
;†evel++) {

232 *
»s_·ge
 = 
NULL
;

233 
de
 = 
	`fšd_š_Ëv–
(
dœ
, 
Ëv–
, 
âame
, 
»s_·ge
);

234 ià(
de
 || 
	`IS_ERR
(*
»s_·ge
))

237 
out
:

239 ià(!
de
)

240 
	`F2FS_I
(
dœ
)->
sk
 = 
cu¼’t
;

241  
de
;

242 
	}
}

250 
f2fs_dœ_’Œy
 *
	$f2fs_fšd_’Œy
(
šode
 *
dœ
,

251 cÚ¡ 
q¡r
 *
chd
, 
·ge
 **
»s_·ge
)

253 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

254 
fsüy±_Çme
 
âame
;

255 
”r
;

257 
”r
 = 
	`fsüy±_£tup_f’ame
(
dœ
, 
chd
, 1, &
âame
);

258 ià(
”r
) {

259 ià(
”r
 =ğ-
ENOENT
)

260 *
»s_·ge
 = 
NULL
;

262 *
»s_·ge
 = 
	`ERR_PTR
(
”r
);

263  
NULL
;

266 
de
 = 
	`__f2fs_fšd_’Œy
(
dœ
, &
âame
, 
»s_·ge
);

268 
	`fsüy±_ä“_f’ame
(&
âame
);

269  
de
;

270 
	}
}

272 
f2fs_dœ_’Œy
 *
	$f2fs_·»Á_dœ
(
šode
 *
dœ
, 
·ge
 **
p
)

274 
q¡r
 
dÙdÙ
 = 
	`QSTR_INIT
("..", 2);

276  
	`f2fs_fšd_’Œy
(
dœ
, &
dÙdÙ
, 
p
);

277 
	}
}

279 
šo_t
 
	$f2fs_šode_by_Çme
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *qstr,

280 
·ge
 **page)

282 
šo_t
 
»s
 = 0;

283 
f2fs_dœ_’Œy
 *
de
;

285 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, 
q¡r
, 
·ge
);

286 ià(
de
) {

287 
»s
 = 
	`Ë32_to_ıu
(
de
->
šo
);

288 
	`f2fs_put_·ge
(*
·ge
, 0);

291  
»s
;

292 
	}
}

294 
	$f2fs_£t_lšk
(
šode
 *
dœ
, 
f2fs_dœ_’Œy
 *
de
,

295 
·ge
 *·ge, 
šode
 *inode)

297 
·ge_ty³
 
ty³
 = 
	`f2fs_has_šlše_d’Œy
(
dœ
è? 
NODE
 : 
DATA
;

298 
	`lock_·ge
(
·ge
);

299 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
ty³
, 
Œue
);

300 
de
->
šo
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

301 
	`£t_de_ty³
(
de
, 
šode
->
i_mode
);

302 
	`£t_·ge_dœty
(
·ge
);

304 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
	`cu¼’t_time
(dir);

305 
	`f2fs_m¬k_šode_dœty_sync
(
dœ
, 
çl£
);

306 
	`f2fs_put_·ge
(
·ge
, 1);

307 
	}
}

309 
	$š™_d’t_šode
(cÚ¡ 
q¡r
 *
Çme
, 
·ge
 *
age
)

311 
f2fs_šode
 *
ri
;

313 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
);

316 
ri
 = 
	`F2FS_INODE
(
age
);

317 
ri
->
i_Çm–’
 = 
	`ıu_to_Ë32
(
Çme
->
Ën
);

318 
	`memıy
(
ri
->
i_Çme
, 
Çme
->Çme,‚ame->
Ën
);

319 
	`£t_·ge_dœty
(
age
);

320 
	}
}

322 
	$f2fs_do_make_em±y_dœ
(
šode
 *šode, šod*
·»Á
,

323 
f2fs_d’Œy_±r
 *
d
)

325 
q¡r
 
dÙ
 = 
	`QSTR_INIT
(".", 1);

326 
q¡r
 
dÙdÙ
 = 
	`QSTR_INIT
("..", 2);

329 
	`f2fs_upd©e_d’Œy
(
šode
->
i_šo
, inode->
i_mode
, 
d
, &
dÙ
, 0, 0);

332 
	`f2fs_upd©e_d’Œy
(
·»Á
->
i_šo
,…¬’t->
i_mode
, 
d
, &
dÙdÙ
, 0, 1);

333 
	}
}

335 
	$make_em±y_dœ
(
šode
 *inode,

336 
šode
 *
·»Á
, 
·ge
 *page)

338 
·ge
 *
d’Œy_·ge
;

339 
f2fs_d’Œy_block
 *
d’Œy_blk
;

340 
f2fs_d’Œy_±r
 
d
;

342 ià(
	`f2fs_has_šlše_d’Œy
(
šode
))

343  
	`f2fs_make_em±y_šlše_dœ
(
šode
, 
·»Á
, 
·ge
);

345 
d’Œy_·ge
 = 
	`f2fs_g‘_Ãw_d©a_·ge
(
šode
, 
·ge
, 0, 
Œue
);

346 ià(
	`IS_ERR
(
d’Œy_·ge
))

347  
	`PTR_ERR
(
d’Œy_·ge
);

349 
d’Œy_blk
 = 
	`·ge_add»ss
(
d’Œy_·ge
);

351 
	`make_d’Œy_±r_block
(
NULL
, &
d
, 
d’Œy_blk
);

352 
	`f2fs_do_make_em±y_dœ
(
šode
, 
·»Á
, &
d
);

354 
	`£t_·ge_dœty
(
d’Œy_·ge
);

355 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

357 
	}
}

359 
·ge
 *
	$f2fs_š™_šode_m‘ad©a
(
šode
 *šode, šod*
dœ
,

360 cÚ¡ 
q¡r
 *
Ãw_Çme
, cÚ¡ q¡¸*
Üig_Çme
,

361 
·ge
 *
d·ge
)

363 
·ge
 *page;

364 
dummy_’üy±
 = 
	`DUMMY_ENCRYPTION_ENABLED
(
	`F2FS_I_SB
(
dœ
));

365 
”r
;

367 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NEW_INODE
)) {

368 
·ge
 = 
	`f2fs_Ãw_šode_·ge
(
šode
);

369 ià(
	`IS_ERR
(
·ge
))

370  
·ge
;

372 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

374 
	`g‘_·ge
(
·ge
);

375 
”r
 = 
	`make_em±y_dœ
(
šode
, 
dœ
, 
·ge
);

376 ià(
”r
) {

377 
	`lock_·ge
(
·ge
);

378 
put_”rÜ
;

380 
	`put_·ge
(
·ge
);

383 
”r
 = 
	`f2fs_š™_aş
(
šode
, 
dœ
, 
·ge
, 
d·ge
);

384 ià(
”r
)

385 
put_”rÜ
;

387 
”r
 = 
	`f2fs_š™_£cur™y
(
šode
, 
dœ
, 
Üig_Çme
, 
·ge
);

388 ià(
”r
)

389 
put_”rÜ
;

391 ià((
	`f2fs_’üy±ed_šode
(
dœ
è|| 
dummy_’üy±
) &&

392 
	`f2fs_may_’üy±
(
šode
)) {

393 
”r
 = 
	`fsüy±_šh”™_cÚ‹xt
(
dœ
, 
šode
, 
·ge
, 
çl£
);

394 ià(
”r
)

395 
put_”rÜ
;

398 
·ge
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
dœ
), 
šode
->
i_šo
);

399 ià(
	`IS_ERR
(
·ge
))

400  
·ge
;

403 ià(
Ãw_Çme
) {

404 
	`š™_d’t_šode
(
Ãw_Çme
, 
·ge
);

405 ià(
	`f2fs_’üy±ed_šode
(
dœ
))

406 
	`fe_£t_’c_Çme
(
šode
);

413 ià(
	`is_šode_æag_£t
(
šode
, 
FI_INC_LINK
)) {

414 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

415 
	`fe_lo¡_pšo
(
šode
);

420 ià(
šode
->
i_Æšk
 == 0)

421 
	`f2fs_»move_Üphª_šode
(
	`F2FS_I_SB
(
dœ
), 
šode
->
i_šo
);

422 
	`f2fs_i_lšks_wr™e
(
šode
, 
Œue
);

424  
·ge
;

426 
put_”rÜ
:

427 
	`ş—r_Æšk
(
šode
);

428 
	`f2fs_upd©e_šode
(
šode
, 
·ge
);

429 
	`f2fs_put_·ge
(
·ge
, 1);

430  
	`ERR_PTR
(
”r
);

431 
	}
}

433 
	$f2fs_upd©e_·»Á_m‘ad©a
(
šode
 *
dœ
, inode *inode,

434 
cu¼’t_d•th
)

436 ià(
šode
 && 
	`is_šode_æag_£t
(šode, 
FI_NEW_INODE
)) {

437 ià(
	`S_ISDIR
(
šode
->
i_mode
))

438 
	`f2fs_i_lšks_wr™e
(
dœ
, 
Œue
);

439 
	`ş—r_šode_æag
(
šode
, 
FI_NEW_INODE
);

441 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
	`cu¼’t_time
(dir);

442 
	`f2fs_m¬k_šode_dœty_sync
(
dœ
, 
çl£
);

444 ià(
	`F2FS_I
(
dœ
)->
i_cu¼’t_d•th
 !ğ
cu¼’t_d•th
)

445 
	`f2fs_i_d•th_wr™e
(
dœ
, 
cu¼’t_d•th
);

447 ià(
šode
 && 
	`is_šode_æag_£t
(šode, 
FI_INC_LINK
))

448 
	`ş—r_šode_æag
(
šode
, 
FI_INC_LINK
);

449 
	}
}

451 
	$f2fs_room_fÜ_f’ame
(cÚ¡ *
b™m­
, 
¦Ùs
, 
max_¦Ùs
)

453 
b™_¡¬t
 = 0;

454 
z”o_¡¬t
, 
z”o_’d
;

455 
Ãxt
:

456 
z”o_¡¬t
 = 
	`fšd_Ãxt_z”o_b™_Ë
(
b™m­
, 
max_¦Ùs
, 
b™_¡¬t
);

457 ià(
z”o_¡¬t
 >ğ
max_¦Ùs
)

458  
max_¦Ùs
;

460 
z”o_’d
 = 
	`fšd_Ãxt_b™_Ë
(
b™m­
, 
max_¦Ùs
, 
z”o_¡¬t
);

461 ià(
z”o_’d
 - 
z”o_¡¬t
 >ğ
¦Ùs
)

462  
z”o_¡¬t
;

464 
b™_¡¬t
 = 
z”o_’d
 + 1;

466 ià(
z”o_’d
 + 1 >ğ
max_¦Ùs
)

467  
max_¦Ùs
;

468 
Ãxt
;

469 
	}
}

471 
	$f2fs_upd©e_d’Œy
(
nid_t
 
šo
, 
umode_t
 
mode
, 
f2fs_d’Œy_±r
 *
d
,

472 cÚ¡ 
q¡r
 *
Çme
, 
f2fs_hash_t
 
Çme_hash
,

473 
b™_pos
)

475 
f2fs_dœ_’Œy
 *
de
;

476 
¦Ùs
 = 
	`GET_DENTRY_SLOTS
(
Çme
->
Ën
);

477 
i
;

479 
de
 = &
d
->
d’Œy
[
b™_pos
];

480 
de
->
hash_code
 = 
Çme_hash
;

481 
de
->
Çme_Ën
 = 
	`ıu_to_Ë16
(
Çme
->
Ën
);

482 
	`memıy
(
d
->
f’ame
[
b™_pos
], 
Çme
->Çme,‚ame->
Ën
);

483 
de
->
šo
 = 
	`ıu_to_Ë32
(ino);

484 
	`£t_de_ty³
(
de
, 
mode
);

485 
i
 = 0; i < 
¦Ùs
; i++) {

486 
	`__£t_b™_Ë
(
b™_pos
 + 
i
, (*)
d
->
b™m­
);

488 ià(
i
)

489 (
de
 + 
i
)->
Çme_Ën
 = 0;

491 
	}
}

493 
	$f2fs_add_»guÏr_’Œy
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Ãw_Çme
,

494 cÚ¡ 
q¡r
 *
Üig_Çme
,

495 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
)

497 
b™_pos
;

498 
Ëv–
;

499 
cu¼’t_d•th
;

500 
bidx
, 
block
;

501 
f2fs_hash_t
 
d’Œy_hash
;

502 
nbuck‘
, 
nblock
;

503 
·ge
 *
d’Œy_·ge
 = 
NULL
;

504 
f2fs_d’Œy_block
 *
d’Œy_blk
 = 
NULL
;

505 
f2fs_d’Œy_±r
 
d
;

506 
·ge
 *·gğ
NULL
;

507 
¦Ùs
, 
”r
 = 0;

509 
Ëv–
 = 0;

510 
¦Ùs
 = 
	`GET_DENTRY_SLOTS
(
Ãw_Çme
->
Ën
);

511 
d’Œy_hash
 = 
	`f2fs_d’Œy_hash
(
Ãw_Çme
, 
NULL
);

513 
cu¼’t_d•th
 = 
	`F2FS_I
(
dœ
)->
i_cu¼’t_d•th
;

514 ià(
	`F2FS_I
(
dœ
)->
chash
 =ğ
d’Œy_hash
) {

515 
Ëv–
 = 
	`F2FS_I
(
dœ
)->
şev–
;

516 
	`F2FS_I
(
dœ
)->
chash
 = 0;

519 
¡¬t
:

520 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


521 ià(
	`time_to_šjeù
(
	`F2FS_I_SB
(
dœ
), 
FAULT_DIR_DEPTH
)) {

522 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_DIR_DEPTH
);

523  -
ENOSPC
;

526 ià(
	`uÆik–y
(
cu¼’t_d•th
 =ğ
MAX_DIR_HASH_DEPTH
))

527  -
ENOSPC
;

530 ià(
Ëv–
 =ğ
cu¼’t_d•th
)

531 ++
cu¼’t_d•th
;

533 
nbuck‘
 = 
	`dœ_buck‘s
(
Ëv–
, 
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
);

534 
nblock
 = 
	`buck‘_blocks
(
Ëv–
);

536 
bidx
 = 
	`dœ_block_šdex
(
Ëv–
, 
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
,

537 (
	`Ë32_to_ıu
(
d’Œy_hash
è% 
nbuck‘
));

539 
block
 = 
bidx
; block <ğ(bidx + 
nblock
 - 1); block++) {

540 
d’Œy_·ge
 = 
	`f2fs_g‘_Ãw_d©a_·ge
(
dœ
, 
NULL
, 
block
, 
Œue
);

541 ià(
	`IS_ERR
(
d’Œy_·ge
))

542  
	`PTR_ERR
(
d’Œy_·ge
);

544 
d’Œy_blk
 = 
	`·ge_add»ss
(
d’Œy_·ge
);

545 
b™_pos
 = 
	`f2fs_room_fÜ_f’ame
(&
d’Œy_blk
->
d’Œy_b™m­
,

546 
¦Ùs
, 
NR_DENTRY_IN_BLOCK
);

547 ià(
b™_pos
 < 
NR_DENTRY_IN_BLOCK
)

548 
add_d’Œy
;

550 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

554 ++
Ëv–
;

555 
¡¬t
;

556 
add_d’Œy
:

557 
	`f2fs_wa™_Ú_·ge_wr™eback
(
d’Œy_·ge
, 
DATA
, 
Œue
);

559 ià(
šode
) {

560 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

561 
·ge
 = 
	`f2fs_š™_šode_m‘ad©a
(
šode
, 
dœ
, 
Ãw_Çme
,

562 
Üig_Çme
, 
NULL
);

563 ià(
	`IS_ERR
(
·ge
)) {

564 
”r
 = 
	`PTR_ERR
(
·ge
);

565 
ç
;

569 
	`make_d’Œy_±r_block
(
NULL
, &
d
, 
d’Œy_blk
);

570 
	`f2fs_upd©e_d’Œy
(
šo
, 
mode
, &
d
, 
Ãw_Çme
, 
d’Œy_hash
, 
b™_pos
);

572 
	`£t_·ge_dœty
(
d’Œy_·ge
);

574 ià(
šode
) {

575 
	`f2fs_i_pšo_wr™e
(
šode
, 
dœ
->
i_šo
);

576 
	`f2fs_put_·ge
(
·ge
, 1);

579 
	`f2fs_upd©e_·»Á_m‘ad©a
(
dœ
, 
šode
, 
cu¼’t_d•th
);

580 
ç
:

581 ià(
šode
)

582 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

584 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

586  
”r
;

587 
	}
}

589 
	$f2fs_add_d’Œy
(
šode
 *
dœ
, 
fsüy±_Çme
 *
âame
,

590 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
)

592 
q¡r
 
Ãw_Çme
;

593 
”r
 = -
EAGAIN
;

595 
Ãw_Çme
.
Çme
 = 
	`âame_Çme
(
âame
);

596 
Ãw_Çme
.
Ën
 = 
	`âame_Ën
(
âame
);

598 ià(
	`f2fs_has_šlše_d’Œy
(
dœ
))

599 
”r
 = 
	`f2fs_add_šlše_’Œy
(
dœ
, &
Ãw_Çme
, 
âame
->
u¤_âame
,

600 
šode
, 
šo
, 
mode
);

601 ià(
”r
 =ğ-
EAGAIN
)

602 
”r
 = 
	`f2fs_add_»guÏr_’Œy
(
dœ
, &
Ãw_Çme
, 
âame
->
u¤_âame
,

603 
šode
, 
šo
, 
mode
);

605 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
dœ
), 
REQ_TIME
);

606  
”r
;

607 
	}
}

613 
	$f2fs_do_add_lšk
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Çme
,

614 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
)

616 
fsüy±_Çme
 
âame
;

617 
·ge
 *·gğ
NULL
;

618 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

619 
”r
;

621 
”r
 = 
	`fsüy±_£tup_f’ame
(
dœ
, 
Çme
, 0, &
âame
);

622 ià(
”r
)

623  
”r
;

632 ià(
cu¼’t
 !ğ
	`F2FS_I
(
dœ
)->
sk
) {

633 
de
 = 
	`__f2fs_fšd_’Œy
(
dœ
, &
âame
, &
·ge
);

634 
	`F2FS_I
(
dœ
)->
sk
 = 
NULL
;

636 ià(
de
) {

637 
	`f2fs_put_·ge
(
·ge
, 0);

638 
”r
 = -
EEXIST
;

639 } ià(
	`IS_ERR
(
·ge
)) {

640 
”r
 = 
	`PTR_ERR
(
·ge
);

642 
”r
 = 
	`f2fs_add_d’Œy
(
dœ
, &
âame
, 
šode
, 
šo
, 
mode
);

644 
	`fsüy±_ä“_f’ame
(&
âame
);

645  
”r
;

646 
	}
}

648 
	$f2fs_do_tmpfe
(
šode
 *šode, šod*
dœ
)

650 
·ge
 *page;

651 
”r
 = 0;

653 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

654 
·ge
 = 
	`f2fs_š™_šode_m‘ad©a
(
šode
, 
dœ
, 
NULL
, NULL, NULL);

655 ià(
	`IS_ERR
(
·ge
)) {

656 
”r
 = 
	`PTR_ERR
(
·ge
);

657 
ç
;

659 
	`f2fs_put_·ge
(
·ge
, 1);

661 
	`ş—r_šode_æag
(
šode
, 
FI_NEW_INODE
);

662 
ç
:

663 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

664 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

665  
”r
;

666 
	}
}

668 
	$f2fs_drİ_Æšk
(
šode
 *
dœ
, inode *inode)

670 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

672 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

674 ià(
	`S_ISDIR
(
šode
->
i_mode
))

675 
	`f2fs_i_lšks_wr™e
(
dœ
, 
çl£
);

676 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

678 
	`f2fs_i_lšks_wr™e
(
šode
, 
çl£
);

679 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

680 
	`f2fs_i_lšks_wr™e
(
šode
, 
çl£
);

681 
	`f2fs_i_size_wr™e
(
šode
, 0);

683 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

685 ià(
šode
->
i_Æšk
 == 0)

686 
	`f2fs_add_Üphª_šode
(
šode
);

688 
	`f2fs_»Ëa£_Üphª_šode
(
sbi
);

689 
	}
}

695 
	$f2fs_d–‘e_’Œy
(
f2fs_dœ_’Œy
 *
d’Œy
, 
·ge
 *page,

696 
šode
 *
dœ
, inode *inode)

698 
f2fs_d’Œy_block
 *
d’Œy_blk
;

699 
b™_pos
;

700 
¦Ùs
 = 
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
d’Œy
->
Çme_Ën
));

701 
i
;

703 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
dœ
), 
REQ_TIME
);

705 ià(
	`F2FS_OPTION
(
	`F2FS_I_SB
(
dœ
)).
fsync_mode
 =ğ
FSYNC_MODE_STRICT
)

706 
	`f2fs_add_šo_’Œy
(
	`F2FS_I_SB
(
dœ
), dœ->
i_šo
, 
TRANS_DIR_INO
);

708 ià(
	`f2fs_has_šlše_d’Œy
(
dœ
))

709  
	`f2fs_d–‘e_šlše_’Œy
(
d’Œy
, 
·ge
, 
dœ
, 
šode
);

711 
	`lock_·ge
(
·ge
);

712 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
);

714 
d’Œy_blk
 = 
	`·ge_add»ss
(
·ge
);

715 
b™_pos
 = 
d’Œy
 - 
d’Œy_blk
->dentry;

716 
i
 = 0; i < 
¦Ùs
; i++)

717 
	`__ş—r_b™_Ë
(
b™_pos
 + 
i
, &
d’Œy_blk
->
d’Œy_b™m­
);

720 
b™_pos
 = 
	`fšd_Ãxt_b™_Ë
(&
d’Œy_blk
->
d’Œy_b™m­
,

721 
NR_DENTRY_IN_BLOCK
,

723 
	`£t_·ge_dœty
(
·ge
);

725 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
	`cu¼’t_time
(dir);

726 
	`f2fs_m¬k_šode_dœty_sync
(
dœ
, 
çl£
);

728 ià(
šode
)

729 
	`f2fs_drİ_Æšk
(
dœ
, 
šode
);

731 ià(
b™_pos
 =ğ
NR_DENTRY_IN_BLOCK
 &&

732 !
	`f2fs_Œunÿ‹_hŞe
(
dœ
, 
·ge
->
šdex
,…age->index + 1)) {

733 
	`f2fs_ş—r_¿dix_Œ“_dœty_g
(
·ge
);

734 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

735 
	`CË¬PagePriv©e
(
·ge
);

736 
	`CË¬PageU±od©e
(
·ge
);

737 
	`šode_dec_dœty_·ges
(
dœ
);

738 
	`f2fs_»move_dœty_šode
(
dœ
);

740 
	`f2fs_put_·ge
(
·ge
, 1);

741 
	}
}

743 
boŞ
 
	$f2fs_em±y_dœ
(
šode
 *
dœ
)

745 
bidx
;

746 
·ge
 *
d’Œy_·ge
;

747 
b™_pos
;

748 
f2fs_d’Œy_block
 *
d’Œy_blk
;

749 
nblock
 = 
	`dœ_blocks
(
dœ
);

751 ià(
	`f2fs_has_šlše_d’Œy
(
dœ
))

752  
	`f2fs_em±y_šlše_dœ
(
dœ
);

754 
bidx
 = 0; bidx < 
nblock
; bidx++) {

755 
d’Œy_·ge
 = 
	`f2fs_g‘_lock_d©a_·ge
(
dœ
, 
bidx
, 
çl£
);

756 ià(
	`IS_ERR
(
d’Œy_·ge
)) {

757 ià(
	`PTR_ERR
(
d’Œy_·ge
è=ğ-
ENOENT
)

760  
çl£
;

763 
d’Œy_blk
 = 
	`·ge_add»ss
(
d’Œy_·ge
);

764 ià(
bidx
 == 0)

765 
b™_pos
 = 2;

767 
b™_pos
 = 0;

768 
b™_pos
 = 
	`fšd_Ãxt_b™_Ë
(&
d’Œy_blk
->
d’Œy_b™m­
,

769 
NR_DENTRY_IN_BLOCK
,

770 
b™_pos
);

772 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

774 ià(
b™_pos
 < 
NR_DENTRY_IN_BLOCK
)

775  
çl£
;

777  
Œue
;

778 
	}
}

780 
	$f2fs_fl_d’Œ›s
(
dœ_cÚ‹xt
 *
ùx
, 
f2fs_d’Œy_±r
 *
d
,

781 
¡¬t_pos
, 
fsüy±_¡r
 *
f¡r
)

783 
d_ty³
 = 
DT_UNKNOWN
;

784 
b™_pos
;

785 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

786 
fsüy±_¡r
 
de_Çme
 = 
	`FSTR_INIT
(
NULL
, 0);

787 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
d
->
šode
);

789 
b™_pos
 = (()
ùx
->
pos
 % 
d
->
max
);

791 
b™_pos
 < 
d
->
max
) {

792 
b™_pos
 = 
	`fšd_Ãxt_b™_Ë
(
d
->
b™m­
, d->
max
, bit_pos);

793 ià(
b™_pos
 >ğ
d
->
max
)

796 
de
 = &
d
->
d’Œy
[
b™_pos
];

797 ià(
de
->
Çme_Ën
 == 0) {

798 
b™_pos
++;

799 
ùx
->
pos
 = 
¡¬t_pos
 + 
b™_pos
;

803 
d_ty³
 = 
	`f2fs_g‘_de_ty³
(
de
);

805 
de_Çme
.
Çme
 = 
d
->
f’ame
[
b™_pos
];

806 
de_Çme
.
Ën
 = 
	`Ë16_to_ıu
(
de
->
Çme_Ën
);

808 ià(
	`f2fs_’üy±ed_šode
(
d
->
šode
)) {

809 
§ve_Ën
 = 
f¡r
->
Ën
;

810 
”r
;

812 
”r
 = 
	`fsüy±_âame_disk_to_u¤
(
d
->
šode
,

813 (
u32
)
de
->
hash_code
, 0,

814 &
de_Çme
, 
f¡r
);

815 ià(
”r
)

816  
”r
;

818 
de_Çme
 = *
f¡r
;

819 
f¡r
->
Ën
 = 
§ve_Ën
;

822 ià(!
	`dœ_em™
(
ùx
, 
de_Çme
.
Çme
, de_Çme.
Ën
,

823 
	`Ë32_to_ıu
(
de
->
šo
), 
d_ty³
))

826 ià(
sbi
->
»addœ_¿
 == 1)

827 
	`f2fs_¿_node_·ge
(
sbi
, 
	`Ë32_to_ıu
(
de
->
šo
));

829 
b™_pos
 +ğ
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
de
->
Çme_Ën
));

830 
ùx
->
pos
 = 
¡¬t_pos
 + 
b™_pos
;

833 
	}
}

835 
	$f2fs_»addœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
)

837 
šode
 *šodğ
	`fe_šode
(
fe
);

838 
Åages
 = 
	`dœ_blocks
(
šode
);

839 
f2fs_d’Œy_block
 *
d’Œy_blk
 = 
NULL
;

840 
·ge
 *
d’Œy_·ge
 = 
NULL
;

841 
fe_¿_¡©e
 *
¿
 = &
fe
->
f_¿
;

842 
loff_t
 
¡¬t_pos
 = 
ùx
->
pos
;

843 
n
 = (()
ùx
->
pos
 / 
NR_DENTRY_IN_BLOCK
);

844 
f2fs_d’Œy_±r
 
d
;

845 
fsüy±_¡r
 
f¡r
 = 
	`FSTR_INIT
(
NULL
, 0);

846 
”r
 = 0;

848 ià(
	`f2fs_’üy±ed_šode
(
šode
)) {

849 
”r
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
šode
);

850 ià(
”r
 &&ƒ¼ !ğ-
ENOKEY
)

851 
out
;

853 
”r
 = 
	`fsüy±_âame_®loc_bufãr
(
šode
, 
F2FS_NAME_LEN
, &
f¡r
);

854 ià(
”r
 < 0)

855 
out
;

858 ià(
	`f2fs_has_šlše_d’Œy
(
šode
)) {

859 
”r
 = 
	`f2fs_»ad_šlše_dœ
(
fe
, 
ùx
, &
f¡r
);

860 
out_ä“
;

863 ; 
n
 < 
Åages
;‚++, 
ùx
->
pos
 =‚ * 
NR_DENTRY_IN_BLOCK
) {

866 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

867 
”r
 = -
ERESTARTSYS
;

868 
out_ä“
;

870 
	`cÚd_»sched
();

873 ià(
Åages
 - 
n
 > 1 && !
	`¿_has_šdex
(
¿
,‚))

874 
	`·ge_ÿche_sync_»adah—d
(
šode
->
i_m­pšg
, 
¿
, 
fe
, 
n
,

875 
	`mš
(
Åages
 - 
n
, (
pgoff_t
)
MAX_DIR_RA_PAGES
));

877 
d’Œy_·ge
 = 
	`f2fs_g‘_lock_d©a_·ge
(
šode
, 
n
, 
çl£
);

878 ià(
	`IS_ERR
(
d’Œy_·ge
)) {

879 
”r
 = 
	`PTR_ERR
(
d’Œy_·ge
);

880 ià(
”r
 =ğ-
ENOENT
) {

881 
”r
 = 0;

884 
out_ä“
;

888 
d’Œy_blk
 = 
	`·ge_add»ss
(
d’Œy_·ge
);

890 
	`make_d’Œy_±r_block
(
šode
, &
d
, 
d’Œy_blk
);

892 
”r
 = 
	`f2fs_fl_d’Œ›s
(
ùx
, &
d
,

893 
n
 * 
NR_DENTRY_IN_BLOCK
, &
f¡r
);

894 ià(
”r
) {

895 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

899 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

901 
out_ä“
:

902 
	`fsüy±_âame_ä“_bufãr
(&
f¡r
);

903 
out
:

904 
	`Œaû_f2fs_»addœ
(
šode
, 
¡¬t_pos
, 
ùx
->
pos
, 
”r
);

905  
”r
 < 0 ?ƒrr : 0;

906 
	}
}

908 
	$f2fs_dœ_İ’
(
šode
 *šode, 
fe
 *
fp
)

910 ià(
	`f2fs_’üy±ed_šode
(
šode
))

911  
	`fsüy±_g‘_’üy±iÚ_šfo
(
šode
è? -
EACCES
 : 0;

913 
	}
}

915 cÚ¡ 
fe_İ”©iÚs
 
	gf2fs_dœ_İ”©iÚs
 = {

916 .
Î£ek
 = 
g’”ic_fe_Î£ek
,

917 .
	g»ad
 = 
g’”ic_»ad_dœ
,

918 .
	g™”©e_sh¬ed
 = 
f2fs_»addœ
,

919 .
	gfsync
 = 
f2fs_sync_fe
,

920 .
	gİ’
 = 
f2fs_dœ_İ’
,

921 .
	guÆocked_ioùl
 = 
f2fs_ioùl
,

922 #ifdeà
CONFIG_COMPAT


923 .
	gcom·t_ioùl
 = 
f2fs_com·t_ioùl
,

	@fs/f2fs/extent_cache.c

14 
	~<lšux/fs.h
>

15 
	~<lšux/f2fs_fs.h
>

17 
	~"f2fs.h
"

18 
	~"node.h
"

19 
	~<Œaû/ev’ts/f2fs.h
>

21 
rb_’Œy
 *
	$__lookup_rb_Œ“_ç¡
(
rb_’Œy
 *
ÿched_»
,

22 
ofs
)

24 ià(
ÿched_»
) {

25 ià(
ÿched_»
->
ofs
 <= ofs &&

26 
ÿched_»
->
ofs
 + cached_»->
Ën
 > ofs) {

27  
ÿched_»
;

30  
NULL
;

31 
	}
}

33 
rb_’Œy
 *
	$__lookup_rb_Œ“_¦ow
(
rb_roÙ
 *
roÙ
,

34 
ofs
)

36 
rb_node
 *
node
 = 
roÙ
->rb_node;

37 
rb_’Œy
 *
»
;

39 
node
) {

40 
»
 = 
	`rb_’Œy
(
node
, 
rb_’Œy
, 
rb_node
);

42 ià(
ofs
 < 
»
->ofs)

43 
node
 =‚ode->
rb_Ëá
;

44 ià(
ofs
 >ğ
»
->of +„e->
Ën
)

45 
node
 =‚ode->
rb_right
;

47  
»
;

49  
NULL
;

50 
	}
}

52 
rb_’Œy
 *
	$f2fs_lookup_rb_Œ“
(
rb_roÙ
 *
roÙ
,

53 
rb_’Œy
 *
ÿched_»
, 
ofs
)

55 
rb_’Œy
 *
»
;

57 
»
 = 
	`__lookup_rb_Œ“_ç¡
(
ÿched_»
, 
ofs
);

58 ià(!
»
)

59  
	`__lookup_rb_Œ“_¦ow
(
roÙ
, 
ofs
);

61  
»
;

62 
	}
}

64 
rb_node
 **
	$f2fs_lookup_rb_Œ“_fÜ_š£¹
(
f2fs_sb_šfo
 *
sbi
,

65 
rb_roÙ
 *
roÙ
, 
rb_node
 **
·»Á
,

66 
ofs
)

68 
rb_node
 **
p
 = &
roÙ
->rb_node;

69 
rb_’Œy
 *
»
;

71 *
p
) {

72 *
·»Á
 = *
p
;

73 
»
 = 
	`rb_’Œy
(*
·»Á
, 
rb_’Œy
, 
rb_node
);

75 ià(
ofs
 < 
»
->ofs)

76 
p
 = &(*p)->
rb_Ëá
;

77 ià(
ofs
 >ğ
»
->of +„e->
Ën
)

78 
p
 = &(*p)->
rb_right
;

80 
	`f2fs_bug_Ú
(
sbi
, 1);

83  
p
;

84 
	}
}

95 
rb_’Œy
 *
	$f2fs_lookup_rb_Œ“_»t
(
rb_roÙ
 *
roÙ
,

96 
rb_’Œy
 *
ÿched_»
,

97 
ofs
,

98 
rb_’Œy
 **
´ev_’Œy
,

99 
rb_’Œy
 **
Ãxt_’Œy
,

100 
rb_node
 ***
š£¹_p
,

101 
rb_node
 **
š£¹_·»Á
,

102 
boŞ
 
fÜû
)

104 
rb_node
 **
²ode
 = &
roÙ
->rb_node;

105 
rb_node
 *
·»Á
 = 
NULL
, *
tmp_node
;

106 
rb_’Œy
 *
»
 = 
ÿched_»
;

108 *
š£¹_p
 = 
NULL
;

109 *
š£¹_·»Á
 = 
NULL
;

110 *
´ev_’Œy
 = 
NULL
;

111 *
Ãxt_’Œy
 = 
NULL
;

113 ià(
	`RB_EMPTY_ROOT
(
roÙ
))

114  
NULL
;

116 ià(
»
) {

117 ià(
»
->
ofs
 <ğof &&„e->of +„e->
Ën
 > ofs)

118 
lookup_ÃighbÜs
;

121 *
²ode
) {

122 
·»Á
 = *
²ode
;

123 
»
 = 
	`rb_’Œy
(*
²ode
, 
rb_’Œy
, 
rb_node
);

125 ià(
ofs
 < 
»
->ofs)

126 
²ode
 = &(*²ode)->
rb_Ëá
;

127 ià(
ofs
 >ğ
»
->of +„e->
Ën
)

128 
²ode
 = &(*²ode)->
rb_right
;

130 
lookup_ÃighbÜs
;

133 *
š£¹_p
 = 
²ode
;

134 *
š£¹_·»Á
 = 
·»Á
;

136 
»
 = 
	`rb_’Œy
(
·»Á
, 
rb_’Œy
, 
rb_node
);

137 
tmp_node
 = 
·»Á
;

138 ià(
·»Á
 && 
ofs
 > 
»
->ofs)

139 
tmp_node
 = 
	`rb_Ãxt
(
·»Á
);

140 *
Ãxt_’Œy
 = 
	`rb_’Œy_§ã
(
tmp_node
, 
rb_’Œy
, 
rb_node
);

142 
tmp_node
 = 
·»Á
;

143 ià(
·»Á
 && 
ofs
 < 
»
->ofs)

144 
tmp_node
 = 
	`rb_´ev
(
·»Á
);

145 *
´ev_’Œy
 = 
	`rb_’Œy_§ã
(
tmp_node
, 
rb_’Œy
, 
rb_node
);

146  
NULL
;

148 
lookup_ÃighbÜs
:

149 ià(
ofs
 =ğ
»
->of || 
fÜû
) {

151 
tmp_node
 = 
	`rb_´ev
(&
»
->
rb_node
);

152 *
´ev_’Œy
 = 
	`rb_’Œy_§ã
(
tmp_node
, 
rb_’Œy
, 
rb_node
);

154 ià(
ofs
 =ğ
»
->of +„e->
Ën
 - 1 || 
fÜû
) {

156 
tmp_node
 = 
	`rb_Ãxt
(&
»
->
rb_node
);

157 *
Ãxt_’Œy
 = 
	`rb_’Œy_§ã
(
tmp_node
, 
rb_’Œy
, 
rb_node
);

159  
»
;

160 
	}
}

162 
boŞ
 
	$f2fs_check_rb_Œ“_cÚsi¡’û
(
f2fs_sb_šfo
 *
sbi
,

163 
rb_roÙ
 *
roÙ
)

165 #ifdeà
CONFIG_F2FS_CHECK_FS


166 
rb_node
 *
cur
 = 
	`rb_fœ¡
(
roÙ
), *
Ãxt
;

167 
rb_’Œy
 *
cur_»
, *
Ãxt_»
;

169 ià(!
cur
)

170  
Œue
;

172 
cur
) {

173 
Ãxt
 = 
	`rb_Ãxt
(
cur
);

174 ià(!
Ãxt
)

175  
Œue
;

177 
cur_»
 = 
	`rb_’Œy
(
cur
, 
rb_’Œy
, 
rb_node
);

178 
Ãxt_»
 = 
	`rb_’Œy
(
Ãxt
, 
rb_’Œy
, 
rb_node
);

180 ià(
cur_»
->
ofs
 + cur_»->
Ën
 > 
Ãxt_»
->ofs) {

181 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
, "inconsistent„btree, "

183 
cur_»
->
ofs
, cur_»->
Ën
,

184 
Ãxt_»
->
ofs
,‚ext_»->
Ën
);

185  
çl£
;

188 
cur
 = 
Ãxt
;

191  
Œue
;

192 
	}
}

194 
kmem_ÿche
 *
	gex‹Á_Œ“_¦ab
;

195 
kmem_ÿche
 *
	gex‹Á_node_¦ab
;

197 
ex‹Á_node
 *
	$__©ch_ex‹Á_node
(
f2fs_sb_šfo
 *
sbi
,

198 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_šfo
 *
ei
,

199 
rb_node
 *
·»Á
, rb_nod**
p
)

201 
ex‹Á_node
 *
’
;

203 
’
 = 
	`kmem_ÿche_®loc
(
ex‹Á_node_¦ab
, 
GFP_ATOMIC
);

204 ià(!
’
)

205  
NULL
;

207 
’
->
ei
 = *ei;

208 
	`INIT_LIST_HEAD
(&
’
->
li¡
);

209 
’
->
‘
 =ƒt;

211 
	`rb_lšk_node
(&
’
->
rb_node
, 
·»Á
, 
p
);

212 
	`rb_š£¹_cŞÜ
(&
’
->
rb_node
, &
‘
->
roÙ
);

213 
	`©omic_šc
(&
‘
->
node_út
);

214 
	`©omic_šc
(&
sbi
->
tÙ®_ext_node
);

215  
’
;

216 
	}
}

218 
	$__d‘ach_ex‹Á_node
(
f2fs_sb_šfo
 *
sbi
,

219 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_node
 *
’
)

221 
	`rb_”a£
(&
’
->
rb_node
, &
‘
->
roÙ
);

222 
	`©omic_dec
(&
‘
->
node_út
);

223 
	`©omic_dec
(&
sbi
->
tÙ®_ext_node
);

225 ià(
‘
->
ÿched_’
 =ğ
’
)

226 
‘
->
ÿched_’
 = 
NULL
;

227 
	`kmem_ÿche_ä“
(
ex‹Á_node_¦ab
, 
’
);

228 
	}
}

236 
	$__»Ëa£_ex‹Á_node
(
f2fs_sb_šfo
 *
sbi
,

237 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_node
 *
’
)

239 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

240 
	`f2fs_bug_Ú
(
sbi
, 
	`li¡_em±y
(&
’
->
li¡
));

241 
	`li¡_d–_š™
(&
’
->
li¡
);

242 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

244 
	`__d‘ach_ex‹Á_node
(
sbi
, 
‘
, 
’
);

245 
	}
}

247 
ex‹Á_Œ“
 *
	$__g¿b_ex‹Á_Œ“
(
šode
 *inode)

249 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

250 
ex‹Á_Œ“
 *
‘
;

251 
nid_t
 
šo
 = 
šode
->
i_šo
;

253 
	`mu‹x_lock
(&
sbi
->
ex‹Á_Œ“_lock
);

254 
‘
 = 
	`¿dix_Œ“_lookup
(&
sbi
->
ex‹Á_Œ“_roÙ
, 
šo
);

255 ià(!
‘
) {

256 
‘
 = 
	`f2fs_kmem_ÿche_®loc
(
ex‹Á_Œ“_¦ab
, 
GFP_NOFS
);

257 
	`f2fs_¿dix_Œ“_š£¹
(&
sbi
->
ex‹Á_Œ“_roÙ
, 
šo
, 
‘
);

258 
	`mem£t
(
‘
, 0, (
ex‹Á_Œ“
));

259 
‘
->
šo
 = ino;

260 
‘
->
roÙ
 = 
RB_ROOT
;

261 
‘
->
ÿched_’
 = 
NULL
;

262 
	`rwlock_š™
(&
‘
->
lock
);

263 
	`INIT_LIST_HEAD
(&
‘
->
li¡
);

264 
	`©omic_£t
(&
‘
->
node_út
, 0);

265 
	`©omic_šc
(&
sbi
->
tÙ®_ext_Œ“
);

267 
	`©omic_dec
(&
sbi
->
tÙ®_zomb›_Œ“
);

268 
	`li¡_d–_š™
(&
‘
->
li¡
);

270 
	`mu‹x_uÆock
(&
sbi
->
ex‹Á_Œ“_lock
);

273 
	`F2FS_I
(
šode
)->
ex‹Á_Œ“
 = 
‘
;

275  
‘
;

276 
	}
}

278 
ex‹Á_node
 *
	$__š™_ex‹Á_Œ“
(
f2fs_sb_šfo
 *
sbi
,

279 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_šfo
 *
ei
)

281 
rb_node
 **
p
 = &
‘
->
roÙ
.rb_node;

282 
ex‹Á_node
 *
’
;

284 
’
 = 
	`__©ch_ex‹Á_node
(
sbi
, 
‘
, 
ei
, 
NULL
, 
p
);

285 ià(!
’
)

286  
NULL
;

288 
‘
->
Ïrge¡
 = 
’
->
ei
;

289 
‘
->
ÿched_’
 = 
’
;

290  
’
;

291 
	}
}

293 
	$__ä“_ex‹Á_Œ“
(
f2fs_sb_šfo
 *
sbi
,

294 
ex‹Á_Œ“
 *
‘
)

296 
rb_node
 *
node
, *
Ãxt
;

297 
ex‹Á_node
 *
’
;

298 
couÁ
 = 
	`©omic_»ad
(&
‘
->
node_út
);

300 
node
 = 
	`rb_fœ¡
(&
‘
->
roÙ
);

301 
node
) {

302 
Ãxt
 = 
	`rb_Ãxt
(
node
);

303 
’
 = 
	`rb_’Œy
(
node
, 
ex‹Á_node
, 
rb_node
);

304 
	`__»Ëa£_ex‹Á_node
(
sbi
, 
‘
, 
’
);

305 
node
 = 
Ãxt
;

308  
couÁ
 - 
	`©omic_»ad
(&
‘
->
node_út
);

309 
	}
}

311 
	$__drİ_Ïrge¡_ex‹Á
(
šode
 *inode,

312 
pgoff_t
 
fofs
, 
Ën
)

314 
ex‹Á_šfo
 *
Ïrge¡
 = &
	`F2FS_I
(
šode
)->
ex‹Á_Œ“
->largest;

316 ià(
fofs
 < 
Ïrge¡
->fof +†¬ge¡->
Ën
 && fofs +†en >†argest->fofs) {

317 
Ïrge¡
->
Ën
 = 0;

318 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

320 
	}
}

323 
boŞ
 
	$__f2fs_š™_ex‹Á_Œ“
(
šode
 *šode, 
f2fs_ex‹Á
 *
i_ext
)

325 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

326 
ex‹Á_Œ“
 *
‘
;

327 
ex‹Á_node
 *
’
;

328 
ex‹Á_šfo
 
ei
;

330 ià(!
	`f2fs_may_ex‹Á_Œ“
(
šode
)) {

332 ià(
i_ext
 && i_ext->
Ën
) {

333 
i_ext
->
Ën
 = 0;

334  
Œue
;

336  
çl£
;

339 
‘
 = 
	`__g¿b_ex‹Á_Œ“
(
šode
);

341 ià(!
i_ext
 || !i_ext->
Ën
)

342  
çl£
;

344 
	`g‘_ex‹Á_šfo
(&
ei
, 
i_ext
);

346 
	`wr™e_lock
(&
‘
->
lock
);

347 ià(
	`©omic_»ad
(&
‘
->
node_út
))

348 
out
;

350 
’
 = 
	`__š™_ex‹Á_Œ“
(
sbi
, 
‘
, &
ei
);

351 ià(
’
) {

352 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

353 
	`li¡_add_
(&
’
->
li¡
, &
sbi
->
ex‹Á_li¡
);

354 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

356 
out
:

357 
	`wr™e_uÆock
(&
‘
->
lock
);

358  
çl£
;

359 
	}
}

361 
boŞ
 
	$f2fs_š™_ex‹Á_Œ“
(
šode
 *šode, 
f2fs_ex‹Á
 *
i_ext
)

363 
boŞ
 
»t
 = 
	`__f2fs_š™_ex‹Á_Œ“
(
šode
, 
i_ext
);

365 ià(!
	`F2FS_I
(
šode
)->
ex‹Á_Œ“
)

366 
	`£t_šode_æag
(
šode
, 
FI_NO_EXTENT
);

368  
»t
;

369 
	}
}

371 
boŞ
 
	$f2fs_lookup_ex‹Á_Œ“
(
šode
 *šode, 
pgoff_t
 
pgofs
,

372 
ex‹Á_šfo
 *
ei
)

374 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

375 
ex‹Á_Œ“
 *
‘
 = 
	`F2FS_I
(
šode
)->extent_tree;

376 
ex‹Á_node
 *
’
;

377 
boŞ
 
»t
 = 
çl£
;

379 
	`f2fs_bug_Ú
(
sbi
, !
‘
);

381 
	`Œaû_f2fs_lookup_ex‹Á_Œ“_¡¬t
(
šode
, 
pgofs
);

383 
	`»ad_lock
(&
‘
->
lock
);

385 ià(
‘
->
Ïrge¡
.
fofs
 <ğ
pgofs
 &&

386 
‘
->
Ïrge¡
.
fofs
 +ƒt->Ïrge¡.
Ën
 > 
pgofs
) {

387 *
ei
 = 
‘
->
Ïrge¡
;

388 
»t
 = 
Œue
;

389 
	`¡©_šc_Ïrge¡_node_h™
(
sbi
);

390 
out
;

393 
’
 = (
ex‹Á_node
 *)
	`f2fs_lookup_rb_Œ“
(&
‘
->
roÙ
,

394 (
rb_’Œy
 *)
‘
->
ÿched_’
, 
pgofs
);

395 ià(!
’
)

396 
out
;

398 ià(
’
 =ğ
‘
->
ÿched_’
)

399 
	`¡©_šc_ÿched_node_h™
(
sbi
);

401 
	`¡©_šc_rbŒ“_node_h™
(
sbi
);

403 *
ei
 = 
’
->ei;

404 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

405 ià(!
	`li¡_em±y
(&
’
->
li¡
)) {

406 
	`li¡_move_
(&
’
->
li¡
, &
sbi
->
ex‹Á_li¡
);

407 
‘
->
ÿched_’
 = 
’
;

409 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

410 
»t
 = 
Œue
;

411 
out
:

412 
	`¡©_šc_tÙ®_h™
(
sbi
);

413 
	`»ad_uÆock
(&
‘
->
lock
);

415 
	`Œaû_f2fs_lookup_ex‹Á_Œ“_’d
(
šode
, 
pgofs
, 
ei
);

416  
»t
;

417 
	}
}

419 
ex‹Á_node
 *
	$__Œy_m”ge_ex‹Á_node
(
šode
 *inode,

420 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_šfo
 *
ei
,

421 
ex‹Á_node
 *
´ev_ex
,

422 
ex‹Á_node
 *
Ãxt_ex
)

424 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

425 
ex‹Á_node
 *
’
 = 
NULL
;

427 ià(
´ev_ex
 && 
	`__is_back_m”g—bË
(
ei
, &prev_ex->ei)) {

428 
´ev_ex
->
ei
.
Ën
 +=ƒi->len;

429 
ei
 = &
´ev_ex
->ei;

430 
’
 = 
´ev_ex
;

433 ià(
Ãxt_ex
 && 
	`__is_äÚt_m”g—bË
(
ei
, &next_ex->ei)) {

434 
Ãxt_ex
->
ei
.
fofs
 =ƒi->fofs;

435 
Ãxt_ex
->
ei
.
blk
 =ƒi->blk;

436 
Ãxt_ex
->
ei
.
Ën
 +=ƒi->len;

437 ià(
’
)

438 
	`__»Ëa£_ex‹Á_node
(
sbi
, 
‘
, 
´ev_ex
);

440 
’
 = 
Ãxt_ex
;

443 ià(!
’
)

444  
NULL
;

446 
	`__Œy_upd©e_Ïrge¡_ex‹Á
(
šode
, 
‘
, 
’
);

448 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

449 ià(!
	`li¡_em±y
(&
’
->
li¡
)) {

450 
	`li¡_move_
(&
’
->
li¡
, &
sbi
->
ex‹Á_li¡
);

451 
‘
->
ÿched_’
 = 
’
;

453 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

454  
’
;

455 
	}
}

457 
ex‹Á_node
 *
	$__š£¹_ex‹Á_Œ“
(
šode
 *inode,

458 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_šfo
 *
ei
,

459 
rb_node
 **
š£¹_p
,

460 
rb_node
 *
š£¹_·»Á
)

462 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

463 
rb_node
 **
p
;

464 
rb_node
 *
·»Á
 = 
NULL
;

465 
ex‹Á_node
 *
’
 = 
NULL
;

467 ià(
š£¹_p
 && 
š£¹_·»Á
) {

468 
·»Á
 = 
š£¹_·»Á
;

469 
p
 = 
š£¹_p
;

470 
do_š£¹
;

473 
p
 = 
	`f2fs_lookup_rb_Œ“_fÜ_š£¹
(
sbi
, &
‘
->
roÙ
, &
·»Á
, 
ei
->
fofs
);

474 
do_š£¹
:

475 
’
 = 
	`__©ch_ex‹Á_node
(
sbi
, 
‘
, 
ei
, 
·»Á
, 
p
);

476 ià(!
’
)

477  
NULL
;

479 
	`__Œy_upd©e_Ïrge¡_ex‹Á
(
šode
, 
‘
, 
’
);

482 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

483 
	`li¡_add_
(&
’
->
li¡
, &
sbi
->
ex‹Á_li¡
);

484 
‘
->
ÿched_’
 = 
’
;

485 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

486  
’
;

487 
	}
}

489 
	$f2fs_upd©e_ex‹Á_Œ“_¿nge
(
šode
 *inode,

490 
pgoff_t
 
fofs
, 
block_t
 
blkaddr
, 
Ën
)

492 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

493 
ex‹Á_Œ“
 *
‘
 = 
	`F2FS_I
(
šode
)->extent_tree;

494 
ex‹Á_node
 *
’
 = 
NULL
, *
’1
 = NULL;

495 
ex‹Á_node
 *
´ev_’
 = 
NULL
, *
Ãxt_’
 = NULL;

496 
ex‹Á_šfo
 
ei
, 
dei
, 
´ev
;

497 
rb_node
 **
š£¹_p
 = 
NULL
, *
š£¹_·»Á
 = NULL;

498 
’d
 = 
fofs
 + 
Ën
;

499 
pos
 = ()
fofs
;

501 ià(!
‘
)

504 
	`Œaû_f2fs_upd©e_ex‹Á_Œ“_¿nge
(
šode
, 
fofs
, 
blkaddr
, 
Ën
);

506 
	`wr™e_lock
(&
‘
->
lock
);

508 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NO_EXTENT
)) {

509 
	`wr™e_uÆock
(&
‘
->
lock
);

513 
´ev
 = 
‘
->
Ïrge¡
;

514 
dei
.
Ën
 = 0;

520 
	`__drİ_Ïrge¡_ex‹Á
(
šode
, 
fofs
, 
Ën
);

523 
’
 = (
ex‹Á_node
 *)
	`f2fs_lookup_rb_Œ“_»t
(&
‘
->
roÙ
,

524 (
rb_’Œy
 *)
‘
->
ÿched_’
, 
fofs
,

525 (
rb_’Œy
 **)&
´ev_’
,

526 (
rb_’Œy
 **)&
Ãxt_’
,

527 &
š£¹_p
, &
š£¹_·»Á
, 
çl£
);

528 ià(!
’
)

529 
’
 = 
Ãxt_’
;

532 
’
 &&ƒn->
ei
.
fofs
 < 
’d
) {

533 
Üg_’d
;

534 
·¹s
 = 0;

536 
Ãxt_’
 = 
’1
 = 
NULL
;

538 
dei
 = 
’
->
ei
;

539 
Üg_’d
 = 
dei
.
fofs
 + dei.
Ën
;

540 
	`f2fs_bug_Ú
(
sbi
, 
pos
 >ğ
Üg_’d
);

542 ià(
pos
 > 
dei
.
fofs
 &&…o - dei.fof >ğ
F2FS_MIN_EXTENT_LEN
) {

543 
’
->
ei
.
Ën
 = 
pos
 -ƒn->ei.
fofs
;

544 
´ev_’
 = 
’
;

545 
·¹s
 = 1;

548 ià(
’d
 < 
Üg_’d
 && org_’d -ƒnd >ğ
F2FS_MIN_EXTENT_LEN
) {

549 ià(
·¹s
) {

550 
	`£t_ex‹Á_šfo
(&
ei
, 
’d
,

551 
’d
 - 
dei
.
fofs
 + dei.
blk
,

552 
Üg_’d
 - 
’d
);

553 
’1
 = 
	`__š£¹_ex‹Á_Œ“
(
šode
, 
‘
, &
ei
,

554 
NULL
, NULL);

555 
Ãxt_’
 = 
’1
;

557 
’
->
ei
.
fofs
 = 
’d
;

558 
’
->
ei
.
blk
 +ğ
’d
 - 
dei
.
fofs
;

559 
’
->
ei
.
Ën
 -ğ
’d
 - 
dei
.
fofs
;

560 
Ãxt_’
 = 
’
;

562 
·¹s
++;

565 ià(!
Ãxt_’
) {

566 
rb_node
 *
node
 = 
	`rb_Ãxt
(&
’
->rb_node);

568 
Ãxt_’
 = 
	`rb_’Œy_§ã
(
node
, 
ex‹Á_node
,

569 
rb_node
);

572 ià(
·¹s
)

573 
	`__Œy_upd©e_Ïrge¡_ex‹Á
(
šode
, 
‘
, 
’
);

575 
	`__»Ëa£_ex‹Á_node
(
sbi
, 
‘
, 
’
);

582 ià(
·¹s
 != 1) {

583 
š£¹_p
 = 
NULL
;

584 
š£¹_·»Á
 = 
NULL
;

586 
’
 = 
Ãxt_’
;

590 ià(
blkaddr
) {

592 
	`£t_ex‹Á_šfo
(&
ei
, 
fofs
, 
blkaddr
, 
Ën
);

593 ià(!
	`__Œy_m”ge_ex‹Á_node
(
šode
, 
‘
, &
ei
, 
´ev_’
, 
Ãxt_’
))

594 
	`__š£¹_ex‹Á_Œ“
(
šode
, 
‘
, &
ei
,

595 
š£¹_p
, 
š£¹_·»Á
);

598 ià(
dei
.
Ën
 >= 1 &&

599 
´ev
.
Ën
 < 
F2FS_MIN_EXTENT_LEN
 &&

600 
‘
->
Ïrge¡
.
Ën
 < 
F2FS_MIN_EXTENT_LEN
) {

601 
	`__drİ_Ïrge¡_ex‹Á
(
šode
, 0, 
UINT_MAX
);

602 
	`£t_šode_æag
(
šode
, 
FI_NO_EXTENT
);

606 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NO_EXTENT
))

607 
	`__ä“_ex‹Á_Œ“
(
sbi
, 
‘
);

609 
	`wr™e_uÆock
(&
‘
->
lock
);

610 
	}
}

612 
	$f2fs_shršk_ex‹Á_Œ“
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
)

614 
ex‹Á_Œ“
 *
‘
, *
Ãxt
;

615 
ex‹Á_node
 *
’
;

616 
node_út
 = 0, 
Œ“_út
 = 0;

617 
»mašed
;

619 ià(!
	`‹¡_İt
(
sbi
, 
EXTENT_CACHE
))

622 ià(!
	`©omic_»ad
(&
sbi
->
tÙ®_zomb›_Œ“
))

623 
ä“_node
;

625 ià(!
	`mu‹x_Œylock
(&
sbi
->
ex‹Á_Œ“_lock
))

626 
out
;

629 
	`li¡_fÜ_—ch_’Œy_§ã
(
‘
, 
Ãxt
, &
sbi
->
zomb›_li¡
, 
li¡
) {

630 ià(
	`©omic_»ad
(&
‘
->
node_út
)) {

631 
	`wr™e_lock
(&
‘
->
lock
);

632 
node_út
 +ğ
	`__ä“_ex‹Á_Œ“
(
sbi
, 
‘
);

633 
	`wr™e_uÆock
(&
‘
->
lock
);

635 
	`f2fs_bug_Ú
(
sbi
, 
	`©omic_»ad
(&
‘
->
node_út
));

636 
	`li¡_d–_š™
(&
‘
->
li¡
);

637 
	`¿dix_Œ“_d–‘e
(&
sbi
->
ex‹Á_Œ“_roÙ
, 
‘
->
šo
);

638 
	`kmem_ÿche_ä“
(
ex‹Á_Œ“_¦ab
, 
‘
);

639 
	`©omic_dec
(&
sbi
->
tÙ®_ext_Œ“
);

640 
	`©omic_dec
(&
sbi
->
tÙ®_zomb›_Œ“
);

641 
Œ“_út
++;

643 ià(
node_út
 + 
Œ“_út
 >ğ
Ä_shršk
)

644 
uÆock_out
;

645 
	`cÚd_»sched
();

647 
	`mu‹x_uÆock
(&
sbi
->
ex‹Á_Œ“_lock
);

649 
ä“_node
:

651 ià(!
	`mu‹x_Œylock
(&
sbi
->
ex‹Á_Œ“_lock
))

652 
out
;

654 
»mašed
 = 
Ä_shršk
 - (
node_út
 + 
Œ“_út
);

656 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

657 ; 
»mašed
 > 0;„emained--) {

658 ià(
	`li¡_em±y
(&
sbi
->
ex‹Á_li¡
))

660 
’
 = 
	`li¡_fœ¡_’Œy
(&
sbi
->
ex‹Á_li¡
,

661 
ex‹Á_node
, 
li¡
);

662 
‘
 = 
’
->et;

663 ià(!
	`wr™e_Œylock
(&
‘
->
lock
)) {

665 
	`li¡_move_
(&
’
->
li¡
, &
sbi
->
ex‹Á_li¡
);

669 
	`li¡_d–_š™
(&
’
->
li¡
);

670 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

672 
	`__d‘ach_ex‹Á_node
(
sbi
, 
‘
, 
’
);

674 
	`wr™e_uÆock
(&
‘
->
lock
);

675 
node_út
++;

676 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

678 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

680 
uÆock_out
:

681 
	`mu‹x_uÆock
(&
sbi
->
ex‹Á_Œ“_lock
);

682 
out
:

683 
	`Œaû_f2fs_shršk_ex‹Á_Œ“
(
sbi
, 
node_út
, 
Œ“_út
);

685  
node_út
 + 
Œ“_út
;

686 
	}
}

688 
	$f2fs_de¡roy_ex‹Á_node
(
šode
 *inode)

690 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

691 
ex‹Á_Œ“
 *
‘
 = 
	`F2FS_I
(
šode
)->extent_tree;

692 
node_út
 = 0;

694 ià(!
‘
 || !
	`©omic_»ad
(&‘->
node_út
))

697 
	`wr™e_lock
(&
‘
->
lock
);

698 
node_út
 = 
	`__ä“_ex‹Á_Œ“
(
sbi
, 
‘
);

699 
	`wr™e_uÆock
(&
‘
->
lock
);

701  
node_út
;

702 
	}
}

704 
	$f2fs_drİ_ex‹Á_Œ“
(
šode
 *inode)

706 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

707 
ex‹Á_Œ“
 *
‘
 = 
	`F2FS_I
(
šode
)->extent_tree;

709 ià(!
	`f2fs_may_ex‹Á_Œ“
(
šode
))

712 
	`£t_šode_æag
(
šode
, 
FI_NO_EXTENT
);

714 
	`wr™e_lock
(&
‘
->
lock
);

715 
	`__ä“_ex‹Á_Œ“
(
sbi
, 
‘
);

716 
	`__drİ_Ïrge¡_ex‹Á
(
šode
, 0, 
UINT_MAX
);

717 
	`wr™e_uÆock
(&
‘
->
lock
);

718 
	}
}

720 
	$f2fs_de¡roy_ex‹Á_Œ“
(
šode
 *inode)

722 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

723 
ex‹Á_Œ“
 *
‘
 = 
	`F2FS_I
(
šode
)->extent_tree;

724 
node_út
 = 0;

726 ià(!
‘
)

729 ià(
šode
->
i_Æšk
 && !
	`is_bad_šode
(inode) &&

730 
	`©omic_»ad
(&
‘
->
node_út
)) {

731 
	`mu‹x_lock
(&
sbi
->
ex‹Á_Œ“_lock
);

732 
	`li¡_add_
(&
‘
->
li¡
, &
sbi
->
zomb›_li¡
);

733 
	`©omic_šc
(&
sbi
->
tÙ®_zomb›_Œ“
);

734 
	`mu‹x_uÆock
(&
sbi
->
ex‹Á_Œ“_lock
);

739 
node_út
 = 
	`f2fs_de¡roy_ex‹Á_node
(
šode
);

742 
	`mu‹x_lock
(&
sbi
->
ex‹Á_Œ“_lock
);

743 
	`f2fs_bug_Ú
(
sbi
, 
	`©omic_»ad
(&
‘
->
node_út
));

744 
	`¿dix_Œ“_d–‘e
(&
sbi
->
ex‹Á_Œ“_roÙ
, 
šode
->
i_šo
);

745 
	`kmem_ÿche_ä“
(
ex‹Á_Œ“_¦ab
, 
‘
);

746 
	`©omic_dec
(&
sbi
->
tÙ®_ext_Œ“
);

747 
	`mu‹x_uÆock
(&
sbi
->
ex‹Á_Œ“_lock
);

749 
	`F2FS_I
(
šode
)->
ex‹Á_Œ“
 = 
NULL
;

751 
	`Œaû_f2fs_de¡roy_ex‹Á_Œ“
(
šode
, 
node_út
);

752 
	}
}

754 
boŞ
 
	$f2fs_lookup_ex‹Á_ÿche
(
šode
 *šode, 
pgoff_t
 
pgofs
,

755 
ex‹Á_šfo
 *
ei
)

757 ià(!
	`f2fs_may_ex‹Á_Œ“
(
šode
))

758  
çl£
;

760  
	`f2fs_lookup_ex‹Á_Œ“
(
šode
, 
pgofs
, 
ei
);

761 
	}
}

763 
	$f2fs_upd©e_ex‹Á_ÿche
(
dnode_of_d©a
 *
dn
)

765 
pgoff_t
 
fofs
;

766 
block_t
 
blkaddr
;

768 ià(!
	`f2fs_may_ex‹Á_Œ“
(
dn
->
šode
))

771 ià(
dn
->
d©a_blkaddr
 =ğ
NEW_ADDR
)

772 
blkaddr
 = 
NULL_ADDR
;

774 
blkaddr
 = 
dn
->
d©a_blkaddr
;

776 
fofs
 = 
	`f2fs_¡¬t_bidx_of_node
(
	`ofs_of_node
(
dn
->
node_·ge
), dn->
šode
) +

777 
dn
->
ofs_š_node
;

778 
	`f2fs_upd©e_ex‹Á_Œ“_¿nge
(
dn
->
šode
, 
fofs
, 
blkaddr
, 1);

779 
	}
}

781 
	$f2fs_upd©e_ex‹Á_ÿche_¿nge
(
dnode_of_d©a
 *
dn
,

782 
pgoff_t
 
fofs
, 
block_t
 
blkaddr
, 
Ën
)

785 ià(!
	`f2fs_may_ex‹Á_Œ“
(
dn
->
šode
))

788 
	`f2fs_upd©e_ex‹Á_Œ“_¿nge
(
dn
->
šode
, 
fofs
, 
blkaddr
, 
Ën
);

789 
	}
}

791 
	$f2fs_š™_ex‹Á_ÿche_šfo
(
f2fs_sb_šfo
 *
sbi
)

793 
	`INIT_RADIX_TREE
(&
sbi
->
ex‹Á_Œ“_roÙ
, 
GFP_NOIO
);

794 
	`mu‹x_š™
(&
sbi
->
ex‹Á_Œ“_lock
);

795 
	`INIT_LIST_HEAD
(&
sbi
->
ex‹Á_li¡
);

796 
	`¥š_lock_š™
(&
sbi
->
ex‹Á_lock
);

797 
	`©omic_£t
(&
sbi
->
tÙ®_ext_Œ“
, 0);

798 
	`INIT_LIST_HEAD
(&
sbi
->
zomb›_li¡
);

799 
	`©omic_£t
(&
sbi
->
tÙ®_zomb›_Œ“
, 0);

800 
	`©omic_£t
(&
sbi
->
tÙ®_ext_node
, 0);

801 
	}
}

803 
__š™
 
	$f2fs_ü—‹_ex‹Á_ÿche
()

805 
ex‹Á_Œ“_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_extent_tree",

806 (
ex‹Á_Œ“
));

807 ià(!
ex‹Á_Œ“_¦ab
)

808  -
ENOMEM
;

809 
ex‹Á_node_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_extent_node",

810 (
ex‹Á_node
));

811 ià(!
ex‹Á_node_¦ab
) {

812 
	`kmem_ÿche_de¡roy
(
ex‹Á_Œ“_¦ab
);

813  -
ENOMEM
;

816 
	}
}

818 
	$f2fs_de¡roy_ex‹Á_ÿche
()

820 
	`kmem_ÿche_de¡roy
(
ex‹Á_node_¦ab
);

821 
	`kmem_ÿche_de¡roy
(
ex‹Á_Œ“_¦ab
);

822 
	}
}

	@fs/f2fs/f2fs.h

11 #iâdeà
_LINUX_F2FS_H


12 
	#_LINUX_F2FS_H


	)

14 
	~<lšux/ty³s.h
>

15 
	~<lšux/·ge-æags.h
>

16 
	~<lšux/bufãr_h—d.h
>

17 
	~<lšux/¦ab.h
>

18 
	~<lšux/üc32.h
>

19 
	~<lšux/magic.h
>

20 
	~<lšux/kobjeù.h
>

21 
	~<lšux/sched.h
>

22 
	~<lšux/üed.h
>

23 
	~<lšux/vm®loc.h
>

24 
	~<lšux/bio.h
>

25 
	~<lšux/blkdev.h
>

26 
	~<lšux/quÙaİs.h
>

27 
	~<üy±o/hash.h
>

29 
	#__FS_HAS_ENCRYPTION
 
	`IS_ENABLED
(
CONFIG_F2FS_FS_ENCRYPTION
)

	)

30 
	~<lšux/fsüy±.h
>

32 #ifdeà
CONFIG_F2FS_CHECK_FS


33 
	#f2fs_bug_Ú
(
sbi
, 
cÚd™iÚ
è
	`BUG_ON
(cÚd™iÚ)

	)

35 
	#f2fs_bug_Ú
(
sbi
, 
cÚd™iÚ
) \

37 ià(
	`uÆik–y
(
cÚd™iÚ
)) { \

38 
	`WARN_ON
(1); \

39 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
); \

41 } 0)

	)

44 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


46 
	mFAULT_KMALLOC
,

47 
	mFAULT_KVMALLOC
,

48 
	mFAULT_PAGE_ALLOC
,

49 
	mFAULT_PAGE_GET
,

50 
	mFAULT_ALLOC_BIO
,

51 
	mFAULT_ALLOC_NID
,

52 
	mFAULT_ORPHAN
,

53 
	mFAULT_BLOCK
,

54 
	mFAULT_DIR_DEPTH
,

55 
	mFAULT_EVICT_INODE
,

56 
	mFAULT_TRUNCATE
,

57 
	mFAULT_IO
,

58 
	mFAULT_CHECKPOINT
,

59 
	mFAULT_MAX
,

62 
	sf2fs_çuÉ_šfo
 {

63 
©omic_t
 
	mšjeù_İs
;

64 
	mšjeù_¿‹
;

65 
	mšjeù_ty³
;

68 *
çuÉ_Çme
[
FAULT_MAX
];

69 
	#IS_FAULT_SET
(
fi
, 
ty³
è((fi)->
šjeù_ty³
 & (1 << (ty³)))

	)

75 
	#F2FS_MOUNT_BG_GC
 0x00000001

	)

76 
	#F2FS_MOUNT_DISABLE_ROLL_FORWARD
 0x00000002

	)

77 
	#F2FS_MOUNT_DISCARD
 0x00000004

	)

78 
	#F2FS_MOUNT_NOHEAP
 0x00000008

	)

79 
	#F2FS_MOUNT_XATTR_USER
 0x00000010

	)

80 
	#F2FS_MOUNT_POSIX_ACL
 0x00000020

	)

81 
	#F2FS_MOUNT_DISABLE_EXT_IDENTIFY
 0x00000040

	)

82 
	#F2FS_MOUNT_INLINE_XATTR
 0x00000080

	)

83 
	#F2FS_MOUNT_INLINE_DATA
 0x00000100

	)

84 
	#F2FS_MOUNT_INLINE_DENTRY
 0x00000200

	)

85 
	#F2FS_MOUNT_FLUSH_MERGE
 0x00000400

	)

86 
	#F2FS_MOUNT_NOBARRIER
 0x00000800

	)

87 
	#F2FS_MOUNT_FASTBOOT
 0x00001000

	)

88 
	#F2FS_MOUNT_EXTENT_CACHE
 0x00002000

	)

89 
	#F2FS_MOUNT_FORCE_FG_GC
 0x00004000

	)

90 
	#F2FS_MOUNT_DATA_FLUSH
 0x00008000

	)

91 
	#F2FS_MOUNT_FAULT_INJECTION
 0x00010000

	)

92 
	#F2FS_MOUNT_ADAPTIVE
 0x00020000

	)

93 
	#F2FS_MOUNT_LFS
 0x00040000

	)

94 
	#F2FS_MOUNT_USRQUOTA
 0x00080000

	)

95 
	#F2FS_MOUNT_GRPQUOTA
 0x00100000

	)

96 
	#F2FS_MOUNT_PRJQUOTA
 0x00200000

	)

97 
	#F2FS_MOUNT_QUOTA
 0x00400000

	)

98 
	#F2FS_MOUNT_INLINE_XATTR_SIZE
 0x00800000

	)

99 
	#F2FS_MOUNT_RESERVE_ROOT
 0x01000000

	)

101 
	#F2FS_OPTION
(
sbi
è((sbi)->
mouÁ_İt
)

	)

102 
	#ş—r_İt
(
sbi
, 
İtiÚ
è(
	`F2FS_OPTION
(sbi).
İt
 &ğ~
F2FS_MOUNT_
##İtiÚ)

	)

103 
	#£t_İt
(
sbi
, 
İtiÚ
è(
	`F2FS_OPTION
(sbi).
İt
 |ğ
F2FS_MOUNT_
##İtiÚ)

	)

104 
	#‹¡_İt
(
sbi
, 
İtiÚ
è(
	`F2FS_OPTION
(sbi).
İt
 & 
F2FS_MOUNT_
##İtiÚ)

	)

106 
	#v”_aá”
(
a
, 
b
è(
	`ty³check
(,‡) && \

107 
	`ty³check
(, 
b
) && \

108 (()((
a
è- (
b
)è> 0))

	)

110 
u32
 
	tblock_t
;

114 
u32
 
	tnid_t
;

116 
	sf2fs_mouÁ_šfo
 {

117 
	mİt
;

118 
	mwr™e_io_size_b™s
;

119 
block_t
 
	mroÙ_»£rved_blocks
;

120 
kuid_t
 
	ms_»suid
;

121 
kgid_t
 
	ms_»sgid
;

122 
	maùive_logs
;

123 
	mšlše_x©Œ_size
;

124 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


125 
f2fs_çuÉ_šfo
 
	mçuÉ_šfo
;

127 #ifdeà
CONFIG_QUOTA


129 *
	ms_qf_Çmes
[
MAXQUOTAS
];

130 
	ms_jquÙa_fmt
;

133 
	mwhšt_mode
;

134 
	m®loc_mode
;

135 
	mfsync_mode
;

136 
boŞ
 
	m‹¡_dummy_’üy±iÚ
;

139 
	#F2FS_FEATURE_ENCRYPT
 0x0001

	)

140 
	#F2FS_FEATURE_BLKZONED
 0x0002

	)

141 
	#F2FS_FEATURE_ATOMIC_WRITE
 0x0004

	)

142 
	#F2FS_FEATURE_EXTRA_ATTR
 0x0008

	)

143 
	#F2FS_FEATURE_PRJQUOTA
 0x0010

	)

144 
	#F2FS_FEATURE_INODE_CHKSUM
 0x0020

	)

145 
	#F2FS_FEATURE_FLEXIBLE_INLINE_XATTR
 0x0040

	)

146 
	#F2FS_FEATURE_QUOTA_INO
 0x0080

	)

147 
	#F2FS_FEATURE_INODE_CRTIME
 0x0100

	)

148 
	#F2FS_FEATURE_LOST_FOUND
 0x0200

	)

149 
	#F2FS_FEATURE_VERITY
 0x0400

	)

151 
	#F2FS_HAS_FEATURE
(
sb
, 
mask
) \

152 ((
	`F2FS_SB
(
sb
)->
¿w_su³r
->
ã©u»
 & 
	`ıu_to_Ë32
(
mask
)è!ğ0)

	)

153 
	#F2FS_SET_FEATURE
(
sb
, 
mask
) \

154 (
	`F2FS_SB
(
sb
)->
¿w_su³r
->
ã©u»
 |ğ
	`ıu_to_Ë32
(
mask
))

	)

155 
	#F2FS_CLEAR_FEATURE
(
sb
, 
mask
) \

156 (
	`F2FS_SB
(
sb
)->
¿w_su³r
->
ã©u»
 &ğ~
	`ıu_to_Ë32
(
mask
))

	)

161 
	#F2FS_DEF_RESUID
 0

	)

162 
	#F2FS_DEF_RESGID
 0

	)

168 
	mNAT_BITMAP
,

169 
	mSIT_BITMAP


172 
	#CP_UMOUNT
 0x00000001

	)

173 
	#CP_FASTBOOT
 0x00000002

	)

174 
	#CP_SYNC
 0x00000004

	)

175 
	#CP_RECOVERY
 0x00000008

	)

176 
	#CP_DISCARD
 0x00000010

	)

177 
	#CP_TRIMMED
 0x00000020

	)

179 
	#MAX_DISCARD_BLOCKS
(
sbi
è
	`BLKS_PER_SEC
(sbi)

	)

180 
	#DEF_MAX_DISCARD_REQUEST
 8

	)

181 
	#DEF_MAX_DISCARD_LEN
 512

	)

182 
	#DEF_MIN_DISCARD_ISSUE_TIME
 50

	)

183 
	#DEF_MID_DISCARD_ISSUE_TIME
 500

	)

184 
	#DEF_MAX_DISCARD_ISSUE_TIME
 60000

	)

185 
	#DEF_DISCARD_URGENT_UTIL
 80

	)

186 
	#DEF_CP_INTERVAL
 60

	)

187 
	#DEF_IDLE_INTERVAL
 5

	)

189 
	sı_cÚŒŞ
 {

190 
	m»asÚ
;

191 
__u64
 
	mŒim_¡¬t
;

192 
__u64
 
	mŒim_’d
;

193 
__u64
 
	mŒim_mšËn
;

200 
	mMETA_CP
,

201 
	mMETA_NAT
,

202 
	mMETA_SIT
,

203 
	mMETA_SSA
,

204 
	mMETA_POR
,

209 
	mORPHAN_INO
,

210 
	mAPPEND_INO
,

211 
	mUPDATE_INO
,

212 
	mTRANS_DIR_INO
,

213 
	mFLUSH_INO
,

214 
	mMAX_INO_ENTRY
,

217 
	sšo_’Œy
 {

218 
li¡_h—d
 
	mli¡
;

219 
nid_t
 
	mšo
;

220 
	mdœty_deviû
;

224 
	sšode_’Œy
 {

225 
li¡_h—d
 
	mli¡
;

226 
šode
 *
	mšode
;

230 
	sdisÿrd_’Œy
 {

231 
li¡_h—d
 
	mli¡
;

232 
block_t
 
	m¡¬t_blkaddr
;

233 
	mdisÿrd_m­
[
SIT_VBLOCK_MAP_SIZE
];

237 
	#DEFAULT_DISCARD_GRANULARITY
 16

	)

240 
	#MAX_PLIST_NUM
 512

	)

241 
	#¶i¡_idx
(
blk_num
è((blk_numè>ğ
MAX_PLIST_NUM
 ? \

242 (
MAX_PLIST_NUM
 - 1è: (
blk_num
 - 1))

	)

245 
	mD_PREP
,

246 
	mD_SUBMIT
,

247 
	mD_DONE
,

250 
	sdisÿrd_šfo
 {

251 
block_t
 
	ml¡¬t
;

252 
block_t
 
	mËn
;

253 
block_t
 
	m¡¬t
;

256 
	sdisÿrd_cmd
 {

257 
rb_node
 
	mrb_node
;

260 
block_t
 
	ml¡¬t
;

261 
block_t
 
	mËn
;

262 
block_t
 
	m¡¬t
;

264 
disÿrd_šfo
 
	mdi
;

267 
li¡_h—d
 
	mli¡
;

268 
com¶‘iÚ
 
	mwa™
;

269 
block_deviû
 *
	mbdev
;

270 
	m»f
;

271 
	m¡©e
;

272 
	m”rÜ
;

276 
	mDPOLICY_BG
,

277 
	mDPOLICY_FORCE
,

278 
	mDPOLICY_FSTRIM
,

279 
	mDPOLICY_UMOUNT
,

280 
	mMAX_DPOLICY
,

283 
	sdisÿrd_pŞicy
 {

284 
	mty³
;

285 
	mmš_š‹rv®
;

286 
	mmid_š‹rv®
;

287 
	mmax_š‹rv®
;

288 
	mmax_»que¡s
;

289 
	mio_aw¬e_g¿n
;

290 
boŞ
 
	mio_aw¬e
;

291 
boŞ
 
	msync
;

292 
	mg¿nuÏr™y
;

295 
	sdisÿrd_cmd_cÚŒŞ
 {

296 
sk_¡ruù
 *
	mf2fs_issue_disÿrd
;

297 
li¡_h—d
 
	m’Œy_li¡
;

298 
li¡_h—d
 
	m³nd_li¡
[
MAX_PLIST_NUM
];

299 
li¡_h—d
 
	mwa™_li¡
;

300 
li¡_h—d
 
	mf¡rim_li¡
;

301 
wa™_queue_h—d_t
 
	mdisÿrd_wa™_queue
;

302 
	mdisÿrd_wake
;

303 
mu‹x
 
	mcmd_lock
;

304 
	mÄ_disÿrds
;

305 
	mmax_disÿrds
;

306 
	mdisÿrd_g¿nuÏr™y
;

307 
	mundisÿrd_blks
;

308 
©omic_t
 
	missued_disÿrd
;

309 
©omic_t
 
	missšg_disÿrd
;

310 
©omic_t
 
	mdisÿrd_cmd_út
;

311 
rb_roÙ
 
	mroÙ
;

315 
	sfsync_šode_’Œy
 {

316 
li¡_h—d
 
	mli¡
;

317 
šode
 *
	mšode
;

318 
block_t
 
	mblkaddr
;

319 
block_t
 
	mÏ¡_d’Œy
;

322 
	#Çts_š_cursum
(
jÆ
è(
	`Ë16_to_ıu
((jÆ)->
n_Çts
))

	)

323 
	#s™s_š_cursum
(
jÆ
è(
	`Ë16_to_ıu
((jÆ)->
n_s™s
))

	)

325 
	#Çt_š_jouº®
(
jÆ
, 
i
è((jÆ)->
Çt_j
.
’Œ›s
[i].
Ã
)

	)

326 
	#nid_š_jouº®
(
jÆ
, 
i
è((jÆ)->
Çt_j
.
’Œ›s
[i].
nid
)

	)

327 
	#s™_š_jouº®
(
jÆ
, 
i
è((jÆ)->
s™_j
.
’Œ›s
[i].
£
)

	)

328 
	#£gno_š_jouº®
(
jÆ
, 
i
è((jÆ)->
s™_j
.
’Œ›s
[i].
£gno
)

	)

330 
	#MAX_NAT_JENTRIES
(
jÆ
è(
NAT_JOURNAL_ENTRIES
 - 
	`Çts_š_cursum
(jÆ))

	)

331 
	#MAX_SIT_JENTRIES
(
jÆ
è(
SIT_JOURNAL_ENTRIES
 - 
	`s™s_š_cursum
(jÆ))

	)

333 
šlše
 
	$upd©e_Çts_š_cursum
(
f2fs_jouº®
 *
jouº®
, 
i
)

335 
befÜe
 = 
	`Çts_š_cursum
(
jouº®
);

337 
jouº®
->
n_Çts
 = 
	`ıu_to_Ë16
(
befÜe
 + 
i
);

338  
befÜe
;

339 
	}
}

341 
šlše
 
	$upd©e_s™s_š_cursum
(
f2fs_jouº®
 *
jouº®
, 
i
)

343 
befÜe
 = 
	`s™s_š_cursum
(
jouº®
);

345 
jouº®
->
n_s™s
 = 
	`ıu_to_Ë16
(
befÜe
 + 
i
);

346  
befÜe
;

347 
	}
}

349 
šlše
 
boŞ
 
	$__has_cursum_¥aû
(
f2fs_jouº®
 *
jouº®
,

350 
size
, 
ty³
)

352 ià(
ty³
 =ğ
NAT_JOURNAL
)

353  
size
 <ğ
	`MAX_NAT_JENTRIES
(
jouº®
);

354  
size
 <ğ
	`MAX_SIT_JENTRIES
(
jouº®
);

355 
	}
}

360 
	#F2FS_IOC_GETFLAGS
 
FS_IOC_GETFLAGS


	)

361 
	#F2FS_IOC_SETFLAGS
 
FS_IOC_SETFLAGS


	)

362 
	#F2FS_IOC_GETVERSION
 
FS_IOC_GETVERSION


	)

364 
	#F2FS_IOCTL_MAGIC
 0xf5

	)

365 
	#F2FS_IOC_START_ATOMIC_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 1)

	)

366 
	#F2FS_IOC_COMMIT_ATOMIC_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 2)

	)

367 
	#F2FS_IOC_START_VOLATILE_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 3)

	)

368 
	#F2FS_IOC_RELEASE_VOLATILE_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 4)

	)

369 
	#F2FS_IOC_ABORT_VOLATILE_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 5)

	)

370 
	#F2FS_IOC_GARBAGE_COLLECT
 
	`_IOW
(
F2FS_IOCTL_MAGIC
, 6, 
__u32
)

	)

371 
	#F2FS_IOC_WRITE_CHECKPOINT
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 7)

	)

372 
	#F2FS_IOC_DEFRAGMENT
 
	`_IOWR
(
F2FS_IOCTL_MAGIC
, 8, \

373 
f2fs_deäagm’t
)

	)

374 
	#F2FS_IOC_MOVE_RANGE
 
	`_IOWR
(
F2FS_IOCTL_MAGIC
, 9, \

375 
f2fs_move_¿nge
)

	)

376 
	#F2FS_IOC_FLUSH_DEVICE
 
	`_IOW
(
F2FS_IOCTL_MAGIC
, 10, \

377 
f2fs_æush_deviû
)

	)

378 
	#F2FS_IOC_GARBAGE_COLLECT_RANGE
 
	`_IOW
(
F2FS_IOCTL_MAGIC
, 11, \

379 
f2fs_gc_¿nge
)

	)

380 
	#F2FS_IOC_GET_FEATURES
 
	`_IOR
(
F2FS_IOCTL_MAGIC
, 12, 
__u32
)

	)

381 
	#F2FS_IOC_SET_PIN_FILE
 
	`_IOW
(
F2FS_IOCTL_MAGIC
, 13, 
__u32
)

	)

382 
	#F2FS_IOC_GET_PIN_FILE
 
	`_IOR
(
F2FS_IOCTL_MAGIC
, 14, 
__u32
)

	)

383 
	#F2FS_IOC_PRECACHE_EXTENTS
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 15)

	)

385 
	#F2FS_IOC_SET_ENCRYPTION_POLICY
 
FS_IOC_SET_ENCRYPTION_POLICY


	)

386 
	#F2FS_IOC_GET_ENCRYPTION_POLICY
 
FS_IOC_GET_ENCRYPTION_POLICY


	)

387 
	#F2FS_IOC_GET_ENCRYPTION_PWSALT
 
FS_IOC_GET_ENCRYPTION_PWSALT


	)

393 
	#F2FS_IOC_SHUTDOWN
 
	`_IOR
('X', 125, 
__u32
è

	)

394 
	#F2FS_GOING_DOWN_FULLSYNC
 0x0

	)

395 
	#F2FS_GOING_DOWN_METASYNC
 0x1

	)

396 
	#F2FS_GOING_DOWN_NOSYNC
 0x2

	)

397 
	#F2FS_GOING_DOWN_METAFLUSH
 0x3

	)

399 #ià
defšed
(
__KERNEL__
è&& defšed(
CONFIG_COMPAT
)

403 
	#F2FS_IOC32_GETFLAGS
 
FS_IOC32_GETFLAGS


	)

404 
	#F2FS_IOC32_SETFLAGS
 
FS_IOC32_SETFLAGS


	)

405 
	#F2FS_IOC32_GETVERSION
 
FS_IOC32_GETVERSION


	)

408 
	#F2FS_IOC_FSGETXATTR
 
FS_IOC_FSGETXATTR


	)

409 
	#F2FS_IOC_FSSETXATTR
 
FS_IOC_FSSETXATTR


	)

411 
	sf2fs_gc_¿nge
 {

412 
u32
 
	msync
;

413 
u64
 
	m¡¬t
;

414 
u64
 
	mËn
;

417 
	sf2fs_deäagm’t
 {

418 
u64
 
	m¡¬t
;

419 
u64
 
	mËn
;

422 
	sf2fs_move_¿nge
 {

423 
u32
 
	md¡_fd
;

424 
u64
 
	mpos_š
;

425 
u64
 
	mpos_out
;

426 
u64
 
	mËn
;

429 
	sf2fs_æush_deviû
 {

430 
u32
 
	mdev_num
;

431 
u32
 
	m£gm’ts
;

435 
	#DEF_INLINE_RESERVED_SIZE
 1

	)

436 
	#DEF_MIN_INLINE_SIZE
 1

	)

437 
šlše
 
g‘_exŒa_isize
(
šode
 *inode);

438 
šlše
 
g‘_šlše_x©Œ_addrs
(
šode
 *inode);

439 
	#MAX_INLINE_DATA
(
šode
è((
__Ë32
) * \

440 (
	`CUR_ADDRS_PER_INODE
(
šode
) - \

441 
	`g‘_šlše_x©Œ_addrs
(
šode
) - \

442 
DEF_INLINE_RESERVED_SIZE
))

	)

445 
	#NR_INLINE_DENTRY
(
šode
è(
	`MAX_INLINE_DATA
(šodeè* 
BITS_PER_BYTE
 / \

446 ((
SIZE_OF_DIR_ENTRY
 + 
F2FS_SLOT_LEN
) * \

447 
BITS_PER_BYTE
 + 1))

	)

448 
	#INLINE_DENTRY_BITMAP_SIZE
(
šode
è((
	`NR_INLINE_DENTRY
(inode) + \

449 
BITS_PER_BYTE
 - 1è/ BITS_PER_BYTE)

	)

450 
	#INLINE_RESERVED_SIZE
(
šode
è(
	`MAX_INLINE_DATA
(inode) - \

451 ((
SIZE_OF_DIR_ENTRY
 + 
F2FS_SLOT_LEN
) * \

452 
	`NR_INLINE_DENTRY
(
šode
) + \

453 
	`INLINE_DENTRY_BITMAP_SIZE
(
šode
)))

	)

459 
	sf2fs_d’Œy_±r
 {

460 
šode
 *
	mšode
;

461 *
	mb™m­
;

462 
f2fs_dœ_’Œy
 *
	md’Œy
;

463 
__u8
 (*
f’ame
)[
F2FS_SLOT_LEN
];

464 
	mmax
;

465 
	mÄ_b™m­
;

468 
šlše
 
	$make_d’Œy_±r_block
(
šode
 *inode,

469 
f2fs_d’Œy_±r
 *
d
, 
f2fs_d’Œy_block
 *
t
)

471 
d
->
šode
 = inode;

472 
d
->
max
 = 
NR_DENTRY_IN_BLOCK
;

473 
d
->
Ä_b™m­
 = 
SIZE_OF_DENTRY_BITMAP
;

474 
d
->
b™m­
 = 
t
->
d’Œy_b™m­
;

475 
d
->
d’Œy
 = 
t
->dentry;

476 
d
->
f’ame
 = 
t
->filename;

477 
	}
}

479 
šlše
 
	$make_d’Œy_±r_šlše
(
šode
 *inode,

480 
f2fs_d’Œy_±r
 *
d
, *
t
)

482 
’Œy_út
 = 
	`NR_INLINE_DENTRY
(
šode
);

483 
b™m­_size
 = 
	`INLINE_DENTRY_BITMAP_SIZE
(
šode
);

484 
»£rved_size
 = 
	`INLINE_RESERVED_SIZE
(
šode
);

486 
d
->
šode
 = inode;

487 
d
->
max
 = 
’Œy_út
;

488 
d
->
Ä_b™m­
 = 
b™m­_size
;

489 
d
->
b™m­
 = 
t
;

490 
d
->
d’Œy
 = 
t
 + 
b™m­_size
 + 
»£rved_size
;

491 
d
->
f’ame
 = 
t
 + 
b™m­_size
 + 
»£rved_size
 +

492 
SIZE_OF_DIR_ENTRY
 * 
’Œy_út
;

493 
	}
}

500 
	#XATTR_NODE_OFFSET
 (((()-1è<< 
OFFSET_BIT_SHIFT
) \

501 >> 
OFFSET_BIT_SHIFT
)

	)

503 
	mALLOC_NODE
,

504 
	mLOOKUP_NODE
,

505 
	mLOOKUP_NODE_RA
,

511 
	#F2FS_LINK_MAX
 0xfffffffà

	)

513 
	#MAX_DIR_RA_PAGES
 4

	)

516 
	#EXT_TREE_VEC_SIZE
 64

	)

519 
	#F2FS_MIN_EXTENT_LEN
 64

	)

522 
	#EXTENT_CACHE_SHRINK_NUMBER
 128

	)

524 
	srb_’Œy
 {

525 
rb_node
 
	mrb_node
;

526 
	mofs
;

527 
	mËn
;

530 
	sex‹Á_šfo
 {

531 
	mfofs
;

532 
	mËn
;

533 
u32
 
	mblk
;

536 
	sex‹Á_node
 {

537 
rb_node
 
	mrb_node
;

540 
	mfofs
;

541 
	mËn
;

542 
u32
 
	mblk
;

544 
ex‹Á_šfo
 
	mei
;

547 
li¡_h—d
 
	mli¡
;

548 
ex‹Á_Œ“
 *
	m‘
;

551 
	sex‹Á_Œ“
 {

552 
nid_t
 
	mšo
;

553 
rb_roÙ
 
	mroÙ
;

554 
ex‹Á_node
 *
	mÿched_’
;

555 
ex‹Á_šfo
 
	mÏrge¡
;

556 
li¡_h—d
 
	mli¡
;

557 
rwlock_t
 
	mlock
;

558 
©omic_t
 
	mnode_út
;

566 
	#F2FS_MAP_NEW
 (1 << 
BH_New
)

	)

567 
	#F2FS_MAP_MAPPED
 (1 << 
BH_M­³d
)

	)

568 
	#F2FS_MAP_UNWRITTEN
 (1 << 
BH_Unwr™‹n
)

	)

569 
	#F2FS_MAP_FLAGS
 (
F2FS_MAP_NEW
 | 
F2FS_MAP_MAPPED
 |\

570 
F2FS_MAP_UNWRITTEN
)

	)

572 
	sf2fs_m­_blocks
 {

573 
block_t
 
	mm_pblk
;

574 
block_t
 
	mm_lblk
;

575 
	mm_Ën
;

576 
	mm_æags
;

577 
pgoff_t
 *
	mm_Ãxt_pgofs
;

578 
pgoff_t
 *
	mm_Ãxt_ex‹Á
;

579 
	mm_£g_ty³
;

584 
	mF2FS_GET_BLOCK_DEFAULT
,

585 
	mF2FS_GET_BLOCK_FIEMAP
,

586 
	mF2FS_GET_BLOCK_BMAP
,

587 
	mF2FS_GET_BLOCK_PRE_DIO
,

588 
	mF2FS_GET_BLOCK_PRE_AIO
,

589 
	mF2FS_GET_BLOCK_PRECACHE
,

595 
	#FADVISE_COLD_BIT
 0x01

	)

596 
	#FADVISE_LOST_PINO_BIT
 0x02

	)

597 
	#FADVISE_ENCRYPT_BIT
 0x04

	)

598 
	#FADVISE_ENC_NAME_BIT
 0x08

	)

599 
	#FADVISE_KEEP_SIZE_BIT
 0x10

	)

600 
	#FADVISE_HOT_BIT
 0x20

	)

601 
	#FADVISE_VERITY_BIT
 0x40

	)

603 
	#fe_is_cŞd
(
šode
è
	`is_fe
(šode, 
FADVISE_COLD_BIT
)

	)

604 
	#fe_wrÚg_pšo
(
šode
è
	`is_fe
(šode, 
FADVISE_LOST_PINO_BIT
)

	)

605 
	#fe_£t_cŞd
(
šode
è
	`£t_fe
(šode, 
FADVISE_COLD_BIT
)

	)

606 
	#fe_lo¡_pšo
(
šode
è
	`£t_fe
(šode, 
FADVISE_LOST_PINO_BIT
)

	)

607 
	#fe_ş—r_cŞd
(
šode
è
	`ş—r_fe
(šode, 
FADVISE_COLD_BIT
)

	)

608 
	#fe_gÙ_pšo
(
šode
è
	`ş—r_fe
(šode, 
FADVISE_LOST_PINO_BIT
)

	)

609 
	#fe_is_’üy±
(
šode
è
	`is_fe
(šode, 
FADVISE_ENCRYPT_BIT
)

	)

610 
	#fe_£t_’üy±
(
šode
è
	`£t_fe
(šode, 
FADVISE_ENCRYPT_BIT
)

	)

611 
	#fe_ş—r_’üy±
(
šode
è
	`ş—r_fe
(šode, 
FADVISE_ENCRYPT_BIT
)

	)

612 
	#fe_’c_Çme
(
šode
è
	`is_fe
(šode, 
FADVISE_ENC_NAME_BIT
)

	)

613 
	#fe_£t_’c_Çme
(
šode
è
	`£t_fe
(šode, 
FADVISE_ENC_NAME_BIT
)

	)

614 
	#fe_k“p_isize
(
šode
è
	`is_fe
(šode, 
FADVISE_KEEP_SIZE_BIT
)

	)

615 
	#fe_£t_k“p_isize
(
šode
è
	`£t_fe
(šode, 
FADVISE_KEEP_SIZE_BIT
)

	)

616 
	#fe_is_hÙ
(
šode
è
	`is_fe
(šode, 
FADVISE_HOT_BIT
)

	)

617 
	#fe_£t_hÙ
(
šode
è
	`£t_fe
(šode, 
FADVISE_HOT_BIT
)

	)

618 
	#fe_ş—r_hÙ
(
šode
è
	`ş—r_fe
(šode, 
FADVISE_HOT_BIT
)

	)

620 
	#DEF_DIR_LEVEL
 0

	)

623 
	mGC_FAILURE_PIN
,

624 
	mGC_FAILURE_ATOMIC
,

625 
	mMAX_GC_FAILURE


628 
	sf2fs_šode_šfo
 {

629 
šode
 
	mvfs_šode
;

630 
	mi_æags
;

631 
	mi_advi£
;

632 
	mi_dœ_Ëv–
;

633 
	mi_cu¼’t_d•th
;

635 
	mi_gc_çu»s
[
MAX_GC_FAILURE
];

636 
	mi_pšo
;

637 
umode_t
 
	mi_aş_mode
;

640 
	mæags
;

641 
rw_£m­hÜe
 
	mi_£m
;

642 
©omic_t
 
	mdœty_·ges
;

643 
f2fs_hash_t
 
	mchash
;

644 
	mşev–
;

645 
sk_¡ruù
 *
	msk
;

646 
sk_¡ruù
 *
	mı_sk
;

647 
nid_t
 
	mi_x©Œ_nid
;

648 
loff_t
 
	mÏ¡_disk_size
;

650 #ifdeà
CONFIG_QUOTA


651 
dquÙ
 *
	mi_dquÙ
[
MAXQUOTAS
];

654 
qsize_t
 
	mi_»£rved_quÙa
;

656 
li¡_h—d
 
	mdœty_li¡
;

657 
li¡_h—d
 
	mgdœty_li¡
;

658 
li¡_h—d
 
	mšmem_i¡
;

659 
li¡_h—d
 
	mšmem_·ges
;

660 
sk_¡ruù
 *
	mšmem_sk
;

661 
mu‹x
 
	mšmem_lock
;

662 
ex‹Á_Œ“
 *
	mex‹Á_Œ“
;

665 
rw_£m­hÜe
 
	mi_gc_rw£m
[2];

666 
rw_£m­hÜe
 
	mi_mm­_£m
;

667 
rw_£m­hÜe
 
	mi_x©Œ_£m
;

669 
	mi_exŒa_isize
;

670 
k´ojid_t
 
	mi_´ojid
;

671 
	mi_šlše_x©Œ_size
;

672 
time¥ec
 
	mi_ütime
;

673 
time¥ec
 
	mi_disk_time
[4];

676 
šlše
 
	$g‘_ex‹Á_šfo
(
ex‹Á_šfo
 *
ext
,

677 
f2fs_ex‹Á
 *
i_ext
)

679 
ext
->
fofs
 = 
	`Ë32_to_ıu
(
i_ext
->fofs);

680 
ext
->
blk
 = 
	`Ë32_to_ıu
(
i_ext
->blk);

681 
ext
->
Ën
 = 
	`Ë32_to_ıu
(
i_ext
->len);

682 
	}
}

684 
šlše
 
	$£t_¿w_ex‹Á
(
ex‹Á_šfo
 *
ext
,

685 
f2fs_ex‹Á
 *
i_ext
)

687 
i_ext
->
fofs
 = 
	`ıu_to_Ë32
(
ext
->fofs);

688 
i_ext
->
blk
 = 
	`ıu_to_Ë32
(
ext
->blk);

689 
i_ext
->
Ën
 = 
	`ıu_to_Ë32
(
ext
->len);

690 
	}
}

692 
šlše
 
	$£t_ex‹Á_šfo
(
ex‹Á_šfo
 *
ei
, 
fofs
,

693 
u32
 
blk
, 
Ën
)

695 
ei
->
fofs
 = fofs;

696 
ei
->
blk
 = blk;

697 
ei
->
Ën
 =†en;

698 
	}
}

700 
šlše
 
boŞ
 
	$__is_disÿrd_m”g—bË
(
disÿrd_šfo
 *
back
,

701 
disÿrd_šfo
 *
äÚt
)

703  (
back
->
l¡¬t
 + back->
Ën
 =ğ
äÚt
->lstart) &&

704 (
back
->
Ën
 + 
äÚt
->ËÀ< 
DEF_MAX_DISCARD_LEN
);

705 
	}
}

707 
šlše
 
boŞ
 
	$__is_disÿrd_back_m”g—bË
(
disÿrd_šfo
 *
cur
,

708 
disÿrd_šfo
 *
back
)

710  
	`__is_disÿrd_m”g—bË
(
back
, 
cur
);

711 
	}
}

713 
šlše
 
boŞ
 
	$__is_disÿrd_äÚt_m”g—bË
(
disÿrd_šfo
 *
cur
,

714 
disÿrd_šfo
 *
äÚt
)

716  
	`__is_disÿrd_m”g—bË
(
cur
, 
äÚt
);

717 
	}
}

719 
šlše
 
boŞ
 
	$__is_ex‹Á_m”g—bË
(
ex‹Á_šfo
 *
back
,

720 
ex‹Á_šfo
 *
äÚt
)

722  (
back
->
fofs
 + back->
Ën
 =ğ
äÚt
->fofs &&

723 
back
->
blk
 + back->
Ën
 =ğ
äÚt
->blk);

724 
	}
}

726 
šlše
 
boŞ
 
	$__is_back_m”g—bË
(
ex‹Á_šfo
 *
cur
,

727 
ex‹Á_šfo
 *
back
)

729  
	`__is_ex‹Á_m”g—bË
(
back
, 
cur
);

730 
	}
}

732 
šlše
 
boŞ
 
	$__is_äÚt_m”g—bË
(
ex‹Á_šfo
 *
cur
,

733 
ex‹Á_šfo
 *
äÚt
)

735  
	`__is_ex‹Á_m”g—bË
(
cur
, 
äÚt
);

736 
	}
}

738 
f2fs_m¬k_šode_dœty_sync
(
šode
 *šode, 
boŞ
 
sync
);

739 
šlše
 
	$__Œy_upd©e_Ïrge¡_ex‹Á
(
šode
 *inode,

740 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_node
 *
’
)

742 ià(
’
->
ei
.
Ën
 > 
‘
->
Ïrge¡
.len) {

743 
‘
->
Ïrge¡
 = 
’
->
ei
;

744 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

746 
	}
}

751 
	enid_¡©e
 {

752 
	mFREE_NID
,

753 
	mPREALLOC_NID
,

754 
	mMAX_NID_STATE
,

757 
	sf2fs_nm_šfo
 {

758 
block_t
 
	mÇt_blkaddr
;

759 
nid_t
 
	mmax_nid
;

760 
nid_t
 
	mavaabË_nids
;

761 
nid_t
 
	mÃxt_sÿn_nid
;

762 
	m¿m_th»sh
;

763 
	m¿_nid_·ges
;

764 
	mdœty_Çts_¿tio
;

767 
¿dix_Œ“_roÙ
 
	mÇt_roÙ
;

768 
¿dix_Œ“_roÙ
 
	mÇt_£t_roÙ
;

769 
rw_£m­hÜe
 
	mÇt_Œ“_lock
;

770 
li¡_h—d
 
	mÇt_’Œ›s
;

771 
	mÇt_út
;

772 
	mdœty_Çt_út
;

773 
	mÇt_blocks
;

776 
¿dix_Œ“_roÙ
 
	mä“_nid_roÙ
;

777 
li¡_h—d
 
	mä“_nid_li¡
;

778 
	mnid_út
[
MAX_NID_STATE
];

779 
¥šlock_t
 
	mnid_li¡_lock
;

780 
mu‹x
 
	mbud_lock
;

781 **
	mä“_nid_b™m­
;

782 *
	mÇt_block_b™m­
;

783 *
	mä“_nid_couÁ
;

786 *
	mÇt_b™m­
;

788 
	mÇt_b™s_blocks
;

789 *
	mÇt_b™s
;

790 *
	mfuÎ_Çt_b™s
;

791 *
	mem±y_Çt_b™s
;

792 #ifdeà
CONFIG_F2FS_CHECK_FS


793 *
	mÇt_b™m­_mœ
;

795 
	mb™m­_size
;

803 
	sdnode_of_d©a
 {

804 
šode
 *
	mšode
;

805 
·ge
 *
	mšode_·ge
;

806 
·ge
 *
	mnode_·ge
;

807 
nid_t
 
	mnid
;

808 
	mofs_š_node
;

809 
boŞ
 
	mšode_·ge_locked
;

810 
boŞ
 
	mnode_chªged
;

811 
	mcur_Ëv–
;

812 
	mmax_Ëv–
;

813 
block_t
 
	md©a_blkaddr
;

816 
šlše
 
	$£t_Ãw_dnode
(
dnode_of_d©a
 *
dn
, 
šode
 *inode,

817 
·ge
 *
age
, ·g*
Åage
, 
nid_t
 
nid
)

819 
	`mem£t
(
dn
, 0, (*dn));

820 
dn
->
šode
 = inode;

821 
dn
->
šode_·ge
 = 
age
;

822 
dn
->
node_·ge
 = 
Åage
;

823 
dn
->
nid
 =‚id;

824 
	}
}

839 
	#NR_CURSEG_DATA_TYPE
 (3)

	)

840 
	#NR_CURSEG_NODE_TYPE
 (3)

	)

841 
	#NR_CURSEG_TYPE
 (
NR_CURSEG_DATA_TYPE
 + 
NR_CURSEG_NODE_TYPE
)

	)

844 
	mCURSEG_HOT_DATA
 = 0,

845 
	mCURSEG_WARM_DATA
,

846 
	mCURSEG_COLD_DATA
,

847 
	mCURSEG_HOT_NODE
,

848 
	mCURSEG_WARM_NODE
,

849 
	mCURSEG_COLD_NODE
,

850 
	mNO_CHECK_TYPE
,

853 
	sæush_cmd
 {

854 
com¶‘iÚ
 
	mwa™
;

855 
Îi¡_node
 
	mÎnode
;

856 
nid_t
 
	mšo
;

857 
	m»t
;

860 
	sæush_cmd_cÚŒŞ
 {

861 
sk_¡ruù
 *
	mf2fs_issue_æush
;

862 
wa™_queue_h—d_t
 
	mæush_wa™_queue
;

863 
©omic_t
 
	missued_æush
;

864 
©omic_t
 
	missšg_æush
;

865 
Îi¡_h—d
 
	missue_li¡
;

866 
Îi¡_node
 *
	mdi¥©ch_li¡
;

869 
	sf2fs_sm_šfo
 {

870 
s™_šfo
 *
	ms™_šfo
;

871 
ä“_£gm­_šfo
 *
	mä“_šfo
;

872 
dœty_£gli¡_šfo
 *
	mdœty_šfo
;

873 
cur£g_šfo
 *
	mcur£g_¬¿y
;

875 
rw_£m­hÜe
 
	mcur£g_lock
;

877 
block_t
 
	m£g0_blkaddr
;

878 
block_t
 
	mmaš_blkaddr
;

879 
block_t
 
	ms§_blkaddr
;

881 
	m£gm’t_couÁ
;

882 
	mmaš_£gm’ts
;

883 
	m»£rved_£gm’ts
;

884 
	movp_£gm’ts
;

887 
	m»c_´eä“_£gm’ts
;

890 
	mŒim_£ùiÚs
;

892 
li¡_h—d
 
	ms™_’Œy_£t
;

894 
	mu_pŞicy
;

895 
	mmš_u_ut
;

896 
	mmš_fsync_blocks
;

897 
	mmš_hÙ_blocks
;

898 
	mmš_s¤_£ùiÚs
;

901 
æush_cmd_cÚŒŞ
 *
	mfcc_šfo
;

904 
disÿrd_cmd_cÚŒŞ
 *
	mdcc_šfo
;

916 
	#WB_DATA_TYPE
(
p
è(
	`__is_ı_gu¬ª‹ed
Õè? 
F2FS_WB_CP_DATA
 : 
F2FS_WB_DATA
)

	)

917 
	ecouÁ_ty³
 {

918 
	mF2FS_DIRTY_DENTS
,

919 
	mF2FS_DIRTY_DATA
,

920 
	mF2FS_DIRTY_QDATA
,

921 
	mF2FS_DIRTY_NODES
,

922 
	mF2FS_DIRTY_META
,

923 
	mF2FS_INMEM_PAGES
,

924 
	mF2FS_DIRTY_IMETA
,

925 
	mF2FS_WB_CP_DATA
,

926 
	mF2FS_WB_DATA
,

927 
	mNR_COUNT_TYPE
,

941 
	#PAGE_TYPE_OF_BIO
(
ty³
è(Ñy³è> 
META
 ? META : (ty³))

	)

942 
	e·ge_ty³
 {

943 
	mDATA
,

944 
	mNODE
,

945 
	mMETA
,

946 
	mNR_PAGE_TYPE
,

947 
	mMETA_FLUSH
,

948 
	mINMEM
,

949 
	mINMEM_DROP
,

950 
	mINMEM_INVALIDATE
,

951 
	mINMEM_REVOKE
,

952 
	mIPU
,

953 
	mOPU
,

956 
	e‹mp_ty³
 {

957 
	mHOT
 = 0,

958 
	mWARM
,

959 
	mCOLD
,

960 
	mNR_TEMP_TYPE
,

963 
	eÃed_lock_ty³
 {

964 
	mLOCK_REQ
 = 0,

965 
	mLOCK_DONE
,

966 
	mLOCK_RETRY
,

969 
	eı_»asÚ_ty³
 {

970 
	mCP_NO_NEEDED
,

971 
	mCP_NON_REGULAR
,

972 
	mCP_HARDLINK
,

973 
	mCP_SB_NEED_CP
,

974 
	mCP_WRONG_PINO
,

975 
	mCP_NO_SPC_ROLL
,

976 
	mCP_NODE_NEED_CP
,

977 
	mCP_FASTBOOT_MODE
,

978 
	mCP_SPEC_LOG_NUM
,

979 
	mCP_RECOVER_DIR
,

982 
	eio¡©_ty³
 {

983 
	mAPP_DIRECT_IO
,

984 
	mAPP_BUFFERED_IO
,

985 
	mAPP_WRITE_IO
,

986 
	mAPP_MAPPED_IO
,

987 
	mFS_DATA_IO
,

988 
	mFS_NODE_IO
,

989 
	mFS_META_IO
,

990 
	mFS_GC_DATA_IO
,

991 
	mFS_GC_NODE_IO
,

992 
	mFS_CP_DATA_IO
,

993 
	mFS_CP_NODE_IO
,

994 
	mFS_CP_META_IO
,

995 
	mFS_DISCARD
,

996 
	mNR_IO_TYPE
,

999 
	sf2fs_io_šfo
 {

1000 
f2fs_sb_šfo
 *
	msbi
;

1001 
nid_t
 
	mšo
;

1002 
·ge_ty³
 
	mty³
;

1003 
‹mp_ty³
 
	m‹mp
;

1004 
	mİ
;

1005 
	mİ_æags
;

1006 
block_t
 
	mÃw_blkaddr
;

1007 
block_t
 
	mŞd_blkaddr
;

1008 
·ge
 *
	m·ge
;

1009 
·ge
 *
	m’üy±ed_·ge
;

1010 
li¡_h—d
 
	mli¡
;

1011 
boŞ
 
	msubm™‹d
;

1012 
	mÃed_lock
;

1013 
boŞ
 
	mš_li¡
;

1014 
boŞ
 
	mis_m‘a
;

1015 
boŞ
 
	m»Œy
;

1016 
io¡©_ty³
 
	mio_ty³
;

1017 
wr™eback_cÚŒŞ
 *
	mio_wbc
;

1020 
	#is_»ad_io
(
rw
è(Ôwè=ğ
READ
)

	)

1021 
	sf2fs_bio_šfo
 {

1022 
f2fs_sb_šfo
 *
	msbi
;

1023 
bio
 *
	mbio
;

1024 
£ùÜ_t
 
	mÏ¡_block_š_bio
;

1025 
f2fs_io_šfo
 
	mfio
;

1026 
rw_£m­hÜe
 
	mio_rw£m
;

1027 
¥šlock_t
 
	mio_lock
;

1028 
li¡_h—d
 
	mio_li¡
;

1031 
	#FDEV
(
i
è(
sbi
->
devs
[i])

	)

1032 
	#RDEV
(
i
è(
¿w_su³r
->
devs
[i])

	)

1033 
	sf2fs_dev_šfo
 {

1034 
block_deviû
 *
	mbdev
;

1035 
	m·th
[
MAX_PATH_LEN
];

1036 
	mtÙ®_£gm’ts
;

1037 
block_t
 
	m¡¬t_blk
;

1038 
block_t
 
	m’d_blk
;

1039 #ifdeà
CONFIG_BLK_DEV_ZONED


1040 
	mÄ_blkz
;

1041 
u8
 *
	mblkz_ty³
;

1045 
	ešode_ty³
 {

1046 
	mDIR_INODE
,

1047 
	mFILE_INODE
,

1048 
	mDIRTY_META
,

1049 
	mATOMIC_FILE
,

1050 
	mNR_INODE_TYPE
,

1054 
	sšode_mªagem’t
 {

1055 
¿dix_Œ“_roÙ
 
	mšo_roÙ
;

1056 
¥šlock_t
 
	mšo_lock
;

1057 
li¡_h—d
 
	mšo_li¡
;

1058 
	mšo_num
;

1063 
	mSBI_IS_DIRTY
,

1064 
	mSBI_IS_CLOSE
,

1065 
	mSBI_NEED_FSCK
,

1066 
	mSBI_POR_DOING
,

1067 
	mSBI_NEED_SB_WRITE
,

1068 
	mSBI_NEED_CP
,

1072 
	mCP_TIME
,

1073 
	mREQ_TIME
,

1074 
	mMAX_TIME
,

1078 
	mGC_NORMAL
,

1079 
	mGC_IDLE_CB
,

1080 
	mGC_IDLE_GREEDY
,

1081 
	mGC_URGENT
,

1085 
	mWHINT_MODE_OFF
,

1086 
	mWHINT_MODE_USER
,

1087 
	mWHINT_MODE_FS
,

1091 
	mALLOC_MODE_DEFAULT
,

1092 
	mALLOC_MODE_REUSE
,

1095 
	efsync_mode
 {

1096 
	mFSYNC_MODE_POSIX
,

1097 
	mFSYNC_MODE_STRICT
,

1098 
	mFSYNC_MODE_NOBARRIER
,

1101 #ifdeà
CONFIG_F2FS_FS_ENCRYPTION


1102 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
) \

1103 (
	`uÆik–y
(
	`F2FS_OPTION
(
sbi
).
‹¡_dummy_’üy±iÚ
))

	)

1105 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
è(0)

	)

1108 
	sf2fs_sb_šfo
 {

1109 
su³r_block
 *
	msb
;

1110 
´oc_dœ_’Œy
 *
	ms_´oc
;

1111 
f2fs_su³r_block
 *
	m¿w_su³r
;

1112 
rw_£m­hÜe
 
	msb_lock
;

1113 
	mv®id_su³r_block
;

1114 
	ms_æag
;

1116 #ifdeà
CONFIG_BLK_DEV_ZONED


1117 
	mblocks_³r_blkz
;

1118 
	mlog_blocks_³r_blkz
;

1122 
f2fs_nm_šfo
 *
	mnm_šfo
;

1123 
šode
 *
	mnode_šode
;

1126 
f2fs_sm_šfo
 *
	msm_šfo
;

1129 
f2fs_bio_šfo
 *
	mwr™e_io
[
NR_PAGE_TYPE
];

1130 
mu‹x
 
	mwio_mu‹x
[
NR_PAGE_TYPE
 - 1][
NR_TEMP_TYPE
];

1133 
rw_£m­hÜe
 
	mio_Üd”_lock
;

1134 
mempoŞ_t
 *
	mwr™e_io_dummy
;

1137 
f2fs_checkpošt
 *
	mck±
;

1138 
	mcur_ı_·ck
;

1139 
¥šlock_t
 
	mı_lock
;

1140 
šode
 *
	mm‘a_šode
;

1141 
mu‹x
 
	mı_mu‹x
;

1142 
rw_£m­hÜe
 
	mı_rw£m
;

1143 
rw_£m­hÜe
 
	mnode_wr™e
;

1144 
rw_£m­hÜe
 
	mnode_chªge
;

1145 
wa™_queue_h—d_t
 
	mı_wa™
;

1146 
	mÏ¡_time
[
MAX_TIME
];

1147 
	mš‹rv®_time
[
MAX_TIME
];

1149 
šode_mªagem’t
 
	mim
[
MAX_INO_ENTRY
];

1152 
	mmax_Üphªs
;

1155 
li¡_h—d
 
	mšode_li¡
[
NR_INODE_TYPE
];

1156 
¥šlock_t
 
	mšode_lock
[
NR_INODE_TYPE
];

1159 
¿dix_Œ“_roÙ
 
	mex‹Á_Œ“_roÙ
;

1160 
mu‹x
 
	mex‹Á_Œ“_lock
;

1161 
li¡_h—d
 
	mex‹Á_li¡
;

1162 
¥šlock_t
 
	mex‹Á_lock
;

1163 
©omic_t
 
	mtÙ®_ext_Œ“
;

1164 
li¡_h—d
 
	mzomb›_li¡
;

1165 
©omic_t
 
	mtÙ®_zomb›_Œ“
;

1166 
©omic_t
 
	mtÙ®_ext_node
;

1169 
	mlog_£ùÜs_³r_block
;

1170 
	mlog_blocksize
;

1171 
	mblocksize
;

1172 
	mroÙ_šo_num
;

1173 
	mnode_šo_num
;

1174 
	mm‘a_šo_num
;

1175 
	mlog_blocks_³r_£g
;

1176 
	mblocks_³r_£g
;

1177 
	m£gs_³r_£c
;

1178 
	m£cs_³r_zÚe
;

1179 
	mtÙ®_£ùiÚs
;

1180 
	mtÙ®_node_couÁ
;

1181 
	mtÙ®_v®id_node_couÁ
;

1182 
loff_t
 
	mmax_fe_blocks
;

1183 
	mdœ_Ëv–
;

1184 
	mŒigg”_s¤_th»shŞd
;

1185 
	m»addœ_¿
;

1187 
block_t
 
	mu£r_block_couÁ
;

1188 
block_t
 
	mtÙ®_v®id_block_couÁ
;

1189 
block_t
 
	mdisÿrd_blks
;

1190 
block_t
 
	mÏ¡_v®id_block_couÁ
;

1191 
block_t
 
	m»£rved_blocks
;

1192 
block_t
 
	mcu¼’t_»£rved_blocks
;

1194 
	mnquÙa_fes
;

1196 
u32
 
	ms_Ãxt_g’”©iÚ
;

1199 
©omic_t
 
	mÄ_·ges
[
NR_COUNT_TYPE
];

1201 
³rıu_couÁ”
 
	m®loc_v®id_block_couÁ
;

1204 
©omic_t
 
	mwb_sync_»q
[
META
];

1207 
³rıu_couÁ”
 
	mtÙ®_v®id_šode_couÁ
;

1209 
f2fs_mouÁ_šfo
 
	mmouÁ_İt
;

1212 
mu‹x
 
	mgc_mu‹x
;

1213 
f2fs_gc_kth»ad
 *
	mgc_th»ad
;

1214 
	mcur_viùim_£c
;

1215 
	mgc_mode
;

1217 
	msk³d_©omic_fes
[2];

1220 
u64
 
	mgc_pš_fe_th»shŞd
;

1223 
	mmax_viùim_£¬ch
;

1229 #ifdeà
CONFIG_F2FS_STAT_FS


1230 
f2fs_¡©_šfo
 *
	m¡©_šfo
;

1231 
	m£gm’t_couÁ
[2];

1232 
	mblock_couÁ
[2];

1233 
©omic_t
 
	mš¶aû_couÁ
;

1234 
©omic64_t
 
	mtÙ®_h™_ext
;

1235 
©omic64_t
 
	m»ad_h™_rbŒ“
;

1236 
©omic64_t
 
	m»ad_h™_Ïrge¡
;

1237 
©omic64_t
 
	m»ad_h™_ÿched
;

1238 
©omic_t
 
	mšlše_x©Œ
;

1239 
©omic_t
 
	mšlše_šode
;

1240 
©omic_t
 
	mšlše_dœ
;

1241 
©omic_t
 
	maw_út
;

1242 
©omic_t
 
	mvw_út
;

1243 
©omic_t
 
	mmax_aw_út
;

1244 
©omic_t
 
	mmax_vw_út
;

1245 
	mbg_gc
;

1246 
	mndœty_šode
[
NR_INODE_TYPE
];

1248 
¥šlock_t
 
	m¡©_lock
;

1251 
¥šlock_t
 
	mio¡©_lock
;

1252 
	mwr™e_io¡©
[
NR_IO_TYPE
];

1253 
boŞ
 
	mio¡©_’abË
;

1256 
kobjeù
 
	ms_kobj
;

1257 
com¶‘iÚ
 
	ms_kobj_uÄegi¡”
;

1260 
li¡_h—d
 
	ms_li¡
;

1261 
	ms_ndevs
;

1262 
f2fs_dev_šfo
 *
	mdevs
;

1263 
	mdœty_deviû
;

1264 
¥šlock_t
 
	mdev_lock
;

1265 
mu‹x
 
	mumouÁ_mu‹x
;

1266 
	mshršk”_run_no
;

1269 
u64
 
	m£ùÜs_wr™‹n_¡¬t
;

1270 
u64
 
	mkby‹s_wr™‹n
;

1273 
üy±o_shash
 *
	ms_chksum_driv”
;

1276 
__u32
 
	ms_chksum_£ed
;

1279 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


1280 
	#f2fs_show_šjeùiÚ_šfo
(
ty³
) \

1281 
	`´štk
("%sF2FS-fs : inject %s in %s of %pF\n", \

1282 
KERN_INFO
, 
çuÉ_Çme
[
ty³
], \

1283 
__func__
, 
	`__butš_»tuº_add»ss
(0))

	)

1284 
šlše
 
boŞ
 
	$time_to_šjeù
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1286 
f2fs_çuÉ_šfo
 *
ffi
 = &
	`F2FS_OPTION
(
sbi
).
çuÉ_šfo
;

1288 ià(!
ffi
->
šjeù_¿‹
)

1289  
çl£
;

1291 ià(!
	`IS_FAULT_SET
(
ffi
, 
ty³
))

1292  
çl£
;

1294 
	`©omic_šc
(&
ffi
->
šjeù_İs
);

1295 ià(
	`©omic_»ad
(&
ffi
->
šjeù_İs
è>ğffi->
šjeù_¿‹
) {

1296 
	`©omic_£t
(&
ffi
->
šjeù_İs
, 0);

1297  
Œue
;

1299  
çl£
;

1300 
	}
}

1306 
	#BD_PART_WRITTEN
(
s
) \

1307 (((
u64
)
	`·¹_¡©_»ad
((
s
)->
sb
->
s_bdev
->
bd_·¹
, 
£ùÜs
[1]) - \

1308 (
s
)->
£ùÜs_wr™‹n_¡¬t
è>> 1)

	)

1310 
šlše
 
	$f2fs_upd©e_time
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1312 
sbi
->
Ï¡_time
[
ty³
] = 
jiff›s
;

1313 
	}
}

1315 
šlše
 
boŞ
 
	$f2fs_time_ov”
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1317 
š‹rv®
 = 
sbi
->
š‹rv®_time
[
ty³
] * 
HZ
;

1319  
	`time_aá”
(
jiff›s
, 
sbi
->
Ï¡_time
[
ty³
] + 
š‹rv®
);

1320 
	}
}

1322 
šlše
 
boŞ
 
	$is_idË
(
f2fs_sb_šfo
 *
sbi
)

1324 
block_deviû
 *
bdev
 = 
sbi
->
sb
->
s_bdev
;

1325 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
bdev
);

1326 
»que¡_li¡
 *
¾
 = &
q
->
roÙ_¾
;

1328 ià(
¾
->
couÁ
[
BLK_RW_SYNC
] ||„l->couÁ[
BLK_RW_ASYNC
])

1331  
	`f2fs_time_ov”
(
sbi
, 
REQ_TIME
);

1332 
	}
}

1337 
šlše
 
u32
 
	$__f2fs_üc32
(
f2fs_sb_šfo
 *
sbi
, 
u32
 
üc
,

1338 cÚ¡ *
add»ss
, 
Ëngth
)

1341 
shash_desc
 
shash
;

1342 
ùx
[4];

1343 } 
desc
;

1344 
”r
;

1346 
	`BUG_ON
(
	`üy±o_shash_descsize
(
sbi
->
s_chksum_driv”
è!ğ(
desc
.
ùx
));

1348 
desc
.
shash
.
tfm
 = 
sbi
->
s_chksum_driv”
;

1349 
desc
.
shash
.
æags
 = 0;

1350 *(
u32
 *)
desc
.
ùx
 = 
üc
;

1352 
”r
 = 
	`üy±o_shash_upd©e
(&
desc
.
shash
, 
add»ss
, 
Ëngth
);

1353 
	`BUG_ON
(
”r
);

1355  *(
u32
 *)
desc
.
ùx
;

1356 
	}
}

1358 
šlše
 
u32
 
	$f2fs_üc32
(
f2fs_sb_šfo
 *
sbi
, cÚ¡ *
add»ss
,

1359 
Ëngth
)

1361  
	`__f2fs_üc32
(
sbi
, 
F2FS_SUPER_MAGIC
, 
add»ss
, 
Ëngth
);

1362 
	}
}

1364 
šlše
 
boŞ
 
	$f2fs_üc_v®id
(
f2fs_sb_šfo
 *
sbi
, 
__u32
 
blk_üc
,

1365 *
buf
, 
size_t
 
buf_size
)

1367  
	`f2fs_üc32
(
sbi
, 
buf
, 
buf_size
è=ğ
blk_üc
;

1368 
	}
}

1370 
šlše
 
u32
 
	$f2fs_chksum
(
f2fs_sb_šfo
 *
sbi
, 
u32
 
üc
,

1371 cÚ¡ *
add»ss
, 
Ëngth
)

1373  
	`__f2fs_üc32
(
sbi
, 
üc
, 
add»ss
, 
Ëngth
);

1374 
	}
}

1376 
šlše
 
f2fs_šode_šfo
 *
	$F2FS_I
(
šode
 *inode)

1378  
	`cÚš”_of
(
šode
, 
f2fs_šode_šfo
, 
vfs_šode
);

1379 
	}
}

1381 
šlše
 
f2fs_sb_šfo
 *
	$F2FS_SB
(
su³r_block
 *
sb
)

1383  
sb
->
s_fs_šfo
;

1384 
	}
}

1386 
šlše
 
f2fs_sb_šfo
 *
	$F2FS_I_SB
(
šode
 *inode)

1388  
	`F2FS_SB
(
šode
->
i_sb
);

1389 
	}
}

1391 
šlše
 
f2fs_sb_šfo
 *
	$F2FS_M_SB
(
add»ss_¥aû
 *
m­pšg
)

1393  
	`F2FS_I_SB
(
m­pšg
->
ho¡
);

1394 
	}
}

1396 
šlše
 
f2fs_sb_šfo
 *
	$F2FS_P_SB
(
·ge
 *page)

1398  
	`F2FS_M_SB
(
·ge
->
m­pšg
);

1399 
	}
}

1401 
šlše
 
f2fs_su³r_block
 *
	$F2FS_RAW_SUPER
(
f2fs_sb_šfo
 *
sbi
)

1403  (
f2fs_su³r_block
 *)(
sbi
->
¿w_su³r
);

1404 
	}
}

1406 
šlše
 
f2fs_checkpošt
 *
	$F2FS_CKPT
(
f2fs_sb_šfo
 *
sbi
)

1408  (
f2fs_checkpošt
 *)(
sbi
->
ck±
);

1409 
	}
}

1411 
šlše
 
f2fs_node
 *
	$F2FS_NODE
(
·ge
 *page)

1413  (
f2fs_node
 *)
	`·ge_add»ss
(
·ge
);

1414 
	}
}

1416 
šlše
 
f2fs_šode
 *
	$F2FS_INODE
(
·ge
 *page)

1418  &((
f2fs_node
 *)
	`·ge_add»ss
(
·ge
))->
i
;

1419 
	}
}

1421 
šlše
 
f2fs_nm_šfo
 *
	$NM_I
(
f2fs_sb_šfo
 *
sbi
)

1423  (
f2fs_nm_šfo
 *)(
sbi
->
nm_šfo
);

1424 
	}
}

1426 
šlše
 
f2fs_sm_šfo
 *
	$SM_I
(
f2fs_sb_šfo
 *
sbi
)

1428  (
f2fs_sm_šfo
 *)(
sbi
->
sm_šfo
);

1429 
	}
}

1431 
šlše
 
s™_šfo
 *
	$SIT_I
(
f2fs_sb_šfo
 *
sbi
)

1433  (
s™_šfo
 *)(
	`SM_I
(
sbi
)->sit_info);

1434 
	}
}

1436 
šlše
 
ä“_£gm­_šfo
 *
	$FREE_I
(
f2fs_sb_šfo
 *
sbi
)

1438  (
ä“_£gm­_šfo
 *)(
	`SM_I
(
sbi
)->
ä“_šfo
);

1439 
	}
}

1441 
šlše
 
dœty_£gli¡_šfo
 *
	$DIRTY_I
(
f2fs_sb_šfo
 *
sbi
)

1443  (
dœty_£gli¡_šfo
 *)(
	`SM_I
(
sbi
)->
dœty_šfo
);

1444 
	}
}

1446 
šlše
 
add»ss_¥aû
 *
	$META_MAPPING
(
f2fs_sb_šfo
 *
sbi
)

1448  
sbi
->
m‘a_šode
->
i_m­pšg
;

1449 
	}
}

1451 
šlše
 
add»ss_¥aû
 *
	$NODE_MAPPING
(
f2fs_sb_šfo
 *
sbi
)

1453  
sbi
->
node_šode
->
i_m­pšg
;

1454 
	}
}

1456 
šlše
 
boŞ
 
	$is_sbi_æag_£t
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1458  
	`‹¡_b™
(
ty³
, &
sbi
->
s_æag
);

1459 
	}
}

1461 
šlše
 
	$£t_sbi_æag
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1463 
	`£t_b™
(
ty³
, &
sbi
->
s_æag
);

1464 
	}
}

1466 
šlše
 
	$ş—r_sbi_æag
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1468 
	`ş—r_b™
(
ty³
, &
sbi
->
s_æag
);

1469 
	}
}

1471 
šlše
 
	$cur_ı_v”siÚ
(
f2fs_checkpošt
 *
ı
)

1473  
	`Ë64_to_ıu
(
ı
->
checkpošt_v”
);

1474 
	}
}

1476 
šlše
 
	$f2fs_qf_šo
(
su³r_block
 *
sb
, 
ty³
)

1478 ià(
ty³
 < 
F2FS_MAX_QUOTAS
)

1479  
	`Ë32_to_ıu
(
	`F2FS_SB
(
sb
)->
¿w_su³r
->
qf_šo
[
ty³
]);

1481 
	}
}

1483 
šlše
 
__u64
 
	$cur_ı_üc
(
f2fs_checkpošt
 *
ı
)

1485 
size_t
 
üc_off£t
 = 
	`Ë32_to_ıu
(
ı
->
checksum_off£t
);

1486  
	`Ë32_to_ıu
(*((
__Ë32
 *)((*)
ı
 + 
üc_off£t
)));

1487 
	}
}

1489 
šlše
 
boŞ
 
	$__is_£t_ck±_æags
(
f2fs_checkpošt
 *
ı
, 
f
)

1491 
ck±_æags
 = 
	`Ë32_to_ıu
(
ı
->ckpt_flags);

1493  
ck±_æags
 & 
f
;

1494 
	}
}

1496 
šlše
 
boŞ
 
	$is_£t_ck±_æags
(
f2fs_sb_šfo
 *
sbi
, 
f
)

1498  
	`__is_£t_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
f
);

1499 
	}
}

1501 
šlše
 
	$__£t_ck±_æags
(
f2fs_checkpošt
 *
ı
, 
f
)

1503 
ck±_æags
;

1505 
ck±_æags
 = 
	`Ë32_to_ıu
(
ı
->ckpt_flags);

1506 
ck±_æags
 |ğ
f
;

1507 
ı
->
ck±_æags
 = 
	`ıu_to_Ë32
(ckpt_flags);

1508 
	}
}

1510 
šlše
 
	$£t_ck±_æags
(
f2fs_sb_šfo
 *
sbi
, 
f
)

1512 
æags
;

1514 
	`¥š_lock_œq§ve
(&
sbi
->
ı_lock
, 
æags
);

1515 
	`__£t_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
f
);

1516 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
ı_lock
, 
æags
);

1517 
	}
}

1519 
šlše
 
	$__ş—r_ck±_æags
(
f2fs_checkpošt
 *
ı
, 
f
)

1521 
ck±_æags
;

1523 
ck±_æags
 = 
	`Ë32_to_ıu
(
ı
->ckpt_flags);

1524 
ck±_æags
 &ğ(~
f
);

1525 
ı
->
ck±_æags
 = 
	`ıu_to_Ë32
(ckpt_flags);

1526 
	}
}

1528 
šlše
 
	$ş—r_ck±_æags
(
f2fs_sb_šfo
 *
sbi
, 
f
)

1530 
æags
;

1532 
	`¥š_lock_œq§ve
(&
sbi
->
ı_lock
, 
æags
);

1533 
	`__ş—r_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
f
);

1534 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
ı_lock
, 
æags
);

1535 
	}
}

1537 
šlše
 
	$di§bË_Çt_b™s
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
lock
)

1539 
æags
;

1541 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

1543 ià(
lock
)

1544 
	`¥š_lock_œq§ve
(&
sbi
->
ı_lock
, 
æags
);

1545 
	`__ş—r_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
CP_NAT_BITS_FLAG
);

1546 
	`kä“
(
	`NM_I
(
sbi
)->
Çt_b™s
);

1547 
	`NM_I
(
sbi
)->
Çt_b™s
 = 
NULL
;

1548 ià(
lock
)

1549 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
ı_lock
, 
æags
);

1550 
	}
}

1552 
šlše
 
boŞ
 
	$’abËd_Çt_b™s
(
f2fs_sb_šfo
 *
sbi
,

1553 
ı_cÚŒŞ
 *
ıc
)

1555 
boŞ
 
£t
 = 
	`is_£t_ck±_æags
(
sbi
, 
CP_NAT_BITS_FLAG
);

1557  (
ıc
è? (ıc->
»asÚ
 & 
CP_UMOUNT
è&& 
£t
 : set;

1558 
	}
}

1560 
šlše
 
	$f2fs_lock_İ
(
f2fs_sb_šfo
 *
sbi
)

1562 
	`down_»ad
(&
sbi
->
ı_rw£m
);

1563 
	}
}

1565 
šlše
 
	$f2fs_Œylock_İ
(
f2fs_sb_šfo
 *
sbi
)

1567  
	`down_»ad_Œylock
(&
sbi
->
ı_rw£m
);

1568 
	}
}

1570 
šlše
 
	$f2fs_uÆock_İ
(
f2fs_sb_šfo
 *
sbi
)

1572 
	`up_»ad
(&
sbi
->
ı_rw£m
);

1573 
	}
}

1575 
šlše
 
	$f2fs_lock_®l
(
f2fs_sb_šfo
 *
sbi
)

1577 
	`down_wr™e
(&
sbi
->
ı_rw£m
);

1578 
	}
}

1580 
šlše
 
	$f2fs_uÆock_®l
(
f2fs_sb_šfo
 *
sbi
)

1582 
	`up_wr™e
(&
sbi
->
ı_rw£m
);

1583 
	}
}

1585 
šlše
 
	$__g‘_ı_»asÚ
(
f2fs_sb_šfo
 *
sbi
)

1587 
»asÚ
 = 
CP_SYNC
;

1589 ià(
	`‹¡_İt
(
sbi
, 
FASTBOOT
))

1590 
»asÚ
 = 
CP_FASTBOOT
;

1591 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_CLOSE
))

1592 
»asÚ
 = 
CP_UMOUNT
;

1593  
»asÚ
;

1594 
	}
}

1596 
šlše
 
boŞ
 
	$__»maš_node_summ¬›s
(
»asÚ
)

1598  (
»asÚ
 & (
CP_UMOUNT
 | 
CP_FASTBOOT
));

1599 
	}
}

1601 
šlše
 
boŞ
 
	$__exi¡_node_summ¬›s
(
f2fs_sb_šfo
 *
sbi
)

1603  (
	`is_£t_ck±_æags
(
sbi
, 
CP_UMOUNT_FLAG
) ||

1604 
	`is_£t_ck±_æags
(
sbi
, 
CP_FASTBOOT_FLAG
));

1605 
	}
}

1610 
šlše
 
	$F2FS_HAS_BLOCKS
(
šode
 *inode)

1612 
block_t
 
x©Œ_block
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
 ? 1 : 0;

1614  (
šode
->
i_blocks
 >> 
F2FS_LOG_SECTORS_PER_BLOCK
è> 
x©Œ_block
;

1615 
	}
}

1617 
šlše
 
boŞ
 
	$f2fs_has_x©Œ_block
(
ofs
)

1619  
ofs
 =ğ
XATTR_NODE_OFFSET
;

1620 
	}
}

1622 
šlše
 
boŞ
 
	$__®low_»£rved_blocks
(
f2fs_sb_šfo
 *
sbi
,

1623 
šode
 *šode, 
boŞ
 
ÿp
)

1625 ià(!
šode
)

1626  
Œue
;

1627 ià(!
	`‹¡_İt
(
sbi
, 
RESERVE_ROOT
))

1628  
çl£
;

1629 ià(
	`IS_NOQUOTA
(
šode
))

1630  
Œue
;

1631 ià(
	`uid_eq
(
	`F2FS_OPTION
(
sbi
).
s_»suid
, 
	`cu¼’t_fsuid
()))

1632  
Œue
;

1633 ià(!
	`gid_eq
(
	`F2FS_OPTION
(
sbi
).
s_»sgid
, 
GLOBAL_ROOT_GID
) &&

1634 
	`š_group_p
(
	`F2FS_OPTION
(
sbi
).
s_»sgid
))

1635  
Œue
;

1636 ià(
ÿp
 && 
	`ÿ·bË
(
CAP_SYS_RESOURCE
))

1637  
Œue
;

1638  
çl£
;

1639 
	}
}

1641 
šlše
 
f2fs_i_blocks_wr™e
(
šode
 *, 
block_t
, 
boŞ
, bool);

1642 
šlše
 
	$šc_v®id_block_couÁ
(
f2fs_sb_šfo
 *
sbi
,

1643 
šode
 *šode, 
blkút_t
 *
couÁ
)

1645 
blkút_t
 
diff
 = 0, 
»Ëa£
 = 0;

1646 
block_t
 
ava_u£r_block_couÁ
;

1647 
»t
;

1649 
»t
 = 
	`dquÙ_»£rve_block
(
šode
, *
couÁ
);

1650 ià(
»t
)

1651  
»t
;

1653 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


1654 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_BLOCK
)) {

1655 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_BLOCK
);

1656 
»Ëa£
 = *
couÁ
;

1657 
’o¥c
;

1664 
	`³rıu_couÁ”_add
(&
sbi
->
®loc_v®id_block_couÁ
, (*
couÁ
));

1666 
	`¥š_lock
(&
sbi
->
¡©_lock
);

1667 
sbi
->
tÙ®_v®id_block_couÁ
 +ğ(
block_t
)(*
couÁ
);

1668 
ava_u£r_block_couÁ
 = 
sbi
->
u£r_block_couÁ
 -

1669 
sbi
->
cu¼’t_»£rved_blocks
;

1671 ià(!
	`__®low_»£rved_blocks
(
sbi
, 
šode
, 
Œue
))

1672 
ava_u£r_block_couÁ
 -ğ
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
;

1674 ià(
	`uÆik–y
(
sbi
->
tÙ®_v®id_block_couÁ
 > 
ava_u£r_block_couÁ
)) {

1675 
diff
 = 
sbi
->
tÙ®_v®id_block_couÁ
 - 
ava_u£r_block_couÁ
;

1676 ià(
diff
 > *
couÁ
)

1677 
diff
 = *
couÁ
;

1678 *
couÁ
 -ğ
diff
;

1679 
»Ëa£
 = 
diff
;

1680 
sbi
->
tÙ®_v®id_block_couÁ
 -ğ
diff
;

1681 ià(!*
couÁ
) {

1682 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1683 
	`³rıu_couÁ”_sub
(&
sbi
->
®loc_v®id_block_couÁ
, 
diff
);

1684 
’o¥c
;

1687 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1689 ià(
	`uÆik–y
(
»Ëa£
))

1690 
	`dquÙ_»Ëa£_»£rv©iÚ_block
(
šode
, 
»Ëa£
);

1691 
	`f2fs_i_blocks_wr™e
(
šode
, *
couÁ
, 
Œue
,rue);

1694 
’o¥c
:

1695 
	`dquÙ_»Ëa£_»£rv©iÚ_block
(
šode
, 
»Ëa£
);

1696  -
ENOSPC
;

1697 
	}
}

1699 
šlše
 
	$dec_v®id_block_couÁ
(
f2fs_sb_šfo
 *
sbi
,

1700 
šode
 *inode,

1701 
block_t
 
couÁ
)

1703 
blkút_t
 
£ùÜs
 = 
couÁ
 << 
F2FS_LOG_SECTORS_PER_BLOCK
;

1705 
	`¥š_lock
(&
sbi
->
¡©_lock
);

1706 
	`f2fs_bug_Ú
(
sbi
, sbi->
tÙ®_v®id_block_couÁ
 < (
block_t
è
couÁ
);

1707 
	`f2fs_bug_Ú
(
sbi
, 
šode
->
i_blocks
 < 
£ùÜs
);

1708 
sbi
->
tÙ®_v®id_block_couÁ
 -ğ(
block_t
)
couÁ
;

1709 ià(
sbi
->
»£rved_blocks
 &&

1710 
sbi
->
cu¼’t_»£rved_blocks
 < sbi->
»£rved_blocks
)

1711 
sbi
->
cu¼’t_»£rved_blocks
 = 
	`mš
(sbi->
»£rved_blocks
,

1712 
sbi
->
cu¼’t_»£rved_blocks
 + 
couÁ
);

1713 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1714 
	`f2fs_i_blocks_wr™e
(
šode
, 
couÁ
, 
çl£
, 
Œue
);

1715 
	}
}

1717 
šlše
 
	$šc_·ge_couÁ
(
f2fs_sb_šfo
 *
sbi
, 
couÁ_ty³
)

1719 
	`©omic_šc
(&
sbi
->
Ä_·ges
[
couÁ_ty³
]);

1721 ià(
couÁ_ty³
 =ğ
F2FS_DIRTY_DATA
 || couÁ_ty³ =ğ
F2FS_INMEM_PAGES
 ||

1722 
couÁ_ty³
 =ğ
F2FS_WB_CP_DATA
 || couÁ_ty³ =ğ
F2FS_WB_DATA
)

1725 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_DIRTY
);

1726 
	}
}

1728 
šlše
 
	$šode_šc_dœty_·ges
(
šode
 *inode)

1730 
	`©omic_šc
(&
	`F2FS_I
(
šode
)->
dœty_·ges
);

1731 
	`šc_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
	`S_ISDIR
(šode->
i_mode
) ?

1732 
F2FS_DIRTY_DENTS
 : 
F2FS_DIRTY_DATA
);

1733 ià(
	`IS_NOQUOTA
(
šode
))

1734 
	`šc_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
F2FS_DIRTY_QDATA
);

1735 
	}
}

1737 
šlše
 
	$dec_·ge_couÁ
(
f2fs_sb_šfo
 *
sbi
, 
couÁ_ty³
)

1739 
	`©omic_dec
(&
sbi
->
Ä_·ges
[
couÁ_ty³
]);

1740 
	}
}

1742 
šlše
 
	$šode_dec_dœty_·ges
(
šode
 *inode)

1744 ià(!
	`S_ISDIR
(
šode
->
i_mode
è&& !
	`S_ISREG
(inode->i_mode) &&

1745 !
	`S_ISLNK
(
šode
->
i_mode
))

1748 
	`©omic_dec
(&
	`F2FS_I
(
šode
)->
dœty_·ges
);

1749 
	`dec_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
	`S_ISDIR
(šode->
i_mode
) ?

1750 
F2FS_DIRTY_DENTS
 : 
F2FS_DIRTY_DATA
);

1751 ià(
	`IS_NOQUOTA
(
šode
))

1752 
	`dec_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
F2FS_DIRTY_QDATA
);

1753 
	}
}

1755 
šlše
 
s64
 
	$g‘_·ges
(
f2fs_sb_šfo
 *
sbi
, 
couÁ_ty³
)

1757  
	`©omic_»ad
(&
sbi
->
Ä_·ges
[
couÁ_ty³
]);

1758 
	}
}

1760 
šlše
 
	$g‘_dœty_·ges
(
šode
 *inode)

1762  
	`©omic_»ad
(&
	`F2FS_I
(
šode
)->
dœty_·ges
);

1763 
	}
}

1765 
šlše
 
	$g‘_blockty³_£cs
(
f2fs_sb_šfo
 *
sbi
, 
block_ty³
)

1767 
·ges_³r_£c
 = 
sbi
->
£gs_³r_£c
 * sbi->
blocks_³r_£g
;

1768 
£gs
 = (
	`g‘_·ges
(
sbi
, 
block_ty³
è+ 
·ges_³r_£c
 - 1) >>

1769 
sbi
->
log_blocks_³r_£g
;

1771  
£gs
 / 
sbi
->
£gs_³r_£c
;

1772 
	}
}

1774 
šlše
 
block_t
 
	$v®id_u£r_blocks
(
f2fs_sb_šfo
 *
sbi
)

1776  
sbi
->
tÙ®_v®id_block_couÁ
;

1777 
	}
}

1779 
šlše
 
block_t
 
	$disÿrd_blocks
(
f2fs_sb_šfo
 *
sbi
)

1781  
sbi
->
disÿrd_blks
;

1782 
	}
}

1784 
šlše
 
	$__b™m­_size
(
f2fs_sb_šfo
 *
sbi
, 
æag
)

1786 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1789 ià(
æag
 =ğ
NAT_BITMAP
)

1790  
	`Ë32_to_ıu
(
ck±
->
Çt_v”_b™m­_by‹size
);

1791 ià(
æag
 =ğ
SIT_BITMAP
)

1792  
	`Ë32_to_ıu
(
ck±
->
s™_v”_b™m­_by‹size
);

1795 
	}
}

1797 
šlše
 
block_t
 
	$__ı_·ylßd
(
f2fs_sb_šfo
 *
sbi
)

1799  
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
ı_·ylßd
);

1800 
	}
}

1802 
šlše
 *
	$__b™m­_±r
(
f2fs_sb_šfo
 *
sbi
, 
æag
)

1804 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1805 
off£t
;

1807 ià(
	`is_£t_ck±_æags
(
sbi
, 
CP_LARGE_NAT_BITMAP_FLAG
)) {

1808 
off£t
 = (
æag
 =ğ
SIT_BITMAP
) ?

1809 
	`Ë32_to_ıu
(
ck±
->
Çt_v”_b™m­_by‹size
) : 0;

1810  &
ck±
->
s™_Çt_v”siÚ_b™m­
 + 
off£t
;

1813 ià(
	`__ı_·ylßd
(
sbi
) > 0) {

1814 ià(
æag
 =ğ
NAT_BITMAP
)

1815  &
ck±
->
s™_Çt_v”siÚ_b™m­
;

1817  (*)
ck±
 + 
F2FS_BLKSIZE
;

1819 
off£t
 = (
æag
 =ğ
NAT_BITMAP
) ?

1820 
	`Ë32_to_ıu
(
ck±
->
s™_v”_b™m­_by‹size
) : 0;

1821  &
ck±
->
s™_Çt_v”siÚ_b™m­
 + 
off£t
;

1823 
	}
}

1825 
šlše
 
block_t
 
	$__¡¬t_ı_addr
(
f2fs_sb_šfo
 *
sbi
)

1827 
block_t
 
¡¬t_addr
 = 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
ı_blkaddr
);

1829 ià(
sbi
->
cur_ı_·ck
 == 2)

1830 
¡¬t_addr
 +ğ
sbi
->
blocks_³r_£g
;

1831  
¡¬t_addr
;

1832 
	}
}

1834 
šlše
 
block_t
 
	$__¡¬t_ı_Ãxt_addr
(
f2fs_sb_šfo
 *
sbi
)

1836 
block_t
 
¡¬t_addr
 = 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
ı_blkaddr
);

1838 ià(
sbi
->
cur_ı_·ck
 == 1)

1839 
¡¬t_addr
 +ğ
sbi
->
blocks_³r_£g
;

1840  
¡¬t_addr
;

1841 
	}
}

1843 
šlše
 
	$__£t_ı_Ãxt_·ck
(
f2fs_sb_šfo
 *
sbi
)

1845 
sbi
->
cur_ı_·ck
 = (sbi->cur_cp_pack == 1) ? 2 : 1;

1846 
	}
}

1848 
šlše
 
block_t
 
	$__¡¬t_sum_addr
(
f2fs_sb_šfo
 *
sbi
)

1850  
	`Ë32_to_ıu
(
	`F2FS_CKPT
(
sbi
)->
ı_·ck_¡¬t_sum
);

1851 
	}
}

1853 
šlše
 
	$šc_v®id_node_couÁ
(
f2fs_sb_šfo
 *
sbi
,

1854 
šode
 *šode, 
boŞ
 
is_šode
)

1856 
block_t
 
v®id_block_couÁ
;

1857 
v®id_node_couÁ
;

1858 
boŞ
 
quÙa
 = 
šode
 && !
is_šode
;

1860 ià(
quÙa
) {

1861 
»t
 = 
	`dquÙ_»£rve_block
(
šode
, 1);

1862 ià(
»t
)

1863  
»t
;

1866 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


1867 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_BLOCK
)) {

1868 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_BLOCK
);

1869 
’o¥c
;

1873 
	`¥š_lock
(&
sbi
->
¡©_lock
);

1875 
v®id_block_couÁ
 = 
sbi
->
tÙ®_v®id_block_couÁ
 +

1876 
sbi
->
cu¼’t_»£rved_blocks
 + 1;

1878 ià(!
	`__®low_»£rved_blocks
(
sbi
, 
šode
, 
çl£
))

1879 
v®id_block_couÁ
 +ğ
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
;

1881 ià(
	`uÆik–y
(
v®id_block_couÁ
 > 
sbi
->
u£r_block_couÁ
)) {

1882 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1883 
’o¥c
;

1886 
v®id_node_couÁ
 = 
sbi
->
tÙ®_v®id_node_couÁ
 + 1;

1887 ià(
	`uÆik–y
(
v®id_node_couÁ
 > 
sbi
->
tÙ®_node_couÁ
)) {

1888 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1889 
’o¥c
;

1892 
sbi
->
tÙ®_v®id_node_couÁ
++;

1893 
sbi
->
tÙ®_v®id_block_couÁ
++;

1894 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1896 ià(
šode
) {

1897 ià(
is_šode
)

1898 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

1900 
	`f2fs_i_blocks_wr™e
(
šode
, 1, 
Œue
,rue);

1903 
	`³rıu_couÁ”_šc
(&
sbi
->
®loc_v®id_block_couÁ
);

1906 
’o¥c
:

1907 ià(
quÙa
)

1908 
	`dquÙ_»Ëa£_»£rv©iÚ_block
(
šode
, 1);

1909  -
ENOSPC
;

1910 
	}
}

1912 
šlše
 
	$dec_v®id_node_couÁ
(
f2fs_sb_šfo
 *
sbi
,

1913 
šode
 *šode, 
boŞ
 
is_šode
)

1915 
	`¥š_lock
(&
sbi
->
¡©_lock
);

1917 
	`f2fs_bug_Ú
(
sbi
, !sbi->
tÙ®_v®id_block_couÁ
);

1918 
	`f2fs_bug_Ú
(
sbi
, !sbi->
tÙ®_v®id_node_couÁ
);

1919 
	`f2fs_bug_Ú
(
sbi
, !
is_šode
 && !
šode
->
i_blocks
);

1921 
sbi
->
tÙ®_v®id_node_couÁ
--;

1922 
sbi
->
tÙ®_v®id_block_couÁ
--;

1923 ià(
sbi
->
»£rved_blocks
 &&

1924 
sbi
->
cu¼’t_»£rved_blocks
 < sbi->
»£rved_blocks
)

1925 
sbi
->
cu¼’t_»£rved_blocks
++;

1927 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1929 ià(!
is_šode
)

1930 
	`f2fs_i_blocks_wr™e
(
šode
, 1, 
çl£
, 
Œue
);

1931 
	}
}

1933 
šlše
 
	$v®id_node_couÁ
(
f2fs_sb_šfo
 *
sbi
)

1935  
sbi
->
tÙ®_v®id_node_couÁ
;

1936 
	}
}

1938 
šlše
 
	$šc_v®id_šode_couÁ
(
f2fs_sb_šfo
 *
sbi
)

1940 
	`³rıu_couÁ”_šc
(&
sbi
->
tÙ®_v®id_šode_couÁ
);

1941 
	}
}

1943 
šlše
 
	$dec_v®id_šode_couÁ
(
f2fs_sb_šfo
 *
sbi
)

1945 
	`³rıu_couÁ”_dec
(&
sbi
->
tÙ®_v®id_šode_couÁ
);

1946 
	}
}

1948 
šlše
 
s64
 
	$v®id_šode_couÁ
(
f2fs_sb_šfo
 *
sbi
)

1950  
	`³rıu_couÁ”_sum_pos™ive
(&
sbi
->
tÙ®_v®id_šode_couÁ
);

1951 
	}
}

1953 
šlše
 
·ge
 *
	$f2fs_g¿b_ÿche_·ge
(
add»ss_¥aû
 *
m­pšg
,

1954 
pgoff_t
 
šdex
, 
boŞ
 
fÜ_wr™e
)

1956 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


1957 
·ge
 *·gğ
	`fšd_lock_·ge
(
m­pšg
, 
šdex
);

1959 ià(
·ge
)

1960  
·ge
;

1962 ià(
	`time_to_šjeù
(
	`F2FS_M_SB
(
m­pšg
), 
FAULT_PAGE_ALLOC
)) {

1963 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_PAGE_ALLOC
);

1964  
NULL
;

1967 ià(!
fÜ_wr™e
)

1968  
	`g¿b_ÿche_·ge
(
m­pšg
, 
šdex
);

1969  
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 
šdex
, 
AOP_FLAG_NOFS
);

1970 
	}
}

1972 
šlše
 
·ge
 *
	$f2fs_·geÿche_g‘_·ge
(

1973 
add»ss_¥aû
 *
m­pšg
, 
pgoff_t
 
šdex
,

1974 
fgp_æags
, 
gå_t
 
gå_mask
)

1976 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


1977 ià(
	`time_to_šjeù
(
	`F2FS_M_SB
(
m­pšg
), 
FAULT_PAGE_GET
)) {

1978 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_PAGE_GET
);

1979  
NULL
;

1982  
	`·geÿche_g‘_·ge
(
m­pšg
, 
šdex
, 
fgp_æags
, 
gå_mask
);

1983 
	}
}

1985 
šlše
 
	$f2fs_cİy_·ge
(
·ge
 *
¤c
, ·g*
d¡
)

1987 *
¤c_kaddr
 = 
	`km­
(
¤c
);

1988 *
d¡_kaddr
 = 
	`km­
(
d¡
);

1990 
	`memıy
(
d¡_kaddr
, 
¤c_kaddr
, 
PAGE_SIZE
);

1991 
	`kunm­
(
d¡
);

1992 
	`kunm­
(
¤c
);

1993 
	}
}

1995 
šlše
 
	$f2fs_put_·ge
(
·ge
 *·ge, 
uÆock
)

1997 ià(!
·ge
)

2000 ià(
uÆock
) {

2001 
	`f2fs_bug_Ú
(
	`F2FS_P_SB
(
·ge
), !
	`PageLocked
(page));

2002 
	`uÆock_·ge
(
·ge
);

2004 
	`put_·ge
(
·ge
);

2005 
	}
}

2007 
šlše
 
	$f2fs_put_dnode
(
dnode_of_d©a
 *
dn
)

2009 ià(
dn
->
node_·ge
)

2010 
	`f2fs_put_·ge
(
dn
->
node_·ge
, 1);

2011 ià(
dn
->
šode_·ge
 && dn->
node_·ge
 != dn->inode_page)

2012 
	`f2fs_put_·ge
(
dn
->
šode_·ge
, 0);

2013 
dn
->
node_·ge
 = 
NULL
;

2014 
dn
->
šode_·ge
 = 
NULL
;

2015 
	}
}

2017 
šlše
 
kmem_ÿche
 *
	$f2fs_kmem_ÿche_ü—‹
(cÚ¡ *
Çme
,

2018 
size_t
 
size
)

2020  
	`kmem_ÿche_ü—‹
(
Çme
, 
size
, 0, 
SLAB_RECLAIM_ACCOUNT
, 
NULL
);

2021 
	}
}

2023 
šlše
 *
	$f2fs_kmem_ÿche_®loc
(
kmem_ÿche
 *
ÿch•
,

2024 
gå_t
 
æags
)

2026 *
’Œy
;

2028 
’Œy
 = 
	`kmem_ÿche_®loc
(
ÿch•
, 
æags
);

2029 ià(!
’Œy
)

2030 
’Œy
 = 
	`kmem_ÿche_®loc
(
ÿch•
, 
æags
 | 
__GFP_NOFAIL
);

2031  
’Œy
;

2032 
	}
}

2034 
šlše
 
bio
 *
	$f2fs_bio_®loc
(
f2fs_sb_šfo
 *
sbi
,

2035 
Åages
, 
boŞ
 
no_ç
)

2037 
bio
 *bio;

2039 ià(
no_ç
) {

2041 
bio
 = 
	`bio_®loc
(
GFP_NOIO
, 
Åages
);

2042 ià(!
bio
)

2043 
bio
 = 
	`bio_®loc
(
GFP_NOIO
 | 
__GFP_NOFAIL
, 
Åages
);

2044  
bio
;

2046 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


2047 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_ALLOC_BIO
)) {

2048 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_ALLOC_BIO
);

2049  
NULL
;

2052  
	`bio_®loc
(
GFP_KERNEL
, 
Åages
);

2053 
	}
}

2055 
šlše
 
	$f2fs_¿dix_Œ“_š£¹
(
¿dix_Œ“_roÙ
 *
roÙ
,

2056 
šdex
, *
™em
)

2058 
	`¿dix_Œ“_š£¹
(
roÙ
, 
šdex
, 
™em
))

2059 
	`cÚd_»sched
();

2060 
	}
}

2062 
	#RAW_IS_INODE
(
p
è(Õ)->
foÙ”
.
nid
 =ğÕ)->foÙ”.
šo
)

	)

2064 
šlše
 
boŞ
 
	$IS_INODE
(
·ge
 *page)

2066 
f2fs_node
 *
p
 = 
	`F2FS_NODE
(
·ge
);

2068  
	`RAW_IS_INODE
(
p
);

2069 
	}
}

2071 
šlše
 
	$off£t_š_addr
(
f2fs_šode
 *
i
)

2073  (
i
->
i_šlše
 & 
F2FS_EXTRA_ATTR
) ?

2074 (
	`Ë16_to_ıu
(
i
->
i_exŒa_isize
è/ (
__Ë32
)) : 0;

2075 
	}
}

2077 
šlše
 
__Ë32
 *
	$blkaddr_š_node
(
f2fs_node
 *
node
)

2079  
	`RAW_IS_INODE
(
node
è?‚ode->
i
.
i_addr
 :‚ode->
dn
.
addr
;

2080 
	}
}

2082 
šlše
 
f2fs_has_exŒa_©Œ
(
šode
 *inode);

2083 
šlše
 
block_t
 
	$d©ablock_addr
(
šode
 *inode,

2084 
·ge
 *
node_·ge
, 
off£t
)

2086 
f2fs_node
 *
¿w_node
;

2087 
__Ë32
 *
addr_¬¿y
;

2088 
ba£
 = 0;

2089 
boŞ
 
is_šode
 = 
	`IS_INODE
(
node_·ge
);

2091 
¿w_node
 = 
	`F2FS_NODE
(
node_·ge
);

2094 ià(
is_šode
) {

2095 ià(!
šode
)

2096 
ba£
 = 
	`off£t_š_addr
(&
¿w_node
->
i
);

2097 ià(
	`f2fs_has_exŒa_©Œ
(
šode
))

2098 
ba£
 = 
	`g‘_exŒa_isize
(
šode
);

2101 
addr_¬¿y
 = 
	`blkaddr_š_node
(
¿w_node
);

2102  
	`Ë32_to_ıu
(
addr_¬¿y
[
ba£
 + 
off£t
]);

2103 
	}
}

2105 
šlše
 
	$f2fs_‹¡_b™
(
Ä
, *
addr
)

2107 
mask
;

2109 
addr
 +ğ(
Ä
 >> 3);

2110 
mask
 = 1 << (7 - (
Ä
 & 0x07));

2111  
mask
 & *
addr
;

2112 
	}
}

2114 
šlše
 
	$f2fs_£t_b™
(
Ä
, *
addr
)

2116 
mask
;

2118 
addr
 +ğ(
Ä
 >> 3);

2119 
mask
 = 1 << (7 - (
Ä
 & 0x07));

2120 *
addr
 |ğ
mask
;

2121 
	}
}

2123 
šlše
 
	$f2fs_ş—r_b™
(
Ä
, *
addr
)

2125 
mask
;

2127 
addr
 +ğ(
Ä
 >> 3);

2128 
mask
 = 1 << (7 - (
Ä
 & 0x07));

2129 *
addr
 &ğ~
mask
;

2130 
	}
}

2132 
šlše
 
	$f2fs_‹¡_ªd_£t_b™
(
Ä
, *
addr
)

2134 
mask
;

2135 
»t
;

2137 
addr
 +ğ(
Ä
 >> 3);

2138 
mask
 = 1 << (7 - (
Ä
 & 0x07));

2139 
»t
 = 
mask
 & *
addr
;

2140 *
addr
 |ğ
mask
;

2141  
»t
;

2142 
	}
}

2144 
šlše
 
	$f2fs_‹¡_ªd_ş—r_b™
(
Ä
, *
addr
)

2146 
mask
;

2147 
»t
;

2149 
addr
 +ğ(
Ä
 >> 3);

2150 
mask
 = 1 << (7 - (
Ä
 & 0x07));

2151 
»t
 = 
mask
 & *
addr
;

2152 *
addr
 &ğ~
mask
;

2153  
»t
;

2154 
	}
}

2156 
šlše
 
	$f2fs_chªge_b™
(
Ä
, *
addr
)

2158 
mask
;

2160 
addr
 +ğ(
Ä
 >> 3);

2161 
mask
 = 1 << (7 - (
Ä
 & 0x07));

2162 *
addr
 ^ğ
mask
;

2163 
	}
}

2168 
	#F2FS_SECRM_FL
 0x00000001

	)

2169 
	#F2FS_UNRM_FL
 0x00000002

	)

2170 
	#F2FS_COMPR_FL
 0x00000004

	)

2171 
	#F2FS_SYNC_FL
 0x00000008

	)

2172 
	#F2FS_IMMUTABLE_FL
 0x00000010

	)

2173 
	#F2FS_APPEND_FL
 0x00000020

	)

2174 
	#F2FS_NODUMP_FL
 0x00000040

	)

2175 
	#F2FS_NOATIME_FL
 0x00000080

	)

2177 
	#F2FS_DIRTY_FL
 0x00000100

	)

2178 
	#F2FS_COMPRBLK_FL
 0x00000200

	)

2179 
	#F2FS_NOCOMPR_FL
 0x00000400

	)

2180 
	#F2FS_ENCRYPT_FL
 0x00000800

	)

2182 
	#F2FS_INDEX_FL
 0x00001000

	)

2183 
	#F2FS_IMAGIC_FL
 0x00002000

	)

2184 
	#F2FS_JOURNAL_DATA_FL
 0x00004000

	)

2185 
	#F2FS_NOTAIL_FL
 0x00008000

	)

2186 
	#F2FS_DIRSYNC_FL
 0x00010000

	)

2187 
	#F2FS_TOPDIR_FL
 0x00020000

	)

2188 
	#F2FS_HUGE_FILE_FL
 0x00040000

	)

2189 
	#F2FS_EXTENTS_FL
 0x00080000

	)

2190 
	#F2FS_EA_INODE_FL
 0x00200000

	)

2191 
	#F2FS_EOFBLOCKS_FL
 0x00400000

	)

2192 
	#F2FS_INLINE_DATA_FL
 0x10000000

	)

2193 
	#F2FS_PROJINHERIT_FL
 0x20000000

	)

2194 
	#F2FS_RESERVED_FL
 0x80000000

	)

2196 
	#F2FS_FL_USER_VISIBLE
 0x304BDFFF

	)

2197 
	#F2FS_FL_USER_MODIFIABLE
 0x204BC0FF

	)

2200 
	#F2FS_FL_XFLAG_VISIBLE
 (
F2FS_SYNC_FL
 | \

2201 
F2FS_IMMUTABLE_FL
 | \

2202 
F2FS_APPEND_FL
 | \

2203 
F2FS_NODUMP_FL
 | \

2204 
F2FS_NOATIME_FL
 | \

2205 
F2FS_PROJINHERIT_FL
)

	)

2208 
	#F2FS_FL_INHERITED
 (
F2FS_SECRM_FL
 | 
F2FS_UNRM_FL
 | 
F2FS_COMPR_FL
 |\

2209 
F2FS_SYNC_FL
 | 
F2FS_NODUMP_FL
 | 
F2FS_NOATIME_FL
 |\

2210 
F2FS_NOCOMPR_FL
 | 
F2FS_JOURNAL_DATA_FL
 |\

2211 
F2FS_NOTAIL_FL
 | 
F2FS_DIRSYNC_FL
 |\

2212 
F2FS_PROJINHERIT_FL
)

	)

2215 
	#F2FS_REG_FLMASK
 (~(
F2FS_DIRSYNC_FL
 | 
F2FS_TOPDIR_FL
))

	)

2218 
	#F2FS_OTHER_FLMASK
 (
F2FS_NODUMP_FL
 | 
F2FS_NOATIME_FL
)

	)

2220 
šlše
 
__u32
 
	$f2fs_mask_æags
(
umode_t
 
mode
, 
__u32
 
æags
)

2222 ià(
	`S_ISDIR
(
mode
))

2223  
æags
;

2224 ià(
	`S_ISREG
(
mode
))

2225  
æags
 & 
F2FS_REG_FLMASK
;

2227  
æags
 & 
F2FS_OTHER_FLMASK
;

2228 
	}
}

2232 
	mFI_NEW_INODE
,

2233 
	mFI_DIRTY_INODE
,

2234 
	mFI_AUTO_RECOVER
,

2235 
	mFI_DIRTY_DIR
,

2236 
	mFI_INC_LINK
,

2237 
	mFI_ACL_MODE
,

2238 
	mFI_NO_ALLOC
,

2239 
	mFI_FREE_NID
,

2240 
	mFI_NO_EXTENT
,

2241 
	mFI_INLINE_XATTR
,

2242 
	mFI_INLINE_DATA
,

2243 
	mFI_INLINE_DENTRY
,

2244 
	mFI_APPEND_WRITE
,

2245 
	mFI_UPDATE_WRITE
,

2246 
	mFI_NEED_IPU
,

2247 
	mFI_ATOMIC_FILE
,

2248 
	mFI_ATOMIC_COMMIT
,

2249 
	mFI_VOLATILE_FILE
,

2250 
	mFI_FIRST_BLOCK_WRITTEN
,

2251 
	mFI_DROP_CACHE
,

2252 
	mFI_DATA_EXIST
,

2253 
	mFI_INLINE_DOTS
,

2254 
	mFI_DO_DEFRAG
,

2255 
	mFI_DIRTY_FILE
,

2256 
	mFI_NO_PREALLOC
,

2257 
	mFI_HOT_DATA
,

2258 
	mFI_EXTRA_ATTR
,

2259 
	mFI_PROJ_INHERIT
,

2260 
	mFI_PIN_FILE
,

2261 
	mFI_ATOMIC_REVOKE_REQUEST
,

2264 
šlše
 
	$__m¬k_šode_dœty_æag
(
šode
 *inode,

2265 
æag
, 
boŞ
 
£t
)

2267 
æag
) {

2268 
FI_INLINE_XATTR
:

2269 
FI_INLINE_DATA
:

2270 
FI_INLINE_DENTRY
:

2271 
FI_NEW_INODE
:

2272 ià(
£t
)

2274 
FI_DATA_EXIST
:

2275 
FI_INLINE_DOTS
:

2276 
FI_PIN_FILE
:

2277 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2279 
	}
}

2281 
šlše
 
	$£t_šode_æag
(
šode
 *šode, 
æag
)

2283 ià(!
	`‹¡_b™
(
æag
, &
	`F2FS_I
(
šode
)->
æags
))

2284 
	`£t_b™
(
æag
, &
	`F2FS_I
(
šode
)->
æags
);

2285 
	`__m¬k_šode_dœty_æag
(
šode
, 
æag
, 
Œue
);

2286 
	}
}

2288 
šlše
 
	$is_šode_æag_£t
(
šode
 *šode, 
æag
)

2290  
	`‹¡_b™
(
æag
, &
	`F2FS_I
(
šode
)->
æags
);

2291 
	}
}

2293 
šlše
 
	$ş—r_šode_æag
(
šode
 *šode, 
æag
)

2295 ià(
	`‹¡_b™
(
æag
, &
	`F2FS_I
(
šode
)->
æags
))

2296 
	`ş—r_b™
(
æag
, &
	`F2FS_I
(
šode
)->
æags
);

2297 
	`__m¬k_šode_dœty_æag
(
šode
, 
æag
, 
çl£
);

2298 
	}
}

2300 
šlše
 
	$£t_aş_šode
(
šode
 *šode, 
umode_t
 
mode
)

2302 
	`F2FS_I
(
šode
)->
i_aş_mode
 = 
mode
;

2303 
	`£t_šode_æag
(
šode
, 
FI_ACL_MODE
);

2304 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

2305 
	}
}

2307 
šlše
 
	$f2fs_i_lšks_wr™e
(
šode
 *šode, 
boŞ
 
šc
)

2309 ià(
šc
)

2310 
	`šc_Æšk
(
šode
);

2312 
	`drİ_Æšk
(
šode
);

2313 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2314 
	}
}

2316 
šlše
 
	$f2fs_i_blocks_wr™e
(
šode
 *inode,

2317 
block_t
 
diff
, 
boŞ
 
add
, boŞ 
şaim
)

2319 
boŞ
 
ş—n
 = !
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
);

2320 
boŞ
 
»cov”
 = 
	`is_šode_æag_£t
(
šode
, 
FI_AUTO_RECOVER
);

2323 ià(
add
) {

2324 ià(
şaim
)

2325 
	`dquÙ_şaim_block
(
šode
, 
diff
);

2327 
	`dquÙ_®loc_block_noç
(
šode
, 
diff
);

2329 
	`dquÙ_ä“_block
(
šode
, 
diff
);

2332 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2333 ià(
ş—n
 || 
»cov”
)

2334 
	`£t_šode_æag
(
šode
, 
FI_AUTO_RECOVER
);

2335 
	}
}

2337 
šlše
 
	$f2fs_i_size_wr™e
(
šode
 *šode, 
loff_t
 
i_size
)

2339 
boŞ
 
ş—n
 = !
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
);

2340 
boŞ
 
»cov”
 = 
	`is_šode_æag_£t
(
šode
, 
FI_AUTO_RECOVER
);

2342 ià(
	`i_size_»ad
(
šode
è=ğ
i_size
)

2345 
	`i_size_wr™e
(
šode
, 
i_size
);

2346 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2347 ià(
ş—n
 || 
»cov”
)

2348 
	`£t_šode_æag
(
šode
, 
FI_AUTO_RECOVER
);

2349 
	}
}

2351 
šlše
 
	$f2fs_i_d•th_wr™e
(
šode
 *šode, 
d•th
)

2353 
	`F2FS_I
(
šode
)->
i_cu¼’t_d•th
 = 
d•th
;

2354 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2355 
	}
}

2357 
šlše
 
	$f2fs_i_gc_çu»s_wr™e
(
šode
 *inode,

2358 
couÁ
)

2360 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_PIN
] = 
couÁ
;

2361 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2362 
	}
}

2364 
šlše
 
	$f2fs_i_xnid_wr™e
(
šode
 *šode, 
nid_t
 
xnid
)

2366 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
 = 
xnid
;

2367 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2368 
	}
}

2370 
šlše
 
	$f2fs_i_pšo_wr™e
(
šode
 *šode, 
nid_t
 
pšo
)

2372 
	`F2FS_I
(
šode
)->
i_pšo
 = 
pšo
;

2373 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2374 
	}
}

2376 
šlše
 
	$g‘_šlše_šfo
(
šode
 *šode, 
f2fs_šode
 *
ri
)

2378 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

2380 ià(
ri
->
i_šlše
 & 
F2FS_INLINE_XATTR
)

2381 
	`£t_b™
(
FI_INLINE_XATTR
, &
fi
->
æags
);

2382 ià(
ri
->
i_šlše
 & 
F2FS_INLINE_DATA
)

2383 
	`£t_b™
(
FI_INLINE_DATA
, &
fi
->
æags
);

2384 ià(
ri
->
i_šlše
 & 
F2FS_INLINE_DENTRY
)

2385 
	`£t_b™
(
FI_INLINE_DENTRY
, &
fi
->
æags
);

2386 ià(
ri
->
i_šlše
 & 
F2FS_DATA_EXIST
)

2387 
	`£t_b™
(
FI_DATA_EXIST
, &
fi
->
æags
);

2388 ià(
ri
->
i_šlše
 & 
F2FS_INLINE_DOTS
)

2389 
	`£t_b™
(
FI_INLINE_DOTS
, &
fi
->
æags
);

2390 ià(
ri
->
i_šlše
 & 
F2FS_EXTRA_ATTR
)

2391 
	`£t_b™
(
FI_EXTRA_ATTR
, &
fi
->
æags
);

2392 ià(
ri
->
i_šlše
 & 
F2FS_PIN_FILE
)

2393 
	`£t_b™
(
FI_PIN_FILE
, &
fi
->
æags
);

2394 
	}
}

2396 
šlše
 
	$£t_¿w_šlše
(
šode
 *šode, 
f2fs_šode
 *
ri
)

2398 
ri
->
i_šlše
 = 0;

2400 ià(
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_XATTR
))

2401 
ri
->
i_šlše
 |ğ
F2FS_INLINE_XATTR
;

2402 ià(
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_DATA
))

2403 
ri
->
i_šlše
 |ğ
F2FS_INLINE_DATA
;

2404 ià(
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_DENTRY
))

2405 
ri
->
i_šlše
 |ğ
F2FS_INLINE_DENTRY
;

2406 ià(
	`is_šode_æag_£t
(
šode
, 
FI_DATA_EXIST
))

2407 
ri
->
i_šlše
 |ğ
F2FS_DATA_EXIST
;

2408 ià(
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_DOTS
))

2409 
ri
->
i_šlše
 |ğ
F2FS_INLINE_DOTS
;

2410 ià(
	`is_šode_æag_£t
(
šode
, 
FI_EXTRA_ATTR
))

2411 
ri
->
i_šlše
 |ğ
F2FS_EXTRA_ATTR
;

2412 ià(
	`is_šode_æag_£t
(
šode
, 
FI_PIN_FILE
))

2413 
ri
->
i_šlše
 |ğ
F2FS_PIN_FILE
;

2414 
	}
}

2416 
šlše
 
	$f2fs_has_exŒa_©Œ
(
šode
 *inode)

2418  
	`is_šode_æag_£t
(
šode
, 
FI_EXTRA_ATTR
);

2419 
	}
}

2421 
šlše
 
	$f2fs_has_šlše_x©Œ
(
šode
 *inode)

2423  
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_XATTR
);

2424 
	}
}

2426 
šlše
 
	$addrs_³r_šode
(
šode
 *inode)

2428  
	`CUR_ADDRS_PER_INODE
(
šode
è- 
	`g‘_šlše_x©Œ_addrs
(inode);

2429 
	}
}

2431 
šlše
 *
	$šlše_x©Œ_addr
(
šode
 *šode, 
·ge
 *page)

2433 
f2fs_šode
 *
ri
 = 
	`F2FS_INODE
(
·ge
);

2435  (*)&(
ri
->
i_addr
[
DEF_ADDRS_PER_INODE
 -

2436 
	`g‘_šlše_x©Œ_addrs
(
šode
)]);

2437 
	}
}

2439 
šlše
 
	$šlše_x©Œ_size
(
šode
 *inode)

2441  
	`g‘_šlše_x©Œ_addrs
(
šode
è* (
__Ë32
);

2442 
	}
}

2444 
šlše
 
	$f2fs_has_šlše_d©a
(
šode
 *inode)

2446  
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_DATA
);

2447 
	}
}

2449 
šlše
 
	$f2fs_exi¡_d©a
(
šode
 *inode)

2451  
	`is_šode_æag_£t
(
šode
, 
FI_DATA_EXIST
);

2452 
	}
}

2454 
šlše
 
	$f2fs_has_šlše_dÙs
(
šode
 *inode)

2456  
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_DOTS
);

2457 
	}
}

2459 
šlše
 
boŞ
 
	$f2fs_is_pšÃd_fe
(
šode
 *inode)

2461  
	`is_šode_æag_£t
(
šode
, 
FI_PIN_FILE
);

2462 
	}
}

2464 
šlše
 
boŞ
 
	$f2fs_is_©omic_fe
(
šode
 *inode)

2466  
	`is_šode_æag_£t
(
šode
, 
FI_ATOMIC_FILE
);

2467 
	}
}

2469 
šlše
 
boŞ
 
	$f2fs_is_comm™_©omic_wr™e
(
šode
 *inode)

2471  
	`is_šode_æag_£t
(
šode
, 
FI_ATOMIC_COMMIT
);

2472 
	}
}

2474 
šlše
 
boŞ
 
	$f2fs_is_vŞ©e_fe
(
šode
 *inode)

2476  
	`is_šode_æag_£t
(
šode
, 
FI_VOLATILE_FILE
);

2477 
	}
}

2479 
šlše
 
boŞ
 
	$f2fs_is_fœ¡_block_wr™‹n
(
šode
 *inode)

2481  
	`is_šode_æag_£t
(
šode
, 
FI_FIRST_BLOCK_WRITTEN
);

2482 
	}
}

2484 
šlše
 
boŞ
 
	$f2fs_is_drİ_ÿche
(
šode
 *inode)

2486  
	`is_šode_æag_£t
(
šode
, 
FI_DROP_CACHE
);

2487 
	}
}

2489 
šlše
 *
	$šlše_d©a_addr
(
šode
 *šode, 
·ge
 *page)

2491 
f2fs_šode
 *
ri
 = 
	`F2FS_INODE
(
·ge
);

2492 
exŒa_size
 = 
	`g‘_exŒa_isize
(
šode
);

2494  (*)&(
ri
->
i_addr
[
exŒa_size
 + 
DEF_INLINE_RESERVED_SIZE
]);

2495 
	}
}

2497 
šlše
 
	$f2fs_has_šlše_d’Œy
(
šode
 *inode)

2499  
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_DENTRY
);

2500 
	}
}

2502 
šlše
 
	$is_fe
(
šode
 *šode, 
ty³
)

2504  
	`F2FS_I
(
šode
)->
i_advi£
 & 
ty³
;

2505 
	}
}

2507 
šlše
 
	$£t_fe
(
šode
 *šode, 
ty³
)

2509 
	`F2FS_I
(
šode
)->
i_advi£
 |ğ
ty³
;

2510 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2511 
	}
}

2513 
šlše
 
	$ş—r_fe
(
šode
 *šode, 
ty³
)

2515 
	`F2FS_I
(
šode
)->
i_advi£
 &ğ~
ty³
;

2516 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2517 
	}
}

2519 
šlše
 
boŞ
 
	$f2fs_sk_šode_upd©e
(
šode
 *šode, 
dsync
)

2521 
time¥ec
 
ts
;

2522 
boŞ
 
»t
;

2524 ià(
dsync
) {

2525 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2527 
	`¥š_lock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

2528 
»t
 = 
	`li¡_em±y
(&
	`F2FS_I
(
šode
)->
gdœty_li¡
);

2529 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

2530  
»t
;

2532 ià(!
	`is_šode_æag_£t
(
šode
, 
FI_AUTO_RECOVER
) ||

2533 
	`fe_k“p_isize
(
šode
) ||

2534 
	`i_size_»ad
(
šode
è& ~
PAGE_MASK
)

2535  
çl£
;

2537 
ts
 = 
	`time¥ec64_to_time¥ec
(
šode
->
i_©ime
);

2538 ià(!
	`time¥ec_equ®
(
	`F2FS_I
(
šode
)->
i_disk_time
, &
ts
))

2539  
çl£
;

2540 
ts
 = 
	`time¥ec64_to_time¥ec
(
šode
->
i_ùime
);

2541 ià(!
	`time¥ec_equ®
(
	`F2FS_I
(
šode
)->
i_disk_time
 + 1, &
ts
))

2542  
çl£
;

2543 
ts
 = 
	`time¥ec64_to_time¥ec
(
šode
->
i_mtime
);

2544 ià(!
	`time¥ec_equ®
(
	`F2FS_I
(
šode
)->
i_disk_time
 + 2, &
ts
))

2545  
çl£
;

2546 ià(!
	`time¥ec_equ®
(
	`F2FS_I
(
šode
)->
i_disk_time
 + 3,

2547 &
	`F2FS_I
(
šode
)->
i_ütime
))

2548  
çl£
;

2550 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_£m
);

2551 
»t
 = 
	`F2FS_I
(
šode
)->
Ï¡_disk_size
 =ğ
	`i_size_»ad
(inode);

2552 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_£m
);

2554  
»t
;

2555 
	}
}

2557 
šlše
 
boŞ
 
	$f2fs_»adÚly
(
su³r_block
 *
sb
)

2559  
	`sb_rdÚly
(
sb
);

2560 
	}
}

2562 
šlše
 
boŞ
 
	$f2fs_ı_”rÜ
(
f2fs_sb_šfo
 *
sbi
)

2564  
	`is_£t_ck±_æags
(
sbi
, 
CP_ERROR_FLAG
);

2565 
	}
}

2567 
šlše
 
boŞ
 
	$is_dÙ_dÙdÙ
(cÚ¡ 
q¡r
 *
¡r
)

2569 ià(
¡r
->
Ën
 =ğ1 && sŒ->
Çme
[0] == '.')

2570  
Œue
;

2572 ià(
¡r
->
Ën
 =ğ2 && sŒ->
Çme
[0] == '.' && str->name[1] == '.')

2573  
Œue
;

2575  
çl£
;

2576 
	}
}

2578 
šlše
 
boŞ
 
	$f2fs_may_ex‹Á_Œ“
(
šode
 *inode)

2580 ià(!
	`‹¡_İt
(
	`F2FS_I_SB
(
šode
), 
EXTENT_CACHE
) ||

2581 
	`is_šode_æag_£t
(
šode
, 
FI_NO_EXTENT
))

2582  
çl£
;

2584  
	`S_ISREG
(
šode
->
i_mode
);

2585 
	}
}

2587 
šlše
 *
	$f2fs_km®loc
(
f2fs_sb_šfo
 *
sbi
,

2588 
size_t
 
size
, 
gå_t
 
æags
)

2590 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


2591 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_KMALLOC
)) {

2592 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_KMALLOC
);

2593  
NULL
;

2596  
	`km®loc
(
size
, 
æags
);

2597 
	}
}

2599 
šlše
 *
	$f2fs_kz®loc
(
f2fs_sb_šfo
 *
sbi
,

2600 
size_t
 
size
, 
gå_t
 
æags
)

2602  
	`f2fs_km®loc
(
sbi
, 
size
, 
æags
 | 
__GFP_ZERO
);

2603 
	}
}

2605 
šlše
 *
	$f2fs_kvm®loc
(
f2fs_sb_šfo
 *
sbi
,

2606 
size_t
 
size
, 
gå_t
 
æags
)

2608 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


2609 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_KVMALLOC
)) {

2610 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_KVMALLOC
);

2611  
NULL
;

2614  
	`kvm®loc
(
size
, 
æags
);

2615 
	}
}

2617 
šlše
 *
	$f2fs_kvz®loc
(
f2fs_sb_šfo
 *
sbi
,

2618 
size_t
 
size
, 
gå_t
 
æags
)

2620  
	`f2fs_kvm®loc
(
sbi
, 
size
, 
æags
 | 
__GFP_ZERO
);

2621 
	}
}

2623 
šlše
 
	$g‘_exŒa_isize
(
šode
 *inode)

2625  
	`F2FS_I
(
šode
)->
i_exŒa_isize
 / (
__Ë32
);

2626 
	}
}

2628 
šlše
 
	$g‘_šlše_x©Œ_addrs
(
šode
 *inode)

2630  
	`F2FS_I
(
šode
)->
i_šlše_x©Œ_size
;

2631 
	}
}

2633 
	#f2fs_g‘_šode_mode
(
i
) \

2634 ((
	`is_šode_æag_£t
(
i
, 
FI_ACL_MODE
)) ? \

2635 (
	`F2FS_I
(
i
)->
i_aş_mode
è: ((i)->
i_mode
))

	)

2637 
	#F2FS_TOTAL_EXTRA_ATTR_SIZE
 \

2638 (
	`off£tof
(
f2fs_šode
, 
i_exŒa_’d
) - \

2639 
	`off£tof
(
f2fs_šode
, 
i_exŒa_isize
)) \

2640 

	)

2641 
	#F2FS_OLD_ATTRIBUTE_SIZE
 (
	`off£tof
(
f2fs_šode
, 
i_addr
))

	)

2642 
	#F2FS_FITS_IN_INODE
(
f2fs_šode
, 
exŒa_isize
, 
f›ld
) \

2643 ((
	`off£tof
(
	`ty³of
(*
f2fs_šode
), 
f›ld
) + \

2644 ((
f2fs_šode
)->
f›ld
)) \

2645 <ğ(
F2FS_OLD_ATTRIBUTE_SIZE
 + 
exŒa_isize
)) \

2646 

	)

2647 
šlše
 
	$f2fs_»£t_io¡©
(
f2fs_sb_šfo
 *
sbi
)

2649 
i
;

2651 
	`¥š_lock
(&
sbi
->
io¡©_lock
);

2652 
i
 = 0; i < 
NR_IO_TYPE
; i++)

2653 
sbi
->
wr™e_io¡©
[
i
] = 0;

2654 
	`¥š_uÆock
(&
sbi
->
io¡©_lock
);

2655 
	}
}

2657 
šlše
 
	$f2fs_upd©e_io¡©
(
f2fs_sb_šfo
 *
sbi
,

2658 
io¡©_ty³
 
ty³
, 
io_by‹s
)

2660 ià(!
sbi
->
io¡©_’abË
)

2662 
	`¥š_lock
(&
sbi
->
io¡©_lock
);

2663 
sbi
->
wr™e_io¡©
[
ty³
] +ğ
io_by‹s
;

2665 ià(
ty³
 =ğ
APP_WRITE_IO
 ||y³ =ğ
APP_DIRECT_IO
)

2666 
sbi
->
wr™e_io¡©
[
APP_BUFFERED_IO
] =

2667 
sbi
->
wr™e_io¡©
[
APP_WRITE_IO
] -

2668 
sbi
->
wr™e_io¡©
[
APP_DIRECT_IO
];

2669 
	`¥š_uÆock
(&
sbi
->
io¡©_lock
);

2670 
	}
}

2672 
šlše
 
boŞ
 
	$is_v®id_blkaddr
(
block_t
 
blkaddr
)

2674 ià(
blkaddr
 =ğ
NEW_ADDR
 || blkadd¸=ğ
NULL_ADDR
)

2675  
çl£
;

2676  
Œue
;

2677 
	}
}

2682 
f2fs_sync_fe
(
fe
 *fe, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
);

2683 
f2fs_Œunÿ‹_d©a_blocks
(
dnode_of_d©a
 *
dn
);

2684 
f2fs_Œunÿ‹_blocks
(
šode
 *šode, 
u64
 
äom
, 
boŞ
 
lock
);

2685 
f2fs_Œunÿ‹
(
šode
 *inode);

2686 
f2fs_g‘©Œ
(cÚ¡ 
·th
 *·th, 
k¡©
 *
¡©
,

2687 
u32
 
»que¡_mask
, 
æags
);

2688 
f2fs_£‰r
(
d’Œy
 *d’Œy, 
Ÿ‰r
 *
©Œ
);

2689 
f2fs_Œunÿ‹_hŞe
(
šode
 *šode, 
pgoff_t
 
pg_¡¬t
,…goff_ˆ
pg_’d
);

2690 
f2fs_Œunÿ‹_d©a_blocks_¿nge
(
dnode_of_d©a
 *
dn
, 
couÁ
);

2691 
f2fs_´eÿche_ex‹Ás
(
šode
 *inode);

2692 
f2fs_ioùl
(
fe
 *
fp
, 
cmd
, 
¬g
);

2693 
f2fs_com·t_ioùl
(
fe
 *fe, 
cmd
, 
¬g
);

2694 
f2fs_pš_fe_cÚŒŞ
(
šode
 *šode, 
boŞ
 
šc
);

2699 
f2fs_£t_šode_æags
(
šode
 *inode);

2700 
boŞ
 
f2fs_šode_chksum_v”ify
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page);

2701 
f2fs_šode_chksum_£t
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page);

2702 
šode
 *
f2fs_ig‘
(
su³r_block
 *
sb
, 
šo
);

2703 
šode
 *
f2fs_ig‘_»Œy
(
su³r_block
 *
sb
, 
šo
);

2704 
f2fs_Œy_to_ä“_Çts
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
);

2705 
f2fs_upd©e_šode
(
šode
 *šode, 
·ge
 *
node_·ge
);

2706 
f2fs_upd©e_šode_·ge
(
šode
 *inode);

2707 
f2fs_wr™e_šode
(
šode
 *šode, 
wr™eback_cÚŒŞ
 *
wbc
);

2708 
f2fs_eviù_šode
(
šode
 *inode);

2709 
f2fs_hªdË_çed_šode
(
šode
 *inode);

2714 
f2fs_upd©e_ex‹nsiÚ_li¡
(
f2fs_sb_šfo
 *
sbi
, cÚ¡ *
Çme
,

2715 
boŞ
 
hÙ
, boŞ 
£t
);

2716 
d’Œy
 *
f2fs_g‘_·»Á
(d’Œy *
chd
);

2721 
f2fs_g‘_de_ty³
(
f2fs_dœ_’Œy
 *
de
);

2722 
f2fs_dœ_’Œy
 *
f2fs_fšd_rg‘_d’Œy
(
fsüy±_Çme
 *
âame
,

2723 
f2fs_hash_t
 
Çmehash
, *
max_¦Ùs
,

2724 
f2fs_d’Œy_±r
 *
d
);

2725 
f2fs_fl_d’Œ›s
(
dœ_cÚ‹xt
 *
ùx
, 
f2fs_d’Œy_±r
 *
d
,

2726 
¡¬t_pos
, 
fsüy±_¡r
 *
f¡r
);

2727 
f2fs_do_make_em±y_dœ
(
šode
 *šode, šod*
·»Á
,

2728 
f2fs_d’Œy_±r
 *
d
);

2729 
·ge
 *
f2fs_š™_šode_m‘ad©a
(
šode
 *šode, šod*
dœ
,

2730 cÚ¡ 
q¡r
 *
Ãw_Çme
,

2731 cÚ¡ 
q¡r
 *
Üig_Çme
, 
·ge
 *
d·ge
);

2732 
f2fs_upd©e_·»Á_m‘ad©a
(
šode
 *
dœ
, inode *inode,

2733 
cu¼’t_d•th
);

2734 
f2fs_room_fÜ_f’ame
(cÚ¡ *
b™m­
, 
¦Ùs
, 
max_¦Ùs
);

2735 
f2fs_drİ_Æšk
(
šode
 *
dœ
, inode *inode);

2736 
f2fs_dœ_’Œy
 *
__f2fs_fšd_’Œy
(
šode
 *
dœ
,

2737 
fsüy±_Çme
 *
âame
, 
·ge
 **
»s_·ge
);

2738 
f2fs_dœ_’Œy
 *
f2fs_fšd_’Œy
(
šode
 *
dœ
,

2739 cÚ¡ 
q¡r
 *
chd
, 
·ge
 **
»s_·ge
);

2740 
f2fs_dœ_’Œy
 *
f2fs_·»Á_dœ
(
šode
 *
dœ
, 
·ge
 **
p
);

2741 
šo_t
 
f2fs_šode_by_Çme
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *qstr,

2742 
·ge
 **page);

2743 
f2fs_£t_lšk
(
šode
 *
dœ
, 
f2fs_dœ_’Œy
 *
de
,

2744 
·ge
 *·ge, 
šode
 *inode);

2745 
f2fs_upd©e_d’Œy
(
nid_t
 
šo
, 
umode_t
 
mode
, 
f2fs_d’Œy_±r
 *
d
,

2746 cÚ¡ 
q¡r
 *
Çme
, 
f2fs_hash_t
 
Çme_hash
,

2747 
b™_pos
);

2748 
f2fs_add_»guÏr_’Œy
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Ãw_Çme
,

2749 cÚ¡ 
q¡r
 *
Üig_Çme
,

2750 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
);

2751 
f2fs_add_d’Œy
(
šode
 *
dœ
, 
fsüy±_Çme
 *
âame
,

2752 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
);

2753 
f2fs_do_add_lšk
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Çme
,

2754 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
);

2755 
f2fs_d–‘e_’Œy
(
f2fs_dœ_’Œy
 *
d’Œy
, 
·ge
 *page,

2756 
šode
 *
dœ
, inode *inode);

2757 
f2fs_do_tmpfe
(
šode
 *šode, šod*
dœ
);

2758 
boŞ
 
f2fs_em±y_dœ
(
šode
 *
dœ
);

2760 
šlše
 
	$f2fs_add_lšk
(
d’Œy
 *d’Œy, 
šode
 *inode)

2762  
	`f2fs_do_add_lšk
(
	`d_šode
(
d’Œy
->
d_·»Á
), &d’Œy->
d_Çme
,

2763 
šode
, inode->
i_šo
, inode->
i_mode
);

2764 
	}
}

2769 
f2fs_šode_dœt›d
(
šode
 *šode, 
boŞ
 
sync
);

2770 
f2fs_šode_synûd
(
šode
 *inode);

2771 
f2fs_’abË_quÙa_fes
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
rdÚly
);

2772 
f2fs_quÙa_off_umouÁ
(
su³r_block
 *
sb
);

2773 
f2fs_comm™_su³r
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
»cov”
);

2774 
f2fs_sync_fs
(
su³r_block
 *
sb
, 
sync
);

2775 
	$__´štf
(3, 4)

2776 
	`f2fs_msg
(
su³r_block
 *
sb
, cÚ¡ *
Ëv–
, cÚ¡ *
fmt
, ...);

2777 
	`f2fs_§n™y_check_ck±
(
f2fs_sb_šfo
 *
sbi
);

2782 
f2fs_hash_t
 
	`f2fs_d’Œy_hash
(cÚ¡ 
q¡r
 *
Çme_šfo
,

2783 
fsüy±_Çme
 *
âame
);

2788 
dnode_of_d©a
;

2789 
node_šfo
;

2791 
	`f2fs_check_nid_¿nge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
);

2792 
boŞ
 
	`f2fs_avaabË_ä“_memÜy
(
f2fs_sb_šfo
 *
sbi
, 
ty³
);

2793 
	`f2fs_Ãed_d’Œy_m¬k
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
);

2794 
boŞ
 
	`f2fs_is_checkpoš‹d_node
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
);

2795 
boŞ
 
	`f2fs_Ãed_šode_block_upd©e
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
);

2796 
	`f2fs_g‘_node_šfo
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
,

2797 
node_šfo
 *
ni
);

2798 
pgoff_t
 
	`f2fs_g‘_Ãxt_·ge_off£t
(
dnode_of_d©a
 *
dn
,…goff_ˆ
pgofs
);

2799 
	`f2fs_g‘_dnode_of_d©a
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
, 
mode
);

2800 
	`f2fs_Œunÿ‹_šode_blocks
(
šode
 *šode, 
pgoff_t
 
äom
);

2801 
	`f2fs_Œunÿ‹_x©Œ_node
(
šode
 *inode);

2802 
	`f2fs_wa™_Ú_node_·ges_wr™eback
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
);

2803 
	`f2fs_»move_šode_·ge
(
šode
 *inode);

2804 
·ge
 *
	`f2fs_Ãw_šode_·ge
(
šode
 *inode);

2805 
·ge
 *
	`f2fs_Ãw_node_·ge
(
dnode_of_d©a
 *
dn
, 
ofs
);

2806 
	`f2fs_¿_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
);

2807 
·ge
 *
	`f2fs_g‘_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
nid
);

2808 
·ge
 *
	`f2fs_g‘_node_·ge_¿
(·g*
·»Á
, 
¡¬t
);

2809 
	`f2fs_move_node_·ge
(
·ge
 *
node_·ge
, 
gc_ty³
);

2810 
	`f2fs_fsync_node_·ges
(
f2fs_sb_šfo
 *
sbi
, 
šode
 *inode,

2811 
wr™eback_cÚŒŞ
 *
wbc
, 
boŞ
 
©omic
);

2812 
	`f2fs_sync_node_·ges
(
f2fs_sb_šfo
 *
sbi
,

2813 
wr™eback_cÚŒŞ
 *
wbc
,

2814 
boŞ
 
do_b®ªû
, 
io¡©_ty³
 
io_ty³
);

2815 
	`f2fs_bud_ä“_nids
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
sync
, boŞ 
mouÁ
);

2816 
boŞ
 
	`f2fs_®loc_nid
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 *
nid
);

2817 
	`f2fs_®loc_nid_dÚe
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
);

2818 
	`f2fs_®loc_nid_çed
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
);

2819 
	`f2fs_Œy_to_ä“_nids
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
);

2820 
	`f2fs_»cov”_šlše_x©Œ
(
šode
 *šode, 
·ge
 *page);

2821 
	`f2fs_»cov”_x©Œ_d©a
(
šode
 *šode, 
·ge
 *page);

2822 
	`f2fs_»cov”_šode_·ge
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page);

2823 
	`f2fs_»¡Üe_node_summ¬y
(
f2fs_sb_šfo
 *
sbi
,

2824 
£gno
, 
f2fs_summ¬y_block
 *
sum
);

2825 
	`f2fs_æush_Çt_’Œ›s
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
);

2826 
	`f2fs_bud_node_mªag”
(
f2fs_sb_šfo
 *
sbi
);

2827 
	`f2fs_de¡roy_node_mªag”
(
f2fs_sb_šfo
 *
sbi
);

2828 
__š™
 
	`f2fs_ü—‹_node_mªag”_ÿches
();

2829 
	`f2fs_de¡roy_node_mªag”_ÿches
();

2834 
boŞ
 
	`f2fs_Ãed_SSR
(
f2fs_sb_šfo
 *
sbi
);

2835 
	`f2fs_»gi¡”_šmem_·ge
(
šode
 *šode, 
·ge
 *page);

2836 
	`f2fs_drİ_šmem_·ges_®l
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
gc_çu»
);

2837 
	`f2fs_drİ_šmem_·ges
(
šode
 *inode);

2838 
	`f2fs_drİ_šmem_·ge
(
šode
 *šode, 
·ge
 *page);

2839 
	`f2fs_comm™_šmem_·ges
(
šode
 *inode);

2840 
	`f2fs_b®ªû_fs
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
Ãed
);

2841 
	`f2fs_b®ªû_fs_bg
(
f2fs_sb_šfo
 *
sbi
);

2842 
	`f2fs_issue_æush
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
);

2843 
	`f2fs_ü—‹_æush_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
);

2844 
	`f2fs_æush_deviû_ÿche
(
f2fs_sb_šfo
 *
sbi
);

2845 
	`f2fs_de¡roy_æush_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
ä“
);

2846 
	`f2fs_šv®id©e_blocks
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
addr
);

2847 
boŞ
 
	`f2fs_is_checkpoš‹d_d©a
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
);

2848 
	`f2fs_drİ_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
);

2849 
	`f2fs_¡İ_disÿrd_th»ad
(
f2fs_sb_šfo
 *
sbi
);

2850 
boŞ
 
	`f2fs_wa™_disÿrd_bios
(
f2fs_sb_šfo
 *
sbi
);

2851 
	`f2fs_ş—r_´eä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
,

2852 
ı_cÚŒŞ
 *
ıc
);

2853 
	`f2fs_»Ëa£_disÿrd_addrs
(
f2fs_sb_šfo
 *
sbi
);

2854 
	`f2fs_Åages_fÜ_summ¬y_æush
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
fÜ_¿
);

2855 
	`f2fs_®loÿ‹_Ãw_£gm’ts
(
f2fs_sb_šfo
 *
sbi
);

2856 
	`f2fs_Œim_fs
(
f2fs_sb_šfo
 *
sbi
, 
f¡rim_¿nge
 *
¿nge
);

2857 
boŞ
 
	`f2fs_exi¡_Œim_ÿndid©es
(
f2fs_sb_šfo
 *
sbi
,

2858 
ı_cÚŒŞ
 *
ıc
);

2859 
·ge
 *
	`f2fs_g‘_sum_·ge
(
f2fs_sb_šfo
 *
sbi
, 
£gno
);

2860 
	`f2fs_upd©e_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, *
¤c
,

2861 
block_t
 
blk_addr
);

2862 
	`f2fs_do_wr™e_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

2863 
io¡©_ty³
 
io_ty³
);

2864 
	`f2fs_do_wr™e_node_·ge
(
nid
, 
f2fs_io_šfo
 *
fio
);

2865 
	`f2fs_ouÏû_wr™e_d©a
(
dnode_of_d©a
 *
dn
,

2866 
f2fs_io_šfo
 *
fio
);

2867 
	`f2fs_š¶aû_wr™e_d©a
(
f2fs_io_šfo
 *
fio
);

2868 
	`f2fs_do_»¶aû_block
(
f2fs_sb_šfo
 *
sbi
, 
f2fs_summ¬y
 *
sum
,

2869 
block_t
 
Şd_blkaddr
, block_ˆ
Ãw_blkaddr
,

2870 
boŞ
 
»cov”_cur£g
, boŞ 
»cov”_Ãwaddr
);

2871 
	`f2fs_»¶aû_block
(
f2fs_sb_šfo
 *
sbi
, 
dnode_of_d©a
 *
dn
,

2872 
block_t
 
Şd_addr
, block_ˆ
Ãw_addr
,

2873 
v”siÚ
, 
boŞ
 
»cov”_cur£g
,

2874 
boŞ
 
»cov”_Ãwaddr
);

2875 
	`f2fs_®loÿ‹_d©a_block
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

2876 
block_t
 
Şd_blkaddr
, block_ˆ*
Ãw_blkaddr
,

2877 
f2fs_summ¬y
 *
sum
, 
ty³
,

2878 
f2fs_io_šfo
 *
fio
, 
boŞ
 
add_li¡
);

2879 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
 *page,

2880 
·ge_ty³
 
ty³
, 
boŞ
 
Üd”ed
);

2881 
	`f2fs_wa™_Ú_block_wr™eback
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
);

2882 
	`f2fs_wr™e_d©a_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
);

2883 
	`f2fs_wr™e_node_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
);

2884 
	`f2fs_lookup_jouº®_š_cursum
(
f2fs_jouº®
 *
jouº®
, 
ty³
,

2885 
v®
, 
®loc
);

2886 
	`f2fs_æush_s™_’Œ›s
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
);

2887 
	`f2fs_bud_£gm’t_mªag”
(
f2fs_sb_šfo
 *
sbi
);

2888 
	`f2fs_de¡roy_£gm’t_mªag”
(
f2fs_sb_šfo
 *
sbi
);

2889 
__š™
 
	`f2fs_ü—‹_£gm’t_mªag”_ÿches
();

2890 
	`f2fs_de¡roy_£gm’t_mªag”_ÿches
();

2891 
	`f2fs_rw_hšt_to_£g_ty³
(
rw_hšt
 
hšt
);

2892 
rw_hšt
 
	`f2fs_io_ty³_to_rw_hšt
(
f2fs_sb_šfo
 *
sbi
,

2893 
·ge_ty³
 
ty³
, 
‹mp_ty³
 
‹mp
);

2898 
	`f2fs_¡İ_checkpošt
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
’d_io
);

2899 
·ge
 *
	`f2fs_g¿b_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
);

2900 
·ge
 *
	`f2fs_g‘_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
);

2901 
·ge
 *
	`f2fs_g‘_tmp_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
);

2902 
boŞ
 
	`f2fs_is_v®id_m‘a_blkaddr
(
f2fs_sb_šfo
 *
sbi
,

2903 
block_t
 
blkaddr
, 
ty³
);

2904 
	`f2fs_¿_m‘a_·ges
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t
, 
Ä·ges
,

2905 
ty³
, 
boŞ
 
sync
);

2906 
	`f2fs_¿_m‘a_·ges_cÚd
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
);

2907 
	`f2fs_sync_m‘a_·ges
(
f2fs_sb_šfo
 *
sbi
, 
·ge_ty³
 
ty³
,

2908 
Ä_to_wr™e
, 
io¡©_ty³
 
io_ty³
);

2909 
	`f2fs_add_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
);

2910 
	`f2fs_»move_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
);

2911 
	`f2fs_»Ëa£_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
®l
);

2912 
boŞ
 
	`f2fs_exi¡_wr™‹n_d©a
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
mode
);

2913 
	`f2fs_£t_dœty_deviû
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
,

2914 
devidx
, 
ty³
);

2915 
boŞ
 
	`f2fs_is_dœty_deviû
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
,

2916 
devidx
, 
ty³
);

2917 
	`f2fs_sync_šode_m‘a
(
f2fs_sb_šfo
 *
sbi
);

2918 
	`f2fs_acquœe_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
);

2919 
	`f2fs_»Ëa£_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
);

2920 
	`f2fs_add_Üphª_šode
(
šode
 *inode);

2921 
	`f2fs_»move_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
);

2922 
	`f2fs_»cov”_Üphª_šodes
(
f2fs_sb_šfo
 *
sbi
);

2923 
	`f2fs_g‘_v®id_checkpošt
(
f2fs_sb_šfo
 *
sbi
);

2924 
	`f2fs_upd©e_dœty_·ge
(
šode
 *šode, 
·ge
 *page);

2925 
	`f2fs_»move_dœty_šode
(
šode
 *inode);

2926 
	`f2fs_sync_dœty_šodes
(
f2fs_sb_šfo
 *
sbi
, 
šode_ty³
 
ty³
);

2927 
	`f2fs_wr™e_checkpošt
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
);

2928 
	`f2fs_š™_šo_’Œy_šfo
(
f2fs_sb_šfo
 *
sbi
);

2929 
__š™
 
	`f2fs_ü—‹_checkpošt_ÿches
();

2930 
	`f2fs_de¡roy_checkpošt_ÿches
();

2935 
	`f2fs_š™_po¡_»ad_´oûssšg
();

2936 
	`f2fs_de¡roy_po¡_»ad_´oûssšg
();

2937 
	`f2fs_subm™_m”ged_wr™e
(
f2fs_sb_šfo
 *
sbi
, 
·ge_ty³
 
ty³
);

2938 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
f2fs_sb_šfo
 *
sbi
,

2939 
šode
 *šode, 
nid_t
 
šo
, 
pgoff_t
 
idx
,

2940 
·ge_ty³
 
ty³
);

2941 
	`f2fs_æush_m”ged_wr™es
(
f2fs_sb_šfo
 *
sbi
);

2942 
	`f2fs_subm™_·ge_bio
(
f2fs_io_šfo
 *
fio
);

2943 
	`f2fs_subm™_·ge_wr™e
(
f2fs_io_šfo
 *
fio
);

2944 
block_deviû
 *
	`f2fs_rg‘_deviû
(
f2fs_sb_šfo
 *
sbi
,

2945 
block_t
 
blk_addr
, 
bio
 *bio);

2946 
	`f2fs_rg‘_deviû_šdex
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
);

2947 
	`f2fs_£t_d©a_blkaddr
(
dnode_of_d©a
 *
dn
);

2948 
	`f2fs_upd©e_d©a_blkaddr
(
dnode_of_d©a
 *
dn
, 
block_t
 
blkaddr
);

2949 
	`f2fs_»£rve_Ãw_blocks
(
dnode_of_d©a
 *
dn
, 
blkút_t
 
couÁ
);

2950 
	`f2fs_»£rve_Ãw_block
(
dnode_of_d©a
 *
dn
);

2951 
	`f2fs_g‘_block
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
);

2952 
	`f2fs_´—Îoÿ‹_blocks
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
);

2953 
	`f2fs_»£rve_block
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
);

2954 
·ge
 *
	`f2fs_g‘_»ad_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
,

2955 
İ_æags
, 
boŞ
 
fÜ_wr™e
);

2956 
·ge
 *
	`f2fs_fšd_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
);

2957 
·ge
 *
	`f2fs_g‘_lock_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
,

2958 
boŞ
 
fÜ_wr™e
);

2959 
·ge
 *
	`f2fs_g‘_Ãw_d©a_·ge
(
šode
 *inode,

2960 
·ge
 *
age
, 
pgoff_t
 
šdex
, 
boŞ
 
Ãw_i_size
);

2961 
	`f2fs_do_wr™e_d©a_·ge
(
f2fs_io_šfo
 *
fio
);

2962 
	`f2fs_m­_blocks
(
šode
 *šode, 
f2fs_m­_blocks
 *
m­
,

2963 
ü—‹
, 
æag
);

2964 
	`f2fs_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

2965 
u64
 
¡¬t
, u64 
Ën
);

2966 
boŞ
 
	`f2fs_should_upd©e_š¶aû
(
šode
 *šode, 
f2fs_io_šfo
 *
fio
);

2967 
boŞ
 
	`f2fs_should_upd©e_ouÏû
(
šode
 *šode, 
f2fs_io_šfo
 *
fio
);

2968 
	`f2fs_šv®id©e_·ge
(
·ge
 *·ge, 
off£t
,

2969 
Ëngth
);

2970 
	`f2fs_»Ëa£_·ge
(
·ge
 *·ge, 
gå_t
 
wa™
);

2971 #ifdeà
CONFIG_MIGRATION


2972 
	`f2fs_mig¿‹_·ge
(
add»ss_¥aû
 *
m­pšg
, 
·ge
 *
Ãw·ge
,

2973 
·ge
 *·ge, 
mig¿‹_mode
 
mode
);

2975 
boŞ
 
	`f2fs_ov”wr™e_io
(
šode
 *šode, 
loff_t
 
pos
, 
size_t
 
Ën
);

2976 
	`f2fs_ş—r_¿dix_Œ“_dœty_g
(
·ge
 *page);

2981 
	`f2fs_¡¬t_gc_th»ad
(
f2fs_sb_šfo
 *
sbi
);

2982 
	`f2fs_¡İ_gc_th»ad
(
f2fs_sb_šfo
 *
sbi
);

2983 
block_t
 
	`f2fs_¡¬t_bidx_of_node
(
node_ofs
, 
šode
 *inode);

2984 
	`f2fs_gc
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
sync
, boŞ 
background
,

2985 
£gno
);

2986 
	`f2fs_bud_gc_mªag”
(
f2fs_sb_šfo
 *
sbi
);

2991 
	`f2fs_»cov”_fsync_d©a
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
check_Úly
);

2992 
boŞ
 
	`f2fs_¥aû_fÜ_rŞl_fÜw¬d
(
f2fs_sb_šfo
 *
sbi
);

2997 #ifdeà
CONFIG_F2FS_STAT_FS


2998 
	sf2fs_¡©_šfo
 {

2999 
li¡_h—d
 
¡©_li¡
;

3000 
f2fs_sb_šfo
 *
sbi
;

3001 
®l_¬—_£gs
, 
s™_¬—_£gs
, 
Çt_¬—_£gs
, 
s§_¬—_£gs
;

3002 
maš_¬—_£gs
, 
maš_¬—_£ùiÚs
, 
maš_¬—_zÚes
;

3003 
h™_Ïrge¡
, 
h™_ÿched
, 
h™_rbŒ“
;

3004 
h™_tÙ®
, 
tÙ®_ext
;

3005 
ext_Œ“
, 
zomb›_Œ“
, 
ext_node
;

3006 
ndœty_node
, 
ndœty_d’t
, 
ndœty_m‘a
, 
ndœty_im‘a
;

3007 
ndœty_d©a
, 
ndœty_qd©a
;

3008 
šmem_·ges
;

3009 
ndœty_dœs
, 
ndœty_fes
, 
nquÙa_fes
, 
ndœty_®l
;

3010 
Çts
, 
dœty_Çts
, 
s™s
, 
dœty_s™s
;

3011 
ä“_nids
, 
ava_nids
, 
®loc_nids
;

3012 
tÙ®_couÁ
, 
utiz©iÚ
;

3013 
bg_gc
, 
Ä_wb_ı_d©a
, 
Ä_wb_d©a
;

3014 
Ä_æushšg
, 
Ä_æushed
, 
æush_li¡_em±y
;

3015 
Ä_disÿrdšg
, 
Ä_disÿrded
;

3016 
Ä_disÿrd_cmd
;

3017 
undisÿrd_blks
;

3018 
šlše_x©Œ
, 
šlše_šode
, 
šlše_dœ
, 
­³nd
, 
upd©e
, 
Üphªs
;

3019 
aw_út
, 
max_aw_út
, 
vw_út
, 
max_vw_út
;

3020 
v®id_couÁ
, 
v®id_node_couÁ
, 
v®id_šode_couÁ
, 
disÿrd_blks
;

3021 
bimod®
, 
avg_vblocks
;

3022 
ut_ä“
, 
ut_v®id
, 
ut_šv®id
;

3023 
rsvd_£gs
, 
ov”p_£gs
;

3024 
dœty_couÁ
, 
node_·ges
, 
m‘a_·ges
;

3025 
´eä“_couÁ
, 
ÿÎ_couÁ
, 
ı_couÁ
, 
bg_ı_couÁ
;

3026 
tÙ_£gs
, 
node_£gs
, 
d©a_£gs
, 
ä“_£gs
, 
ä“_£cs
;

3027 
bg_node_£gs
, 
bg_d©a_£gs
;

3028 
tÙ_blks
, 
d©a_blks
, 
node_blks
;

3029 
bg_d©a_blks
, 
bg_node_blks
;

3030 
sk³d_©omic_fes
[2];

3031 
cur£g
[
NR_CURSEG_TYPE
];

3032 
cur£c
[
NR_CURSEG_TYPE
];

3033 
curzÚe
[
NR_CURSEG_TYPE
];

3035 
£gm’t_couÁ
[2];

3036 
block_couÁ
[2];

3037 
š¶aû_couÁ
;

3038 
ba£_mem
, 
ÿche_mem
, 
·ge_mem
;

3041 
šlše
 
f2fs_¡©_šfo
 *
	$F2FS_STAT
(
f2fs_sb_šfo
 *
sbi
)

3043  (
f2fs_¡©_šfo
 *)
sbi
->
¡©_šfo
;

3044 
	}
}

3046 
	#¡©_šc_ı_couÁ
(
si
è((si)->
ı_couÁ
++)

	)

3047 
	#¡©_šc_bg_ı_couÁ
(
si
è((si)->
bg_ı_couÁ
++)

	)

3048 
	#¡©_šc_ÿÎ_couÁ
(
si
è((si)->
ÿÎ_couÁ
++)

	)

3049 
	#¡©_šc_bggc_couÁ
(
sbi
è((sbi)->
bg_gc
++)

	)

3050 
	#¡©_šc_dœty_šode
(
sbi
, 
ty³
è((sbi)->
ndœty_šode
[ty³]++)

	)

3051 
	#¡©_dec_dœty_šode
(
sbi
, 
ty³
è((sbi)->
ndœty_šode
[ty³]--)

	)

3052 
	#¡©_šc_tÙ®_h™
(
sbi
è(
	`©omic64_šc
(&(sbi)->
tÙ®_h™_ext
))

	)

3053 
	#¡©_šc_rbŒ“_node_h™
(
sbi
è(
	`©omic64_šc
(&(sbi)->
»ad_h™_rbŒ“
))

	)

3054 
	#¡©_šc_Ïrge¡_node_h™
(
sbi
è(
	`©omic64_šc
(&(sbi)->
»ad_h™_Ïrge¡
))

	)

3055 
	#¡©_šc_ÿched_node_h™
(
sbi
è(
	`©omic64_šc
(&(sbi)->
»ad_h™_ÿched
))

	)

3056 
	#¡©_šc_šlše_x©Œ
(
šode
) \

3058 ià(
	`f2fs_has_šlše_x©Œ
(
šode
)) \

3059 (
	`©omic_šc
(&
	`F2FS_I_SB
(
šode
)->
šlše_x©Œ
)); \

3060 } 0)

	)

3061 
	#¡©_dec_šlše_x©Œ
(
šode
) \

3063 ià(
	`f2fs_has_šlše_x©Œ
(
šode
)) \

3064 (
	`©omic_dec
(&
	`F2FS_I_SB
(
šode
)->
šlše_x©Œ
)); \

3065 } 0)

	)

3066 
	#¡©_šc_šlše_šode
(
šode
) \

3068 ià(
	`f2fs_has_šlše_d©a
(
šode
)) \

3069 (
	`©omic_šc
(&
	`F2FS_I_SB
(
šode
)->
šlše_šode
)); \

3070 } 0)

	)

3071 
	#¡©_dec_šlše_šode
(
šode
) \

3073 ià(
	`f2fs_has_šlše_d©a
(
šode
)) \

3074 (
	`©omic_dec
(&
	`F2FS_I_SB
(
šode
)->
šlše_šode
)); \

3075 } 0)

	)

3076 
	#¡©_šc_šlše_dœ
(
šode
) \

3078 ià(
	`f2fs_has_šlše_d’Œy
(
šode
)) \

3079 (
	`©omic_šc
(&
	`F2FS_I_SB
(
šode
)->
šlše_dœ
)); \

3080 } 0)

	)

3081 
	#¡©_dec_šlše_dœ
(
šode
) \

3083 ià(
	`f2fs_has_šlše_d’Œy
(
šode
)) \

3084 (
	`©omic_dec
(&
	`F2FS_I_SB
(
šode
)->
šlše_dœ
)); \

3085 } 0)

	)

3086 
	#¡©_šc_£g_ty³
(
sbi
, 
cur£g
) \

3087 ((
sbi
)->
£gm’t_couÁ
[(
cur£g
)->
®loc_ty³
]++)

	)

3088 
	#¡©_šc_block_couÁ
(
sbi
, 
cur£g
) \

3089 ((
sbi
)->
block_couÁ
[(
cur£g
)->
®loc_ty³
]++)

	)

3090 
	#¡©_šc_š¶aû_blocks
(
sbi
) \

3091 (
	`©omic_šc
(&(
sbi
)->
š¶aû_couÁ
))

	)

3092 
	#¡©_šc_©omic_wr™e
(
šode
) \

3093 (
	`©omic_šc
(&
	`F2FS_I_SB
(
šode
)->
aw_út
))

	)

3094 
	#¡©_dec_©omic_wr™e
(
šode
) \

3095 (
	`©omic_dec
(&
	`F2FS_I_SB
(
šode
)->
aw_út
))

	)

3096 
	#¡©_upd©e_max_©omic_wr™e
(
šode
) \

3098 
cur
 = 
	`©omic_»ad
(&
	`F2FS_I_SB
(
šode
)->
aw_út
); \

3099 
max
 = 
	`©omic_»ad
(&
	`F2FS_I_SB
(
šode
)->
max_aw_út
); \

3100 ià(
cur
 > 
max
) \

3101 
	`©omic_£t
(&
	`F2FS_I_SB
(
šode
)->
max_aw_út
, 
cur
); \

3102 } 0)

	)

3103 
	#¡©_šc_vŞ©e_wr™e
(
šode
) \

3104 (
	`©omic_šc
(&
	`F2FS_I_SB
(
šode
)->
vw_út
))

	)

3105 
	#¡©_dec_vŞ©e_wr™e
(
šode
) \

3106 (
	`©omic_dec
(&
	`F2FS_I_SB
(
šode
)->
vw_út
))

	)

3107 
	#¡©_upd©e_max_vŞ©e_wr™e
(
šode
) \

3109 
cur
 = 
	`©omic_»ad
(&
	`F2FS_I_SB
(
šode
)->
vw_út
); \

3110 
max
 = 
	`©omic_»ad
(&
	`F2FS_I_SB
(
šode
)->
max_vw_út
); \

3111 ià(
cur
 > 
max
) \

3112 
	`©omic_£t
(&
	`F2FS_I_SB
(
šode
)->
max_vw_út
, 
cur
); \

3113 } 0)

	)

3114 
	#¡©_šc_£g_couÁ
(
sbi
, 
ty³
, 
gc_ty³
) \

3116 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
); \

3117 
si
->
tÙ_£gs
++; \

3118 ià((
ty³
è=ğ
SUM_TYPE_DATA
) { \

3119 
si
->
d©a_£gs
++; \

3120 
si
->
bg_d©a_£gs
 +ğ(
gc_ty³
 =ğ
BG_GC
) ? 1 : 0; \

3122 
si
->
node_£gs
++; \

3123 
si
->
bg_node_£gs
 +ğ(
gc_ty³
 =ğ
BG_GC
) ? 1 : 0; \

3125 } 0)

	)

3127 
	#¡©_šc_tÙ_blk_couÁ
(
si
, 
blks
) \

3128 ((
si
)->
tÙ_blks
 +ğ(
blks
))

	)

3130 
	#¡©_šc_d©a_blk_couÁ
(
sbi
, 
blks
, 
gc_ty³
) \

3132 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
); \

3133 
	`¡©_šc_tÙ_blk_couÁ
(
si
, 
blks
); \

3134 
si
->
d©a_blks
 +ğ(
blks
); \

3135 
si
->
bg_d©a_blks
 +ğ((
gc_ty³
è=ğ
BG_GC
è? (
blks
) : 0; \

3136 } 0)

	)

3138 
	#¡©_šc_node_blk_couÁ
(
sbi
, 
blks
, 
gc_ty³
) \

3140 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
); \

3141 
	`¡©_šc_tÙ_blk_couÁ
(
si
, 
blks
); \

3142 
si
->
node_blks
 +ğ(
blks
); \

3143 
si
->
bg_node_blks
 +ğ((
gc_ty³
è=ğ
BG_GC
è? (
blks
) : 0; \

3144 } 0)

	)

3146 
f2fs_bud_¡©s
(
f2fs_sb_šfo
 *
sbi
);

3147 
f2fs_de¡roy_¡©s
(
f2fs_sb_šfo
 *
sbi
);

3148 
__š™
 
f2fs_ü—‹_roÙ_¡©s
();

3149 
f2fs_de¡roy_roÙ_¡©s
();

3151 
	#¡©_šc_ı_couÁ
(
si
èdØ{ } 0)

	)

3152 
	#¡©_šc_bg_ı_couÁ
(
si
èdØ{ } 0)

	)

3153 
	#¡©_šc_ÿÎ_couÁ
(
si
èdØ{ } 0)

	)

3154 
	#¡©_šc_bggc_couÁ
(
si
èdØ{ } 0)

	)

3155 
	#¡©_šc_dœty_šode
(
sbi
, 
ty³
èdØ{ } 0)

	)

3156 
	#¡©_dec_dœty_šode
(
sbi
, 
ty³
èdØ{ } 0)

	)

3157 
	#¡©_šc_tÙ®_h™
(
sb
èdØ{ } 0)

	)

3158 
	#¡©_šc_rbŒ“_node_h™
(
sb
èdØ{ } 0)

	)

3159 
	#¡©_šc_Ïrge¡_node_h™
(
sbi
èdØ{ } 0)

	)

3160 
	#¡©_šc_ÿched_node_h™
(
sbi
èdØ{ } 0)

	)

3161 
	#¡©_šc_šlše_x©Œ
(
šode
èdØ{ } 0)

	)

3162 
	#¡©_dec_šlše_x©Œ
(
šode
èdØ{ } 0)

	)

3163 
	#¡©_šc_šlše_šode
(
šode
èdØ{ } 0)

	)

3164 
	#¡©_dec_šlše_šode
(
šode
èdØ{ } 0)

	)

3165 
	#¡©_šc_šlše_dœ
(
šode
èdØ{ } 0)

	)

3166 
	#¡©_dec_šlše_dœ
(
šode
èdØ{ } 0)

	)

3167 
	#¡©_šc_©omic_wr™e
(
šode
èdØ{ } 0)

	)

3168 
	#¡©_dec_©omic_wr™e
(
šode
èdØ{ } 0)

	)

3169 
	#¡©_upd©e_max_©omic_wr™e
(
šode
èdØ{ } 0)

	)

3170 
	#¡©_šc_vŞ©e_wr™e
(
šode
èdØ{ } 0)

	)

3171 
	#¡©_dec_vŞ©e_wr™e
(
šode
èdØ{ } 0)

	)

3172 
	#¡©_upd©e_max_vŞ©e_wr™e
(
šode
èdØ{ } 0)

	)

3173 
	#¡©_šc_£g_ty³
(
sbi
, 
cur£g
èdØ{ } 0)

	)

3174 
	#¡©_šc_block_couÁ
(
sbi
, 
cur£g
èdØ{ } 0)

	)

3175 
	#¡©_šc_š¶aû_blocks
(
sbi
èdØ{ } 0)

	)

3176 
	#¡©_šc_£g_couÁ
(
sbi
, 
ty³
, 
gc_ty³
èdØ{ } 0)

	)

3177 
	#¡©_šc_tÙ_blk_couÁ
(
si
, 
blks
èdØ{ } 0)

	)

3178 
	#¡©_šc_d©a_blk_couÁ
(
sbi
, 
blks
, 
gc_ty³
èdØ{ } 0)

	)

3179 
	#¡©_šc_node_blk_couÁ
(
sbi
, 
blks
, 
gc_ty³
èdØ{ } 0)

	)

3181 
šlše
 
	$f2fs_bud_¡©s
(
f2fs_sb_šfo
 *
sbi
è{  0; 
	}
}

3182 
šlše
 
	$f2fs_de¡roy_¡©s
(
f2fs_sb_šfo
 *
sbi
è{ 
	}
}

3183 
šlše
 
__š™
 
	$f2fs_ü—‹_roÙ_¡©s
(è{  0; 
	}
}

3184 
šlše
 
	$f2fs_de¡roy_roÙ_¡©s
(è{ 
	}
}

3187 cÚ¡ 
fe_İ”©iÚs
 
f2fs_dœ_İ”©iÚs
;

3188 cÚ¡ 
fe_İ”©iÚs
 
f2fs_fe_İ”©iÚs
;

3189 cÚ¡ 
šode_İ”©iÚs
 
f2fs_fe_šode_İ”©iÚs
;

3190 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
f2fs_dblock_aİs
;

3191 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
f2fs_node_aİs
;

3192 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
f2fs_m‘a_aİs
;

3193 cÚ¡ 
šode_İ”©iÚs
 
f2fs_dœ_šode_İ”©iÚs
;

3194 cÚ¡ 
šode_İ”©iÚs
 
f2fs_symlšk_šode_İ”©iÚs
;

3195 cÚ¡ 
šode_İ”©iÚs
 
f2fs_’üy±ed_symlšk_šode_İ”©iÚs
;

3196 cÚ¡ 
šode_İ”©iÚs
 
f2fs_¥ecŸl_šode_İ”©iÚs
;

3197 
kmem_ÿche
 *
f2fs_šode_’Œy_¦ab
;

3202 
boŞ
 
f2fs_may_šlše_d©a
(
šode
 *inode);

3203 
boŞ
 
f2fs_may_šlše_d’Œy
(
šode
 *inode);

3204 
f2fs_do_»ad_šlše_d©a
(
·ge
 *·ge, ·g*
age
);

3205 
f2fs_Œunÿ‹_šlše_šode
(
šode
 *inode,

3206 
·ge
 *
age
, 
u64
 
äom
);

3207 
f2fs_»ad_šlše_d©a
(
šode
 *šode, 
·ge
 *page);

3208 
f2fs_cÚv”t_šlše_·ge
(
dnode_of_d©a
 *
dn
, 
·ge
 *page);

3209 
f2fs_cÚv”t_šlše_šode
(
šode
 *inode);

3210 
f2fs_wr™e_šlše_d©a
(
šode
 *šode, 
·ge
 *page);

3211 
boŞ
 
f2fs_»cov”_šlše_d©a
(
šode
 *šode, 
·ge
 *
Åage
);

3212 
f2fs_dœ_’Œy
 *
f2fs_fšd_š_šlše_dœ
(
šode
 *
dœ
,

3213 
fsüy±_Çme
 *
âame
, 
·ge
 **
»s_·ge
);

3214 
f2fs_make_em±y_šlše_dœ
(
šode
 *šode, šod*
·»Á
,

3215 
·ge
 *
age
);

3216 
f2fs_add_šlše_’Œy
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Ãw_Çme
,

3217 cÚ¡ 
q¡r
 *
Üig_Çme
,

3218 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
);

3219 
f2fs_d–‘e_šlše_’Œy
(
f2fs_dœ_’Œy
 *
d’Œy
,

3220 
·ge
 *·ge, 
šode
 *
dœ
,

3221 
šode
 *inode);

3222 
boŞ
 
f2fs_em±y_šlše_dœ
(
šode
 *
dœ
);

3223 
f2fs_»ad_šlše_dœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
,

3224 
fsüy±_¡r
 *
f¡r
);

3225 
f2fs_šlše_d©a_f›m­
(
šode
 *inode,

3226 
f›m­_ex‹Á_šfo
 *
f›šfo
,

3227 
__u64
 
¡¬t
, __u64 
Ën
);

3232 
f2fs_shršk_couÁ
(
shršk”
 *
shršk
,

3233 
shršk_cÚŒŞ
 *
sc
);

3234 
f2fs_shršk_sÿn
(
shršk”
 *
shršk
,

3235 
shršk_cÚŒŞ
 *
sc
);

3236 
f2fs_još_shršk”
(
f2fs_sb_šfo
 *
sbi
);

3237 
f2fs_Ëave_shršk”
(
f2fs_sb_šfo
 *
sbi
);

3242 
rb_’Œy
 *
f2fs_lookup_rb_Œ“
(
rb_roÙ
 *
roÙ
,

3243 
rb_’Œy
 *
ÿched_»
, 
ofs
);

3244 
rb_node
 **
f2fs_lookup_rb_Œ“_fÜ_š£¹
(
f2fs_sb_šfo
 *
sbi
,

3245 
rb_roÙ
 *
roÙ
, 
rb_node
 **
·»Á
,

3246 
ofs
);

3247 
rb_’Œy
 *
f2fs_lookup_rb_Œ“_»t
(
rb_roÙ
 *
roÙ
,

3248 
rb_’Œy
 *
ÿched_»
, 
ofs
,

3249 
rb_’Œy
 **
´ev_’Œy
, rb_’Œy **
Ãxt_’Œy
,

3250 
rb_node
 ***
š£¹_p
, rb_nod**
š£¹_·»Á
,

3251 
boŞ
 
fÜû
);

3252 
boŞ
 
f2fs_check_rb_Œ“_cÚsi¡’û
(
f2fs_sb_šfo
 *
sbi
,

3253 
rb_roÙ
 *
roÙ
);

3254 
f2fs_shršk_ex‹Á_Œ“
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
);

3255 
boŞ
 
f2fs_š™_ex‹Á_Œ“
(
šode
 *šode, 
f2fs_ex‹Á
 *
i_ext
);

3256 
f2fs_drİ_ex‹Á_Œ“
(
šode
 *inode);

3257 
f2fs_de¡roy_ex‹Á_node
(
šode
 *inode);

3258 
f2fs_de¡roy_ex‹Á_Œ“
(
šode
 *inode);

3259 
boŞ
 
f2fs_lookup_ex‹Á_ÿche
(
šode
 *šode, 
pgoff_t
 
pgofs
,

3260 
ex‹Á_šfo
 *
ei
);

3261 
f2fs_upd©e_ex‹Á_ÿche
(
dnode_of_d©a
 *
dn
);

3262 
f2fs_upd©e_ex‹Á_ÿche_¿nge
(
dnode_of_d©a
 *
dn
,

3263 
pgoff_t
 
fofs
, 
block_t
 
blkaddr
, 
Ën
);

3264 
f2fs_š™_ex‹Á_ÿche_šfo
(
f2fs_sb_šfo
 *
sbi
);

3265 
__š™
 
f2fs_ü—‹_ex‹Á_ÿche
();

3266 
f2fs_de¡roy_ex‹Á_ÿche
();

3271 
__š™
 
f2fs_š™_sysfs
();

3272 
f2fs_ex™_sysfs
();

3273 
f2fs_»gi¡”_sysfs
(
f2fs_sb_šfo
 *
sbi
);

3274 
f2fs_uÄegi¡”_sysfs
(
f2fs_sb_šfo
 *
sbi
);

3279 
šlše
 
boŞ
 
	$f2fs_’üy±ed_šode
(
šode
 *inode)

3281  
	`fe_is_’üy±
(
šode
);

3282 
	}
}

3284 
šlše
 
boŞ
 
	$f2fs_’üy±ed_fe
(
šode
 *inode)

3286  
	`f2fs_’üy±ed_šode
(
šode
è&& 
	`S_ISREG
(šode->
i_mode
);

3287 
	}
}

3289 
šlše
 
	$f2fs_£t_’üy±ed_šode
(
šode
 *inode)

3291 #ifdeà
CONFIG_F2FS_FS_ENCRYPTION


3292 
	`fe_£t_’üy±
(
šode
);

3293 
šode
->
i_æags
 |ğ
S_ENCRYPTED
;

3295 
	}
}

3301 
šlše
 
boŞ
 
	$f2fs_po¡_»ad_»quœed
(
šode
 *inode)

3303  
	`f2fs_’üy±ed_fe
(
šode
);

3304 
	}
}

3306 
	#F2FS_FEATURE_FUNCS
(
Çme
, 
æagÇme
) \

3307 
šlše
 
f2fs_sb_has_
##
	`Çme
(
su³r_block
 *
sb
) \

3309  
	`F2FS_HAS_FEATURE
(
sb
, 
F2FS_FEATURE_
##
æagÇme
); \

3310 }

	)

3312 
F2FS_FEATURE_FUNCS
(
’üy±
, 
ENCRYPT
);

3313 
F2FS_FEATURE_FUNCS
(
blkzÚed
, 
BLKZONED
);

3314 
F2FS_FEATURE_FUNCS
(
exŒa_©Œ
, 
EXTRA_ATTR
);

3315 
F2FS_FEATURE_FUNCS
(
´ojeù_quÙa
, 
PRJQUOTA
);

3316 
F2FS_FEATURE_FUNCS
(
šode_chksum
, 
INODE_CHKSUM
);

3317 
F2FS_FEATURE_FUNCS
(
æexibË_šlše_x©Œ
, 
FLEXIBLE_INLINE_XATTR
);

3318 
F2FS_FEATURE_FUNCS
(
quÙa_šo
, 
QUOTA_INO
);

3319 
F2FS_FEATURE_FUNCS
(
šode_ütime
, 
INODE_CRTIME
);

3320 
F2FS_FEATURE_FUNCS
(
lo¡_found
, 
LOST_FOUND
);

3322 #ifdeà
CONFIG_BLK_DEV_ZONED


3323 
šlše
 
	$g‘_blkz_ty³
(
f2fs_sb_šfo
 *
sbi
,

3324 
block_deviû
 *
bdev
, 
block_t
 
blkaddr
)

3326 
zno
 = 
blkaddr
 >> 
sbi
->
log_blocks_³r_blkz
;

3327 
i
;

3329 
i
 = 0; i < 
sbi
->
s_ndevs
; i++)

3330 ià(
	`FDEV
(
i
).
bdev
 == bdev)

3331  
	`FDEV
(
i
).
blkz_ty³
[
zno
];

3332  -
EINVAL
;

3333 
	}
}

3336 
šlše
 
boŞ
 
	$f2fs_disÿrd_’
(
f2fs_sb_šfo
 *
sbi
)

3338 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
sbi
->
sb
->
s_bdev
);

3340  
	`blk_queue_disÿrd
(
q
è|| 
	`f2fs_sb_has_blkzÚed
(
sbi
->
sb
);

3341 
	}
}

3343 
šlše
 
	$£t_İt_mode
(
f2fs_sb_šfo
 *
sbi
, 
mt
)

3345 
	`ş—r_İt
(
sbi
, 
ADAPTIVE
);

3346 
	`ş—r_İt
(
sbi
, 
LFS
);

3348 
mt
) {

3349 
F2FS_MOUNT_ADAPTIVE
:

3350 
	`£t_İt
(
sbi
, 
ADAPTIVE
);

3352 
F2FS_MOUNT_LFS
:

3353 
	`£t_İt
(
sbi
, 
LFS
);

3356 
	}
}

3358 
šlše
 
boŞ
 
	$f2fs_may_’üy±
(
šode
 *inode)

3360 #ifdeà
CONFIG_F2FS_FS_ENCRYPTION


3361 
umode_t
 
mode
 = 
šode
->
i_mode
;

3363  (
	`S_ISREG
(
mode
è|| 
	`S_ISDIR
(modeè|| 
	`S_ISLNK
(mode));

3367 
	}
}

3369 
šlše
 
boŞ
 
	$f2fs_fÜû_bufã»d_io
(
šode
 *šode, 
rw
)

3371  (
	`f2fs_po¡_»ad_»quœed
(
šode
) ||

3372 (
rw
 =ğ
WRITE
 && 
	`‹¡_İt
(
	`F2FS_I_SB
(
šode
), 
LFS
)) ||

3373 
	`F2FS_I_SB
(
šode
)->
s_ndevs
);

3374 
	}
}

	@fs/f2fs/file.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/¡©.h
>

14 
	~<lšux/bufãr_h—d.h
>

15 
	~<lšux/wr™eback.h
>

16 
	~<lšux/blkdev.h
>

17 
	~<lšux/çÎoc.h
>

18 
	~<lšux/ty³s.h
>

19 
	~<lšux/com·t.h
>

20 
	~<lšux/uacûss.h
>

21 
	~<lšux/mouÁ.h
>

22 
	~<lšux/·gevec.h
>

23 
	~<lšux/uio.h
>

24 
	~<lšux/uuid.h
>

25 
	~<lšux/fe.h
>

27 
	~"f2fs.h
"

28 
	~"node.h
"

29 
	~"£gm’t.h
"

30 
	~"x©Œ.h
"

31 
	~"aş.h
"

32 
	~"gc.h
"

33 
	~"Œaû.h
"

34 
	~<Œaû/ev’ts/f2fs.h
>

36 
vm_çuÉ_t
 
	$f2fs_fem­_çuÉ
(
vm_çuÉ
 *
vmf
)

38 
šode
 *šodğ
	`fe_šode
(
vmf
->
vma
->
vm_fe
);

39 
vm_çuÉ_t
 
»t
;

41 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

42 
»t
 = 
	`fem­_çuÉ
(
vmf
);

43 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

45  
»t
;

46 
	}
}

48 
vm_çuÉ_t
 
	$f2fs_vm_·ge_mkwr™e
(
vm_çuÉ
 *
vmf
)

50 
·ge
 *·gğ
vmf
->page;

51 
šode
 *šodğ
	`fe_šode
(
vmf
->
vma
->
vm_fe
);

52 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

53 
dnode_of_d©a
 
dn
;

54 
”r
;

56 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

57 
”r
 = -
EIO
;

58 
”r
;

61 
	`sb_¡¬t_·geçuÉ
(
šode
->
i_sb
);

63 
	`f2fs_bug_Ú
(
sbi
, 
	`f2fs_has_šlše_d©a
(
šode
));

66 
	`f2fs_lock_İ
(
sbi
);

67 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

68 
”r
 = 
	`f2fs_»£rve_block
(&
dn
, 
·ge
->
šdex
);

69 ià(
”r
) {

70 
	`f2fs_uÆock_İ
(
sbi
);

71 
out
;

73 
	`f2fs_put_dnode
(&
dn
);

74 
	`f2fs_uÆock_İ
(
sbi
);

76 
	`f2fs_b®ªû_fs
(
sbi
, 
dn
.
node_chªged
);

78 
	`fe_upd©e_time
(
vmf
->
vma
->
vm_fe
);

79 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

80 
	`lock_·ge
(
·ge
);

81 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
 ||

82 
	`·ge_off£t
(
·ge
è> 
	`i_size_»ad
(
šode
) ||

83 !
	`PageU±od©e
(
·ge
))) {

84 
	`uÆock_·ge
(
·ge
);

85 
”r
 = -
EFAULT
;

86 
out_£m
;

92 ià(
	`PageM­³dToDisk
(
·ge
))

93 
m­³d
;

96 ià(((
loff_t
)(
·ge
->
šdex
 + 1è<< 
PAGE_SHIFT
) >

97 
	`i_size_»ad
(
šode
)) {

98 
loff_t
 
off£t
;

100 
off£t
 = 
	`i_size_»ad
(
šode
è& ~
PAGE_MASK
;

101 
	`z”o_u£r_£gm’t
(
·ge
, 
off£t
, 
PAGE_SIZE
);

103 
	`£t_·ge_dœty
(
·ge
);

104 ià(!
	`PageU±od©e
(
·ge
))

105 
	`S‘PageU±od©e
(
·ge
);

107 
	`f2fs_upd©e_io¡©
(
sbi
, 
APP_MAPPED_IO
, 
F2FS_BLKSIZE
);

109 
	`Œaû_f2fs_vm_·ge_mkwr™e
(
·ge
, 
DATA
);

110 
m­³d
:

112 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
çl£
);

115 ià(
	`f2fs_po¡_»ad_»quœed
(
šode
))

116 
	`f2fs_wa™_Ú_block_wr™eback
(
sbi
, 
dn
.
d©a_blkaddr
);

118 
out_£m
:

119 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

120 
out
:

121 
	`sb_’d_·geçuÉ
(
šode
->
i_sb
);

122 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

123 
”r
:

124  
	`block_·ge_mkwr™e_»tuº
(
”r
);

125 
	}
}

127 cÚ¡ 
vm_İ”©iÚs_¡ruù
 
	gf2fs_fe_vm_İs
 = {

128 .
çuÉ
 = 
f2fs_fem­_çuÉ
,

129 .
	gm­_·ges
 = 
fem­_m­_·ges
,

130 .
	g·ge_mkwr™e
 = 
f2fs_vm_·ge_mkwr™e
,

133 
	$g‘_·»Á_šo
(
šode
 *šode, 
nid_t
 *
pšo
)

135 
d’Œy
 *dentry;

137 
šode
 = 
	`ig¿b
(inode);

138 
d’Œy
 = 
	`d_fšd_ªy_®Ÿs
(
šode
);

139 
	`ut
(
šode
);

140 ià(!
d’Œy
)

143 *
pšo
 = 
	`·»Á_šo
(
d’Œy
);

144 
	`dput
(
d’Œy
);

146 
	}
}

148 
šlše
 
ı_»asÚ_ty³
 
	$Ãed_do_checkpošt
(
šode
 *inode)

150 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

151 
ı_»asÚ_ty³
 
ı_»asÚ
 = 
CP_NO_NEEDED
;

153 ià(!
	`S_ISREG
(
šode
->
i_mode
))

154 
ı_»asÚ
 = 
CP_NON_REGULAR
;

155 ià(
šode
->
i_Æšk
 != 1)

156 
ı_»asÚ
 = 
CP_HARDLINK
;

157 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_CP
))

158 
ı_»asÚ
 = 
CP_SB_NEED_CP
;

159 ià(
	`fe_wrÚg_pšo
(
šode
))

160 
ı_»asÚ
 = 
CP_WRONG_PINO
;

161 ià(!
	`f2fs_¥aû_fÜ_rŞl_fÜw¬d
(
sbi
))

162 
ı_»asÚ
 = 
CP_NO_SPC_ROLL
;

163 ià(!
	`f2fs_is_checkpoš‹d_node
(
sbi
, 
	`F2FS_I
(
šode
)->
i_pšo
))

164 
ı_»asÚ
 = 
CP_NODE_NEED_CP
;

165 ià(
	`‹¡_İt
(
sbi
, 
FASTBOOT
))

166 
ı_»asÚ
 = 
CP_FASTBOOT_MODE
;

167 ià(
	`F2FS_OPTION
(
sbi
).
aùive_logs
 == 2)

168 
ı_»asÚ
 = 
CP_SPEC_LOG_NUM
;

169 ià(
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =ğ
FSYNC_MODE_STRICT
 &&

170 
	`f2fs_Ãed_d’Œy_m¬k
(
sbi
, 
šode
->
i_šo
) &&

171 
	`f2fs_exi¡_wr™‹n_d©a
(
sbi
, 
	`F2FS_I
(
šode
)->
i_pšo
,

172 
TRANS_DIR_INO
))

173 
ı_»asÚ
 = 
CP_RECOVER_DIR
;

175  
ı_»asÚ
;

176 
	}
}

178 
boŞ
 
	$Ãed_šode_·ge_upd©e
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

180 
·ge
 *
i
 = 
	`fšd_g‘_·ge
(
	`NODE_MAPPING
(
sbi
), 
šo
);

181 
boŞ
 
»t
 = 
çl£
;

183 ià((
i
 && 
	`PageDœty
(i)è|| 
	`f2fs_Ãed_šode_block_upd©e
(
sbi
, 
šo
))

184 
»t
 = 
Œue
;

185 
	`f2fs_put_·ge
(
i
, 0);

186  
»t
;

187 
	}
}

189 
	$Œy_to_fix_pšo
(
šode
 *inode)

191 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

192 
nid_t
 
pšo
;

194 
	`down_wr™e
(&
fi
->
i_£m
);

195 ià(
	`fe_wrÚg_pšo
(
šode
è&& inode->
i_Æšk
 == 1 &&

196 
	`g‘_·»Á_šo
(
šode
, &
pšo
)) {

197 
	`f2fs_i_pšo_wr™e
(
šode
, 
pšo
);

198 
	`fe_gÙ_pšo
(
šode
);

200 
	`up_wr™e
(&
fi
->
i_£m
);

201 
	}
}

203 
	$f2fs_do_sync_fe
(
fe
 *fe, 
loff_t
 
¡¬t
,†off_ˆ
’d
,

204 
d©async
, 
boŞ
 
©omic
)

206 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

207 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

208 
nid_t
 
šo
 = 
šode
->
i_šo
;

209 
»t
 = 0;

210 
ı_»asÚ_ty³
 
ı_»asÚ
 = 0;

211 
wr™eback_cÚŒŞ
 
wbc
 = {

212 .
sync_mode
 = 
WB_SYNC_ALL
,

213 .
Ä_to_wr™e
 = 
LONG_MAX
,

214 .
fÜ_»şaim
 = 0,

217 ià(
	`uÆik–y
(
	`f2fs_»adÚly
(
šode
->
i_sb
)))

220 
	`Œaû_f2fs_sync_fe_’‹r
(
šode
);

223 ià(
d©async
 || 
	`g‘_dœty_·ges
(
šode
è<ğ
	`SM_I
(
sbi
)->
mš_fsync_blocks
)

224 
	`£t_šode_æag
(
šode
, 
FI_NEED_IPU
);

225 
»t
 = 
	`fe_wr™e_ªd_wa™_¿nge
(
fe
, 
¡¬t
, 
’d
);

226 
	`ş—r_šode_æag
(
šode
, 
FI_NEED_IPU
);

228 ià(
»t
) {

229 
	`Œaû_f2fs_sync_fe_ex™
(
šode
, 
ı_»asÚ
, 
d©async
, 
»t
);

230  
»t
;

234 ià(!
	`f2fs_sk_šode_upd©e
(
šode
, 
d©async
)) {

235 
	`f2fs_wr™e_šode
(
šode
, 
NULL
);

236 
go_wr™e
;

242 ià(!
	`is_šode_æag_£t
(
šode
, 
FI_APPEND_WRITE
) &&

243 !
	`f2fs_exi¡_wr™‹n_d©a
(
sbi
, 
šo
, 
APPEND_INO
)) {

246 ià(
	`Ãed_šode_·ge_upd©e
(
sbi
, 
šo
))

247 
go_wr™e
;

249 ià(
	`is_šode_æag_£t
(
šode
, 
FI_UPDATE_WRITE
) ||

250 
	`f2fs_exi¡_wr™‹n_d©a
(
sbi
, 
šo
, 
UPDATE_INO
))

251 
æush_out
;

252 
out
;

254 
go_wr™e
:

259 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_£m
);

260 
ı_»asÚ
 = 
	`Ãed_do_checkpošt
(
šode
);

261 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_£m
);

263 ià(
ı_»asÚ
) {

265 
»t
 = 
	`f2fs_sync_fs
(
šode
->
i_sb
, 1);

271 
	`Œy_to_fix_pšo
(
šode
);

272 
	`ş—r_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

273 
	`ş—r_šode_æag
(
šode
, 
FI_UPDATE_WRITE
);

274 
out
;

276 
sync_nodes
:

277 
	`©omic_šc
(&
sbi
->
wb_sync_»q
[
NODE
]);

278 
»t
 = 
	`f2fs_fsync_node_·ges
(
sbi
, 
šode
, &
wbc
, 
©omic
);

279 
	`©omic_dec
(&
sbi
->
wb_sync_»q
[
NODE
]);

280 ià(
»t
)

281 
out
;

284 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

285 
»t
 = -
EIO
;

286 
out
;

289 ià(
	`f2fs_Ãed_šode_block_upd©e
(
sbi
, 
šo
)) {

290 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

291 
	`f2fs_wr™e_šode
(
šode
, 
NULL
);

292 
sync_nodes
;

303 ià(!
©omic
) {

304 
»t
 = 
	`f2fs_wa™_Ú_node_·ges_wr™eback
(
sbi
, 
šo
);

305 ià(
»t
)

306 
out
;

310 
	`f2fs_»move_šo_’Œy
(
sbi
, 
šo
, 
APPEND_INO
);

311 
	`ş—r_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

312 
æush_out
:

313 ià(!
©omic
 && 
	`F2FS_OPTION
(
sbi
).
fsync_mode
 !ğ
FSYNC_MODE_NOBARRIER
)

314 
»t
 = 
	`f2fs_issue_æush
(
sbi
, 
šode
->
i_šo
);

315 ià(!
»t
) {

316 
	`f2fs_»move_šo_’Œy
(
sbi
, 
šo
, 
UPDATE_INO
);

317 
	`ş—r_šode_æag
(
šode
, 
FI_UPDATE_WRITE
);

318 
	`f2fs_»move_šo_’Œy
(
sbi
, 
šo
, 
FLUSH_INO
);

320 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

321 
out
:

322 
	`Œaû_f2fs_sync_fe_ex™
(
šode
, 
ı_»asÚ
, 
d©async
, 
»t
);

323 
	`f2fs_Œaû_ios
(
NULL
, 1);

324  
»t
;

325 
	}
}

327 
	$f2fs_sync_fe
(
fe
 *fe, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
)

329 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
	`fe_šode
(
fe
)))))

330  -
EIO
;

331  
	`f2fs_do_sync_fe
(
fe
, 
¡¬t
, 
’d
, 
d©async
, 
çl£
);

332 
	}
}

334 
pgoff_t
 
	$__g‘_fœ¡_dœty_šdex
(
add»ss_¥aû
 *
m­pšg
,

335 
pgoff_t
 
pgofs
, 
wh’û
)

337 
·ge
 *page;

338 
Ä_·ges
;

340 ià(
wh’û
 !ğ
SEEK_DATA
)

344 
Ä_·ges
 = 
	`fšd_g‘_·ges_g
(
m­pšg
, &
pgofs
, 
PAGECACHE_TAG_DIRTY
,

345 1, &
·ge
);

346 ià(!
Ä_·ges
)

347  
ULONG_MAX
;

348 
pgofs
 = 
·ge
->
šdex
;

349 
	`put_·ge
(
·ge
);

350  
pgofs
;

351 
	}
}

353 
boŞ
 
	$__found_off£t
(
block_t
 
blkaddr
, 
pgoff_t
 
dœty
,…goff_ˆ
pgofs
,

354 
wh’û
)

356 
wh’û
) {

357 
SEEK_DATA
:

358 ià((
blkaddr
 =ğ
NEW_ADDR
 && 
dœty
 =ğ
pgofs
) ||

359 
	`is_v®id_blkaddr
(
blkaddr
))

360  
Œue
;

362 
SEEK_HOLE
:

363 ià(
blkaddr
 =ğ
NULL_ADDR
)

364  
Œue
;

367  
çl£
;

368 
	}
}

370 
loff_t
 
	$f2fs_£ek_block
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

372 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

373 
loff_t
 
maxby‹s
 = 
šode
->
i_sb
->
s_maxby‹s
;

374 
dnode_of_d©a
 
dn
;

375 
pgoff_t
 
pgofs
, 
’d_off£t
, 
dœty
;

376 
loff_t
 
d©a_ofs
 = 
off£t
;

377 
loff_t
 
isize
;

378 
”r
 = 0;

380 
	`šode_lock
(
šode
);

382 
isize
 = 
	`i_size_»ad
(
šode
);

383 ià(
off£t
 >ğ
isize
)

384 
ç
;

387 ià(
	`f2fs_has_šlše_d©a
(
šode
è|| 
	`f2fs_has_šlše_d’Œy
(inode)) {

388 ià(
wh’û
 =ğ
SEEK_HOLE
)

389 
d©a_ofs
 = 
isize
;

390 
found
;

393 
pgofs
 = (
pgoff_t
)(
off£t
 >> 
PAGE_SHIFT
);

395 
dœty
 = 
	`__g‘_fœ¡_dœty_šdex
(
šode
->
i_m­pšg
, 
pgofs
, 
wh’û
);

397 ; 
d©a_ofs
 < 
isize
; d©a_of ğ(
loff_t
)
pgofs
 << 
PAGE_SHIFT
) {

398 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

399 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
pgofs
, 
LOOKUP_NODE
);

400 ià(
”r
 &&ƒ¼ !ğ-
ENOENT
) {

401 
ç
;

402 } ià(
”r
 =ğ-
ENOENT
) {

404 ià(
wh’û
 =ğ
SEEK_DATA
) {

405 
pgofs
 = 
	`f2fs_g‘_Ãxt_·ge_off£t
(&
dn
,…gofs);

408 
found
;

412 
’d_off£t
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
šode
);

415 ; 
dn
.
ofs_š_node
 < 
’d_off£t
;

416 
dn
.
ofs_š_node
++, 
pgofs
++,

417 
d©a_ofs
 = (
loff_t
)
pgofs
 << 
PAGE_SHIFT
) {

418 
block_t
 
blkaddr
;

420 
blkaddr
 = 
	`d©ablock_addr
(
dn
.
šode
,

421 
dn
.
node_·ge
, dn.
ofs_š_node
);

423 ià(
	`__found_off£t
(
blkaddr
, 
dœty
, 
pgofs
, 
wh’û
)) {

424 
	`f2fs_put_dnode
(&
dn
);

425 
found
;

428 
	`f2fs_put_dnode
(&
dn
);

431 ià(
wh’û
 =ğ
SEEK_DATA
)

432 
ç
;

433 
found
:

434 ià(
wh’û
 =ğ
SEEK_HOLE
 && 
d©a_ofs
 > 
isize
)

435 
d©a_ofs
 = 
isize
;

436 
	`šode_uÆock
(
šode
);

437  
	`vfs_£os
(
fe
, 
d©a_ofs
, 
maxby‹s
);

438 
ç
:

439 
	`šode_uÆock
(
šode
);

440  -
ENXIO
;

441 
	}
}

443 
loff_t
 
	$f2fs_Î£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

445 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

446 
loff_t
 
maxby‹s
 = 
šode
->
i_sb
->
s_maxby‹s
;

448 
wh’û
) {

449 
SEEK_SET
:

450 
SEEK_CUR
:

451 
SEEK_END
:

452  
	`g’”ic_fe_Î£ek_size
(
fe
, 
off£t
, 
wh’û
,

453 
maxby‹s
, 
	`i_size_»ad
(
šode
));

454 
SEEK_DATA
:

455 
SEEK_HOLE
:

456 ià(
off£t
 < 0)

457  -
ENXIO
;

458  
	`f2fs_£ek_block
(
fe
, 
off£t
, 
wh’û
);

461  -
EINVAL
;

462 
	}
}

464 
	$f2fs_fe_mm­
(
fe
 *fe, 
vm_¬—_¡ruù
 *
vma
)

466 
šode
 *šodğ
	`fe_šode
(
fe
);

467 
”r
;

469 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
))))

470  -
EIO
;

473 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

474 ià(
”r
)

475  
”r
;

477 
	`fe_acûs£d
(
fe
);

478 
vma
->
vm_İs
 = &
f2fs_fe_vm_İs
;

480 
	}
}

482 
	$f2fs_fe_İ’
(
šode
 *šode, 
fe
 *
fp
)

484 
”r
 = 
	`fsüy±_fe_İ’
(
šode
, 
fp
);

486 ià(
”r
)

487  
”r
;

489 
fp
->
f_mode
 |ğ
FMODE_NOWAIT
;

491  
	`dquÙ_fe_İ’
(
šode
, 
fp
);

492 
	}
}

494 
	$f2fs_Œunÿ‹_d©a_blocks_¿nge
(
dnode_of_d©a
 *
dn
, 
couÁ
)

496 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

497 
f2fs_node
 *
¿w_node
;

498 
Ä_ä“
 = 0, 
ofs
 = 
dn
->
ofs_š_node
, 
Ën
 = 
couÁ
;

499 
__Ë32
 *
addr
;

500 
ba£
 = 0;

502 ià(
	`IS_INODE
(
dn
->
node_·ge
è&& 
	`f2fs_has_exŒa_©Œ
(dn->
šode
))

503 
ba£
 = 
	`g‘_exŒa_isize
(
dn
->
šode
);

505 
¿w_node
 = 
	`F2FS_NODE
(
dn
->
node_·ge
);

506 
addr
 = 
	`blkaddr_š_node
(
¿w_node
è+ 
ba£
 + 
ofs
;

508 ; 
couÁ
 > 0; couÁ--, 
addr
++, 
dn
->
ofs_š_node
++) {

509 
block_t
 
blkaddr
 = 
	`Ë32_to_ıu
(*
addr
);

511 ià(
blkaddr
 =ğ
NULL_ADDR
)

514 
dn
->
d©a_blkaddr
 = 
NULL_ADDR
;

515 
	`f2fs_£t_d©a_blkaddr
(
dn
);

516 
	`f2fs_šv®id©e_blocks
(
sbi
, 
blkaddr
);

517 ià(
dn
->
ofs_š_node
 =ğ0 && 
	`IS_INODE
(dn->
node_·ge
))

518 
	`ş—r_šode_æag
(
dn
->
šode
, 
FI_FIRST_BLOCK_WRITTEN
);

519 
Ä_ä“
++;

522 ià(
Ä_ä“
) {

523 
pgoff_t
 
fofs
;

528 
fofs
 = 
	`f2fs_¡¬t_bidx_of_node
(
	`ofs_of_node
(
dn
->
node_·ge
),

529 
dn
->
šode
è+ 
ofs
;

530 
	`f2fs_upd©e_ex‹Á_ÿche_¿nge
(
dn
, 
fofs
, 0, 
Ën
);

531 
	`dec_v®id_block_couÁ
(
sbi
, 
dn
->
šode
, 
Ä_ä“
);

533 
dn
->
ofs_š_node
 = 
ofs
;

535 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

536 
	`Œaû_f2fs_Œunÿ‹_d©a_blocks_¿nge
(
dn
->
šode
, dn->
nid
,

537 
dn
->
ofs_š_node
, 
Ä_ä“
);

538 
	}
}

540 
	$f2fs_Œunÿ‹_d©a_blocks
(
dnode_of_d©a
 *
dn
)

542 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(
dn
, 
ADDRS_PER_BLOCK
);

543 
	}
}

545 
	$Œunÿ‹_·¹Ÿl_d©a_·ge
(
šode
 *šode, 
u64
 
äom
,

546 
boŞ
 
ÿche_Úly
)

548 
loff_t
 
off£t
 = 
äom
 & (
PAGE_SIZE
 - 1);

549 
pgoff_t
 
šdex
 = 
äom
 >> 
PAGE_SHIFT
;

550 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

551 
·ge
 *page;

553 ià(!
off£t
 && !
ÿche_Úly
)

556 ià(
ÿche_Úly
) {

557 
·ge
 = 
	`fšd_lock_·ge
(
m­pšg
, 
šdex
);

558 ià(
·ge
 && 
	`PageU±od©e
(page))

559 
Œunÿ‹_out
;

560 
	`f2fs_put_·ge
(
·ge
, 1);

564 
·ge
 = 
	`f2fs_g‘_lock_d©a_·ge
(
šode
, 
šdex
, 
Œue
);

565 ià(
	`IS_ERR
(
·ge
))

566  
	`PTR_ERR
(
·ge
è=ğ-
ENOENT
 ? 0 : PTR_ERR(page);

567 
Œunÿ‹_out
:

568 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
);

569 
	`z”o_u£r
(
·ge
, 
off£t
, 
PAGE_SIZE
 - offset);

572 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
), 
ÿche_Úly
 && 
	`f2fs_’üy±ed_šode
(inode));

573 ià(!
ÿche_Úly
)

574 
	`£t_·ge_dœty
(
·ge
);

575 
	`f2fs_put_·ge
(
·ge
, 1);

577 
	}
}

579 
	$f2fs_Œunÿ‹_blocks
(
šode
 *šode, 
u64
 
äom
, 
boŞ
 
lock
)

581 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

582 
dnode_of_d©a
 
dn
;

583 
pgoff_t
 
ä“_äom
;

584 
couÁ
 = 0, 
”r
 = 0;

585 
·ge
 *
age
;

586 
boŞ
 
Œunÿ‹_·ge
 = 
çl£
;

588 
	`Œaû_f2fs_Œunÿ‹_blocks_’‹r
(
šode
, 
äom
);

590 
ä“_äom
 = (
pgoff_t
)
	`F2FS_BLK_ALIGN
(
äom
);

592 ià(
ä“_äom
 >ğ
sbi
->
max_fe_blocks
)

593 
ä“_·¹Ÿl
;

595 ià(
lock
)

596 
	`f2fs_lock_İ
(
sbi
);

598 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

599 ià(
	`IS_ERR
(
age
)) {

600 
”r
 = 
	`PTR_ERR
(
age
);

601 
out
;

604 ià(
	`f2fs_has_šlše_d©a
(
šode
)) {

605 
	`f2fs_Œunÿ‹_šlše_šode
(
šode
, 
age
, 
äom
);

606 
	`f2fs_put_·ge
(
age
, 1);

607 
Œunÿ‹_·ge
 = 
Œue
;

608 
out
;

611 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
age
, 
NULL
, 0);

612 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
ä“_äom
, 
LOOKUP_NODE_RA
);

613 ià(
”r
) {

614 ià(
”r
 =ğ-
ENOENT
)

615 
ä“_Ãxt
;

616 
out
;

619 
couÁ
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
šode
);

621 
couÁ
 -ğ
dn
.
ofs_š_node
;

622 
	`f2fs_bug_Ú
(
sbi
, 
couÁ
 < 0);

624 ià(
dn
.
ofs_š_node
 || 
	`IS_INODE
(dn.
node_·ge
)) {

625 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 
couÁ
);

626 
ä“_äom
 +ğ
couÁ
;

629 
	`f2fs_put_dnode
(&
dn
);

630 
ä“_Ãxt
:

631 
”r
 = 
	`f2fs_Œunÿ‹_šode_blocks
(
šode
, 
ä“_äom
);

632 
out
:

633 ià(
lock
)

634 
	`f2fs_uÆock_İ
(
sbi
);

635 
ä“_·¹Ÿl
:

637 ià(!
”r
)

638 
”r
 = 
	`Œunÿ‹_·¹Ÿl_d©a_·ge
(
šode
, 
äom
, 
Œunÿ‹_·ge
);

640 
	`Œaû_f2fs_Œunÿ‹_blocks_ex™
(
šode
, 
”r
);

641  
”r
;

642 
	}
}

644 
	$f2fs_Œunÿ‹
(
šode
 *inode)

646 
”r
;

648 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
))))

649  -
EIO
;

651 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

652 
	`S_ISLNK
(
šode
->
i_mode
)))

655 
	`Œaû_f2fs_Œunÿ‹
(
šode
);

657 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


658 ià(
	`time_to_šjeù
(
	`F2FS_I_SB
(
šode
), 
FAULT_TRUNCATE
)) {

659 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_TRUNCATE
);

660  -
EIO
;

664 ià(!
	`f2fs_may_šlše_d©a
(
šode
)) {

665 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

666 ià(
”r
)

667  
”r
;

670 
”r
 = 
	`f2fs_Œunÿ‹_blocks
(
šode
, 
	`i_size_»ad
(šode), 
Œue
);

671 ià(
”r
)

672  
”r
;

674 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

675 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

677 
	}
}

679 
	$f2fs_g‘©Œ
(cÚ¡ 
·th
 *·th, 
k¡©
 *
¡©
,

680 
u32
 
»que¡_mask
, 
qu”y_æags
)

682 
šode
 *šodğ
	`d_šode
(
·th
->
d’Œy
);

683 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

684 
f2fs_šode
 *
ri
;

685 
æags
;

687 ià(
	`f2fs_has_exŒa_©Œ
(
šode
) &&

688 
	`f2fs_sb_has_šode_ütime
(
šode
->
i_sb
) &&

689 
	`F2FS_FITS_IN_INODE
(
ri
, 
fi
->
i_exŒa_isize
, 
i_ütime
)) {

690 
¡©
->
»suÉ_mask
 |ğ
STATX_BTIME
;

691 
¡©
->
btime
.
tv_£c
 = 
fi
->
i_ütime
.tv_sec;

692 
¡©
->
btime
.
tv_n£c
 = 
fi
->
i_ütime
.tv_nsec;

695 
æags
 = 
fi
->
i_æags
 & 
F2FS_FL_USER_VISIBLE
;

696 ià(
æags
 & 
F2FS_APPEND_FL
)

697 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_APPEND
;

698 ià(
æags
 & 
F2FS_COMPR_FL
)

699 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_COMPRESSED
;

700 ià(
	`f2fs_’üy±ed_šode
(
šode
))

701 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_ENCRYPTED
;

702 ià(
æags
 & 
F2FS_IMMUTABLE_FL
)

703 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_IMMUTABLE
;

704 ià(
æags
 & 
F2FS_NODUMP_FL
)

705 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_NODUMP
;

707 
¡©
->
©Œibu‹s_mask
 |ğ(
STATX_ATTR_APPEND
 |

708 
STATX_ATTR_COMPRESSED
 |

709 
STATX_ATTR_ENCRYPTED
 |

710 
STATX_ATTR_IMMUTABLE
 |

711 
STATX_ATTR_NODUMP
);

713 
	`g’”ic_fÏ‰r
(
šode
, 
¡©
);

716 ià((
	`S_ISREG
(
šode
->
i_mode
è&& 
	`f2fs_has_šlše_d©a
(inode)) ||

717 
	`f2fs_has_šlše_d’Œy
(
šode
))

718 
¡©
->
blocks
 +ğ(¡©->
size
 + 511) >> 9;

721 
	}
}

723 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


724 
	$__£‰r_cİy
(
šode
 *šode, cÚ¡ 
Ÿ‰r
 *
©Œ
)

726 
Ÿ_v®id
 = 
©Œ
->ia_valid;

728 ià(
Ÿ_v®id
 & 
ATTR_UID
)

729 
šode
->
i_uid
 = 
©Œ
->
Ÿ_uid
;

730 ià(
Ÿ_v®id
 & 
ATTR_GID
)

731 
šode
->
i_gid
 = 
©Œ
->
Ÿ_gid
;

732 ià(
Ÿ_v®id
 & 
ATTR_ATIME
)

733 
šode
->
i_©ime
 = 
	`time¥ec64_Œunc
(
©Œ
->
Ÿ_©ime
,

734 
šode
->
i_sb
->
s_time_g¿n
);

735 ià(
Ÿ_v®id
 & 
ATTR_MTIME
)

736 
šode
->
i_mtime
 = 
	`time¥ec64_Œunc
(
©Œ
->
Ÿ_mtime
,

737 
šode
->
i_sb
->
s_time_g¿n
);

738 ià(
Ÿ_v®id
 & 
ATTR_CTIME
)

739 
šode
->
i_ùime
 = 
	`time¥ec64_Œunc
(
©Œ
->
Ÿ_ùime
,

740 
šode
->
i_sb
->
s_time_g¿n
);

741 ià(
Ÿ_v®id
 & 
ATTR_MODE
) {

742 
umode_t
 
mode
 = 
©Œ
->
Ÿ_mode
;

744 ià(!
	`š_group_p
(
šode
->
i_gid
è&& !
	`ÿ·bË
(
CAP_FSETID
))

745 
mode
 &ğ~
S_ISGID
;

746 
	`£t_aş_šode
(
šode
, 
mode
);

748 
	}
}

750 
	#__£‰r_cİy
 
£‰r_cİy


	)

753 
	$f2fs_£‰r
(
d’Œy
 *d’Œy, 
Ÿ‰r
 *
©Œ
)

755 
šode
 *šodğ
	`d_šode
(
d’Œy
);

756 
”r
;

757 
boŞ
 
size_chªged
 = 
çl£
;

759 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
))))

760  -
EIO
;

762 
”r
 = 
	`£‰r_´•¬e
(
d’Œy
, 
©Œ
);

763 ià(
”r
)

764  
”r
;

766 
”r
 = 
	`fsüy±_´•¬e_£‰r
(
d’Œy
, 
©Œ
);

767 ià(
”r
)

768  
”r
;

770 ià(
	`is_quÙa_modifiÿtiÚ
(
šode
, 
©Œ
)) {

771 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

772 ià(
”r
)

773  
”r
;

775 ià((
©Œ
->
Ÿ_v®id
 & 
ATTR_UID
 &&

776 !
	`uid_eq
(
©Œ
->
Ÿ_uid
, 
šode
->
i_uid
)) ||

777 (
©Œ
->
Ÿ_v®id
 & 
ATTR_GID
 &&

778 !
	`gid_eq
(
©Œ
->
Ÿ_gid
, 
šode
->
i_gid
))) {

779 
”r
 = 
	`dquÙ_Œªsãr
(
šode
, 
©Œ
);

780 ià(
”r
)

781  
”r
;

784 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_SIZE
) {

785 ià(
©Œ
->
Ÿ_size
 <ğ
	`i_size_»ad
(
šode
)) {

786 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

787 
	`Œunÿ‹_£tsize
(
šode
, 
©Œ
->
Ÿ_size
);

788 
”r
 = 
	`f2fs_Œunÿ‹
(
šode
);

789 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

790 ià(
”r
)

791  
”r
;

797 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

798 
	`Œunÿ‹_£tsize
(
šode
, 
©Œ
->
Ÿ_size
);

799 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

802 ià(!
	`f2fs_may_šlše_d©a
(
šode
)) {

803 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

804 ià(
”r
)

805  
”r
;

807 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

810 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

811 
	`F2FS_I
(
šode
)->
Ï¡_disk_size
 = 
	`i_size_»ad
(inode);

812 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

814 
size_chªged
 = 
Œue
;

817 
	`__£‰r_cİy
(
šode
, 
©Œ
);

819 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_MODE
) {

820 
”r
 = 
	`posix_aş_chmod
(
šode
, 
	`f2fs_g‘_šode_mode
(inode));

821 ià(
”r
 || 
	`is_šode_æag_£t
(
šode
, 
FI_ACL_MODE
)) {

822 
šode
->
i_mode
 = 
	`F2FS_I
(šode)->
i_aş_mode
;

823 
	`ş—r_šode_æag
(
šode
, 
FI_ACL_MODE
);

828 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
size_chªged
);

831 
	`f2fs_b®ªû_fs
(
	`F2FS_I_SB
(
šode
), 
Œue
);

833  
”r
;

834 
	}
}

836 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_fe_šode_İ”©iÚs
 = {

837 .
g‘©Œ
 = 
f2fs_g‘©Œ
,

838 .
	g£‰r
 = 
f2fs_£‰r
,

839 .
	gg‘_aş
 = 
f2fs_g‘_aş
,

840 .
	g£t_aş
 = 
f2fs_£t_aş
,

841 #ifdeà
CONFIG_F2FS_FS_XATTR


842 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

844 .
	gf›m­
 = 
f2fs_f›m­
,

847 
	$fl_z”o
(
šode
 *šode, 
pgoff_t
 
šdex
,

848 
loff_t
 
¡¬t
,†off_ˆ
Ën
)

850 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

851 
·ge
 *page;

853 ià(!
Ën
)

856 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

858 
	`f2fs_lock_İ
(
sbi
);

859 
·ge
 = 
	`f2fs_g‘_Ãw_d©a_·ge
(
šode
, 
NULL
, 
šdex
, 
çl£
);

860 
	`f2fs_uÆock_İ
(
sbi
);

862 ià(
	`IS_ERR
(
·ge
))

863  
	`PTR_ERR
(
·ge
);

865 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
);

866 
	`z”o_u£r
(
·ge
, 
¡¬t
, 
Ën
);

867 
	`£t_·ge_dœty
(
·ge
);

868 
	`f2fs_put_·ge
(
·ge
, 1);

870 
	}
}

872 
	$f2fs_Œunÿ‹_hŞe
(
šode
 *šode, 
pgoff_t
 
pg_¡¬t
,…goff_ˆ
pg_’d
)

874 
”r
;

876 
pg_¡¬t
 < 
pg_’d
) {

877 
dnode_of_d©a
 
dn
;

878 
pgoff_t
 
’d_off£t
, 
couÁ
;

880 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

881 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
pg_¡¬t
, 
LOOKUP_NODE
);

882 ià(
”r
) {

883 ià(
”r
 =ğ-
ENOENT
) {

884 
pg_¡¬t
 = 
	`f2fs_g‘_Ãxt_·ge_off£t
(&
dn
,

885 
pg_¡¬t
);

888  
”r
;

891 
’d_off£t
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
šode
);

892 
couÁ
 = 
	`mš
(
’d_off£t
 - 
dn
.
ofs_š_node
, 
pg_’d
 - 
pg_¡¬t
);

894 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
), 
couÁ
 =ğ0 || couÁ > 
’d_off£t
);

896 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 
couÁ
);

897 
	`f2fs_put_dnode
(&
dn
);

899 
pg_¡¬t
 +ğ
couÁ
;

902 
	}
}

904 
	$punch_hŞe
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

906 
pgoff_t
 
pg_¡¬t
, 
pg_’d
;

907 
loff_t
 
off_¡¬t
, 
off_’d
;

908 
»t
;

910 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

911 ià(
»t
)

912  
»t
;

914 
pg_¡¬t
 = ((è
off£t
è>> 
PAGE_SHIFT
;

915 
pg_’d
 = ((è
off£t
 + 
Ën
è>> 
PAGE_SHIFT
;

917 
off_¡¬t
 = 
off£t
 & (
PAGE_SIZE
 - 1);

918 
off_’d
 = (
off£t
 + 
Ën
è& (
PAGE_SIZE
 - 1);

920 ià(
pg_¡¬t
 =ğ
pg_’d
) {

921 
»t
 = 
	`fl_z”o
(
šode
, 
pg_¡¬t
, 
off_¡¬t
,

922 
off_’d
 - 
off_¡¬t
);

923 ià(
»t
)

924  
»t
;

926 ià(
off_¡¬t
) {

927 
»t
 = 
	`fl_z”o
(
šode
, 
pg_¡¬t
++, 
off_¡¬t
,

928 
PAGE_SIZE
 - 
off_¡¬t
);

929 ià(
»t
)

930  
»t
;

932 ià(
off_’d
) {

933 
»t
 = 
	`fl_z”o
(
šode
, 
pg_’d
, 0, 
off_’d
);

934 ià(
»t
)

935  
»t
;

938 ià(
pg_¡¬t
 < 
pg_’d
) {

939 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

940 
loff_t
 
blk_¡¬t
, 
blk_’d
;

941 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

943 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

945 
blk_¡¬t
 = (
loff_t
)
pg_¡¬t
 << 
PAGE_SHIFT
;

946 
blk_’d
 = (
loff_t
)
pg_’d
 << 
PAGE_SHIFT
;

947 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

948 
	`Œunÿ‹_šode_·ges_¿nge
(
m­pšg
, 
blk_¡¬t
,

949 
blk_’d
 - 1);

951 
	`f2fs_lock_İ
(
sbi
);

952 
»t
 = 
	`f2fs_Œunÿ‹_hŞe
(
šode
, 
pg_¡¬t
, 
pg_’d
);

953 
	`f2fs_uÆock_İ
(
sbi
);

954 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

958  
»t
;

959 
	}
}

961 
	$__»ad_out_blkaddrs
(
šode
 *šode, 
block_t
 *
blkaddr
,

962 *
do_»¶aû
, 
pgoff_t
 
off
,…goff_ˆ
Ën
)

964 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

965 
dnode_of_d©a
 
dn
;

966 
»t
, 
dÚe
, 
i
;

968 
Ãxt_dnode
:

969 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

970 
»t
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
off
, 
LOOKUP_NODE_RA
);

971 ià(
»t
 &&„‘ !ğ-
ENOENT
) {

972  
»t
;

973 } ià(
»t
 =ğ-
ENOENT
) {

974 ià(
dn
.
max_Ëv–
 == 0)

975  -
ENOENT
;

976 
dÚe
 = 
	`mš
((
pgoff_t
)
ADDRS_PER_BLOCK
 - 
dn
.
ofs_š_node
, 
Ën
);

977 
blkaddr
 +ğ
dÚe
;

978 
do_»¶aû
 +ğ
dÚe
;

979 
Ãxt
;

982 
dÚe
 = 
	`mš
((
pgoff_t
)
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
šode
) -

983 
dn
.
ofs_š_node
, 
Ën
);

984 
i
 = 0; i < 
dÚe
; i++, 
blkaddr
++, 
do_»¶aû
++, 
dn
.
ofs_š_node
++) {

985 *
blkaddr
 = 
	`d©ablock_addr
(
dn
.
šode
,

986 
dn
.
node_·ge
, dn.
ofs_š_node
);

987 ià(!
	`f2fs_is_checkpoš‹d_d©a
(
sbi
, *
blkaddr
)) {

989 ià(
	`‹¡_İt
(
sbi
, 
LFS
)) {

990 
	`f2fs_put_dnode
(&
dn
);

991  -
ENOTSUPP
;

995 
	`f2fs_upd©e_d©a_blkaddr
(&
dn
, 
NULL_ADDR
);

996 *
do_»¶aû
 = 1;

999 
	`f2fs_put_dnode
(&
dn
);

1000 
Ãxt
:

1001 
Ën
 -ğ
dÚe
;

1002 
off
 +ğ
dÚe
;

1003 ià(
Ën
)

1004 
Ãxt_dnode
;

1006 
	}
}

1008 
	$__rŞl_back_blkaddrs
(
šode
 *šode, 
block_t
 *
blkaddr
,

1009 *
do_»¶aû
, 
pgoff_t
 
off
, 
Ën
)

1011 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1012 
dnode_of_d©a
 
dn
;

1013 
»t
, 
i
;

1015 
i
 = 0; i < 
Ën
; i++, 
do_»¶aû
++, 
blkaddr
++) {

1016 ià(*
do_»¶aû
 == 0)

1019 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

1020 
»t
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
off
 + 
i
, 
LOOKUP_NODE_RA
);

1021 ià(
»t
) {

1022 
	`dec_v®id_block_couÁ
(
sbi
, 
šode
, 1);

1023 
	`f2fs_šv®id©e_blocks
(
sbi
, *
blkaddr
);

1025 
	`f2fs_upd©e_d©a_blkaddr
(&
dn
, *
blkaddr
);

1027 
	`f2fs_put_dnode
(&
dn
);

1030 
	}
}

1032 
	$__şÚe_blkaddrs
(
šode
 *
¤c_šode
, šod*
d¡_šode
,

1033 
block_t
 *
blkaddr
, *
do_»¶aû
,

1034 
pgoff_t
 
¤c
,…goff_ˆ
d¡
,…goff_ˆ
Ën
, 
boŞ
 
fuÎ
)

1036 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
¤c_šode
);

1037 
pgoff_t
 
i
 = 0;

1038 
»t
;

1040 
i
 < 
Ën
) {

1041 ià(
blkaddr
[
i
] =ğ
NULL_ADDR
 && !
fuÎ
) {

1042 
i
++;

1046 ià(
do_»¶aû
[
i
] || 
blkaddr
[i] =ğ
NULL_ADDR
) {

1047 
dnode_of_d©a
 
dn
;

1048 
node_šfo
 
ni
;

1049 
size_t
 
Ãw_size
;

1050 
pgoff_t
 
’
;

1052 
	`£t_Ãw_dnode
(&
dn
, 
d¡_šode
, 
NULL
, NULL, 0);

1053 
»t
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
d¡
 + 
i
, 
ALLOC_NODE
);

1054 ià(
»t
)

1055  
»t
;

1057 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
.
nid
, &
ni
);

1058 
’
 = 
	`mš
((
pgoff_t
)

1059 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
d¡_šode
) -

1060 
dn
.
ofs_š_node
, 
Ën
 - 
i
);

1062 
dn
.
d©a_blkaddr
 = 
	`d©ablock_addr
(dn.
šode
,

1063 
dn
.
node_·ge
, dn.
ofs_š_node
);

1064 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 1);

1066 ià(
do_»¶aû
[
i
]) {

1067 
	`f2fs_i_blocks_wr™e
(
¤c_šode
,

1068 1, 
çl£
, false);

1069 
	`f2fs_i_blocks_wr™e
(
d¡_šode
,

1070 1, 
Œue
, 
çl£
);

1071 
	`f2fs_»¶aû_block
(
sbi
, &
dn
, dn.
d©a_blkaddr
,

1072 
blkaddr
[
i
], 
ni
.
v”siÚ
, 
Œue
, 
çl£
);

1074 
do_»¶aû
[
i
] = 0;

1076 
dn
.
ofs_š_node
++;

1077 
i
++;

1078 
Ãw_size
 = (
d¡
 + 
i
è<< 
PAGE_SHIFT
;

1079 ià(
d¡_šode
->
i_size
 < 
Ãw_size
)

1080 
	`f2fs_i_size_wr™e
(
d¡_šode
, 
Ãw_size
);

1081 } --
’
 && (
do_»¶aû
[
i
] || 
blkaddr
[i] =ğ
NULL_ADDR
));

1083 
	`f2fs_put_dnode
(&
dn
);

1085 
·ge
 *
p¤c
, *
pd¡
;

1087 
p¤c
 = 
	`f2fs_g‘_lock_d©a_·ge
(
¤c_šode
,

1088 
¤c
 + 
i
, 
Œue
);

1089 ià(
	`IS_ERR
(
p¤c
))

1090  
	`PTR_ERR
(
p¤c
);

1091 
pd¡
 = 
	`f2fs_g‘_Ãw_d©a_·ge
(
d¡_šode
, 
NULL
, 
d¡
 + 
i
,

1092 
Œue
);

1093 ià(
	`IS_ERR
(
pd¡
)) {

1094 
	`f2fs_put_·ge
(
p¤c
, 1);

1095  
	`PTR_ERR
(
pd¡
);

1097 
	`f2fs_cİy_·ge
(
p¤c
, 
pd¡
);

1098 
	`£t_·ge_dœty
(
pd¡
);

1099 
	`f2fs_put_·ge
(
pd¡
, 1);

1100 
	`f2fs_put_·ge
(
p¤c
, 1);

1102 
»t
 = 
	`f2fs_Œunÿ‹_hŞe
(
¤c_šode
,

1103 
¤c
 + 
i
, src + i + 1);

1104 ià(
»t
)

1105  
»t
;

1106 
i
++;

1110 
	}
}

1112 
	$__exchªge_d©a_block
(
šode
 *
¤c_šode
,

1113 
šode
 *
d¡_šode
, 
pgoff_t
 
¤c
,…goff_ˆ
d¡
,

1114 
pgoff_t
 
Ën
, 
boŞ
 
fuÎ
)

1116 
block_t
 *
¤c_blkaddr
;

1117 *
do_»¶aû
;

1118 
pgoff_t
 
Ş’
;

1119 
»t
;

1121 
Ën
) {

1122 
Ş’
 = 
	`mš
((
pgoff_t
)4 * 
ADDRS_PER_BLOCK
, 
Ën
);

1124 
¤c_blkaddr
 = 
	`f2fs_kvz®loc
(
	`F2FS_I_SB
(
¤c_šode
),

1125 
	`¬¿y_size
(
Ş’
, (
block_t
)),

1126 
GFP_KERNEL
);

1127 ià(!
¤c_blkaddr
)

1128  -
ENOMEM
;

1130 
do_»¶aû
 = 
	`f2fs_kvz®loc
(
	`F2FS_I_SB
(
¤c_šode
),

1131 
	`¬¿y_size
(
Ş’
, ()),

1132 
GFP_KERNEL
);

1133 ià(!
do_»¶aû
) {

1134 
	`kvä“
(
¤c_blkaddr
);

1135  -
ENOMEM
;

1138 
»t
 = 
	`__»ad_out_blkaddrs
(
¤c_šode
, 
¤c_blkaddr
,

1139 
do_»¶aû
, 
¤c
, 
Ş’
);

1140 ià(
»t
)

1141 
rŞl_back
;

1143 
»t
 = 
	`__şÚe_blkaddrs
(
¤c_šode
, 
d¡_šode
, 
¤c_blkaddr
,

1144 
do_»¶aû
, 
¤c
, 
d¡
, 
Ş’
, 
fuÎ
);

1145 ià(
»t
)

1146 
rŞl_back
;

1148 
¤c
 +ğ
Ş’
;

1149 
d¡
 +ğ
Ş’
;

1150 
Ën
 -ğ
Ş’
;

1152 
	`kvä“
(
¤c_blkaddr
);

1153 
	`kvä“
(
do_»¶aû
);

1157 
rŞl_back
:

1158 
	`__rŞl_back_blkaddrs
(
¤c_šode
, 
¤c_blkaddr
, 
do_»¶aû
, 
¤c
, 
Ş’
);

1159 
	`kvä“
(
¤c_blkaddr
);

1160 
	`kvä“
(
do_»¶aû
);

1161  
»t
;

1162 
	}
}

1164 
	$f2fs_do_cŞÏp£
(
šode
 *šode, 
pgoff_t
 
¡¬t
,…goff_ˆ
’d
)

1166 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1167 
pgoff_t
 
Ä·ges
 = (
	`i_size_»ad
(
šode
è+ 
PAGE_SIZE
 - 1) / PAGE_SIZE;

1168 
»t
;

1170 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

1171 
	`f2fs_lock_İ
(
sbi
);

1173 
	`f2fs_drİ_ex‹Á_Œ“
(
šode
);

1175 
»t
 = 
	`__exchªge_d©a_block
(
šode
, inode, 
’d
, 
¡¬t
, 
Ä·ges
 -ƒnd, 
Œue
);

1176 
	`f2fs_uÆock_İ
(
sbi
);

1177  
»t
;

1178 
	}
}

1180 
	$f2fs_cŞÏp£_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

1182 
pgoff_t
 
pg_¡¬t
, 
pg_’d
;

1183 
loff_t
 
Ãw_size
;

1184 
»t
;

1186 ià(
off£t
 + 
Ën
 >ğ
	`i_size_»ad
(
šode
))

1187  -
EINVAL
;

1190 ià(
off£t
 & (
F2FS_BLKSIZE
 - 1è|| 
Ën
 & (F2FS_BLKSIZE - 1))

1191  -
EINVAL
;

1193 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1194 ià(
»t
)

1195  
»t
;

1197 
pg_¡¬t
 = 
off£t
 >> 
PAGE_SHIFT
;

1198 
pg_’d
 = (
off£t
 + 
Ën
è>> 
PAGE_SHIFT
;

1201 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1203 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1205 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
off£t
, 
LLONG_MAX
);

1206 ià(
»t
)

1207 
out_uÆock
;

1209 
	`Œunÿ‹_·geÿche
(
šode
, 
off£t
);

1211 
»t
 = 
	`f2fs_do_cŞÏp£
(
šode
, 
pg_¡¬t
, 
pg_’d
);

1212 ià(
»t
)

1213 
out_uÆock
;

1216 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
off£t
, 
LLONG_MAX
);

1217 
	`Œunÿ‹_·geÿche
(
šode
, 
off£t
);

1219 
Ãw_size
 = 
	`i_size_»ad
(
šode
è- 
Ën
;

1220 
	`Œunÿ‹_·geÿche
(
šode
, 
Ãw_size
);

1222 
»t
 = 
	`f2fs_Œunÿ‹_blocks
(
šode
, 
Ãw_size
, 
Œue
);

1223 ià(!
»t
)

1224 
	`f2fs_i_size_wr™e
(
šode
, 
Ãw_size
);

1225 
out_uÆock
:

1226 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1227 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1228  
»t
;

1229 
	}
}

1231 
	$f2fs_do_z”o_¿nge
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
¡¬t
,

1232 
pgoff_t
 
’d
)

1234 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

1235 
pgoff_t
 
šdex
 = 
¡¬t
;

1236 
ofs_š_node
 = 
dn
->ofs_in_node;

1237 
blkút_t
 
couÁ
 = 0;

1238 
»t
;

1240 ; 
šdex
 < 
’d
; index++, 
dn
->
ofs_š_node
++) {

1241 ià(
	`d©ablock_addr
(
dn
->
šode
, dn->
node_·ge
,

1242 
dn
->
ofs_š_node
è=ğ
NULL_ADDR
)

1243 
couÁ
++;

1246 
dn
->
ofs_š_node
 = ofs_in_node;

1247 
»t
 = 
	`f2fs_»£rve_Ãw_blocks
(
dn
, 
couÁ
);

1248 ià(
»t
)

1249  
»t
;

1251 
dn
->
ofs_š_node
 = ofs_in_node;

1252 
šdex
 = 
¡¬t
; index < 
’d
; index++, 
dn
->
ofs_š_node
++) {

1253 
dn
->
d©a_blkaddr
 = 
	`d©ablock_addr
(dn->
šode
,

1254 
dn
->
node_·ge
, dn->
ofs_š_node
);

1259 ià(
dn
->
d©a_blkaddr
 =ğ
NULL_ADDR
) {

1260 
»t
 = -
ENOSPC
;

1263 ià(
dn
->
d©a_blkaddr
 !ğ
NEW_ADDR
) {

1264 
	`f2fs_šv®id©e_blocks
(
sbi
, 
dn
->
d©a_blkaddr
);

1265 
dn
->
d©a_blkaddr
 = 
NEW_ADDR
;

1266 
	`f2fs_£t_d©a_blkaddr
(
dn
);

1270 
	`f2fs_upd©e_ex‹Á_ÿche_¿nge
(
dn
, 
¡¬t
, 0, 
šdex
 - start);

1272  
»t
;

1273 
	}
}

1275 
	$f2fs_z”o_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
,

1276 
mode
)

1278 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1279 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

1280 
pgoff_t
 
šdex
, 
pg_¡¬t
, 
pg_’d
;

1281 
loff_t
 
Ãw_size
 = 
	`i_size_»ad
(
šode
);

1282 
loff_t
 
off_¡¬t
, 
off_’d
;

1283 
»t
 = 0;

1285 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, (
Ën
 + 
off£t
));

1286 ià(
»t
)

1287  
»t
;

1289 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1290 ià(
»t
)

1291  
»t
;

1293 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1294 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
m­pšg
, 
off£t
, off£ˆ+ 
Ën
 - 1);

1295 ià(
»t
)

1296 
out_£m
;

1298 
	`Œunÿ‹_·geÿche_¿nge
(
šode
, 
off£t
, off£ˆ+ 
Ën
 - 1);

1300 
pg_¡¬t
 = ((è
off£t
è>> 
PAGE_SHIFT
;

1301 
pg_’d
 = ((è
off£t
 + 
Ën
è>> 
PAGE_SHIFT
;

1303 
off_¡¬t
 = 
off£t
 & (
PAGE_SIZE
 - 1);

1304 
off_’d
 = (
off£t
 + 
Ën
è& (
PAGE_SIZE
 - 1);

1306 ià(
pg_¡¬t
 =ğ
pg_’d
) {

1307 
»t
 = 
	`fl_z”o
(
šode
, 
pg_¡¬t
, 
off_¡¬t
,

1308 
off_’d
 - 
off_¡¬t
);

1309 ià(
»t
)

1310 
out_£m
;

1312 
Ãw_size
 = 
	`max_t
(
loff_t
,‚ew_size, 
off£t
 + 
Ën
);

1314 ià(
off_¡¬t
) {

1315 
»t
 = 
	`fl_z”o
(
šode
, 
pg_¡¬t
++, 
off_¡¬t
,

1316 
PAGE_SIZE
 - 
off_¡¬t
);

1317 ià(
»t
)

1318 
out_£m
;

1320 
Ãw_size
 = 
	`max_t
(
loff_t
,‚ew_size,

1321 (
loff_t
)
pg_¡¬t
 << 
PAGE_SHIFT
);

1324 
šdex
 = 
pg_¡¬t
; index < 
pg_’d
;) {

1325 
dnode_of_d©a
 
dn
;

1326 
’d_off£t
;

1327 
pgoff_t
 
’d
;

1329 
	`f2fs_lock_İ
(
sbi
);

1331 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

1332 
»t
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
šdex
, 
ALLOC_NODE
);

1333 ià(
»t
) {

1334 
	`f2fs_uÆock_İ
(
sbi
);

1335 
out
;

1338 
’d_off£t
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
šode
);

1339 
’d
 = 
	`mš
(
pg_’d
, 
’d_off£t
 - 
dn
.
ofs_š_node
 + 
šdex
);

1341 
»t
 = 
	`f2fs_do_z”o_¿nge
(&
dn
, 
šdex
, 
’d
);

1342 
	`f2fs_put_dnode
(&
dn
);

1343 
	`f2fs_uÆock_İ
(
sbi
);

1345 
	`f2fs_b®ªû_fs
(
sbi
, 
dn
.
node_chªged
);

1347 ià(
»t
)

1348 
out
;

1350 
šdex
 = 
’d
;

1351 
Ãw_size
 = 
	`max_t
(
loff_t
,‚ew_size,

1352 (
loff_t
)
šdex
 << 
PAGE_SHIFT
);

1355 ià(
off_’d
) {

1356 
»t
 = 
	`fl_z”o
(
šode
, 
pg_’d
, 0, 
off_’d
);

1357 ià(
»t
)

1358 
out
;

1360 
Ãw_size
 = 
	`max_t
(
loff_t
,‚ew_size, 
off£t
 + 
Ën
);

1364 
out
:

1365 ià(
Ãw_size
 > 
	`i_size_»ad
(
šode
)) {

1366 ià(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

1367 
	`fe_£t_k“p_isize
(
šode
);

1369 
	`f2fs_i_size_wr™e
(
šode
, 
Ãw_size
);

1371 
out_£m
:

1372 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1374  
»t
;

1375 
	}
}

1377 
	$f2fs_š£¹_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

1379 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1380 
pgoff_t
 
Ä
, 
pg_¡¬t
, 
pg_’d
, 
d–
, 
idx
;

1381 
loff_t
 
Ãw_size
;

1382 
»t
 = 0;

1384 
Ãw_size
 = 
	`i_size_»ad
(
šode
è+ 
Ën
;

1385 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, 
Ãw_size
);

1386 ià(
»t
)

1387  
»t
;

1389 ià(
off£t
 >ğ
	`i_size_»ad
(
šode
))

1390  -
EINVAL
;

1393 ià(
off£t
 & (
F2FS_BLKSIZE
 - 1è|| 
Ën
 & (F2FS_BLKSIZE - 1))

1394  -
EINVAL
;

1396 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1397 ià(
»t
)

1398  
»t
;

1400 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

1403 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1405 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1406 
»t
 = 
	`f2fs_Œunÿ‹_blocks
(
šode
, 
	`i_size_»ad
(šode), 
Œue
);

1407 ià(
»t
)

1408 
out
;

1411 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
off£t
, 
LLONG_MAX
);

1412 ià(
»t
)

1413 
out
;

1415 
	`Œunÿ‹_·geÿche
(
šode
, 
off£t
);

1417 
pg_¡¬t
 = 
off£t
 >> 
PAGE_SHIFT
;

1418 
pg_’d
 = (
off£t
 + 
Ën
è>> 
PAGE_SHIFT
;

1419 
d–
 = 
pg_’d
 - 
pg_¡¬t
;

1420 
idx
 = (
	`i_size_»ad
(
šode
è+ 
PAGE_SIZE
 - 1) / PAGE_SIZE;

1422 !
»t
 && 
idx
 > 
pg_¡¬t
) {

1423 
Ä
 = 
idx
 - 
pg_¡¬t
;

1424 ià(
Ä
 > 
d–
)

1425 
Ä
 = 
d–
;

1426 
idx
 -ğ
Ä
;

1428 
	`f2fs_lock_İ
(
sbi
);

1429 
	`f2fs_drİ_ex‹Á_Œ“
(
šode
);

1431 
»t
 = 
	`__exchªge_d©a_block
(
šode
, inode, 
idx
,

1432 
idx
 + 
d–
, 
Ä
, 
çl£
);

1433 
	`f2fs_uÆock_İ
(
sbi
);

1437 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
off£t
, 
LLONG_MAX
);

1438 
	`Œunÿ‹_·geÿche
(
šode
, 
off£t
);

1440 ià(!
»t
)

1441 
	`f2fs_i_size_wr™e
(
šode
, 
Ãw_size
);

1442 
out
:

1443 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1444 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1445  
»t
;

1446 
	}
}

1448 
	$ex·nd_šode_d©a
(
šode
 *šode, 
loff_t
 
off£t
,

1449 
loff_t
 
Ën
, 
mode
)

1451 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1452 
f2fs_m­_blocks
 
m­
 = { .
m_Ãxt_pgofs
 = 
NULL
,

1453 .
m_Ãxt_ex‹Á
 = 
NULL
, .
m_£g_ty³
 = 
NO_CHECK_TYPE
 };

1454 
pgoff_t
 
pg_’d
;

1455 
loff_t
 
Ãw_size
 = 
	`i_size_»ad
(
šode
);

1456 
loff_t
 
off_’d
;

1457 
”r
;

1459 
”r
 = 
	`šode_Ãwsize_ok
(
šode
, (
Ën
 + 
off£t
));

1460 ià(
”r
)

1461  
”r
;

1463 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1464 ià(
”r
)

1465  
”r
;

1467 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

1469 
pg_’d
 = (()
off£t
 + 
Ën
è>> 
PAGE_SHIFT
;

1470 
off_’d
 = (
off£t
 + 
Ën
è& (
PAGE_SIZE
 - 1);

1472 
m­
.
m_lblk
 = (()
off£t
è>> 
PAGE_SHIFT
;

1473 
m­
.
m_Ën
 = 
pg_’d
 - m­.
m_lblk
;

1474 ià(
off_’d
)

1475 
m­
.
m_Ën
++;

1477 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 1, 
F2FS_GET_BLOCK_PRE_AIO
);

1478 ià(
”r
) {

1479 
pgoff_t
 
Ï¡_off
;

1481 ià(!
m­
.
m_Ën
)

1482  
”r
;

1484 
Ï¡_off
 = 
m­
.
m_lblk
 + m­.
m_Ën
 - 1;

1487 
Ãw_size
 = (
Ï¡_off
 =ğ
pg_’d
è? 
off£t
 + 
Ën
 :

1488 (
loff_t
)(
Ï¡_off
 + 1è<< 
PAGE_SHIFT
;

1490 
Ãw_size
 = ((
loff_t
)
pg_’d
 << 
PAGE_SHIFT
è+ 
off_’d
;

1493 ià(
Ãw_size
 > 
	`i_size_»ad
(
šode
)) {

1494 ià(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

1495 
	`fe_£t_k“p_isize
(
šode
);

1497 
	`f2fs_i_size_wr™e
(
šode
, 
Ãw_size
);

1500  
”r
;

1501 
	}
}

1503 
	$f2fs_çÎoÿ‹
(
fe
 *fe, 
mode
,

1504 
loff_t
 
off£t
,†off_ˆ
Ën
)

1506 
šode
 *šodğ
	`fe_šode
(
fe
);

1507 
»t
 = 0;

1509 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
))))

1510  -
EIO
;

1513 ià(!
	`S_ISREG
(
šode
->
i_mode
))

1514  -
EINVAL
;

1516 ià(
	`f2fs_’üy±ed_šode
(
šode
) &&

1517 (
mode
 & (
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_INSERT_RANGE
)))

1518  -
EOPNOTSUPP
;

1520 ià(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
 |

1521 
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_ZERO_RANGE
 |

1522 
FALLOC_FL_INSERT_RANGE
))

1523  -
EOPNOTSUPP
;

1525 
	`šode_lock
(
šode
);

1527 ià(
mode
 & 
FALLOC_FL_PUNCH_HOLE
) {

1528 ià(
off£t
 >ğ
šode
->
i_size
)

1529 
out
;

1531 
»t
 = 
	`punch_hŞe
(
šode
, 
off£t
, 
Ën
);

1532 } ià(
mode
 & 
FALLOC_FL_COLLAPSE_RANGE
) {

1533 
»t
 = 
	`f2fs_cŞÏp£_¿nge
(
šode
, 
off£t
, 
Ën
);

1534 } ià(
mode
 & 
FALLOC_FL_ZERO_RANGE
) {

1535 
»t
 = 
	`f2fs_z”o_¿nge
(
šode
, 
off£t
, 
Ën
, 
mode
);

1536 } ià(
mode
 & 
FALLOC_FL_INSERT_RANGE
) {

1537 
»t
 = 
	`f2fs_š£¹_¿nge
(
šode
, 
off£t
, 
Ën
);

1539 
»t
 = 
	`ex·nd_šode_d©a
(
šode
, 
off£t
, 
Ën
, 
mode
);

1542 ià(!
»t
) {

1543 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

1544 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

1545 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

1548 
out
:

1549 
	`šode_uÆock
(
šode
);

1551 
	`Œaû_f2fs_çÎoÿ‹
(
šode
, 
mode
, 
off£t
, 
Ën
, 
»t
);

1552  
»t
;

1553 
	}
}

1555 
	$f2fs_»Ëa£_fe
(
šode
 *šode, 
fe
 *
fp
)

1561 ià(!(
fp
->
f_mode
 & 
FMODE_WRITE
) ||

1562 
	`©omic_»ad
(&
šode
->
i_wr™ecouÁ
) != 1)

1566 ià(
	`f2fs_is_©omic_fe
(
šode
))

1567 
	`f2fs_drİ_šmem_·ges
(
šode
);

1568 ià(
	`f2fs_is_vŞ©e_fe
(
šode
)) {

1569 
	`£t_šode_æag
(
šode
, 
FI_DROP_CACHE
);

1570 
	`fem­_fd©awr™e
(
šode
->
i_m­pšg
);

1571 
	`ş—r_šode_æag
(
šode
, 
FI_DROP_CACHE
);

1572 
	`ş—r_šode_æag
(
šode
, 
FI_VOLATILE_FILE
);

1573 
	`¡©_dec_vŞ©e_wr™e
(
šode
);

1576 
	}
}

1578 
	$f2fs_fe_æush
(
fe
 *fe, 
æ_owÃr_t
 
id
)

1580 
šode
 *šodğ
	`fe_šode
(
fe
);

1588 ià(
	`f2fs_is_©omic_fe
(
šode
) &&

1589 
	`F2FS_I
(
šode
)->
šmem_sk
 =ğ
cu¼’t
)

1590 
	`f2fs_drİ_šmem_·ges
(
šode
);

1592 
	}
}

1594 
	$f2fs_ioc_g‘æags
(
fe
 *
fp
, 
¬g
)

1596 
šode
 *šodğ
	`fe_šode
(
fp
);

1597 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

1598 
æags
 = 
fi
->
i_æags
;

1600 ià(
	`fe_is_’üy±
(
šode
))

1601 
æags
 |ğ
F2FS_ENCRYPT_FL
;

1602 ià(
	`f2fs_has_šlše_d©a
(
šode
è|| 
	`f2fs_has_šlše_d’Œy
(inode))

1603 
æags
 |ğ
F2FS_INLINE_DATA_FL
;

1605 
æags
 &ğ
F2FS_FL_USER_VISIBLE
;

1607  
	`put_u£r
(
æags
, (
__u£r
 *)
¬g
);

1608 
	}
}

1610 
	$__f2fs_ioc_£tæags
(
šode
 *šode, 
æags
)

1612 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

1613 
Şdæags
;

1616 ià(
	`IS_NOQUOTA
(
šode
))

1617  -
EPERM
;

1619 
æags
 = 
	`f2fs_mask_æags
(
šode
->
i_mode
, flags);

1621 
Şdæags
 = 
fi
->
i_æags
;

1623 ià((
æags
 ^ 
Şdæags
è& (
F2FS_APPEND_FL
 | 
F2FS_IMMUTABLE_FL
))

1624 ià(!
	`ÿ·bË
(
CAP_LINUX_IMMUTABLE
))

1625  -
EPERM
;

1627 
æags
 = fÏg & 
F2FS_FL_USER_MODIFIABLE
;

1628 
æags
 |ğ
Şdæags
 & ~
F2FS_FL_USER_MODIFIABLE
;

1629 
fi
->
i_æags
 = 
æags
;

1631 ià(
fi
->
i_æags
 & 
F2FS_PROJINHERIT_FL
)

1632 
	`£t_šode_æag
(
šode
, 
FI_PROJ_INHERIT
);

1634 
	`ş—r_šode_æag
(
šode
, 
FI_PROJ_INHERIT
);

1636 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

1637 
	`f2fs_£t_šode_æags
(
šode
);

1638 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

1640 
	}
}

1642 
	$f2fs_ioc_£tæags
(
fe
 *
fp
, 
¬g
)

1644 
šode
 *šodğ
	`fe_šode
(
fp
);

1645 
æags
;

1646 
»t
;

1648 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1649  -
EACCES
;

1651 ià(
	`g‘_u£r
(
æags
, (
__u£r
 *)
¬g
))

1652  -
EFAULT
;

1654 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1655 ià(
»t
)

1656  
»t
;

1658 
	`šode_lock
(
šode
);

1660 
»t
 = 
	`__f2fs_ioc_£tæags
(
šode
, 
æags
);

1662 
	`šode_uÆock
(
šode
);

1663 
	`mÁ_drİ_wr™e_fe
(
fp
);

1664  
»t
;

1665 
	}
}

1667 
	$f2fs_ioc_g‘v”siÚ
(
fe
 *
fp
, 
¬g
)

1669 
šode
 *šodğ
	`fe_šode
(
fp
);

1671  
	`put_u£r
(
šode
->
i_g’”©iÚ
, (
__u£r
 *)
¬g
);

1672 
	}
}

1674 
	$f2fs_ioc_¡¬t_©omic_wr™e
(
fe
 *
fp
)

1676 
šode
 *šodğ
	`fe_šode
(
fp
);

1677 
»t
;

1679 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1680  -
EACCES
;

1682 ià(!
	`S_ISREG
(
šode
->
i_mode
))

1683  -
EINVAL
;

1685 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1686 ià(
»t
)

1687  
»t
;

1689 
	`šode_lock
(
šode
);

1691 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1693 ià(
	`f2fs_is_©omic_fe
(
šode
))

1694 
out
;

1696 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1697 ià(
»t
)

1698 
out
;

1700 ià(!
	`g‘_dœty_·ges
(
šode
))

1701 
sk_æush
;

1703 
	`f2fs_msg
(
	`F2FS_I_SB
(
šode
)->
sb
, 
KERN_WARNING
,

1705 
šode
->
i_šo
, 
	`g‘_dœty_·ges
(inode));

1706 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 0, 
LLONG_MAX
);

1707 ià(
»t
)

1708 
out
;

1709 
sk_æush
:

1710 
	`£t_šode_æag
(
šode
, 
FI_ATOMIC_FILE
);

1711 
	`ş—r_šode_æag
(
šode
, 
FI_ATOMIC_REVOKE_REQUEST
);

1712 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

1714 
	`F2FS_I
(
šode
)->
šmem_sk
 = 
cu¼’t
;

1715 
	`¡©_šc_©omic_wr™e
(
šode
);

1716 
	`¡©_upd©e_max_©omic_wr™e
(
šode
);

1717 
out
:

1718 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1719 
	`šode_uÆock
(
šode
);

1720 
	`mÁ_drİ_wr™e_fe
(
fp
);

1721  
»t
;

1722 
	}
}

1724 
	$f2fs_ioc_comm™_©omic_wr™e
(
fe
 *
fp
)

1726 
šode
 *šodğ
	`fe_šode
(
fp
);

1727 
»t
;

1729 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1730  -
EACCES
;

1732 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1733 ià(
»t
)

1734  
»t
;

1736 
	`šode_lock
(
šode
);

1738 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1740 ià(
	`f2fs_is_vŞ©e_fe
(
šode
)) {

1741 
»t
 = -
EINVAL
;

1742 
”r_out
;

1745 ià(
	`f2fs_is_©omic_fe
(
šode
)) {

1746 
»t
 = 
	`f2fs_comm™_šmem_·ges
(
šode
);

1747 ià(
»t
)

1748 
”r_out
;

1750 
»t
 = 
	`f2fs_do_sync_fe
(
fp
, 0, 
LLONG_MAX
, 0, 
Œue
);

1751 ià(!
»t
) {

1752 
	`ş—r_šode_æag
(
šode
, 
FI_ATOMIC_FILE
);

1753 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_ATOMIC
] = 0;

1754 
	`¡©_dec_©omic_wr™e
(
šode
);

1757 
»t
 = 
	`f2fs_do_sync_fe
(
fp
, 0, 
LLONG_MAX
, 1, 
çl£
);

1759 
”r_out
:

1760 ià(
	`is_šode_æag_£t
(
šode
, 
FI_ATOMIC_REVOKE_REQUEST
)) {

1761 
	`ş—r_šode_æag
(
šode
, 
FI_ATOMIC_REVOKE_REQUEST
);

1762 
»t
 = -
EINVAL
;

1764 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1765 
	`šode_uÆock
(
šode
);

1766 
	`mÁ_drİ_wr™e_fe
(
fp
);

1767  
»t
;

1768 
	}
}

1770 
	$f2fs_ioc_¡¬t_vŞ©e_wr™e
(
fe
 *
fp
)

1772 
šode
 *šodğ
	`fe_šode
(
fp
);

1773 
»t
;

1775 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1776  -
EACCES
;

1778 ià(!
	`S_ISREG
(
šode
->
i_mode
))

1779  -
EINVAL
;

1781 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1782 ià(
»t
)

1783  
»t
;

1785 
	`šode_lock
(
šode
);

1787 ià(
	`f2fs_is_vŞ©e_fe
(
šode
))

1788 
out
;

1790 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1791 ià(
»t
)

1792 
out
;

1794 
	`¡©_šc_vŞ©e_wr™e
(
šode
);

1795 
	`¡©_upd©e_max_vŞ©e_wr™e
(
šode
);

1797 
	`£t_šode_æag
(
šode
, 
FI_VOLATILE_FILE
);

1798 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

1799 
out
:

1800 
	`šode_uÆock
(
šode
);

1801 
	`mÁ_drİ_wr™e_fe
(
fp
);

1802  
»t
;

1803 
	}
}

1805 
	$f2fs_ioc_»Ëa£_vŞ©e_wr™e
(
fe
 *
fp
)

1807 
šode
 *šodğ
	`fe_šode
(
fp
);

1808 
»t
;

1810 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1811  -
EACCES
;

1813 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1814 ià(
»t
)

1815  
»t
;

1817 
	`šode_lock
(
šode
);

1819 ià(!
	`f2fs_is_vŞ©e_fe
(
šode
))

1820 
out
;

1822 ià(!
	`f2fs_is_fœ¡_block_wr™‹n
(
šode
)) {

1823 
»t
 = 
	`Œunÿ‹_·¹Ÿl_d©a_·ge
(
šode
, 0, 
Œue
);

1824 
out
;

1827 
»t
 = 
	`punch_hŞe
(
šode
, 0, 
F2FS_BLKSIZE
);

1828 
out
:

1829 
	`šode_uÆock
(
šode
);

1830 
	`mÁ_drİ_wr™e_fe
(
fp
);

1831  
»t
;

1832 
	}
}

1834 
	$f2fs_ioc_abÜt_vŞ©e_wr™e
(
fe
 *
fp
)

1836 
šode
 *šodğ
	`fe_šode
(
fp
);

1837 
»t
;

1839 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1840  -
EACCES
;

1842 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1843 ià(
»t
)

1844  
»t
;

1846 
	`šode_lock
(
šode
);

1848 ià(
	`f2fs_is_©omic_fe
(
šode
))

1849 
	`f2fs_drİ_šmem_·ges
(
šode
);

1850 ià(
	`f2fs_is_vŞ©e_fe
(
šode
)) {

1851 
	`ş—r_šode_æag
(
šode
, 
FI_VOLATILE_FILE
);

1852 
	`¡©_dec_vŞ©e_wr™e
(
šode
);

1853 
»t
 = 
	`f2fs_do_sync_fe
(
fp
, 0, 
LLONG_MAX
, 0, 
Œue
);

1856 
	`šode_uÆock
(
šode
);

1858 
	`mÁ_drİ_wr™e_fe
(
fp
);

1859 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

1860  
»t
;

1861 
	}
}

1863 
	$f2fs_ioc_shutdown
(
fe
 *
fp
, 
¬g
)

1865 
šode
 *šodğ
	`fe_šode
(
fp
);

1866 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1867 
su³r_block
 *
sb
 = 
sbi
->sb;

1868 
__u32
 
š
;

1869 
»t
;

1871 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1872  -
EPERM
;

1874 ià(
	`g‘_u£r
(
š
, (
__u32
 
__u£r
 *)
¬g
))

1875  -
EFAULT
;

1877 ià(
š
 !ğ
F2FS_GOING_DOWN_FULLSYNC
) {

1878 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1879 ià(
»t
)

1880  
»t
;

1883 
š
) {

1884 
F2FS_GOING_DOWN_FULLSYNC
:

1885 
sb
 = 
	`ä“ze_bdev
(sb->
s_bdev
);

1886 ià(
	`IS_ERR
(
sb
)) {

1887 
»t
 = 
	`PTR_ERR
(
sb
);

1888 
out
;

1890 ià(
sb
) {

1891 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

1892 
	`thaw_bdev
(
sb
->
s_bdev
, sb);

1895 
F2FS_GOING_DOWN_METASYNC
:

1897 
»t
 = 
	`f2fs_sync_fs
(
sb
, 1);

1898 ià(
»t
)

1899 
out
;

1900 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

1902 
F2FS_GOING_DOWN_NOSYNC
:

1903 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

1905 
F2FS_GOING_DOWN_METAFLUSH
:

1906 
	`f2fs_sync_m‘a_·ges
(
sbi
, 
META
, 
LONG_MAX
, 
FS_META_IO
);

1907 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

1910 
»t
 = -
EINVAL
;

1911 
out
;

1914 
	`f2fs_¡İ_gc_th»ad
(
sbi
);

1915 
	`f2fs_¡İ_disÿrd_th»ad
(
sbi
);

1917 
	`f2fs_drİ_disÿrd_cmd
(
sbi
);

1918 
	`ş—r_İt
(
sbi
, 
DISCARD
);

1920 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

1921 
out
:

1922 ià(
š
 !ğ
F2FS_GOING_DOWN_FULLSYNC
)

1923 
	`mÁ_drİ_wr™e_fe
(
fp
);

1924  
»t
;

1925 
	}
}

1927 
	$f2fs_ioc_f™rim
(
fe
 *
fp
, 
¬g
)

1929 
šode
 *šodğ
	`fe_šode
(
fp
);

1930 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1931 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
sb
->
s_bdev
);

1932 
f¡rim_¿nge
 
¿nge
;

1933 
»t
;

1935 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1936  -
EPERM
;

1938 ià(!
	`blk_queue_disÿrd
(
q
))

1939  -
EOPNOTSUPP
;

1941 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f¡rim_¿nge
 
__u£r
 *)
¬g
,

1942 (
¿nge
)))

1943  -
EFAULT
;

1945 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1946 ià(
»t
)

1947  
»t
;

1949 
¿nge
.
mšËn
 = 
	`max
(()range.minlen,

1950 
q
->
lim™s
.
disÿrd_g¿nuÏr™y
);

1951 
»t
 = 
	`f2fs_Œim_fs
(
	`F2FS_SB
(
sb
), &
¿nge
);

1952 
	`mÁ_drİ_wr™e_fe
(
fp
);

1953 ià(
»t
 < 0)

1954  
»t
;

1956 ià(
	`cİy_to_u£r
((
f¡rim_¿nge
 
__u£r
 *)
¬g
, &
¿nge
,

1957 (
¿nge
)))

1958  -
EFAULT
;

1959 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

1961 
	}
}

1963 
boŞ
 
	$uuid_is_nÚz”o
(
__u8
 
u
[16])

1965 
i
;

1967 
i
 = 0; i < 16; i++)

1968 ià(
u
[
i
])

1969  
Œue
;

1970  
çl£
;

1971 
	}
}

1973 
	$f2fs_ioc_£t_’üy±iÚ_pŞicy
(
fe
 *
fp
, 
¬g
)

1975 
šode
 *šodğ
	`fe_šode
(
fp
);

1977 ià(!
	`f2fs_sb_has_’üy±
(
šode
->
i_sb
))

1978  -
EOPNOTSUPP
;

1980 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

1982  
	`fsüy±_ioùl_£t_pŞicy
(
fp
, (cÚ¡ 
__u£r
 *)
¬g
);

1983 
	}
}

1985 
	$f2fs_ioc_g‘_’üy±iÚ_pŞicy
(
fe
 *
fp
, 
¬g
)

1987 ià(!
	`f2fs_sb_has_’üy±
(
	`fe_šode
(
fp
)->
i_sb
))

1988  -
EOPNOTSUPP
;

1989  
	`fsüy±_ioùl_g‘_pŞicy
(
fp
, (
__u£r
 *)
¬g
);

1990 
	}
}

1992 
	$f2fs_ioc_g‘_’üy±iÚ_pw§É
(
fe
 *
fp
, 
¬g
)

1994 
šode
 *šodğ
	`fe_šode
(
fp
);

1995 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1996 
”r
;

1998 ià(!
	`f2fs_sb_has_’üy±
(
šode
->
i_sb
))

1999  -
EOPNOTSUPP
;

2001 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2002 ià(
”r
)

2003  
”r
;

2005 
	`down_wr™e
(&
sbi
->
sb_lock
);

2007 ià(
	`uuid_is_nÚz”o
(
sbi
->
¿w_su³r
->
’üy±_pw_§É
))

2008 
gÙ_™
;

2011 
	`g’”©e_¿ndom_uuid
(
sbi
->
¿w_su³r
->
’üy±_pw_§É
);

2013 
”r
 = 
	`f2fs_comm™_su³r
(
sbi
, 
çl£
);

2014 ià(
”r
) {

2016 
	`mem£t
(
sbi
->
¿w_su³r
->
’üy±_pw_§É
, 0, 16);

2017 
out_”r
;

2019 
gÙ_™
:

2020 ià(
	`cİy_to_u£r
((
__u8
 
__u£r
 *)
¬g
, 
sbi
->
¿w_su³r
->
’üy±_pw_§É
,

2022 
”r
 = -
EFAULT
;

2023 
out_”r
:

2024 
	`up_wr™e
(&
sbi
->
sb_lock
);

2025 
	`mÁ_drİ_wr™e_fe
(
fp
);

2026  
”r
;

2027 
	}
}

2029 
	$f2fs_ioc_gc
(
fe
 *
fp
, 
¬g
)

2031 
šode
 *šodğ
	`fe_šode
(
fp
);

2032 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2033 
__u32
 
sync
;

2034 
»t
;

2036 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2037  -
EPERM
;

2039 ià(
	`g‘_u£r
(
sync
, (
__u32
 
__u£r
 *)
¬g
))

2040  -
EFAULT
;

2042 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

2043  -
EROFS
;

2045 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2046 ià(
»t
)

2047  
»t
;

2049 ià(!
sync
) {

2050 ià(!
	`mu‹x_Œylock
(&
sbi
->
gc_mu‹x
)) {

2051 
»t
 = -
EBUSY
;

2052 
out
;

2055 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

2058 
»t
 = 
	`f2fs_gc
(
sbi
, 
sync
, 
Œue
, 
NULL_SEGNO
);

2059 
out
:

2060 
	`mÁ_drİ_wr™e_fe
(
fp
);

2061  
»t
;

2062 
	}
}

2064 
	$f2fs_ioc_gc_¿nge
(
fe
 *
fp
, 
¬g
)

2066 
šode
 *šodğ
	`fe_šode
(
fp
);

2067 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2068 
f2fs_gc_¿nge
 
¿nge
;

2069 
u64
 
’d
;

2070 
»t
;

2072 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2073  -
EPERM
;

2075 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f2fs_gc_¿nge
 
__u£r
 *)
¬g
,

2076 (
¿nge
)))

2077  -
EFAULT
;

2079 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

2080  -
EROFS
;

2082 
’d
 = 
¿nge
.
¡¬t
 +„ªge.
Ën
;

2083 ià(
¿nge
.
¡¬t
 < 
	`MAIN_BLKADDR
(
sbi
è|| 
’d
 >ğ
	`MAX_BLKADDR
(sbi)) {

2084  -
EINVAL
;

2087 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2088 ià(
»t
)

2089  
»t
;

2091 
do_mÜe
:

2092 ià(!
¿nge
.
sync
) {

2093 ià(!
	`mu‹x_Œylock
(&
sbi
->
gc_mu‹x
)) {

2094 
»t
 = -
EBUSY
;

2095 
out
;

2098 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

2101 
»t
 = 
	`f2fs_gc
(
sbi
, 
¿nge
.
sync
, 
Œue
, 
	`GET_SEGNO
(sbi,„ªge.
¡¬t
));

2102 
¿nge
.
¡¬t
 +ğ
sbi
->
blocks_³r_£g
;

2103 ià(
¿nge
.
¡¬t
 <ğ
’d
)

2104 
do_mÜe
;

2105 
out
:

2106 
	`mÁ_drİ_wr™e_fe
(
fp
);

2107  
»t
;

2108 
	}
}

2110 
	$f2fs_ioc_f2fs_wr™e_checkpošt
(
fe
 *
fp
, 
¬g
)

2112 
šode
 *šodğ
	`fe_šode
(
fp
);

2113 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2114 
»t
;

2116 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2117  -
EPERM
;

2119 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

2120  -
EROFS
;

2122 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2123 ià(
»t
)

2124  
»t
;

2126 
»t
 = 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

2128 
	`mÁ_drİ_wr™e_fe
(
fp
);

2129  
»t
;

2130 
	}
}

2132 
	$f2fs_deäagm’t_¿nge
(
f2fs_sb_šfo
 *
sbi
,

2133 
fe
 *
fp
,

2134 
f2fs_deäagm’t
 *
¿nge
)

2136 
šode
 *šodğ
	`fe_šode
(
fp
);

2137 
f2fs_m­_blocks
 
m­
 = { .
m_Ãxt_ex‹Á
 = 
NULL
,

2138 .
m_£g_ty³
 = 
NO_CHECK_TYPE
 };

2139 
ex‹Á_šfo
 
ei
 = {0, 0, 0};

2140 
pgoff_t
 
pg_¡¬t
, 
pg_’d
, 
Ãxt_pgofs
;

2141 
blk_³r_£g
 = 
sbi
->
blocks_³r_£g
;

2142 
tÙ®
 = 0, 
£c_num
;

2143 
block_t
 
blk_’d
 = 0;

2144 
boŞ
 
äagm’‹d
 = 
çl£
;

2145 
”r
;

2148 ià(
	`f2fs_should_upd©e_š¶aû
(
šode
, 
NULL
))

2149  -
EINVAL
;

2151 
pg_¡¬t
 = 
¿nge
->
¡¬t
 >> 
PAGE_SHIFT
;

2152 
pg_’d
 = (
¿nge
->
¡¬t
 +„ªge->
Ën
è>> 
PAGE_SHIFT
;

2154 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

2156 
	`šode_lock
(
šode
);

2159 
”r
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
¿nge
->
¡¬t
,

2160 
¿nge
->
¡¬t
 +„ªge->
Ën
 - 1);

2161 ià(
”r
)

2162 
out
;

2168 ià(
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
pg_¡¬t
, &
ei
)) {

2169 ià(
ei
.
fofs
 +ƒi.
Ën
 >ğ
pg_’d
)

2170 
out
;

2173 
m­
.
m_lblk
 = 
pg_¡¬t
;

2174 
m­
.
m_Ãxt_pgofs
 = &
Ãxt_pgofs
;

2181 
m­
.
m_lblk
 < 
pg_’d
) {

2182 
m­
.
m_Ën
 = 
pg_’d
 - m­.
m_lblk
;

2183 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 0, 
F2FS_GET_BLOCK_DEFAULT
);

2184 ià(
”r
)

2185 
out
;

2187 ià(!(
m­
.
m_æags
 & 
F2FS_MAP_FLAGS
)) {

2188 
m­
.
m_lblk
 = 
Ãxt_pgofs
;

2192 ià(
blk_’d
 && blk_’d !ğ
m­
.
m_pblk
)

2193 
äagm’‹d
 = 
Œue
;

2196 
tÙ®
 +ğ
m­
.
m_Ën
;

2198 
blk_’d
 = 
m­
.
m_pblk
 + m­.
m_Ën
;

2200 
m­
.
m_lblk
 +ğm­.
m_Ën
;

2203 ià(!
äagm’‹d
)

2204 
out
;

2206 
£c_num
 = (
tÙ®
 + 
	`BLKS_PER_SEC
(
sbi
) - 1) / BLKS_PER_SEC(sbi);

2213 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 
£c_num
)) {

2214 
”r
 = -
EAGAIN
;

2215 
out
;

2218 
m­
.
m_lblk
 = 
pg_¡¬t
;

2219 
m­
.
m_Ën
 = 
pg_’d
 - 
pg_¡¬t
;

2220 
tÙ®
 = 0;

2222 
m­
.
m_lblk
 < 
pg_’d
) {

2223 
pgoff_t
 
idx
;

2224 
út
 = 0;

2226 
do_m­
:

2227 
m­
.
m_Ën
 = 
pg_’d
 - m­.
m_lblk
;

2228 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 0, 
F2FS_GET_BLOCK_DEFAULT
);

2229 ià(
”r
)

2230 
ş—r_out
;

2232 ià(!(
m­
.
m_æags
 & 
F2FS_MAP_FLAGS
)) {

2233 
m­
.
m_lblk
 = 
Ãxt_pgofs
;

2237 
	`£t_šode_æag
(
šode
, 
FI_DO_DEFRAG
);

2239 
idx
 = 
m­
.
m_lblk
;

2240 
idx
 < 
m­
.
m_lblk
 + m­.
m_Ën
 && 
út
 < 
blk_³r_£g
) {

2241 
·ge
 *page;

2243 
·ge
 = 
	`f2fs_g‘_lock_d©a_·ge
(
šode
, 
idx
, 
Œue
);

2244 ià(
	`IS_ERR
(
·ge
)) {

2245 
”r
 = 
	`PTR_ERR
(
·ge
);

2246 
ş—r_out
;

2249 
	`£t_·ge_dœty
(
·ge
);

2250 
	`f2fs_put_·ge
(
·ge
, 1);

2252 
idx
++;

2253 
út
++;

2254 
tÙ®
++;

2257 
m­
.
m_lblk
 = 
idx
;

2259 ià(
idx
 < 
pg_’d
 && 
út
 < 
blk_³r_£g
)

2260 
do_m­
;

2262 
	`ş—r_šode_æag
(
šode
, 
FI_DO_DEFRAG
);

2264 
”r
 = 
	`fem­_fd©awr™e
(
šode
->
i_m­pšg
);

2265 ià(
”r
)

2266 
out
;

2268 
ş—r_out
:

2269 
	`ş—r_šode_æag
(
šode
, 
FI_DO_DEFRAG
);

2270 
out
:

2271 
	`šode_uÆock
(
šode
);

2272 ià(!
”r
)

2273 
¿nge
->
Ën
 = (
u64
)
tÙ®
 << 
PAGE_SHIFT
;

2274  
”r
;

2275 
	}
}

2277 
	$f2fs_ioc_deäagm’t
(
fe
 *
fp
, 
¬g
)

2279 
šode
 *šodğ
	`fe_šode
(
fp
);

2280 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2281 
f2fs_deäagm’t
 
¿nge
;

2282 
”r
;

2284 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2285  -
EPERM
;

2287 ià(!
	`S_ISREG
(
šode
->
i_mode
è|| 
	`f2fs_is_©omic_fe
(inode))

2288  -
EINVAL
;

2290 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

2291  -
EROFS
;

2293 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f2fs_deäagm’t
 
__u£r
 *)
¬g
,

2294 (
¿nge
)))

2295  -
EFAULT
;

2298 ià(
¿nge
.
¡¬t
 & (
F2FS_BLKSIZE
 - 1è||„ªge.
Ën
 & (F2FS_BLKSIZE - 1))

2299  -
EINVAL
;

2301 ià(
	`uÆik–y
((
¿nge
.
¡¬t
 +„ªge.
Ën
è>> 
PAGE_SHIFT
 >

2302 
sbi
->
max_fe_blocks
))

2303  -
EINVAL
;

2305 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2306 ià(
”r
)

2307  
”r
;

2309 
”r
 = 
	`f2fs_deäagm’t_¿nge
(
sbi
, 
fp
, &
¿nge
);

2310 
	`mÁ_drİ_wr™e_fe
(
fp
);

2312 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

2313 ià(
”r
 < 0)

2314  
”r
;

2316 ià(
	`cİy_to_u£r
((
f2fs_deäagm’t
 
__u£r
 *)
¬g
, &
¿nge
,

2317 (
¿nge
)))

2318  -
EFAULT
;

2321 
	}
}

2323 
	$f2fs_move_fe_¿nge
(
fe
 *
fe_š
, 
loff_t
 
pos_š
,

2324 
fe
 *
fe_out
, 
loff_t
 
pos_out
, 
size_t
 
Ën
)

2326 
šode
 *
¤c
 = 
	`fe_šode
(
fe_š
);

2327 
šode
 *
d¡
 = 
	`fe_šode
(
fe_out
);

2328 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
¤c
);

2329 
size_t
 
Ş’
 = 
Ën
, 
d¡_max_i_size
 = 0;

2330 
size_t
 
d¡_osize
;

2331 
»t
;

2333 ià(
fe_š
->
f_·th
.
mÁ
 !ğ
fe_out
->f_path.mnt ||

2334 
¤c
->
i_sb
 !ğ
d¡
->i_sb)

2335  -
EXDEV
;

2337 ià(
	`uÆik–y
(
	`f2fs_»adÚly
(
¤c
->
i_sb
)))

2338  -
EROFS
;

2340 ià(!
	`S_ISREG
(
¤c
->
i_mode
è|| !S_ISREG(
d¡
->i_mode))

2341  -
EINVAL
;

2343 ià(
	`f2fs_’üy±ed_šode
(
¤c
è|| f2fs_’üy±ed_šode(
d¡
))

2344  -
EOPNOTSUPP
;

2346 ià(
¤c
 =ğ
d¡
) {

2347 ià(
pos_š
 =ğ
pos_out
)

2349 ià(
pos_out
 > 
pos_š
 &&…os_ouˆ<…os_š + 
Ën
)

2350  -
EINVAL
;

2353 
	`šode_lock
(
¤c
);

2354 
	`down_wr™e
(&
	`F2FS_I
(
¤c
)->
i_gc_rw£m
[
WRITE
]);

2355 ià(
¤c
 !ğ
d¡
) {

2356 
»t
 = -
EBUSY
;

2357 ià(!
	`šode_Œylock
(
d¡
))

2358 
out
;

2359 ià(!
	`down_wr™e_Œylock
(&
	`F2FS_I
(
d¡
)->
i_gc_rw£m
[
WRITE
])) {

2360 
	`šode_uÆock
(
d¡
);

2361 
out
;

2365 
»t
 = -
EINVAL
;

2366 ià(
pos_š
 + 
Ën
 > 
¤c
->
i_size
 ||…os_in +†en <…os_in)

2367 
out_uÆock
;

2368 ià(
Ën
 == 0)

2369 
Ş’
 = 
Ën
 = 
¤c
->
i_size
 - 
pos_š
;

2370 ià(
pos_š
 + 
Ën
 =ğ
¤c
->
i_size
)

2371 
Ën
 = 
	`ALIGN
(
¤c
->
i_size
, 
F2FS_BLKSIZE
è- 
pos_š
;

2372 ià(
Ën
 == 0) {

2373 
»t
 = 0;

2374 
out_uÆock
;

2377 
d¡_osize
 = 
d¡
->
i_size
;

2378 ià(
pos_out
 + 
Ş’
 > 
d¡
->
i_size
)

2379 
d¡_max_i_size
 = 
pos_out
 + 
Ş’
;

2382 ià(!
	`IS_ALIGNED
(
pos_š
, 
F2FS_BLKSIZE
) ||

2383 !
	`IS_ALIGNED
(
pos_š
 + 
Ën
, 
F2FS_BLKSIZE
) ||

2384 !
	`IS_ALIGNED
(
pos_out
, 
F2FS_BLKSIZE
))

2385 
out_uÆock
;

2387 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
¤c
);

2388 ià(
»t
)

2389 
out_uÆock
;

2391 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
d¡
);

2392 ià(
»t
)

2393 
out_uÆock
;

2396 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
¤c
->
i_m­pšg
,

2397 
pos_š
,…os_š + 
Ën
);

2398 ià(
»t
)

2399 
out_uÆock
;

2401 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
d¡
->
i_m­pšg
,

2402 
pos_out
,…os_ouˆ+ 
Ën
);

2403 ià(
»t
)

2404 
out_uÆock
;

2406 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

2407 
	`f2fs_lock_İ
(
sbi
);

2408 
»t
 = 
	`__exchªge_d©a_block
(
¤c
, 
d¡
, 
pos_š
 >> 
F2FS_BLKSIZE_BITS
,

2409 
pos_out
 >> 
F2FS_BLKSIZE_BITS
,

2410 
Ën
 >> 
F2FS_BLKSIZE_BITS
, 
çl£
);

2412 ià(!
»t
) {

2413 ià(
d¡_max_i_size
)

2414 
	`f2fs_i_size_wr™e
(
d¡
, 
d¡_max_i_size
);

2415 ià(
d¡_osize
 !ğ
d¡
->
i_size
)

2416 
	`f2fs_i_size_wr™e
(
d¡
, 
d¡_osize
);

2418 
	`f2fs_uÆock_İ
(
sbi
);

2419 
out_uÆock
:

2420 ià(
¤c
 !ğ
d¡
) {

2421 
	`up_wr™e
(&
	`F2FS_I
(
d¡
)->
i_gc_rw£m
[
WRITE
]);

2422 
	`šode_uÆock
(
d¡
);

2424 
out
:

2425 
	`up_wr™e
(&
	`F2FS_I
(
¤c
)->
i_gc_rw£m
[
WRITE
]);

2426 
	`šode_uÆock
(
¤c
);

2427  
»t
;

2428 
	}
}

2430 
	$f2fs_ioc_move_¿nge
(
fe
 *
fp
, 
¬g
)

2432 
f2fs_move_¿nge
 
¿nge
;

2433 
fd
 
d¡
;

2434 
”r
;

2436 ià(!(
fp
->
f_mode
 & 
FMODE_READ
) ||

2437 !(
fp
->
f_mode
 & 
FMODE_WRITE
))

2438  -
EBADF
;

2440 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f2fs_move_¿nge
 
__u£r
 *)
¬g
,

2441 (
¿nge
)))

2442  -
EFAULT
;

2444 
d¡
 = 
	`fdg‘
(
¿nge
.
d¡_fd
);

2445 ià(!
d¡
.
fe
)

2446  -
EBADF
;

2448 ià(!(
d¡
.
fe
->
f_mode
 & 
FMODE_WRITE
)) {

2449 
”r
 = -
EBADF
;

2450 
”r_out
;

2453 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2454 ià(
”r
)

2455 
”r_out
;

2457 
”r
 = 
	`f2fs_move_fe_¿nge
(
fp
, 
¿nge
.
pos_š
, 
d¡
.
fe
,

2458 
¿nge
.
pos_out
,„ªge.
Ën
);

2460 
	`mÁ_drİ_wr™e_fe
(
fp
);

2461 ià(
”r
)

2462 
”r_out
;

2464 ià(
	`cİy_to_u£r
((
f2fs_move_¿nge
 
__u£r
 *)
¬g
,

2465 &
¿nge
, (range)))

2466 
”r
 = -
EFAULT
;

2467 
”r_out
:

2468 
	`fdput
(
d¡
);

2469  
”r
;

2470 
	}
}

2472 
	$f2fs_ioc_æush_deviû
(
fe
 *
fp
, 
¬g
)

2474 
šode
 *šodğ
	`fe_šode
(
fp
);

2475 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2476 
s™_šfo
 *
sm
 = 
	`SIT_I
(
sbi
);

2477 
¡¬t_£gno
 = 0, 
’d_£gno
 = 0;

2478 
dev_¡¬t_£gno
 = 0, 
dev_’d_£gno
 = 0;

2479 
f2fs_æush_deviû
 
¿nge
;

2480 
»t
;

2482 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2483  -
EPERM
;

2485 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

2486  -
EROFS
;

2488 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f2fs_æush_deviû
 
__u£r
 *)
¬g
,

2489 (
¿nge
)))

2490  -
EFAULT
;

2492 ià(
sbi
->
s_ndevs
 <ğ1 || sbi->s_ndev - 1 <ğ
¿nge
.
dev_num
 ||

2493 
sbi
->
£gs_³r_£c
 != 1) {

2494 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

2496 
¿nge
.
dev_num
, 
sbi
->
s_ndevs
,

2497 
sbi
->
£gs_³r_£c
);

2498  -
EINVAL
;

2501 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2502 ià(
»t
)

2503  
»t
;

2505 ià(
¿nge
.
dev_num
 != 0)

2506 
dev_¡¬t_£gno
 = 
	`GET_SEGNO
(
sbi
, 
	`FDEV
(
¿nge
.
dev_num
).
¡¬t_blk
);

2507 
dev_’d_£gno
 = 
	`GET_SEGNO
(
sbi
, 
	`FDEV
(
¿nge
.
dev_num
).
’d_blk
);

2509 
¡¬t_£gno
 = 
sm
->
Ï¡_viùim
[
FLUSH_DEVICE
];

2510 ià(
¡¬t_£gno
 < 
dev_¡¬t_£gno
 || s¹_£gnØ>ğ
dev_’d_£gno
)

2511 
¡¬t_£gno
 = 
dev_¡¬t_£gno
;

2512 
’d_£gno
 = 
	`mš
(
¡¬t_£gno
 + 
¿nge
.
£gm’ts
, 
dev_’d_£gno
);

2514 
¡¬t_£gno
 < 
’d_£gno
) {

2515 ià(!
	`mu‹x_Œylock
(&
sbi
->
gc_mu‹x
)) {

2516 
»t
 = -
EBUSY
;

2517 
out
;

2519 
sm
->
Ï¡_viùim
[
GC_CB
] = 
’d_£gno
 + 1;

2520 
sm
->
Ï¡_viùim
[
GC_GREEDY
] = 
’d_£gno
 + 1;

2521 
sm
->
Ï¡_viùim
[
ALLOC_NEXT
] = 
’d_£gno
 + 1;

2522 
»t
 = 
	`f2fs_gc
(
sbi
, 
Œue
,rue, 
¡¬t_£gno
);

2523 ià(
»t
 =ğ-
EAGAIN
)

2524 
»t
 = 0;

2525 ià(
»t
 < 0)

2527 
¡¬t_£gno
++;

2529 
out
:

2530 
	`mÁ_drİ_wr™e_fe
(
fp
);

2531  
»t
;

2532 
	}
}

2534 
	$f2fs_ioc_g‘_ã©u»s
(
fe
 *
fp
, 
¬g
)

2536 
šode
 *šodğ
	`fe_šode
(
fp
);

2537 
u32
 
sb_ã©u»
 = 
	`Ë32_to_ıu
(
	`F2FS_I_SB
(
šode
)->
¿w_su³r
->
ã©u»
);

2540 
sb_ã©u»
 |ğ
F2FS_FEATURE_ATOMIC_WRITE
;

2542  
	`put_u£r
(
sb_ã©u»
, (
u32
 
__u£r
 *)
¬g
);

2543 
	}
}

2545 #ifdeà
CONFIG_QUOTA


2546 
	$f2fs_ioc_£rojeù
(
fe
 *
fp
, 
__u32
 
´ojid
)

2548 
šode
 *šodğ
	`fe_šode
(
fp
);

2549 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

2550 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2551 
su³r_block
 *
sb
 = 
sbi
->sb;

2552 
dquÙ
 *
Œªsãr_to
[
MAXQUOTAS
] = {};

2553 
·ge
 *
age
;

2554 
k´ojid_t
 
k´ojid
;

2555 
”r
;

2557 ià(!
	`f2fs_sb_has_´ojeù_quÙa
(
sb
)) {

2558 ià(
´ojid
 !ğ
F2FS_DEF_PROJID
)

2559  -
EOPNOTSUPP
;

2564 ià(!
	`f2fs_has_exŒa_©Œ
(
šode
))

2565  -
EOPNOTSUPP
;

2567 
k´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
, (
´ojid_t
)
´ojid
);

2569 ià(
	`´ojid_eq
(
k´ojid
, 
	`F2FS_I
(
šode
)->
i_´ojid
))

2572 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2573 ià(
”r
)

2574  
”r
;

2576 
”r
 = -
EPERM
;

2577 
	`šode_lock
(
šode
);

2580 ià(
	`IS_NOQUOTA
(
šode
))

2581 
out_uÆock
;

2583 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

2584 ià(
	`IS_ERR
(
age
)) {

2585 
”r
 = 
	`PTR_ERR
(
age
);

2586 
out_uÆock
;

2589 ià(!
	`F2FS_FITS_IN_INODE
(
	`F2FS_INODE
(
age
), 
fi
->
i_exŒa_isize
,

2590 
i_´ojid
)) {

2591 
”r
 = -
EOVERFLOW
;

2592 
	`f2fs_put_·ge
(
age
, 1);

2593 
out_uÆock
;

2595 
	`f2fs_put_·ge
(
age
, 1);

2597 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

2598 ià(
”r
)

2599 
out_uÆock
;

2601 
Œªsãr_to
[
PRJQUOTA
] = 
	`dqg‘
(
sb
, 
	`make_kqid_´ojid
(
k´ojid
));

2602 ià(!
	`IS_ERR
(
Œªsãr_to
[
PRJQUOTA
])) {

2603 
”r
 = 
	`__dquÙ_Œªsãr
(
šode
, 
Œªsãr_to
);

2604 
	`dqput
(
Œªsãr_to
[
PRJQUOTA
]);

2605 ià(
”r
)

2606 
out_dœty
;

2609 
	`F2FS_I
(
šode
)->
i_´ojid
 = 
k´ojid
;

2610 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

2611 
out_dœty
:

2612 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2613 
out_uÆock
:

2614 
	`šode_uÆock
(
šode
);

2615 
	`mÁ_drİ_wr™e_fe
(
fp
);

2616  
”r
;

2617 
	}
}

2619 
	$f2fs_ioc_£rojeù
(
fe
 *
fp
, 
__u32
 
´ojid
)

2621 ià(
´ojid
 !ğ
F2FS_DEF_PROJID
)

2622  -
EOPNOTSUPP
;

2624 
	}
}

2628 
šlše
 
__u32
 
	$f2fs_iæags_to_xæags
(
iæags
)

2630 
__u32
 
xæags
 = 0;

2632 ià(
iæags
 & 
F2FS_SYNC_FL
)

2633 
xæags
 |ğ
FS_XFLAG_SYNC
;

2634 ià(
iæags
 & 
F2FS_IMMUTABLE_FL
)

2635 
xæags
 |ğ
FS_XFLAG_IMMUTABLE
;

2636 ià(
iæags
 & 
F2FS_APPEND_FL
)

2637 
xæags
 |ğ
FS_XFLAG_APPEND
;

2638 ià(
iæags
 & 
F2FS_NODUMP_FL
)

2639 
xæags
 |ğ
FS_XFLAG_NODUMP
;

2640 ià(
iæags
 & 
F2FS_NOATIME_FL
)

2641 
xæags
 |ğ
FS_XFLAG_NOATIME
;

2642 ià(
iæags
 & 
F2FS_PROJINHERIT_FL
)

2643 
xæags
 |ğ
FS_XFLAG_PROJINHERIT
;

2644  
xæags
;

2645 
	}
}

2647 
	#F2FS_SUPPORTED_FS_XFLAGS
 (
FS_XFLAG_SYNC
 | 
FS_XFLAG_IMMUTABLE
 | \

2648 
FS_XFLAG_APPEND
 | 
FS_XFLAG_NODUMP
 | \

2649 
FS_XFLAG_NOATIME
 | 
FS_XFLAG_PROJINHERIT
)

	)

2652 
šlše
 
	$f2fs_xæags_to_iæags
(
__u32
 
xæags
)

2654 
iæags
 = 0;

2656 ià(
xæags
 & 
FS_XFLAG_SYNC
)

2657 
iæags
 |ğ
F2FS_SYNC_FL
;

2658 ià(
xæags
 & 
FS_XFLAG_IMMUTABLE
)

2659 
iæags
 |ğ
F2FS_IMMUTABLE_FL
;

2660 ià(
xæags
 & 
FS_XFLAG_APPEND
)

2661 
iæags
 |ğ
F2FS_APPEND_FL
;

2662 ià(
xæags
 & 
FS_XFLAG_NODUMP
)

2663 
iæags
 |ğ
F2FS_NODUMP_FL
;

2664 ià(
xæags
 & 
FS_XFLAG_NOATIME
)

2665 
iæags
 |ğ
F2FS_NOATIME_FL
;

2666 ià(
xæags
 & 
FS_XFLAG_PROJINHERIT
)

2667 
iæags
 |ğ
F2FS_PROJINHERIT_FL
;

2669  
iæags
;

2670 
	}
}

2672 
	$f2fs_ioc_fsg‘x©Œ
(
fe
 *
fp
, 
¬g
)

2674 
šode
 *šodğ
	`fe_šode
(
fp
);

2675 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

2676 
fsx©Œ
 
ç
;

2678 
	`mem£t
(&
ç
, 0, (
fsx©Œ
));

2679 
ç
.
fsx_xæags
 = 
	`f2fs_iæags_to_xæags
(
fi
->
i_æags
 &

2680 
F2FS_FL_USER_VISIBLE
);

2682 ià(
	`f2fs_sb_has_´ojeù_quÙa
(
šode
->
i_sb
))

2683 
ç
.
fsx_´ojid
 = (
__u32
)
	`äom_k´ojid
(&
š™_u£r_ns
,

2684 
fi
->
i_´ojid
);

2686 ià(
	`cİy_to_u£r
((
fsx©Œ
 
__u£r
 *)
¬g
, &
ç
, (fa)))

2687  -
EFAULT
;

2689 
	}
}

2691 
	$f2fs_ioc_fs£tx©Œ
(
fe
 *
fp
, 
¬g
)

2693 
šode
 *šodğ
	`fe_šode
(
fp
);

2694 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

2695 
fsx©Œ
 
ç
;

2696 
æags
;

2697 
”r
;

2699 ià(
	`cİy_äom_u£r
(&
ç
, (
fsx©Œ
 
__u£r
 *)
¬g
, (fa)))

2700  -
EFAULT
;

2703 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

2704  -
EACCES
;

2706 ià(
ç
.
fsx_xæags
 & ~
F2FS_SUPPORTED_FS_XFLAGS
)

2707  -
EOPNOTSUPP
;

2709 
æags
 = 
	`f2fs_xæags_to_iæags
(
ç
.
fsx_xæags
);

2710 ià(
	`f2fs_mask_æags
(
šode
->
i_mode
, 
æags
) != flags)

2711  -
EOPNOTSUPP
;

2713 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2714 ià(
”r
)

2715  
”r
;

2717 
	`šode_lock
(
šode
);

2718 
æags
 = (
fi
->
i_æags
 & ~
F2FS_FL_XFLAG_VISIBLE
) |

2719 (
æags
 & 
F2FS_FL_XFLAG_VISIBLE
);

2720 
”r
 = 
	`__f2fs_ioc_£tæags
(
šode
, 
æags
);

2721 
	`šode_uÆock
(
šode
);

2722 
	`mÁ_drİ_wr™e_fe
(
fp
);

2723 ià(
”r
)

2724  
”r
;

2726 
”r
 = 
	`f2fs_ioc_£rojeù
(
fp
, 
ç
.
fsx_´ojid
);

2727 ià(
”r
)

2728  
”r
;

2731 
	}
}

2733 
	$f2fs_pš_fe_cÚŒŞ
(
šode
 *šode, 
boŞ
 
šc
)

2735 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

2736 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2739 ià(
šc
)

2740 
	`f2fs_i_gc_çu»s_wr™e
(
šode
,

2741 
fi
->
i_gc_çu»s
[
GC_FAILURE_PIN
] + 1);

2743 ià(
fi
->
i_gc_çu»s
[
GC_FAILURE_PIN
] > 
sbi
->
gc_pš_fe_th»shŞd
) {

2744 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

2746 
__func__
, 
šode
->
i_šo
,

2747 
fi
->
i_gc_çu»s
[
GC_FAILURE_PIN
]);

2748 
	`ş—r_šode_æag
(
šode
, 
FI_PIN_FILE
);

2749  -
EAGAIN
;

2752 
	}
}

2754 
	$f2fs_ioc_£t_pš_fe
(
fe
 *
fp
, 
¬g
)

2756 
šode
 *šodğ
	`fe_šode
(
fp
);

2757 
__u32
 
pš
;

2758 
»t
 = 0;

2760 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

2761  -
EACCES
;

2763 ià(
	`g‘_u£r
(
pš
, (
__u32
 
__u£r
 *)
¬g
))

2764  -
EFAULT
;

2766 ià(!
	`S_ISREG
(
šode
->
i_mode
))

2767  -
EINVAL
;

2769 ià(
	`f2fs_»adÚly
(
	`F2FS_I_SB
(
šode
)->
sb
))

2770  -
EROFS
;

2772 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2773 ià(
»t
)

2774  
»t
;

2776 
	`šode_lock
(
šode
);

2778 ià(
	`f2fs_should_upd©e_ouÏû
(
šode
, 
NULL
)) {

2779 
»t
 = -
EINVAL
;

2780 
out
;

2783 ià(!
pš
) {

2784 
	`ş—r_šode_æag
(
šode
, 
FI_PIN_FILE
);

2785 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_PIN
] = 1;

2786 
dÚe
;

2789 ià(
	`f2fs_pš_fe_cÚŒŞ
(
šode
, 
çl£
)) {

2790 
»t
 = -
EAGAIN
;

2791 
out
;

2793 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

2794 ià(
»t
)

2795 
out
;

2797 
	`£t_šode_æag
(
šode
, 
FI_PIN_FILE
);

2798 
»t
 = 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_PIN
];

2799 
dÚe
:

2800 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

2801 
out
:

2802 
	`šode_uÆock
(
šode
);

2803 
	`mÁ_drİ_wr™e_fe
(
fp
);

2804  
»t
;

2805 
	}
}

2807 
	$f2fs_ioc_g‘_pš_fe
(
fe
 *
fp
, 
¬g
)

2809 
šode
 *šodğ
	`fe_šode
(
fp
);

2810 
__u32
 
pš
 = 0;

2812 ià(
	`is_šode_æag_£t
(
šode
, 
FI_PIN_FILE
))

2813 
pš
 = 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_PIN
];

2814  
	`put_u£r
(
pš
, (
u32
 
__u£r
 *)
¬g
);

2815 
	}
}

2817 
	$f2fs_´eÿche_ex‹Ás
(
šode
 *inode)

2819 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

2820 
f2fs_m­_blocks
 
m­
;

2821 
pgoff_t
 
m_Ãxt_ex‹Á
;

2822 
loff_t
 
’d
;

2823 
”r
;

2825 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NO_EXTENT
))

2826  -
EOPNOTSUPP
;

2828 
m­
.
m_lblk
 = 0;

2829 
m­
.
m_Ãxt_pgofs
 = 
NULL
;

2830 
m­
.
m_Ãxt_ex‹Á
 = &m_next_extent;

2831 
m­
.
m_£g_ty³
 = 
NO_CHECK_TYPE
;

2832 
’d
 = 
	`F2FS_I_SB
(
šode
)->
max_fe_blocks
;

2834 
m­
.
m_lblk
 < 
’d
) {

2835 
m­
.
m_Ën
 = 
’d
 - m­.
m_lblk
;

2837 
	`down_wr™e
(&
fi
->
i_gc_rw£m
[
WRITE
]);

2838 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 0, 
F2FS_GET_BLOCK_PRECACHE
);

2839 
	`up_wr™e
(&
fi
->
i_gc_rw£m
[
WRITE
]);

2840 ià(
”r
)

2841  
”r
;

2843 
m­
.
m_lblk
 = 
m_Ãxt_ex‹Á
;

2846  
”r
;

2847 
	}
}

2849 
	$f2fs_ioc_´eÿche_ex‹Ás
(
fe
 *
fp
, 
¬g
)

2851  
	`f2fs_´eÿche_ex‹Ás
(
	`fe_šode
(
fp
));

2852 
	}
}

2854 
	$f2fs_ioùl
(
fe
 *
fp
, 
cmd
, 
¬g
)

2856 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
	`fe_šode
(
fp
)))))

2857  -
EIO
;

2859 
cmd
) {

2860 
F2FS_IOC_GETFLAGS
:

2861  
	`f2fs_ioc_g‘æags
(
fp
, 
¬g
);

2862 
F2FS_IOC_SETFLAGS
:

2863  
	`f2fs_ioc_£tæags
(
fp
, 
¬g
);

2864 
F2FS_IOC_GETVERSION
:

2865  
	`f2fs_ioc_g‘v”siÚ
(
fp
, 
¬g
);

2866 
F2FS_IOC_START_ATOMIC_WRITE
:

2867  
	`f2fs_ioc_¡¬t_©omic_wr™e
(
fp
);

2868 
F2FS_IOC_COMMIT_ATOMIC_WRITE
:

2869  
	`f2fs_ioc_comm™_©omic_wr™e
(
fp
);

2870 
F2FS_IOC_START_VOLATILE_WRITE
:

2871  
	`f2fs_ioc_¡¬t_vŞ©e_wr™e
(
fp
);

2872 
F2FS_IOC_RELEASE_VOLATILE_WRITE
:

2873  
	`f2fs_ioc_»Ëa£_vŞ©e_wr™e
(
fp
);

2874 
F2FS_IOC_ABORT_VOLATILE_WRITE
:

2875  
	`f2fs_ioc_abÜt_vŞ©e_wr™e
(
fp
);

2876 
F2FS_IOC_SHUTDOWN
:

2877  
	`f2fs_ioc_shutdown
(
fp
, 
¬g
);

2878 
FITRIM
:

2879  
	`f2fs_ioc_f™rim
(
fp
, 
¬g
);

2880 
F2FS_IOC_SET_ENCRYPTION_POLICY
:

2881  
	`f2fs_ioc_£t_’üy±iÚ_pŞicy
(
fp
, 
¬g
);

2882 
F2FS_IOC_GET_ENCRYPTION_POLICY
:

2883  
	`f2fs_ioc_g‘_’üy±iÚ_pŞicy
(
fp
, 
¬g
);

2884 
F2FS_IOC_GET_ENCRYPTION_PWSALT
:

2885  
	`f2fs_ioc_g‘_’üy±iÚ_pw§É
(
fp
, 
¬g
);

2886 
F2FS_IOC_GARBAGE_COLLECT
:

2887  
	`f2fs_ioc_gc
(
fp
, 
¬g
);

2888 
F2FS_IOC_GARBAGE_COLLECT_RANGE
:

2889  
	`f2fs_ioc_gc_¿nge
(
fp
, 
¬g
);

2890 
F2FS_IOC_WRITE_CHECKPOINT
:

2891  
	`f2fs_ioc_f2fs_wr™e_checkpošt
(
fp
, 
¬g
);

2892 
F2FS_IOC_DEFRAGMENT
:

2893  
	`f2fs_ioc_deäagm’t
(
fp
, 
¬g
);

2894 
F2FS_IOC_MOVE_RANGE
:

2895  
	`f2fs_ioc_move_¿nge
(
fp
, 
¬g
);

2896 
F2FS_IOC_FLUSH_DEVICE
:

2897  
	`f2fs_ioc_æush_deviû
(
fp
, 
¬g
);

2898 
F2FS_IOC_GET_FEATURES
:

2899  
	`f2fs_ioc_g‘_ã©u»s
(
fp
, 
¬g
);

2900 
F2FS_IOC_FSGETXATTR
:

2901  
	`f2fs_ioc_fsg‘x©Œ
(
fp
, 
¬g
);

2902 
F2FS_IOC_FSSETXATTR
:

2903  
	`f2fs_ioc_fs£tx©Œ
(
fp
, 
¬g
);

2904 
F2FS_IOC_GET_PIN_FILE
:

2905  
	`f2fs_ioc_g‘_pš_fe
(
fp
, 
¬g
);

2906 
F2FS_IOC_SET_PIN_FILE
:

2907  
	`f2fs_ioc_£t_pš_fe
(
fp
, 
¬g
);

2908 
F2FS_IOC_PRECACHE_EXTENTS
:

2909  
	`f2fs_ioc_´eÿche_ex‹Ás
(
fp
, 
¬g
);

2911  -
ENOTTY
;

2913 
	}
}

2915 
ssize_t
 
	$f2fs_fe_wr™e_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

2917 
fe
 *fğ
iocb
->
ki_fp
;

2918 
šode
 *šodğ
	`fe_šode
(
fe
);

2919 
ssize_t
 
»t
;

2921 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
))))

2922  -
EIO
;

2924 ià((
iocb
->
ki_æags
 & 
IOCB_NOWAIT
è&& !(iocb->ki_æag & 
IOCB_DIRECT
))

2925  -
EINVAL
;

2927 ià(!
	`šode_Œylock
(
šode
)) {

2928 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
)

2929  -
EAGAIN
;

2930 
	`šode_lock
(
šode
);

2933 
»t
 = 
	`g’”ic_wr™e_checks
(
iocb
, 
äom
);

2934 ià(
»t
 > 0) {

2935 
boŞ
 
´—Îoÿ‹d
 = 
çl£
;

2936 
size_t
 
rg‘_size
 = 0;

2937 
”r
;

2939 ià(
	`iov_™”_çuÉ_š_»adabË
(
äom
, 
	`iov_™”_couÁ
(from)))

2940 
	`£t_šode_æag
(
šode
, 
FI_NO_PREALLOC
);

2942 ià((
iocb
->
ki_æags
 & 
IOCB_NOWAIT
) &&

2943 (
iocb
->
ki_æags
 & 
IOCB_DIRECT
)) {

2944 ià(!
	`f2fs_ov”wr™e_io
(
šode
, 
iocb
->
ki_pos
,

2945 
	`iov_™”_couÁ
(
äom
)) ||

2946 
	`f2fs_has_šlše_d©a
(
šode
) ||

2947 
	`f2fs_fÜû_bufã»d_io
(
šode
, 
WRITE
)) {

2948 
	`ş—r_šode_æag
(
šode
,

2949 
FI_NO_PREALLOC
);

2950 
	`šode_uÆock
(
šode
);

2951  -
EAGAIN
;

2955 
´—Îoÿ‹d
 = 
Œue
;

2956 
rg‘_size
 = 
iocb
->
ki_pos
 + 
	`iov_™”_couÁ
(
äom
);

2958 
”r
 = 
	`f2fs_´—Îoÿ‹_blocks
(
iocb
, 
äom
);

2959 ià(
”r
) {

2960 
	`ş—r_šode_æag
(
šode
, 
FI_NO_PREALLOC
);

2961 
	`šode_uÆock
(
šode
);

2962  
”r
;

2965 
»t
 = 
	`__g’”ic_fe_wr™e_™”
(
iocb
, 
äom
);

2966 
	`ş—r_šode_æag
(
šode
, 
FI_NO_PREALLOC
);

2969 ià(
´—Îoÿ‹d
 && 
	`i_size_»ad
(
šode
è< 
rg‘_size
)

2970 
	`f2fs_Œunÿ‹
(
šode
);

2972 ià(
»t
 > 0)

2973 
	`f2fs_upd©e_io¡©
(
	`F2FS_I_SB
(
šode
), 
APP_WRITE_IO
, 
»t
);

2975 
	`šode_uÆock
(
šode
);

2977 ià(
»t
 > 0)

2978 
»t
 = 
	`g’”ic_wr™e_sync
(
iocb
,„et);

2979  
»t
;

2980 
	}
}

2982 #ifdeà
CONFIG_COMPAT


2983 
	$f2fs_com·t_ioùl
(
fe
 *fe, 
cmd
, 
¬g
)

2985 
cmd
) {

2986 
F2FS_IOC32_GETFLAGS
:

2987 
cmd
 = 
F2FS_IOC_GETFLAGS
;

2989 
F2FS_IOC32_SETFLAGS
:

2990 
cmd
 = 
F2FS_IOC_SETFLAGS
;

2992 
F2FS_IOC32_GETVERSION
:

2993 
cmd
 = 
F2FS_IOC_GETVERSION
;

2995 
F2FS_IOC_START_ATOMIC_WRITE
:

2996 
F2FS_IOC_COMMIT_ATOMIC_WRITE
:

2997 
F2FS_IOC_START_VOLATILE_WRITE
:

2998 
F2FS_IOC_RELEASE_VOLATILE_WRITE
:

2999 
F2FS_IOC_ABORT_VOLATILE_WRITE
:

3000 
F2FS_IOC_SHUTDOWN
:

3001 
F2FS_IOC_SET_ENCRYPTION_POLICY
:

3002 
F2FS_IOC_GET_ENCRYPTION_PWSALT
:

3003 
F2FS_IOC_GET_ENCRYPTION_POLICY
:

3004 
F2FS_IOC_GARBAGE_COLLECT
:

3005 
F2FS_IOC_GARBAGE_COLLECT_RANGE
:

3006 
F2FS_IOC_WRITE_CHECKPOINT
:

3007 
F2FS_IOC_DEFRAGMENT
:

3008 
F2FS_IOC_MOVE_RANGE
:

3009 
F2FS_IOC_FLUSH_DEVICE
:

3010 
F2FS_IOC_GET_FEATURES
:

3011 
F2FS_IOC_FSGETXATTR
:

3012 
F2FS_IOC_FSSETXATTR
:

3013 
F2FS_IOC_GET_PIN_FILE
:

3014 
F2FS_IOC_SET_PIN_FILE
:

3015 
F2FS_IOC_PRECACHE_EXTENTS
:

3018  -
ENOIOCTLCMD
;

3020  
	`f2fs_ioùl
(
fe
, 
cmd
, (è
	`com·t_±r
(
¬g
));

3021 
	}
}

3024 cÚ¡ 
fe_İ”©iÚs
 
	gf2fs_fe_İ”©iÚs
 = {

3025 .
Î£ek
 = 
f2fs_Î£ek
,

3026 .
	g»ad_™”
 = 
g’”ic_fe_»ad_™”
,

3027 .
	gwr™e_™”
 = 
f2fs_fe_wr™e_™”
,

3028 .
	gİ’
 = 
f2fs_fe_İ’
,

3029 .
	g»Ëa£
 = 
f2fs_»Ëa£_fe
,

3030 .
	gmm­
 = 
f2fs_fe_mm­
,

3031 .
	gæush
 = 
f2fs_fe_æush
,

3032 .
	gfsync
 = 
f2fs_sync_fe
,

3033 .
	gçÎoÿ‹
 = 
f2fs_çÎoÿ‹
,

3034 .
	guÆocked_ioùl
 = 
f2fs_ioùl
,

3035 #ifdeà
CONFIG_COMPAT


3036 .
	gcom·t_ioùl
 = 
f2fs_com·t_ioùl
,

3038 .
	g¥liû_»ad
 = 
g’”ic_fe_¥liû_»ad
,

3039 .
	g¥liû_wr™e
 = 
™”_fe_¥liû_wr™e
,

	@fs/f2fs/gc.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/moduË.h
>

13 
	~<lšux/backšg-dev.h
>

14 
	~<lšux/š™.h
>

15 
	~<lšux/f2fs_fs.h
>

16 
	~<lšux/kth»ad.h
>

17 
	~<lšux/d–ay.h
>

18 
	~<lšux/ä“z”.h
>

20 
	~"f2fs.h
"

21 
	~"node.h
"

22 
	~"£gm’t.h
"

23 
	~"gc.h
"

24 
	~<Œaû/ev’ts/f2fs.h
>

26 
	$gc_th»ad_func
(*
d©a
)

28 
f2fs_sb_šfo
 *
sbi
 = 
d©a
;

29 
f2fs_gc_kth»ad
 *
gc_th
 = 
sbi
->
gc_th»ad
;

30 
wa™_queue_h—d_t
 *
wq
 = &
sbi
->
gc_th»ad
->
gc_wa™_queue_h—d
;

31 
wa™_ms
;

33 
wa™_ms
 = 
gc_th
->
mš_¦“p_time
;

35 
	`£t_ä“zabË
();

37 
	`wa™_ev’t_š‹¼u±ibË_timeout
(*
wq
,

38 
	`kth»ad_should_¡İ
(è|| 
	`ä“zšg
(
cu¼’t
) ||

39 
gc_th
->
gc_wake
,

40 
	`m£cs_to_jiff›s
(
wa™_ms
));

43 ià(
gc_th
->
gc_wake
)

44 
gc_th
->
gc_wake
 = 0;

46 ià(
	`Œy_to_ä“ze
())

48 ià(
	`kth»ad_should_¡İ
())

51 ià(
sbi
->
sb
->
s_wr™”s
.
äoz’
 >ğ
SB_FREEZE_WRITE
) {

52 
	`šü—£_¦“p_time
(
gc_th
, &
wa™_ms
);

56 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


57 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_CHECKPOINT
)) {

58 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_CHECKPOINT
);

59 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

63 ià(!
	`sb_¡¬t_wr™e_Œylock
(
sbi
->
sb
))

79 ià(
sbi
->
gc_mode
 =ğ
GC_URGENT
) {

80 
wa™_ms
 = 
gc_th
->
urg’t_¦“p_time
;

81 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

82 
do_gc
;

85 ià(!
	`mu‹x_Œylock
(&
sbi
->
gc_mu‹x
))

86 
Ãxt
;

88 ià(!
	`is_idË
(
sbi
)) {

89 
	`šü—£_¦“p_time
(
gc_th
, &
wa™_ms
);

90 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

91 
Ãxt
;

94 ià(
	`has_’ough_šv®id_blocks
(
sbi
))

95 
	`deü—£_¦“p_time
(
gc_th
, &
wa™_ms
);

97 
	`šü—£_¦“p_time
(
gc_th
, &
wa™_ms
);

98 
do_gc
:

99 
	`¡©_šc_bggc_couÁ
(
sbi
);

102 ià(
	`f2fs_gc
(
sbi
, 
	`‹¡_İt
(sbi, 
FORCE_FG_GC
), 
Œue
, 
NULL_SEGNO
))

103 
wa™_ms
 = 
gc_th
->
no_gc_¦“p_time
;

105 
	`Œaû_f2fs_background_gc
(
sbi
->
sb
, 
wa™_ms
,

106 
	`´eä“_£gm’ts
(
sbi
), 
	`ä“_£gm’ts
(sbi));

109 
	`f2fs_b®ªû_fs_bg
(
sbi
);

110 
Ãxt
:

111 
	`sb_’d_wr™e
(
sbi
->
sb
);

113 } !
	`kth»ad_should_¡İ
());

115 
	}
}

117 
	$f2fs_¡¬t_gc_th»ad
(
f2fs_sb_šfo
 *
sbi
)

119 
f2fs_gc_kth»ad
 *
gc_th
;

120 
dev_t
 
dev
 = 
sbi
->
sb
->
s_bdev
->
bd_dev
;

121 
”r
 = 0;

123 
gc_th
 = 
	`f2fs_km®loc
(
sbi
, (
f2fs_gc_kth»ad
), 
GFP_KERNEL
);

124 ià(!
gc_th
) {

125 
”r
 = -
ENOMEM
;

126 
out
;

129 
gc_th
->
urg’t_¦“p_time
 = 
DEF_GC_THREAD_URGENT_SLEEP_TIME
;

130 
gc_th
->
mš_¦“p_time
 = 
DEF_GC_THREAD_MIN_SLEEP_TIME
;

131 
gc_th
->
max_¦“p_time
 = 
DEF_GC_THREAD_MAX_SLEEP_TIME
;

132 
gc_th
->
no_gc_¦“p_time
 = 
DEF_GC_THREAD_NOGC_SLEEP_TIME
;

134 
gc_th
->
gc_wake
= 0;

136 
sbi
->
gc_th»ad
 = 
gc_th
;

137 
	`š™_wa™queue_h—d
(&
sbi
->
gc_th»ad
->
gc_wa™_queue_h—d
);

138 
sbi
->
gc_th»ad
->
f2fs_gc_sk
 = 
	`kth»ad_run
(
gc_th»ad_func
, sbi,

139 "f2fs_gc-%u:%u", 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

140 ià(
	`IS_ERR
(
gc_th
->
f2fs_gc_sk
)) {

141 
”r
 = 
	`PTR_ERR
(
gc_th
->
f2fs_gc_sk
);

142 
	`kä“
(
gc_th
);

143 
sbi
->
gc_th»ad
 = 
NULL
;

145 
out
:

146  
”r
;

147 
	}
}

149 
	$f2fs_¡İ_gc_th»ad
(
f2fs_sb_šfo
 *
sbi
)

151 
f2fs_gc_kth»ad
 *
gc_th
 = 
sbi
->
gc_th»ad
;

152 ià(!
gc_th
)

154 
	`kth»ad_¡İ
(
gc_th
->
f2fs_gc_sk
);

155 
	`kä“
(
gc_th
);

156 
sbi
->
gc_th»ad
 = 
NULL
;

157 
	}
}

159 
	$£Ëù_gc_ty³
(
f2fs_sb_šfo
 *
sbi
, 
gc_ty³
)

161 
gc_mode
 = (
gc_ty³
 =ğ
BG_GC
è? 
GC_CB
 : 
GC_GREEDY
;

163 
sbi
->
gc_mode
) {

164 
GC_IDLE_CB
:

165 
gc_mode
 = 
GC_CB
;

167 
GC_IDLE_GREEDY
:

168 
GC_URGENT
:

169 
gc_mode
 = 
GC_GREEDY
;

172  
gc_mode
;

173 
	}
}

175 
	$£Ëù_pŞicy
(
f2fs_sb_šfo
 *
sbi
, 
gc_ty³
,

176 
ty³
, 
viùim_£l_pŞicy
 *
p
)

178 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

180 ià(
p
->
®loc_mode
 =ğ
SSR
) {

181 
p
->
gc_mode
 = 
GC_GREEDY
;

182 
p
->
dœty_£gm­
 = 
dœty_i
->dœty_£gm­[
ty³
];

183 
p
->
max_£¬ch
 = 
dœty_i
->
Ä_dœty
[
ty³
];

184 
p
->
ofs_un™
 = 1;

186 
p
->
gc_mode
 = 
	`£Ëù_gc_ty³
(
sbi
, 
gc_ty³
);

187 
p
->
dœty_£gm­
 = 
dœty_i
->dœty_£gm­[
DIRTY
];

188 
p
->
max_£¬ch
 = 
dœty_i
->
Ä_dœty
[
DIRTY
];

189 
p
->
ofs_un™
 = 
sbi
->
£gs_³r_£c
;

193 ià(
gc_ty³
 !ğ
FG_GC
 &&

194 (
sbi
->
gc_mode
 !ğ
GC_URGENT
) &&

195 
p
->
max_£¬ch
 > 
sbi
->
max_viùim_£¬ch
)

196 
p
->
max_£¬ch
 = 
sbi
->
max_viùim_£¬ch
;

199 ià(
	`‹¡_İt
(
sbi
, 
NOHEAP
) &&

200 (
ty³
 =ğ
CURSEG_HOT_DATA
 || 
	`IS_NODESEG
(type)))

201 
p
->
off£t
 = 0;

203 
p
->
off£t
 = 
	`SIT_I
(
sbi
)->
Ï¡_viùim
[p->
gc_mode
];

204 
	}
}

206 
	$g‘_max_co¡
(
f2fs_sb_šfo
 *
sbi
,

207 
viùim_£l_pŞicy
 *
p
)

210 ià(
p
->
®loc_mode
 =ğ
SSR
)

211  
sbi
->
blocks_³r_£g
;

212 ià(
p
->
gc_mode
 =ğ
GC_GREEDY
)

213  2 * 
sbi
->
blocks_³r_£g
 * 
p
->
ofs_un™
;

214 ià(
p
->
gc_mode
 =ğ
GC_CB
)

215  
UINT_MAX
;

218 
	}
}

220 
	$check_bg_viùims
(
f2fs_sb_šfo
 *
sbi
)

222 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

223 
£úo
;

230 
	`fÜ_—ch_£t_b™
(
£úo
, 
dœty_i
->
viùim_£cm­
, 
	`MAIN_SECS
(
sbi
)) {

231 ià(
	`£c_u§ge_check
(
sbi
, 
£úo
))

233 
	`ş—r_b™
(
£úo
, 
dœty_i
->
viùim_£cm­
);

234  
	`GET_SEG_FROM_SEC
(
sbi
, 
£úo
);

236  
NULL_SEGNO
;

237 
	}
}

239 
	$g‘_cb_co¡
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

241 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

242 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
);

243 
¡¬t
 = 
	`GET_SEG_FROM_SEC
(
sbi
, 
£úo
);

244 
mtime
 = 0;

245 
vblocks
;

246 
age
 = 0;

247 
u
;

248 
i
;

250 
i
 = 0; i < 
sbi
->
£gs_³r_£c
; i++)

251 
mtime
 +ğ
	`g‘_£g_’Œy
(
sbi
, 
¡¬t
 + 
i
)->mtime;

252 
vblocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
Œue
);

254 
mtime
 = 
	`div_u64
(mtime, 
sbi
->
£gs_³r_£c
);

255 
vblocks
 = 
	`div_u64
(vblocks, 
sbi
->
£gs_³r_£c
);

257 
u
 = (
vblocks
 * 100è>> 
sbi
->
log_blocks_³r_£g
;

260 ià(
mtime
 < 
s™_i
->
mš_mtime
)

261 
s™_i
->
mš_mtime
 = 
mtime
;

262 ià(
mtime
 > 
s™_i
->
max_mtime
)

263 
s™_i
->
max_mtime
 = 
mtime
;

264 ià(
s™_i
->
max_mtime
 !ğs™_i->
mš_mtime
)

265 
age
 = 100 - 
	`div64_u64
(100 * (
mtime
 - 
s™_i
->
mš_mtime
),

266 
s™_i
->
max_mtime
 - s™_i->
mš_mtime
);

268  
UINT_MAX
 - ((100 * (100 - 
u
è* 
age
) / (100 + u));

269 
	}
}

271 
šlše
 
	$g‘_gc_co¡
(
f2fs_sb_šfo
 *
sbi
,

272 
£gno
, 
viùim_£l_pŞicy
 *
p
)

274 ià(
p
->
®loc_mode
 =ğ
SSR
)

275  
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->
ck±_v®id_blocks
;

278 ià(
p
->
gc_mode
 =ğ
GC_GREEDY
)

279  
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
Œue
);

281  
	`g‘_cb_co¡
(
sbi
, 
£gno
);

282 
	}
}

284 
	$couÁ_b™s
(cÚ¡ *
addr
,

285 
off£t
, 
Ën
)

287 
’d
 = 
off£t
 + 
Ën
, 
sum
 = 0;

289 
off£t
 < 
’d
) {

290 ià(
	`‹¡_b™
(
off£t
++, 
addr
))

291 ++
sum
;

293  
sum
;

294 
	}
}

304 
	$g‘_viùim_by_deçuÉ
(
f2fs_sb_šfo
 *
sbi
,

305 *
»suÉ
, 
gc_ty³
, 
ty³
, 
®loc_mode
)

307 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

308 
s™_šfo
 *
sm
 = 
	`SIT_I
(
sbi
);

309 
viùim_£l_pŞicy
 
p
;

310 
£úo
, 
Ï¡_viùim
;

311 
Ï¡_£gm’t
 = 
	`MAIN_SEGS
(
sbi
);

312 
n£¬ched
 = 0;

314 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

316 
p
.
®loc_mode
 =‡lloc_mode;

317 
	`£Ëù_pŞicy
(
sbi
, 
gc_ty³
, 
ty³
, &
p
);

319 
p
.
mš_£gno
 = 
NULL_SEGNO
;

320 
p
.
mš_co¡
 = 
	`g‘_max_co¡
(
sbi
, &p);

322 ià(*
»suÉ
 !ğ
NULL_SEGNO
) {

323 ià(
	`IS_DATASEG
(
	`g‘_£g_’Œy
(
sbi
, *
»suÉ
)->
ty³
) &&

324 
	`g‘_v®id_blocks
(
sbi
, *
»suÉ
, 
çl£
) &&

325 !
	`£c_u§ge_check
(
sbi
, 
	`GET_SEC_FROM_SEG
(sbi, *
»suÉ
)))

326 
p
.
mš_£gno
 = *
»suÉ
;

327 
out
;

330 ià(
p
.
max_£¬ch
 == 0)

331 
out
;

333 
Ï¡_viùim
 = 
sm
->Ï¡_viùim[
p
.
gc_mode
];

334 ià(
p
.
®loc_mode
 =ğ
LFS
 && 
gc_ty³
 =ğ
FG_GC
) {

335 
p
.
mš_£gno
 = 
	`check_bg_viùims
(
sbi
);

336 ià(
p
.
mš_£gno
 !ğ
NULL_SEGNO
)

337 
gÙ_™
;

341 
co¡
;

342 
£gno
;

344 
£gno
 = 
	`fšd_Ãxt_b™
(
p
.
dœty_£gm­
, 
Ï¡_£gm’t
,….
off£t
);

345 ià(
£gno
 >ğ
Ï¡_£gm’t
) {

346 ià(
sm
->
Ï¡_viùim
[
p
.
gc_mode
]) {

347 
Ï¡_£gm’t
 =

348 
sm
->
Ï¡_viùim
[
p
.
gc_mode
];

349 
sm
->
Ï¡_viùim
[
p
.
gc_mode
] = 0;

350 
p
.
off£t
 = 0;

356 
p
.
off£t
 = 
£gno
 +….
ofs_un™
;

357 ià(
p
.
ofs_un™
 > 1) {

358 
p
.
off£t
 -ğ
£gno
 %….
ofs_un™
;

359 
n£¬ched
 +ğ
	`couÁ_b™s
(
p
.
dœty_£gm­
,

360 
p
.
off£t
 -….
ofs_un™
,

361 
p
.
ofs_un™
);

363 
n£¬ched
++;

366 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
);

368 ià(
	`£c_u§ge_check
(
sbi
, 
£úo
))

369 
Ãxt
;

370 ià(
gc_ty³
 =ğ
BG_GC
 && 
	`‹¡_b™
(
£úo
, 
dœty_i
->
viùim_£cm­
))

371 
Ãxt
;

373 
co¡
 = 
	`g‘_gc_co¡
(
sbi
, 
£gno
, &
p
);

375 ià(
p
.
mš_co¡
 > 
co¡
) {

376 
p
.
mš_£gno
 = 
£gno
;

377 
p
.
mš_co¡
 = 
co¡
;

379 
Ãxt
:

380 ià(
n£¬ched
 >ğ
p
.
max_£¬ch
) {

381 ià(!
sm
->
Ï¡_viùim
[
p
.
gc_mode
] && 
£gno
 <=†ast_victim)

382 
sm
->
Ï¡_viùim
[
p
.
gc_mode
] =†ast_victim + 1;

384 
sm
->
Ï¡_viùim
[
p
.
gc_mode
] = 
£gno
 + 1;

385 
sm
->
Ï¡_viùim
[
p
.
gc_mode
] %ğ
	`MAIN_SEGS
(
sbi
);

389 ià(
p
.
mš_£gno
 !ğ
NULL_SEGNO
) {

390 
gÙ_™
:

391 ià(
p
.
®loc_mode
 =ğ
LFS
) {

392 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
p
.
mš_£gno
);

393 ià(
gc_ty³
 =ğ
FG_GC
)

394 
sbi
->
cur_viùim_£c
 = 
£úo
;

396 
	`£t_b™
(
£úo
, 
dœty_i
->
viùim_£cm­
);

398 *
»suÉ
 = (
p
.
mš_£gno
 /….
ofs_un™
) *….ofs_unit;

400 
	`Œaû_f2fs_g‘_viùim
(
sbi
->
sb
, 
ty³
, 
gc_ty³
, &
p
,

401 
sbi
->
cur_viùim_£c
,

402 
	`´eä“_£gm’ts
(
sbi
), 
	`ä“_£gm’ts
(sbi));

404 
out
:

405 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

407  (
p
.
mš_£gno
 =ğ
NULL_SEGNO
) ? 0 : 1;

408 
	}
}

410 cÚ¡ 
viùim_£ËùiÚ
 
	gdeçuÉ_v_İs
 = {

411 .
g‘_viùim
 = 
g‘_viùim_by_deçuÉ
,

414 
šode
 *
	$fšd_gc_šode
(
gc_šode_li¡
 *
gc_li¡
, 
nid_t
 
šo
)

416 
šode_’Œy
 *
›
;

418 
›
 = 
	`¿dix_Œ“_lookup
(&
gc_li¡
->
œoÙ
, 
šo
);

419 ià(
›
)

420  
›
->
šode
;

421  
NULL
;

422 
	}
}

424 
	$add_gc_šode
(
gc_šode_li¡
 *
gc_li¡
, 
šode
 *inode)

426 
šode_’Œy
 *
Ãw_›
;

428 ià(
šode
 =ğ
	`fšd_gc_šode
(
gc_li¡
, inode->
i_šo
)) {

429 
	`ut
(
šode
);

432 
Ãw_›
 = 
	`f2fs_kmem_ÿche_®loc
(
f2fs_šode_’Œy_¦ab
, 
GFP_NOFS
);

433 
Ãw_›
->
šode
 = inode;

435 
	`f2fs_¿dix_Œ“_š£¹
(&
gc_li¡
->
œoÙ
, 
šode
->
i_šo
, 
Ãw_›
);

436 
	`li¡_add_
(&
Ãw_›
->
li¡
, &
gc_li¡
->
i¡
);

437 
	}
}

439 
	$put_gc_šode
(
gc_šode_li¡
 *
gc_li¡
)

441 
šode_’Œy
 *
›
, *
Ãxt_›
;

442 
	`li¡_fÜ_—ch_’Œy_§ã
(
›
, 
Ãxt_›
, &
gc_li¡
->
i¡
, 
li¡
) {

443 
	`¿dix_Œ“_d–‘e
(&
gc_li¡
->
œoÙ
, 
›
->
šode
->
i_šo
);

444 
	`ut
(
›
->
šode
);

445 
	`li¡_d–
(&
›
->
li¡
);

446 
	`kmem_ÿche_ä“
(
f2fs_šode_’Œy_¦ab
, 
›
);

448 
	}
}

450 
	$check_v®id_m­
(
f2fs_sb_šfo
 *
sbi
,

451 
£gno
, 
off£t
)

453 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

454 
£g_’Œy
 *
£Áry
;

455 
»t
;

457 
	`down_»ad
(&
s™_i
->
£Áry_lock
);

458 
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

459 
»t
 = 
	`f2fs_‹¡_b™
(
off£t
, 
£Áry
->
cur_v®id_m­
);

460 
	`up_»ad
(&
s™_i
->
£Áry_lock
);

461  
»t
;

462 
	}
}

469 
	$gc_node_£gm’t
(
f2fs_sb_šfo
 *
sbi
,

470 
f2fs_summ¬y
 *
sum
, 
£gno
, 
gc_ty³
)

472 
f2fs_summ¬y
 *
’Œy
;

473 
block_t
 
¡¬t_addr
;

474 
off
;

475 
pha£
 = 0;

476 
boŞ
 
fggc
 = (
gc_ty³
 =ğ
FG_GC
);

478 
¡¬t_addr
 = 
	`START_BLOCK
(
sbi
, 
£gno
);

480 
Ãxt_¡•
:

481 
’Œy
 = 
sum
;

483 ià(
fggc
 && 
pha£
 == 2)

484 
	`©omic_šc
(&
sbi
->
wb_sync_»q
[
NODE
]);

486 
off
 = 0; ofà< 
sbi
->
blocks_³r_£g
; off++, 
’Œy
++) {

487 
nid_t
 
nid
 = 
	`Ë32_to_ıu
(
’Œy
->nid);

488 
·ge
 *
node_·ge
;

489 
node_šfo
 
ni
;

492 ià(
gc_ty³
 =ğ
BG_GC
 && 
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0))

495 ià(
	`check_v®id_m­
(
sbi
, 
£gno
, 
off
) == 0)

498 ià(
pha£
 == 0) {

499 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`NAT_BLOCK_OFFSET
(
nid
), 1,

500 
META_NAT
, 
Œue
);

504 ià(
pha£
 == 1) {

505 
	`f2fs_¿_node_·ge
(
sbi
, 
nid
);

510 
node_·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
nid
);

511 ià(
	`IS_ERR
(
node_·ge
))

515 ià(
	`check_v®id_m­
(
sbi
, 
£gno
, 
off
) == 0) {

516 
	`f2fs_put_·ge
(
node_·ge
, 1);

520 
	`f2fs_g‘_node_šfo
(
sbi
, 
nid
, &
ni
);

521 ià(
ni
.
blk_addr
 !ğ
¡¬t_addr
 + 
off
) {

522 
	`f2fs_put_·ge
(
node_·ge
, 1);

526 
	`f2fs_move_node_·ge
(
node_·ge
, 
gc_ty³
);

527 
	`¡©_šc_node_blk_couÁ
(
sbi
, 1, 
gc_ty³
);

530 ià(++
pha£
 < 3)

531 
Ãxt_¡•
;

533 ià(
fggc
)

534 
	`©omic_dec
(&
sbi
->
wb_sync_»q
[
NODE
]);

535 
	}
}

544 
block_t
 
	$f2fs_¡¬t_bidx_of_node
(
node_ofs
, 
šode
 *inode)

546 
šdœeù_blks
 = 2 * 
NIDS_PER_BLOCK
 + 4;

547 
bidx
;

549 ià(
node_ofs
 == 0)

552 ià(
node_ofs
 <= 2) {

553 
bidx
 = 
node_ofs
 - 1;

554 } ià(
node_ofs
 <ğ
šdœeù_blks
) {

555 
dec
 = (
node_ofs
 - 4è/ (
NIDS_PER_BLOCK
 + 1);

556 
bidx
 = 
node_ofs
 - 2 - 
dec
;

558 
dec
 = (
node_ofs
 - 
šdœeù_blks
 - 3è/ (
NIDS_PER_BLOCK
 + 1);

559 
bidx
 = 
node_ofs
 - 5 - 
dec
;

561  
bidx
 * 
ADDRS_PER_BLOCK
 + 
	`ADDRS_PER_INODE
(
šode
);

562 
	}
}

564 
boŞ
 
	$is_®ive
(
f2fs_sb_šfo
 *
sbi
, 
f2fs_summ¬y
 *
sum
,

565 
node_šfo
 *
dni
, 
block_t
 
blkaddr
, *
nofs
)

567 
·ge
 *
node_·ge
;

568 
nid_t
 
nid
;

569 
ofs_š_node
;

570 
block_t
 
sourû_blkaddr
;

572 
nid
 = 
	`Ë32_to_ıu
(
sum
->nid);

573 
ofs_š_node
 = 
	`Ë16_to_ıu
(
sum
->ofs_in_node);

575 
node_·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
nid
);

576 ià(
	`IS_ERR
(
node_·ge
))

577  
çl£
;

579 
	`f2fs_g‘_node_šfo
(
sbi
, 
nid
, 
dni
);

581 ià(
sum
->
v”siÚ
 !ğ
dni
->version) {

582 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

584 
__func__
);

585 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

588 *
nofs
 = 
	`ofs_of_node
(
node_·ge
);

589 
sourû_blkaddr
 = 
	`d©ablock_addr
(
NULL
, 
node_·ge
, 
ofs_š_node
);

590 
	`f2fs_put_·ge
(
node_·ge
, 1);

592 ià(
sourû_blkaddr
 !ğ
blkaddr
)

593  
çl£
;

594  
Œue
;

595 
	}
}

601 
	$move_d©a_block
(
šode
 *šode, 
block_t
 
bidx
,

602 
gc_ty³
, 
£gno
, 
off
)

604 
f2fs_io_šfo
 
fio
 = {

605 .
sbi
 = 
	`F2FS_I_SB
(
šode
),

606 .
šo
 = 
šode
->
i_šo
,

607 .
ty³
 = 
DATA
,

608 .
‹mp
 = 
COLD
,

609 .
İ
 = 
REQ_OP_READ
,

610 .
İ_æags
 = 0,

611 .
’üy±ed_·ge
 = 
NULL
,

612 .
š_li¡
 = 
çl£
,

613 .
»Œy
 = 
çl£
,

615 
dnode_of_d©a
 
dn
;

616 
f2fs_summ¬y
 
sum
;

617 
node_šfo
 
ni
;

618 
·ge
 *page;

619 
block_t
 
Ãwaddr
;

620 
”r
;

621 
boŞ
 
lfs_mode
 = 
	`‹¡_İt
(
fio
.
sbi
, 
LFS
);

624 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
šode
->
i_m­pšg
, 
bidx
, 
çl£
);

625 ià(!
·ge
)

628 ià(!
	`check_v®id_m­
(
	`F2FS_I_SB
(
šode
), 
£gno
, 
off
))

629 
out
;

631 ià(
	`f2fs_is_©omic_fe
(
šode
)) {

632 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_ATOMIC
]++;

633 
	`F2FS_I_SB
(
šode
)->
sk³d_©omic_fes
[
gc_ty³
]++;

634 
out
;

637 ià(
	`f2fs_is_pšÃd_fe
(
šode
)) {

638 
	`f2fs_pš_fe_cÚŒŞ
(
šode
, 
Œue
);

639 
out
;

642 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

643 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
bidx
, 
LOOKUP_NODE
);

644 ià(
”r
)

645 
out
;

647 ià(
	`uÆik–y
(
dn
.
d©a_blkaddr
 =ğ
NULL_ADDR
)) {

648 
	`CË¬PageU±od©e
(
·ge
);

649 
put_out
;

656 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
);

658 
	`f2fs_g‘_node_šfo
(
fio
.
sbi
, 
dn
.
nid
, &
ni
);

659 
	`£t_summ¬y
(&
sum
, 
dn
.
nid
, dn.
ofs_š_node
, 
ni
.
v”siÚ
);

662 
fio
.
·ge
 =…age;

663 
fio
.
Ãw_blkaddr
 = fio.
Şd_blkaddr
 = 
dn
.
d©a_blkaddr
;

665 ià(
lfs_mode
)

666 
	`down_wr™e
(&
fio
.
sbi
->
io_Üd”_lock
);

668 
	`f2fs_®loÿ‹_d©a_block
(
fio
.
sbi
, 
NULL
, fio.
Şd_blkaddr
, &
Ãwaddr
,

669 &
sum
, 
CURSEG_COLD_DATA
, 
NULL
, 
çl£
);

671 
fio
.
’üy±ed_·ge
 = 
	`f2fs_·geÿche_g‘_·ge
(
	`META_MAPPING
(fio.
sbi
),

672 
Ãwaddr
, 
FGP_LOCK
 | 
FGP_CREAT
, 
GFP_NOFS
);

673 ià(!
fio
.
’üy±ed_·ge
) {

674 
”r
 = -
ENOMEM
;

675 
»cov”_block
;

678 
”r
 = 
	`f2fs_subm™_·ge_bio
(&
fio
);

679 ià(
”r
)

680 
put_·ge_out
;

683 
	`lock_·ge
(
fio
.
’üy±ed_·ge
);

685 ià(
	`uÆik–y
(
fio
.
’üy±ed_·ge
->
m­pšg
 !ğ
	`META_MAPPING
(fio.
sbi
))) {

686 
”r
 = -
EIO
;

687 
put_·ge_out
;

689 ià(
	`uÆik–y
(!
	`PageU±od©e
(
fio
.
’üy±ed_·ge
))) {

690 
”r
 = -
EIO
;

691 
put_·ge_out
;

694 
	`£t_·ge_dœty
(
fio
.
’üy±ed_·ge
);

695 
	`f2fs_wa™_Ú_·ge_wr™eback
(
fio
.
’üy±ed_·ge
, 
DATA
, 
Œue
);

696 ià(
	`ş—r_·ge_dœty_fÜ_io
(
fio
.
’üy±ed_·ge
))

697 
	`dec_·ge_couÁ
(
fio
.
sbi
, 
F2FS_DIRTY_META
);

699 
	`£t_·ge_wr™eback
(
fio
.
’üy±ed_·ge
);

700 
	`CË¬PageE¼Ü
(
·ge
);

703 
	`f2fs_wa™_Ú_·ge_wr™eback
(
dn
.
node_·ge
, 
NODE
, 
Œue
);

705 
fio
.
İ
 = 
REQ_OP_WRITE
;

706 
fio
.
İ_æags
 = 
REQ_SYNC
;

707 
fio
.
Ãw_blkaddr
 = 
Ãwaddr
;

708 
	`f2fs_subm™_·ge_wr™e
(&
fio
);

709 ià(
fio
.
»Œy
) {

710 ià(
	`PageWr™eback
(
fio
.
’üy±ed_·ge
))

711 
	`’d_·ge_wr™eback
(
fio
.
’üy±ed_·ge
);

712 
put_·ge_out
;

715 
	`f2fs_upd©e_io¡©
(
fio
.
sbi
, 
FS_GC_DATA_IO
, 
F2FS_BLKSIZE
);

717 
	`f2fs_upd©e_d©a_blkaddr
(&
dn
, 
Ãwaddr
);

718 
	`£t_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

719 ià(
·ge
->
šdex
 == 0)

720 
	`£t_šode_æag
(
šode
, 
FI_FIRST_BLOCK_WRITTEN
);

721 
put_·ge_out
:

722 
	`f2fs_put_·ge
(
fio
.
’üy±ed_·ge
, 1);

723 
»cov”_block
:

724 ià(
lfs_mode
)

725 
	`up_wr™e
(&
fio
.
sbi
->
io_Üd”_lock
);

726 ià(
”r
)

727 
	`f2fs_do_»¶aû_block
(
fio
.
sbi
, &
sum
, 
Ãwaddr
, fio.
Şd_blkaddr
,

728 
Œue
,rue);

729 
put_out
:

730 
	`f2fs_put_dnode
(&
dn
);

731 
out
:

732 
	`f2fs_put_·ge
(
·ge
, 1);

733 
	}
}

735 
	$move_d©a_·ge
(
šode
 *šode, 
block_t
 
bidx
, 
gc_ty³
,

736 
£gno
, 
off
)

738 
·ge
 *page;

740 
·ge
 = 
	`f2fs_g‘_lock_d©a_·ge
(
šode
, 
bidx
, 
Œue
);

741 ià(
	`IS_ERR
(
·ge
))

744 ià(!
	`check_v®id_m­
(
	`F2FS_I_SB
(
šode
), 
£gno
, 
off
))

745 
out
;

747 ià(
	`f2fs_is_©omic_fe
(
šode
)) {

748 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_ATOMIC
]++;

749 
	`F2FS_I_SB
(
šode
)->
sk³d_©omic_fes
[
gc_ty³
]++;

750 
out
;

752 ià(
	`f2fs_is_pšÃd_fe
(
šode
)) {

753 ià(
gc_ty³
 =ğ
FG_GC
)

754 
	`f2fs_pš_fe_cÚŒŞ
(
šode
, 
Œue
);

755 
out
;

758 ià(
gc_ty³
 =ğ
BG_GC
) {

759 ià(
	`PageWr™eback
(
·ge
))

760 
out
;

761 
	`£t_·ge_dœty
(
·ge
);

762 
	`£t_cŞd_d©a
(
·ge
);

764 
f2fs_io_šfo
 
fio
 = {

765 .
sbi
 = 
	`F2FS_I_SB
(
šode
),

766 .
šo
 = 
šode
->
i_šo
,

767 .
ty³
 = 
DATA
,

768 .
‹mp
 = 
COLD
,

769 .
İ
 = 
REQ_OP_WRITE
,

770 .
İ_æags
 = 
REQ_SYNC
,

771 .
Şd_blkaddr
 = 
NULL_ADDR
,

772 .
·ge
 =…age,

773 .
’üy±ed_·ge
 = 
NULL
,

774 .
Ãed_lock
 = 
LOCK_REQ
,

775 .
io_ty³
 = 
FS_GC_DATA_IO
,

777 
boŞ
 
is_dœty
 = 
	`PageDœty
(
·ge
);

778 
”r
;

780 
»Œy
:

781 
	`£t_·ge_dœty
(
·ge
);

782 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
);

783 ià(
	`ş—r_·ge_dœty_fÜ_io
(
·ge
)) {

784 
	`šode_dec_dœty_·ges
(
šode
);

785 
	`f2fs_»move_dœty_šode
(
šode
);

788 
	`£t_cŞd_d©a
(
·ge
);

790 
”r
 = 
	`f2fs_do_wr™e_d©a_·ge
(&
fio
);

791 ià(
”r
) {

792 
	`ş—r_cŞd_d©a
(
·ge
);

793 ià(
”r
 =ğ-
ENOMEM
) {

794 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

795 
»Œy
;

797 ià(
is_dœty
)

798 
	`£t_·ge_dœty
(
·ge
);

801 
out
:

802 
	`f2fs_put_·ge
(
·ge
, 1);

803 
	}
}

812 
	$gc_d©a_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
f2fs_summ¬y
 *
sum
,

813 
gc_šode_li¡
 *
gc_li¡
, 
£gno
, 
gc_ty³
)

815 
su³r_block
 *
sb
 = 
sbi
->sb;

816 
f2fs_summ¬y
 *
’Œy
;

817 
block_t
 
¡¬t_addr
;

818 
off
;

819 
pha£
 = 0;

821 
¡¬t_addr
 = 
	`START_BLOCK
(
sbi
, 
£gno
);

823 
Ãxt_¡•
:

824 
’Œy
 = 
sum
;

826 
off
 = 0; ofà< 
sbi
->
blocks_³r_£g
; off++, 
’Œy
++) {

827 
·ge
 *
d©a_·ge
;

828 
šode
 *inode;

829 
node_šfo
 
dni
;

830 
ofs_š_node
, 
nofs
;

831 
block_t
 
¡¬t_bidx
;

832 
nid_t
 
nid
 = 
	`Ë32_to_ıu
(
’Œy
->nid);

835 ià(
gc_ty³
 =ğ
BG_GC
 && 
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0))

838 ià(
	`check_v®id_m­
(
sbi
, 
£gno
, 
off
) == 0)

841 ià(
pha£
 == 0) {

842 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`NAT_BLOCK_OFFSET
(
nid
), 1,

843 
META_NAT
, 
Œue
);

847 ià(
pha£
 == 1) {

848 
	`f2fs_¿_node_·ge
(
sbi
, 
nid
);

853 ià(!
	`is_®ive
(
sbi
, 
’Œy
, &
dni
, 
¡¬t_addr
 + 
off
, &
nofs
))

856 ià(
pha£
 == 2) {

857 
	`f2fs_¿_node_·ge
(
sbi
, 
dni
.
šo
);

861 
ofs_š_node
 = 
	`Ë16_to_ıu
(
’Œy
->ofs_in_node);

863 ià(
pha£
 == 3) {

864 
šode
 = 
	`f2fs_ig‘
(
sb
, 
dni
.
šo
);

865 ià(
	`IS_ERR
(
šode
è|| 
	`is_bad_šode
(inode))

869 ià(
	`f2fs_po¡_»ad_»quœed
(
šode
)) {

870 
	`add_gc_šode
(
gc_li¡
, 
šode
);

874 ià(!
	`down_wr™e_Œylock
(

875 &
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
])) {

876 
	`ut
(
šode
);

880 
¡¬t_bidx
 = 
	`f2fs_¡¬t_bidx_of_node
(
nofs
, 
šode
);

881 
d©a_·ge
 = 
	`f2fs_g‘_»ad_d©a_·ge
(
šode
,

882 
¡¬t_bidx
 + 
ofs_š_node
, 
REQ_RAHEAD
,

883 
Œue
);

884 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

885 ià(
	`IS_ERR
(
d©a_·ge
)) {

886 
	`ut
(
šode
);

890 
	`f2fs_put_·ge
(
d©a_·ge
, 0);

891 
	`add_gc_šode
(
gc_li¡
, 
šode
);

896 
šode
 = 
	`fšd_gc_šode
(
gc_li¡
, 
dni
.
šo
);

897 ià(
šode
) {

898 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

899 
boŞ
 
locked
 = 
çl£
;

901 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

902 ià(!
	`down_wr™e_Œylock
(&
fi
->
i_gc_rw£m
[
READ
]))

904 ià(!
	`down_wr™e_Œylock
(

905 &
fi
->
i_gc_rw£m
[
WRITE
])) {

906 
	`up_wr™e
(&
fi
->
i_gc_rw£m
[
READ
]);

909 
locked
 = 
Œue
;

912 
	`šode_dio_wa™
(
šode
);

915 
¡¬t_bidx
 = 
	`f2fs_¡¬t_bidx_of_node
(
nofs
, 
šode
)

916 + 
ofs_š_node
;

917 ià(
	`f2fs_po¡_»ad_»quœed
(
šode
))

918 
	`move_d©a_block
(
šode
, 
¡¬t_bidx
, 
gc_ty³
,

919 
£gno
, 
off
);

921 
	`move_d©a_·ge
(
šode
, 
¡¬t_bidx
, 
gc_ty³
,

922 
£gno
, 
off
);

924 ià(
locked
) {

925 
	`up_wr™e
(&
fi
->
i_gc_rw£m
[
WRITE
]);

926 
	`up_wr™e
(&
fi
->
i_gc_rw£m
[
READ
]);

929 
	`¡©_šc_d©a_blk_couÁ
(
sbi
, 1, 
gc_ty³
);

933 ià(++
pha£
 < 5)

934 
Ãxt_¡•
;

935 
	}
}

937 
	$__g‘_viùim
(
f2fs_sb_šfo
 *
sbi
, *
viùim
,

938 
gc_ty³
)

940 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

941 
»t
;

943 
	`down_wr™e
(&
s™_i
->
£Áry_lock
);

944 
»t
 = 
	`DIRTY_I
(
sbi
)->
v_İs
->
	`g‘_viùim
(sbi, 
viùim
, 
gc_ty³
,

945 
NO_CHECK_TYPE
, 
LFS
);

946 
	`up_wr™e
(&
s™_i
->
£Áry_lock
);

947  
»t
;

948 
	}
}

950 
	$do_g¬bage_cŞËù
(
f2fs_sb_šfo
 *
sbi
,

951 
¡¬t_£gno
,

952 
gc_šode_li¡
 *
gc_li¡
, 
gc_ty³
)

954 
·ge
 *
sum_·ge
;

955 
f2fs_summ¬y_block
 *
sum
;

956 
blk_¶ug
 
¶ug
;

957 
£gno
 = 
¡¬t_£gno
;

958 
’d_£gno
 = 
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
;

959 
£g_ä“d
 = 0;

960 
ty³
 = 
	`IS_DATASEG
(
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->type) ?

961 
SUM_TYPE_DATA
 : 
SUM_TYPE_NODE
;

964 ià(
sbi
->
£gs_³r_£c
 > 1)

965 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`GET_SUM_BLOCK
(sbi, 
£gno
),

966 
sbi
->
£gs_³r_£c
, 
META_SSA
, 
Œue
);

969 
£gno
 < 
’d_£gno
) {

970 
sum_·ge
 = 
	`f2fs_g‘_sum_·ge
(
sbi
, 
£gno
++);

971 
	`uÆock_·ge
(
sum_·ge
);

974 
	`blk_¡¬t_¶ug
(&
¶ug
);

976 
£gno
 = 
¡¬t_£gno
; segnØ< 
’d_£gno
; segno++) {

979 
sum_·ge
 = 
	`fšd_g‘_·ge
(
	`META_MAPPING
(
sbi
),

980 
	`GET_SUM_BLOCK
(
sbi
, 
£gno
));

981 
	`f2fs_put_·ge
(
sum_·ge
, 0);

983 ià(
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
çl£
) == 0 ||

984 !
	`PageU±od©e
(
sum_·ge
) ||

985 
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

986 
Ãxt
;

988 
sum
 = 
	`·ge_add»ss
(
sum_·ge
);

989 
	`f2fs_bug_Ú
(
sbi
, 
ty³
 !ğ
	`GET_SUM_TYPE
((&
sum
->
foÙ”
)));

998 ià(
ty³
 =ğ
SUM_TYPE_NODE
)

999 
	`gc_node_£gm’t
(
sbi
, 
sum
->
’Œ›s
, 
£gno
, 
gc_ty³
);

1001 
	`gc_d©a_£gm’t
(
sbi
, 
sum
->
’Œ›s
, 
gc_li¡
, 
£gno
,

1002 
gc_ty³
);

1004 
	`¡©_šc_£g_couÁ
(
sbi
, 
ty³
, 
gc_ty³
);

1006 ià(
gc_ty³
 =ğ
FG_GC
 &&

1007 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
çl£
) == 0)

1008 
£g_ä“d
++;

1009 
Ãxt
:

1010 
	`f2fs_put_·ge
(
sum_·ge
, 0);

1013 ià(
gc_ty³
 =ğ
FG_GC
)

1014 
	`f2fs_subm™_m”ged_wr™e
(
sbi
,

1015 (
ty³
 =ğ
SUM_TYPE_NODE
è? 
NODE
 : 
DATA
);

1017 
	`blk_fšish_¶ug
(&
¶ug
);

1019 
	`¡©_šc_ÿÎ_couÁ
(
sbi
->
¡©_šfo
);

1021  
£g_ä“d
;

1022 
	}
}

1024 
	$f2fs_gc
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
sync
,

1025 
boŞ
 
background
, 
£gno
)

1027 
gc_ty³
 = 
sync
 ? 
FG_GC
 : 
BG_GC
;

1028 
£c_ä“d
 = 0, 
£g_ä“d
 = 0, 
tÙ®_ä“d
 = 0;

1029 
»t
 = 0;

1030 
ı_cÚŒŞ
 
ıc
;

1031 
š™_£gno
 = 
£gno
;

1032 
gc_šode_li¡
 
gc_li¡
 = {

1033 .
i¡
 = 
	`LIST_HEAD_INIT
(
gc_li¡
.ilist),

1034 .
œoÙ
 = 
	`RADIX_TREE_INIT
(
gc_li¡
.œoÙ, 
GFP_NOFS
),

1036 
Ï¡_sk³d
 = 
sbi
->
sk³d_©omic_fes
[
FG_GC
];

1037 
sk³d_round
 = 0, 
round
 = 0;

1039 
	`Œaû_f2fs_gc_begš
(
sbi
->
sb
, 
sync
, 
background
,

1040 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
),

1041 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
),

1042 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_IMETA
),

1043 
	`ä“_£ùiÚs
(
sbi
),

1044 
	`ä“_£gm’ts
(
sbi
),

1045 
	`»£rved_£gm’ts
(
sbi
),

1046 
	`´eä“_£gm’ts
(
sbi
));

1048 
ıc
.
»asÚ
 = 
	`__g‘_ı_»asÚ
(
sbi
);

1049 
gc_mÜe
:

1050 ià(
	`uÆik–y
(!(
sbi
->
sb
->
s_æags
 & 
SB_ACTIVE
))) {

1051 
»t
 = -
EINVAL
;

1052 
¡İ
;

1054 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1055 
»t
 = -
EIO
;

1056 
¡İ
;

1059 ià(
gc_ty³
 =ğ
BG_GC
 && 
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0)) {

1065 ià(
	`´eä“_£gm’ts
(
sbi
)) {

1066 
»t
 = 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

1067 ià(
»t
)

1068 
¡İ
;

1070 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0))

1071 
gc_ty³
 = 
FG_GC
;

1075 ià(
gc_ty³
 =ğ
BG_GC
 && !
background
) {

1076 
»t
 = -
EINVAL
;

1077 
¡İ
;

1079 ià(!
	`__g‘_viùim
(
sbi
, &
£gno
, 
gc_ty³
)) {

1080 
»t
 = -
ENODATA
;

1081 
¡İ
;

1084 
£g_ä“d
 = 
	`do_g¬bage_cŞËù
(
sbi
, 
£gno
, &
gc_li¡
, 
gc_ty³
);

1085 ià(
gc_ty³
 =ğ
FG_GC
 && 
£g_ä“d
 =ğ
sbi
->
£gs_³r_£c
)

1086 
£c_ä“d
++;

1087 
tÙ®_ä“d
 +ğ
£g_ä“d
;

1089 ià(
gc_ty³
 =ğ
FG_GC
) {

1090 ià(
sbi
->
sk³d_©omic_fes
[
FG_GC
] > 
Ï¡_sk³d
)

1091 
sk³d_round
++;

1092 
Ï¡_sk³d
 = 
sbi
->
sk³d_©omic_fes
[
FG_GC
];

1093 
round
++;

1096 ià(
gc_ty³
 =ğ
FG_GC
)

1097 
sbi
->
cur_viùim_£c
 = 
NULL_SEGNO
;

1099 ià(!
sync
) {

1100 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 
£c_ä“d
, 0)) {

1101 ià(
sk³d_round
 > 
MAX_SKIP_ATOMIC_COUNT
 &&

1102 
sk³d_round
 * 2 >ğ
round
)

1103 
	`f2fs_drİ_šmem_·ges_®l
(
sbi
, 
Œue
);

1104 
£gno
 = 
NULL_SEGNO
;

1105 
gc_mÜe
;

1108 ià(
gc_ty³
 =ğ
FG_GC
)

1109 
»t
 = 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

1111 
¡İ
:

1112 
	`SIT_I
(
sbi
)->
Ï¡_viùim
[
ALLOC_NEXT
] = 0;

1113 
	`SIT_I
(
sbi
)->
Ï¡_viùim
[
FLUSH_DEVICE
] = 
š™_£gno
;

1115 
	`Œaû_f2fs_gc_’d
(
sbi
->
sb
, 
»t
, 
tÙ®_ä“d
, 
£c_ä“d
,

1116 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
),

1117 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
),

1118 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_IMETA
),

1119 
	`ä“_£ùiÚs
(
sbi
),

1120 
	`ä“_£gm’ts
(
sbi
),

1121 
	`»£rved_£gm’ts
(
sbi
),

1122 
	`´eä“_£gm’ts
(
sbi
));

1124 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

1126 
	`put_gc_šode
(&
gc_li¡
);

1128 ià(
sync
)

1129 
»t
 = 
£c_ä“d
 ? 0 : -
EAGAIN
;

1130  
»t
;

1131 
	}
}

1133 
	$f2fs_bud_gc_mªag”
(
f2fs_sb_šfo
 *
sbi
)

1135 
	`DIRTY_I
(
sbi
)->
v_İs
 = &
deçuÉ_v_İs
;

1137 
sbi
->
gc_pš_fe_th»shŞd
 = 
DEF_GC_FAILED_PINNED_FILES
;

1140 ià(
sbi
->
s_ndevs
 && sbi->
£gs_³r_£c
 == 1)

1141 
	`SIT_I
(
sbi
)->
Ï¡_viùim
[
ALLOC_NEXT
] =

1142 
	`GET_SEGNO
(
sbi
, 
	`FDEV
(0).
’d_blk
) + 1;

1143 
	}
}

	@fs/f2fs/gc.h

11 
	#GC_THREAD_MIN_WB_PAGES
 1

	)

16 
	#DEF_GC_THREAD_URGENT_SLEEP_TIME
 500

	)

17 
	#DEF_GC_THREAD_MIN_SLEEP_TIME
 30000

	)

18 
	#DEF_GC_THREAD_MAX_SLEEP_TIME
 60000

	)

19 
	#DEF_GC_THREAD_NOGC_SLEEP_TIME
 300000

	)

20 
	#LIMIT_INVALID_BLOCK
 40

	)

21 
	#LIMIT_FREE_BLOCK
 40

	)

23 
	#DEF_GC_FAILED_PINNED_FILES
 2048

	)

26 
	#DEF_MAX_VICTIM_SEARCH
 4096

	)

28 
	sf2fs_gc_kth»ad
 {

29 
sk_¡ruù
 *
	mf2fs_gc_sk
;

30 
wa™_queue_h—d_t
 
	mgc_wa™_queue_h—d
;

33 
	murg’t_¦“p_time
;

34 
	mmš_¦“p_time
;

35 
	mmax_¦“p_time
;

36 
	mno_gc_¦“p_time
;

39 
	mgc_wake
;

42 
	sgc_šode_li¡
 {

43 
li¡_h—d
 
	mi¡
;

44 
¿dix_Œ“_roÙ
 
	mœoÙ
;

50 
šlše
 
block_t
 
	$ä“_u£r_blocks
(
f2fs_sb_šfo
 *
sbi
)

52 ià(
	`ä“_£gm’ts
(
sbi
è< 
	`ov”´ovisiÚ_£gm’ts
(sbi))

55  (
	`ä“_£gm’ts
(
sbi
è- 
	`ov”´ovisiÚ_£gm’ts
(sbi))

56 << 
sbi
->
log_blocks_³r_£g
;

57 
	}
}

59 
šlše
 
block_t
 
	$lim™_šv®id_u£r_blocks
(
f2fs_sb_šfo
 *
sbi
)

61  ()(
sbi
->
u£r_block_couÁ
 * 
LIMIT_INVALID_BLOCK
) / 100;

62 
	}
}

64 
šlše
 
block_t
 
	$lim™_ä“_u£r_blocks
(
f2fs_sb_šfo
 *
sbi
)

66 
block_t
 
»şaimabË_u£r_blocks
 = 
sbi
->
u£r_block_couÁ
 -

67 
	`wr™‹n_block_couÁ
(
sbi
);

68  ()(
»şaimabË_u£r_blocks
 * 
LIMIT_FREE_BLOCK
) / 100;

69 
	}
}

71 
šlše
 
	$šü—£_¦“p_time
(
f2fs_gc_kth»ad
 *
gc_th
,

72 *
wa™
)

74 
mš_time
 = 
gc_th
->
mš_¦“p_time
;

75 
max_time
 = 
gc_th
->
max_¦“p_time
;

77 ià(*
wa™
 =ğ
gc_th
->
no_gc_¦“p_time
)

80 ià(()*
wa™
 + ()
mš_time
 > ()
max_time
)

81 *
wa™
 = 
max_time
;

83 *
wa™
 +ğ
mš_time
;

84 
	}
}

86 
šlše
 
	$deü—£_¦“p_time
(
f2fs_gc_kth»ad
 *
gc_th
,

87 *
wa™
)

89 
mš_time
 = 
gc_th
->
mš_¦“p_time
;

91 ià(*
wa™
 =ğ
gc_th
->
no_gc_¦“p_time
)

92 *
wa™
 = 
gc_th
->
max_¦“p_time
;

94 ià(()*
wa™
 - ()
mš_time
 < ()min_time)

95 *
wa™
 = 
mš_time
;

97 *
wa™
 -ğ
mš_time
;

98 
	}
}

100 
šlše
 
boŞ
 
	$has_’ough_šv®id_blocks
(
f2fs_sb_šfo
 *
sbi
)

102 
block_t
 
šv®id_u£r_blocks
 = 
sbi
->
u£r_block_couÁ
 -

103 
	`wr™‹n_block_couÁ
(
sbi
);

109 ià(
šv®id_u£r_blocks
 > 
	`lim™_šv®id_u£r_blocks
(
sbi
) &&

110 
	`ä“_u£r_blocks
(
sbi
è< 
	`lim™_ä“_u£r_blocks
(sbi))

111  
Œue
;

112  
çl£
;

113 
	}
}

	@fs/f2fs/hash.c

15 
	~<lšux/ty³s.h
>

16 
	~<lšux/fs.h
>

17 
	~<lšux/f2fs_fs.h
>

18 
	~<lšux/üy±ohash.h
>

19 
	~<lšux/·gem­.h
>

21 
	~"f2fs.h
"

26 
	#DELTA
 0x9E3779B9

	)

28 
	$TEA_ŒªsfÜm
(
buf
[4], cÚ¡ 
š
[])

30 
__u32
 
sum
 = 0;

31 
__u32
 
b0
 = 
buf
[0], 
b1
 = buf[1];

32 
__u32
 
a
 = 
š
[0], 
b
 = in[1], 
c
 = in[2], 
d
 = in[3];

33 
n
 = 16;

36 
sum
 +ğ
DELTA
;

37 
b0
 +ğ((
b1
 << 4)+
a
è^ (b1+
sum
è^ ((b1 >> 5)+
b
);

38 
b1
 +ğ((
b0
 << 4)+
c
è^ (b0+
sum
è^ ((b0 >> 5)+
d
);

39 } --
n
);

41 
buf
[0] +ğ
b0
;

42 
buf
[1] +ğ
b1
;

43 
	}
}

45 
	$¡r2hashbuf
(cÚ¡ *
msg
, 
size_t
 
Ën
,

46 *
buf
, 
num
)

48 
·d
, 
v®
;

49 
i
;

51 
·d
 = (
__u32
)
Ën
 | ((__u32)len << 8);

52 
·d
 |=…ad << 16;

54 
v®
 = 
·d
;

55 ià(
Ën
 > 
num
 * 4)

56 
Ën
 = 
num
 * 4;

57 
i
 = 0; i < 
Ën
; i++) {

58 ià((
i
 % 4) == 0)

59 
v®
 = 
·d
;

60 
v®
 = 
msg
[
i
] + (val << 8);

61 ià((
i
 % 4) == 3) {

62 *
buf
++ = 
v®
;

63 
v®
 = 
·d
;

64 
num
--;

67 ià(--
num
 >= 0)

68 *
buf
++ = 
v®
;

69 --
num
 >= 0)

70 *
buf
++ = 
·d
;

71 
	}
}

73 
f2fs_hash_t
 
	$f2fs_d’Œy_hash
(cÚ¡ 
q¡r
 *
Çme_šfo
,

74 
fsüy±_Çme
 *
âame
)

76 
__u32
 
hash
;

77 
f2fs_hash_t
 
f2fs_hash
;

78 cÚ¡ *
p
;

79 
__u32
 
š
[8], 
buf
[4];

80 cÚ¡ *
Çme
 = 
Çme_šfo
->name;

81 
size_t
 
Ën
 = 
Çme_šfo
->len;

84 ià(
âame
 && !âame->
disk_Çme
.
Çme
)

85  
	`ıu_to_Ë32
(
âame
->
hash
);

87 ià(
	`is_dÙ_dÙdÙ
(
Çme_šfo
))

91 
buf
[0] = 0x67452301;

92 
buf
[1] = 0xefcdab89;

93 
buf
[2] = 0x98badcfe;

94 
buf
[3] = 0x10325476;

96 
p
 = 
Çme
;

98 
	`¡r2hashbuf
(
p
, 
Ën
, 
š
, 4);

99 
	`TEA_ŒªsfÜm
(
buf
, 
š
);

100 
p
 += 16;

101 ià(
Ën
 <= 16)

103 
Ën
 -= 16;

105 
hash
 = 
buf
[0];

106 
f2fs_hash
 = 
	`ıu_to_Ë32
(
hash
 & ~
F2FS_HASH_COL_BIT
);

107  
f2fs_hash
;

108 
	}
}

	@fs/f2fs/inline.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

14 
	~"f2fs.h
"

15 
	~"node.h
"

17 
boŞ
 
	$f2fs_may_šlše_d©a
(
šode
 *inode)

19 ià(
	`f2fs_is_©omic_fe
(
šode
))

20  
çl£
;

22 ià(!
	`S_ISREG
(
šode
->
i_mode
è&& !
	`S_ISLNK
(inode->i_mode))

23  
çl£
;

25 ià(
	`i_size_»ad
(
šode
è> 
	`MAX_INLINE_DATA
(inode))

26  
çl£
;

28 ià(
	`f2fs_po¡_»ad_»quœed
(
šode
))

29  
çl£
;

31  
Œue
;

32 
	}
}

34 
boŞ
 
	$f2fs_may_šlše_d’Œy
(
šode
 *inode)

36 ià(!
	`‹¡_İt
(
	`F2FS_I_SB
(
šode
), 
INLINE_DENTRY
))

37  
çl£
;

39 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

40  
çl£
;

42  
Œue
;

43 
	}
}

45 
	$f2fs_do_»ad_šlše_d©a
(
·ge
 *·ge, ·g*
age
)

47 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

48 *
¤c_addr
, *
d¡_addr
;

50 ià(
	`PageU±od©e
(
·ge
))

53 
	`f2fs_bug_Ú
(
	`F2FS_P_SB
(
·ge
),…age->
šdex
);

55 
	`z”o_u£r_£gm’t
(
·ge
, 
	`MAX_INLINE_DATA
(
šode
), 
PAGE_SIZE
);

58 
¤c_addr
 = 
	`šlše_d©a_addr
(
šode
, 
age
);

59 
d¡_addr
 = 
	`km­_©omic
(
·ge
);

60 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
	`MAX_INLINE_DATA
(
šode
));

61 
	`æush_dÿche_·ge
(
·ge
);

62 
	`kunm­_©omic
(
d¡_addr
);

63 ià(!
	`PageU±od©e
(
·ge
))

64 
	`S‘PageU±od©e
(
·ge
);

65 
	}
}

67 
	$f2fs_Œunÿ‹_šlše_šode
(
šode
 *inode,

68 
·ge
 *
age
, 
u64
 
äom
)

70 *
addr
;

72 ià(
äom
 >ğ
	`MAX_INLINE_DATA
(
šode
))

75 
addr
 = 
	`šlše_d©a_addr
(
šode
, 
age
);

77 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
);

78 
	`mem£t
(
addr
 + 
äom
, 0, 
	`MAX_INLINE_DATA
(
šode
) - from);

79 
	`£t_·ge_dœty
(
age
);

81 ià(
äom
 == 0)

82 
	`ş—r_šode_æag
(
šode
, 
FI_DATA_EXIST
);

83 
	}
}

85 
	$f2fs_»ad_šlše_d©a
(
šode
 *šode, 
·ge
 *page)

87 
·ge
 *
age
;

89 
age
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
);

90 ià(
	`IS_ERR
(
age
)) {

91 
	`uÆock_·ge
(
·ge
);

92  
	`PTR_ERR
(
age
);

95 ià(!
	`f2fs_has_šlše_d©a
(
šode
)) {

96 
	`f2fs_put_·ge
(
age
, 1);

97  -
EAGAIN
;

100 ià(
·ge
->
šdex
)

101 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

103 
	`f2fs_do_»ad_šlše_d©a
(
·ge
, 
age
);

105 ià(!
	`PageU±od©e
(
·ge
))

106 
	`S‘PageU±od©e
(
·ge
);

107 
	`f2fs_put_·ge
(
age
, 1);

108 
	`uÆock_·ge
(
·ge
);

110 
	}
}

112 
	$f2fs_cÚv”t_šlše_·ge
(
dnode_of_d©a
 *
dn
, 
·ge
 *page)

114 
f2fs_io_šfo
 
fio
 = {

115 .
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
),

116 .
šo
 = 
dn
->
šode
->
i_šo
,

117 .
ty³
 = 
DATA
,

118 .
İ
 = 
REQ_OP_WRITE
,

119 .
İ_æags
 = 
REQ_SYNC
 | 
REQ_PRIO
,

120 .
·ge
 =…age,

121 .
’üy±ed_·ge
 = 
NULL
,

122 .
io_ty³
 = 
FS_DATA_IO
,

124 
dœty
, 
”r
;

126 ià(!
	`f2fs_exi¡_d©a
(
dn
->
šode
))

127 
ş—r_out
;

129 
”r
 = 
	`f2fs_»£rve_block
(
dn
, 0);

130 ià(
”r
)

131  
”r
;

133 
	`f2fs_bug_Ú
(
	`F2FS_P_SB
(
·ge
), 
	`PageWr™eback
(page));

135 
	`f2fs_do_»ad_šlše_d©a
(
·ge
, 
dn
->
šode_·ge
);

136 
	`£t_·ge_dœty
(
·ge
);

139 
dœty
 = 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

142 
	`£t_·ge_wr™eback
(
·ge
);

143 
	`CË¬PageE¼Ü
(
·ge
);

144 
fio
.
Şd_blkaddr
 = 
dn
->
d©a_blkaddr
;

145 
	`£t_šode_æag
(
dn
->
šode
, 
FI_HOT_DATA
);

146 
	`f2fs_ouÏû_wr™e_d©a
(
dn
, &
fio
);

147 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
);

148 ià(
dœty
) {

149 
	`šode_dec_dœty_·ges
(
dn
->
šode
);

150 
	`f2fs_»move_dœty_šode
(
dn
->
šode
);

154 
	`£t_šode_æag
(
dn
->
šode
, 
FI_APPEND_WRITE
);

157 
	`f2fs_Œunÿ‹_šlše_šode
(
dn
->
šode
, dn->
šode_·ge
, 0);

158 
	`ş—r_šlše_node
(
dn
->
šode_·ge
);

159 
ş—r_out
:

160 
	`¡©_dec_šlše_šode
(
dn
->
šode
);

161 
	`ş—r_šode_æag
(
dn
->
šode
, 
FI_INLINE_DATA
);

162 
	`f2fs_put_dnode
(
dn
);

164 
	}
}

166 
	$f2fs_cÚv”t_šlše_šode
(
šode
 *inode)

168 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

169 
dnode_of_d©a
 
dn
;

170 
·ge
 *
age
, *page;

171 
”r
 = 0;

173 ià(!
	`f2fs_has_šlše_d©a
(
šode
))

176 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
šode
->
i_m­pšg
, 0, 
çl£
);

177 ià(!
·ge
)

178  -
ENOMEM
;

180 
	`f2fs_lock_İ
(
sbi
);

182 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

183 ià(
	`IS_ERR
(
age
)) {

184 
”r
 = 
	`PTR_ERR
(
age
);

185 
out
;

188 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
age
, ipage, 0);

190 ià(
	`f2fs_has_šlše_d©a
(
šode
))

191 
”r
 = 
	`f2fs_cÚv”t_šlše_·ge
(&
dn
, 
·ge
);

193 
	`f2fs_put_dnode
(&
dn
);

194 
out
:

195 
	`f2fs_uÆock_İ
(
sbi
);

197 
	`f2fs_put_·ge
(
·ge
, 1);

199 
	`f2fs_b®ªû_fs
(
sbi
, 
dn
.
node_chªged
);

201  
”r
;

202 
	}
}

204 
	$f2fs_wr™e_šlše_d©a
(
šode
 *šode, 
·ge
 *page)

206 *
¤c_addr
, *
d¡_addr
;

207 
dnode_of_d©a
 
dn
;

208 
”r
;

210 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

211 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 0, 
LOOKUP_NODE
);

212 ià(
”r
)

213  
”r
;

215 ià(!
	`f2fs_has_šlše_d©a
(
šode
)) {

216 
	`f2fs_put_dnode
(&
dn
);

217  -
EAGAIN
;

220 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
), 
·ge
->
šdex
);

222 
	`f2fs_wa™_Ú_·ge_wr™eback
(
dn
.
šode_·ge
, 
NODE
, 
Œue
);

223 
¤c_addr
 = 
	`km­_©omic
(
·ge
);

224 
d¡_addr
 = 
	`šlše_d©a_addr
(
šode
, 
dn
.
šode_·ge
);

225 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
	`MAX_INLINE_DATA
(
šode
));

226 
	`kunm­_©omic
(
¤c_addr
);

227 
	`£t_·ge_dœty
(
dn
.
šode_·ge
);

229 
	`f2fs_ş—r_¿dix_Œ“_dœty_g
(
·ge
);

231 
	`£t_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

232 
	`£t_šode_æag
(
šode
, 
FI_DATA_EXIST
);

234 
	`ş—r_šlše_node
(
dn
.
šode_·ge
);

235 
	`f2fs_put_dnode
(&
dn
);

237 
	}
}

239 
boŞ
 
	$f2fs_»cov”_šlše_d©a
(
šode
 *šode, 
·ge
 *
Åage
)

241 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

242 
f2fs_šode
 *
ri
 = 
NULL
;

243 *
¤c_addr
, *
d¡_addr
;

244 
·ge
 *
age
;

254 ià(
	`IS_INODE
(
Åage
))

255 
ri
 = 
	`F2FS_INODE
(
Åage
);

257 ià(
	`f2fs_has_šlše_d©a
(
šode
) &&

258 
ri
 && (ri->
i_šlše
 & 
F2FS_INLINE_DATA
)) {

259 
´oûss_šlše
:

260 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

261 
	`f2fs_bug_Ú
(
sbi
, 
	`IS_ERR
(
age
));

263 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
);

265 
¤c_addr
 = 
	`šlše_d©a_addr
(
šode
, 
Åage
);

266 
d¡_addr
 = 
	`šlše_d©a_addr
(
šode
, 
age
);

267 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
	`MAX_INLINE_DATA
(
šode
));

269 
	`£t_šode_æag
(
šode
, 
FI_INLINE_DATA
);

270 
	`£t_šode_æag
(
šode
, 
FI_DATA_EXIST
);

272 
	`£t_·ge_dœty
(
age
);

273 
	`f2fs_put_·ge
(
age
, 1);

274  
Œue
;

277 ià(
	`f2fs_has_šlše_d©a
(
šode
)) {

278 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

279 
	`f2fs_bug_Ú
(
sbi
, 
	`IS_ERR
(
age
));

280 
	`f2fs_Œunÿ‹_šlše_šode
(
šode
, 
age
, 0);

281 
	`ş—r_šode_æag
(
šode
, 
FI_INLINE_DATA
);

282 
	`f2fs_put_·ge
(
age
, 1);

283 } ià(
ri
 && (ri->
i_šlše
 & 
F2FS_INLINE_DATA
)) {

284 ià(
	`f2fs_Œunÿ‹_blocks
(
šode
, 0, 
çl£
))

285  
çl£
;

286 
´oûss_šlše
;

288  
çl£
;

289 
	}
}

291 
f2fs_dœ_’Œy
 *
	$f2fs_fšd_š_šlše_dœ
(
šode
 *
dœ
,

292 
fsüy±_Çme
 *
âame
, 
·ge
 **
»s_·ge
)

294 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
dœ
->
i_sb
);

295 
q¡r
 
Çme
 = 
	`FSTR_TO_QSTR
(&
âame
->
disk_Çme
);

296 
f2fs_dœ_’Œy
 *
de
;

297 
f2fs_d’Œy_±r
 
d
;

298 
·ge
 *
age
;

299 *
šlše_d’Œy
;

300 
f2fs_hash_t
 
Çmehash
;

302 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
dœ
->
i_šo
);

303 ià(
	`IS_ERR
(
age
)) {

304 *
»s_·ge
 = 
age
;

305  
NULL
;

308 
Çmehash
 = 
	`f2fs_d’Œy_hash
(&
Çme
, 
âame
);

310 
šlše_d’Œy
 = 
	`šlše_d©a_addr
(
dœ
, 
age
);

312 
	`make_d’Œy_±r_šlše
(
dœ
, &
d
, 
šlše_d’Œy
);

313 
de
 = 
	`f2fs_fšd_rg‘_d’Œy
(
âame
, 
Çmehash
, 
NULL
, &
d
);

314 
	`uÆock_·ge
(
age
);

315 ià(
de
)

316 *
»s_·ge
 = 
age
;

318 
	`f2fs_put_·ge
(
age
, 0);

320  
de
;

321 
	}
}

323 
	$f2fs_make_em±y_šlše_dœ
(
šode
 *šode, šod*
·»Á
,

324 
·ge
 *
age
)

326 
f2fs_d’Œy_±r
 
d
;

327 *
šlše_d’Œy
;

329 
šlše_d’Œy
 = 
	`šlše_d©a_addr
(
šode
, 
age
);

331 
	`make_d’Œy_±r_šlše
(
šode
, &
d
, 
šlše_d’Œy
);

332 
	`f2fs_do_make_em±y_dœ
(
šode
, 
·»Á
, &
d
);

334 
	`£t_·ge_dœty
(
age
);

337 ià(
	`i_size_»ad
(
šode
è< 
	`MAX_INLINE_DATA
(inode))

338 
	`f2fs_i_size_wr™e
(
šode
, 
	`MAX_INLINE_DATA
(inode));

340 
	}
}

346 
	$f2fs_move_šlše_dœ’ts
(
šode
 *
dœ
, 
·ge
 *
age
,

347 *
šlše_d’Œy
)

349 
·ge
 *page;

350 
dnode_of_d©a
 
dn
;

351 
f2fs_d’Œy_block
 *
d’Œy_blk
;

352 
f2fs_d’Œy_±r
 
¤c
, 
d¡
;

353 
”r
;

355 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
dœ
->
i_m­pšg
, 0, 
çl£
);

356 ià(!
·ge
) {

357 
	`f2fs_put_·ge
(
age
, 1);

358  -
ENOMEM
;

361 
	`£t_Ãw_dnode
(&
dn
, 
dœ
, 
age
, 
NULL
, 0);

362 
”r
 = 
	`f2fs_»£rve_block
(&
dn
, 0);

363 ià(
”r
)

364 
out
;

366 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
);

368 
d’Œy_blk
 = 
	`·ge_add»ss
(
·ge
);

370 
	`make_d’Œy_±r_šlše
(
dœ
, &
¤c
, 
šlše_d’Œy
);

371 
	`make_d’Œy_±r_block
(
dœ
, &
d¡
, 
d’Œy_blk
);

374 
	`memıy
(
d¡
.
b™m­
, 
¤c
.b™m­, src.
Ä_b™m­
);

375 
	`mem£t
(
d¡
.
b™m­
 + 
¤c
.
Ä_b™m­
, 0, dst.nr_bitmap - src.nr_bitmap);

382 
	`memıy
(
d¡
.
d’Œy
, 
¤c
.d’Œy, 
SIZE_OF_DIR_ENTRY
 * src.
max
);

383 
	`memıy
(
d¡
.
f’ame
, 
¤c
.f’ame, src.
max
 * 
F2FS_SLOT_LEN
);

385 ià(!
	`PageU±od©e
(
·ge
))

386 
	`S‘PageU±od©e
(
·ge
);

387 
	`£t_·ge_dœty
(
·ge
);

390 
	`f2fs_Œunÿ‹_šlše_šode
(
dœ
, 
age
, 0);

392 
	`¡©_dec_šlše_dœ
(
dœ
);

393 
	`ş—r_šode_æag
(
dœ
, 
FI_INLINE_DENTRY
);

395 
	`f2fs_i_d•th_wr™e
(
dœ
, 1);

396 ià(
	`i_size_»ad
(
dœ
è< 
PAGE_SIZE
)

397 
	`f2fs_i_size_wr™e
(
dœ
, 
PAGE_SIZE
);

398 
out
:

399 
	`f2fs_put_·ge
(
·ge
, 1);

400  
”r
;

401 
	}
}

403 
	$f2fs_add_šlše_’Œ›s
(
šode
 *
dœ
, *
šlše_d’Œy
)

405 
f2fs_d’Œy_±r
 
d
;

406 
b™_pos
 = 0;

407 
”r
 = 0;

409 
	`make_d’Œy_±r_šlše
(
dœ
, &
d
, 
šlše_d’Œy
);

411 
b™_pos
 < 
d
.
max
) {

412 
f2fs_dœ_’Œy
 *
de
;

413 
q¡r
 
Ãw_Çme
;

414 
nid_t
 
šo
;

415 
umode_t
 
çke_mode
;

417 ià(!
	`‹¡_b™_Ë
(
b™_pos
, 
d
.
b™m­
)) {

418 
b™_pos
++;

422 
de
 = &
d
.
d’Œy
[
b™_pos
];

424 ià(
	`uÆik–y
(!
de
->
Çme_Ën
)) {

425 
b™_pos
++;

429 
Ãw_Çme
.
Çme
 = 
d
.
f’ame
[
b™_pos
];

430 
Ãw_Çme
.
Ën
 = 
	`Ë16_to_ıu
(
de
->
Çme_Ën
);

432 
šo
 = 
	`Ë32_to_ıu
(
de
->ino);

433 
çke_mode
 = 
	`f2fs_g‘_de_ty³
(
de
è<< 
S_SHIFT
;

435 
”r
 = 
	`f2fs_add_»guÏr_’Œy
(
dœ
, &
Ãw_Çme
, 
NULL
, NULL,

436 
šo
, 
çke_mode
);

437 ià(
”r
)

438 
punch_d’Œy_·ges
;

440 
b™_pos
 +ğ
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
de
->
Çme_Ën
));

443 
punch_d’Œy_·ges
:

444 
	`Œunÿ‹_šode_·ges
(&
dœ
->
i_d©a
, 0);

445 
	`f2fs_Œunÿ‹_blocks
(
dœ
, 0, 
çl£
);

446 
	`f2fs_»move_dœty_šode
(
dœ
);

447  
”r
;

448 
	}
}

450 
	$f2fs_move_»hashed_dœ’ts
(
šode
 *
dœ
, 
·ge
 *
age
,

451 *
šlše_d’Œy
)

453 *
backup_d’Œy
;

454 
”r
;

456 
backup_d’Œy
 = 
	`f2fs_km®loc
(
	`F2FS_I_SB
(
dœ
),

457 
	`MAX_INLINE_DATA
(
dœ
), 
GFP_F2FS_ZERO
);

458 ià(!
backup_d’Œy
) {

459 
	`f2fs_put_·ge
(
age
, 1);

460  -
ENOMEM
;

463 
	`memıy
(
backup_d’Œy
, 
šlše_d’Œy
, 
	`MAX_INLINE_DATA
(
dœ
));

464 
	`f2fs_Œunÿ‹_šlše_šode
(
dœ
, 
age
, 0);

466 
	`uÆock_·ge
(
age
);

468 
”r
 = 
	`f2fs_add_šlše_’Œ›s
(
dœ
, 
backup_d’Œy
);

469 ià(
”r
)

470 
»cov”
;

472 
	`lock_·ge
(
age
);

474 
	`¡©_dec_šlše_dœ
(
dœ
);

475 
	`ş—r_šode_æag
(
dœ
, 
FI_INLINE_DENTRY
);

476 
	`kä“
(
backup_d’Œy
);

478 
»cov”
:

479 
	`lock_·ge
(
age
);

480 
	`memıy
(
šlše_d’Œy
, 
backup_d’Œy
, 
	`MAX_INLINE_DATA
(
dœ
));

481 
	`f2fs_i_d•th_wr™e
(
dœ
, 0);

482 
	`f2fs_i_size_wr™e
(
dœ
, 
	`MAX_INLINE_DATA
(dir));

483 
	`£t_·ge_dœty
(
age
);

484 
	`f2fs_put_·ge
(
age
, 1);

486 
	`kä“
(
backup_d’Œy
);

487  
”r
;

488 
	}
}

490 
	$f2fs_cÚv”t_šlše_dœ
(
šode
 *
dœ
, 
·ge
 *
age
,

491 *
šlše_d’Œy
)

493 ià(!
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
)

494  
	`f2fs_move_šlše_dœ’ts
(
dœ
, 
age
, 
šlše_d’Œy
);

496  
	`f2fs_move_»hashed_dœ’ts
(
dœ
, 
age
, 
šlše_d’Œy
);

497 
	}
}

499 
	$f2fs_add_šlše_’Œy
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Ãw_Çme
,

500 cÚ¡ 
q¡r
 *
Üig_Çme
,

501 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
)

503 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

504 
·ge
 *
age
;

505 
b™_pos
;

506 
f2fs_hash_t
 
Çme_hash
;

507 *
šlše_d’Œy
 = 
NULL
;

508 
f2fs_d’Œy_±r
 
d
;

509 
¦Ùs
 = 
	`GET_DENTRY_SLOTS
(
Ãw_Çme
->
Ën
);

510 
·ge
 *·gğ
NULL
;

511 
”r
 = 0;

513 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
dœ
->
i_šo
);

514 ià(
	`IS_ERR
(
age
))

515  
	`PTR_ERR
(
age
);

517 
šlše_d’Œy
 = 
	`šlše_d©a_addr
(
dœ
, 
age
);

518 
	`make_d’Œy_±r_šlše
(
dœ
, &
d
, 
šlše_d’Œy
);

520 
b™_pos
 = 
	`f2fs_room_fÜ_f’ame
(
d
.
b™m­
, 
¦Ùs
, d.
max
);

521 ià(
b™_pos
 >ğ
d
.
max
) {

522 
”r
 = 
	`f2fs_cÚv”t_šlše_dœ
(
dœ
, 
age
, 
šlše_d’Œy
);

523 ià(
”r
)

524  
”r
;

525 
”r
 = -
EAGAIN
;

526 
out
;

529 ià(
šode
) {

530 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

531 
·ge
 = 
	`f2fs_š™_šode_m‘ad©a
(
šode
, 
dœ
, 
Ãw_Çme
,

532 
Üig_Çme
, 
age
);

533 ià(
	`IS_ERR
(
·ge
)) {

534 
”r
 = 
	`PTR_ERR
(
·ge
);

535 
ç
;

539 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
);

541 
Çme_hash
 = 
	`f2fs_d’Œy_hash
(
Ãw_Çme
, 
NULL
);

542 
	`f2fs_upd©e_d’Œy
(
šo
, 
mode
, &
d
, 
Ãw_Çme
, 
Çme_hash
, 
b™_pos
);

544 
	`£t_·ge_dœty
(
age
);

547 ià(
šode
) {

548 
	`f2fs_i_pšo_wr™e
(
šode
, 
dœ
->
i_šo
);

549 
	`f2fs_put_·ge
(
·ge
, 1);

552 
	`f2fs_upd©e_·»Á_m‘ad©a
(
dœ
, 
šode
, 0);

553 
ç
:

554 ià(
šode
)

555 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

556 
out
:

557 
	`f2fs_put_·ge
(
age
, 1);

558  
”r
;

559 
	}
}

561 
	$f2fs_d–‘e_šlše_’Œy
(
f2fs_dœ_’Œy
 *
d’Œy
, 
·ge
 *page,

562 
šode
 *
dœ
, inode *inode)

564 
f2fs_d’Œy_±r
 
d
;

565 *
šlše_d’Œy
;

566 
¦Ùs
 = 
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
d’Œy
->
Çme_Ën
));

567 
b™_pos
;

568 
i
;

570 
	`lock_·ge
(
·ge
);

571 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
, 
Œue
);

573 
šlše_d’Œy
 = 
	`šlše_d©a_addr
(
dœ
, 
·ge
);

574 
	`make_d’Œy_±r_šlše
(
dœ
, &
d
, 
šlše_d’Œy
);

576 
b™_pos
 = 
d’Œy
 - 
d
.dentry;

577 
i
 = 0; i < 
¦Ùs
; i++)

578 
	`__ş—r_b™_Ë
(
b™_pos
 + 
i
, 
d
.
b™m­
);

580 
	`£t_·ge_dœty
(
·ge
);

581 
	`f2fs_put_·ge
(
·ge
, 1);

583 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
	`cu¼’t_time
(dir);

584 
	`f2fs_m¬k_šode_dœty_sync
(
dœ
, 
çl£
);

586 ià(
šode
)

587 
	`f2fs_drİ_Æšk
(
dœ
, 
šode
);

588 
	}
}

590 
boŞ
 
	$f2fs_em±y_šlše_dœ
(
šode
 *
dœ
)

592 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

593 
·ge
 *
age
;

594 
b™_pos
 = 2;

595 *
šlše_d’Œy
;

596 
f2fs_d’Œy_±r
 
d
;

598 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
dœ
->
i_šo
);

599 ià(
	`IS_ERR
(
age
))

600  
çl£
;

602 
šlše_d’Œy
 = 
	`šlše_d©a_addr
(
dœ
, 
age
);

603 
	`make_d’Œy_±r_šlše
(
dœ
, &
d
, 
šlše_d’Œy
);

605 
b™_pos
 = 
	`fšd_Ãxt_b™_Ë
(
d
.
b™m­
, d.
max
, bit_pos);

607 
	`f2fs_put_·ge
(
age
, 1);

609 ià(
b™_pos
 < 
d
.
max
)

610  
çl£
;

612  
Œue
;

613 
	}
}

615 
	$f2fs_»ad_šlše_dœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
,

616 
fsüy±_¡r
 *
f¡r
)

618 
šode
 *šodğ
	`fe_šode
(
fe
);

619 
·ge
 *
age
 = 
NULL
;

620 
f2fs_d’Œy_±r
 
d
;

621 *
šlše_d’Œy
 = 
NULL
;

622 
”r
;

624 
	`make_d’Œy_±r_šlše
(
šode
, &
d
, 
šlše_d’Œy
);

626 ià(
ùx
->
pos
 =ğ
d
.
max
)

629 
age
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
);

630 ià(
	`IS_ERR
(
age
))

631  
	`PTR_ERR
(
age
);

633 
šlše_d’Œy
 = 
	`šlše_d©a_addr
(
šode
, 
age
);

635 
	`make_d’Œy_±r_šlše
(
šode
, &
d
, 
šlše_d’Œy
);

637 
”r
 = 
	`f2fs_fl_d’Œ›s
(
ùx
, &
d
, 0, 
f¡r
);

638 ià(!
”r
)

639 
ùx
->
pos
 = 
d
.
max
;

641 
	`f2fs_put_·ge
(
age
, 1);

642  
”r
 < 0 ?ƒrr : 0;

643 
	}
}

645 
	$f2fs_šlše_d©a_f›m­
(
šode
 *inode,

646 
f›m­_ex‹Á_šfo
 *
f›šfo
, 
__u64
 
¡¬t
, __u64 
Ën
)

648 
__u64
 
by‹addr
, 
’
;

649 
__u32
 
æags
 = 
FIEMAP_EXTENT_DATA_INLINE
 | 
FIEMAP_EXTENT_NOT_ALIGNED
 |

650 
FIEMAP_EXTENT_LAST
;

651 
node_šfo
 
ni
;

652 
·ge
 *
age
;

653 
”r
 = 0;

655 
age
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
);

656 ià(
	`IS_ERR
(
age
))

657  
	`PTR_ERR
(
age
);

659 ià(!
	`f2fs_has_šlše_d©a
(
šode
)) {

660 
”r
 = -
EAGAIN
;

661 
out
;

664 
’
 = 
	`mš_t
(
size_t
, 
	`MAX_INLINE_DATA
(
šode
), 
	`i_size_»ad
(inode));

665 ià(
¡¬t
 >ğ
’
)

666 
out
;

667 ià(
¡¬t
 + 
Ën
 < 
’
)

668 
’
 = 
¡¬t
 + 
Ën
;

669 
’
 -ğ
¡¬t
;

671 
	`f2fs_g‘_node_šfo
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
, &
ni
);

672 
by‹addr
 = (
__u64
)
ni
.
blk_addr
 << 
šode
->
i_sb
->
s_blocksize_b™s
;

673 
by‹addr
 +ğ(*)
	`šlše_d©a_addr
(
šode
, 
age
) -

674 (*)
	`F2FS_INODE
(
age
);

675 
”r
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 
¡¬t
, 
by‹addr
, 
’
, 
æags
);

676 
out
:

677 
	`f2fs_put_·ge
(
age
, 1);

678  
”r
;

679 
	}
}

	@fs/f2fs/inode.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/bufãr_h—d.h
>

14 
	~<lšux/backšg-dev.h
>

15 
	~<lšux/wr™eback.h
>

17 
	~"f2fs.h
"

18 
	~"node.h
"

19 
	~"£gm’t.h
"

21 
	~<Œaû/ev’ts/f2fs.h
>

23 
	$f2fs_m¬k_šode_dœty_sync
(
šode
 *šode, 
boŞ
 
sync
)

25 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NEW_INODE
))

28 ià(
	`f2fs_šode_dœt›d
(
šode
, 
sync
))

31 
	`m¬k_šode_dœty_sync
(
šode
);

32 
	}
}

34 
	$f2fs_£t_šode_æags
(
šode
 *inode)

36 
æags
 = 
	`F2FS_I
(
šode
)->
i_æags
;

37 
Ãw_æ
 = 0;

39 ià(
æags
 & 
F2FS_SYNC_FL
)

40 
Ãw_æ
 |ğ
S_SYNC
;

41 ià(
æags
 & 
F2FS_APPEND_FL
)

42 
Ãw_æ
 |ğ
S_APPEND
;

43 ià(
æags
 & 
F2FS_IMMUTABLE_FL
)

44 
Ãw_æ
 |ğ
S_IMMUTABLE
;

45 ià(
æags
 & 
F2FS_NOATIME_FL
)

46 
Ãw_æ
 |ğ
S_NOATIME
;

47 ià(
æags
 & 
F2FS_DIRSYNC_FL
)

48 
Ãw_æ
 |ğ
S_DIRSYNC
;

49 ià(
	`f2fs_’üy±ed_šode
(
šode
))

50 
Ãw_æ
 |ğ
S_ENCRYPTED
;

51 
	`šode_£t_æags
(
šode
, 
Ãw_æ
,

52 
S_SYNC
|
S_APPEND
|
S_IMMUTABLE
|
S_NOATIME
|
S_DIRSYNC
|

53 
S_ENCRYPTED
);

54 
	}
}

56 
	$__g‘_šode_rdev
(
šode
 *šode, 
f2fs_šode
 *
ri
)

58 
exŒa_size
 = 
	`g‘_exŒa_isize
(
šode
);

60 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode) ||

61 
	`S_ISFIFO
(
šode
->
i_mode
è|| 
	`S_ISSOCK
(inode->i_mode)) {

62 ià(
ri
->
i_addr
[
exŒa_size
])

63 
šode
->
i_rdev
 = 
	`Şd_decode_dev
(

64 
	`Ë32_to_ıu
(
ri
->
i_addr
[
exŒa_size
]));

66 
šode
->
i_rdev
 = 
	`Ãw_decode_dev
(

67 
	`Ë32_to_ıu
(
ri
->
i_addr
[
exŒa_size
 + 1]));

69 
	}
}

71 
boŞ
 
	$__wr™‹n_fœ¡_block
(
f2fs_šode
 *
ri
)

73 
block_t
 
addr
 = 
	`Ë32_to_ıu
(
ri
->
i_addr
[
	`off£t_š_addr
(ri)]);

75 ià(
	`is_v®id_blkaddr
(
addr
))

76  
Œue
;

77  
çl£
;

78 
	}
}

80 
	$__£t_šode_rdev
(
šode
 *šode, 
f2fs_šode
 *
ri
)

82 
exŒa_size
 = 
	`g‘_exŒa_isize
(
šode
);

84 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode)) {

85 ià(
	`Şd_v®id_dev
(
šode
->
i_rdev
)) {

86 
ri
->
i_addr
[
exŒa_size
] =

87 
	`ıu_to_Ë32
(
	`Şd_’code_dev
(
šode
->
i_rdev
));

88 
ri
->
i_addr
[
exŒa_size
 + 1] = 0;

90 
ri
->
i_addr
[
exŒa_size
] = 0;

91 
ri
->
i_addr
[
exŒa_size
 + 1] =

92 
	`ıu_to_Ë32
(
	`Ãw_’code_dev
(
šode
->
i_rdev
));

93 
ri
->
i_addr
[
exŒa_size
 + 2] = 0;

96 
	}
}

98 
	$__»cov”_šlše_¡©us
(
šode
 *šode, 
·ge
 *
age
)

100 *
šlše_d©a
 = 
	`šlše_d©a_addr
(
šode
, 
age
);

101 
__Ë32
 *
¡¬t
 = 
šlše_d©a
;

102 
__Ë32
 *
’d
 = 
¡¬t
 + 
	`MAX_INLINE_DATA
(
šode
) / (__le32);

104 
¡¬t
 < 
’d
) {

105 ià(*
¡¬t
++) {

106 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
);

108 
	`£t_šode_æag
(
šode
, 
FI_DATA_EXIST
);

109 
	`£t_¿w_šlše
(
šode
, 
	`F2FS_INODE
(
age
));

110 
	`£t_·ge_dœty
(
age
);

115 
	}
}

117 
boŞ
 
	$f2fs_’abË_šode_chksum
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

119 
f2fs_šode
 *
ri
 = &
	`F2FS_NODE
(
·ge
)->
i
;

121 ià(!
	`f2fs_sb_has_šode_chksum
(
sbi
->
sb
))

122  
çl£
;

124 ià(!
	`RAW_IS_INODE
(
	`F2FS_NODE
(
·ge
)è|| !(
ri
->
i_šlše
 & 
F2FS_EXTRA_ATTR
))

125  
çl£
;

127 ià(!
	`F2FS_FITS_IN_INODE
(
ri
, 
	`Ë16_to_ıu
Ôi->
i_exŒa_isize
),

128 
i_šode_checksum
))

129  
çl£
;

131  
Œue
;

132 
	}
}

134 
__u32
 
	$f2fs_šode_chksum
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

136 
f2fs_node
 *
node
 = 
	`F2FS_NODE
(
·ge
);

137 
f2fs_šode
 *
ri
 = &
node
->
i
;

138 
__Ë32
 
šo
 = 
node
->
foÙ”
.ino;

139 
__Ë32
 
g’
 = 
ri
->
i_g’”©iÚ
;

140 
__u32
 
chksum
, 
chksum_£ed
;

141 
__u32
 
dummy_cs
 = 0;

142 
off£t
 = 
	`off£tof
(
f2fs_šode
, 
i_šode_checksum
);

143 
cs_size
 = (
dummy_cs
);

145 
chksum
 = 
	`f2fs_chksum
(
sbi
, sbi->
s_chksum_£ed
, (
__u8
 *)&
šo
,

146 (
šo
));

147 
chksum_£ed
 = 
	`f2fs_chksum
(
sbi
, 
chksum
, (
__u8
 *)&
g’
, (gen));

149 
chksum
 = 
	`f2fs_chksum
(
sbi
, 
chksum_£ed
, (
__u8
 *)
ri
, 
off£t
);

150 
chksum
 = 
	`f2fs_chksum
(
sbi
, chksum, (
__u8
 *)&
dummy_cs
, 
cs_size
);

151 
off£t
 +ğ
cs_size
;

152 
chksum
 = 
	`f2fs_chksum
(
sbi
, chksum, (
__u8
 *)
ri
 + 
off£t
,

153 
F2FS_BLKSIZE
 - 
off£t
);

154  
chksum
;

155 
	}
}

157 
boŞ
 
	$f2fs_šode_chksum_v”ify
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

159 
f2fs_šode
 *
ri
;

160 
__u32
 
´ovided
, 
ÿlcuÏ‹d
;

162 ià(!
	`f2fs_’abË_šode_chksum
(
sbi
, 
·ge
) ||

163 
	`PageDœty
(
·ge
è|| 
	`PageWr™eback
(page))

164  
Œue
;

166 
ri
 = &
	`F2FS_NODE
(
·ge
)->
i
;

167 
´ovided
 = 
	`Ë32_to_ıu
(
ri
->
i_šode_checksum
);

168 
ÿlcuÏ‹d
 = 
	`f2fs_šode_chksum
(
sbi
, 
·ge
);

170 ià(
´ovided
 !ğ
ÿlcuÏ‹d
)

171 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

173 
	`šo_of_node
(
·ge
), 
´ovided
, 
ÿlcuÏ‹d
);

175  
´ovided
 =ğ
ÿlcuÏ‹d
;

176 
	}
}

178 
	$f2fs_šode_chksum_£t
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

180 
f2fs_šode
 *
ri
 = &
	`F2FS_NODE
(
·ge
)->
i
;

182 ià(!
	`f2fs_’abË_šode_chksum
(
sbi
, 
·ge
))

185 
ri
->
i_šode_checksum
 = 
	`ıu_to_Ë32
(
	`f2fs_šode_chksum
(
sbi
, 
·ge
));

186 
	}
}

188 
boŞ
 
	$§n™y_check_šode
(
šode
 *inode)

190 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

192 ià(
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sbi
->
sb
)

193 && !
	`f2fs_has_exŒa_©Œ
(
šode
)) {

194 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

195 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

197 
__func__
, 
šode
->
i_šo
);

198  
çl£
;

200  
Œue
;

201 
	}
}

203 
	$do_»ad_šode
(
šode
 *inode)

205 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

206 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

207 
·ge
 *
node_·ge
;

208 
f2fs_šode
 *
ri
;

209 
´ojid_t
 
i_´ojid
;

212 ià(
	`f2fs_check_nid_¿nge
(
sbi
, 
šode
->
i_šo
))

213  -
EINVAL
;

215 
node_·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

216 ià(
	`IS_ERR
(
node_·ge
))

217  
	`PTR_ERR
(
node_·ge
);

219 
ri
 = 
	`F2FS_INODE
(
node_·ge
);

221 
šode
->
i_mode
 = 
	`Ë16_to_ıu
(
ri
->i_mode);

222 
	`i_uid_wr™e
(
šode
, 
	`Ë32_to_ıu
(
ri
->
i_uid
));

223 
	`i_gid_wr™e
(
šode
, 
	`Ë32_to_ıu
(
ri
->
i_gid
));

224 
	`£t_Æšk
(
šode
, 
	`Ë32_to_ıu
(
ri
->
i_lšks
));

225 
šode
->
i_size
 = 
	`Ë64_to_ıu
(
ri
->i_size);

226 
šode
->
i_blocks
 = 
	`SECTOR_FROM_BLOCK
(
	`Ë64_to_ıu
(
ri
->i_blocks) - 1);

228 
šode
->
i_©ime
.
tv_£c
 = 
	`Ë64_to_ıu
(
ri
->i_atime);

229 
šode
->
i_ùime
.
tv_£c
 = 
	`Ë64_to_ıu
(
ri
->i_ctime);

230 
šode
->
i_mtime
.
tv_£c
 = 
	`Ë64_to_ıu
(
ri
->i_mtime);

231 
šode
->
i_©ime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
ri
->
i_©ime_n£c
);

232 
šode
->
i_ùime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
ri
->
i_ùime_n£c
);

233 
šode
->
i_mtime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
ri
->
i_mtime_n£c
);

234 
šode
->
i_g’”©iÚ
 = 
	`Ë32_to_ıu
(
ri
->i_generation);

235 ià(
	`S_ISDIR
(
šode
->
i_mode
))

236 
fi
->
i_cu¼’t_d•th
 = 
	`Ë32_to_ıu
(
ri
->i_current_depth);

237 ià(
	`S_ISREG
(
šode
->
i_mode
))

238 
fi
->
i_gc_çu»s
[
GC_FAILURE_PIN
] =

239 
	`Ë16_to_ıu
(
ri
->
i_gc_çu»s
);

240 
fi
->
i_x©Œ_nid
 = 
	`Ë32_to_ıu
(
ri
->i_xattr_nid);

241 
fi
->
i_æags
 = 
	`Ë32_to_ıu
(
ri
->i_flags);

242 
fi
->
æags
 = 0;

243 
fi
->
i_advi£
 = 
ri
->i_advise;

244 
fi
->
i_pšo
 = 
	`Ë32_to_ıu
(
ri
->i_pino);

245 
fi
->
i_dœ_Ëv–
 = 
ri
->i_dir_level;

247 ià(
	`f2fs_š™_ex‹Á_Œ“
(
šode
, &
ri
->
i_ext
))

248 
	`£t_·ge_dœty
(
node_·ge
);

250 
	`g‘_šlše_šfo
(
šode
, 
ri
);

252 
fi
->
i_exŒa_isize
 = 
	`f2fs_has_exŒa_©Œ
(
šode
) ?

253 
	`Ë16_to_ıu
(
ri
->
i_exŒa_isize
) : 0;

255 ià(
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sbi
->
sb
)) {

256 
fi
->
i_šlše_x©Œ_size
 = 
	`Ë16_to_ıu
(
ri
->i_inline_xattr_size);

257 } ià(
	`f2fs_has_šlše_x©Œ
(
šode
) ||

258 
	`f2fs_has_šlše_d’Œy
(
šode
)) {

259 
fi
->
i_šlše_x©Œ_size
 = 
DEFAULT_INLINE_XATTR_ADDRS
;

268 
fi
->
i_šlše_x©Œ_size
 = 0;

272 ià(
	`f2fs_has_šlše_d©a
(
šode
è&& !
	`f2fs_exi¡_d©a
(inode))

273 
	`__»cov”_šlše_¡©us
(
šode
, 
node_·ge
);

276 
	`__g‘_šode_rdev
(
šode
, 
ri
);

278 ià(
	`__wr™‹n_fœ¡_block
(
ri
))

279 
	`£t_šode_æag
(
šode
, 
FI_FIRST_BLOCK_WRITTEN
);

281 ià(!
	`f2fs_Ãed_šode_block_upd©e
(
sbi
, 
šode
->
i_šo
))

282 
fi
->
Ï¡_disk_size
 = 
šode
->
i_size
;

284 ià(
fi
->
i_æags
 & 
F2FS_PROJINHERIT_FL
)

285 
	`£t_šode_æag
(
šode
, 
FI_PROJ_INHERIT
);

287 ià(
	`f2fs_has_exŒa_©Œ
(
šode
è&& 
	`f2fs_sb_has_´ojeù_quÙa
(
sbi
->
sb
) &&

288 
	`F2FS_FITS_IN_INODE
(
ri
, 
fi
->
i_exŒa_isize
, 
i_´ojid
))

289 
i_´ojid
 = (
´ojid_t
)
	`Ë32_to_ıu
(
ri
->i_projid);

291 
i_´ojid
 = 
F2FS_DEF_PROJID
;

292 
fi
->
i_´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
, i_projid);

294 ià(
	`f2fs_has_exŒa_©Œ
(
šode
è&& 
	`f2fs_sb_has_šode_ütime
(
sbi
->
sb
) &&

295 
	`F2FS_FITS_IN_INODE
(
ri
, 
fi
->
i_exŒa_isize
, 
i_ütime
)) {

296 
fi
->
i_ütime
.
tv_£c
 = 
	`Ë64_to_ıu
(
ri
->i_crtime);

297 
fi
->
i_ütime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
ri
->
i_ütime_n£c
);

300 
	`F2FS_I
(
šode
)->
i_disk_time
[0] = 
	`time¥ec64_to_time¥ec
(šode->
i_©ime
);

301 
	`F2FS_I
(
šode
)->
i_disk_time
[1] = 
	`time¥ec64_to_time¥ec
(šode->
i_ùime
);

302 
	`F2FS_I
(
šode
)->
i_disk_time
[2] = 
	`time¥ec64_to_time¥ec
(šode->
i_mtime
);

303 
	`F2FS_I
(
šode
)->
i_disk_time
[3] = F2FS_I(šode)->
i_ütime
;

304 
	`f2fs_put_·ge
(
node_·ge
, 1);

306 
	`¡©_šc_šlše_x©Œ
(
šode
);

307 
	`¡©_šc_šlše_šode
(
šode
);

308 
	`¡©_šc_šlše_dœ
(
šode
);

311 
	}
}

313 
šode
 *
	$f2fs_ig‘
(
su³r_block
 *
sb
, 
šo
)

315 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

316 
šode
 *inode;

317 
»t
 = 0;

319 
šode
 = 
	`ig‘_locked
(
sb
, 
šo
);

320 ià(!
šode
)

321  
	`ERR_PTR
(-
ENOMEM
);

323 ià(!(
šode
->
i_¡©e
 & 
I_NEW
)) {

324 
	`Œaû_f2fs_ig‘
(
šode
);

325  
šode
;

327 ià(
šo
 =ğ
	`F2FS_NODE_INO
(
sbi
è|| inØ=ğ
	`F2FS_META_INO
(sbi))

328 
make_now
;

330 
»t
 = 
	`do_»ad_šode
(
šode
);

331 ià(
»t
)

332 
bad_šode
;

333 ià(!
	`§n™y_check_šode
(
šode
)) {

334 
»t
 = -
EINVAL
;

335 
bad_šode
;

337 
make_now
:

338 ià(
šo
 =ğ
	`F2FS_NODE_INO
(
sbi
)) {

339 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_node_aİs
;

340 
	`m­pšg_£t_gå_mask
(
šode
->
i_m­pšg
, 
GFP_NOFS
);

341 } ià(
šo
 =ğ
	`F2FS_META_INO
(
sbi
)) {

342 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_m‘a_aİs
;

343 
	`m­pšg_£t_gå_mask
(
šode
->
i_m­pšg
, 
GFP_NOFS
);

344 } ià(
	`S_ISREG
(
šode
->
i_mode
)) {

345 
šode
->
i_İ
 = &
f2fs_fe_šode_İ”©iÚs
;

346 
šode
->
i_fİ
 = &
f2fs_fe_İ”©iÚs
;

347 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

348 } ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

349 
šode
->
i_İ
 = &
f2fs_dœ_šode_İ”©iÚs
;

350 
šode
->
i_fİ
 = &
f2fs_dœ_İ”©iÚs
;

351 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

352 
	`šode_nohighmem
(
šode
);

353 } ià(
	`S_ISLNK
(
šode
->
i_mode
)) {

354 ià(
	`f2fs_’üy±ed_šode
(
šode
))

355 
šode
->
i_İ
 = &
f2fs_’üy±ed_symlšk_šode_İ”©iÚs
;

357 
šode
->
i_İ
 = &
f2fs_symlšk_šode_İ”©iÚs
;

358 
	`šode_nohighmem
(
šode
);

359 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

360 } ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode) ||

361 
	`S_ISFIFO
(
šode
->
i_mode
è|| 
	`S_ISSOCK
(inode->i_mode)) {

362 
šode
->
i_İ
 = &
f2fs_¥ecŸl_šode_İ”©iÚs
;

363 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, inode->
i_rdev
);

365 
»t
 = -
EIO
;

366 
bad_šode
;

368 
	`f2fs_£t_šode_æags
(
šode
);

369 
	`uÆock_Ãw_šode
(
šode
);

370 
	`Œaû_f2fs_ig‘
(
šode
);

371  
šode
;

373 
bad_šode
:

374 
	`ig‘_çed
(
šode
);

375 
	`Œaû_f2fs_ig‘_ex™
(
šode
, 
»t
);

376  
	`ERR_PTR
(
»t
);

377 
	}
}

379 
šode
 *
	$f2fs_ig‘_»Œy
(
su³r_block
 *
sb
, 
šo
)

381 
šode
 *inode;

382 
»Œy
:

383 
šode
 = 
	`f2fs_ig‘
(
sb
, 
šo
);

384 ià(
	`IS_ERR
(
šode
)) {

385 ià(
	`PTR_ERR
(
šode
è=ğ-
ENOMEM
) {

386 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

387 
»Œy
;

390  
šode
;

391 
	}
}

393 
	$f2fs_upd©e_šode
(
šode
 *šode, 
·ge
 *
node_·ge
)

395 
f2fs_šode
 *
ri
;

396 
ex‹Á_Œ“
 *
‘
 = 
	`F2FS_I
(
šode
)->extent_tree;

398 
	`f2fs_wa™_Ú_·ge_wr™eback
(
node_·ge
, 
NODE
, 
Œue
);

399 
	`£t_·ge_dœty
(
node_·ge
);

401 
	`f2fs_šode_synûd
(
šode
);

403 
ri
 = 
	`F2FS_INODE
(
node_·ge
);

405 
ri
->
i_mode
 = 
	`ıu_to_Ë16
(
šode
->i_mode);

406 
ri
->
i_advi£
 = 
	`F2FS_I
(
šode
)->i_advise;

407 
ri
->
i_uid
 = 
	`ıu_to_Ë32
(
	`i_uid_»ad
(
šode
));

408 
ri
->
i_gid
 = 
	`ıu_to_Ë32
(
	`i_gid_»ad
(
šode
));

409 
ri
->
i_lšks
 = 
	`ıu_to_Ë32
(
šode
->
i_Æšk
);

410 
ri
->
i_size
 = 
	`ıu_to_Ë64
(
	`i_size_»ad
(
šode
));

411 
ri
->
i_blocks
 = 
	`ıu_to_Ë64
(
	`SECTOR_TO_BLOCK
(
šode
->i_blocks) + 1);

413 ià(
‘
) {

414 
	`»ad_lock
(&
‘
->
lock
);

415 
	`£t_¿w_ex‹Á
(&
‘
->
Ïrge¡
, &
ri
->
i_ext
);

416 
	`»ad_uÆock
(&
‘
->
lock
);

418 
	`mem£t
(&
ri
->
i_ext
, 0, (ri->i_ext));

420 
	`£t_¿w_šlše
(
šode
, 
ri
);

422 
ri
->
i_©ime
 = 
	`ıu_to_Ë64
(
šode
->i_©ime.
tv_£c
);

423 
ri
->
i_ùime
 = 
	`ıu_to_Ë64
(
šode
->i_ùime.
tv_£c
);

424 
ri
->
i_mtime
 = 
	`ıu_to_Ë64
(
šode
->i_mtime.
tv_£c
);

425 
ri
->
i_©ime_n£c
 = 
	`ıu_to_Ë32
(
šode
->
i_©ime
.
tv_n£c
);

426 
ri
->
i_ùime_n£c
 = 
	`ıu_to_Ë32
(
šode
->
i_ùime
.
tv_n£c
);

427 
ri
->
i_mtime_n£c
 = 
	`ıu_to_Ë32
(
šode
->
i_mtime
.
tv_n£c
);

428 ià(
	`S_ISDIR
(
šode
->
i_mode
))

429 
ri
->
i_cu¼’t_d•th
 =

430 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->
i_cu¼’t_d•th
);

431 ià(
	`S_ISREG
(
šode
->
i_mode
))

432 
ri
->
i_gc_çu»s
 =

433 
	`ıu_to_Ë16
(
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_PIN
]);

434 
ri
->
i_x©Œ_nid
 = 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->i_xattr_nid);

435 
ri
->
i_æags
 = 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->i_flags);

436 
ri
->
i_pšo
 = 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->i_pino);

437 
ri
->
i_g’”©iÚ
 = 
	`ıu_to_Ë32
(
šode
->i_generation);

438 
ri
->
i_dœ_Ëv–
 = 
	`F2FS_I
(
šode
)->i_dir_level;

440 ià(
	`f2fs_has_exŒa_©Œ
(
šode
)) {

441 
ri
->
i_exŒa_isize
 = 
	`ıu_to_Ë16
(
	`F2FS_I
(
šode
)->i_extra_isize);

443 ià(
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
	`F2FS_I_SB
(
šode
)->
sb
))

444 
ri
->
i_šlše_x©Œ_size
 =

445 
	`ıu_to_Ë16
(
	`F2FS_I
(
šode
)->
i_šlše_x©Œ_size
);

447 ià(
	`f2fs_sb_has_´ojeù_quÙa
(
	`F2FS_I_SB
(
šode
)->
sb
) &&

448 
	`F2FS_FITS_IN_INODE
(
ri
, 
	`F2FS_I
(
šode
)->
i_exŒa_isize
,

449 
i_´ojid
)) {

450 
´ojid_t
 
i_´ojid
;

452 
i_´ojid
 = 
	`äom_k´ojid
(&
š™_u£r_ns
,

453 
	`F2FS_I
(
šode
)->
i_´ojid
);

454 
ri
->
i_´ojid
 = 
	`ıu_to_Ë32
(i_projid);

457 ià(
	`f2fs_sb_has_šode_ütime
(
	`F2FS_I_SB
(
šode
)->
sb
) &&

458 
	`F2FS_FITS_IN_INODE
(
ri
, 
	`F2FS_I
(
šode
)->
i_exŒa_isize
,

459 
i_ütime
)) {

460 
ri
->
i_ütime
 =

461 
	`ıu_to_Ë64
(
	`F2FS_I
(
šode
)->
i_ütime
.
tv_£c
);

462 
ri
->
i_ütime_n£c
 =

463 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->
i_ütime
.
tv_n£c
);

467 
	`__£t_šode_rdev
(
šode
, 
ri
);

470 ià(
šode
->
i_Æšk
 == 0)

471 
	`ş—r_šlše_node
(
node_·ge
);

473 
	`F2FS_I
(
šode
)->
i_disk_time
[0] = 
	`time¥ec64_to_time¥ec
(šode->
i_©ime
);

474 
	`F2FS_I
(
šode
)->
i_disk_time
[1] = 
	`time¥ec64_to_time¥ec
(šode->
i_ùime
);

475 
	`F2FS_I
(
šode
)->
i_disk_time
[2] = 
	`time¥ec64_to_time¥ec
(šode->
i_mtime
);

476 
	`F2FS_I
(
šode
)->
i_disk_time
[3] = F2FS_I(šode)->
i_ütime
;

477 
	}
}

479 
	$f2fs_upd©e_šode_·ge
(
šode
 *inode)

481 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

482 
·ge
 *
node_·ge
;

483 
»Œy
:

484 
node_·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

485 ià(
	`IS_ERR
(
node_·ge
)) {

486 
”r
 = 
	`PTR_ERR
(
node_·ge
);

487 ià(
”r
 =ğ-
ENOMEM
) {

488 
	`cÚd_»sched
();

489 
»Œy
;

490 } ià(
”r
 !ğ-
ENOENT
) {

491 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

495 
	`f2fs_upd©e_šode
(
šode
, 
node_·ge
);

496 
	`f2fs_put_·ge
(
node_·ge
, 1);

497 
	}
}

499 
	$f2fs_wr™e_šode
(
šode
 *šode, 
wr™eback_cÚŒŞ
 *
wbc
)

501 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

503 ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
) ||

504 
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
))

507 ià(!
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
))

514 
	`f2fs_upd©e_šode_·ge
(
šode
);

515 ià(
wbc
 && wbc->
Ä_to_wr™e
)

516 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

518 
	}
}

523 
	$f2fs_eviù_šode
(
šode
 *inode)

525 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

526 
nid_t
 
xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

527 
”r
 = 0;

530 ià(
	`f2fs_is_©omic_fe
(
šode
))

531 
	`f2fs_drİ_šmem_·ges
(
šode
);

533 
	`Œaû_f2fs_eviù_šode
(
šode
);

534 
	`Œunÿ‹_šode_·ges_fš®
(&
šode
->
i_d©a
);

536 ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
) ||

537 
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
))

538 
out_ş—r
;

540 
	`f2fs_bug_Ú
(
sbi
, 
	`g‘_dœty_·ges
(
šode
));

541 
	`f2fs_»move_dœty_šode
(
šode
);

543 
	`f2fs_de¡roy_ex‹Á_Œ“
(
šode
);

545 ià(
šode
->
i_Æšk
 || 
	`is_bad_šode
(inode))

546 
no_d–‘e
;

548 
	`dquÙ_š™Ÿlize
(
šode
);

550 
	`f2fs_»move_šo_’Œy
(
sbi
, 
šode
->
i_šo
, 
APPEND_INO
);

551 
	`f2fs_»move_šo_’Œy
(
sbi
, 
šode
->
i_šo
, 
UPDATE_INO
);

552 
	`f2fs_»move_šo_’Œy
(
sbi
, 
šode
->
i_šo
, 
FLUSH_INO
);

554 
	`sb_¡¬t_štwr™e
(
šode
->
i_sb
);

555 
	`£t_šode_æag
(
šode
, 
FI_NO_ALLOC
);

556 
	`i_size_wr™e
(
šode
, 0);

557 
»Œy
:

558 ià(
	`F2FS_HAS_BLOCKS
(
šode
))

559 
”r
 = 
	`f2fs_Œunÿ‹
(
šode
);

561 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


562 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_EVICT_INODE
)) {

563 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_EVICT_INODE
);

564 
”r
 = -
EIO
;

567 ià(!
”r
) {

568 
	`f2fs_lock_İ
(
sbi
);

569 
”r
 = 
	`f2fs_»move_šode_·ge
(
šode
);

570 
	`f2fs_uÆock_İ
(
sbi
);

571 ià(
”r
 =ğ-
ENOENT
)

572 
”r
 = 0;

576 ià(
”r
 =ğ-
ENOMEM
) {

577 
”r
 = 0;

578 
»Œy
;

581 ià(
”r
)

582 
	`f2fs_upd©e_šode_·ge
(
šode
);

583 
	`dquÙ_ä“_šode
(
šode
);

584 
	`sb_’d_štwr™e
(
šode
->
i_sb
);

585 
no_d–‘e
:

586 
	`dquÙ_drİ
(
šode
);

588 
	`¡©_dec_šlše_x©Œ
(
šode
);

589 
	`¡©_dec_šlše_dœ
(
šode
);

590 
	`¡©_dec_šlše_šode
(
šode
);

592 ià(
	`lik–y
(!
	`is_£t_ck±_æags
(
sbi
, 
CP_ERROR_FLAG
)))

593 
	`f2fs_bug_Ú
(
sbi
, 
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
));

595 
	`f2fs_šode_synûd
(
šode
);

598 ià(
šode
->
i_šo
)

599 
	`šv®id©e_m­pšg_·ges
(
	`NODE_MAPPING
(
sbi
), 
šode
->
i_šo
,

600 
šode
->
i_šo
);

601 ià(
xnid
)

602 
	`šv®id©e_m­pšg_·ges
(
	`NODE_MAPPING
(
sbi
), 
xnid
, xnid);

603 ià(
šode
->
i_Æšk
) {

604 ià(
	`is_šode_æag_£t
(
šode
, 
FI_APPEND_WRITE
))

605 
	`f2fs_add_šo_’Œy
(
sbi
, 
šode
->
i_šo
, 
APPEND_INO
);

606 ià(
	`is_šode_æag_£t
(
šode
, 
FI_UPDATE_WRITE
))

607 
	`f2fs_add_šo_’Œy
(
sbi
, 
šode
->
i_šo
, 
UPDATE_INO
);

609 ià(
	`is_šode_æag_£t
(
šode
, 
FI_FREE_NID
)) {

610 
	`f2fs_®loc_nid_çed
(
sbi
, 
šode
->
i_šo
);

611 
	`ş—r_šode_æag
(
šode
, 
FI_FREE_NID
);

619 
out_ş—r
:

620 
	`fsüy±_put_’üy±iÚ_šfo
(
šode
);

621 
	`ş—r_šode
(
šode
);

622 
	}
}

625 
	$f2fs_hªdË_çed_šode
(
šode
 *inode)

627 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

628 
node_šfo
 
ni
;

634 
	`ş—r_Æšk
(
šode
);

640 
	`f2fs_upd©e_šode_·ge
(
šode
);

641 
	`f2fs_šode_synûd
(
šode
);

644 
	`uÆock_Ãw_šode
(
šode
);

651 
	`f2fs_g‘_node_šfo
(
sbi
, 
šode
->
i_šo
, &
ni
);

653 ià(
ni
.
blk_addr
 !ğ
NULL_ADDR
) {

654 
”r
 = 
	`f2fs_acquœe_Üphª_šode
(
sbi
);

655 ià(
”r
) {

656 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

657 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

660 
	`f2fs_add_Üphª_šode
(
šode
);

662 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

664 
	`£t_šode_æag
(
šode
, 
FI_FREE_NID
);

667 
	`f2fs_uÆock_İ
(
sbi
);

670 
	`ut
(
šode
);

671 
	}
}

	@fs/f2fs/namei.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/·gem­.h
>

14 
	~<lšux/sched.h
>

15 
	~<lšux/ùy³.h
>

16 
	~<lšux/dÿche.h
>

17 
	~<lšux/Çmei.h
>

18 
	~<lšux/quÙaİs.h
>

20 
	~"f2fs.h
"

21 
	~"node.h
"

22 
	~"x©Œ.h
"

23 
	~"aş.h
"

24 
	~<Œaû/ev’ts/f2fs.h
>

26 
šode
 *
	$f2fs_Ãw_šode
(
šode
 *
dœ
, 
umode_t
 
mode
)

28 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

29 
nid_t
 
šo
;

30 
šode
 *inode;

31 
boŞ
 
nid_ä“
 = 
çl£
;

32 
x©Œ_size
 = 0;

33 
”r
;

35 
šode
 = 
	`Ãw_šode
(
dœ
->
i_sb
);

36 ià(!
šode
)

37  
	`ERR_PTR
(-
ENOMEM
);

39 
	`f2fs_lock_İ
(
sbi
);

40 ià(!
	`f2fs_®loc_nid
(
sbi
, &
šo
)) {

41 
	`f2fs_uÆock_İ
(
sbi
);

42 
”r
 = -
ENOSPC
;

43 
ç
;

45 
	`f2fs_uÆock_İ
(
sbi
);

47 
nid_ä“
 = 
Œue
;

49 
	`šode_š™_owÃr
(
šode
, 
dœ
, 
mode
);

51 
šode
->
i_šo
 = 
šo
;

52 
šode
->
i_blocks
 = 0;

53 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

54 
	`F2FS_I
(
šode
)->
i_ütime
 = 
	`time¥ec64_to_time¥ec
(šode->
i_mtime
);

55 
šode
->
i_g’”©iÚ
 = 
sbi
->
s_Ãxt_g’”©iÚ
++;

57 ià(
	`S_ISDIR
(
šode
->
i_mode
))

58 
	`F2FS_I
(
šode
)->
i_cu¼’t_d•th
 = 1;

60 
”r
 = 
	`š£¹_šode_locked
(
šode
);

61 ià(
”r
) {

62 
”r
 = -
EINVAL
;

63 
ç
;

66 ià(
	`f2fs_sb_has_´ojeù_quÙa
(
sbi
->
sb
) &&

67 (
	`F2FS_I
(
dœ
)->
i_æags
 & 
F2FS_PROJINHERIT_FL
))

68 
	`F2FS_I
(
šode
)->
i_´ojid
 = F2FS_I(
dœ
)->i_projid;

70 
	`F2FS_I
(
šode
)->
i_´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
,

71 
F2FS_DEF_PROJID
);

73 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

74 ià(
”r
)

75 
ç_drİ
;

77 
”r
 = 
	`dquÙ_®loc_šode
(
šode
);

78 ià(
”r
)

79 
ç_drİ
;

81 
	`£t_šode_æag
(
šode
, 
FI_NEW_INODE
);

84 ià((
	`f2fs_’üy±ed_šode
(
dœ
è|| 
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
)) &&

85 
	`f2fs_may_’üy±
(
šode
))

86 
	`f2fs_£t_’üy±ed_šode
(
šode
);

88 ià(
	`f2fs_sb_has_exŒa_©Œ
(
sbi
->
sb
)) {

89 
	`£t_šode_æag
(
šode
, 
FI_EXTRA_ATTR
);

90 
	`F2FS_I
(
šode
)->
i_exŒa_isize
 = 
F2FS_TOTAL_EXTRA_ATTR_SIZE
;

93 ià(
	`‹¡_İt
(
sbi
, 
INLINE_XATTR
))

94 
	`£t_šode_æag
(
šode
, 
FI_INLINE_XATTR
);

96 ià(
	`‹¡_İt
(
sbi
, 
INLINE_DATA
è&& 
	`f2fs_may_šlše_d©a
(
šode
))

97 
	`£t_šode_æag
(
šode
, 
FI_INLINE_DATA
);

98 ià(
	`f2fs_may_šlše_d’Œy
(
šode
))

99 
	`£t_šode_æag
(
šode
, 
FI_INLINE_DENTRY
);

101 ià(
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sbi
->
sb
)) {

102 
	`f2fs_bug_Ú
(
sbi
, !
	`f2fs_has_exŒa_©Œ
(
šode
));

103 ià(
	`f2fs_has_šlše_x©Œ
(
šode
))

104 
x©Œ_size
 = 
	`F2FS_OPTION
(
sbi
).
šlše_x©Œ_size
;

106 } ià(
	`f2fs_has_šlše_x©Œ
(
šode
) ||

107 
	`f2fs_has_šlše_d’Œy
(
šode
)) {

108 
x©Œ_size
 = 
DEFAULT_INLINE_XATTR_ADDRS
;

110 
	`F2FS_I
(
šode
)->
i_šlše_x©Œ_size
 = 
x©Œ_size
;

112 
	`f2fs_š™_ex‹Á_Œ“
(
šode
, 
NULL
);

114 
	`¡©_šc_šlše_x©Œ
(
šode
);

115 
	`¡©_šc_šlše_šode
(
šode
);

116 
	`¡©_šc_šlše_dœ
(
šode
);

118 
	`F2FS_I
(
šode
)->
i_æags
 =

119 
	`f2fs_mask_æags
(
mode
, 
	`F2FS_I
(
dœ
)->
i_æags
 & 
F2FS_FL_INHERITED
);

121 ià(
	`S_ISDIR
(
šode
->
i_mode
))

122 
	`F2FS_I
(
šode
)->
i_æags
 |ğ
F2FS_INDEX_FL
;

124 ià(
	`F2FS_I
(
šode
)->
i_æags
 & 
F2FS_PROJINHERIT_FL
)

125 
	`£t_šode_æag
(
šode
, 
FI_PROJ_INHERIT
);

127 
	`Œaû_f2fs_Ãw_šode
(
šode
, 0);

128  
šode
;

130 
ç
:

131 
	`Œaû_f2fs_Ãw_šode
(
šode
, 
”r
);

132 
	`make_bad_šode
(
šode
);

133 ià(
nid_ä“
)

134 
	`£t_šode_æag
(
šode
, 
FI_FREE_NID
);

135 
	`ut
(
šode
);

136  
	`ERR_PTR
(
”r
);

137 
ç_drİ
:

138 
	`Œaû_f2fs_Ãw_šode
(
šode
, 
”r
);

139 
	`dquÙ_drİ
(
šode
);

140 
šode
->
i_æags
 |ğ
S_NOQUOTA
;

141 ià(
nid_ä“
)

142 
	`£t_šode_æag
(
šode
, 
FI_FREE_NID
);

143 
	`ş—r_Æšk
(
šode
);

144 
	`uÆock_Ãw_šode
(
šode
);

145 
	`ut
(
šode
);

146  
	`ERR_PTR
(
”r
);

147 
	}
}

149 
	$is_ex‹nsiÚ_exi¡
(cÚ¡ *
s
, cÚ¡ *
sub
)

151 
size_t
 
¦’
 = 
	`¡¾’
(
s
);

152 
size_t
 
subËn
 = 
	`¡¾’
(
sub
);

153 
i
;

159 ià(
¦’
 < 
subËn
 + 2)

162 
i
 = 1; i < 
¦’
 - 
subËn
; i++) {

163 ià(
s
[
i
] != '.')

165 ià(!
	`¡ºÿ£cmp
(
s
 + 
i
 + 1, 
sub
, 
subËn
))

170 
	}
}

175 
šlše
 
	$£t_fe_‹m³¿tu»
(
f2fs_sb_šfo
 *
sbi
, 
šode
 *inode,

176 cÚ¡ *
Çme
)

178 
	`__u8
 (*
exi¡
)[
F2FS_EXTENSION_LEN
] = 
sbi
->
¿w_su³r
->
ex‹nsiÚ_li¡
;

179 
i
, 
cŞd_couÁ
, 
hÙ_couÁ
;

181 
	`down_»ad
(&
sbi
->
sb_lock
);

183 
cŞd_couÁ
 = 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
ex‹nsiÚ_couÁ
);

184 
hÙ_couÁ
 = 
sbi
->
¿w_su³r
->
hÙ_ext_couÁ
;

186 
i
 = 0; i < 
cŞd_couÁ
 + 
hÙ_couÁ
; i++) {

187 ià(!
	`is_ex‹nsiÚ_exi¡
(
Çme
, 
exi¡
[
i
]))

189 ià(
i
 < 
cŞd_couÁ
)

190 
	`fe_£t_cŞd
(
šode
);

192 
	`fe_£t_hÙ
(
šode
);

196 
	`up_»ad
(&
sbi
->
sb_lock
);

197 
	}
}

199 
	$f2fs_upd©e_ex‹nsiÚ_li¡
(
f2fs_sb_šfo
 *
sbi
, cÚ¡ *
Çme
,

200 
boŞ
 
hÙ
, boŞ 
£t
)

202 
	`__u8
 (*
exi¡
)[
F2FS_EXTENSION_LEN
] = 
sbi
->
¿w_su³r
->
ex‹nsiÚ_li¡
;

203 
cŞd_couÁ
 = 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
ex‹nsiÚ_couÁ
);

204 
hÙ_couÁ
 = 
sbi
->
¿w_su³r
->
hÙ_ext_couÁ
;

205 
tÙ®_couÁ
 = 
cŞd_couÁ
 + 
hÙ_couÁ
;

206 
¡¬t
, 
couÁ
;

207 
i
;

209 ià(
£t
) {

210 ià(
tÙ®_couÁ
 =ğ
F2FS_MAX_EXTENSION
)

211  -
EINVAL
;

213 ià(!
hÙ
 && !
cŞd_couÁ
)

214  -
EINVAL
;

215 ià(
hÙ
 && !
hÙ_couÁ
)

216  -
EINVAL
;

219 ià(
hÙ
) {

220 
¡¬t
 = 
cŞd_couÁ
;

221 
couÁ
 = 
tÙ®_couÁ
;

223 
¡¬t
 = 0;

224 
couÁ
 = 
cŞd_couÁ
;

227 
i
 = 
¡¬t
; i < 
couÁ
; i++) {

228 ià(
	`¡rcmp
(
Çme
, 
exi¡
[
i
]))

231 ià(
£t
)

232  -
EINVAL
;

234 
	`memıy
(
exi¡
[
i
],ƒxtlist[i + 1],

235 
F2FS_EXTENSION_LEN
 * (
tÙ®_couÁ
 - 
i
 - 1));

236 
	`mem£t
(
exi¡
[
tÙ®_couÁ
 - 1], 0, 
F2FS_EXTENSION_LEN
);

237 ià(
hÙ
)

238 
sbi
->
¿w_su³r
->
hÙ_ext_couÁ
 = 
hÙ_couÁ
 - 1;

240 
sbi
->
¿w_su³r
->
ex‹nsiÚ_couÁ
 =

241 
	`ıu_to_Ë32
(
cŞd_couÁ
 - 1);

245 ià(!
£t
)

246  -
EINVAL
;

248 ià(
hÙ
) {

249 
	`¡ºıy
(
exi¡
[
couÁ
], 
Çme
, 
	`¡¾’
(name));

250 
sbi
->
¿w_su³r
->
hÙ_ext_couÁ
 = 
hÙ_couÁ
 + 1;

252 
buf
[
F2FS_MAX_EXTENSION
][
F2FS_EXTENSION_LEN
];

254 
	`memıy
(
buf
, &
exi¡
[
cŞd_couÁ
],

255 
F2FS_EXTENSION_LEN
 * 
hÙ_couÁ
);

256 
	`mem£t
(
exi¡
[
cŞd_couÁ
], 0, 
F2FS_EXTENSION_LEN
);

257 
	`¡ºıy
(
exi¡
[
cŞd_couÁ
], 
Çme
, 
	`¡¾’
(name));

258 
	`memıy
(&
exi¡
[
cŞd_couÁ
 + 1], 
buf
,

259 
F2FS_EXTENSION_LEN
 * 
hÙ_couÁ
);

260 
sbi
->
¿w_su³r
->
ex‹nsiÚ_couÁ
 = 
	`ıu_to_Ë32
(
cŞd_couÁ
 + 1);

263 
	}
}

265 
	$f2fs_ü—‹
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
,

266 
boŞ
 
exş
)

268 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

269 
šode
 *inode;

270 
nid_t
 
šo
 = 0;

271 
”r
;

273 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

274  -
EIO
;

276 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

277 ià(
”r
)

278  
”r
;

280 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
mode
);

281 ià(
	`IS_ERR
(
šode
))

282  
	`PTR_ERR
(
šode
);

284 ià(!
	`‹¡_İt
(
sbi
, 
DISABLE_EXT_IDENTIFY
))

285 
	`£t_fe_‹m³¿tu»
(
sbi
, 
šode
, 
d’Œy
->
d_Çme
.
Çme
);

287 
šode
->
i_İ
 = &
f2fs_fe_šode_İ”©iÚs
;

288 
šode
->
i_fİ
 = &
f2fs_fe_İ”©iÚs
;

289 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

290 
šo
 = 
šode
->
i_šo
;

292 
	`f2fs_lock_İ
(
sbi
);

293 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

294 ià(
”r
)

295 
out
;

296 
	`f2fs_uÆock_İ
(
sbi
);

298 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
šo
);

300 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

302 ià(
	`IS_DIRSYNC
(
dœ
))

303 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

305 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

307 
out
:

308 
	`f2fs_hªdË_çed_šode
(
šode
);

309  
”r
;

310 
	}
}

312 
	$f2fs_lšk
(
d’Œy
 *
Şd_d’Œy
, 
šode
 *
dœ
,

313 
d’Œy
 *dentry)

315 
šode
 *šodğ
	`d_šode
(
Şd_d’Œy
);

316 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

317 
”r
;

319 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

320  -
EIO
;

322 
”r
 = 
	`fsüy±_´•¬e_lšk
(
Şd_d’Œy
, 
dœ
, 
d’Œy
);

323 ià(
”r
)

324  
”r
;

326 ià(
	`is_šode_æag_£t
(
dœ
, 
FI_PROJ_INHERIT
) &&

327 (!
	`´ojid_eq
(
	`F2FS_I
(
dœ
)->
i_´ojid
,

328 
	`F2FS_I
(
Şd_d’Œy
->
d_šode
)->
i_´ojid
)))

329  -
EXDEV
;

331 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

332 ià(
”r
)

333  
”r
;

335 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

337 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

338 
	`ihŞd
(
šode
);

340 
	`£t_šode_æag
(
šode
, 
FI_INC_LINK
);

341 
	`f2fs_lock_İ
(
sbi
);

342 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

343 ià(
”r
)

344 
out
;

345 
	`f2fs_uÆock_İ
(
sbi
);

347 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

349 ià(
	`IS_DIRSYNC
(
dœ
))

350 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

352 
out
:

353 
	`ş—r_šode_æag
(
šode
, 
FI_INC_LINK
);

354 
	`ut
(
šode
);

355 
	`f2fs_uÆock_İ
(
sbi
);

356  
”r
;

357 
	}
}

359 
d’Œy
 *
	$f2fs_g‘_·»Á
(
d’Œy
 *
chd
)

361 
q¡r
 
dÙdÙ
 = 
	`QSTR_INIT
("..", 2);

362 
·ge
 *page;

363 
šo
 = 
	`f2fs_šode_by_Çme
(
	`d_šode
(
chd
), &
dÙdÙ
, &
·ge
);

364 ià(!
šo
) {

365 ià(
	`IS_ERR
(
·ge
))

366  
	`ERR_CAST
(
·ge
);

367  
	`ERR_PTR
(-
ENOENT
);

369  
	`d_obš_®Ÿs
(
	`f2fs_ig‘
(
chd
->
d_sb
, 
šo
));

370 
	}
}

372 
	$__»cov”_dÙ_d’Œ›s
(
šode
 *
dœ
, 
nid_t
 
pšo
)

374 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

375 
q¡r
 
dÙ
 = 
	`QSTR_INIT
(".", 1);

376 
q¡r
 
dÙdÙ
 = 
	`QSTR_INIT
("..", 2);

377 
f2fs_dœ_’Œy
 *
de
;

378 
·ge
 *page;

379 
”r
 = 0;

381 ià(
	`f2fs_»adÚly
(
sbi
->
sb
)) {

382 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
,

384 "š„—dÚly mouÁpošt", 
dœ
->
i_šo
, 
pšo
);

388 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

389 ià(
”r
)

390  
”r
;

392 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

394 
	`f2fs_lock_İ
(
sbi
);

396 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, &
dÙ
, &
·ge
);

397 ià(
de
) {

398 
	`f2fs_put_·ge
(
·ge
, 0);

399 } ià(
	`IS_ERR
(
·ge
)) {

400 
”r
 = 
	`PTR_ERR
(
·ge
);

401 
out
;

403 
”r
 = 
	`f2fs_do_add_lšk
(
dœ
, &
dÙ
, 
NULL
, dœ->
i_šo
, 
S_IFDIR
);

404 ià(
”r
)

405 
out
;

408 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, &
dÙdÙ
, &
·ge
);

409 ià(
de
)

410 
	`f2fs_put_·ge
(
·ge
, 0);

411 ià(
	`IS_ERR
(
·ge
))

412 
”r
 = 
	`PTR_ERR
(
·ge
);

414 
”r
 = 
	`f2fs_do_add_lšk
(
dœ
, &
dÙdÙ
, 
NULL
, 
pšo
, 
S_IFDIR
);

415 
out
:

416 ià(!
”r
)

417 
	`ş—r_šode_æag
(
dœ
, 
FI_INLINE_DOTS
);

419 
	`f2fs_uÆock_İ
(
sbi
);

420  
”r
;

421 
	}
}

423 
d’Œy
 *
	$f2fs_lookup
(
šode
 *
dœ
, 
d’Œy
 *dentry,

424 
æags
)

426 
šode
 *šodğ
NULL
;

427 
f2fs_dœ_’Œy
 *
de
;

428 
·ge
 *page;

429 
d’Œy
 *
Ãw
;

430 
nid_t
 
šo
 = -1;

431 
”r
 = 0;

432 
roÙ_šo
 = 
	`F2FS_ROOT_INO
(
	`F2FS_I_SB
(
dœ
));

434 
	`Œaû_f2fs_lookup_¡¬t
(
dœ
, 
d’Œy
, 
æags
);

436 
”r
 = 
	`fsüy±_´•¬e_lookup
(
dœ
, 
d’Œy
, 
æags
);

437 ià(
”r
)

438 
out
;

440 ià(
d’Œy
->
d_Çme
.
Ën
 > 
F2FS_NAME_LEN
) {

441 
”r
 = -
ENAMETOOLONG
;

442 
out
;

445 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, &
d’Œy
->
d_Çme
, &
·ge
);

446 ià(!
de
) {

447 ià(
	`IS_ERR
(
·ge
)) {

448 
”r
 = 
	`PTR_ERR
(
·ge
);

449 
out
;

451 
out_¥liû
;

454 
šo
 = 
	`Ë32_to_ıu
(
de
->ino);

455 
	`f2fs_put_·ge
(
·ge
, 0);

457 
šode
 = 
	`f2fs_ig‘
(
dœ
->
i_sb
, 
šo
);

458 ià(
	`IS_ERR
(
šode
)) {

459 
”r
 = 
	`PTR_ERR
(
šode
);

460 
out
;

463 ià((
dœ
->
i_šo
 =ğ
roÙ_šo
è&& 
	`f2fs_has_šlše_dÙs
(dir)) {

464 
”r
 = 
	`__»cov”_dÙ_d’Œ›s
(
dœ
, 
roÙ_šo
);

465 ià(
”r
)

466 
out_ut
;

469 ià(
	`f2fs_has_šlše_dÙs
(
šode
)) {

470 
”r
 = 
	`__»cov”_dÙ_d’Œ›s
(
šode
, 
dœ
->
i_šo
);

471 ià(
”r
)

472 
out_ut
;

474 ià(
	`f2fs_’üy±ed_šode
(
dœ
) &&

475 (
	`S_ISDIR
(
šode
->
i_mode
è|| 
	`S_ISLNK
(inode->i_mode)) &&

476 !
	`fsüy±_has_³rm™‹d_cÚ‹xt
(
dœ
, 
šode
)) {

477 
	`f2fs_msg
(
šode
->
i_sb
, 
KERN_WARNING
,

479 
dœ
->
i_šo
, 
šode
->i_ino);

480 
”r
 = -
EPERM
;

481 
out_ut
;

483 
out_¥liû
:

484 
Ãw
 = 
	`d_¥liû_®Ÿs
(
šode
, 
d’Œy
);

485 ià(
	`IS_ERR
(
Ãw
))

486 
”r
 = 
	`PTR_ERR
(
Ãw
);

487 
	`Œaû_f2fs_lookup_’d
(
dœ
, 
d’Œy
, 
šo
, 
”r
);

488  
Ãw
;

489 
out_ut
:

490 
	`ut
(
šode
);

491 
out
:

492 
	`Œaû_f2fs_lookup_’d
(
dœ
, 
d’Œy
, 
šo
, 
”r
);

493  
	`ERR_PTR
(
”r
);

494 
	}
}

496 
	$f2fs_uÆšk
(
šode
 *
dœ
, 
d’Œy
 *dentry)

498 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

499 
šode
 *šodğ
	`d_šode
(
d’Œy
);

500 
f2fs_dœ_’Œy
 *
de
;

501 
·ge
 *page;

502 
”r
 = -
ENOENT
;

504 
	`Œaû_f2fs_uÆšk_’‹r
(
dœ
, 
d’Œy
);

506 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

507  -
EIO
;

509 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

510 ià(
”r
)

511  
”r
;

512 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

513 ià(
”r
)

514  
”r
;

516 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, &
d’Œy
->
d_Çme
, &
·ge
);

517 ià(!
de
) {

518 ià(
	`IS_ERR
(
·ge
))

519 
”r
 = 
	`PTR_ERR
(
·ge
);

520 
ç
;

523 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

525 
	`f2fs_lock_İ
(
sbi
);

526 
”r
 = 
	`f2fs_acquœe_Üphª_šode
(
sbi
);

527 ià(
”r
) {

528 
	`f2fs_uÆock_İ
(
sbi
);

529 
	`f2fs_put_·ge
(
·ge
, 0);

530 
ç
;

532 
	`f2fs_d–‘e_’Œy
(
de
, 
·ge
, 
dœ
, 
šode
);

533 
	`f2fs_uÆock_İ
(
sbi
);

535 ià(
	`IS_DIRSYNC
(
dœ
))

536 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

537 
ç
:

538 
	`Œaû_f2fs_uÆšk_ex™
(
šode
, 
”r
);

539  
”r
;

540 
	}
}

542 cÚ¡ *
	$f2fs_g‘_lšk
(
d’Œy
 *dentry,

543 
šode
 *inode,

544 
d–ayed_ÿÎ
 *
dÚe
)

546 cÚ¡ *
lšk
 = 
	`·ge_g‘_lšk
(
d’Œy
, 
šode
, 
dÚe
);

547 ià(!
	`IS_ERR
(
lšk
) && !*link) {

549 
	`do_d–ayed_ÿÎ
(
dÚe
);

550 
	`ş—r_d–ayed_ÿÎ
(
dÚe
);

551 
lšk
 = 
	`ERR_PTR
(-
ENOENT
);

553  
lšk
;

554 
	}
}

556 
	$f2fs_symlšk
(
šode
 *
dœ
, 
d’Œy
 *dentry,

557 cÚ¡ *
symÇme
)

559 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

560 
šode
 *inode;

561 
size_t
 
Ën
 = 
	`¡¾’
(
symÇme
);

562 
fsüy±_¡r
 
disk_lšk
;

563 
”r
;

565 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

566  -
EIO
;

568 
”r
 = 
	`fsüy±_´•¬e_symlšk
(
dœ
, 
symÇme
, 
Ën
, dœ->
i_sb
->
s_blocksize
,

569 &
disk_lšk
);

570 ià(
”r
)

571  
”r
;

573 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

574 ià(
”r
)

575  
”r
;

577 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
S_IFLNK
 | 
S_IRWXUGO
);

578 ià(
	`IS_ERR
(
šode
))

579  
	`PTR_ERR
(
šode
);

581 ià(
	`IS_ENCRYPTED
(
šode
))

582 
šode
->
i_İ
 = &
f2fs_’üy±ed_symlšk_šode_İ”©iÚs
;

584 
šode
->
i_İ
 = &
f2fs_symlšk_šode_İ”©iÚs
;

585 
	`šode_nohighmem
(
šode
);

586 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

588 
	`f2fs_lock_İ
(
sbi
);

589 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

590 ià(
”r
)

591 
out_f2fs_hªdË_çed_šode
;

592 
	`f2fs_uÆock_İ
(
sbi
);

593 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

595 
”r
 = 
	`fsüy±_’üy±_symlšk
(
šode
, 
symÇme
, 
Ën
, &
disk_lšk
);

596 ià(
”r
)

597 
”r_out
;

599 
”r
 = 
	`·ge_symlšk
(
šode
, 
disk_lšk
.
Çme
, disk_lšk.
Ën
);

601 
”r_out
:

602 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

613 ià(!
”r
) {

614 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 0,

615 
disk_lšk
.
Ën
 - 1);

617 ià(
	`IS_DIRSYNC
(
dœ
))

618 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

620 
	`f2fs_uÆšk
(
dœ
, 
d’Œy
);

623 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

624 
out_ä“_’üy±ed_lšk
;

626 
out_f2fs_hªdË_çed_šode
:

627 
	`f2fs_hªdË_çed_šode
(
šode
);

628 
out_ä“_’üy±ed_lšk
:

629 ià(
disk_lšk
.
Çme
 !ğ(*)
symÇme
)

630 
	`kä“
(
disk_lšk
.
Çme
);

631  
”r
;

632 
	}
}

634 
	$f2fs_mkdœ
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

636 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

637 
šode
 *inode;

638 
”r
;

640 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

641  -
EIO
;

643 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

644 ià(
”r
)

645  
”r
;

647 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
S_IFDIR
 | 
mode
);

648 ià(
	`IS_ERR
(
šode
))

649  
	`PTR_ERR
(
šode
);

651 
šode
->
i_İ
 = &
f2fs_dœ_šode_İ”©iÚs
;

652 
šode
->
i_fİ
 = &
f2fs_dœ_İ”©iÚs
;

653 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

654 
	`šode_nohighmem
(
šode
);

656 
	`£t_šode_æag
(
šode
, 
FI_INC_LINK
);

657 
	`f2fs_lock_İ
(
sbi
);

658 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

659 ià(
”r
)

660 
out_ç
;

661 
	`f2fs_uÆock_İ
(
sbi
);

663 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

665 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

667 ià(
	`IS_DIRSYNC
(
dœ
))

668 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

670 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

673 
out_ç
:

674 
	`ş—r_šode_æag
(
šode
, 
FI_INC_LINK
);

675 
	`f2fs_hªdË_çed_šode
(
šode
);

676  
”r
;

677 
	}
}

679 
	$f2fs_rmdœ
(
šode
 *
dœ
, 
d’Œy
 *dentry)

681 
šode
 *šodğ
	`d_šode
(
d’Œy
);

682 ià(
	`f2fs_em±y_dœ
(
šode
))

683  
	`f2fs_uÆšk
(
dœ
, 
d’Œy
);

684  -
ENOTEMPTY
;

685 
	}
}

687 
	$f2fs_mknod
(
šode
 *
dœ
, 
d’Œy
 *dentry,

688 
umode_t
 
mode
, 
dev_t
 
rdev
)

690 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

691 
šode
 *inode;

692 
”r
 = 0;

694 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

695  -
EIO
;

697 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

698 ià(
”r
)

699  
”r
;

701 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
mode
);

702 ià(
	`IS_ERR
(
šode
))

703  
	`PTR_ERR
(
šode
);

705 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, 
rdev
);

706 
šode
->
i_İ
 = &
f2fs_¥ecŸl_šode_İ”©iÚs
;

708 
	`f2fs_lock_İ
(
sbi
);

709 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

710 ià(
”r
)

711 
out
;

712 
	`f2fs_uÆock_İ
(
sbi
);

714 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

716 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

718 ià(
	`IS_DIRSYNC
(
dœ
))

719 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

721 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

723 
out
:

724 
	`f2fs_hªdË_çed_šode
(
šode
);

725  
”r
;

726 
	}
}

728 
	$__f2fs_tmpfe
(
šode
 *
dœ
, 
d’Œy
 *dentry,

729 
umode_t
 
mode
, 
šode
 **
wh™eout
)

731 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

732 
šode
 *inode;

733 
”r
;

735 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

736 ià(
”r
)

737  
”r
;

739 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
mode
);

740 ià(
	`IS_ERR
(
šode
))

741  
	`PTR_ERR
(
šode
);

743 ià(
wh™eout
) {

744 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, 
WHITEOUT_DEV
);

745 
šode
->
i_İ
 = &
f2fs_¥ecŸl_šode_İ”©iÚs
;

747 
šode
->
i_İ
 = &
f2fs_fe_šode_İ”©iÚs
;

748 
šode
->
i_fİ
 = &
f2fs_fe_İ”©iÚs
;

749 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

752 
	`f2fs_lock_İ
(
sbi
);

753 
”r
 = 
	`f2fs_acquœe_Üphª_šode
(
sbi
);

754 ià(
”r
)

755 
out
;

757 
”r
 = 
	`f2fs_do_tmpfe
(
šode
, 
dœ
);

758 ià(
”r
)

759 
»Ëa£_out
;

765 
	`f2fs_add_Üphª_šode
(
šode
);

766 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

768 ià(
wh™eout
) {

769 
	`f2fs_i_lšks_wr™e
(
šode
, 
çl£
);

770 *
wh™eout
 = 
šode
;

772 
	`d_tmpfe
(
d’Œy
, 
šode
);

775 
	`f2fs_uÆock_İ
(
sbi
);

776 
	`uÆock_Ãw_šode
(
šode
);

778 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

781 
»Ëa£_out
:

782 
	`f2fs_»Ëa£_Üphª_šode
(
sbi
);

783 
out
:

784 
	`f2fs_hªdË_çed_šode
(
šode
);

785  
”r
;

786 
	}
}

788 
	$f2fs_tmpfe
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

790 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

792 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

793  -
EIO
;

795 ià(
	`f2fs_’üy±ed_šode
(
dœ
è|| 
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
)) {

796 
”r
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
dœ
);

797 ià(
”r
)

798  
”r
;

801  
	`__f2fs_tmpfe
(
dœ
, 
d’Œy
, 
mode
, 
NULL
);

802 
	}
}

804 
	$f2fs_ü—‹_wh™eout
(
šode
 *
dœ
, šod**
wh™eout
)

806 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
dœ
))))

807  -
EIO
;

809  
	`__f2fs_tmpfe
(
dœ
, 
NULL
, 
S_IFCHR
 | 
WHITEOUT_MODE
, 
wh™eout
);

810 
	}
}

812 
	$f2fs_»Çme
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

813 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
,

814 
æags
)

816 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
Şd_dœ
);

817 
šode
 *
Şd_šode
 = 
	`d_šode
(
Şd_d’Œy
);

818 
šode
 *
Ãw_šode
 = 
	`d_šode
(
Ãw_d’Œy
);

819 
šode
 *
wh™eout
 = 
NULL
;

820 
·ge
 *
Şd_dœ_·ge
;

821 
·ge
 *
Şd_·ge
, *
Ãw_·ge
 = 
NULL
;

822 
f2fs_dœ_’Œy
 *
Şd_dœ_’Œy
 = 
NULL
;

823 
f2fs_dœ_’Œy
 *
Şd_’Œy
;

824 
f2fs_dœ_’Œy
 *
Ãw_’Œy
;

825 
boŞ
 
is_Şd_šlše
 = 
	`f2fs_has_šlše_d’Œy
(
Şd_dœ
);

826 
”r
 = -
ENOENT
;

828 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

829  -
EIO
;

831 ià(
	`is_šode_æag_£t
(
Ãw_dœ
, 
FI_PROJ_INHERIT
) &&

832 (!
	`´ojid_eq
(
	`F2FS_I
(
Ãw_dœ
)->
i_´ojid
,

833 
	`F2FS_I
(
Şd_d’Œy
->
d_šode
)->
i_´ojid
)))

834  -
EXDEV
;

836 
”r
 = 
	`dquÙ_š™Ÿlize
(
Şd_dœ
);

837 ià(
”r
)

838 
out
;

840 
”r
 = 
	`dquÙ_š™Ÿlize
(
Ãw_dœ
);

841 ià(
”r
)

842 
out
;

844 ià(
Ãw_šode
) {

845 
”r
 = 
	`dquÙ_š™Ÿlize
(
Ãw_šode
);

846 ià(
”r
)

847 
out
;

850 
Şd_’Œy
 = 
	`f2fs_fšd_’Œy
(
Şd_dœ
, &
Şd_d’Œy
->
d_Çme
, &
Şd_·ge
);

851 ià(!
Şd_’Œy
) {

852 ià(
	`IS_ERR
(
Şd_·ge
))

853 
”r
 = 
	`PTR_ERR
(
Şd_·ge
);

854 
out
;

857 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
)) {

858 
Şd_dœ_’Œy
 = 
	`f2fs_·»Á_dœ
(
Şd_šode
, &
Şd_dœ_·ge
);

859 ià(!
Şd_dœ_’Œy
) {

860 ià(
	`IS_ERR
(
Şd_dœ_·ge
))

861 
”r
 = 
	`PTR_ERR
(
Şd_dœ_·ge
);

862 
out_Şd
;

866 ià(
æags
 & 
RENAME_WHITEOUT
) {

867 
”r
 = 
	`f2fs_ü—‹_wh™eout
(
Şd_dœ
, &
wh™eout
);

868 ià(
”r
)

869 
out_dœ
;

872 ià(
Ãw_šode
) {

874 
”r
 = -
ENOTEMPTY
;

875 ià(
Şd_dœ_’Œy
 && !
	`f2fs_em±y_dœ
(
Ãw_šode
))

876 
out_wh™eout
;

878 
”r
 = -
ENOENT
;

879 
Ãw_’Œy
 = 
	`f2fs_fšd_’Œy
(
Ãw_dœ
, &
Ãw_d’Œy
->
d_Çme
,

880 &
Ãw_·ge
);

881 ià(!
Ãw_’Œy
) {

882 ià(
	`IS_ERR
(
Ãw_·ge
))

883 
”r
 = 
	`PTR_ERR
(
Ãw_·ge
);

884 
out_wh™eout
;

887 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

889 
	`f2fs_lock_İ
(
sbi
);

891 
”r
 = 
	`f2fs_acquœe_Üphª_šode
(
sbi
);

892 ià(
”r
)

893 
put_out_dœ
;

895 
	`f2fs_£t_lšk
(
Ãw_dœ
, 
Ãw_’Œy
, 
Ãw_·ge
, 
Şd_šode
);

897 
Ãw_šode
->
i_ùime
 = 
	`cu¼’t_time
(new_inode);

898 
	`down_wr™e
(&
	`F2FS_I
(
Ãw_šode
)->
i_£m
);

899 ià(
Şd_dœ_’Œy
)

900 
	`f2fs_i_lšks_wr™e
(
Ãw_šode
, 
çl£
);

901 
	`f2fs_i_lšks_wr™e
(
Ãw_šode
, 
çl£
);

902 
	`up_wr™e
(&
	`F2FS_I
(
Ãw_šode
)->
i_£m
);

904 ià(!
Ãw_šode
->
i_Æšk
)

905 
	`f2fs_add_Üphª_šode
(
Ãw_šode
);

907 
	`f2fs_»Ëa£_Üphª_šode
(
sbi
);

909 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

911 
	`f2fs_lock_İ
(
sbi
);

913 
”r
 = 
	`f2fs_add_lšk
(
Ãw_d’Œy
, 
Şd_šode
);

914 ià(
”r
) {

915 
	`f2fs_uÆock_İ
(
sbi
);

916 
out_wh™eout
;

919 ià(
Şd_dœ_’Œy
)

920 
	`f2fs_i_lšks_wr™e
(
Ãw_dœ
, 
Œue
);

929 ià(
is_Şd_šlše
 && !
	`f2fs_has_šlše_d’Œy
(
Şd_dœ
)) {

930 
	`f2fs_put_·ge
(
Şd_·ge
, 0);

931 
Şd_·ge
 = 
NULL
;

933 
Şd_’Œy
 = 
	`f2fs_fšd_’Œy
(
Şd_dœ
,

934 &
Şd_d’Œy
->
d_Çme
, &
Şd_·ge
);

935 ià(!
Şd_’Œy
) {

936 
”r
 = -
ENOENT
;

937 ià(
	`IS_ERR
(
Şd_·ge
))

938 
”r
 = 
	`PTR_ERR
(
Şd_·ge
);

939 
	`f2fs_uÆock_İ
(
sbi
);

940 
out_wh™eout
;

945 
	`down_wr™e
(&
	`F2FS_I
(
Şd_šode
)->
i_£m
);

946 ià(!
Şd_dœ_’Œy
 || 
wh™eout
)

947 
	`fe_lo¡_pšo
(
Şd_šode
);

949 
	`F2FS_I
(
Şd_šode
)->
i_pšo
 = 
Ãw_dœ
->
i_šo
;

950 
	`up_wr™e
(&
	`F2FS_I
(
Şd_šode
)->
i_£m
);

952 
Şd_šode
->
i_ùime
 = 
	`cu¼’t_time
(old_inode);

953 
	`f2fs_m¬k_šode_dœty_sync
(
Şd_šode
, 
çl£
);

955 
	`f2fs_d–‘e_’Œy
(
Şd_’Œy
, 
Şd_·ge
, 
Şd_dœ
, 
NULL
);

957 ià(
wh™eout
) {

958 
wh™eout
->
i_¡©e
 |ğ
I_LINKABLE
;

959 
	`£t_šode_æag
(
wh™eout
, 
FI_INC_LINK
);

960 
”r
 = 
	`f2fs_add_lšk
(
Şd_d’Œy
, 
wh™eout
);

961 ià(
”r
)

962 
put_out_dœ
;

963 
wh™eout
->
i_¡©e
 &ğ~
I_LINKABLE
;

964 
	`ut
(
wh™eout
);

967 ià(
Şd_dœ_’Œy
) {

968 ià(
Şd_dœ
 !ğ
Ãw_dœ
 && !
wh™eout
)

969 
	`f2fs_£t_lšk
(
Şd_šode
, 
Şd_dœ_’Œy
,

970 
Şd_dœ_·ge
, 
Ãw_dœ
);

972 
	`f2fs_put_·ge
(
Şd_dœ_·ge
, 0);

973 
	`f2fs_i_lšks_wr™e
(
Şd_dœ
, 
çl£
);

975 ià(
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =ğ
FSYNC_MODE_STRICT
) {

976 
	`f2fs_add_šo_’Œy
(
sbi
, 
Ãw_dœ
->
i_šo
, 
TRANS_DIR_INO
);

977 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
))

978 
	`f2fs_add_šo_’Œy
(
sbi
, 
Şd_šode
->
i_šo
,

979 
TRANS_DIR_INO
);

982 
	`f2fs_uÆock_İ
(
sbi
);

984 ià(
	`IS_DIRSYNC
(
Şd_dœ
è|| IS_DIRSYNC(
Ãw_dœ
))

985 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

988 
put_out_dœ
:

989 
	`f2fs_uÆock_İ
(
sbi
);

990 ià(
Ãw_·ge
)

991 
	`f2fs_put_·ge
(
Ãw_·ge
, 0);

992 
out_wh™eout
:

993 ià(
wh™eout
)

994 
	`ut
(
wh™eout
);

995 
out_dœ
:

996 ià(
Şd_dœ_’Œy
)

997 
	`f2fs_put_·ge
(
Şd_dœ_·ge
, 0);

998 
out_Şd
:

999 
	`f2fs_put_·ge
(
Şd_·ge
, 0);

1000 
out
:

1001  
”r
;

1002 
	}
}

1004 
	$f2fs_üoss_»Çme
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

1005 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
)

1007 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
Şd_dœ
);

1008 
šode
 *
Şd_šode
 = 
	`d_šode
(
Şd_d’Œy
);

1009 
šode
 *
Ãw_šode
 = 
	`d_šode
(
Ãw_d’Œy
);

1010 
·ge
 *
Şd_dœ_·ge
, *
Ãw_dœ_·ge
;

1011 
·ge
 *
Şd_·ge
, *
Ãw_·ge
;

1012 
f2fs_dœ_’Œy
 *
Şd_dœ_’Œy
 = 
NULL
, *
Ãw_dœ_’Œy
 = NULL;

1013 
f2fs_dœ_’Œy
 *
Şd_’Œy
, *
Ãw_’Œy
;

1014 
Şd_Æšk
 = 0, 
Ãw_Æšk
 = 0;

1015 
”r
 = -
ENOENT
;

1017 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1018  -
EIO
;

1020 ià((
	`is_šode_æag_£t
(
Ãw_dœ
, 
FI_PROJ_INHERIT
) &&

1021 !
	`´ojid_eq
(
	`F2FS_I
(
Ãw_dœ
)->
i_´ojid
,

1022 
	`F2FS_I
(
Şd_d’Œy
->
d_šode
)->
i_´ojid
)) ||

1023 (
	`is_šode_æag_£t
(
Ãw_dœ
, 
FI_PROJ_INHERIT
) &&

1024 !
	`´ojid_eq
(
	`F2FS_I
(
Şd_dœ
)->
i_´ojid
,

1025 
	`F2FS_I
(
Ãw_d’Œy
->
d_šode
)->
i_´ojid
)))

1026  -
EXDEV
;

1028 
”r
 = 
	`dquÙ_š™Ÿlize
(
Şd_dœ
);

1029 ià(
”r
)

1030 
out
;

1032 
”r
 = 
	`dquÙ_š™Ÿlize
(
Ãw_dœ
);

1033 ià(
”r
)

1034 
out
;

1036 
Şd_’Œy
 = 
	`f2fs_fšd_’Œy
(
Şd_dœ
, &
Şd_d’Œy
->
d_Çme
, &
Şd_·ge
);

1037 ià(!
Şd_’Œy
) {

1038 ià(
	`IS_ERR
(
Şd_·ge
))

1039 
”r
 = 
	`PTR_ERR
(
Şd_·ge
);

1040 
out
;

1043 
Ãw_’Œy
 = 
	`f2fs_fšd_’Œy
(
Ãw_dœ
, &
Ãw_d’Œy
->
d_Çme
, &
Ãw_·ge
);

1044 ià(!
Ãw_’Œy
) {

1045 ià(
	`IS_ERR
(
Ãw_·ge
))

1046 
”r
 = 
	`PTR_ERR
(
Ãw_·ge
);

1047 
out_Şd
;

1051 ià(
Şd_dœ
 !ğ
Ãw_dœ
) {

1052 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
)) {

1053 
Şd_dœ_’Œy
 = 
	`f2fs_·»Á_dœ
(
Şd_šode
,

1054 &
Şd_dœ_·ge
);

1055 ià(!
Şd_dœ_’Œy
) {

1056 ià(
	`IS_ERR
(
Şd_dœ_·ge
))

1057 
”r
 = 
	`PTR_ERR
(
Şd_dœ_·ge
);

1058 
out_Ãw
;

1062 ià(
	`S_ISDIR
(
Ãw_šode
->
i_mode
)) {

1063 
Ãw_dœ_’Œy
 = 
	`f2fs_·»Á_dœ
(
Ãw_šode
,

1064 &
Ãw_dœ_·ge
);

1065 ià(!
Ãw_dœ_’Œy
) {

1066 ià(
	`IS_ERR
(
Ãw_dœ_·ge
))

1067 
”r
 = 
	`PTR_ERR
(
Ãw_dœ_·ge
);

1068 
out_Şd_dœ
;

1078 ià((!
Şd_dœ_’Œy
 || !
Ãw_dœ_’Œy
) &&

1079 
Şd_dœ_’Œy
 !ğ
Ãw_dœ_’Œy
) {

1080 
Şd_Æšk
 = 
Şd_dœ_’Œy
 ? -1 : 1;

1081 
Ãw_Æšk
 = -
Şd_Æšk
;

1082 
”r
 = -
EMLINK
;

1083 ià((
Şd_Æšk
 > 0 && 
Şd_dœ
->
i_Æšk
 >ğ
F2FS_LINK_MAX
) ||

1084 (
Ãw_Æšk
 > 0 && 
Ãw_dœ
->
i_Æšk
 >ğ
F2FS_LINK_MAX
))

1085 
out_Ãw_dœ
;

1088 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

1090 
	`f2fs_lock_İ
(
sbi
);

1093 ià(
Şd_dœ_’Œy
)

1094 
	`f2fs_£t_lšk
(
Şd_šode
, 
Şd_dœ_’Œy
, 
Şd_dœ_·ge
, 
Ãw_dœ
);

1097 ià(
Ãw_dœ_’Œy
)

1098 
	`f2fs_£t_lšk
(
Ãw_šode
, 
Ãw_dœ_’Œy
, 
Ãw_dœ_·ge
, 
Şd_dœ
);

1101 
	`f2fs_£t_lšk
(
Şd_dœ
, 
Şd_’Œy
, 
Şd_·ge
, 
Ãw_šode
);

1103 
	`down_wr™e
(&
	`F2FS_I
(
Şd_šode
)->
i_£m
);

1104 
	`fe_lo¡_pšo
(
Şd_šode
);

1105 
	`up_wr™e
(&
	`F2FS_I
(
Şd_šode
)->
i_£m
);

1107 
Şd_dœ
->
i_ùime
 = 
	`cu¼’t_time
(old_dir);

1108 ià(
Şd_Æšk
) {

1109 
	`down_wr™e
(&
	`F2FS_I
(
Şd_dœ
)->
i_£m
);

1110 
	`f2fs_i_lšks_wr™e
(
Şd_dœ
, 
Şd_Æšk
 > 0);

1111 
	`up_wr™e
(&
	`F2FS_I
(
Şd_dœ
)->
i_£m
);

1113 
	`f2fs_m¬k_šode_dœty_sync
(
Şd_dœ
, 
çl£
);

1116 
	`f2fs_£t_lšk
(
Ãw_dœ
, 
Ãw_’Œy
, 
Ãw_·ge
, 
Şd_šode
);

1118 
	`down_wr™e
(&
	`F2FS_I
(
Ãw_šode
)->
i_£m
);

1119 
	`fe_lo¡_pšo
(
Ãw_šode
);

1120 
	`up_wr™e
(&
	`F2FS_I
(
Ãw_šode
)->
i_£m
);

1122 
Ãw_dœ
->
i_ùime
 = 
	`cu¼’t_time
(new_dir);

1123 ià(
Ãw_Æšk
) {

1124 
	`down_wr™e
(&
	`F2FS_I
(
Ãw_dœ
)->
i_£m
);

1125 
	`f2fs_i_lšks_wr™e
(
Ãw_dœ
, 
Ãw_Æšk
 > 0);

1126 
	`up_wr™e
(&
	`F2FS_I
(
Ãw_dœ
)->
i_£m
);

1128 
	`f2fs_m¬k_šode_dœty_sync
(
Ãw_dœ
, 
çl£
);

1130 ià(
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =ğ
FSYNC_MODE_STRICT
) {

1131 
	`f2fs_add_šo_’Œy
(
sbi
, 
Şd_dœ
->
i_šo
, 
TRANS_DIR_INO
);

1132 
	`f2fs_add_šo_’Œy
(
sbi
, 
Ãw_dœ
->
i_šo
, 
TRANS_DIR_INO
);

1135 
	`f2fs_uÆock_İ
(
sbi
);

1137 ià(
	`IS_DIRSYNC
(
Şd_dœ
è|| IS_DIRSYNC(
Ãw_dœ
))

1138 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

1140 
out_Ãw_dœ
:

1141 ià(
Ãw_dœ_’Œy
) {

1142 
	`f2fs_put_·ge
(
Ãw_dœ_·ge
, 0);

1144 
out_Şd_dœ
:

1145 ià(
Şd_dœ_’Œy
) {

1146 
	`f2fs_put_·ge
(
Şd_dœ_·ge
, 0);

1148 
out_Ãw
:

1149 
	`f2fs_put_·ge
(
Ãw_·ge
, 0);

1150 
out_Şd
:

1151 
	`f2fs_put_·ge
(
Şd_·ge
, 0);

1152 
out
:

1153  
”r
;

1154 
	}
}

1156 
	$f2fs_»Çme2
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

1157 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
,

1158 
æags
)

1160 
”r
;

1162 ià(
æags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
 | 
RENAME_WHITEOUT
))

1163  -
EINVAL
;

1165 
”r
 = 
	`fsüy±_´•¬e_»Çme
(
Şd_dœ
, 
Şd_d’Œy
, 
Ãw_dœ
, 
Ãw_d’Œy
,

1166 
æags
);

1167 ià(
”r
)

1168  
”r
;

1170 ià(
æags
 & 
RENAME_EXCHANGE
) {

1171  
	`f2fs_üoss_»Çme
(
Şd_dœ
, 
Şd_d’Œy
,

1172 
Ãw_dœ
, 
Ãw_d’Œy
);

1178  
	`f2fs_»Çme
(
Şd_dœ
, 
Şd_d’Œy
, 
Ãw_dœ
, 
Ãw_d’Œy
, 
æags
);

1179 
	}
}

1181 cÚ¡ *
	$f2fs_’üy±ed_g‘_lšk
(
d’Œy
 *dentry,

1182 
šode
 *inode,

1183 
d–ayed_ÿÎ
 *
dÚe
)

1185 
·ge
 *page;

1186 cÚ¡ *
rg‘
;

1188 ià(!
d’Œy
)

1189  
	`ERR_PTR
(-
ECHILD
);

1191 
·ge
 = 
	`»ad_m­pšg_·ge
(
šode
->
i_m­pšg
, 0, 
NULL
);

1192 ià(
	`IS_ERR
(
·ge
))

1193  
	`ERR_CAST
(
·ge
);

1195 
rg‘
 = 
	`fsüy±_g‘_symlšk
(
šode
, 
	`·ge_add»ss
(
·ge
),

1196 
šode
->
i_sb
->
s_blocksize
, 
dÚe
);

1197 
	`put_·ge
(
·ge
);

1198  
rg‘
;

1199 
	}
}

1201 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_’üy±ed_symlšk_šode_İ”©iÚs
 = {

1202 .
g‘_lšk
 = 
f2fs_’üy±ed_g‘_lšk
,

1203 .
	gg‘©Œ
 = 
f2fs_g‘©Œ
,

1204 .
	g£‰r
 = 
f2fs_£‰r
,

1205 #ifdeà
CONFIG_F2FS_FS_XATTR


1206 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

1210 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_dœ_šode_İ”©iÚs
 = {

1211 .
ü—‹
 = 
f2fs_ü—‹
,

1212 .
	glookup
 = 
f2fs_lookup
,

1213 .
	glšk
 = 
f2fs_lšk
,

1214 .
	guÆšk
 = 
f2fs_uÆšk
,

1215 .
	gsymlšk
 = 
f2fs_symlšk
,

1216 .
	gmkdœ
 = 
f2fs_mkdœ
,

1217 .
	grmdœ
 = 
f2fs_rmdœ
,

1218 .
	gmknod
 = 
f2fs_mknod
,

1219 .
	g»Çme
 = 
f2fs_»Çme2
,

1220 .
	gtmpfe
 = 
f2fs_tmpfe
,

1221 .
	gg‘©Œ
 = 
f2fs_g‘©Œ
,

1222 .
	g£‰r
 = 
f2fs_£‰r
,

1223 .
	gg‘_aş
 = 
f2fs_g‘_aş
,

1224 .
	g£t_aş
 = 
f2fs_£t_aş
,

1225 #ifdeà
CONFIG_F2FS_FS_XATTR


1226 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

1230 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_symlšk_šode_İ”©iÚs
 = {

1231 .
g‘_lšk
 = 
f2fs_g‘_lšk
,

1232 .
	gg‘©Œ
 = 
f2fs_g‘©Œ
,

1233 .
	g£‰r
 = 
f2fs_£‰r
,

1234 #ifdeà
CONFIG_F2FS_FS_XATTR


1235 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

1239 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_¥ecŸl_šode_İ”©iÚs
 = {

1240 .
g‘©Œ
 = 
f2fs_g‘©Œ
,

1241 .
	g£‰r
 = 
f2fs_£‰r
,

1242 .
	gg‘_aş
 = 
f2fs_g‘_aş
,

1243 .
	g£t_aş
 = 
f2fs_£t_aş
,

1244 #ifdeà
CONFIG_F2FS_FS_XATTR


1245 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

	@fs/f2fs/node.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/m·ge.h
>

14 
	~<lšux/backšg-dev.h
>

15 
	~<lšux/blkdev.h
>

16 
	~<lšux/·gevec.h
>

17 
	~<lšux/sw­.h
>

19 
	~"f2fs.h
"

20 
	~"node.h
"

21 
	~"£gm’t.h
"

22 
	~"x©Œ.h
"

23 
	~"Œaû.h
"

24 
	~<Œaû/ev’ts/f2fs.h
>

26 
	#Ú_f2fs_bud_ä“_nids
(
nmi
è
	`mu‹x_is_locked
(&(
nm_i
)->
bud_lock
)

	)

28 
kmem_ÿche
 *
	gÇt_’Œy_¦ab
;

29 
kmem_ÿche
 *
	gä“_nid_¦ab
;

30 
kmem_ÿche
 *
	gÇt_’Œy_£t_¦ab
;

35 
	$f2fs_check_nid_¿nge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

37 ià(
	`uÆik–y
(
nid
 < 
	`F2FS_ROOT_INO
(
sbi
è||‚id >ğ
	`NM_I
(sbi)->
max_nid
)) {

38 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

39 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

41 
__func__
, 
nid
);

42  -
EINVAL
;

45 
	}
}

47 
boŞ
 
	$f2fs_avaabË_ä“_memÜy
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

49 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

50 
sysšfo
 
v®
;

51 
ava_¿m
;

52 
mem_size
 = 0;

53 
boŞ
 
»s
 = 
çl£
;

55 
	`si_memšfo
(&
v®
);

58 
ava_¿m
 = 
v®
.
tÙ®¿m
 - v®.
tÙ®high
;

63 ià(
ty³
 =ğ
FREE_NIDS
) {

64 
mem_size
 = (
nm_i
->
nid_út
[
FREE_NID
] *

65 (
ä“_nid
)è>> 
PAGE_SHIFT
;

66 
»s
 = 
mem_size
 < ((
ava_¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 2);

67 } ià(
ty³
 =ğ
NAT_ENTRIES
) {

68 
mem_size
 = (
nm_i
->
Çt_út
 * (
Çt_’Œy
)) >>

69 
PAGE_SHIFT
;

70 
»s
 = 
mem_size
 < ((
ava_¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 2);

71 ià(
	`exûss_ÿched_Çts
(
sbi
))

72 
»s
 = 
çl£
;

73 } ià(
ty³
 =ğ
DIRTY_DENTS
) {

74 ià(
sbi
->
sb
->
s_bdi
->
wb
.
dœty_exûeded
)

75  
çl£
;

76 
mem_size
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
);

77 
»s
 = 
mem_size
 < ((
ava_¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 1);

78 } ià(
ty³
 =ğ
INO_ENTRIES
) {

79 
i
;

81 
i
 = 0; i < 
MAX_INO_ENTRY
; i++)

82 
mem_size
 +ğ
sbi
->
im
[
i
].
šo_num
 *

83 (
šo_’Œy
);

84 
mem_size
 >>ğ
PAGE_SHIFT
;

85 
»s
 = 
mem_size
 < ((
ava_¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 1);

86 } ià(
ty³
 =ğ
EXTENT_CACHE
) {

87 
mem_size
 = (
	`©omic_»ad
(&
sbi
->
tÙ®_ext_Œ“
) *

88 (
ex‹Á_Œ“
) +

89 
	`©omic_»ad
(&
sbi
->
tÙ®_ext_node
) *

90 (
ex‹Á_node
)è>> 
PAGE_SHIFT
;

91 
»s
 = 
mem_size
 < ((
ava_¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 1);

92 } ià(
ty³
 =ğ
INMEM_PAGES
) {

94 
mem_size
 = 
	`g‘_·ges
(
sbi
, 
F2FS_INMEM_PAGES
);

95 
»s
 = 
mem_size
 < (
v®
.
tÙ®¿m
 / 5);

97 ià(!
sbi
->
sb
->
s_bdi
->
wb
.
dœty_exûeded
)

98  
Œue
;

100  
»s
;

101 
	}
}

103 
	$ş—r_node_·ge_dœty
(
·ge
 *page)

105 ià(
	`PageDœty
(
·ge
)) {

106 
	`f2fs_ş—r_¿dix_Œ“_dœty_g
(
·ge
);

107 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

108 
	`dec_·ge_couÁ
(
	`F2FS_P_SB
(
·ge
), 
F2FS_DIRTY_NODES
);

110 
	`CË¬PageU±od©e
(
·ge
);

111 
	}
}

113 
·ge
 *
	$g‘_cu¼’t_Çt_·ge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

115 
pgoff_t
 
šdex
 = 
	`cu¼’t_Çt_addr
(
sbi
, 
nid
);

116  
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
šdex
);

117 
	}
}

119 
·ge
 *
	$g‘_Ãxt_Çt_·ge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

121 
·ge
 *
¤c_·ge
;

122 
·ge
 *
d¡_·ge
;

123 
pgoff_t
 
¤c_off
;

124 
pgoff_t
 
d¡_off
;

125 *
¤c_addr
;

126 *
d¡_addr
;

127 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

129 
¤c_off
 = 
	`cu¼’t_Çt_addr
(
sbi
, 
nid
);

130 
d¡_off
 = 
	`Ãxt_Çt_addr
(
sbi
, 
¤c_off
);

133 
¤c_·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
¤c_off
);

134 
d¡_·ge
 = 
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
d¡_off
);

135 
	`f2fs_bug_Ú
(
sbi
, 
	`PageDœty
(
¤c_·ge
));

137 
¤c_addr
 = 
	`·ge_add»ss
(
¤c_·ge
);

138 
d¡_addr
 = 
	`·ge_add»ss
(
d¡_·ge
);

139 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
PAGE_SIZE
);

140 
	`£t_·ge_dœty
(
d¡_·ge
);

141 
	`f2fs_put_·ge
(
¤c_·ge
, 1);

143 
	`£t_to_Ãxt_Çt
(
nm_i
, 
nid
);

145  
d¡_·ge
;

146 
	}
}

148 
Çt_’Œy
 *
	$__®loc_Çt_’Œy
(
nid_t
 
nid
, 
boŞ
 
no_ç
)

150 
Çt_’Œy
 *
Ãw
;

152 ià(
no_ç
)

153 
Ãw
 = 
	`f2fs_kmem_ÿche_®loc
(
Çt_’Œy_¦ab
, 
GFP_F2FS_ZERO
);

155 
Ãw
 = 
	`kmem_ÿche_®loc
(
Çt_’Œy_¦ab
, 
GFP_F2FS_ZERO
);

156 ià(
Ãw
) {

157 
	`Çt_£t_nid
(
Ãw
, 
nid
);

158 
	`Çt_»£t_æag
(
Ãw
);

160  
Ãw
;

161 
	}
}

163 
	$__ä“_Çt_’Œy
(
Çt_’Œy
 *
e
)

165 
	`kmem_ÿche_ä“
(
Çt_’Œy_¦ab
, 
e
);

166 
	}
}

169 
Çt_’Œy
 *
	$__š™_Çt_’Œy
(
f2fs_nm_šfo
 *
nm_i
,

170 
Çt_’Œy
 *
Ã
, 
f2fs_Çt_’Œy
 *
¿w_Ã
, 
boŞ
 
no_ç
)

172 ià(
no_ç
)

173 
	`f2fs_¿dix_Œ“_š£¹
(&
nm_i
->
Çt_roÙ
, 
	`Çt_g‘_nid
(
Ã
),‚e);

174 ià(
	`¿dix_Œ“_š£¹
(&
nm_i
->
Çt_roÙ
, 
	`Çt_g‘_nid
(
Ã
),‚e))

175  
NULL
;

177 ià(
¿w_Ã
)

178 
	`node_šfo_äom_¿w_Çt
(&
Ã
->
ni
, 
¿w_Ã
);

179 
	`li¡_add_
(&
Ã
->
li¡
, &
nm_i
->
Çt_’Œ›s
);

180 
nm_i
->
Çt_út
++;

181  
Ã
;

182 
	}
}

184 
Çt_’Œy
 *
	$__lookup_Çt_ÿche
(
f2fs_nm_šfo
 *
nm_i
, 
nid_t
 
n
)

186  
	`¿dix_Œ“_lookup
(&
nm_i
->
Çt_roÙ
, 
n
);

187 
	}
}

189 
	$__gªg_lookup_Çt_ÿche
(
f2fs_nm_šfo
 *
nm_i
,

190 
nid_t
 
¡¬t
, 
Ä
, 
Çt_’Œy
 **
•
)

192  
	`¿dix_Œ“_gªg_lookup
(&
nm_i
->
Çt_roÙ
, (**)
•
, 
¡¬t
, 
Ä
);

193 
	}
}

195 
	$__d–_äom_Çt_ÿche
(
f2fs_nm_šfo
 *
nm_i
, 
Çt_’Œy
 *
e
)

197 
	`li¡_d–
(&
e
->
li¡
);

198 
	`¿dix_Œ“_d–‘e
(&
nm_i
->
Çt_roÙ
, 
	`Çt_g‘_nid
(
e
));

199 
nm_i
->
Çt_út
--;

200 
	`__ä“_Çt_’Œy
(
e
);

201 
	}
}

203 
Çt_’Œy_£t
 *
	$__g¿b_Çt_’Œy_£t
(
f2fs_nm_šfo
 *
nm_i
,

204 
Çt_’Œy
 *
Ã
)

206 
nid_t
 
£t
 = 
	`NAT_BLOCK_OFFSET
(
Ã
->
ni
.
nid
);

207 
Çt_’Œy_£t
 *
h—d
;

209 
h—d
 = 
	`¿dix_Œ“_lookup
(&
nm_i
->
Çt_£t_roÙ
, 
£t
);

210 ià(!
h—d
) {

211 
h—d
 = 
	`f2fs_kmem_ÿche_®loc
(
Çt_’Œy_£t_¦ab
, 
GFP_NOFS
);

213 
	`INIT_LIST_HEAD
(&
h—d
->
’Œy_li¡
);

214 
	`INIT_LIST_HEAD
(&
h—d
->
£t_li¡
);

215 
h—d
->
£t
 = set;

216 
h—d
->
’Œy_út
 = 0;

217 
	`f2fs_¿dix_Œ“_š£¹
(&
nm_i
->
Çt_£t_roÙ
, 
£t
, 
h—d
);

219  
h—d
;

220 
	}
}

222 
	$__£t_Çt_ÿche_dœty
(
f2fs_nm_šfo
 *
nm_i
,

223 
Çt_’Œy
 *
Ã
)

225 
Çt_’Œy_£t
 *
h—d
;

226 
boŞ
 
Ãw_Ã
 = 
	`Çt_g‘_blkaddr
(
Ã
è=ğ
NEW_ADDR
;

228 ià(!
Ãw_Ã
)

229 
h—d
 = 
	`__g¿b_Çt_’Œy_£t
(
nm_i
, 
Ã
);

236 ià(!
Ãw_Ã
 && (
	`g‘_Çt_æag
(
Ã
, 
IS_PREALLOC
) ||

237 !
	`g‘_Çt_æag
(
Ã
, 
IS_DIRTY
)))

238 
h—d
->
’Œy_út
++;

240 
	`£t_Çt_æag
(
Ã
, 
IS_PREALLOC
, 
Ãw_Ã
);

242 ià(
	`g‘_Çt_æag
(
Ã
, 
IS_DIRTY
))

243 
»äesh_li¡
;

245 
nm_i
->
dœty_Çt_út
++;

246 
	`£t_Çt_æag
(
Ã
, 
IS_DIRTY
, 
Œue
);

247 
»äesh_li¡
:

248 ià(
Ãw_Ã
)

249 
	`li¡_d–_š™
(&
Ã
->
li¡
);

251 
	`li¡_move_
(&
Ã
->
li¡
, &
h—d
->
’Œy_li¡
);

252 
	}
}

254 
	$__ş—r_Çt_ÿche_dœty
(
f2fs_nm_šfo
 *
nm_i
,

255 
Çt_’Œy_£t
 *
£t
, 
Çt_’Œy
 *
Ã
)

257 
	`li¡_move_
(&
Ã
->
li¡
, &
nm_i
->
Çt_’Œ›s
);

258 
	`£t_Çt_æag
(
Ã
, 
IS_DIRTY
, 
çl£
);

259 
£t
->
’Œy_út
--;

260 
nm_i
->
dœty_Çt_út
--;

261 
	}
}

263 
	$__gªg_lookup_Çt_£t
(
f2fs_nm_šfo
 *
nm_i
,

264 
nid_t
 
¡¬t
, 
Ä
, 
Çt_’Œy_£t
 **
•
)

266  
	`¿dix_Œ“_gªg_lookup
(&
nm_i
->
Çt_£t_roÙ
, (**)
•
,

267 
¡¬t
, 
Ä
);

268 
	}
}

270 
	$f2fs_Ãed_d’Œy_m¬k
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

272 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

273 
Çt_’Œy
 *
e
;

274 
boŞ
 
Ãed
 = 
çl£
;

276 
	`down_»ad
(&
nm_i
->
Çt_Œ“_lock
);

277 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

278 ià(
e
) {

279 ià(!
	`g‘_Çt_æag
(
e
, 
IS_CHECKPOINTED
) &&

280 !
	`g‘_Çt_æag
(
e
, 
HAS_FSYNCED_INODE
))

281 
Ãed
 = 
Œue
;

283 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

284  
Ãed
;

285 
	}
}

287 
boŞ
 
	$f2fs_is_checkpoš‹d_node
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

289 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

290 
Çt_’Œy
 *
e
;

291 
boŞ
 
is_ı
 = 
Œue
;

293 
	`down_»ad
(&
nm_i
->
Çt_Œ“_lock
);

294 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

295 ià(
e
 && !
	`g‘_Çt_æag
Ó, 
IS_CHECKPOINTED
))

296 
is_ı
 = 
çl£
;

297 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

298  
is_ı
;

299 
	}
}

301 
boŞ
 
	$f2fs_Ãed_šode_block_upd©e
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

303 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

304 
Çt_’Œy
 *
e
;

305 
boŞ
 
Ãed_upd©e
 = 
Œue
;

307 
	`down_»ad
(&
nm_i
->
Çt_Œ“_lock
);

308 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
šo
);

309 ià(
e
 && 
	`g‘_Çt_æag
Ó, 
HAS_LAST_FSYNC
) &&

310 (
	`g‘_Çt_æag
(
e
, 
IS_CHECKPOINTED
) ||

311 
	`g‘_Çt_æag
(
e
, 
HAS_FSYNCED_INODE
)))

312 
Ãed_upd©e
 = 
çl£
;

313 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

314  
Ãed_upd©e
;

315 
	}
}

318 
	$ÿche_Çt_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
,

319 
f2fs_Çt_’Œy
 *
Ã
)

321 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

322 
Çt_’Œy
 *
Ãw
, *
e
;

324 
Ãw
 = 
	`__®loc_Çt_’Œy
(
nid
, 
çl£
);

325 ià(!
Ãw
)

328 
	`down_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

329 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

330 ià(!
e
)

331 
e
 = 
	`__š™_Çt_’Œy
(
nm_i
, 
Ãw
, 
Ã
, 
çl£
);

333 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_šo
(
e
è!ğ
	`Ë32_to_ıu
(
Ã
->
šo
) ||

334 
	`Çt_g‘_blkaddr
(
e
) !=

335 
	`Ë32_to_ıu
(
Ã
->
block_addr
) ||

336 
	`Çt_g‘_v”siÚ
(
e
è!ğ
Ã
->
v”siÚ
);

337 
	`up_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

338 ià(
e
 !ğ
Ãw
)

339 
	`__ä“_Çt_’Œy
(
Ãw
);

340 
	}
}

342 
	$£t_node_addr
(
f2fs_sb_šfo
 *
sbi
, 
node_šfo
 *
ni
,

343 
block_t
 
Ãw_blkaddr
, 
boŞ
 
fsync_dÚe
)

345 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

346 
Çt_’Œy
 *
e
;

347 
Çt_’Œy
 *
Ãw
 = 
	`__®loc_Çt_’Œy
(
ni
->
nid
, 
Œue
);

349 
	`down_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

350 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
ni
->
nid
);

351 ià(!
e
) {

352 
e
 = 
	`__š™_Çt_’Œy
(
nm_i
, 
Ãw
, 
NULL
, 
Œue
);

353 
	`cİy_node_šfo
(&
e
->
ni
,‚i);

354 
	`f2fs_bug_Ú
(
sbi
, 
ni
->
blk_addr
 =ğ
NEW_ADDR
);

355 } ià(
Ãw_blkaddr
 =ğ
NEW_ADDR
) {

361 
	`cİy_node_šfo
(&
e
->
ni
,‚i);

362 
	`f2fs_bug_Ú
(
sbi
, 
ni
->
blk_addr
 !ğ
NULL_ADDR
);

365 ià(
e
 !ğ
Ãw
)

366 
	`__ä“_Çt_’Œy
(
Ãw
);

369 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_blkaddr
(
e
è!ğ
ni
->
blk_addr
);

370 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_blkaddr
(
e
è=ğ
NULL_ADDR
 &&

371 
Ãw_blkaddr
 =ğ
NULL_ADDR
);

372 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_blkaddr
(
e
è=ğ
NEW_ADDR
 &&

373 
Ãw_blkaddr
 =ğ
NEW_ADDR
);

374 
	`f2fs_bug_Ú
(
sbi
, 
	`is_v®id_blkaddr
(
	`Çt_g‘_blkaddr
(
e
)) &&

375 
Ãw_blkaddr
 =ğ
NEW_ADDR
);

378 ià(
	`Çt_g‘_blkaddr
(
e
è!ğ
NEW_ADDR
 && 
Ãw_blkaddr
 =ğ
NULL_ADDR
) {

379 
v”siÚ
 = 
	`Çt_g‘_v”siÚ
(
e
);

380 
	`Çt_£t_v”siÚ
(
e
, 
	`šc_node_v”siÚ
(
v”siÚ
));

384 
	`Çt_£t_blkaddr
(
e
, 
Ãw_blkaddr
);

385 ià(!
	`is_v®id_blkaddr
(
Ãw_blkaddr
))

386 
	`£t_Çt_æag
(
e
, 
IS_CHECKPOINTED
, 
çl£
);

387 
	`__£t_Çt_ÿche_dœty
(
nm_i
, 
e
);

390 ià(
ni
->
nid
 !ğni->
šo
)

391 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
ni
->
šo
);

392 ià(
e
) {

393 ià(
fsync_dÚe
 && 
ni
->
nid
 =ğni->
šo
)

394 
	`£t_Çt_æag
(
e
, 
HAS_FSYNCED_INODE
, 
Œue
);

395 
	`£t_Çt_æag
(
e
, 
HAS_LAST_FSYNC
, 
fsync_dÚe
);

397 
	`up_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

398 
	}
}

400 
	$f2fs_Œy_to_ä“_Çts
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
)

402 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

403 
Ä
 = 
Ä_shršk
;

405 ià(!
	`down_wr™e_Œylock
(&
nm_i
->
Çt_Œ“_lock
))

408 
Ä_shršk
 && !
	`li¡_em±y
(&
nm_i
->
Çt_’Œ›s
)) {

409 
Çt_’Œy
 *
Ã
;

410 
Ã
 = 
	`li¡_fœ¡_’Œy
(&
nm_i
->
Çt_’Œ›s
,

411 
Çt_’Œy
, 
li¡
);

412 
	`__d–_äom_Çt_ÿche
(
nm_i
, 
Ã
);

413 
Ä_shršk
--;

415 
	`up_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

416  
Ä
 - 
Ä_shršk
;

417 
	}
}

422 
	$f2fs_g‘_node_šfo
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
,

423 
node_šfo
 *
ni
)

425 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

426 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

427 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

428 
nid_t
 
¡¬t_nid
 = 
	`START_NID
(
nid
);

429 
f2fs_Çt_block
 *
Çt_blk
;

430 
·ge
 *·gğ
NULL
;

431 
f2fs_Çt_’Œy
 
Ã
;

432 
Çt_’Œy
 *
e
;

433 
pgoff_t
 
šdex
;

434 
i
;

436 
ni
->
nid
 =‚id;

439 
	`down_»ad
(&
nm_i
->
Çt_Œ“_lock
);

440 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

441 ià(
e
) {

442 
ni
->
šo
 = 
	`Çt_g‘_šo
(
e
);

443 
ni
->
blk_addr
 = 
	`Çt_g‘_blkaddr
(
e
);

444 
ni
->
v”siÚ
 = 
	`Çt_g‘_v”siÚ
(
e
);

445 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

449 
	`mem£t
(&
Ã
, 0, (
f2fs_Çt_’Œy
));

452 
	`down_»ad
(&
cur£g
->
jouº®_rw£m
);

453 
i
 = 
	`f2fs_lookup_jouº®_š_cursum
(
jouº®
, 
NAT_JOURNAL
, 
nid
, 0);

454 ià(
i
 >= 0) {

455 
Ã
 = 
	`Çt_š_jouº®
(
jouº®
, 
i
);

456 
	`node_šfo_äom_¿w_Çt
(
ni
, &
Ã
);

458 
	`up_»ad
(&
cur£g
->
jouº®_rw£m
);

459 ià(
i
 >= 0) {

460 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

461 
ÿche
;

465 
šdex
 = 
	`cu¼’t_Çt_addr
(
sbi
, 
nid
);

466 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

468 
·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
šdex
);

469 
Çt_blk
 = (
f2fs_Çt_block
 *)
	`·ge_add»ss
(
·ge
);

470 
Ã
 = 
Çt_blk
->
’Œ›s
[
nid
 - 
¡¬t_nid
];

471 
	`node_šfo_äom_¿w_Çt
(
ni
, &
Ã
);

472 
	`f2fs_put_·ge
(
·ge
, 1);

473 
ÿche
:

475 
	`ÿche_Çt_’Œy
(
sbi
, 
nid
, &
Ã
);

476 
	}
}

481 
	$f2fs_¿_node_·ges
(
·ge
 *
·»Á
, 
¡¬t
, 
n
)

483 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·»Á
);

484 
blk_¶ug
 
¶ug
;

485 
i
, 
’d
;

486 
nid_t
 
nid
;

488 
	`blk_¡¬t_¶ug
(&
¶ug
);

491 
’d
 = 
¡¬t
 + 
n
;

492 
’d
 = 
	`mš
Ónd, 
NIDS_PER_BLOCK
);

493 
i
 = 
¡¬t
; i < 
’d
; i++) {

494 
nid
 = 
	`g‘_nid
(
·»Á
, 
i
, 
çl£
);

495 
	`f2fs_¿_node_·ge
(
sbi
, 
nid
);

498 
	`blk_fšish_¶ug
(&
¶ug
);

499 
	}
}

501 
pgoff_t
 
	$f2fs_g‘_Ãxt_·ge_off£t
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
pgofs
)

503 cÚ¡ 
dœeù_šdex
 = 
	`ADDRS_PER_INODE
(
dn
->
šode
);

504 cÚ¡ 
dœeù_blks
 = 
ADDRS_PER_BLOCK
;

505 cÚ¡ 
šdœeù_blks
 = 
ADDRS_PER_BLOCK
 * 
NIDS_PER_BLOCK
;

506 
sk³d_un™
 = 
ADDRS_PER_BLOCK
;

507 
cur_Ëv–
 = 
dn
->cur_level;

508 
max_Ëv–
 = 
dn
->max_level;

509 
pgoff_t
 
ba£
 = 0;

511 ià(!
dn
->
max_Ëv–
)

512  
pgofs
 + 1;

514 
max_Ëv–
-- > 
cur_Ëv–
)

515 
sk³d_un™
 *ğ
NIDS_PER_BLOCK
;

517 
dn
->
max_Ëv–
) {

519 
ba£
 +ğ2 * 
šdœeù_blks
;

521 
ba£
 +ğ2 * 
dœeù_blks
;

523 
ba£
 +ğ
dœeù_šdex
;

526 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
dn
->
šode
), 1);

529  ((
pgofs
 - 
ba£
è/ 
sk³d_un™
 + 1) * skipped_unit + base;

530 
	}
}

536 
	$g‘_node_·th
(
šode
 *šode, 
block
,

537 
off£t
[4], 
noff£t
[4])

539 cÚ¡ 
dœeù_šdex
 = 
	`ADDRS_PER_INODE
(
šode
);

540 cÚ¡ 
dœeù_blks
 = 
ADDRS_PER_BLOCK
;

541 cÚ¡ 
d±rs_³r_blk
 = 
NIDS_PER_BLOCK
;

542 cÚ¡ 
šdœeù_blks
 = 
ADDRS_PER_BLOCK
 * 
NIDS_PER_BLOCK
;

543 cÚ¡ 
dšdœeù_blks
 = 
šdœeù_blks
 * 
NIDS_PER_BLOCK
;

544 
n
 = 0;

545 
Ëv–
 = 0;

547 
noff£t
[0] = 0;

549 ià(
block
 < 
dœeù_šdex
) {

550 
off£t
[
n
] = 
block
;

551 
gÙ
;

553 
block
 -ğ
dœeù_šdex
;

554 ià(
block
 < 
dœeù_blks
) {

555 
off£t
[
n
++] = 
NODE_DIR1_BLOCK
;

556 
noff£t
[
n
] = 1;

557 
off£t
[
n
] = 
block
;

558 
Ëv–
 = 1;

559 
gÙ
;

561 
block
 -ğ
dœeù_blks
;

562 ià(
block
 < 
dœeù_blks
) {

563 
off£t
[
n
++] = 
NODE_DIR2_BLOCK
;

564 
noff£t
[
n
] = 2;

565 
off£t
[
n
] = 
block
;

566 
Ëv–
 = 1;

567 
gÙ
;

569 
block
 -ğ
dœeù_blks
;

570 ià(
block
 < 
šdœeù_blks
) {

571 
off£t
[
n
++] = 
NODE_IND1_BLOCK
;

572 
noff£t
[
n
] = 3;

573 
off£t
[
n
++] = 
block
 / 
dœeù_blks
;

574 
noff£t
[
n
] = 4 + 
off£t
[n - 1];

575 
off£t
[
n
] = 
block
 % 
dœeù_blks
;

576 
Ëv–
 = 2;

577 
gÙ
;

579 
block
 -ğ
šdœeù_blks
;

580 ià(
block
 < 
šdœeù_blks
) {

581 
off£t
[
n
++] = 
NODE_IND2_BLOCK
;

582 
noff£t
[
n
] = 4 + 
d±rs_³r_blk
;

583 
off£t
[
n
++] = 
block
 / 
dœeù_blks
;

584 
noff£t
[
n
] = 5 + 
d±rs_³r_blk
 + 
off£t
[n - 1];

585 
off£t
[
n
] = 
block
 % 
dœeù_blks
;

586 
Ëv–
 = 2;

587 
gÙ
;

589 
block
 -ğ
šdœeù_blks
;

590 ià(
block
 < 
dšdœeù_blks
) {

591 
off£t
[
n
++] = 
NODE_DIND_BLOCK
;

592 
noff£t
[
n
] = 5 + (
d±rs_³r_blk
 * 2);

593 
off£t
[
n
++] = 
block
 / 
šdœeù_blks
;

594 
noff£t
[
n
] = 6 + (
d±rs_³r_blk
 * 2) +

595 
off£t
[
n
 - 1] * (
d±rs_³r_blk
 + 1);

596 
off£t
[
n
++] = (
block
 / 
dœeù_blks
è% 
d±rs_³r_blk
;

597 
noff£t
[
n
] = 7 + (
d±rs_³r_blk
 * 2) +

598 
off£t
[
n
 - 2] * (
d±rs_³r_blk
 + 1) +

599 
off£t
[
n
 - 1];

600 
off£t
[
n
] = 
block
 % 
dœeù_blks
;

601 
Ëv–
 = 3;

602 
gÙ
;

604  -
E2BIG
;

606 
gÙ
:

607  
Ëv–
;

608 
	}
}

616 
	$f2fs_g‘_dnode_of_d©a
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
, 
mode
)

618 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

619 
·ge
 *
Åage
[4];

620 
·ge
 *
·»Á
 = 
NULL
;

621 
off£t
[4];

622 
noff£t
[4];

623 
nid_t
 
nids
[4];

624 
Ëv–
, 
i
 = 0;

625 
”r
 = 0;

627 
Ëv–
 = 
	`g‘_node_·th
(
dn
->
šode
, 
šdex
, 
off£t
, 
noff£t
);

628 ià(
Ëv–
 < 0)

629  
Ëv–
;

631 
nids
[0] = 
dn
->
šode
->
i_šo
;

632 
Åage
[0] = 
dn
->
šode_·ge
;

634 ià(!
Åage
[0]) {

635 
Åage
[0] = 
	`f2fs_g‘_node_·ge
(
sbi
, 
nids
[0]);

636 ià(
	`IS_ERR
(
Åage
[0]))

637  
	`PTR_ERR
(
Åage
[0]);

641 ià(
	`f2fs_has_šlše_d©a
(
dn
->
šode
è&& 
šdex
) {

642 
”r
 = -
ENOENT
;

643 
	`f2fs_put_·ge
(
Åage
[0], 1);

644 
»Ëa£_out
;

647 
·»Á
 = 
Åage
[0];

648 ià(
Ëv–
 != 0)

649 
nids
[1] = 
	`g‘_nid
(
·»Á
, 
off£t
[0], 
Œue
);

650 
dn
->
šode_·ge
 = 
Åage
[0];

651 
dn
->
šode_·ge_locked
 = 
Œue
;

654 
i
 = 1; i <ğ
Ëv–
; i++) {

655 
boŞ
 
dÚe
 = 
çl£
;

657 ià(!
nids
[
i
] && 
mode
 =ğ
ALLOC_NODE
) {

659 ià(!
	`f2fs_®loc_nid
(
sbi
, &(
nids
[
i
]))) {

660 
”r
 = -
ENOSPC
;

661 
»Ëa£_·ges
;

664 
dn
->
nid
 = 
nids
[
i
];

665 
Åage
[
i
] = 
	`f2fs_Ãw_node_·ge
(
dn
, 
noff£t
[i]);

666 ià(
	`IS_ERR
(
Åage
[
i
])) {

667 
	`f2fs_®loc_nid_çed
(
sbi
, 
nids
[
i
]);

668 
”r
 = 
	`PTR_ERR
(
Åage
[
i
]);

669 
»Ëa£_·ges
;

672 
	`£t_nid
(
·»Á
, 
off£t
[
i
 - 1], 
nids
[i], i == 1);

673 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
nids
[
i
]);

674 
dÚe
 = 
Œue
;

675 } ià(
mode
 =ğ
LOOKUP_NODE_RA
 && 
i
 =ğ
Ëv–
 &&†evel > 1) {

676 
Åage
[
i
] = 
	`f2fs_g‘_node_·ge_¿
(
·»Á
, 
off£t
[i - 1]);

677 ià(
	`IS_ERR
(
Åage
[
i
])) {

678 
”r
 = 
	`PTR_ERR
(
Åage
[
i
]);

679 
»Ëa£_·ges
;

681 
dÚe
 = 
Œue
;

683 ià(
i
 == 1) {

684 
dn
->
šode_·ge_locked
 = 
çl£
;

685 
	`uÆock_·ge
(
·»Á
);

687 
	`f2fs_put_·ge
(
·»Á
, 1);

690 ià(!
dÚe
) {

691 
Åage
[
i
] = 
	`f2fs_g‘_node_·ge
(
sbi
, 
nids
[i]);

692 ià(
	`IS_ERR
(
Åage
[
i
])) {

693 
”r
 = 
	`PTR_ERR
(
Åage
[
i
]);

694 
	`f2fs_put_·ge
(
Åage
[0], 0);

695 
»Ëa£_out
;

698 ià(
i
 < 
Ëv–
) {

699 
·»Á
 = 
Åage
[
i
];

700 
nids
[
i
 + 1] = 
	`g‘_nid
(
·»Á
, 
off£t
[i], 
çl£
);

703 
dn
->
nid
 = 
nids
[
Ëv–
];

704 
dn
->
ofs_š_node
 = 
off£t
[
Ëv–
];

705 
dn
->
node_·ge
 = 
Åage
[
Ëv–
];

706 
dn
->
d©a_blkaddr
 = 
	`d©ablock_addr
(dn->
šode
,

707 
dn
->
node_·ge
, dn->
ofs_š_node
);

710 
»Ëa£_·ges
:

711 
	`f2fs_put_·ge
(
·»Á
, 1);

712 ià(
i
 > 1)

713 
	`f2fs_put_·ge
(
Åage
[0], 0);

714 
»Ëa£_out
:

715 
dn
->
šode_·ge
 = 
NULL
;

716 
dn
->
node_·ge
 = 
NULL
;

717 ià(
”r
 =ğ-
ENOENT
) {

718 
dn
->
cur_Ëv–
 = 
i
;

719 
dn
->
max_Ëv–
 = 
Ëv–
;

720 
dn
->
ofs_š_node
 = 
off£t
[
Ëv–
];

722  
”r
;

723 
	}
}

725 
	$Œunÿ‹_node
(
dnode_of_d©a
 *
dn
)

727 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

728 
node_šfo
 
ni
;

730 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
->
nid
, &
ni
);

733 
	`f2fs_šv®id©e_blocks
(
sbi
, 
ni
.
blk_addr
);

734 
	`dec_v®id_node_couÁ
(
sbi
, 
dn
->
šode
, dn->
nid
 =ğdn->šode->
i_šo
);

735 
	`£t_node_addr
(
sbi
, &
ni
, 
NULL_ADDR
, 
çl£
);

737 ià(
dn
->
nid
 =ğdn->
šode
->
i_šo
) {

738 
	`f2fs_»move_Üphª_šode
(
sbi
, 
dn
->
nid
);

739 
	`dec_v®id_šode_couÁ
(
sbi
);

740 
	`f2fs_šode_synûd
(
dn
->
šode
);

743 
	`ş—r_node_·ge_dœty
(
dn
->
node_·ge
);

744 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_DIRTY
);

746 
	`f2fs_put_·ge
(
dn
->
node_·ge
, 1);

748 
	`šv®id©e_m­pšg_·ges
(
	`NODE_MAPPING
(
sbi
),

749 
dn
->
node_·ge
->
šdex
, dn->node_page->index);

751 
dn
->
node_·ge
 = 
NULL
;

752 
	`Œaû_f2fs_Œunÿ‹_node
(
dn
->
šode
, dn->
nid
, 
ni
.
blk_addr
);

753 
	}
}

755 
	$Œunÿ‹_dnode
(
dnode_of_d©a
 *
dn
)

757 
·ge
 *page;

759 ià(
dn
->
nid
 == 0)

763 
·ge
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
dn
->
šode
), dn->
nid
);

764 ià(
	`IS_ERR
(
·ge
è&& 
	`PTR_ERR
Õageè=ğ-
ENOENT
)

766 ià(
	`IS_ERR
(
·ge
))

767  
	`PTR_ERR
(
·ge
);

770 
dn
->
node_·ge
 = 
·ge
;

771 
dn
->
ofs_š_node
 = 0;

772 
	`f2fs_Œunÿ‹_d©a_blocks
(
dn
);

773 
	`Œunÿ‹_node
(
dn
);

775 
	}
}

777 
	$Œunÿ‹_nodes
(
dnode_of_d©a
 *
dn
, 
nofs
,

778 
ofs
, 
d•th
)

780 
dnode_of_d©a
 
rdn
 = *
dn
;

781 
·ge
 *page;

782 
f2fs_node
 *
º
;

783 
nid_t
 
chd_nid
;

784 
chd_nofs
;

785 
ä“d
 = 0;

786 
i
, 
»t
;

788 ià(
dn
->
nid
 == 0)

789  
NIDS_PER_BLOCK
 + 1;

791 
	`Œaû_f2fs_Œunÿ‹_nodes_’‹r
(
dn
->
šode
, dn->
nid
, dn->
d©a_blkaddr
);

793 
·ge
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
dn
->
šode
), dn->
nid
);

794 ià(
	`IS_ERR
(
·ge
)) {

795 
	`Œaû_f2fs_Œunÿ‹_nodes_ex™
(
dn
->
šode
, 
	`PTR_ERR
(
·ge
));

796  
	`PTR_ERR
(
·ge
);

799 
	`f2fs_¿_node_·ges
(
·ge
, 
ofs
, 
NIDS_PER_BLOCK
);

801 
º
 = 
	`F2FS_NODE
(
·ge
);

802 ià(
d•th
 < 3) {

803 
i
 = 
ofs
; i < 
NIDS_PER_BLOCK
; i++, 
ä“d
++) {

804 
chd_nid
 = 
	`Ë32_to_ıu
(
º
->
š
.
nid
[
i
]);

805 ià(
chd_nid
 == 0)

807 
rdn
.
nid
 = 
chd_nid
;

808 
»t
 = 
	`Œunÿ‹_dnode
(&
rdn
);

809 ià(
»t
 < 0)

810 
out_”r
;

811 ià(
	`£t_nid
(
·ge
, 
i
, 0, 
çl£
))

812 
dn
->
node_chªged
 = 
Œue
;

815 
chd_nofs
 = 
nofs
 + 
ofs
 * (
NIDS_PER_BLOCK
 + 1) + 1;

816 
i
 = 
ofs
; i < 
NIDS_PER_BLOCK
; i++) {

817 
chd_nid
 = 
	`Ë32_to_ıu
(
º
->
š
.
nid
[
i
]);

818 ià(
chd_nid
 == 0) {

819 
chd_nofs
 +ğ
NIDS_PER_BLOCK
 + 1;

822 
rdn
.
nid
 = 
chd_nid
;

823 
»t
 = 
	`Œunÿ‹_nodes
(&
rdn
, 
chd_nofs
, 0, 
d•th
 - 1);

824 ià(
»t
 =ğ(
NIDS_PER_BLOCK
 + 1)) {

825 ià(
	`£t_nid
(
·ge
, 
i
, 0, 
çl£
))

826 
dn
->
node_chªged
 = 
Œue
;

827 
chd_nofs
 +ğ
»t
;

828 } ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
) {

829 
out_”r
;

832 
ä“d
 = 
chd_nofs
;

835 ià(!
ofs
) {

837 
dn
->
node_·ge
 = 
·ge
;

838 
	`Œunÿ‹_node
(
dn
);

839 
ä“d
++;

841 
	`f2fs_put_·ge
(
·ge
, 1);

843 
	`Œaû_f2fs_Œunÿ‹_nodes_ex™
(
dn
->
šode
, 
ä“d
);

844  
ä“d
;

846 
out_”r
:

847 
	`f2fs_put_·ge
(
·ge
, 1);

848 
	`Œaû_f2fs_Œunÿ‹_nodes_ex™
(
dn
->
šode
, 
»t
);

849  
»t
;

850 
	}
}

852 
	$Œunÿ‹_·¹Ÿl_nodes
(
dnode_of_d©a
 *
dn
,

853 
f2fs_šode
 *
ri
, *
off£t
, 
d•th
)

855 
·ge
 *
·ges
[2];

856 
nid_t
 
nid
[3];

857 
nid_t
 
chd_nid
;

858 
”r
 = 0;

859 
i
;

860 
idx
 = 
d•th
 - 2;

862 
nid
[0] = 
	`Ë32_to_ıu
(
ri
->
i_nid
[
off£t
[0] - 
NODE_DIR1_BLOCK
]);

863 ià(!
nid
[0])

867 
i
 = 0; i < 
idx
 + 1; i++) {

869 
·ges
[
i
] = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
dn
->
šode
), 
nid
[i]);

870 ià(
	`IS_ERR
(
·ges
[
i
])) {

871 
”r
 = 
	`PTR_ERR
(
·ges
[
i
]);

872 
idx
 = 
i
 - 1;

873 
ç
;

875 
nid
[
i
 + 1] = 
	`g‘_nid
(
·ges
[i], 
off£t
[˜+ 1], 
çl£
);

878 
	`f2fs_¿_node_·ges
(
·ges
[
idx
], 
off£t
[idx + 1], 
NIDS_PER_BLOCK
);

881 
i
 = 
off£t
[
idx
 + 1]; i < 
NIDS_PER_BLOCK
; i++) {

882 
chd_nid
 = 
	`g‘_nid
(
·ges
[
idx
], 
i
, 
çl£
);

883 ià(!
chd_nid
)

885 
dn
->
nid
 = 
chd_nid
;

886 
”r
 = 
	`Œunÿ‹_dnode
(
dn
);

887 ià(
”r
 < 0)

888 
ç
;

889 ià(
	`£t_nid
(
·ges
[
idx
], 
i
, 0, 
çl£
))

890 
dn
->
node_chªged
 = 
Œue
;

893 ià(
off£t
[
idx
 + 1] == 0) {

894 
dn
->
node_·ge
 = 
·ges
[
idx
];

895 
dn
->
nid
 =‚id[
idx
];

896 
	`Œunÿ‹_node
(
dn
);

898 
	`f2fs_put_·ge
(
·ges
[
idx
], 1);

900 
off£t
[
idx
]++;

901 
off£t
[
idx
 + 1] = 0;

902 
idx
--;

903 
ç
:

904 
i
 = 
idx
; i >= 0; i--)

905 
	`f2fs_put_·ge
(
·ges
[
i
], 1);

907 
	`Œaû_f2fs_Œunÿ‹_·¹Ÿl_nodes
(
dn
->
šode
, 
nid
, 
d•th
, 
”r
);

909  
”r
;

910 
	}
}

915 
	$f2fs_Œunÿ‹_šode_blocks
(
šode
 *šode, 
pgoff_t
 
äom
)

917 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

918 
”r
 = 0, 
cÚt
 = 1;

919 
Ëv–
, 
off£t
[4], 
noff£t
[4];

920 
nofs
 = 0;

921 
f2fs_šode
 *
ri
;

922 
dnode_of_d©a
 
dn
;

923 
·ge
 *page;

925 
	`Œaû_f2fs_Œunÿ‹_šode_blocks_’‹r
(
šode
, 
äom
);

927 
Ëv–
 = 
	`g‘_node_·th
(
šode
, 
äom
, 
off£t
, 
noff£t
);

928 ià(
Ëv–
 < 0)

929  
Ëv–
;

931 
·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

932 ià(
	`IS_ERR
(
·ge
)) {

933 
	`Œaû_f2fs_Œunÿ‹_šode_blocks_ex™
(
šode
, 
	`PTR_ERR
(
·ge
));

934  
	`PTR_ERR
(
·ge
);

937 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
·ge
, 
NULL
, 0);

938 
	`uÆock_·ge
(
·ge
);

940 
ri
 = 
	`F2FS_INODE
(
·ge
);

941 
Ëv–
) {

944 
nofs
 = 
noff£t
[1];

947 
nofs
 = 
noff£t
[1];

948 ià(!
off£t
[
Ëv–
 - 1])

949 
sk_·¹Ÿl
;

950 
”r
 = 
	`Œunÿ‹_·¹Ÿl_nodes
(&
dn
, 
ri
, 
off£t
, 
Ëv–
);

951 ià(
”r
 < 0 &&ƒ¼ !ğ-
ENOENT
)

952 
ç
;

953 
nofs
 +ğ1 + 
NIDS_PER_BLOCK
;

956 
nofs
 = 5 + 2 * 
NIDS_PER_BLOCK
;

957 ià(!
off£t
[
Ëv–
 - 1])

958 
sk_·¹Ÿl
;

959 
”r
 = 
	`Œunÿ‹_·¹Ÿl_nodes
(&
dn
, 
ri
, 
off£t
, 
Ëv–
);

960 ià(
”r
 < 0 &&ƒ¼ !ğ-
ENOENT
)

961 
ç
;

964 
	`BUG
();

967 
sk_·¹Ÿl
:

968 
cÚt
) {

969 
dn
.
nid
 = 
	`Ë32_to_ıu
(
ri
->
i_nid
[
off£t
[0] - 
NODE_DIR1_BLOCK
]);

970 
off£t
[0]) {

971 
NODE_DIR1_BLOCK
:

972 
NODE_DIR2_BLOCK
:

973 
”r
 = 
	`Œunÿ‹_dnode
(&
dn
);

976 
NODE_IND1_BLOCK
:

977 
NODE_IND2_BLOCK
:

978 
”r
 = 
	`Œunÿ‹_nodes
(&
dn
, 
nofs
, 
off£t
[1], 2);

981 
NODE_DIND_BLOCK
:

982 
”r
 = 
	`Œunÿ‹_nodes
(&
dn
, 
nofs
, 
off£t
[1], 3);

983 
cÚt
 = 0;

987 
	`BUG
();

989 ià(
”r
 < 0 &&ƒ¼ !ğ-
ENOENT
)

990 
ç
;

991 ià(
off£t
[1] == 0 &&

992 
ri
->
i_nid
[
off£t
[0] - 
NODE_DIR1_BLOCK
]) {

993 
	`lock_·ge
(
·ge
);

994 
	`BUG_ON
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
));

995 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
, 
Œue
);

996 
ri
->
i_nid
[
off£t
[0] - 
NODE_DIR1_BLOCK
] = 0;

997 
	`£t_·ge_dœty
(
·ge
);

998 
	`uÆock_·ge
(
·ge
);

1000 
off£t
[1] = 0;

1001 
off£t
[0]++;

1002 
nofs
 +ğ
”r
;

1004 
ç
:

1005 
	`f2fs_put_·ge
(
·ge
, 0);

1006 
	`Œaû_f2fs_Œunÿ‹_šode_blocks_ex™
(
šode
, 
”r
);

1007  
”r
 > 0 ? 0 :ƒrr;

1008 
	}
}

1011 
	$f2fs_Œunÿ‹_x©Œ_node
(
šode
 *inode)

1013 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1014 
nid_t
 
nid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

1015 
dnode_of_d©a
 
dn
;

1016 
·ge
 *
Åage
;

1018 ià(!
nid
)

1021 
Åage
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
nid
);

1022 ià(
	`IS_ERR
(
Åage
))

1023  
	`PTR_ERR
(
Åage
);

1025 
	`f2fs_i_xnid_wr™e
(
šode
, 0);

1027 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, 
Åage
, 
nid
);

1028 
	`Œunÿ‹_node
(&
dn
);

1030 
	}
}

1036 
	$f2fs_»move_šode_·ge
(
šode
 *inode)

1038 
dnode_of_d©a
 
dn
;

1039 
”r
;

1041 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, inode->
i_šo
);

1042 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 0, 
LOOKUP_NODE
);

1043 ià(
”r
)

1044  
”r
;

1046 
”r
 = 
	`f2fs_Œunÿ‹_x©Œ_node
(
šode
);

1047 ià(
”r
) {

1048 
	`f2fs_put_dnode
(&
dn
);

1049  
”r
;

1053 ià(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

1054 
	`S_ISLNK
(
šode
->
i_mode
))

1055 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 1);

1058 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
),

1059 
šode
->
i_blocks
 != 0 && inode->i_blocks != 8);

1062 
	`Œunÿ‹_node
(&
dn
);

1064 
	}
}

1066 
·ge
 *
	$f2fs_Ãw_šode_·ge
(
šode
 *inode)

1068 
dnode_of_d©a
 
dn
;

1071 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, inode->
i_šo
);

1074  
	`f2fs_Ãw_node_·ge
(&
dn
, 0);

1075 
	}
}

1077 
·ge
 *
	$f2fs_Ãw_node_·ge
(
dnode_of_d©a
 *
dn
, 
ofs
)

1079 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

1080 
node_šfo
 
Ãw_ni
;

1081 
·ge
 *page;

1082 
”r
;

1084 ià(
	`uÆik–y
(
	`is_šode_æag_£t
(
dn
->
šode
, 
FI_NO_ALLOC
)))

1085  
	`ERR_PTR
(-
EPERM
);

1087 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
dn
->
nid
, 
çl£
);

1088 ià(!
·ge
)

1089  
	`ERR_PTR
(-
ENOMEM
);

1091 ià(
	`uÆik–y
((
”r
 = 
	`šc_v®id_node_couÁ
(
sbi
, 
dn
->
šode
, !
ofs
))))

1092 
ç
;

1094 #ifdeà
CONFIG_F2FS_CHECK_FS


1095 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
->
nid
, &
Ãw_ni
);

1096 
	`f2fs_bug_Ú
(
sbi
, 
Ãw_ni
.
blk_addr
 !ğ
NULL_ADDR
);

1098 
Ãw_ni
.
nid
 = 
dn
->nid;

1099 
Ãw_ni
.
šo
 = 
dn
->
šode
->
i_šo
;

1100 
Ãw_ni
.
blk_addr
 = 
NULL_ADDR
;

1101 
Ãw_ni
.
æag
 = 0;

1102 
Ãw_ni
.
v”siÚ
 = 0;

1103 
	`£t_node_addr
(
sbi
, &
Ãw_ni
, 
NEW_ADDR
, 
çl£
);

1105 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
, 
Œue
);

1106 
	`fl_node_foÙ”
(
·ge
, 
dn
->
nid
, dn->
šode
->
i_šo
, 
ofs
, 
Œue
);

1107 
	`£t_cŞd_node
(
·ge
, 
	`S_ISDIR
(
dn
->
šode
->
i_mode
));

1108 ià(!
	`PageU±od©e
(
·ge
))

1109 
	`S‘PageU±od©e
(
·ge
);

1110 ià(
	`£t_·ge_dœty
(
·ge
))

1111 
dn
->
node_chªged
 = 
Œue
;

1113 ià(
	`f2fs_has_x©Œ_block
(
ofs
))

1114 
	`f2fs_i_xnid_wr™e
(
dn
->
šode
, dn->
nid
);

1116 ià(
ofs
 == 0)

1117 
	`šc_v®id_šode_couÁ
(
sbi
);

1118  
·ge
;

1120 
ç
:

1121 
	`ş—r_node_·ge_dœty
(
·ge
);

1122 
	`f2fs_put_·ge
(
·ge
, 1);

1123  
	`ERR_PTR
(
”r
);

1124 
	}
}

1131 
	$»ad_node_·ge
(
·ge
 *·ge, 
İ_æags
)

1133 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

1134 
node_šfo
 
ni
;

1135 
f2fs_io_šfo
 
fio
 = {

1136 .
sbi
 = sbi,

1137 .
ty³
 = 
NODE
,

1138 .
İ
 = 
REQ_OP_READ
,

1139 .
İ_æags
 = op_flags,

1140 .
·ge
 =…age,

1141 .
’üy±ed_·ge
 = 
NULL
,

1144 ià(
	`PageU±od©e
(
·ge
))

1145  
LOCKED_PAGE
;

1147 
	`f2fs_g‘_node_šfo
(
sbi
, 
·ge
->
šdex
, &
ni
);

1149 ià(
	`uÆik–y
(
ni
.
blk_addr
 =ğ
NULL_ADDR
)) {

1150 
	`CË¬PageU±od©e
(
·ge
);

1151  -
ENOENT
;

1154 
fio
.
Ãw_blkaddr
 = fio.
Şd_blkaddr
 = 
ni
.
blk_addr
;

1155  
	`f2fs_subm™_·ge_bio
(&
fio
);

1156 
	}
}

1161 
	$f2fs_¿_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

1163 
·ge
 *
­age
;

1164 
”r
;

1166 ià(!
nid
)

1168 ià(
	`f2fs_check_nid_¿nge
(
sbi
, 
nid
))

1171 
	`rcu_»ad_lock
();

1172 
­age
 = 
	`¿dix_Œ“_lookup
(&
	`NODE_MAPPING
(
sbi
)->
i_·ges
, 
nid
);

1173 
	`rcu_»ad_uÆock
();

1174 ià(
­age
)

1177 
­age
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
nid
, 
çl£
);

1178 ià(!
­age
)

1181 
”r
 = 
	`»ad_node_·ge
(
­age
, 
REQ_RAHEAD
);

1182 
	`f2fs_put_·ge
(
­age
, 
”r
 ? 1 : 0);

1183 
	}
}

1185 
·ge
 *
	$__g‘_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
nid
,

1186 
·ge
 *
·»Á
, 
¡¬t
)

1188 
·ge
 *page;

1189 
”r
;

1191 ià(!
nid
)

1192  
	`ERR_PTR
(-
ENOENT
);

1193 ià(
	`f2fs_check_nid_¿nge
(
sbi
, 
nid
))

1194  
	`ERR_PTR
(-
EINVAL
);

1195 
»³©
:

1196 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
nid
, 
çl£
);

1197 ià(!
·ge
)

1198  
	`ERR_PTR
(-
ENOMEM
);

1200 
”r
 = 
	`»ad_node_·ge
(
·ge
, 0);

1201 ià(
”r
 < 0) {

1202 
	`f2fs_put_·ge
(
·ge
, 1);

1203  
	`ERR_PTR
(
”r
);

1204 } ià(
”r
 =ğ
LOCKED_PAGE
) {

1205 
”r
 = 0;

1206 
·ge_h™
;

1209 ià(
·»Á
)

1210 
	`f2fs_¿_node_·ges
(
·»Á
, 
¡¬t
 + 1, 
MAX_RA_NODE
);

1212 
	`lock_·ge
(
·ge
);

1214 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
))) {

1215 
	`f2fs_put_·ge
(
·ge
, 1);

1216 
»³©
;

1219 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

1220 
”r
 = -
EIO
;

1221 
out_”r
;

1224 ià(!
	`f2fs_šode_chksum_v”ify
(
sbi
, 
·ge
)) {

1225 
”r
 = -
EBADMSG
;

1226 
out_”r
;

1228 
·ge_h™
:

1229 if(
	`uÆik–y
(
nid
 !ğ
	`nid_of_node
(
·ge
))) {

1230 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
, "inconsistent‚ode block, "

1232 
nid
, 
	`nid_of_node
(
·ge
), 
	`šo_of_node
(page),

1233 
	`ofs_of_node
(
·ge
), 
	`ıv”_of_node
(page),

1234 
	`Ãxt_blkaddr_of_node
(
·ge
));

1235 
”r
 = -
EINVAL
;

1236 
out_”r
:

1237 
	`CË¬PageU±od©e
(
·ge
);

1238 
	`f2fs_put_·ge
(
·ge
, 1);

1239  
	`ERR_PTR
(
”r
);

1241  
·ge
;

1242 
	}
}

1244 
·ge
 *
	$f2fs_g‘_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
nid
)

1246  
	`__g‘_node_·ge
(
sbi
, 
nid
, 
NULL
, 0);

1247 
	}
}

1249 
·ge
 *
	$f2fs_g‘_node_·ge_¿
(
·ge
 *
·»Á
, 
¡¬t
)

1251 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·»Á
);

1252 
nid_t
 
nid
 = 
	`g‘_nid
(
·»Á
, 
¡¬t
, 
çl£
);

1254  
	`__g‘_node_·ge
(
sbi
, 
nid
, 
·»Á
, 
¡¬t
);

1255 
	}
}

1257 
	$æush_šlše_d©a
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

1259 
šode
 *inode;

1260 
·ge
 *page;

1261 
»t
;

1264 
šode
 = 
	`ookup
(
sbi
->
sb
, 
šo
);

1265 ià(!
šode
)

1268 
·ge
 = 
	`f2fs_·geÿche_g‘_·ge
(
šode
->
i_m­pšg
, 0,

1269 
FGP_LOCK
|
FGP_NOWAIT
, 0);

1270 ià(!
·ge
)

1271 
ut_out
;

1273 ià(!
	`PageU±od©e
(
·ge
))

1274 
·ge_out
;

1276 ià(!
	`PageDœty
(
·ge
))

1277 
·ge_out
;

1279 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

1280 
·ge_out
;

1282 
»t
 = 
	`f2fs_wr™e_šlše_d©a
(
šode
, 
·ge
);

1283 
	`šode_dec_dœty_·ges
(
šode
);

1284 
	`f2fs_»move_dœty_šode
(
šode
);

1285 ià(
»t
)

1286 
	`£t_·ge_dœty
(
·ge
);

1287 
·ge_out
:

1288 
	`f2fs_put_·ge
(
·ge
, 1);

1289 
ut_out
:

1290 
	`ut
(
šode
);

1291 
	}
}

1293 
·ge
 *
	$Ï¡_fsync_dnode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

1295 
pgoff_t
 
šdex
;

1296 
·gevec
 
pvec
;

1297 
·ge
 *
Ï¡_·ge
 = 
NULL
;

1298 
Ä_·ges
;

1300 
	`·gevec_š™
(&
pvec
);

1301 
šdex
 = 0;

1303 (
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
	`NODE_MAPPING
(
sbi
), &
šdex
,

1304 
PAGECACHE_TAG_DIRTY
))) {

1305 
i
;

1307 
i
 = 0; i < 
Ä_·ges
; i++) {

1308 
·ge
 *·gğ
pvec
.
·ges
[
i
];

1310 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1311 
	`f2fs_put_·ge
(
Ï¡_·ge
, 0);

1312 
	`·gevec_»Ëa£
(&
pvec
);

1313  
	`ERR_PTR
(-
EIO
);

1316 ià(!
	`IS_DNODE
(
·ge
è|| !
	`is_cŞd_node
(page))

1318 ià(
	`šo_of_node
(
·ge
è!ğ
šo
)

1321 
	`lock_·ge
(
·ge
);

1323 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
))) {

1324 
cÚtšue_uÆock
:

1325 
	`uÆock_·ge
(
·ge
);

1328 ià(
	`šo_of_node
(
·ge
è!ğ
šo
)

1329 
cÚtšue_uÆock
;

1331 ià(!
	`PageDœty
(
·ge
)) {

1333 
cÚtšue_uÆock
;

1336 ià(
Ï¡_·ge
)

1337 
	`f2fs_put_·ge
(
Ï¡_·ge
, 0);

1339 
	`g‘_·ge
(
·ge
);

1340 
Ï¡_·ge
 = 
·ge
;

1341 
	`uÆock_·ge
(
·ge
);

1343 
	`·gevec_»Ëa£
(&
pvec
);

1344 
	`cÚd_»sched
();

1346  
Ï¡_·ge
;

1347 
	}
}

1349 
	$__wr™e_node_·ge
(
·ge
 *·ge, 
boŞ
 
©omic
, boŞ *
subm™‹d
,

1350 
wr™eback_cÚŒŞ
 *
wbc
, 
boŞ
 
do_b®ªû
,

1351 
io¡©_ty³
 
io_ty³
)

1353 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

1354 
nid_t
 
nid
;

1355 
node_šfo
 
ni
;

1356 
f2fs_io_šfo
 
fio
 = {

1357 .
sbi
 = sbi,

1358 .
šo
 = 
	`šo_of_node
(
·ge
),

1359 .
ty³
 = 
NODE
,

1360 .
İ
 = 
REQ_OP_WRITE
,

1361 .
İ_æags
 = 
	`wbc_to_wr™e_æags
(
wbc
),

1362 .
·ge
 =…age,

1363 .
’üy±ed_·ge
 = 
NULL
,

1364 .
subm™‹d
 = 
çl£
,

1365 .
io_ty³
 = io_type,

1366 .
io_wbc
 = 
wbc
,

1369 
	`Œaû_f2fs_wr™•age
(
·ge
, 
NODE
);

1371 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1372 
»dœty_out
;

1374 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

1375 
»dœty_out
;

1378 
nid
 = 
	`nid_of_node
(
·ge
);

1379 
	`f2fs_bug_Ú
(
sbi
, 
·ge
->
šdex
 !ğ
nid
);

1381 ià(
wbc
->
fÜ_»şaim
) {

1382 ià(!
	`down_»ad_Œylock
(&
sbi
->
node_wr™e
))

1383 
»dœty_out
;

1385 
	`down_»ad
(&
sbi
->
node_wr™e
);

1388 
	`f2fs_g‘_node_šfo
(
sbi
, 
nid
, &
ni
);

1391 ià(
	`uÆik–y
(
ni
.
blk_addr
 =ğ
NULL_ADDR
)) {

1392 
	`CË¬PageU±od©e
(
·ge
);

1393 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_NODES
);

1394 
	`up_»ad
(&
sbi
->
node_wr™e
);

1395 
	`uÆock_·ge
(
·ge
);

1399 ià(
©omic
 && !
	`‹¡_İt
(
sbi
, 
NOBARRIER
))

1400 
fio
.
İ_æags
 |ğ
REQ_PREFLUSH
 | 
REQ_FUA
;

1402 
	`£t_·ge_wr™eback
(
·ge
);

1403 
	`CË¬PageE¼Ü
(
·ge
);

1404 
fio
.
Şd_blkaddr
 = 
ni
.
blk_addr
;

1405 
	`f2fs_do_wr™e_node_·ge
(
nid
, &
fio
);

1406 
	`£t_node_addr
(
sbi
, &
ni
, 
fio
.
Ãw_blkaddr
, 
	`is_fsync_dnode
(
·ge
));

1407 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_NODES
);

1408 
	`up_»ad
(&
sbi
->
node_wr™e
);

1410 ià(
wbc
->
fÜ_»şaim
) {

1411 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
sbi
, 
·ge
->
m­pšg
->
ho¡
, 0,

1412 
·ge
->
šdex
, 
NODE
);

1413 
subm™‹d
 = 
NULL
;

1416 
	`uÆock_·ge
(
·ge
);

1418 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1419 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
NODE
);

1420 
subm™‹d
 = 
NULL
;

1422 ià(
subm™‹d
)

1423 *
subm™‹d
 = 
fio
.submitted;

1425 ià(
do_b®ªû
)

1426 
	`f2fs_b®ªû_fs
(
sbi
, 
çl£
);

1429 
»dœty_out
:

1430 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

1431  
AOP_WRITEPAGE_ACTIVATE
;

1432 
	}
}

1434 
	$f2fs_move_node_·ge
(
·ge
 *
node_·ge
, 
gc_ty³
)

1436 ià(
gc_ty³
 =ğ
FG_GC
) {

1437 
wr™eback_cÚŒŞ
 
wbc
 = {

1438 .
sync_mode
 = 
WB_SYNC_ALL
,

1439 .
Ä_to_wr™e
 = 1,

1440 .
fÜ_»şaim
 = 0,

1443 
	`£t_·ge_dœty
(
node_·ge
);

1444 
	`f2fs_wa™_Ú_·ge_wr™eback
(
node_·ge
, 
NODE
, 
Œue
);

1446 
	`f2fs_bug_Ú
(
	`F2FS_P_SB
(
node_·ge
), 
	`PageWr™eback
(node_page));

1447 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
node_·ge
))

1448 
out_·ge
;

1450 ià(
	`__wr™e_node_·ge
(
node_·ge
, 
çl£
, 
NULL
,

1451 &
wbc
, 
çl£
, 
FS_GC_NODE_IO
))

1452 
	`uÆock_·ge
(
node_·ge
);

1453 
»Ëa£_·ge
;

1456 ià(!
	`PageWr™eback
(
node_·ge
))

1457 
	`£t_·ge_dœty
(
node_·ge
);

1459 
out_·ge
:

1460 
	`uÆock_·ge
(
node_·ge
);

1461 
»Ëa£_·ge
:

1462 
	`f2fs_put_·ge
(
node_·ge
, 0);

1463 
	}
}

1465 
	$f2fs_wr™e_node_·ge
(
·ge
 *page,

1466 
wr™eback_cÚŒŞ
 *
wbc
)

1468  
	`__wr™e_node_·ge
(
·ge
, 
çl£
, 
NULL
, 
wbc
, f®£, 
FS_NODE_IO
);

1469 
	}
}

1471 
	$f2fs_fsync_node_·ges
(
f2fs_sb_šfo
 *
sbi
, 
šode
 *inode,

1472 
wr™eback_cÚŒŞ
 *
wbc
, 
boŞ
 
©omic
)

1474 
pgoff_t
 
šdex
;

1475 
pgoff_t
 
Ï¡_idx
 = 
ULONG_MAX
;

1476 
·gevec
 
pvec
;

1477 
»t
 = 0;

1478 
·ge
 *
Ï¡_·ge
 = 
NULL
;

1479 
boŞ
 
m¬ked
 = 
çl£
;

1480 
nid_t
 
šo
 = 
šode
->
i_šo
;

1481 
Ä_·ges
;

1483 ià(
©omic
) {

1484 
Ï¡_·ge
 = 
	`Ï¡_fsync_dnode
(
sbi
, 
šo
);

1485 ià(
	`IS_ERR_OR_NULL
(
Ï¡_·ge
))

1486  
	`PTR_ERR_OR_ZERO
(
Ï¡_·ge
);

1488 
»Œy
:

1489 
	`·gevec_š™
(&
pvec
);

1490 
šdex
 = 0;

1492 (
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
	`NODE_MAPPING
(
sbi
), &
šdex
,

1493 
PAGECACHE_TAG_DIRTY
))) {

1494 
i
;

1496 
i
 = 0; i < 
Ä_·ges
; i++) {

1497 
·ge
 *·gğ
pvec
.
·ges
[
i
];

1498 
boŞ
 
subm™‹d
 = 
çl£
;

1500 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1501 
	`f2fs_put_·ge
(
Ï¡_·ge
, 0);

1502 
	`·gevec_»Ëa£
(&
pvec
);

1503 
»t
 = -
EIO
;

1504 
out
;

1507 ià(!
	`IS_DNODE
(
·ge
è|| !
	`is_cŞd_node
(page))

1509 ià(
	`šo_of_node
(
·ge
è!ğ
šo
)

1512 
	`lock_·ge
(
·ge
);

1514 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
))) {

1515 
cÚtšue_uÆock
:

1516 
	`uÆock_·ge
(
·ge
);

1519 ià(
	`šo_of_node
(
·ge
è!ğ
šo
)

1520 
cÚtšue_uÆock
;

1522 ià(!
	`PageDœty
(
·ge
è&&…ag!ğ
Ï¡_·ge
) {

1524 
cÚtšue_uÆock
;

1527 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
, 
Œue
);

1528 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

1530 
	`£t_fsync_m¬k
(
·ge
, 0);

1531 
	`£t_d’Œy_m¬k
(
·ge
, 0);

1533 ià(!
©omic
 || 
·ge
 =ğ
Ï¡_·ge
) {

1534 
	`£t_fsync_m¬k
(
·ge
, 1);

1535 ià(
	`IS_INODE
(
·ge
)) {

1536 ià(
	`is_šode_æag_£t
(
šode
,

1537 
FI_DIRTY_INODE
))

1538 
	`f2fs_upd©e_šode
(
šode
, 
·ge
);

1539 
	`£t_d’Œy_m¬k
(
·ge
,

1540 
	`f2fs_Ãed_d’Œy_m¬k
(
sbi
, 
šo
));

1543 ià(!
	`PageDœty
(
·ge
))

1544 
	`£t_·ge_dœty
(
·ge
);

1547 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

1548 
cÚtšue_uÆock
;

1550 
»t
 = 
	`__wr™e_node_·ge
(
·ge
, 
©omic
 &&

1551 
·ge
 =ğ
Ï¡_·ge
,

1552 &
subm™‹d
, 
wbc
, 
Œue
,

1553 
FS_NODE_IO
);

1554 ià(
»t
) {

1555 
	`uÆock_·ge
(
·ge
);

1556 
	`f2fs_put_·ge
(
Ï¡_·ge
, 0);

1558 } ià(
subm™‹d
) {

1559 
Ï¡_idx
 = 
·ge
->
šdex
;

1562 ià(
·ge
 =ğ
Ï¡_·ge
) {

1563 
	`f2fs_put_·ge
(
·ge
, 0);

1564 
m¬ked
 = 
Œue
;

1568 
	`·gevec_»Ëa£
(&
pvec
);

1569 
	`cÚd_»sched
();

1571 ià(
»t
 || 
m¬ked
)

1574 ià(!
»t
 && 
©omic
 && !
m¬ked
) {

1575 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_DEBUG
,

1577 
šo
, 
Ï¡_·ge
->
šdex
);

1578 
	`lock_·ge
(
Ï¡_·ge
);

1579 
	`f2fs_wa™_Ú_·ge_wr™eback
(
Ï¡_·ge
, 
NODE
, 
Œue
);

1580 
	`£t_·ge_dœty
(
Ï¡_·ge
);

1581 
	`uÆock_·ge
(
Ï¡_·ge
);

1582 
»Œy
;

1584 
out
:

1585 ià(
Ï¡_idx
 !ğ
ULONG_MAX
)

1586 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
sbi
, 
NULL
, 
šo
, 
Ï¡_idx
, 
NODE
);

1587  
»t
 ? -
EIO
: 0;

1588 
	}
}

1590 
	$f2fs_sync_node_·ges
(
f2fs_sb_šfo
 *
sbi
,

1591 
wr™eback_cÚŒŞ
 *
wbc
,

1592 
boŞ
 
do_b®ªû
, 
io¡©_ty³
 
io_ty³
)

1594 
pgoff_t
 
šdex
;

1595 
·gevec
 
pvec
;

1596 
¡•
 = 0;

1597 
nwr™‹n
 = 0;

1598 
»t
 = 0;

1599 
Ä_·ges
, 
dÚe
 = 0;

1601 
	`·gevec_š™
(&
pvec
);

1603 
Ãxt_¡•
:

1604 
šdex
 = 0;

1606 !
dÚe
 && (
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
,

1607 
	`NODE_MAPPING
(
sbi
), &
šdex
, 
PAGECACHE_TAG_DIRTY
))) {

1608 
i
;

1610 
i
 = 0; i < 
Ä_·ges
; i++) {

1611 
·ge
 *·gğ
pvec
.
·ges
[
i
];

1612 
boŞ
 
subm™‹d
 = 
çl£
;

1615 ià(
	`©omic_»ad
(&
sbi
->
wb_sync_»q
[
NODE
]) &&

1616 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
) {

1617 
dÚe
 = 1;

1627 ià(
¡•
 =ğ0 && 
	`IS_DNODE
(
·ge
))

1629 ià(
¡•
 =ğ1 && (!
	`IS_DNODE
(
·ge
) ||

1630 
	`is_cŞd_node
(
·ge
)))

1632 ià(
¡•
 =ğ2 && (!
	`IS_DNODE
(
·ge
) ||

1633 !
	`is_cŞd_node
(
·ge
)))

1635 
lock_node
:

1636 ià(!
	`Œylock_·ge
(
·ge
))

1639 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
))) {

1640 
cÚtšue_uÆock
:

1641 
	`uÆock_·ge
(
·ge
);

1645 ià(!
	`PageDœty
(
·ge
)) {

1647 
cÚtšue_uÆock
;

1651 ià(
	`is_šlše_node
(
·ge
)) {

1652 
	`ş—r_šlše_node
(
·ge
);

1653 
	`uÆock_·ge
(
·ge
);

1654 
	`æush_šlše_d©a
(
sbi
, 
	`šo_of_node
(
·ge
));

1655 
lock_node
;

1658 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
, 
Œue
);

1660 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

1661 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

1662 
cÚtšue_uÆock
;

1664 
	`£t_fsync_m¬k
(
·ge
, 0);

1665 
	`£t_d’Œy_m¬k
(
·ge
, 0);

1667 
»t
 = 
	`__wr™e_node_·ge
(
·ge
, 
çl£
, &
subm™‹d
,

1668 
wbc
, 
do_b®ªû
, 
io_ty³
);

1669 ià(
»t
)

1670 
	`uÆock_·ge
(
·ge
);

1671 ià(
subm™‹d
)

1672 
nwr™‹n
++;

1674 ià(--
wbc
->
Ä_to_wr™e
 == 0)

1677 
	`·gevec_»Ëa£
(&
pvec
);

1678 
	`cÚd_»sched
();

1680 ià(
wbc
->
Ä_to_wr™e
 == 0) {

1681 
¡•
 = 2;

1686 ià(
¡•
 < 2) {

1687 
¡•
++;

1688 
Ãxt_¡•
;

1691 ià(
nwr™‹n
)

1692 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
NODE
);

1694 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1695  -
EIO
;

1696  
»t
;

1697 
	}
}

1699 
	$f2fs_wa™_Ú_node_·ges_wr™eback
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

1701 
pgoff_t
 
šdex
 = 0;

1702 
·gevec
 
pvec
;

1703 
»t2
, 
»t
 = 0;

1704 
Ä_·ges
;

1706 
	`·gevec_š™
(&
pvec
);

1708 (
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
	`NODE_MAPPING
(
sbi
), &
šdex
,

1709 
PAGECACHE_TAG_WRITEBACK
))) {

1710 
i
;

1712 
i
 = 0; i < 
Ä_·ges
; i++) {

1713 
·ge
 *·gğ
pvec
.
·ges
[
i
];

1715 ià(
šo
 && 
	`šo_of_node
(
·ge
) == ino) {

1716 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
, 
Œue
);

1717 ià(
	`Te¡CË¬PageE¼Ü
(
·ge
))

1718 
»t
 = -
EIO
;

1721 
	`·gevec_»Ëa£
(&
pvec
);

1722 
	`cÚd_»sched
();

1725 
»t2
 = 
	`fem­_check_”rÜs
(
	`NODE_MAPPING
(
sbi
));

1726 ià(!
»t
)

1727 
»t
 = 
»t2
;

1728  
»t
;

1729 
	}
}

1731 
	$f2fs_wr™e_node_·ges
(
add»ss_¥aû
 *
m­pšg
,

1732 
wr™eback_cÚŒŞ
 *
wbc
)

1734 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_M_SB
(
m­pšg
);

1735 
blk_¶ug
 
¶ug
;

1736 
diff
;

1738 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

1739 
sk_wr™e
;

1742 
	`f2fs_b®ªû_fs_bg
(
sbi
);

1745 ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
è< 
	`Ä_·ges_to_sk
(sbi, 
NODE
))

1746 
sk_wr™e
;

1748 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
)

1749 
	`©omic_šc
(&
sbi
->
wb_sync_»q
[
NODE
]);

1750 ià(
	`©omic_»ad
(&
sbi
->
wb_sync_»q
[
NODE
]))

1751 
sk_wr™e
;

1753 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
NODE
);

1755 
diff
 = 
	`Ä_·ges_to_wr™e
(
sbi
, 
NODE
, 
wbc
);

1756 
	`blk_¡¬t_¶ug
(&
¶ug
);

1757 
	`f2fs_sync_node_·ges
(
sbi
, 
wbc
, 
Œue
, 
FS_NODE_IO
);

1758 
	`blk_fšish_¶ug
(&
¶ug
);

1759 
wbc
->
Ä_to_wr™e
 = 
	`max
(()0, wbc->Ä_to_wr™- 
diff
);

1761 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
)

1762 
	`©omic_dec
(&
sbi
->
wb_sync_»q
[
NODE
]);

1765 
sk_wr™e
:

1766 
wbc
->
·ges_sk³d
 +ğ
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
);

1767 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
NODE
);

1769 
	}
}

1771 
	$f2fs_£t_node_·ge_dœty
(
·ge
 *page)

1773 
	`Œaû_f2fs_£t_·ge_dœty
(
·ge
, 
NODE
);

1775 ià(!
	`PageU±od©e
(
·ge
))

1776 
	`S‘PageU±od©e
(
·ge
);

1777 ià(!
	`PageDœty
(
·ge
)) {

1778 
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

1779 
	`šc_·ge_couÁ
(
	`F2FS_P_SB
(
·ge
), 
F2FS_DIRTY_NODES
);

1780 
	`S‘PagePriv©e
(
·ge
);

1781 
	`f2fs_Œaû_pid
(
·ge
);

1785 
	}
}

1790 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gf2fs_node_aİs
 = {

1791 .
wr™•age
 = 
f2fs_wr™e_node_·ge
,

1792 .
	gwr™•ages
 = 
f2fs_wr™e_node_·ges
,

1793 .
	g£t_·ge_dœty
 = 
f2fs_£t_node_·ge_dœty
,

1794 .
	gšv®id©•age
 = 
f2fs_šv®id©e_·ge
,

1795 .
	g»Ëa£·ge
 = 
f2fs_»Ëa£_·ge
,

1796 #ifdeà
CONFIG_MIGRATION


1797 .
	gmig¿‹·ge
 = 
f2fs_mig¿‹_·ge
,

1801 
ä“_nid
 *
	$__lookup_ä“_nid_li¡
(
f2fs_nm_šfo
 *
nm_i
,

1802 
nid_t
 
n
)

1804  
	`¿dix_Œ“_lookup
(&
nm_i
->
ä“_nid_roÙ
, 
n
);

1805 
	}
}

1807 
	$__š£¹_ä“_nid
(
f2fs_sb_šfo
 *
sbi
,

1808 
ä“_nid
 *
i
, 
nid_¡©e
 
¡©e
)

1810 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1812 
”r
 = 
	`¿dix_Œ“_š£¹
(&
nm_i
->
ä“_nid_roÙ
, 
i
->
nid
, i);

1813 ià(
”r
)

1814  
”r
;

1816 
	`f2fs_bug_Ú
(
sbi
, 
¡©e
 !ğ
i
->state);

1817 
nm_i
->
nid_út
[
¡©e
]++;

1818 ià(
¡©e
 =ğ
FREE_NID
)

1819 
	`li¡_add_
(&
i
->
li¡
, &
nm_i
->
ä“_nid_li¡
);

1821 
	}
}

1823 
	$__»move_ä“_nid
(
f2fs_sb_šfo
 *
sbi
,

1824 
ä“_nid
 *
i
, 
nid_¡©e
 
¡©e
)

1826 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1828 
	`f2fs_bug_Ú
(
sbi
, 
¡©e
 !ğ
i
->state);

1829 
nm_i
->
nid_út
[
¡©e
]--;

1830 ià(
¡©e
 =ğ
FREE_NID
)

1831 
	`li¡_d–
(&
i
->
li¡
);

1832 
	`¿dix_Œ“_d–‘e
(&
nm_i
->
ä“_nid_roÙ
, 
i
->
nid
);

1833 
	}
}

1835 
	$__move_ä“_nid
(
f2fs_sb_šfo
 *
sbi
, 
ä“_nid
 *
i
,

1836 
nid_¡©e
 
Üg_¡©e
, nid_¡©
d¡_¡©e
)

1838 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1840 
	`f2fs_bug_Ú
(
sbi
, 
Üg_¡©e
 !ğ
i
->
¡©e
);

1841 
i
->
¡©e
 = 
d¡_¡©e
;

1842 
nm_i
->
nid_út
[
Üg_¡©e
]--;

1843 
nm_i
->
nid_út
[
d¡_¡©e
]++;

1845 
d¡_¡©e
) {

1846 
PREALLOC_NID
:

1847 
	`li¡_d–
(&
i
->
li¡
);

1849 
FREE_NID
:

1850 
	`li¡_add_
(&
i
->
li¡
, &
nm_i
->
ä“_nid_li¡
);

1853 
	`BUG_ON
(1);

1855 
	}
}

1857 
	$upd©e_ä“_nid_b™m­
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
,

1858 
boŞ
 
£t
, boŞ 
bud
)

1860 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1861 
Çt_ofs
 = 
	`NAT_BLOCK_OFFSET
(
nid
);

1862 
nid_ofs
 = 
nid
 - 
	`START_NID
(nid);

1864 ià(!
	`‹¡_b™_Ë
(
Çt_ofs
, 
nm_i
->
Çt_block_b™m­
))

1867 ià(
£t
) {

1868 ià(
	`‹¡_b™_Ë
(
nid_ofs
, 
nm_i
->
ä“_nid_b™m­
[
Çt_ofs
]))

1870 
	`__£t_b™_Ë
(
nid_ofs
, 
nm_i
->
ä“_nid_b™m­
[
Çt_ofs
]);

1871 
nm_i
->
ä“_nid_couÁ
[
Çt_ofs
]++;

1873 ià(!
	`‹¡_b™_Ë
(
nid_ofs
, 
nm_i
->
ä“_nid_b™m­
[
Çt_ofs
]))

1875 
	`__ş—r_b™_Ë
(
nid_ofs
, 
nm_i
->
ä“_nid_b™m­
[
Çt_ofs
]);

1876 ià(!
bud
)

1877 
nm_i
->
ä“_nid_couÁ
[
Çt_ofs
]--;

1879 
	}
}

1882 
boŞ
 
	$add_ä“_nid
(
f2fs_sb_šfo
 *
sbi
,

1883 
nid_t
 
nid
, 
boŞ
 
bud
, boŞ 
upd©e
)

1885 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1886 
ä“_nid
 *
i
, *
e
;

1887 
Çt_’Œy
 *
Ã
;

1888 
”r
 = -
EINVAL
;

1889 
boŞ
 
»t
 = 
çl£
;

1892 ià(
	`uÆik–y
(
nid
 == 0))

1893  
çl£
;

1895 
i
 = 
	`f2fs_kmem_ÿche_®loc
(
ä“_nid_¦ab
, 
GFP_NOFS
);

1896 
i
->
nid
 =‚id;

1897 
i
->
¡©e
 = 
FREE_NID
;

1899 
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
 | 
__GFP_NOFAIL
);

1901 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

1903 ià(
bud
) {

1925 
Ã
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

1926 ià(
Ã
 && (!
	`g‘_Çt_æag
Òe, 
IS_CHECKPOINTED
) ||

1927 
	`Çt_g‘_blkaddr
(
Ã
è!ğ
NULL_ADDR
))

1928 
”r_out
;

1930 
e
 = 
	`__lookup_ä“_nid_li¡
(
nm_i
, 
nid
);

1931 ià(
e
) {

1932 ià(
e
->
¡©e
 =ğ
FREE_NID
)

1933 
»t
 = 
Œue
;

1934 
”r_out
;

1937 
»t
 = 
Œue
;

1938 
”r
 = 
	`__š£¹_ä“_nid
(
sbi
, 
i
, 
FREE_NID
);

1939 
”r_out
:

1940 ià(
upd©e
) {

1941 
	`upd©e_ä“_nid_b™m­
(
sbi
, 
nid
, 
»t
, 
bud
);

1942 ià(!
bud
)

1943 
nm_i
->
avaabË_nids
++;

1945 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

1946 
	`¿dix_Œ“_´–ßd_’d
();

1948 ià(
”r
)

1949 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

1950  
»t
;

1951 
	}
}

1953 
	$»move_ä“_nid
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

1955 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1956 
ä“_nid
 *
i
;

1957 
boŞ
 
Ãed_ä“
 = 
çl£
;

1959 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

1960 
i
 = 
	`__lookup_ä“_nid_li¡
(
nm_i
, 
nid
);

1961 ià(
i
 && i->
¡©e
 =ğ
FREE_NID
) {

1962 
	`__»move_ä“_nid
(
sbi
, 
i
, 
FREE_NID
);

1963 
Ãed_ä“
 = 
Œue
;

1965 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

1967 ià(
Ãed_ä“
)

1968 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

1969 
	}
}

1971 
	$sÿn_Çt_·ge
(
f2fs_sb_šfo
 *
sbi
,

1972 
·ge
 *
Çt_·ge
, 
nid_t
 
¡¬t_nid
)

1974 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1975 
f2fs_Çt_block
 *
Çt_blk
 = 
	`·ge_add»ss
(
Çt_·ge
);

1976 
block_t
 
blk_addr
;

1977 
Çt_ofs
 = 
	`NAT_BLOCK_OFFSET
(
¡¬t_nid
);

1978 
i
;

1980 
	`__£t_b™_Ë
(
Çt_ofs
, 
nm_i
->
Çt_block_b™m­
);

1982 
i
 = 
¡¬t_nid
 % 
NAT_ENTRY_PER_BLOCK
;

1984 ; 
i
 < 
NAT_ENTRY_PER_BLOCK
; i++, 
¡¬t_nid
++) {

1985 ià(
	`uÆik–y
(
¡¬t_nid
 >ğ
nm_i
->
max_nid
))

1988 
blk_addr
 = 
	`Ë32_to_ıu
(
Çt_blk
->
’Œ›s
[
i
].
block_addr
);

1989 
	`f2fs_bug_Ú
(
sbi
, 
blk_addr
 =ğ
NEW_ADDR
);

1990 ià(
blk_addr
 =ğ
NULL_ADDR
) {

1991 
	`add_ä“_nid
(
sbi
, 
¡¬t_nid
, 
Œue
,rue);

1993 
	`¥š_lock
(&
	`NM_I
(
sbi
)->
nid_li¡_lock
);

1994 
	`upd©e_ä“_nid_b™m­
(
sbi
, 
¡¬t_nid
, 
çl£
, 
Œue
);

1995 
	`¥š_uÆock
(&
	`NM_I
(
sbi
)->
nid_li¡_lock
);

1998 
	}
}

2000 
	$sÿn_cur£g_ÿche
(
f2fs_sb_šfo
 *
sbi
)

2002 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

2003 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

2004 
i
;

2006 
	`down_»ad
(&
cur£g
->
jouº®_rw£m
);

2007 
i
 = 0; i < 
	`Çts_š_cursum
(
jouº®
); i++) {

2008 
block_t
 
addr
;

2009 
nid_t
 
nid
;

2011 
addr
 = 
	`Ë32_to_ıu
(
	`Çt_š_jouº®
(
jouº®
, 
i
).
block_addr
);

2012 
nid
 = 
	`Ë32_to_ıu
(
	`nid_š_jouº®
(
jouº®
, 
i
));

2013 ià(
addr
 =ğ
NULL_ADDR
)

2014 
	`add_ä“_nid
(
sbi
, 
nid
, 
Œue
, 
çl£
);

2016 
	`»move_ä“_nid
(
sbi
, 
nid
);

2018 
	`up_»ad
(&
cur£g
->
jouº®_rw£m
);

2019 
	}
}

2021 
	$sÿn_ä“_nid_b™s
(
f2fs_sb_šfo
 *
sbi
)

2023 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2024 
i
, 
idx
;

2025 
nid_t
 
nid
;

2027 
	`down_»ad
(&
nm_i
->
Çt_Œ“_lock
);

2029 
i
 = 0; i < 
nm_i
->
Çt_blocks
; i++) {

2030 ià(!
	`‹¡_b™_Ë
(
i
, 
nm_i
->
Çt_block_b™m­
))

2032 ià(!
nm_i
->
ä“_nid_couÁ
[
i
])

2034 
idx
 = 0; idx < 
NAT_ENTRY_PER_BLOCK
; idx++) {

2035 
idx
 = 
	`fšd_Ãxt_b™_Ë
(
nm_i
->
ä“_nid_b™m­
[
i
],

2036 
NAT_ENTRY_PER_BLOCK
, 
idx
);

2037 ià(
idx
 >ğ
NAT_ENTRY_PER_BLOCK
)

2040 
nid
 = 
i
 * 
NAT_ENTRY_PER_BLOCK
 + 
idx
;

2041 
	`add_ä“_nid
(
sbi
, 
nid
, 
Œue
, 
çl£
);

2043 ià(
nm_i
->
nid_út
[
FREE_NID
] >ğ
MAX_FREE_NIDS
)

2044 
out
;

2047 
out
:

2048 
	`sÿn_cur£g_ÿche
(
sbi
);

2050 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

2051 
	}
}

2053 
	$__f2fs_bud_ä“_nids
(
f2fs_sb_šfo
 *
sbi
,

2054 
boŞ
 
sync
, boŞ 
mouÁ
)

2056 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2057 
i
 = 0;

2058 
nid_t
 
nid
 = 
nm_i
->
Ãxt_sÿn_nid
;

2060 ià(
	`uÆik–y
(
nid
 >ğ
nm_i
->
max_nid
))

2061 
nid
 = 0;

2064 ià(
nm_i
->
nid_út
[
FREE_NID
] >ğ
NAT_ENTRY_PER_BLOCK
)

2067 ià(!
sync
 && !
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
FREE_NIDS
))

2070 ià(!
mouÁ
) {

2072 
	`sÿn_ä“_nid_b™s
(
sbi
);

2074 ià(
nm_i
->
nid_út
[
FREE_NID
] >ğ
NAT_ENTRY_PER_BLOCK
)

2079 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`NAT_BLOCK_OFFSET
(
nid
), 
FREE_NID_PAGES
,

2080 
META_NAT
, 
Œue
);

2082 
	`down_»ad
(&
nm_i
->
Çt_Œ“_lock
);

2085 ià(!
	`‹¡_b™_Ë
(
	`NAT_BLOCK_OFFSET
(
nid
),

2086 
nm_i
->
Çt_block_b™m­
)) {

2087 
·ge
 *·gğ
	`g‘_cu¼’t_Çt_·ge
(
sbi
, 
nid
);

2089 
	`sÿn_Çt_·ge
(
sbi
, 
·ge
, 
nid
);

2090 
	`f2fs_put_·ge
(
·ge
, 1);

2093 
nid
 +ğ(
NAT_ENTRY_PER_BLOCK
 - (nid % NAT_ENTRY_PER_BLOCK));

2094 ià(
	`uÆik–y
(
nid
 >ğ
nm_i
->
max_nid
))

2095 
nid
 = 0;

2097 ià(++
i
 >ğ
FREE_NID_PAGES
)

2102 
nm_i
->
Ãxt_sÿn_nid
 = 
nid
;

2105 
	`sÿn_cur£g_ÿche
(
sbi
);

2107 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

2109 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`NAT_BLOCK_OFFSET
(
nm_i
->
Ãxt_sÿn_nid
),

2110 
nm_i
->
¿_nid_·ges
, 
META_NAT
, 
çl£
);

2111 
	}
}

2113 
	$f2fs_bud_ä“_nids
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
sync
, boŞ 
mouÁ
)

2115 
	`mu‹x_lock
(&
	`NM_I
(
sbi
)->
bud_lock
);

2116 
	`__f2fs_bud_ä“_nids
(
sbi
, 
sync
, 
mouÁ
);

2117 
	`mu‹x_uÆock
(&
	`NM_I
(
sbi
)->
bud_lock
);

2118 
	}
}

2125 
boŞ
 
	$f2fs_®loc_nid
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 *
nid
)

2127 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2128 
ä“_nid
 *
i
 = 
NULL
;

2129 
»Œy
:

2130 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


2131 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_ALLOC_NID
)) {

2132 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_ALLOC_NID
);

2133  
çl£
;

2136 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2138 ià(
	`uÆik–y
(
nm_i
->
avaabË_nids
 == 0)) {

2139 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2140  
çl£
;

2144 ià(
nm_i
->
nid_út
[
FREE_NID
] && !
	`Ú_f2fs_bud_ä“_nids
(nm_i)) {

2145 
	`f2fs_bug_Ú
(
sbi
, 
	`li¡_em±y
(&
nm_i
->
ä“_nid_li¡
));

2146 
i
 = 
	`li¡_fœ¡_’Œy
(&
nm_i
->
ä“_nid_li¡
,

2147 
ä“_nid
, 
li¡
);

2148 *
nid
 = 
i
->nid;

2150 
	`__move_ä“_nid
(
sbi
, 
i
, 
FREE_NID
, 
PREALLOC_NID
);

2151 
nm_i
->
avaabË_nids
--;

2153 
	`upd©e_ä“_nid_b™m­
(
sbi
, *
nid
, 
çl£
, false);

2155 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2156  
Œue
;

2158 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2161 
	`f2fs_bud_ä“_nids
(
sbi
, 
Œue
, 
çl£
);

2162 
»Œy
;

2163 
	}
}

2168 
	$f2fs_®loc_nid_dÚe
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

2170 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2171 
ä“_nid
 *
i
;

2173 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2174 
i
 = 
	`__lookup_ä“_nid_li¡
(
nm_i
, 
nid
);

2175 
	`f2fs_bug_Ú
(
sbi
, !
i
);

2176 
	`__»move_ä“_nid
(
sbi
, 
i
, 
PREALLOC_NID
);

2177 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2179 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

2180 
	}
}

2185 
	$f2fs_®loc_nid_çed
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

2187 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2188 
ä“_nid
 *
i
;

2189 
boŞ
 
Ãed_ä“
 = 
çl£
;

2191 ià(!
nid
)

2194 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2195 
i
 = 
	`__lookup_ä“_nid_li¡
(
nm_i
, 
nid
);

2196 
	`f2fs_bug_Ú
(
sbi
, !
i
);

2198 ià(!
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
FREE_NIDS
)) {

2199 
	`__»move_ä“_nid
(
sbi
, 
i
, 
PREALLOC_NID
);

2200 
Ãed_ä“
 = 
Œue
;

2202 
	`__move_ä“_nid
(
sbi
, 
i
, 
PREALLOC_NID
, 
FREE_NID
);

2205 
nm_i
->
avaabË_nids
++;

2207 
	`upd©e_ä“_nid_b™m­
(
sbi
, 
nid
, 
Œue
, 
çl£
);

2209 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2211 ià(
Ãed_ä“
)

2212 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

2213 
	}
}

2215 
	$f2fs_Œy_to_ä“_nids
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
)

2217 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2218 
ä“_nid
 *
i
, *
Ãxt
;

2219 
Ä
 = 
Ä_shršk
;

2221 ià(
nm_i
->
nid_út
[
FREE_NID
] <ğ
MAX_FREE_NIDS
)

2224 ià(!
	`mu‹x_Œylock
(&
nm_i
->
bud_lock
))

2227 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2228 
	`li¡_fÜ_—ch_’Œy_§ã
(
i
, 
Ãxt
, &
nm_i
->
ä“_nid_li¡
, 
li¡
) {

2229 ià(
Ä_shršk
 <= 0 ||

2230 
nm_i
->
nid_út
[
FREE_NID
] <ğ
MAX_FREE_NIDS
)

2233 
	`__»move_ä“_nid
(
sbi
, 
i
, 
FREE_NID
);

2234 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

2235 
Ä_shršk
--;

2237 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2238 
	`mu‹x_uÆock
(&
nm_i
->
bud_lock
);

2240  
Ä
 - 
Ä_shršk
;

2241 
	}
}

2243 
	$f2fs_»cov”_šlše_x©Œ
(
šode
 *šode, 
·ge
 *page)

2245 *
¤c_addr
, *
d¡_addr
;

2246 
size_t
 
šlše_size
;

2247 
·ge
 *
age
;

2248 
f2fs_šode
 *
ri
;

2250 
age
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
);

2251 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
), 
	`IS_ERR
(
age
));

2253 
ri
 = 
	`F2FS_INODE
(
·ge
);

2254 ià(
ri
->
i_šlše
 & 
F2FS_INLINE_XATTR
) {

2255 
	`£t_šode_æag
(
šode
, 
FI_INLINE_XATTR
);

2257 
	`ş—r_šode_æag
(
šode
, 
FI_INLINE_XATTR
);

2258 
upd©e_šode
;

2261 
d¡_addr
 = 
	`šlše_x©Œ_addr
(
šode
, 
age
);

2262 
¤c_addr
 = 
	`šlše_x©Œ_addr
(
šode
, 
·ge
);

2263 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

2265 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
);

2266 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
šlše_size
);

2267 
upd©e_šode
:

2268 
	`f2fs_upd©e_šode
(
šode
, 
age
);

2269 
	`f2fs_put_·ge
(
age
, 1);

2270 
	}
}

2272 
	$f2fs_»cov”_x©Œ_d©a
(
šode
 *šode, 
·ge
 *page)

2274 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2275 
nid_t
 
´ev_xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

2276 
nid_t
 
Ãw_xnid
;

2277 
dnode_of_d©a
 
dn
;

2278 
node_šfo
 
ni
;

2279 
·ge
 *
x·ge
;

2281 ià(!
´ev_xnid
)

2282 
»cov”_xnid
;

2285 
	`f2fs_g‘_node_šfo
(
sbi
, 
´ev_xnid
, &
ni
);

2286 
	`f2fs_šv®id©e_blocks
(
sbi
, 
ni
.
blk_addr
);

2287 
	`dec_v®id_node_couÁ
(
sbi
, 
šode
, 
çl£
);

2288 
	`£t_node_addr
(
sbi
, &
ni
, 
NULL_ADDR
, 
çl£
);

2290 
»cov”_xnid
:

2292 ià(!
	`f2fs_®loc_nid
(
sbi
, &
Ãw_xnid
))

2293  -
ENOSPC
;

2295 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 
Ãw_xnid
);

2296 
x·ge
 = 
	`f2fs_Ãw_node_·ge
(&
dn
, 
XATTR_NODE_OFFSET
);

2297 ià(
	`IS_ERR
(
x·ge
)) {

2298 
	`f2fs_®loc_nid_çed
(
sbi
, 
Ãw_xnid
);

2299  
	`PTR_ERR
(
x·ge
);

2302 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
Ãw_xnid
);

2303 
	`f2fs_upd©e_šode_·ge
(
šode
);

2306 
	`memıy
(
	`F2FS_NODE
(
x·ge
), F2FS_NODE(
·ge
), 
VALID_XATTR_BLOCK_SIZE
);

2308 
	`£t_·ge_dœty
(
x·ge
);

2309 
	`f2fs_put_·ge
(
x·ge
, 1);

2312 
	}
}

2314 
	$f2fs_»cov”_šode_·ge
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

2316 
f2fs_šode
 *
¤c
, *
d¡
;

2317 
nid_t
 
šo
 = 
	`šo_of_node
(
·ge
);

2318 
node_šfo
 
Şd_ni
, 
Ãw_ni
;

2319 
·ge
 *
age
;

2321 
	`f2fs_g‘_node_šfo
(
sbi
, 
šo
, &
Şd_ni
);

2323 ià(
	`uÆik–y
(
Şd_ni
.
blk_addr
 !ğ
NULL_ADDR
))

2324  -
EINVAL
;

2325 
»Œy
:

2326 
age
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
šo
, 
çl£
);

2327 ià(!
age
) {

2328 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

2329 
»Œy
;

2333 
	`»move_ä“_nid
(
sbi
, 
šo
);

2335 ià(!
	`PageU±od©e
(
age
))

2336 
	`S‘PageU±od©e
(
age
);

2337 
	`fl_node_foÙ”
(
age
, 
šo
, ino, 0, 
Œue
);

2338 
	`£t_cŞd_node
(
·ge
, 
çl£
);

2340 
¤c
 = 
	`F2FS_INODE
(
·ge
);

2341 
d¡
 = 
	`F2FS_INODE
(
age
);

2343 
	`memıy
(
d¡
, 
¤c
, ()&¤c->
i_ext
 - ()src);

2344 
d¡
->
i_size
 = 0;

2345 
d¡
->
i_blocks
 = 
	`ıu_to_Ë64
(1);

2346 
d¡
->
i_lšks
 = 
	`ıu_to_Ë32
(1);

2347 
d¡
->
i_x©Œ_nid
 = 0;

2348 
d¡
->
i_šlše
 = 
¤c
->i_šlš& (
F2FS_INLINE_XATTR
 | 
F2FS_EXTRA_ATTR
);

2349 ià(
d¡
->
i_šlše
 & 
F2FS_EXTRA_ATTR
) {

2350 
d¡
->
i_exŒa_isize
 = 
¤c
->i_extra_isize;

2352 ià(
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sbi
->
sb
) &&

2353 
	`F2FS_FITS_IN_INODE
(
¤c
, 
	`Ë16_to_ıu
(¤c->
i_exŒa_isize
),

2354 
i_šlše_x©Œ_size
))

2355 
d¡
->
i_šlše_x©Œ_size
 = 
¤c
->i_inline_xattr_size;

2357 ià(
	`f2fs_sb_has_´ojeù_quÙa
(
sbi
->
sb
) &&

2358 
	`F2FS_FITS_IN_INODE
(
¤c
, 
	`Ë16_to_ıu
(¤c->
i_exŒa_isize
),

2359 
i_´ojid
))

2360 
d¡
->
i_´ojid
 = 
¤c
->i_projid;

2363 
Ãw_ni
 = 
Şd_ni
;

2364 
Ãw_ni
.
šo
 = ino;

2366 ià(
	`uÆik–y
(
	`šc_v®id_node_couÁ
(
sbi
, 
NULL
, 
Œue
)))

2367 
	`WARN_ON
(1);

2368 
	`£t_node_addr
(
sbi
, &
Ãw_ni
, 
NEW_ADDR
, 
çl£
);

2369 
	`šc_v®id_šode_couÁ
(
sbi
);

2370 
	`£t_·ge_dœty
(
age
);

2371 
	`f2fs_put_·ge
(
age
, 1);

2373 
	}
}

2375 
	$f2fs_»¡Üe_node_summ¬y
(
f2fs_sb_šfo
 *
sbi
,

2376 
£gno
, 
f2fs_summ¬y_block
 *
sum
)

2378 
f2fs_node
 *
º
;

2379 
f2fs_summ¬y
 *
sum_’Œy
;

2380 
block_t
 
addr
;

2381 
i
, 
idx
, 
Ï¡_off£t
, 
Ä·ges
;

2384 
Ï¡_off£t
 = 
sbi
->
blocks_³r_£g
;

2385 
addr
 = 
	`START_BLOCK
(
sbi
, 
£gno
);

2386 
sum_’Œy
 = &
sum
->
’Œ›s
[0];

2388 
i
 = 0; i < 
Ï¡_off£t
; i +ğ
Ä·ges
, 
addr
 +=‚rpages) {

2389 
Ä·ges
 = 
	`mš
(
Ï¡_off£t
 - 
i
, 
BIO_MAX_PAGES
);

2392 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
addr
, 
Ä·ges
, 
META_POR
, 
Œue
);

2394 
idx
 = 
addr
; idx <‡dd¸+ 
Ä·ges
; idx++) {

2395 
·ge
 *·gğ
	`f2fs_g‘_tmp_·ge
(
sbi
, 
idx
);

2397 
º
 = 
	`F2FS_NODE
(
·ge
);

2398 
sum_’Œy
->
nid
 = 
º
->
foÙ”
.nid;

2399 
sum_’Œy
->
v”siÚ
 = 0;

2400 
sum_’Œy
->
ofs_š_node
 = 0;

2401 
sum_’Œy
++;

2402 
	`f2fs_put_·ge
(
·ge
, 1);

2405 
	`šv®id©e_m­pšg_·ges
(
	`META_MAPPING
(
sbi
), 
addr
,

2406 
addr
 + 
Ä·ges
);

2408 
	}
}

2410 
	$»move_Çts_š_jouº®
(
f2fs_sb_šfo
 *
sbi
)

2412 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2413 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

2414 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

2415 
i
;

2417 
	`down_wr™e
(&
cur£g
->
jouº®_rw£m
);

2418 
i
 = 0; i < 
	`Çts_š_cursum
(
jouº®
); i++) {

2419 
Çt_’Œy
 *
Ã
;

2420 
f2fs_Çt_’Œy
 
¿w_Ã
;

2421 
nid_t
 
nid
 = 
	`Ë32_to_ıu
(
	`nid_š_jouº®
(
jouº®
, 
i
));

2423 
¿w_Ã
 = 
	`Çt_š_jouº®
(
jouº®
, 
i
);

2425 
Ã
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

2426 ià(!
Ã
) {

2427 
Ã
 = 
	`__®loc_Çt_’Œy
(
nid
, 
Œue
);

2428 
	`__š™_Çt_’Œy
(
nm_i
, 
Ã
, &
¿w_Ã
, 
Œue
);

2436 ià(!
	`g‘_Çt_æag
(
Ã
, 
IS_DIRTY
) &&

2437 
	`Ë32_to_ıu
(
¿w_Ã
.
block_addr
è=ğ
NULL_ADDR
) {

2438 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2439 
nm_i
->
avaabË_nids
--;

2440 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2443 
	`__£t_Çt_ÿche_dœty
(
nm_i
, 
Ã
);

2445 
	`upd©e_Çts_š_cursum
(
jouº®
, -
i
);

2446 
	`up_wr™e
(&
cur£g
->
jouº®_rw£m
);

2447 
	}
}

2449 
	$__adju¡_Çt_’Œy_£t
(
Çt_’Œy_£t
 *
Ãs
,

2450 
li¡_h—d
 *
h—d
, 
max
)

2452 
Çt_’Œy_£t
 *
cur
;

2454 ià(
Ãs
->
’Œy_út
 >ğ
max
)

2455 
add_out
;

2457 
	`li¡_fÜ_—ch_’Œy
(
cur
, 
h—d
, 
£t_li¡
) {

2458 ià(
cur
->
’Œy_út
 >ğ
Ãs
->entry_cnt) {

2459 
	`li¡_add
(&
Ãs
->
£t_li¡
, 
cur
->£t_li¡.
´ev
);

2463 
add_out
:

2464 
	`li¡_add_
(&
Ãs
->
£t_li¡
, 
h—d
);

2465 
	}
}

2467 
	$__upd©e_Çt_b™s
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
¡¬t_nid
,

2468 
·ge
 *page)

2470 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2471 
Çt_šdex
 = 
¡¬t_nid
 / 
NAT_ENTRY_PER_BLOCK
;

2472 
f2fs_Çt_block
 *
Çt_blk
 = 
	`·ge_add»ss
(
·ge
);

2473 
v®id
 = 0;

2474 
i
 = 0;

2476 ià(!
	`’abËd_Çt_b™s
(
sbi
, 
NULL
))

2479 ià(
Çt_šdex
 == 0) {

2480 
v®id
 = 1;

2481 
i
 = 1;

2483 ; 
i
 < 
NAT_ENTRY_PER_BLOCK
; i++) {

2484 ià(
Çt_blk
->
’Œ›s
[
i
].
block_addr
 !ğ
NULL_ADDR
)

2485 
v®id
++;

2487 ià(
v®id
 == 0) {

2488 
	`__£t_b™_Ë
(
Çt_šdex
, 
nm_i
->
em±y_Çt_b™s
);

2489 
	`__ş—r_b™_Ë
(
Çt_šdex
, 
nm_i
->
fuÎ_Çt_b™s
);

2493 
	`__ş—r_b™_Ë
(
Çt_šdex
, 
nm_i
->
em±y_Çt_b™s
);

2494 ià(
v®id
 =ğ
NAT_ENTRY_PER_BLOCK
)

2495 
	`__£t_b™_Ë
(
Çt_šdex
, 
nm_i
->
fuÎ_Çt_b™s
);

2497 
	`__ş—r_b™_Ë
(
Çt_šdex
, 
nm_i
->
fuÎ_Çt_b™s
);

2498 
	}
}

2500 
	$__æush_Çt_’Œy_£t
(
f2fs_sb_šfo
 *
sbi
,

2501 
Çt_’Œy_£t
 *
£t
, 
ı_cÚŒŞ
 *
ıc
)

2503 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

2504 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

2505 
nid_t
 
¡¬t_nid
 = 
£t
->£ˆ* 
NAT_ENTRY_PER_BLOCK
;

2506 
boŞ
 
to_jouº®
 = 
Œue
;

2507 
f2fs_Çt_block
 *
Çt_blk
;

2508 
Çt_’Œy
 *
Ã
, *
cur
;

2509 
·ge
 *·gğ
NULL
;

2516 ià(
	`’abËd_Çt_b™s
(
sbi
, 
ıc
) ||

2517 !
	`__has_cursum_¥aû
(
jouº®
, 
£t
->
’Œy_út
, 
NAT_JOURNAL
))

2518 
to_jouº®
 = 
çl£
;

2520 ià(
to_jouº®
) {

2521 
	`down_wr™e
(&
cur£g
->
jouº®_rw£m
);

2523 
·ge
 = 
	`g‘_Ãxt_Çt_·ge
(
sbi
, 
¡¬t_nid
);

2524 
Çt_blk
 = 
	`·ge_add»ss
(
·ge
);

2525 
	`f2fs_bug_Ú
(
sbi
, !
Çt_blk
);

2529 
	`li¡_fÜ_—ch_’Œy_§ã
(
Ã
, 
cur
, &
£t
->
’Œy_li¡
, 
li¡
) {

2530 
f2fs_Çt_’Œy
 *
¿w_Ã
;

2531 
nid_t
 
nid
 = 
	`Çt_g‘_nid
(
Ã
);

2532 
off£t
;

2534 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_blkaddr
(
Ã
è=ğ
NEW_ADDR
);

2536 ià(
to_jouº®
) {

2537 
off£t
 = 
	`f2fs_lookup_jouº®_š_cursum
(
jouº®
,

2538 
NAT_JOURNAL
, 
nid
, 1);

2539 
	`f2fs_bug_Ú
(
sbi
, 
off£t
 < 0);

2540 
¿w_Ã
 = &
	`Çt_š_jouº®
(
jouº®
, 
off£t
);

2541 
	`nid_š_jouº®
(
jouº®
, 
off£t
èğ
	`ıu_to_Ë32
(
nid
);

2543 
¿w_Ã
 = &
Çt_blk
->
’Œ›s
[
nid
 - 
¡¬t_nid
];

2545 
	`¿w_Çt_äom_node_šfo
(
¿w_Ã
, &
Ã
->
ni
);

2546 
	`Çt_»£t_æag
(
Ã
);

2547 
	`__ş—r_Çt_ÿche_dœty
(
	`NM_I
(
sbi
), 
£t
, 
Ã
);

2548 ià(
	`Çt_g‘_blkaddr
(
Ã
è=ğ
NULL_ADDR
) {

2549 
	`add_ä“_nid
(
sbi
, 
nid
, 
çl£
, 
Œue
);

2551 
	`¥š_lock
(&
	`NM_I
(
sbi
)->
nid_li¡_lock
);

2552 
	`upd©e_ä“_nid_b™m­
(
sbi
, 
nid
, 
çl£
, false);

2553 
	`¥š_uÆock
(&
	`NM_I
(
sbi
)->
nid_li¡_lock
);

2557 ià(
to_jouº®
) {

2558 
	`up_wr™e
(&
cur£g
->
jouº®_rw£m
);

2560 
	`__upd©e_Çt_b™s
(
sbi
, 
¡¬t_nid
, 
·ge
);

2561 
	`f2fs_put_·ge
(
·ge
, 1);

2565 ià(!
£t
->
’Œy_út
) {

2566 
	`¿dix_Œ“_d–‘e
(&
	`NM_I
(
sbi
)->
Çt_£t_roÙ
, 
£t
->set);

2567 
	`kmem_ÿche_ä“
(
Çt_’Œy_£t_¦ab
, 
£t
);

2569 
	}
}

2574 
	$f2fs_æush_Çt_’Œ›s
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

2576 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2577 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

2578 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

2579 
Çt_’Œy_£t
 *
£tvec
[
SETVEC_SIZE
];

2580 
Çt_’Œy_£t
 *
£t
, *
tmp
;

2581 
found
;

2582 
nid_t
 
£t_idx
 = 0;

2583 
	`LIST_HEAD
(
£ts
);

2585 ià(!
nm_i
->
dœty_Çt_út
)

2588 
	`down_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

2595 ià(
	`’abËd_Çt_b™s
(
sbi
, 
ıc
) ||

2596 !
	`__has_cursum_¥aû
(
jouº®
, 
nm_i
->
dœty_Çt_út
, 
NAT_JOURNAL
))

2597 
	`»move_Çts_š_jouº®
(
sbi
);

2599 (
found
 = 
	`__gªg_lookup_Çt_£t
(
nm_i
,

2600 
£t_idx
, 
SETVEC_SIZE
, 
£tvec
))) {

2601 
idx
;

2602 
£t_idx
 = 
£tvec
[
found
 - 1]->
£t
 + 1;

2603 
idx
 = 0; idx < 
found
; idx++)

2604 
	`__adju¡_Çt_’Œy_£t
(
£tvec
[
idx
], &
£ts
,

2605 
	`MAX_NAT_JENTRIES
(
jouº®
));

2609 
	`li¡_fÜ_—ch_’Œy_§ã
(
£t
, 
tmp
, &
£ts
, 
£t_li¡
)

2610 
	`__æush_Çt_’Œy_£t
(
sbi
, 
£t
, 
ıc
);

2612 
	`up_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

2614 
	}
}

2616 
	$__g‘_Çt_b™m­s
(
f2fs_sb_šfo
 *
sbi
)

2618 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

2619 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2620 
Çt_b™s_by‹s
 = 
nm_i
->
Çt_blocks
 / 
BITS_PER_BYTE
;

2621 
i
;

2622 
__u64
 
ı_v”
 = 
	`cur_ı_v”siÚ
(
ck±
);

2623 
block_t
 
Çt_b™s_addr
;

2625 ià(!
	`’abËd_Çt_b™s
(
sbi
, 
NULL
))

2628 
nm_i
->
Çt_b™s_blocks
 = 
	`F2FS_BLK_ALIGN
((
Çt_b™s_by‹s
 << 1) + 8);

2629 
nm_i
->
Çt_b™s
 = 
	`f2fs_kz®loc
(
sbi
,

2630 
nm_i
->
Çt_b™s_blocks
 << 
F2FS_BLKSIZE_BITS
, 
GFP_KERNEL
);

2631 ià(!
nm_i
->
Çt_b™s
)

2632  -
ENOMEM
;

2634 
Çt_b™s_addr
 = 
	`__¡¬t_ı_addr
(
sbi
è+ sbi->
blocks_³r_£g
 -

2635 
nm_i
->
Çt_b™s_blocks
;

2636 
i
 = 0; i < 
nm_i
->
Çt_b™s_blocks
; i++) {

2637 
·ge
 *·gğ
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
Çt_b™s_addr
++);

2639 
	`memıy
(
nm_i
->
Çt_b™s
 + (
i
 << 
F2FS_BLKSIZE_BITS
),

2640 
	`·ge_add»ss
(
·ge
), 
F2FS_BLKSIZE
);

2641 
	`f2fs_put_·ge
(
·ge
, 1);

2644 
ı_v”
 |ğ(
	`cur_ı_üc
(
ck±
) << 32);

2645 ià(
	`ıu_to_Ë64
(
ı_v”
è!ğ*(
__Ë64
 *)
nm_i
->
Çt_b™s
) {

2646 
	`di§bË_Çt_b™s
(
sbi
, 
Œue
);

2650 
nm_i
->
fuÎ_Çt_b™s
 =‚m_i->
Çt_b™s
 + 8;

2651 
nm_i
->
em±y_Çt_b™s
 =‚m_i->
fuÎ_Çt_b™s
 + 
Çt_b™s_by‹s
;

2653 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_NOTICE
, "Found‚at_bits in checkpoint");

2655 
	}
}

2657 
šlše
 
	$lßd_ä“_nid_b™m­
(
f2fs_sb_šfo
 *
sbi
)

2659 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2660 
i
 = 0;

2661 
nid_t
 
nid
, 
Ï¡_nid
;

2663 ià(!
	`’abËd_Çt_b™s
(
sbi
, 
NULL
))

2666 
i
 = 0; i < 
nm_i
->
Çt_blocks
; i++) {

2667 
i
 = 
	`fšd_Ãxt_b™_Ë
(
nm_i
->
em±y_Çt_b™s
,‚m_i->
Çt_blocks
, i);

2668 ià(
i
 >ğ
nm_i
->
Çt_blocks
)

2671 
	`__£t_b™_Ë
(
i
, 
nm_i
->
Çt_block_b™m­
);

2673 
nid
 = 
i
 * 
NAT_ENTRY_PER_BLOCK
;

2674 
Ï¡_nid
 = 
nid
 + 
NAT_ENTRY_PER_BLOCK
;

2676 
	`¥š_lock
(&
	`NM_I
(
sbi
)->
nid_li¡_lock
);

2677 ; 
nid
 < 
Ï¡_nid
;‚id++)

2678 
	`upd©e_ä“_nid_b™m­
(
sbi
, 
nid
, 
Œue
,rue);

2679 
	`¥š_uÆock
(&
	`NM_I
(
sbi
)->
nid_li¡_lock
);

2682 
i
 = 0; i < 
nm_i
->
Çt_blocks
; i++) {

2683 
i
 = 
	`fšd_Ãxt_b™_Ë
(
nm_i
->
fuÎ_Çt_b™s
,‚m_i->
Çt_blocks
, i);

2684 ià(
i
 >ğ
nm_i
->
Çt_blocks
)

2687 
	`__£t_b™_Ë
(
i
, 
nm_i
->
Çt_block_b™m­
);

2689 
	}
}

2691 
	$š™_node_mªag”
(
f2fs_sb_šfo
 *
sbi
)

2693 
f2fs_su³r_block
 *
sb_¿w
 = 
	`F2FS_RAW_SUPER
(
sbi
);

2694 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2695 *
v”siÚ_b™m­
;

2696 
Çt_£gs
;

2697 
”r
;

2699 
nm_i
->
Çt_blkaddr
 = 
	`Ë32_to_ıu
(
sb_¿w
->nat_blkaddr);

2702 
Çt_£gs
 = 
	`Ë32_to_ıu
(
sb_¿w
->
£gm’t_couÁ_Çt
) >> 1;

2703 
nm_i
->
Çt_blocks
 = 
Çt_£gs
 << 
	`Ë32_to_ıu
(
sb_¿w
->
log_blocks_³r_£g
);

2704 
nm_i
->
max_nid
 = 
NAT_ENTRY_PER_BLOCK
 *‚m_i->
Çt_blocks
;

2707 
nm_i
->
avaabË_nids
 =‚m_i->
max_nid
 - 
sbi
->
tÙ®_v®id_node_couÁ
 -

2708 
sbi
->
nquÙa_fes
 - 
F2FS_RESERVED_NODE_NUM
;

2709 
nm_i
->
nid_út
[
FREE_NID
] = 0;

2710 
nm_i
->
nid_út
[
PREALLOC_NID
] = 0;

2711 
nm_i
->
Çt_út
 = 0;

2712 
nm_i
->
¿m_th»sh
 = 
DEF_RAM_THRESHOLD
;

2713 
nm_i
->
¿_nid_·ges
 = 
DEF_RA_NID_PAGES
;

2714 
nm_i
->
dœty_Çts_¿tio
 = 
DEF_DIRTY_NAT_RATIO_THRESHOLD
;

2716 
	`INIT_RADIX_TREE
(&
nm_i
->
ä“_nid_roÙ
, 
GFP_ATOMIC
);

2717 
	`INIT_LIST_HEAD
(&
nm_i
->
ä“_nid_li¡
);

2718 
	`INIT_RADIX_TREE
(&
nm_i
->
Çt_roÙ
, 
GFP_NOIO
);

2719 
	`INIT_RADIX_TREE
(&
nm_i
->
Çt_£t_roÙ
, 
GFP_NOIO
);

2720 
	`INIT_LIST_HEAD
(&
nm_i
->
Çt_’Œ›s
);

2722 
	`mu‹x_š™
(&
nm_i
->
bud_lock
);

2723 
	`¥š_lock_š™
(&
nm_i
->
nid_li¡_lock
);

2724 
	`š™_rw£m
(&
nm_i
->
Çt_Œ“_lock
);

2726 
nm_i
->
Ãxt_sÿn_nid
 = 
	`Ë32_to_ıu
(
sbi
->
ck±
->
Ãxt_ä“_nid
);

2727 
nm_i
->
b™m­_size
 = 
	`__b™m­_size
(
sbi
, 
NAT_BITMAP
);

2728 
v”siÚ_b™m­
 = 
	`__b™m­_±r
(
sbi
, 
NAT_BITMAP
);

2729 ià(!
v”siÚ_b™m­
)

2730  -
EFAULT
;

2732 
nm_i
->
Çt_b™m­
 = 
	`kmemdup
(
v”siÚ_b™m­
,‚m_i->
b™m­_size
,

2733 
GFP_KERNEL
);

2734 ià(!
nm_i
->
Çt_b™m­
)

2735  -
ENOMEM
;

2737 
”r
 = 
	`__g‘_Çt_b™m­s
(
sbi
);

2738 ià(
”r
)

2739  
”r
;

2741 #ifdeà
CONFIG_F2FS_CHECK_FS


2742 
nm_i
->
Çt_b™m­_mœ
 = 
	`kmemdup
(
v”siÚ_b™m­
,‚m_i->
b™m­_size
,

2743 
GFP_KERNEL
);

2744 ià(!
nm_i
->
Çt_b™m­_mœ
)

2745  -
ENOMEM
;

2749 
	}
}

2751 
	$š™_ä“_nid_ÿche
(
f2fs_sb_šfo
 *
sbi
)

2753 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2754 
i
;

2756 
nm_i
->
ä“_nid_b™m­
 =

2757 
	`f2fs_kz®loc
(
sbi
, 
	`¬¿y_size
((*),

2758 
nm_i
->
Çt_blocks
),

2759 
GFP_KERNEL
);

2760 ià(!
nm_i
->
ä“_nid_b™m­
)

2761  -
ENOMEM
;

2763 
i
 = 0; i < 
nm_i
->
Çt_blocks
; i++) {

2764 
nm_i
->
ä“_nid_b™m­
[
i
] = 
	`f2fs_kvz®loc
(
sbi
,

2765 
NAT_ENTRY_BITMAP_SIZE_ALIGNED
, 
GFP_KERNEL
);

2766 ià(!
nm_i
->
ä“_nid_b™m­
)

2767  -
ENOMEM
;

2770 
nm_i
->
Çt_block_b™m­
 = 
	`f2fs_kvz®loc
(
sbi
,‚m_i->
Çt_blocks
 / 8,

2771 
GFP_KERNEL
);

2772 ià(!
nm_i
->
Çt_block_b™m­
)

2773  -
ENOMEM
;

2775 
nm_i
->
ä“_nid_couÁ
 =

2776 
	`f2fs_kvz®loc
(
sbi
, 
	`¬¿y_size
((),

2777 
nm_i
->
Çt_blocks
),

2778 
GFP_KERNEL
);

2779 ià(!
nm_i
->
ä“_nid_couÁ
)

2780  -
ENOMEM
;

2782 
	}
}

2784 
	$f2fs_bud_node_mªag”
(
f2fs_sb_šfo
 *
sbi
)

2786 
”r
;

2788 
sbi
->
nm_šfo
 = 
	`f2fs_kz®loc
(sbi, (
f2fs_nm_šfo
),

2789 
GFP_KERNEL
);

2790 ià(!
sbi
->
nm_šfo
)

2791  -
ENOMEM
;

2793 
”r
 = 
	`š™_node_mªag”
(
sbi
);

2794 ià(
”r
)

2795  
”r
;

2797 
”r
 = 
	`š™_ä“_nid_ÿche
(
sbi
);

2798 ià(
”r
)

2799  
”r
;

2802 
	`lßd_ä“_nid_b™m­
(
sbi
);

2804 
	`f2fs_bud_ä“_nids
(
sbi
, 
Œue
,rue);

2806 
	}
}

2808 
	$f2fs_de¡roy_node_mªag”
(
f2fs_sb_šfo
 *
sbi
)

2810 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2811 
ä“_nid
 *
i
, *
Ãxt_i
;

2812 
Çt_’Œy
 *
Çtvec
[
NATVEC_SIZE
];

2813 
Çt_’Œy_£t
 *
£tvec
[
SETVEC_SIZE
];

2814 
nid_t
 
nid
 = 0;

2815 
found
;

2817 ià(!
nm_i
)

2821 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2822 
	`li¡_fÜ_—ch_’Œy_§ã
(
i
, 
Ãxt_i
, &
nm_i
->
ä“_nid_li¡
, 
li¡
) {

2823 
	`__»move_ä“_nid
(
sbi
, 
i
, 
FREE_NID
);

2824 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2825 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

2826 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2828 
	`f2fs_bug_Ú
(
sbi
, 
nm_i
->
nid_út
[
FREE_NID
]);

2829 
	`f2fs_bug_Ú
(
sbi
, 
nm_i
->
nid_út
[
PREALLOC_NID
]);

2830 
	`f2fs_bug_Ú
(
sbi
, !
	`li¡_em±y
(&
nm_i
->
ä“_nid_li¡
));

2831 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2834 
	`down_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

2835 (
found
 = 
	`__gªg_lookup_Çt_ÿche
(
nm_i
,

2836 
nid
, 
NATVEC_SIZE
, 
Çtvec
))) {

2837 
idx
;

2839 
nid
 = 
	`Çt_g‘_nid
(
Çtvec
[
found
 - 1]) + 1;

2840 
idx
 = 0; idx < 
found
; idx++)

2841 
	`__d–_äom_Çt_ÿche
(
nm_i
, 
Çtvec
[
idx
]);

2843 
	`f2fs_bug_Ú
(
sbi
, 
nm_i
->
Çt_út
);

2846 
nid
 = 0;

2847 (
found
 = 
	`__gªg_lookup_Çt_£t
(
nm_i
,

2848 
nid
, 
SETVEC_SIZE
, 
£tvec
))) {

2849 
idx
;

2851 
nid
 = 
£tvec
[
found
 - 1]->
£t
 + 1;

2852 
idx
 = 0; idx < 
found
; idx++) {

2854 
	`f2fs_bug_Ú
(
sbi
, !
	`li¡_em±y
(&
£tvec
[
idx
]->
’Œy_li¡
));

2855 
	`¿dix_Œ“_d–‘e
(&
nm_i
->
Çt_£t_roÙ
, 
£tvec
[
idx
]->
£t
);

2856 
	`kmem_ÿche_ä“
(
Çt_’Œy_£t_¦ab
, 
£tvec
[
idx
]);

2859 
	`up_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

2861 
	`kvä“
(
nm_i
->
Çt_block_b™m­
);

2862 ià(
nm_i
->
ä“_nid_b™m­
) {

2863 
i
;

2865 
i
 = 0; i < 
nm_i
->
Çt_blocks
; i++)

2866 
	`kvä“
(
nm_i
->
ä“_nid_b™m­
[
i
]);

2867 
	`kä“
(
nm_i
->
ä“_nid_b™m­
);

2869 
	`kvä“
(
nm_i
->
ä“_nid_couÁ
);

2871 
	`kä“
(
nm_i
->
Çt_b™m­
);

2872 
	`kä“
(
nm_i
->
Çt_b™s
);

2873 #ifdeà
CONFIG_F2FS_CHECK_FS


2874 
	`kä“
(
nm_i
->
Çt_b™m­_mœ
);

2876 
sbi
->
nm_šfo
 = 
NULL
;

2877 
	`kä“
(
nm_i
);

2878 
	}
}

2880 
__š™
 
	$f2fs_ü—‹_node_mªag”_ÿches
()

2882 
Çt_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("nat_entry",

2883 (
Çt_’Œy
));

2884 ià(!
Çt_’Œy_¦ab
)

2885 
ç
;

2887 
ä“_nid_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("free_nid",

2888 (
ä“_nid
));

2889 ià(!
ä“_nid_¦ab
)

2890 
de¡roy_Çt_’Œy
;

2892 
Çt_’Œy_£t_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("nat_entry_set",

2893 (
Çt_’Œy_£t
));

2894 ià(!
Çt_’Œy_£t_¦ab
)

2895 
de¡roy_ä“_nid
;

2898 
de¡roy_ä“_nid
:

2899 
	`kmem_ÿche_de¡roy
(
ä“_nid_¦ab
);

2900 
de¡roy_Çt_’Œy
:

2901 
	`kmem_ÿche_de¡roy
(
Çt_’Œy_¦ab
);

2902 
ç
:

2903  -
ENOMEM
;

2904 
	}
}

2906 
	$f2fs_de¡roy_node_mªag”_ÿches
()

2908 
	`kmem_ÿche_de¡roy
(
Çt_’Œy_£t_¦ab
);

2909 
	`kmem_ÿche_de¡roy
(
ä“_nid_¦ab
);

2910 
	`kmem_ÿche_de¡roy
(
Çt_’Œy_¦ab
);

2911 
	}
}

	@fs/f2fs/node.h

12 
	#START_NID
(
nid
è((Òidè/ 
NAT_ENTRY_PER_BLOCK
è* NAT_ENTRY_PER_BLOCK)

	)

15 
	#NAT_BLOCK_OFFSET
(
¡¬t_nid
è((¡¬t_nidè/ 
NAT_ENTRY_PER_BLOCK
)

	)

18 
	#FREE_NID_PAGES
 8

	)

19 
	#MAX_FREE_NIDS
 (
NAT_ENTRY_PER_BLOCK
 * 
FREE_NID_PAGES
)

	)

21 
	#DEF_RA_NID_PAGES
 0

	)

24 
	#MAX_RA_NODE
 128

	)

27 
	#DEF_RAM_THRESHOLD
 1

	)

30 
	#DEF_DIRTY_NAT_RATIO_THRESHOLD
 10

	)

32 
	#DEF_NAT_CACHE_THRESHOLD
 100000

	)

35 
	#NATVEC_SIZE
 64

	)

36 
	#SETVEC_SIZE
 32

	)

39 
	#LOCKED_PAGE
 1

	)

43 
	mIS_CHECKPOINTED
,

44 
	mHAS_FSYNCED_INODE
,

45 
	mHAS_LAST_FSYNC
,

46 
	mIS_DIRTY
,

47 
	mIS_PREALLOC
,

53 
	snode_šfo
 {

54 
nid_t
 
	mnid
;

55 
nid_t
 
	mšo
;

56 
block_t
 
	mblk_addr
;

57 
	mv”siÚ
;

58 
	mæag
;

61 
	sÇt_’Œy
 {

62 
li¡_h—d
 
	mli¡
;

63 
node_šfo
 
	mni
;

66 
	#Çt_g‘_nid
(
Çt
è(Ò©)->
ni
.
nid
)

	)

67 
	#Çt_£t_nid
(
Çt
, 
n
è(Ò©)->
ni
.
nid
 = (n))

	)

68 
	#Çt_g‘_blkaddr
(
Çt
è(Ò©)->
ni
.
blk_addr
)

	)

69 
	#Çt_£t_blkaddr
(
Çt
, 
b
è(Ò©)->
ni
.
blk_addr
 = (b))

	)

70 
	#Çt_g‘_šo
(
Çt
è(Ò©)->
ni
.
šo
)

	)

71 
	#Çt_£t_šo
(
Çt
, 
i
è(Ò©)->
ni
.
šo
 = (i))

	)

72 
	#Çt_g‘_v”siÚ
(
Çt
è(Ò©)->
ni
.
v”siÚ
)

	)

73 
	#Çt_£t_v”siÚ
(
Çt
, 
v
è(Ò©)->
ni
.
v”siÚ
 = (v))

	)

75 
	#šc_node_v”siÚ
(
v”siÚ
è(++(v”siÚ))

	)

77 
šlše
 
	$cİy_node_šfo
(
node_šfo
 *
d¡
,

78 
node_šfo
 *
¤c
)

80 
d¡
->
nid
 = 
¤c
->nid;

81 
d¡
->
šo
 = 
¤c
->ino;

82 
d¡
->
blk_addr
 = 
¤c
->blk_addr;

83 
d¡
->
v”siÚ
 = 
¤c
->version;

85 
	}
}

87 
šlše
 
	$£t_Çt_æag
(
Çt_’Œy
 *
Ã
,

88 
ty³
, 
boŞ
 
£t
)

90 
mask
 = 0x01 << 
ty³
;

91 ià(
£t
)

92 
Ã
->
ni
.
æag
 |ğ
mask
;

94 
Ã
->
ni
.
æag
 &ğ~
mask
;

95 
	}
}

97 
šlše
 
boŞ
 
	$g‘_Çt_æag
(
Çt_’Œy
 *
Ã
, 
ty³
)

99 
mask
 = 0x01 << 
ty³
;

100  
Ã
->
ni
.
æag
 & 
mask
;

101 
	}
}

103 
šlše
 
	$Çt_»£t_æag
(
Çt_’Œy
 *
Ã
)

106 
	`£t_Çt_æag
(
Ã
, 
IS_CHECKPOINTED
, 
Œue
);

107 
	`£t_Çt_æag
(
Ã
, 
HAS_FSYNCED_INODE
, 
çl£
);

108 
	`£t_Çt_æag
(
Ã
, 
HAS_LAST_FSYNC
, 
Œue
);

109 
	}
}

111 
šlše
 
	$node_šfo_äom_¿w_Çt
(
node_šfo
 *
ni
,

112 
f2fs_Çt_’Œy
 *
¿w_Ã
)

114 
ni
->
šo
 = 
	`Ë32_to_ıu
(
¿w_Ã
->ino);

115 
ni
->
blk_addr
 = 
	`Ë32_to_ıu
(
¿w_Ã
->
block_addr
);

116 
ni
->
v”siÚ
 = 
¿w_Ã
->version;

117 
	}
}

119 
šlše
 
	$¿w_Çt_äom_node_šfo
(
f2fs_Çt_’Œy
 *
¿w_Ã
,

120 
node_šfo
 *
ni
)

122 
¿w_Ã
->
šo
 = 
	`ıu_to_Ë32
(
ni
->ino);

123 
¿w_Ã
->
block_addr
 = 
	`ıu_to_Ë32
(
ni
->
blk_addr
);

124 
¿w_Ã
->
v”siÚ
 = 
ni
->version;

125 
	}
}

127 
šlše
 
boŞ
 
	$exûss_dœty_Çts
(
f2fs_sb_šfo
 *
sbi
)

129  
	`NM_I
(
sbi
)->
dœty_Çt_út
 >ğNM_I(sbi)->
max_nid
 *

130 
	`NM_I
(
sbi
)->
dœty_Çts_¿tio
 / 100;

131 
	}
}

133 
šlše
 
boŞ
 
	$exûss_ÿched_Çts
(
f2fs_sb_šfo
 *
sbi
)

135  
	`NM_I
(
sbi
)->
Çt_út
 >ğ
DEF_NAT_CACHE_THRESHOLD
;

136 
	}
}

138 
	emem_ty³
 {

139 
	mFREE_NIDS
,

140 
	mNAT_ENTRIES
,

141 
	mDIRTY_DENTS
,

142 
	mINO_ENTRIES
,

143 
	mEXTENT_CACHE
,

144 
	mINMEM_PAGES
,

145 
	mBASE_CHECK
,

148 
	sÇt_’Œy_£t
 {

149 
li¡_h—d
 
	m£t_li¡
;

150 
li¡_h—d
 
	m’Œy_li¡
;

151 
nid_t
 
	m£t
;

152 
	m’Œy_út
;

155 
	sä“_nid
 {

156 
li¡_h—d
 
	mli¡
;

157 
nid_t
 
	mnid
;

158 
	m¡©e
;

161 
šlše
 
	$Ãxt_ä“_nid
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 *
nid
)

163 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

164 
ä“_nid
 *
âid
;

166 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

167 ià(
nm_i
->
nid_út
[
FREE_NID
] <= 0) {

168 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

171 
âid
 = 
	`li¡_fœ¡_’Œy
(&
nm_i
->
ä“_nid_li¡
, 
ä“_nid
, 
li¡
);

172 *
nid
 = 
âid
->nid;

173 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

174 
	}
}

179 
šlše
 
	$g‘_Çt_b™m­
(
f2fs_sb_šfo
 *
sbi
, *
addr
)

181 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

183 #ifdeà
CONFIG_F2FS_CHECK_FS


184 ià(
	`memcmp
(
nm_i
->
Çt_b™m­
,‚m_i->
Çt_b™m­_mœ
,

185 
nm_i
->
b™m­_size
))

186 
	`f2fs_bug_Ú
(
sbi
, 1);

188 
	`memıy
(
addr
, 
nm_i
->
Çt_b™m­
,‚m_i->
b™m­_size
);

189 
	}
}

191 
šlše
 
pgoff_t
 
	$cu¼’t_Çt_addr
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
¡¬t
)

193 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

194 
pgoff_t
 
block_off
;

195 
pgoff_t
 
block_addr
;

202 
block_off
 = 
	`NAT_BLOCK_OFFSET
(
¡¬t
);

204 
block_addr
 = (
pgoff_t
)(
nm_i
->
Çt_blkaddr
 +

205 (
block_off
 << 1) -

206 (
block_off
 & (
sbi
->
blocks_³r_£g
 - 1)));

208 ià(
	`f2fs_‹¡_b™
(
block_off
, 
nm_i
->
Çt_b™m­
))

209 
block_addr
 +ğ
sbi
->
blocks_³r_£g
;

211  
block_addr
;

212 
	}
}

214 
šlše
 
pgoff_t
 
	$Ãxt_Çt_addr
(
f2fs_sb_šfo
 *
sbi
,

215 
pgoff_t
 
block_addr
)

217 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

219 
block_addr
 -ğ
nm_i
->
Çt_blkaddr
;

220 
block_addr
 ^ğ1 << 
sbi
->
log_blocks_³r_£g
;

221  
block_addr
 + 
nm_i
->
Çt_blkaddr
;

222 
	}
}

224 
šlše
 
	$£t_to_Ãxt_Çt
(
f2fs_nm_šfo
 *
nm_i
, 
nid_t
 
¡¬t_nid
)

226 
block_off
 = 
	`NAT_BLOCK_OFFSET
(
¡¬t_nid
);

228 
	`f2fs_chªge_b™
(
block_off
, 
nm_i
->
Çt_b™m­
);

229 #ifdeà
CONFIG_F2FS_CHECK_FS


230 
	`f2fs_chªge_b™
(
block_off
, 
nm_i
->
Çt_b™m­_mœ
);

232 
	}
}

234 
šlše
 
nid_t
 
	$šo_of_node
(
·ge
 *
node_·ge
)

236 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

237  
	`Ë32_to_ıu
(
º
->
foÙ”
.
šo
);

238 
	}
}

240 
šlše
 
nid_t
 
	$nid_of_node
(
·ge
 *
node_·ge
)

242 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

243  
	`Ë32_to_ıu
(
º
->
foÙ”
.
nid
);

244 
	}
}

246 
šlše
 
	$ofs_of_node
(
·ge
 *
node_·ge
)

248 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

249 
æag
 = 
	`Ë32_to_ıu
(
º
->
foÙ”
.flag);

250  
æag
 >> 
OFFSET_BIT_SHIFT
;

251 
	}
}

253 
šlše
 
__u64
 
	$ıv”_of_node
(
·ge
 *
node_·ge
)

255 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

256  
	`Ë64_to_ıu
(
º
->
foÙ”
.
ı_v”
);

257 
	}
}

259 
šlše
 
block_t
 
	$Ãxt_blkaddr_of_node
(
·ge
 *
node_·ge
)

261 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

262  
	`Ë32_to_ıu
(
º
->
foÙ”
.
Ãxt_blkaddr
);

263 
	}
}

265 
šlše
 
	$fl_node_foÙ”
(
·ge
 *·ge, 
nid_t
 
nid
,

266 
nid_t
 
šo
, 
ofs
, 
boŞ
 
»£t
)

268 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

269 
Şd_æag
 = 0;

271 ià(
»£t
)

272 
	`mem£t
(
º
, 0, (*rn));

274 
Şd_æag
 = 
	`Ë32_to_ıu
(
º
->
foÙ”
.
æag
);

276 
º
->
foÙ”
.
nid
 = 
	`ıu_to_Ë32
(nid);

277 
º
->
foÙ”
.
šo
 = 
	`ıu_to_Ë32
(ino);

280 
º
->
foÙ”
.
æag
 = 
	`ıu_to_Ë32
((
ofs
 << 
OFFSET_BIT_SHIFT
) |

281 (
Şd_æag
 & 
OFFSET_BIT_MASK
));

282 
	}
}

284 
šlše
 
	$cİy_node_foÙ”
(
·ge
 *
d¡
, ·g*
¤c
)

286 
f2fs_node
 *
¤c_º
 = 
	`F2FS_NODE
(
¤c
);

287 
f2fs_node
 *
d¡_º
 = 
	`F2FS_NODE
(
d¡
);

288 
	`memıy
(&
d¡_º
->
foÙ”
, &
¤c_º
->foÙ”, (
node_foÙ”
));

289 
	}
}

291 
šlše
 
	$fl_node_foÙ”_blkaddr
(
·ge
 *·ge, 
block_t
 
blkaddr
)

293 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
	`F2FS_P_SB
(
·ge
));

294 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

295 
__u64
 
ı_v”
 = 
	`cur_ı_v”siÚ
(
ck±
);

297 ià(
	`__is_£t_ck±_æags
(
ck±
, 
CP_CRC_RECOVERY_FLAG
))

298 
ı_v”
 |ğ(
	`cur_ı_üc
(
ck±
) << 32);

300 
º
->
foÙ”
.
ı_v”
 = 
	`ıu_to_Ë64
(cp_ver);

301 
º
->
foÙ”
.
Ãxt_blkaddr
 = 
	`ıu_to_Ë32
(
blkaddr
);

302 
	}
}

304 
šlše
 
boŞ
 
	$is_»cov”abË_dnode
(
·ge
 *page)

306 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
	`F2FS_P_SB
(
·ge
));

307 
__u64
 
ı_v”
 = 
	`cur_ı_v”siÚ
(
ck±
);

310 ià(
	`__is_£t_ck±_æags
(
ck±
, 
CP_NOCRC_RECOVERY_FLAG
))

311  (
ı_v”
 << 32è=ğ(
	`ıv”_of_node
(
·ge
) << 32);

313 ià(
	`__is_£t_ck±_æags
(
ck±
, 
CP_CRC_RECOVERY_FLAG
))

314 
ı_v”
 |ğ(
	`cur_ı_üc
(
ck±
) << 32);

316  
ı_v”
 =ğ
	`ıv”_of_node
(
·ge
);

317 
	}
}

340 
šlše
 
boŞ
 
	$IS_DNODE
(
·ge
 *
node_·ge
)

342 
ofs
 = 
	`ofs_of_node
(
node_·ge
);

344 ià(
	`f2fs_has_x©Œ_block
(
ofs
))

345  
Œue
;

347 ià(
ofs
 =ğ3 || of =ğ4 + 
NIDS_PER_BLOCK
 ||

348 
ofs
 =ğ5 + 2 * 
NIDS_PER_BLOCK
)

349  
çl£
;

350 ià(
ofs
 >ğ6 + 2 * 
NIDS_PER_BLOCK
) {

351 
ofs
 -ğ6 + 2 * 
NIDS_PER_BLOCK
;

352 ià(!(()
ofs
 % (
NIDS_PER_BLOCK
 + 1)))

353  
çl£
;

355  
Œue
;

356 
	}
}

358 
šlše
 
	$£t_nid
(
·ge
 *
p
, 
off
, 
nid_t
 
nid
, 
boŞ
 
i
)

360 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
p
);

362 
	`f2fs_wa™_Ú_·ge_wr™eback
(
p
, 
NODE
, 
Œue
);

364 ià(
i
)

365 
º
->
i
.
i_nid
[
off
 - 
NODE_DIR1_BLOCK
] = 
	`ıu_to_Ë32
(
nid
);

367 
º
->
š
.
nid
[
off
] = 
	`ıu_to_Ë32
(nid);

368  
	`£t_·ge_dœty
(
p
);

369 
	}
}

371 
šlše
 
nid_t
 
	$g‘_nid
(
·ge
 *
p
, 
off
, 
boŞ
 
i
)

373 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
p
);

375 ià(
i
)

376  
	`Ë32_to_ıu
(
º
->
i
.
i_nid
[
off
 - 
NODE_DIR1_BLOCK
]);

377  
	`Ë32_to_ıu
(
º
->
š
.
nid
[
off
]);

378 
	}
}

386 
šlše
 
	$is_cŞd_d©a
(
·ge
 *page)

388  
	`PageChecked
(
·ge
);

389 
	}
}

391 
šlše
 
	$£t_cŞd_d©a
(
·ge
 *page)

393 
	`S‘PageChecked
(
·ge
);

394 
	}
}

396 
šlše
 
	$ş—r_cŞd_d©a
(
·ge
 *page)

398 
	`CË¬PageChecked
(
·ge
);

399 
	}
}

401 
šlše
 
	$is_node
(
·ge
 *·ge, 
ty³
)

403 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

404  
	`Ë32_to_ıu
(
º
->
foÙ”
.
æag
è& (1 << 
ty³
);

405 
	}
}

407 
	#is_cŞd_node
(
·ge
è
	`is_node
Õage, 
COLD_BIT_SHIFT
)

	)

408 
	#is_fsync_dnode
(
·ge
è
	`is_node
Õage, 
FSYNC_BIT_SHIFT
)

	)

409 
	#is_d’t_dnode
(
·ge
è
	`is_node
Õage, 
DENT_BIT_SHIFT
)

	)

411 
šlše
 
	$is_šlše_node
(
·ge
 *page)

413  
	`PageChecked
(
·ge
);

414 
	}
}

416 
šlše
 
	$£t_šlše_node
(
·ge
 *page)

418 
	`S‘PageChecked
(
·ge
);

419 
	}
}

421 
šlše
 
	$ş—r_šlše_node
(
·ge
 *page)

423 
	`CË¬PageChecked
(
·ge
);

424 
	}
}

426 
šlše
 
	$£t_cŞd_node
(
·ge
 *·ge, 
boŞ
 
is_dœ
)

428 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

429 
æag
 = 
	`Ë32_to_ıu
(
º
->
foÙ”
.flag);

431 ià(
is_dœ
)

432 
æag
 &ğ~(0x1 << 
COLD_BIT_SHIFT
);

434 
æag
 |ğ(0x1 << 
COLD_BIT_SHIFT
);

435 
º
->
foÙ”
.
æag
 = 
	`ıu_to_Ë32
(flag);

436 
	}
}

438 
šlše
 
	$£t_m¬k
(
·ge
 *·ge, 
m¬k
, 
ty³
)

440 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

441 
æag
 = 
	`Ë32_to_ıu
(
º
->
foÙ”
.flag);

442 ià(
m¬k
)

443 
æag
 |ğ(0x1 << 
ty³
);

445 
æag
 &ğ~(0x1 << 
ty³
);

446 
º
->
foÙ”
.
æag
 = 
	`ıu_to_Ë32
(flag);

447 
	}
}

448 
	#£t_d’Œy_m¬k
(
·ge
, 
m¬k
è
	`£t_m¬k
Õage, m¬k, 
DENT_BIT_SHIFT
)

	)

449 
	#£t_fsync_m¬k
(
·ge
, 
m¬k
è
	`£t_m¬k
Õage, m¬k, 
FSYNC_BIT_SHIFT
)

	)

	@fs/f2fs/recovery.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~"f2fs.h
"

14 
	~"node.h
"

15 
	~"£gm’t.h
"

48 
kmem_ÿche
 *
	gfsync_’Œy_¦ab
;

50 
boŞ
 
	$f2fs_¥aû_fÜ_rŞl_fÜw¬d
(
f2fs_sb_šfo
 *
sbi
)

52 
s64
 
ÇÎoc
 = 
	`³rıu_couÁ”_sum_pos™ive
(&
sbi
->
®loc_v®id_block_couÁ
);

54 ià(
sbi
->
Ï¡_v®id_block_couÁ
 + 
ÇÎoc
 > sbi->
u£r_block_couÁ
)

55  
çl£
;

56  
Œue
;

57 
	}
}

59 
fsync_šode_’Œy
 *
	$g‘_fsync_šode
(
li¡_h—d
 *
h—d
,

60 
nid_t
 
šo
)

62 
fsync_šode_’Œy
 *
’Œy
;

64 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, 
h—d
, 
li¡
)

65 ià(
’Œy
->
šode
->
i_šo
 =ğ
šo
)

66  
’Œy
;

68  
NULL
;

69 
	}
}

71 
fsync_šode_’Œy
 *
	$add_fsync_šode
(
f2fs_sb_šfo
 *
sbi
,

72 
li¡_h—d
 *
h—d
, 
nid_t
 
šo
, 
boŞ
 
quÙa_šode
)

74 
šode
 *inode;

75 
fsync_šode_’Œy
 *
’Œy
;

76 
”r
;

78 
šode
 = 
	`f2fs_ig‘_»Œy
(
sbi
->
sb
, 
šo
);

79 ià(
	`IS_ERR
(
šode
))

80  
	`ERR_CAST
(
šode
);

82 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

83 ià(
”r
)

84 
”r_out
;

86 ià(
quÙa_šode
) {

87 
”r
 = 
	`dquÙ_®loc_šode
(
šode
);

88 ià(
”r
)

89 
”r_out
;

92 
’Œy
 = 
	`f2fs_kmem_ÿche_®loc
(
fsync_’Œy_¦ab
, 
GFP_F2FS_ZERO
);

93 
’Œy
->
šode
 = inode;

94 
	`li¡_add_
(&
’Œy
->
li¡
, 
h—d
);

96  
’Œy
;

97 
”r_out
:

98 
	`ut
(
šode
);

99  
	`ERR_PTR
(
”r
);

100 
	}
}

102 
	$d–_fsync_šode
(
fsync_šode_’Œy
 *
’Œy
)

104 
	`ut
(
’Œy
->
šode
);

105 
	`li¡_d–
(&
’Œy
->
li¡
);

106 
	`kmem_ÿche_ä“
(
fsync_’Œy_¦ab
, 
’Œy
);

107 
	}
}

109 
	$»cov”_d’Œy
(
šode
 *šode, 
·ge
 *
age
,

110 
li¡_h—d
 *
dœ_li¡
)

112 
f2fs_šode
 *
¿w_šode
 = 
	`F2FS_INODE
(
age
);

113 
nid_t
 
pšo
 = 
	`Ë32_to_ıu
(
¿w_šode
->
i_pšo
);

114 
f2fs_dœ_’Œy
 *
de
;

115 
fsüy±_Çme
 
âame
;

116 
·ge
 *page;

117 
šode
 *
dœ
, *
ešode
;

118 
fsync_šode_’Œy
 *
’Œy
;

119 
”r
 = 0;

120 *
Çme
;

122 
’Œy
 = 
	`g‘_fsync_šode
(
dœ_li¡
, 
pšo
);

123 ià(!
’Œy
) {

124 
’Œy
 = 
	`add_fsync_šode
(
	`F2FS_I_SB
(
šode
), 
dœ_li¡
,

125 
pšo
, 
çl£
);

126 ià(
	`IS_ERR
(
’Œy
)) {

127 
dœ
 = 
	`ERR_CAST
(
’Œy
);

128 
”r
 = 
	`PTR_ERR
(
’Œy
);

129 
out
;

133 
dœ
 = 
’Œy
->
šode
;

135 
	`mem£t
(&
âame
, 0, (
fsüy±_Çme
));

136 
âame
.
disk_Çme
.
Ën
 = 
	`Ë32_to_ıu
(
¿w_šode
->
i_Çm–’
);

137 
âame
.
disk_Çme
.
Çme
 = 
¿w_šode
->
i_Çme
;

139 ià(
	`uÆik–y
(
âame
.
disk_Çme
.
Ën
 > 
F2FS_NAME_LEN
)) {

140 
	`WARN_ON
(1);

141 
”r
 = -
ENAMETOOLONG
;

142 
out
;

144 
»Œy
:

145 
de
 = 
	`__f2fs_fšd_’Œy
(
dœ
, &
âame
, &
·ge
);

146 ià(
de
 && 
šode
->
i_šo
 =ğ
	`Ë32_to_ıu
(de->
šo
))

147 
out_put
;

149 ià(
de
) {

150 
ešode
 = 
	`f2fs_ig‘_»Œy
(
šode
->
i_sb
, 
	`Ë32_to_ıu
(
de
->
šo
));

151 ià(
	`IS_ERR
(
ešode
)) {

152 
	`WARN_ON
(1);

153 
”r
 = 
	`PTR_ERR
(
ešode
);

154 ià(
”r
 =ğ-
ENOENT
)

155 
”r
 = -
EEXIST
;

156 
out_put
;

159 
”r
 = 
	`dquÙ_š™Ÿlize
(
ešode
);

160 ià(
”r
) {

161 
	`ut
(
ešode
);

162 
out_put
;

165 
”r
 = 
	`f2fs_acquœe_Üphª_šode
(
	`F2FS_I_SB
(
šode
));

166 ià(
”r
) {

167 
	`ut
(
ešode
);

168 
out_put
;

170 
	`f2fs_d–‘e_’Œy
(
de
, 
·ge
, 
dœ
, 
ešode
);

171 
	`ut
(
ešode
);

172 
»Œy
;

173 } ià(
	`IS_ERR
(
·ge
)) {

174 
”r
 = 
	`PTR_ERR
(
·ge
);

176 
”r
 = 
	`f2fs_add_d’Œy
(
dœ
, &
âame
, 
šode
,

177 
šode
->
i_šo
, inode->
i_mode
);

179 ià(
”r
 =ğ-
ENOMEM
)

180 
»Œy
;

181 
out
;

183 
out_put
:

184 
	`f2fs_put_·ge
(
·ge
, 0);

185 
out
:

186 ià(
	`fe_’c_Çme
(
šode
))

187 
Çme
 = "<encrypted>";

189 
Çme
 = 
¿w_šode
->
i_Çme
;

190 
	`f2fs_msg
(
šode
->
i_sb
, 
KERN_NOTICE
,

192 
__func__
, 
	`šo_of_node
(
age
), 
Çme
,

193 
	`IS_ERR
(
dœ
è? 0 : dœ->
i_šo
, 
”r
);

194  
”r
;

195 
	}
}

197 
	$»cov”_šlše_æags
(
šode
 *šode, 
f2fs_šode
 *
ri
)

199 ià(
ri
->
i_šlše
 & 
F2FS_PIN_FILE
)

200 
	`£t_šode_æag
(
šode
, 
FI_PIN_FILE
);

202 
	`ş—r_šode_æag
(
šode
, 
FI_PIN_FILE
);

203 ià(
ri
->
i_šlše
 & 
F2FS_DATA_EXIST
)

204 
	`£t_šode_æag
(
šode
, 
FI_DATA_EXIST
);

206 
	`ş—r_šode_æag
(
šode
, 
FI_DATA_EXIST
);

207 
	}
}

209 
	$»cov”_šode
(
šode
 *šode, 
·ge
 *page)

211 
f2fs_šode
 *
¿w
 = 
	`F2FS_INODE
(
·ge
);

212 *
Çme
;

214 
šode
->
i_mode
 = 
	`Ë16_to_ıu
(
¿w
->i_mode);

215 
	`f2fs_i_size_wr™e
(
šode
, 
	`Ë64_to_ıu
(
¿w
->
i_size
));

216 
šode
->
i_©ime
.
tv_£c
 = 
	`Ë64_to_ıu
(
¿w
->i_atime);

217 
šode
->
i_ùime
.
tv_£c
 = 
	`Ë64_to_ıu
(
¿w
->i_ctime);

218 
šode
->
i_mtime
.
tv_£c
 = 
	`Ë64_to_ıu
(
¿w
->i_mtime);

219 
šode
->
i_©ime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
¿w
->
i_©ime_n£c
);

220 
šode
->
i_ùime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
¿w
->
i_ùime_n£c
);

221 
šode
->
i_mtime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
¿w
->
i_mtime_n£c
);

223 
	`F2FS_I
(
šode
)->
i_advi£
 = 
¿w
->i_advise;

225 
	`»cov”_šlše_æags
(
šode
, 
¿w
);

227 ià(
	`fe_’c_Çme
(
šode
))

228 
Çme
 = "<encrypted>";

230 
Çme
 = 
	`F2FS_INODE
(
·ge
)->
i_Çme
;

232 
	`f2fs_msg
(
šode
->
i_sb
, 
KERN_NOTICE
,

234 
	`šo_of_node
(
·ge
), 
Çme
, 
¿w
->
i_šlše
);

235 
	}
}

237 
	$fšd_fsync_dnodes
(
f2fs_sb_šfo
 *
sbi
, 
li¡_h—d
 *
h—d
,

238 
boŞ
 
check_Úly
)

240 
cur£g_šfo
 *
cur£g
;

241 
·ge
 *·gğ
NULL
;

242 
block_t
 
blkaddr
;

243 
loİ_út
 = 0;

244 
ä“_blocks
 = 
sbi
->
u£r_block_couÁ
 -

245 
	`v®id_u£r_blocks
(
sbi
);

246 
”r
 = 0;

249 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
);

250 
blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
);

253 
fsync_šode_’Œy
 *
’Œy
;

255 ià(!
	`f2fs_is_v®id_m‘a_blkaddr
(
sbi
, 
blkaddr
, 
META_POR
))

258 
·ge
 = 
	`f2fs_g‘_tmp_·ge
(
sbi
, 
blkaddr
);

260 ià(!
	`is_»cov”abË_dnode
(
·ge
))

263 ià(!
	`is_fsync_dnode
(
·ge
))

264 
Ãxt
;

266 
’Œy
 = 
	`g‘_fsync_šode
(
h—d
, 
	`šo_of_node
(
·ge
));

267 ià(!
’Œy
) {

268 
boŞ
 
quÙa_šode
 = 
çl£
;

270 ià(!
check_Úly
 &&

271 
	`IS_INODE
(
·ge
è&& 
	`is_d’t_dnode
(page)) {

272 
”r
 = 
	`f2fs_»cov”_šode_·ge
(
sbi
, 
·ge
);

273 ià(
”r
)

275 
quÙa_šode
 = 
Œue
;

282 
’Œy
 = 
	`add_fsync_šode
(
sbi
, 
h—d
, 
	`šo_of_node
(
·ge
),

283 
quÙa_šode
);

284 ià(
	`IS_ERR
(
’Œy
)) {

285 
”r
 = 
	`PTR_ERR
(
’Œy
);

286 ià(
”r
 =ğ-
ENOENT
) {

287 
”r
 = 0;

288 
Ãxt
;

293 
’Œy
->
blkaddr
 = blkaddr;

295 ià(
	`IS_INODE
(
·ge
è&& 
	`is_d’t_dnode
(page))

296 
’Œy
->
Ï¡_d’Œy
 = 
blkaddr
;

297 
Ãxt
:

299 ià(++
loİ_út
 >ğ
ä“_blocks
 ||

300 
blkaddr
 =ğ
	`Ãxt_blkaddr_of_node
(
·ge
)) {

301 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_NOTICE
,

304 
__func__
, 
blkaddr
, 
	`Ãxt_blkaddr_of_node
(
·ge
));

305 
”r
 = -
EINVAL
;

310 
blkaddr
 = 
	`Ãxt_blkaddr_of_node
(
·ge
);

311 
	`f2fs_put_·ge
(
·ge
, 1);

313 
	`f2fs_¿_m‘a_·ges_cÚd
(
sbi
, 
blkaddr
);

315 
	`f2fs_put_·ge
(
·ge
, 1);

316  
”r
;

317 
	}
}

319 
	$de¡roy_fsync_dnodes
(
li¡_h—d
 *
h—d
)

321 
fsync_šode_’Œy
 *
’Œy
, *
tmp
;

323 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
tmp
, 
h—d
, 
li¡
)

324 
	`d–_fsync_šode
(
’Œy
);

325 
	}
}

327 
	$check_šdex_š_´ev_nodes
(
f2fs_sb_šfo
 *
sbi
,

328 
block_t
 
blkaddr
, 
dnode_of_d©a
 *
dn
)

330 
£g_’Œy
 *
£Áry
;

331 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
blkaddr
);

332 
blkoff
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
blkaddr
);

333 
f2fs_summ¬y_block
 *
sum_node
;

334 
f2fs_summ¬y
 
sum
;

335 
·ge
 *
sum_·ge
, *
node_·ge
;

336 
dnode_of_d©a
 
tdn
 = *
dn
;

337 
nid_t
 
šo
, 
nid
;

338 
šode
 *inode;

339 
off£t
;

340 
block_t
 
bidx
;

341 
i
;

343 
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

344 ià(!
	`f2fs_‹¡_b™
(
blkoff
, 
£Áry
->
cur_v®id_m­
))

348 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

349 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
i
);

350 ià(
cur£g
->
£gno
 == segno) {

351 
sum
 = 
cur£g
->
sum_blk
->
’Œ›s
[
blkoff
];

352 
gÙ_™
;

356 
sum_·ge
 = 
	`f2fs_g‘_sum_·ge
(
sbi
, 
£gno
);

357 
sum_node
 = (
f2fs_summ¬y_block
 *)
	`·ge_add»ss
(
sum_·ge
);

358 
sum
 = 
sum_node
->
’Œ›s
[
blkoff
];

359 
	`f2fs_put_·ge
(
sum_·ge
, 1);

360 
gÙ_™
:

362 
nid
 = 
	`Ë32_to_ıu
(
sum
.nid);

363 ià(
dn
->
šode
->
i_šo
 =ğ
nid
) {

364 
tdn
.
nid
 =‚id;

365 ià(!
dn
->
šode_·ge_locked
)

366 
	`lock_·ge
(
dn
->
šode_·ge
);

367 
tdn
.
node_·ge
 = 
dn
->
šode_·ge
;

368 
tdn
.
ofs_š_node
 = 
	`Ë16_to_ıu
(
sum
.ofs_in_node);

369 
Œunÿ‹_out
;

370 } ià(
dn
->
nid
 ==‚id) {

371 
tdn
.
ofs_š_node
 = 
	`Ë16_to_ıu
(
sum
.ofs_in_node);

372 
Œunÿ‹_out
;

376 
node_·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
nid
);

377 ià(
	`IS_ERR
(
node_·ge
))

378  
	`PTR_ERR
(
node_·ge
);

380 
off£t
 = 
	`ofs_of_node
(
node_·ge
);

381 
šo
 = 
	`šo_of_node
(
node_·ge
);

382 
	`f2fs_put_·ge
(
node_·ge
, 1);

384 ià(
šo
 !ğ
dn
->
šode
->
i_šo
) {

385 
»t
;

388 
šode
 = 
	`f2fs_ig‘_»Œy
(
sbi
->
sb
, 
šo
);

389 ià(
	`IS_ERR
(
šode
))

390  
	`PTR_ERR
(
šode
);

392 
»t
 = 
	`dquÙ_š™Ÿlize
(
šode
);

393 ià(
»t
) {

394 
	`ut
(
šode
);

395  
»t
;

398 
šode
 = 
dn
->inode;

401 
bidx
 = 
	`f2fs_¡¬t_bidx_of_node
(
off£t
, 
šode
) +

402 
	`Ë16_to_ıu
(
sum
.
ofs_š_node
);

408 ià(
šo
 =ğ
dn
->
šode
->
i_šo
 && dn->
šode_·ge_locked
)

409 
	`uÆock_·ge
(
dn
->
šode_·ge
);

411 
	`£t_Ãw_dnode
(&
tdn
, 
šode
, 
NULL
, NULL, 0);

412 ià(
	`f2fs_g‘_dnode_of_d©a
(&
tdn
, 
bidx
, 
LOOKUP_NODE
))

413 
out
;

415 ià(
tdn
.
d©a_blkaddr
 =ğ
blkaddr
)

416 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
tdn
, 1);

418 
	`f2fs_put_dnode
(&
tdn
);

419 
out
:

420 ià(
šo
 !ğ
dn
->
šode
->
i_šo
)

421 
	`ut
(
šode
);

422 ià(
dn
->
šode_·ge_locked
)

423 
	`lock_·ge
(
dn
->
šode_·ge
);

426 
Œunÿ‹_out
:

427 ià(
	`d©ablock_addr
(
tdn
.
šode
,dn.
node_·ge
,

428 
tdn
.
ofs_š_node
è=ğ
blkaddr
)

429 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
tdn
, 1);

430 ià(
dn
->
šode
->
i_šo
 =ğ
nid
 && !dn->
šode_·ge_locked
)

431 
	`uÆock_·ge
(
dn
->
šode_·ge
);

433 
	}
}

435 
	$do_»cov”_d©a
(
f2fs_sb_šfo
 *
sbi
, 
šode
 *inode,

436 
·ge
 *page)

438 
dnode_of_d©a
 
dn
;

439 
node_šfo
 
ni
;

440 
¡¬t
, 
’d
;

441 
”r
 = 0, 
»cov”ed
 = 0;

444 ià(
	`IS_INODE
(
·ge
)) {

445 
	`f2fs_»cov”_šlše_x©Œ
(
šode
, 
·ge
);

446 } ià(
	`f2fs_has_x©Œ_block
(
	`ofs_of_node
(
·ge
))) {

447 
”r
 = 
	`f2fs_»cov”_x©Œ_d©a
(
šode
, 
·ge
);

448 ià(!
”r
)

449 
»cov”ed
++;

450 
out
;

454 ià(
	`f2fs_»cov”_šlše_d©a
(
šode
, 
·ge
))

455 
out
;

458 
¡¬t
 = 
	`f2fs_¡¬t_bidx_of_node
(
	`ofs_of_node
(
·ge
), 
šode
);

459 
’d
 = 
¡¬t
 + 
	`ADDRS_PER_PAGE
(
·ge
, 
šode
);

461 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

462 
»Œy_dn
:

463 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
¡¬t
, 
ALLOC_NODE
);

464 ià(
”r
) {

465 ià(
”r
 =ğ-
ENOMEM
) {

466 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

467 
»Œy_dn
;

469 
out
;

472 
	`f2fs_wa™_Ú_·ge_wr™eback
(
dn
.
node_·ge
, 
NODE
, 
Œue
);

474 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
.
nid
, &
ni
);

475 
	`f2fs_bug_Ú
(
sbi
, 
ni
.
šo
 !ğ
	`šo_of_node
(
·ge
));

476 
	`f2fs_bug_Ú
(
sbi
, 
	`ofs_of_node
(
dn
.
node_·ge
è!ğofs_of_node(
·ge
));

478 ; 
¡¬t
 < 
’d
; s¹++, 
dn
.
ofs_š_node
++) {

479 
block_t
 
¤c
, 
de¡
;

481 
¤c
 = 
	`d©ablock_addr
(
dn
.
šode
, dn.
node_·ge
, dn.
ofs_š_node
);

482 
de¡
 = 
	`d©ablock_addr
(
dn
.
šode
, 
·ge
, dn.
ofs_š_node
);

485 ià(
¤c
 =ğ
de¡
)

489 ià(
de¡
 =ğ
NULL_ADDR
) {

490 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 1);

494 ià(!
	`fe_k“p_isize
(
šode
) &&

495 (
	`i_size_»ad
(
šode
è<ğ((
loff_t
)
¡¬t
 << 
PAGE_SHIFT
)))

496 
	`f2fs_i_size_wr™e
(
šode
,

497 (
loff_t
)(
¡¬t
 + 1è<< 
PAGE_SHIFT
);

503 ià(
de¡
 =ğ
NEW_ADDR
) {

504 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 1);

505 
	`f2fs_»£rve_Ãw_block
(&
dn
);

510 ià(
	`f2fs_is_v®id_m‘a_blkaddr
(
sbi
, 
de¡
, 
META_POR
)) {

512 ià(
¤c
 =ğ
NULL_ADDR
) {

513 
”r
 = 
	`f2fs_»£rve_Ãw_block
(&
dn
);

514 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


515 
”r
)

516 
”r
 = 
	`f2fs_»£rve_Ãw_block
(&
dn
);

519 
	`f2fs_bug_Ú
(
sbi
, 
”r
);

520 ià(
”r
)

521 
”r
;

523 
»Œy_´ev
:

525 
”r
 = 
	`check_šdex_š_´ev_nodes
(
sbi
, 
de¡
, &
dn
);

526 ià(
”r
) {

527 ià(
”r
 =ğ-
ENOMEM
) {

528 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

529 
»Œy_´ev
;

531 
”r
;

535 
	`f2fs_»¶aû_block
(
sbi
, &
dn
, 
¤c
, 
de¡
,

536 
ni
.
v”siÚ
, 
çl£
, false);

537 
»cov”ed
++;

541 
	`cİy_node_foÙ”
(
dn
.
node_·ge
, 
·ge
);

542 
	`fl_node_foÙ”
(
dn
.
node_·ge
, dn.
nid
, 
ni
.
šo
,

543 
	`ofs_of_node
(
·ge
), 
çl£
);

544 
	`£t_·ge_dœty
(
dn
.
node_·ge
);

545 
”r
:

546 
	`f2fs_put_dnode
(&
dn
);

547 
out
:

548 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_NOTICE
,

550 
šode
->
i_šo
,

551 
	`fe_k“p_isize
(
šode
) ? "keep" : "recover",

552 
»cov”ed
, 
”r
);

553  
”r
;

554 
	}
}

556 
	$»cov”_d©a
(
f2fs_sb_šfo
 *
sbi
, 
li¡_h—d
 *
šode_li¡
,

557 
li¡_h—d
 *
dœ_li¡
)

559 
cur£g_šfo
 *
cur£g
;

560 
·ge
 *·gğ
NULL
;

561 
”r
 = 0;

562 
block_t
 
blkaddr
;

565 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
);

566 
blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
);

569 
fsync_šode_’Œy
 *
’Œy
;

571 ià(!
	`f2fs_is_v®id_m‘a_blkaddr
(
sbi
, 
blkaddr
, 
META_POR
))

574 
	`f2fs_¿_m‘a_·ges_cÚd
(
sbi
, 
blkaddr
);

576 
·ge
 = 
	`f2fs_g‘_tmp_·ge
(
sbi
, 
blkaddr
);

578 ià(!
	`is_»cov”abË_dnode
(
·ge
)) {

579 
	`f2fs_put_·ge
(
·ge
, 1);

583 
’Œy
 = 
	`g‘_fsync_šode
(
šode_li¡
, 
	`šo_of_node
(
·ge
));

584 ià(!
’Œy
)

585 
Ãxt
;

591 ià(
	`IS_INODE
(
·ge
))

592 
	`»cov”_šode
(
’Œy
->
šode
, 
·ge
);

593 ià(
’Œy
->
Ï¡_d’Œy
 =ğ
blkaddr
) {

594 
”r
 = 
	`»cov”_d’Œy
(
’Œy
->
šode
, 
·ge
, 
dœ_li¡
);

595 ià(
”r
) {

596 
	`f2fs_put_·ge
(
·ge
, 1);

600 
”r
 = 
	`do_»cov”_d©a
(
sbi
, 
’Œy
->
šode
, 
·ge
);

601 ià(
”r
) {

602 
	`f2fs_put_·ge
(
·ge
, 1);

606 ià(
’Œy
->
blkaddr
 == blkaddr)

607 
	`d–_fsync_šode
(
’Œy
);

608 
Ãxt
:

610 
blkaddr
 = 
	`Ãxt_blkaddr_of_node
(
·ge
);

611 
	`f2fs_put_·ge
(
·ge
, 1);

613 ià(!
”r
)

614 
	`f2fs_®loÿ‹_Ãw_£gm’ts
(
sbi
);

615  
”r
;

616 
	}
}

618 
	$f2fs_»cov”_fsync_d©a
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
check_Úly
)

620 
li¡_h—d
 
šode_li¡
;

621 
li¡_h—d
 
dœ_li¡
;

622 
”r
;

623 
»t
 = 0;

624 
s_æags
 = 
sbi
->
sb
->s_flags;

625 
boŞ
 
Ãed_wr™eı
 = 
çl£
;

626 #ifdeà
CONFIG_QUOTA


627 
quÙa_’abËd
;

630 ià(
s_æags
 & 
SB_RDONLY
) {

631 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
, "orphan cleanup on„eadonly fs");

632 
sbi
->
sb
->
s_æags
 &ğ~
SB_RDONLY
;

635 #ifdeà
CONFIG_QUOTA


637 
sbi
->
sb
->
s_æags
 |ğ
SB_ACTIVE
;

639 
quÙa_’abËd
 = 
	`f2fs_’abË_quÙa_fes
(
sbi
, 
s_æags
 & 
SB_RDONLY
);

642 
fsync_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_fsync_inode_entry",

643 (
fsync_šode_’Œy
));

644 ià(!
fsync_’Œy_¦ab
) {

645 
”r
 = -
ENOMEM
;

646 
out
;

649 
	`INIT_LIST_HEAD
(&
šode_li¡
);

650 
	`INIT_LIST_HEAD
(&
dœ_li¡
);

653 
	`mu‹x_lock
(&
sbi
->
ı_mu‹x
);

656 
”r
 = 
	`fšd_fsync_dnodes
(
sbi
, &
šode_li¡
, 
check_Úly
);

657 ià(
”r
 || 
	`li¡_em±y
(&
šode_li¡
))

658 
sk
;

660 ià(
check_Úly
) {

661 
»t
 = 1;

662 
sk
;

665 
Ãed_wr™eı
 = 
Œue
;

668 
”r
 = 
	`»cov”_d©a
(
sbi
, &
šode_li¡
, &
dœ_li¡
);

669 ià(!
”r
)

670 
	`f2fs_bug_Ú
(
sbi
, !
	`li¡_em±y
(&
šode_li¡
));

671 
sk
:

672 
	`de¡roy_fsync_dnodes
(&
šode_li¡
);

675 
	`Œunÿ‹_šode_·ges_¿nge
(
	`META_MAPPING
(
sbi
),

676 (
loff_t
)
	`MAIN_BLKADDR
(
sbi
è<< 
PAGE_SHIFT
, -1);

678 ià(
”r
) {

679 
	`Œunÿ‹_šode_·ges_fš®
(
	`NODE_MAPPING
(
sbi
));

680 
	`Œunÿ‹_šode_·ges_fš®
(
	`META_MAPPING
(
sbi
));

683 
	`ş—r_sbi_æag
(
sbi
, 
SBI_POR_DOING
);

684 
	`mu‹x_uÆock
(&
sbi
->
ı_mu‹x
);

687 
	`de¡roy_fsync_dnodes
(&
dœ_li¡
);

689 ià(!
”r
 && 
Ãed_wr™eı
) {

690 
ı_cÚŒŞ
 
ıc
 = {

691 .
»asÚ
 = 
CP_RECOVERY
,

693 
”r
 = 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

696 
	`kmem_ÿche_de¡roy
(
fsync_’Œy_¦ab
);

697 
out
:

698 #ifdeà
CONFIG_QUOTA


700 ià(
quÙa_’abËd
)

701 
	`f2fs_quÙa_off_umouÁ
(
sbi
->
sb
);

703 
sbi
->
sb
->
s_æags
 = s_flags;

705  
»t
 ?„‘: 
”r
;

706 
	}
}

	@fs/f2fs/segment.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/bio.h
>

14 
	~<lšux/blkdev.h
>

15 
	~<lšux/´eãtch.h
>

16 
	~<lšux/kth»ad.h
>

17 
	~<lšux/sw­.h
>

18 
	~<lšux/tim”.h
>

19 
	~<lšux/ä“z”.h
>

20 
	~<lšux/sched/sigÇl.h
>

22 
	~"f2fs.h
"

23 
	~"£gm’t.h
"

24 
	~"node.h
"

25 
	~"gc.h
"

26 
	~"Œaû.h
"

27 
	~<Œaû/ev’ts/f2fs.h
>

29 
	#__»v”£_ffz
(
x
è
	`__»v”£_ffs
(~(x))

	)

31 
kmem_ÿche
 *
	gdisÿrd_’Œy_¦ab
;

32 
kmem_ÿche
 *
	gdisÿrd_cmd_¦ab
;

33 
kmem_ÿche
 *
	gs™_’Œy_£t_¦ab
;

34 
kmem_ÿche
 *
	gšmem_’Œy_¦ab
;

36 
	$__»v”£_ulÚg
(*
¡r
)

38 
tmp
 = 0;

39 
shiá
 = 24, 
idx
 = 0;

41 #ià
BITS_PER_LONG
 == 64

42 
shiá
 = 56;

44 
shiá
 >= 0) {

45 
tmp
 |ğ()
¡r
[
idx
++] << 
shiá
;

46 
shiá
 -ğ
BITS_PER_BYTE
;

48  
tmp
;

49 
	}
}

55 
šlše
 
	$__»v”£_ffs
(
wÜd
)

57 
num
 = 0;

59 #ià
BITS_PER_LONG
 == 64

60 ià((
wÜd
 & 0xffffffff00000000UL) == 0)

61 
num
 += 32;

63 
wÜd
 >>= 32;

65 ià((
wÜd
 & 0xffff0000) == 0)

66 
num
 += 16;

68 
wÜd
 >>= 16;

70 ià((
wÜd
 & 0xff00) == 0)

71 
num
 += 8;

73 
wÜd
 >>= 8;

75 ià((
wÜd
 & 0xf0) == 0)

76 
num
 += 4;

78 
wÜd
 >>= 4;

80 ià((
wÜd
 & 0xc) == 0)

81 
num
 += 2;

83 
wÜd
 >>= 2;

85 ià((
wÜd
 & 0x2) == 0)

86 
num
 += 1;

87  
num
;

88 
	}
}

99 
	$__fšd_»v_Ãxt_b™
(cÚ¡ *
addr
,

100 
size
, 
off£t
)

102 cÚ¡ *
p
 = 
addr
 + 
	`BIT_WORD
(
off£t
);

103 
»suÉ
 = 
size
;

104 
tmp
;

106 ià(
off£t
 >ğ
size
)

107  
size
;

109 
size
 -ğ(
off£t
 & ~(
BITS_PER_LONG
 - 1));

110 
off£t
 %ğ
BITS_PER_LONG
;

113 ià(*
p
 == 0)

114 
·ss
;

116 
tmp
 = 
	`__»v”£_ulÚg
((*)
p
);

118 
tmp
 &ğ~0UL >> 
off£t
;

119 ià(
size
 < 
BITS_PER_LONG
)

120 
tmp
 &ğ(~0UL << (
BITS_PER_LONG
 - 
size
));

121 ià(
tmp
)

122 
found
;

123 
·ss
:

124 ià(
size
 <ğ
BITS_PER_LONG
)

126 
size
 -ğ
BITS_PER_LONG
;

127 
off£t
 = 0;

128 
p
++;

130  
»suÉ
;

131 
found
:

132  
»suÉ
 - 
size
 + 
	`__»v”£_ffs
(
tmp
);

133 
	}
}

135 
	$__fšd_»v_Ãxt_z”o_b™
(cÚ¡ *
addr
,

136 
size
, 
off£t
)

138 cÚ¡ *
p
 = 
addr
 + 
	`BIT_WORD
(
off£t
);

139 
»suÉ
 = 
size
;

140 
tmp
;

142 ià(
off£t
 >ğ
size
)

143  
size
;

145 
size
 -ğ(
off£t
 & ~(
BITS_PER_LONG
 - 1));

146 
off£t
 %ğ
BITS_PER_LONG
;

149 ià(*
p
 == ~0UL)

150 
·ss
;

152 
tmp
 = 
	`__»v”£_ulÚg
((*)
p
);

154 ià(
off£t
)

155 
tmp
 |ğ~0UL << (
BITS_PER_LONG
 - 
off£t
);

156 ià(
size
 < 
BITS_PER_LONG
)

157 
tmp
 |ğ~0UL >> 
size
;

158 ià(
tmp
 != ~0UL)

159 
found
;

160 
·ss
:

161 ià(
size
 <ğ
BITS_PER_LONG
)

163 
size
 -ğ
BITS_PER_LONG
;

164 
off£t
 = 0;

165 
p
++;

167  
»suÉ
;

168 
found
:

169  
»suÉ
 - 
size
 + 
	`__»v”£_ffz
(
tmp
);

170 
	}
}

172 
boŞ
 
	$f2fs_Ãed_SSR
(
f2fs_sb_šfo
 *
sbi
)

174 
node_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_NODES
);

175 
d’t_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_DENTS
);

176 
im‘a_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_IMETA
);

178 ià(
	`‹¡_İt
(
sbi
, 
LFS
))

179  
çl£
;

180 ià(
sbi
->
gc_mode
 =ğ
GC_URGENT
)

181  
Œue
;

183  
	`ä“_£ùiÚs
(
sbi
è<ğ(
node_£cs
 + 2 * 
d’t_£cs
 + 
im‘a_£cs
 +

184 
	`SM_I
(
sbi
)->
mš_s¤_£ùiÚs
 + 
	`»£rved_£ùiÚs
(sbi));

185 
	}
}

187 
	$f2fs_»gi¡”_šmem_·ge
(
šode
 *šode, 
·ge
 *page)

189 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

190 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

191 
šmem_·ges
 *
Ãw
;

193 
	`f2fs_Œaû_pid
(
·ge
);

195 
	`£t_·ge_´iv©e
(
·ge
, ()
ATOMIC_WRITTEN_PAGE
);

196 
	`S‘PagePriv©e
(
·ge
);

198 
Ãw
 = 
	`f2fs_kmem_ÿche_®loc
(
šmem_’Œy_¦ab
, 
GFP_NOFS
);

201 
Ãw
->
·ge
 =…age;

202 
	`INIT_LIST_HEAD
(&
Ãw
->
li¡
);

205 
	`mu‹x_lock
(&
fi
->
šmem_lock
);

206 
	`g‘_·ge
(
·ge
);

207 
	`li¡_add_
(&
Ãw
->
li¡
, &
fi
->
šmem_·ges
);

208 
	`¥š_lock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

209 ià(
	`li¡_em±y
(&
fi
->
šmem_i¡
))

210 
	`li¡_add_
(&
fi
->
šmem_i¡
, &
sbi
->
šode_li¡
[
ATOMIC_FILE
]);

211 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

212 
	`šc_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
F2FS_INMEM_PAGES
);

213 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

215 
	`Œaû_f2fs_»gi¡”_šmem_·ge
(
·ge
, 
INMEM
);

216 
	}
}

218 
	$__»voke_šmem_·ges
(
šode
 *inode,

219 
li¡_h—d
 *
h—d
, 
boŞ
 
drİ
, boŞ 
»cov”
)

221 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

222 
šmem_·ges
 *
cur
, *
tmp
;

223 
”r
 = 0;

225 
	`li¡_fÜ_—ch_’Œy_§ã
(
cur
, 
tmp
, 
h—d
, 
li¡
) {

226 
·ge
 *·gğ
cur
->page;

228 ià(
drİ
)

229 
	`Œaû_f2fs_comm™_šmem_·ge
(
·ge
, 
INMEM_DROP
);

231 
	`lock_·ge
(
·ge
);

233 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
);

235 ià(
»cov”
) {

236 
dnode_of_d©a
 
dn
;

237 
node_šfo
 
ni
;

239 
	`Œaû_f2fs_comm™_šmem_·ge
(
·ge
, 
INMEM_REVOKE
);

240 
»Œy
:

241 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

242 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
·ge
->
šdex
,

243 
LOOKUP_NODE
);

244 ià(
”r
) {

245 ià(
”r
 =ğ-
ENOMEM
) {

246 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

247 
	`cÚd_»sched
();

248 
»Œy
;

250 
”r
 = -
EAGAIN
;

251 
Ãxt
;

253 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
.
nid
, &
ni
);

254 ià(
cur
->
Şd_addr
 =ğ
NEW_ADDR
) {

255 
	`f2fs_šv®id©e_blocks
(
sbi
, 
dn
.
d©a_blkaddr
);

256 
	`f2fs_upd©e_d©a_blkaddr
(&
dn
, 
NEW_ADDR
);

258 
	`f2fs_»¶aû_block
(
sbi
, &
dn
, dn.
d©a_blkaddr
,

259 
cur
->
Şd_addr
, 
ni
.
v”siÚ
, 
Œue
,rue);

260 
	`f2fs_put_dnode
(&
dn
);

262 
Ãxt
:

264 ià(
drİ
 || 
»cov”
)

265 
	`CË¬PageU±od©e
(
·ge
);

266 
	`£t_·ge_´iv©e
(
·ge
, 0);

267 
	`CË¬PagePriv©e
(
·ge
);

268 
	`f2fs_put_·ge
(
·ge
, 1);

270 
	`li¡_d–
(&
cur
->
li¡
);

271 
	`kmem_ÿche_ä“
(
šmem_’Œy_¦ab
, 
cur
);

272 
	`dec_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
F2FS_INMEM_PAGES
);

274  
”r
;

275 
	}
}

277 
	$f2fs_drİ_šmem_·ges_®l
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
gc_çu»
)

279 
li¡_h—d
 *
h—d
 = &
sbi
->
šode_li¡
[
ATOMIC_FILE
];

280 
šode
 *inode;

281 
f2fs_šode_šfo
 *
fi
;

282 
Ãxt
:

283 
	`¥š_lock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

284 ià(
	`li¡_em±y
(
h—d
)) {

285 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

288 
fi
 = 
	`li¡_fœ¡_’Œy
(
h—d
, 
f2fs_šode_šfo
, 
šmem_i¡
);

289 
šode
 = 
	`ig¿b
(&
fi
->
vfs_šode
);

290 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

292 ià(
šode
) {

293 ià(
gc_çu»
) {

294 ià(
fi
->
i_gc_çu»s
[
GC_FAILURE_ATOMIC
])

295 
drİ
;

296 
sk
;

298 
drİ
:

299 
	`£t_šode_æag
(
šode
, 
FI_ATOMIC_REVOKE_REQUEST
);

300 
	`f2fs_drİ_šmem_·ges
(
šode
);

301 
	`ut
(
šode
);

303 
sk
:

304 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

305 
	`cÚd_»sched
();

306 
Ãxt
;

307 
	}
}

309 
	$f2fs_drİ_šmem_·ges
(
šode
 *inode)

311 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

312 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

314 
	`mu‹x_lock
(&
fi
->
šmem_lock
);

315 
	`__»voke_šmem_·ges
(
šode
, &
fi
->
šmem_·ges
, 
Œue
, 
çl£
);

316 
	`¥š_lock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

317 ià(!
	`li¡_em±y
(&
fi
->
šmem_i¡
))

318 
	`li¡_d–_š™
(&
fi
->
šmem_i¡
);

319 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

320 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

322 
	`ş—r_šode_æag
(
šode
, 
FI_ATOMIC_FILE
);

323 
fi
->
i_gc_çu»s
[
GC_FAILURE_ATOMIC
] = 0;

324 
	`¡©_dec_©omic_wr™e
(
šode
);

325 
	}
}

327 
	$f2fs_drİ_šmem_·ge
(
šode
 *šode, 
·ge
 *page)

329 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

330 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

331 
li¡_h—d
 *
h—d
 = &
fi
->
šmem_·ges
;

332 
šmem_·ges
 *
cur
 = 
NULL
;

334 
	`f2fs_bug_Ú
(
sbi
, !
	`IS_ATOMIC_WRITTEN_PAGE
(
·ge
));

336 
	`mu‹x_lock
(&
fi
->
šmem_lock
);

337 
	`li¡_fÜ_—ch_’Œy
(
cur
, 
h—d
, 
li¡
) {

338 ià(
cur
->
·ge
 ==…age)

342 
	`f2fs_bug_Ú
(
sbi
, 
	`li¡_em±y
(
h—d
è|| 
cur
->
·ge
 !=…age);

343 
	`li¡_d–
(&
cur
->
li¡
);

344 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

346 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_INMEM_PAGES
);

347 
	`kmem_ÿche_ä“
(
šmem_’Œy_¦ab
, 
cur
);

349 
	`CË¬PageU±od©e
(
·ge
);

350 
	`£t_·ge_´iv©e
(
·ge
, 0);

351 
	`CË¬PagePriv©e
(
·ge
);

352 
	`f2fs_put_·ge
(
·ge
, 0);

354 
	`Œaû_f2fs_comm™_šmem_·ge
(
·ge
, 
INMEM_INVALIDATE
);

355 
	}
}

357 
	$__f2fs_comm™_šmem_·ges
(
šode
 *inode)

359 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

360 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

361 
šmem_·ges
 *
cur
, *
tmp
;

362 
f2fs_io_šfo
 
fio
 = {

363 .
sbi
 = sbi,

364 .
šo
 = 
šode
->
i_šo
,

365 .
ty³
 = 
DATA
,

366 .
İ
 = 
REQ_OP_WRITE
,

367 .
İ_æags
 = 
REQ_SYNC
 | 
REQ_PRIO
,

368 .
io_ty³
 = 
FS_DATA_IO
,

370 
li¡_h—d
 
»voke_li¡
;

371 
pgoff_t
 
Ï¡_idx
 = 
ULONG_MAX
;

372 
”r
 = 0;

374 
	`INIT_LIST_HEAD
(&
»voke_li¡
);

376 
	`li¡_fÜ_—ch_’Œy_§ã
(
cur
, 
tmp
, &
fi
->
šmem_·ges
, 
li¡
) {

377 
·ge
 *·gğ
cur
->page;

379 
	`lock_·ge
(
·ge
);

380 ià(
·ge
->
m­pšg
 =ğ
šode
->
i_m­pšg
) {

381 
	`Œaû_f2fs_comm™_šmem_·ge
(
·ge
, 
INMEM
);

383 
	`£t_·ge_dœty
(
·ge
);

384 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
);

385 ià(
	`ş—r_·ge_dœty_fÜ_io
(
·ge
)) {

386 
	`šode_dec_dœty_·ges
(
šode
);

387 
	`f2fs_»move_dœty_šode
(
šode
);

389 
»Œy
:

390 
fio
.
·ge
 =…age;

391 
fio
.
Şd_blkaddr
 = 
NULL_ADDR
;

392 
fio
.
’üy±ed_·ge
 = 
NULL
;

393 
fio
.
Ãed_lock
 = 
LOCK_DONE
;

394 
”r
 = 
	`f2fs_do_wr™e_d©a_·ge
(&
fio
);

395 ià(
”r
) {

396 ià(
”r
 =ğ-
ENOMEM
) {

397 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

398 
	`cÚd_»sched
();

399 
»Œy
;

401 
	`uÆock_·ge
(
·ge
);

405 
cur
->
Şd_addr
 = 
fio
.
Şd_blkaddr
;

406 
Ï¡_idx
 = 
·ge
->
šdex
;

408 
	`uÆock_·ge
(
·ge
);

409 
	`li¡_move_
(&
cur
->
li¡
, &
»voke_li¡
);

412 ià(
Ï¡_idx
 !ğ
ULONG_MAX
)

413 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
sbi
, 
šode
, 0, 
Ï¡_idx
, 
DATA
);

415 ià(
”r
) {

424 
”r
 = 
	`__»voke_šmem_·ges
(
šode
, &
»voke_li¡
, 
çl£
, 
Œue
);

427 
	`__»voke_šmem_·ges
(
šode
, &
fi
->
šmem_·ges
, 
Œue
, 
çl£
);

429 
	`__»voke_šmem_·ges
(
šode
, &
»voke_li¡
, 
çl£
, false);

432  
”r
;

433 
	}
}

435 
	$f2fs_comm™_šmem_·ges
(
šode
 *inode)

437 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

438 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

439 
”r
;

441 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

442 
	`f2fs_lock_İ
(
sbi
);

444 
	`£t_šode_æag
(
šode
, 
FI_ATOMIC_COMMIT
);

446 
	`mu‹x_lock
(&
fi
->
šmem_lock
);

447 
”r
 = 
	`__f2fs_comm™_šmem_·ges
(
šode
);

449 
	`¥š_lock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

450 ià(!
	`li¡_em±y
(&
fi
->
šmem_i¡
))

451 
	`li¡_d–_š™
(&
fi
->
šmem_i¡
);

452 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

453 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

455 
	`ş—r_šode_æag
(
šode
, 
FI_ATOMIC_COMMIT
);

457 
	`f2fs_uÆock_İ
(
sbi
);

458  
”r
;

459 
	}
}

465 
	$f2fs_b®ªû_fs
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
Ãed
)

467 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


468 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_CHECKPOINT
)) {

469 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_CHECKPOINT
);

470 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

475 ià(
Ãed
 && 
	`exûss_ÿched_Çts
(
sbi
))

476 
	`f2fs_b®ªû_fs_bg
(
sbi
);

482 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0)) {

483 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

484 
	`f2fs_gc
(
sbi
, 
çl£
, f®£, 
NULL_SEGNO
);

486 
	}
}

488 
	$f2fs_b®ªû_fs_bg
(
f2fs_sb_šfo
 *
sbi
)

490 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

494 ià(!
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
EXTENT_CACHE
))

495 
	`f2fs_shršk_ex‹Á_Œ“
(
sbi
, 
EXTENT_CACHE_SHRINK_NUMBER
);

498 ià(!
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
NAT_ENTRIES
))

499 
	`f2fs_Œy_to_ä“_Çts
(
sbi
, 
NAT_ENTRY_PER_BLOCK
);

501 ià(!
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
FREE_NIDS
))

502 
	`f2fs_Œy_to_ä“_nids
(
sbi
, 
MAX_FREE_NIDS
);

504 
	`f2fs_bud_ä“_nids
(
sbi
, 
çl£
, false);

506 ià(!
	`is_idË
(
sbi
è&& !
	`exûss_dœty_Çts
(sbi))

510 ià(!
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
NAT_ENTRIES
) ||

511 !
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
INO_ENTRIES
) ||

512 
	`exûss_´eä“_£gs
(
sbi
) ||

513 
	`exûss_dœty_Çts
(
sbi
) ||

514 
	`f2fs_time_ov”
(
sbi
, 
CP_TIME
)) {

515 ià(
	`‹¡_İt
(
sbi
, 
DATA_FLUSH
)) {

516 
blk_¶ug
 
¶ug
;

518 
	`blk_¡¬t_¶ug
(&
¶ug
);

519 
	`f2fs_sync_dœty_šodes
(
sbi
, 
FILE_INODE
);

520 
	`blk_fšish_¶ug
(&
¶ug
);

522 
	`f2fs_sync_fs
(
sbi
->
sb
, 
Œue
);

523 
	`¡©_šc_bg_ı_couÁ
(
sbi
->
¡©_šfo
);

525 
	}
}

527 
	$__subm™_æush_wa™
(
f2fs_sb_šfo
 *
sbi
,

528 
block_deviû
 *
bdev
)

530 
bio
 *biØğ
	`f2fs_bio_®loc
(
sbi
, 0, 
Œue
);

531 
»t
;

533 
bio
->
bi_İf
 = 
REQ_OP_WRITE
 | 
REQ_SYNC
 | 
REQ_PREFLUSH
;

534 
	`bio_£t_dev
(
bio
, 
bdev
);

535 
»t
 = 
	`subm™_bio_wa™
(
bio
);

536 
	`bio_put
(
bio
);

538 
	`Œaû_f2fs_issue_æush
(
bdev
, 
	`‹¡_İt
(
sbi
, 
NOBARRIER
),

539 
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
), 
»t
);

540  
»t
;

541 
	}
}

543 
	$subm™_æush_wa™
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

545 
»t
 = 0;

546 
i
;

548 ià(!
sbi
->
s_ndevs
)

549  
	`__subm™_æush_wa™
(
sbi
, sbi->
sb
->
s_bdev
);

551 
i
 = 0; i < 
sbi
->
s_ndevs
; i++) {

552 ià(!
	`f2fs_is_dœty_deviû
(
sbi
, 
šo
, 
i
, 
FLUSH_INO
))

554 
»t
 = 
	`__subm™_æush_wa™
(
sbi
, 
	`FDEV
(
i
).
bdev
);

555 ià(
»t
)

558  
»t
;

559 
	}
}

561 
	$issue_æush_th»ad
(*
d©a
)

563 
f2fs_sb_šfo
 *
sbi
 = 
d©a
;

564 
æush_cmd_cÚŒŞ
 *
fcc
 = 
	`SM_I
(
sbi
)->
fcc_šfo
;

565 
wa™_queue_h—d_t
 *
q
 = &
fcc
->
æush_wa™_queue
;

566 
»³©
:

567 ià(
	`kth»ad_should_¡İ
())

570 
	`sb_¡¬t_štwr™e
(
sbi
->
sb
);

572 ià(!
	`Îi¡_em±y
(&
fcc
->
issue_li¡
)) {

573 
æush_cmd
 *
cmd
, *
Ãxt
;

574 
»t
;

576 
fcc
->
di¥©ch_li¡
 = 
	`Îi¡_d–_®l
(&fcc->
issue_li¡
);

577 
fcc
->
di¥©ch_li¡
 = 
	`Îi¡_»v”£_Üd”
(fcc->dispatch_list);

579 
cmd
 = 
	`Îi¡_’Œy
(
fcc
->
di¥©ch_li¡
, 
æush_cmd
, 
Înode
);

581 
»t
 = 
	`subm™_æush_wa™
(
sbi
, 
cmd
->
šo
);

582 
	`©omic_šc
(&
fcc
->
issued_æush
);

584 
	`Îi¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
Ãxt
,

585 
fcc
->
di¥©ch_li¡
, 
Înode
) {

586 
cmd
->
»t
 =„et;

587 
	`com¶‘e
(&
cmd
->
wa™
);

589 
fcc
->
di¥©ch_li¡
 = 
NULL
;

592 
	`sb_’d_štwr™e
(
sbi
->
sb
);

594 
	`wa™_ev’t_š‹¼u±ibË
(*
q
,

595 
	`kth»ad_should_¡İ
(è|| !
	`Îi¡_em±y
(&
fcc
->
issue_li¡
));

596 
»³©
;

597 
	}
}

599 
	$f2fs_issue_æush
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

601 
æush_cmd_cÚŒŞ
 *
fcc
 = 
	`SM_I
(
sbi
)->
fcc_šfo
;

602 
æush_cmd
 
cmd
;

603 
»t
;

605 ià(
	`‹¡_İt
(
sbi
, 
NOBARRIER
))

608 ià(!
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
)) {

609 
»t
 = 
	`subm™_æush_wa™
(
sbi
, 
šo
);

610 
	`©omic_šc
(&
fcc
->
issued_æush
);

611  
»t
;

614 ià(
	`©omic_šc_»tuº
(&
fcc
->
issšg_æush
è=ğ1 || 
sbi
->
s_ndevs
 > 1) {

615 
»t
 = 
	`subm™_æush_wa™
(
sbi
, 
šo
);

616 
	`©omic_dec
(&
fcc
->
issšg_æush
);

618 
	`©omic_šc
(&
fcc
->
issued_æush
);

619  
»t
;

622 
cmd
.
šo
 = ino;

623 
	`š™_com¶‘iÚ
(&
cmd
.
wa™
);

625 
	`Îi¡_add
(&
cmd
.
Înode
, &
fcc
->
issue_li¡
);

628 
	`smp_mb
();

630 ià(
	`wa™queue_aùive
(&
fcc
->
æush_wa™_queue
))

631 
	`wake_up
(&
fcc
->
æush_wa™_queue
);

633 ià(
fcc
->
f2fs_issue_æush
) {

634 
	`wa™_fÜ_com¶‘iÚ
(&
cmd
.
wa™
);

635 
	`©omic_dec
(&
fcc
->
issšg_æush
);

637 
Îi¡_node
 *
li¡
;

639 
li¡
 = 
	`Îi¡_d–_®l
(&
fcc
->
issue_li¡
);

640 ià(!
li¡
) {

641 
	`wa™_fÜ_com¶‘iÚ
(&
cmd
.
wa™
);

642 
	`©omic_dec
(&
fcc
->
issšg_æush
);

644 
æush_cmd
 *
tmp
, *
Ãxt
;

646 
»t
 = 
	`subm™_æush_wa™
(
sbi
, 
šo
);

648 
	`Îi¡_fÜ_—ch_’Œy_§ã
(
tmp
, 
Ãxt
, 
li¡
, 
Înode
) {

649 ià(
tmp
 =ğ&
cmd
) {

650 
cmd
.
»t
 =„et;

651 
	`©omic_dec
(&
fcc
->
issšg_æush
);

654 
tmp
->
»t
 =„et;

655 
	`com¶‘e
(&
tmp
->
wa™
);

660  
cmd
.
»t
;

661 
	}
}

663 
	$f2fs_ü—‹_æush_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
)

665 
dev_t
 
dev
 = 
sbi
->
sb
->
s_bdev
->
bd_dev
;

666 
æush_cmd_cÚŒŞ
 *
fcc
;

667 
”r
 = 0;

669 ià(
	`SM_I
(
sbi
)->
fcc_šfo
) {

670 
fcc
 = 
	`SM_I
(
sbi
)->
fcc_šfo
;

671 ià(
fcc
->
f2fs_issue_æush
)

672  
”r
;

673 
š™_th»ad
;

676 
fcc
 = 
	`f2fs_kz®loc
(
sbi
, (
æush_cmd_cÚŒŞ
), 
GFP_KERNEL
);

677 ià(!
fcc
)

678  -
ENOMEM
;

679 
	`©omic_£t
(&
fcc
->
issued_æush
, 0);

680 
	`©omic_£t
(&
fcc
->
issšg_æush
, 0);

681 
	`š™_wa™queue_h—d
(&
fcc
->
æush_wa™_queue
);

682 
	`š™_Îi¡_h—d
(&
fcc
->
issue_li¡
);

683 
	`SM_I
(
sbi
)->
fcc_šfo
 = 
fcc
;

684 ià(!
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
))

685  
”r
;

687 
š™_th»ad
:

688 
fcc
->
f2fs_issue_æush
 = 
	`kth»ad_run
(
issue_æush_th»ad
, 
sbi
,

689 "f2fs_æush-%u:%u", 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

690 ià(
	`IS_ERR
(
fcc
->
f2fs_issue_æush
)) {

691 
”r
 = 
	`PTR_ERR
(
fcc
->
f2fs_issue_æush
);

692 
	`kä“
(
fcc
);

693 
	`SM_I
(
sbi
)->
fcc_šfo
 = 
NULL
;

694  
”r
;

697  
”r
;

698 
	}
}

700 
	$f2fs_de¡roy_æush_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
ä“
)

702 
æush_cmd_cÚŒŞ
 *
fcc
 = 
	`SM_I
(
sbi
)->
fcc_šfo
;

704 ià(
fcc
 && fcc->
f2fs_issue_æush
) {

705 
sk_¡ruù
 *
æush_th»ad
 = 
fcc
->
f2fs_issue_æush
;

707 
fcc
->
f2fs_issue_æush
 = 
NULL
;

708 
	`kth»ad_¡İ
(
æush_th»ad
);

710 ià(
ä“
) {

711 
	`kä“
(
fcc
);

712 
	`SM_I
(
sbi
)->
fcc_šfo
 = 
NULL
;

714 
	}
}

716 
	$f2fs_æush_deviû_ÿche
(
f2fs_sb_šfo
 *
sbi
)

718 
»t
 = 0, 
i
;

720 ià(!
sbi
->
s_ndevs
)

723 
i
 = 1; i < 
sbi
->
s_ndevs
; i++) {

724 ià(!
	`f2fs_‹¡_b™
(
i
, (*)&
sbi
->
dœty_deviû
))

726 
»t
 = 
	`__subm™_æush_wa™
(
sbi
, 
	`FDEV
(
i
).
bdev
);

727 ià(
»t
)

730 
	`¥š_lock
(&
sbi
->
dev_lock
);

731 
	`f2fs_ş—r_b™
(
i
, (*)&
sbi
->
dœty_deviû
);

732 
	`¥š_uÆock
(&
sbi
->
dev_lock
);

735  
»t
;

736 
	}
}

738 
	$__loÿ‹_dœty_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
£gno
,

739 
dœty_ty³
 dirty_type)

741 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

744 ià(
	`IS_CURSEG
(
sbi
, 
£gno
))

747 ià(!
	`‹¡_ªd_£t_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
dœty_ty³
]))

748 
dœty_i
->
Ä_dœty
[
dœty_ty³
]++;

750 ià(
dœty_ty³
 =ğ
DIRTY
) {

751 
£g_’Œy
 *
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

752 
dœty_ty³
 
t
 = 
£Áry
->
ty³
;

754 ià(
	`uÆik–y
(
t
 >ğ
DIRTY
)) {

755 
	`f2fs_bug_Ú
(
sbi
, 1);

758 ià(!
	`‹¡_ªd_£t_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
t
]))

759 
dœty_i
->
Ä_dœty
[
t
]++;

761 
	}
}

763 
	$__»move_dœty_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
£gno
,

764 
dœty_ty³
 dirty_type)

766 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

768 ià(
	`‹¡_ªd_ş—r_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
dœty_ty³
]))

769 
dœty_i
->
Ä_dœty
[
dœty_ty³
]--;

771 ià(
dœty_ty³
 =ğ
DIRTY
) {

772 
£g_’Œy
 *
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

773 
dœty_ty³
 
t
 = 
£Áry
->
ty³
;

775 ià(
	`‹¡_ªd_ş—r_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
t
]))

776 
dœty_i
->
Ä_dœty
[
t
]--;

778 ià(
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
Œue
) == 0)

779 
	`ş—r_b™
(
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
),

780 
dœty_i
->
viùim_£cm­
);

782 
	}
}

789 
	$loÿ‹_dœty_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

791 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

792 
v®id_blocks
;

794 ià(
£gno
 =ğ
NULL_SEGNO
 || 
	`IS_CURSEG
(
sbi
, segno))

797 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

799 
v®id_blocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
çl£
);

801 ià(
v®id_blocks
 == 0) {

802 
	`__loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
, 
PRE
);

803 
	`__»move_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

804 } ià(
v®id_blocks
 < 
sbi
->
blocks_³r_£g
) {

805 
	`__loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

808 
	`__»move_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

811 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

812 
	}
}

814 
disÿrd_cmd
 *
	$__ü—‹_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

815 
block_deviû
 *
bdev
, 
block_t
 
l¡¬t
,

816 
block_t
 
¡¬t
, block_ˆ
Ën
)

818 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

819 
li¡_h—d
 *
³nd_li¡
;

820 
disÿrd_cmd
 *
dc
;

822 
	`f2fs_bug_Ú
(
sbi
, !
Ën
);

824 
³nd_li¡
 = &
dcc
->³nd_li¡[
	`¶i¡_idx
(
Ën
)];

826 
dc
 = 
	`f2fs_kmem_ÿche_®loc
(
disÿrd_cmd_¦ab
, 
GFP_NOFS
);

827 
	`INIT_LIST_HEAD
(&
dc
->
li¡
);

828 
dc
->
bdev
 = bdev;

829 
dc
->
l¡¬t
 =†start;

830 
dc
->
¡¬t
 = start;

831 
dc
->
Ën
 =†en;

832 
dc
->
»f
 = 0;

833 
dc
->
¡©e
 = 
D_PREP
;

834 
dc
->
”rÜ
 = 0;

835 
	`š™_com¶‘iÚ
(&
dc
->
wa™
);

836 
	`li¡_add_
(&
dc
->
li¡
, 
³nd_li¡
);

837 
	`©omic_šc
(&
dcc
->
disÿrd_cmd_út
);

838 
dcc
->
undisÿrd_blks
 +ğ
Ën
;

840  
dc
;

841 
	}
}

843 
disÿrd_cmd
 *
	$__©ch_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

844 
block_deviû
 *
bdev
, 
block_t
 
l¡¬t
,

845 
block_t
 
¡¬t
, block_ˆ
Ën
,

846 
rb_node
 *
·»Á
, rb_nod**
p
)

848 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

849 
disÿrd_cmd
 *
dc
;

851 
dc
 = 
	`__ü—‹_disÿrd_cmd
(
sbi
, 
bdev
, 
l¡¬t
, 
¡¬t
, 
Ën
);

853 
	`rb_lšk_node
(&
dc
->
rb_node
, 
·»Á
, 
p
);

854 
	`rb_š£¹_cŞÜ
(&
dc
->
rb_node
, &
dcc
->
roÙ
);

856  
dc
;

857 
	}
}

859 
	$__d‘ach_disÿrd_cmd
(
disÿrd_cmd_cÚŒŞ
 *
dcc
,

860 
disÿrd_cmd
 *
dc
)

862 ià(
dc
->
¡©e
 =ğ
D_DONE
)

863 
	`©omic_dec
(&
dcc
->
issšg_disÿrd
);

865 
	`li¡_d–
(&
dc
->
li¡
);

866 
	`rb_”a£
(&
dc
->
rb_node
, &
dcc
->
roÙ
);

867 
dcc
->
undisÿrd_blks
 -ğ
dc
->
Ën
;

869 
	`kmem_ÿche_ä“
(
disÿrd_cmd_¦ab
, 
dc
);

871 
	`©omic_dec
(&
dcc
->
disÿrd_cmd_út
);

872 
	}
}

874 
	$__»move_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

875 
disÿrd_cmd
 *
dc
)

877 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

879 
	`Œaû_f2fs_»move_disÿrd
(
dc
->
bdev
, dc->
¡¬t
, dc->
Ën
);

881 
	`f2fs_bug_Ú
(
sbi
, 
dc
->
»f
);

883 ià(
dc
->
”rÜ
 =ğ-
EOPNOTSUPP
)

884 
dc
->
”rÜ
 = 0;

886 ià(
dc
->
”rÜ
)

887 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
,

889 
dc
->
l¡¬t
, dc->
¡¬t
, dc->
Ën
, dc->
”rÜ
);

890 
	`__d‘ach_disÿrd_cmd
(
dcc
, 
dc
);

891 
	}
}

893 
	$f2fs_subm™_disÿrd_’dio
(
bio
 *bio)

895 
disÿrd_cmd
 *
dc
 = (disÿrd_cmd *)
bio
->
bi_´iv©e
;

897 
dc
->
”rÜ
 = 
	`blk_¡©us_to_”ºo
(
bio
->
bi_¡©us
);

898 
dc
->
¡©e
 = 
D_DONE
;

899 
	`com¶‘e_®l
(&
dc
->
wa™
);

900 
	`bio_put
(
bio
);

901 
	}
}

903 
	$__check_s™_b™m­
(
f2fs_sb_šfo
 *
sbi
,

904 
block_t
 
¡¬t
, block_ˆ
’d
)

906 #ifdeà
CONFIG_F2FS_CHECK_FS


907 
£g_’Œy
 *
£Áry
;

908 
£gno
;

909 
block_t
 
blk
 = 
¡¬t
;

910 
off£t
, 
size
, 
max_blocks
 = 
sbi
->
blocks_³r_£g
;

911 *
m­
;

913 
blk
 < 
’d
) {

914 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
blk
);

915 
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

916 
off£t
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
blk
);

918 ià(
’d
 < 
	`START_BLOCK
(
sbi
, 
£gno
 + 1))

919 
size
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
’d
);

921 
size
 = 
max_blocks
;

922 
m­
 = (*)(
£Áry
->
cur_v®id_m­
);

923 
off£t
 = 
	`__fšd_»v_Ãxt_b™
(
m­
, 
size
, offset);

924 
	`f2fs_bug_Ú
(
sbi
, 
off£t
 !ğ
size
);

925 
blk
 = 
	`START_BLOCK
(
sbi
, 
£gno
 + 1);

928 
	}
}

930 
	$__š™_disÿrd_pŞicy
(
f2fs_sb_šfo
 *
sbi
,

931 
disÿrd_pŞicy
 *
dpŞicy
,

932 
disÿrd_ty³
, 
g¿nuÏr™y
)

935 
dpŞicy
->
ty³
 = 
disÿrd_ty³
;

936 
dpŞicy
->
sync
 = 
Œue
;

937 
dpŞicy
->
g¿nuÏr™y
 = granularity;

939 
dpŞicy
->
max_»que¡s
 = 
DEF_MAX_DISCARD_REQUEST
;

940 
dpŞicy
->
io_aw¬e_g¿n
 = 
MAX_PLIST_NUM
;

942 ià(
disÿrd_ty³
 =ğ
DPOLICY_BG
) {

943 
dpŞicy
->
mš_š‹rv®
 = 
DEF_MIN_DISCARD_ISSUE_TIME
;

944 
dpŞicy
->
mid_š‹rv®
 = 
DEF_MID_DISCARD_ISSUE_TIME
;

945 
dpŞicy
->
max_š‹rv®
 = 
DEF_MAX_DISCARD_ISSUE_TIME
;

946 
dpŞicy
->
io_aw¬e
 = 
Œue
;

947 
dpŞicy
->
sync
 = 
çl£
;

948 ià(
	`utiz©iÚ
(
sbi
è> 
DEF_DISCARD_URGENT_UTIL
) {

949 
dpŞicy
->
g¿nuÏr™y
 = 1;

950 
dpŞicy
->
max_š‹rv®
 = 
DEF_MIN_DISCARD_ISSUE_TIME
;

952 } ià(
disÿrd_ty³
 =ğ
DPOLICY_FORCE
) {

953 
dpŞicy
->
mš_š‹rv®
 = 
DEF_MIN_DISCARD_ISSUE_TIME
;

954 
dpŞicy
->
mid_š‹rv®
 = 
DEF_MID_DISCARD_ISSUE_TIME
;

955 
dpŞicy
->
max_š‹rv®
 = 
DEF_MAX_DISCARD_ISSUE_TIME
;

956 
dpŞicy
->
io_aw¬e
 = 
çl£
;

957 } ià(
disÿrd_ty³
 =ğ
DPOLICY_FSTRIM
) {

958 
dpŞicy
->
io_aw¬e
 = 
çl£
;

959 } ià(
disÿrd_ty³
 =ğ
DPOLICY_UMOUNT
) {

960 
dpŞicy
->
max_»que¡s
 = 
UINT_MAX
;

961 
dpŞicy
->
io_aw¬e
 = 
çl£
;

963 
	}
}

967 
	$__subm™_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

968 
disÿrd_pŞicy
 *
dpŞicy
,

969 
disÿrd_cmd
 *
dc
)

971 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

972 
li¡_h—d
 *
wa™_li¡
 = (
dpŞicy
->
ty³
 =ğ
DPOLICY_FSTRIM
) ?

973 &(
dcc
->
f¡rim_li¡
è: &(dcc->
wa™_li¡
);

974 
bio
 *biØğ
NULL
;

975 
æag
 = 
dpŞicy
->
sync
 ? 
REQ_SYNC
 : 0;

977 ià(
dc
->
¡©e
 !ğ
D_PREP
)

980 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_FSCK
))

983 
	`Œaû_f2fs_issue_disÿrd
(
dc
->
bdev
, dc->
¡¬t
, dc->
Ën
);

985 
dc
->
”rÜ
 = 
	`__blkdev_issue_disÿrd
(dc->
bdev
,

986 
	`SECTOR_FROM_BLOCK
(
dc
->
¡¬t
),

987 
	`SECTOR_FROM_BLOCK
(
dc
->
Ën
),

988 
GFP_NOFS
, 0, &
bio
);

989 ià(!
dc
->
”rÜ
) {

991 
dc
->
¡©e
 = 
D_SUBMIT
;

992 
	`©omic_šc
(&
dcc
->
issued_disÿrd
);

993 
	`©omic_šc
(&
dcc
->
issšg_disÿrd
);

994 ià(
bio
) {

995 
bio
->
bi_´iv©e
 = 
dc
;

996 
bio
->
bi_’d_io
 = 
f2fs_subm™_disÿrd_’dio
;

997 
bio
->
bi_İf
 |ğ
æag
;

998 
	`subm™_bio
(
bio
);

999 
	`li¡_move_
(&
dc
->
li¡
, 
wa™_li¡
);

1000 
	`__check_s™_b™m­
(
sbi
, 
dc
->
¡¬t
, dc->¡¬ˆ+ dc->
Ën
);

1002 
	`f2fs_upd©e_io¡©
(
sbi
, 
FS_DISCARD
, 1);

1005 
	`__»move_disÿrd_cmd
(
sbi
, 
dc
);

1007 
	}
}

1009 
disÿrd_cmd
 *
	$__š£¹_disÿrd_Œ“
(
f2fs_sb_šfo
 *
sbi
,

1010 
block_deviû
 *
bdev
, 
block_t
 
l¡¬t
,

1011 
block_t
 
¡¬t
, block_ˆ
Ën
,

1012 
rb_node
 **
š£¹_p
,

1013 
rb_node
 *
š£¹_·»Á
)

1015 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1016 
rb_node
 **
p
;

1017 
rb_node
 *
·»Á
 = 
NULL
;

1018 
disÿrd_cmd
 *
dc
 = 
NULL
;

1020 ià(
š£¹_p
 && 
š£¹_·»Á
) {

1021 
·»Á
 = 
š£¹_·»Á
;

1022 
p
 = 
š£¹_p
;

1023 
do_š£¹
;

1026 
p
 = 
	`f2fs_lookup_rb_Œ“_fÜ_š£¹
(
sbi
, &
dcc
->
roÙ
, &
·»Á
, 
l¡¬t
);

1027 
do_š£¹
:

1028 
dc
 = 
	`__©ch_disÿrd_cmd
(
sbi
, 
bdev
, 
l¡¬t
, 
¡¬t
, 
Ën
, 
·»Á
, 
p
);

1029 ià(!
dc
)

1030  
NULL
;

1032  
dc
;

1033 
	}
}

1035 
	$__»loÿ‹_disÿrd_cmd
(
disÿrd_cmd_cÚŒŞ
 *
dcc
,

1036 
disÿrd_cmd
 *
dc
)

1038 
	`li¡_move_
(&
dc
->
li¡
, &
dcc
->
³nd_li¡
[
	`¶i¡_idx
(dc->
Ën
)]);

1039 
	}
}

1041 
	$__punch_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

1042 
disÿrd_cmd
 *
dc
, 
block_t
 
blkaddr
)

1044 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1045 
disÿrd_šfo
 
di
 = 
dc
->di;

1046 
boŞ
 
modif›d
 = 
çl£
;

1048 ià(
dc
->
¡©e
 =ğ
D_DONE
 || dc->
Ën
 == 1) {

1049 
	`__»move_disÿrd_cmd
(
sbi
, 
dc
);

1053 
dcc
->
undisÿrd_blks
 -ğ
di
.
Ën
;

1055 ià(
blkaddr
 > 
di
.
l¡¬t
) {

1056 
dc
->
Ën
 = 
blkaddr
 - dc->
l¡¬t
;

1057 
dcc
->
undisÿrd_blks
 +ğ
dc
->
Ën
;

1058 
	`__»loÿ‹_disÿrd_cmd
(
dcc
, 
dc
);

1059 
modif›d
 = 
Œue
;

1062 ià(
blkaddr
 < 
di
.
l¡¬t
 + di.
Ën
 - 1) {

1063 ià(
modif›d
) {

1064 
	`__š£¹_disÿrd_Œ“
(
sbi
, 
dc
->
bdev
, 
blkaddr
 + 1,

1065 
di
.
¡¬t
 + 
blkaddr
 + 1 - di.
l¡¬t
,

1066 
di
.
l¡¬t
 + di.
Ën
 - 1 - 
blkaddr
,

1067 
NULL
, NULL);

1069 
dc
->
l¡¬t
++;

1070 
dc
->
Ën
--;

1071 
dc
->
¡¬t
++;

1072 
dcc
->
undisÿrd_blks
 +ğ
dc
->
Ën
;

1073 
	`__»loÿ‹_disÿrd_cmd
(
dcc
, 
dc
);

1076 
	}
}

1078 
	$__upd©e_disÿrd_Œ“_¿nge
(
f2fs_sb_šfo
 *
sbi
,

1079 
block_deviû
 *
bdev
, 
block_t
 
l¡¬t
,

1080 
block_t
 
¡¬t
, block_ˆ
Ën
)

1082 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1083 
disÿrd_cmd
 *
´ev_dc
 = 
NULL
, *
Ãxt_dc
 = NULL;

1084 
disÿrd_cmd
 *
dc
;

1085 
disÿrd_šfo
 
di
 = {0};

1086 
rb_node
 **
š£¹_p
 = 
NULL
, *
š£¹_·»Á
 = NULL;

1087 
block_t
 
’d
 = 
l¡¬t
 + 
Ën
;

1089 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

1091 
dc
 = (
disÿrd_cmd
 *)
	`f2fs_lookup_rb_Œ“_»t
(&
dcc
->
roÙ
,

1092 
NULL
, 
l¡¬t
,

1093 (
rb_’Œy
 **)&
´ev_dc
,

1094 (
rb_’Œy
 **)&
Ãxt_dc
,

1095 &
š£¹_p
, &
š£¹_·»Á
, 
Œue
);

1096 ià(
dc
)

1097 
´ev_dc
 = 
dc
;

1099 ià(!
´ev_dc
) {

1100 
di
.
l¡¬t
 =†start;

1101 
di
.
Ën
 = 
Ãxt_dc
 ?‚ext_dc->
l¡¬t
 -†start :†en;

1102 
di
.
Ën
 = 
	`mš
(di.len,†en);

1103 
di
.
¡¬t
 = start;

1107 
rb_node
 *
node
;

1108 
boŞ
 
m”ged
 = 
çl£
;

1109 
disÿrd_cmd
 *
tdc
 = 
NULL
;

1111 ià(
´ev_dc
) {

1112 
di
.
l¡¬t
 = 
´ev_dc
->l¡¬ˆ+…»v_dc->
Ën
;

1113 ià(
di
.
l¡¬t
 <†start)

1114 
di
.
l¡¬t
 =†start;

1115 ià(
di
.
l¡¬t
 >ğ
’d
)

1118 ià(!
Ãxt_dc
 ||‚ext_dc->
l¡¬t
 > 
’d
)

1119 
di
.
Ën
 = 
’d
 - di.
l¡¬t
;

1121 
di
.
Ën
 = 
Ãxt_dc
->
l¡¬t
 - di.lstart;

1122 
di
.
¡¬t
 = s¹ + di.
l¡¬t
 -†start;

1125 ià(!
di
.
Ën
)

1126 
Ãxt
;

1128 ià(
´ev_dc
 &&…»v_dc->
¡©e
 =ğ
D_PREP
 &&

1129 
´ev_dc
->
bdev
 == bdev &&

1130 
	`__is_disÿrd_back_m”g—bË
(&
di
, &
´ev_dc
->di)) {

1131 
´ev_dc
->
di
.
Ën
 += di.len;

1132 
dcc
->
undisÿrd_blks
 +ğ
di
.
Ën
;

1133 
	`__»loÿ‹_disÿrd_cmd
(
dcc
, 
´ev_dc
);

1134 
di
 = 
´ev_dc
->di;

1135 
tdc
 = 
´ev_dc
;

1136 
m”ged
 = 
Œue
;

1139 ià(
Ãxt_dc
 &&‚ext_dc->
¡©e
 =ğ
D_PREP
 &&

1140 
Ãxt_dc
->
bdev
 == bdev &&

1141 
	`__is_disÿrd_äÚt_m”g—bË
(&
di
, &
Ãxt_dc
->di)) {

1142 
Ãxt_dc
->
di
.
l¡¬t
 = di.lstart;

1143 
Ãxt_dc
->
di
.
Ën
 += di.len;

1144 
Ãxt_dc
->
di
.
¡¬t
 = di.start;

1145 
dcc
->
undisÿrd_blks
 +ğ
di
.
Ën
;

1146 
	`__»loÿ‹_disÿrd_cmd
(
dcc
, 
Ãxt_dc
);

1147 ià(
tdc
)

1148 
	`__»move_disÿrd_cmd
(
sbi
, 
tdc
);

1149 
m”ged
 = 
Œue
;

1152 ià(!
m”ged
) {

1153 
	`__š£¹_disÿrd_Œ“
(
sbi
, 
bdev
, 
di
.
l¡¬t
, di.
¡¬t
,

1154 
di
.
Ën
, 
NULL
, NULL);

1156 
Ãxt
:

1157 
´ev_dc
 = 
Ãxt_dc
;

1158 ià(!
´ev_dc
)

1161 
node
 = 
	`rb_Ãxt
(&
´ev_dc
->
rb_node
);

1162 
Ãxt_dc
 = 
	`rb_’Œy_§ã
(
node
, 
disÿrd_cmd
, 
rb_node
);

1165 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

1166 
	}
}

1168 
	$__queue_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

1169 
block_deviû
 *
bdev
, 
block_t
 
blk¡¬t
, block_ˆ
blkËn
)

1171 
block_t
 
lblk¡¬t
 = 
blk¡¬t
;

1173 
	`Œaû_f2fs_queue_disÿrd
(
bdev
, 
blk¡¬t
, 
blkËn
);

1175 ià(
sbi
->
s_ndevs
) {

1176 
devi
 = 
	`f2fs_rg‘_deviû_šdex
(
sbi
, 
blk¡¬t
);

1178 
blk¡¬t
 -ğ
	`FDEV
(
devi
).
¡¬t_blk
;

1180 
	`__upd©e_disÿrd_Œ“_¿nge
(
sbi
, 
bdev
, 
lblk¡¬t
, 
blk¡¬t
, 
blkËn
);

1182 
	}
}

1184 
	$__issue_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

1185 
disÿrd_pŞicy
 *
dpŞicy
)

1187 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1188 
li¡_h—d
 *
³nd_li¡
;

1189 
disÿrd_cmd
 *
dc
, *
tmp
;

1190 
blk_¶ug
 
¶ug
;

1191 
i
, 
™”
 = 0, 
issued
 = 0;

1192 
boŞ
 
io_š‹¼u±ed
 = 
çl£
;

1194 
i
 = 
MAX_PLIST_NUM
 - 1; i >= 0; i--) {

1195 ià(
i
 + 1 < 
dpŞicy
->
g¿nuÏr™y
)

1197 
³nd_li¡
 = &
dcc
->³nd_li¡[
i
];

1199 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

1200 ià(
	`li¡_em±y
(
³nd_li¡
))

1201 
Ãxt
;

1202 
	`f2fs_bug_Ú
(
sbi
,

1203 !
	`f2fs_check_rb_Œ“_cÚsi¡’û
(
sbi
, &
dcc
->
roÙ
));

1204 
	`blk_¡¬t_¶ug
(&
¶ug
);

1205 
	`li¡_fÜ_—ch_’Œy_§ã
(
dc
, 
tmp
, 
³nd_li¡
, 
li¡
) {

1206 
	`f2fs_bug_Ú
(
sbi
, 
dc
->
¡©e
 !ğ
D_PREP
);

1208 ià(
dpŞicy
->
io_aw¬e
 && 
i
 < dpŞicy->
io_aw¬e_g¿n
 &&

1209 !
	`is_idË
(
sbi
)) {

1210 
io_š‹¼u±ed
 = 
Œue
;

1211 
sk
;

1214 
	`__subm™_disÿrd_cmd
(
sbi
, 
dpŞicy
, 
dc
);

1215 
issued
++;

1216 
sk
:

1217 ià(++
™”
 >ğ
dpŞicy
->
max_»que¡s
)

1220 
	`blk_fšish_¶ug
(&
¶ug
);

1221 
Ãxt
:

1222 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

1224 ià(
™”
 >ğ
dpŞicy
->
max_»que¡s
)

1228 ià(!
issued
 && 
io_š‹¼u±ed
)

1229 
issued
 = -1;

1231  
issued
;

1232 
	}
}

1234 
boŞ
 
	$__drİ_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
)

1236 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1237 
li¡_h—d
 *
³nd_li¡
;

1238 
disÿrd_cmd
 *
dc
, *
tmp
;

1239 
i
;

1240 
boŞ
 
drİ³d
 = 
çl£
;

1242 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

1243 
i
 = 
MAX_PLIST_NUM
 - 1; i >= 0; i--) {

1244 
³nd_li¡
 = &
dcc
->³nd_li¡[
i
];

1245 
	`li¡_fÜ_—ch_’Œy_§ã
(
dc
, 
tmp
, 
³nd_li¡
, 
li¡
) {

1246 
	`f2fs_bug_Ú
(
sbi
, 
dc
->
¡©e
 !ğ
D_PREP
);

1247 
	`__»move_disÿrd_cmd
(
sbi
, 
dc
);

1248 
drİ³d
 = 
Œue
;

1251 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

1253  
drİ³d
;

1254 
	}
}

1256 
	$f2fs_drİ_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
)

1258 
	`__drİ_disÿrd_cmd
(
sbi
);

1259 
	}
}

1261 
	$__wa™_Úe_disÿrd_bio
(
f2fs_sb_šfo
 *
sbi
,

1262 
disÿrd_cmd
 *
dc
)

1264 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1265 
Ën
 = 0;

1267 
	`wa™_fÜ_com¶‘iÚ_io
(&
dc
->
wa™
);

1268 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

1269 
	`f2fs_bug_Ú
(
sbi
, 
dc
->
¡©e
 !ğ
D_DONE
);

1270 
dc
->
»f
--;

1271 ià(!
dc
->
»f
) {

1272 ià(!
dc
->
”rÜ
)

1273 
Ën
 = 
dc
->len;

1274 
	`__»move_disÿrd_cmd
(
sbi
, 
dc
);

1276 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

1278  
Ën
;

1279 
	}
}

1281 
	$__wa™_disÿrd_cmd_¿nge
(
f2fs_sb_šfo
 *
sbi
,

1282 
disÿrd_pŞicy
 *
dpŞicy
,

1283 
block_t
 
¡¬t
, block_ˆ
’d
)

1285 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1286 
li¡_h—d
 *
wa™_li¡
 = (
dpŞicy
->
ty³
 =ğ
DPOLICY_FSTRIM
) ?

1287 &(
dcc
->
f¡rim_li¡
è: &(dcc->
wa™_li¡
);

1288 
disÿrd_cmd
 *
dc
, *
tmp
;

1289 
boŞ
 
Ãed_wa™
;

1290 
Œimmed
 = 0;

1292 
Ãxt
:

1293 
Ãed_wa™
 = 
çl£
;

1295 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

1296 
	`li¡_fÜ_—ch_’Œy_§ã
(
dc
, 
tmp
, 
wa™_li¡
, 
li¡
) {

1297 ià(
dc
->
l¡¬t
 + dc->
Ën
 <ğ
¡¬t
 || 
’d
 <= dc->lstart)

1299 ià(
dc
->
Ën
 < 
dpŞicy
->
g¿nuÏr™y
)

1301 ià(
dc
->
¡©e
 =ğ
D_DONE
 && !dc->
»f
) {

1302 
	`wa™_fÜ_com¶‘iÚ_io
(&
dc
->
wa™
);

1303 ià(!
dc
->
”rÜ
)

1304 
Œimmed
 +ğ
dc
->
Ën
;

1305 
	`__»move_disÿrd_cmd
(
sbi
, 
dc
);

1307 
dc
->
»f
++;

1308 
Ãed_wa™
 = 
Œue
;

1312 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

1314 ià(
Ãed_wa™
) {

1315 
Œimmed
 +ğ
	`__wa™_Úe_disÿrd_bio
(
sbi
, 
dc
);

1316 
Ãxt
;

1319  
Œimmed
;

1320 
	}
}

1322 
	$__wa™_®l_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

1323 
disÿrd_pŞicy
 *
dpŞicy
)

1325 
disÿrd_pŞicy
 
dp
;

1327 ià(
dpŞicy
) {

1328 
	`__wa™_disÿrd_cmd_¿nge
(
sbi
, 
dpŞicy
, 0, 
UINT_MAX
);

1333 
	`__š™_disÿrd_pŞicy
(
sbi
, &
dp
, 
DPOLICY_FSTRIM
, 1);

1334 
	`__wa™_disÿrd_cmd_¿nge
(
sbi
, &
dp
, 0, 
UINT_MAX
);

1335 
	`__š™_disÿrd_pŞicy
(
sbi
, &
dp
, 
DPOLICY_UMOUNT
, 1);

1336 
	`__wa™_disÿrd_cmd_¿nge
(
sbi
, &
dp
, 0, 
UINT_MAX
);

1337 
	}
}

1340 
	$f2fs_wa™_disÿrd_bio
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
)

1342 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1343 
disÿrd_cmd
 *
dc
;

1344 
boŞ
 
Ãed_wa™
 = 
çl£
;

1346 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

1347 
dc
 = (
disÿrd_cmd
 *)
	`f2fs_lookup_rb_Œ“
(&
dcc
->
roÙ
,

1348 
NULL
, 
blkaddr
);

1349 ià(
dc
) {

1350 ià(
dc
->
¡©e
 =ğ
D_PREP
) {

1351 
	`__punch_disÿrd_cmd
(
sbi
, 
dc
, 
blkaddr
);

1353 
dc
->
»f
++;

1354 
Ãed_wa™
 = 
Œue
;

1357 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

1359 ià(
Ãed_wa™
)

1360 
	`__wa™_Úe_disÿrd_bio
(
sbi
, 
dc
);

1361 
	}
}

1363 
	$f2fs_¡İ_disÿrd_th»ad
(
f2fs_sb_šfo
 *
sbi
)

1365 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1367 ià(
dcc
 && dcc->
f2fs_issue_disÿrd
) {

1368 
sk_¡ruù
 *
disÿrd_th»ad
 = 
dcc
->
f2fs_issue_disÿrd
;

1370 
dcc
->
f2fs_issue_disÿrd
 = 
NULL
;

1371 
	`kth»ad_¡İ
(
disÿrd_th»ad
);

1373 
	}
}

1376 
boŞ
 
	$f2fs_wa™_disÿrd_bios
(
f2fs_sb_šfo
 *
sbi
)

1378 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1379 
disÿrd_pŞicy
 
dpŞicy
;

1380 
boŞ
 
drİ³d
;

1382 
	`__š™_disÿrd_pŞicy
(
sbi
, &
dpŞicy
, 
DPOLICY_UMOUNT
,

1383 
dcc
->
disÿrd_g¿nuÏr™y
);

1384 
	`__issue_disÿrd_cmd
(
sbi
, &
dpŞicy
);

1385 
drİ³d
 = 
	`__drİ_disÿrd_cmd
(
sbi
);

1388 
	`__wa™_®l_disÿrd_cmd
(
sbi
, 
NULL
);

1389  
drİ³d
;

1390 
	}
}

1392 
	$issue_disÿrd_th»ad
(*
d©a
)

1394 
f2fs_sb_šfo
 *
sbi
 = 
d©a
;

1395 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1396 
wa™_queue_h—d_t
 *
q
 = &
dcc
->
disÿrd_wa™_queue
;

1397 
disÿrd_pŞicy
 
dpŞicy
;

1398 
wa™_ms
 = 
DEF_MIN_DISCARD_ISSUE_TIME
;

1399 
issued
;

1401 
	`£t_ä“zabË
();

1404 
	`__š™_disÿrd_pŞicy
(
sbi
, &
dpŞicy
, 
DPOLICY_BG
,

1405 
dcc
->
disÿrd_g¿nuÏr™y
);

1407 
	`wa™_ev’t_š‹¼u±ibË_timeout
(*
q
,

1408 
	`kth»ad_should_¡İ
(è|| 
	`ä“zšg
(
cu¼’t
) ||

1409 
dcc
->
disÿrd_wake
,

1410 
	`m£cs_to_jiff›s
(
wa™_ms
));

1412 ià(
dcc
->
disÿrd_wake
)

1413 
dcc
->
disÿrd_wake
 = 0;

1415 ià(
	`Œy_to_ä“ze
())

1417 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

1419 ià(
	`kth»ad_should_¡İ
())

1421 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_FSCK
)) {

1422 
wa™_ms
 = 
dpŞicy
.
max_š‹rv®
;

1426 ià(
sbi
->
gc_mode
 =ğ
GC_URGENT
)

1427 
	`__š™_disÿrd_pŞicy
(
sbi
, &
dpŞicy
, 
DPOLICY_FORCE
, 1);

1429 
	`sb_¡¬t_štwr™e
(
sbi
->
sb
);

1431 
issued
 = 
	`__issue_disÿrd_cmd
(
sbi
, &
dpŞicy
);

1432 ià(
issued
 > 0) {

1433 
	`__wa™_®l_disÿrd_cmd
(
sbi
, &
dpŞicy
);

1434 
wa™_ms
 = 
dpŞicy
.
mš_š‹rv®
;

1435 } ià(
issued
 == -1){

1436 
wa™_ms
 = 
dpŞicy
.
mid_š‹rv®
;

1438 
wa™_ms
 = 
dpŞicy
.
max_š‹rv®
;

1441 
	`sb_’d_štwr™e
(
sbi
->
sb
);

1443 } !
	`kth»ad_should_¡İ
());

1445 
	}
}

1447 #ifdeà
CONFIG_BLK_DEV_ZONED


1448 
	$__f2fs_issue_disÿrd_zÚe
(
f2fs_sb_šfo
 *
sbi
,

1449 
block_deviû
 *
bdev
, 
block_t
 
blk¡¬t
, block_ˆ
blkËn
)

1451 
£ùÜ_t
 
£ùÜ
, 
Ä_£ùs
;

1452 
block_t
 
lblk¡¬t
 = 
blk¡¬t
;

1453 
devi
 = 0;

1455 ià(
sbi
->
s_ndevs
) {

1456 
devi
 = 
	`f2fs_rg‘_deviû_šdex
(
sbi
, 
blk¡¬t
);

1457 
blk¡¬t
 -ğ
	`FDEV
(
devi
).
¡¬t_blk
;

1465 
	`g‘_blkz_ty³
(
sbi
, 
bdev
, 
blk¡¬t
)) {

1467 
BLK_ZONE_TYPE_CONVENTIONAL
:

1468 ià(!
	`blk_queue_disÿrd
(
	`bdev_g‘_queue
(
bdev
)))

1470  
	`__queue_disÿrd_cmd
(
sbi
, 
bdev
, 
lblk¡¬t
, 
blkËn
);

1471 
BLK_ZONE_TYPE_SEQWRITE_REQ
:

1472 
BLK_ZONE_TYPE_SEQWRITE_PREF
:

1473 
£ùÜ
 = 
	`SECTOR_FROM_BLOCK
(
blk¡¬t
);

1474 
Ä_£ùs
 = 
	`SECTOR_FROM_BLOCK
(
blkËn
);

1476 ià(
£ùÜ
 & (
	`bdev_zÚe_£ùÜs
(
bdev
) - 1) ||

1477 
Ä_£ùs
 !ğ
	`bdev_zÚe_£ùÜs
(
bdev
)) {

1478 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
,

1480 
devi
, 
sbi
->
s_ndevs
 ? 
	`FDEV
(devi).
·th
: "",

1481 
blk¡¬t
, 
blkËn
);

1482  -
EIO
;

1484 
	`Œaû_f2fs_issue_»£t_zÚe
(
bdev
, 
blk¡¬t
);

1485  
	`blkdev_»£t_zÚes
(
bdev
, 
£ùÜ
,

1486 
Ä_£ùs
, 
GFP_NOFS
);

1489  -
EIO
;

1491 
	}
}

1494 
	$__issue_disÿrd_async
(
f2fs_sb_šfo
 *
sbi
,

1495 
block_deviû
 *
bdev
, 
block_t
 
blk¡¬t
, block_ˆ
blkËn
)

1497 #ifdeà
CONFIG_BLK_DEV_ZONED


1498 ià(
	`f2fs_sb_has_blkzÚed
(
sbi
->
sb
) &&

1499 
	`bdev_zÚed_mod–
(
bdev
è!ğ
BLK_ZONED_NONE
)

1500  
	`__f2fs_issue_disÿrd_zÚe
(
sbi
, 
bdev
, 
blk¡¬t
, 
blkËn
);

1502  
	`__queue_disÿrd_cmd
(
sbi
, 
bdev
, 
blk¡¬t
, 
blkËn
);

1503 
	}
}

1505 
	$f2fs_issue_disÿrd
(
f2fs_sb_šfo
 *
sbi
,

1506 
block_t
 
blk¡¬t
, block_ˆ
blkËn
)

1508 
£ùÜ_t
 
¡¬t
 = 
blk¡¬t
, 
Ën
 = 0;

1509 
block_deviû
 *
bdev
;

1510 
£g_’Œy
 *
£
;

1511 
off£t
;

1512 
block_t
 
i
;

1513 
”r
 = 0;

1515 
bdev
 = 
	`f2fs_rg‘_deviû
(
sbi
, 
blk¡¬t
, 
NULL
);

1517 
i
 = 
blk¡¬t
; i < blk¡¬ˆ+ 
blkËn
; i++, 
Ën
++) {

1518 ià(
i
 !ğ
¡¬t
) {

1519 
block_deviû
 *
bdev2
 =

1520 
	`f2fs_rg‘_deviû
(
sbi
, 
i
, 
NULL
);

1522 ià(
bdev2
 !ğ
bdev
) {

1523 
”r
 = 
	`__issue_disÿrd_async
(
sbi
, 
bdev
,

1524 
¡¬t
, 
Ën
);

1525 ià(
”r
)

1526  
”r
;

1527 
bdev
 = 
bdev2
;

1528 
¡¬t
 = 
i
;

1529 
Ën
 = 0;

1533 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
	`GET_SEGNO
(sbi, 
i
));

1534 
off£t
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
i
);

1536 ià(!
	`f2fs_‹¡_ªd_£t_b™
(
off£t
, 
£
->
disÿrd_m­
))

1537 
sbi
->
disÿrd_blks
--;

1540 ià(
Ën
)

1541 
”r
 = 
	`__issue_disÿrd_async
(
sbi
, 
bdev
, 
¡¬t
, 
Ën
);

1542  
”r
;

1543 
	}
}

1545 
boŞ
 
	$add_disÿrd_addrs
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
,

1546 
boŞ
 
check_Úly
)

1548 
’Œ›s
 = 
SIT_VBLOCK_MAP_SIZE
 / ();

1549 
max_blocks
 = 
sbi
->
blocks_³r_£g
;

1550 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
ıc
->
Œim_¡¬t
);

1551 *
cur_m­
 = (*)
£
->
cur_v®id_m­
;

1552 *
ck±_m­
 = (*)
£
->
ck±_v®id_m­
;

1553 *
disÿrd_m­
 = (*)
£
->discard_map;

1554 *
dm­
 = 
	`SIT_I
(
sbi
)->
tmp_m­
;

1555 
¡¬t
 = 0, 
’d
 = -1;

1556 
boŞ
 
fÜû
 = (
ıc
->
»asÚ
 & 
CP_DISCARD
);

1557 
disÿrd_’Œy
 *
de
 = 
NULL
;

1558 
li¡_h—d
 *
h—d
 = &
	`SM_I
(
sbi
)->
dcc_šfo
->
’Œy_li¡
;

1559 
i
;

1561 ià(
£
->
v®id_blocks
 =ğ
max_blocks
 || !
	`f2fs_disÿrd_’
(
sbi
))

1562  
çl£
;

1564 ià(!
fÜû
) {

1565 ià(!
	`‹¡_İt
(
sbi
, 
DISCARD
è|| !
£
->
v®id_blocks
 ||

1566 
	`SM_I
(
sbi
)->
dcc_šfo
->
Ä_disÿrds
 >=

1567 
	`SM_I
(
sbi
)->
dcc_šfo
->
max_disÿrds
)

1568  
çl£
;

1572 
i
 = 0; i < 
’Œ›s
; i++)

1573 
dm­
[
i
] = 
fÜû
 ? ~
ck±_m­
[i] & ~
disÿrd_m­
[i] :

1574 (
cur_m­
[
i
] ^ 
ck±_m­
[i]) & ckpt_map[i];

1576 
fÜû
 || 
	`SM_I
(
sbi
)->
dcc_šfo
->
Ä_disÿrds
 <=

1577 
	`SM_I
(
sbi
)->
dcc_šfo
->
max_disÿrds
) {

1578 
¡¬t
 = 
	`__fšd_»v_Ãxt_b™
(
dm­
, 
max_blocks
, 
’d
 + 1);

1579 ià(
¡¬t
 >ğ
max_blocks
)

1582 
’d
 = 
	`__fšd_»v_Ãxt_z”o_b™
(
dm­
, 
max_blocks
, 
¡¬t
 + 1);

1583 ià(
fÜû
 && 
¡¬t
 && 
’d
 !ğ
max_blocks


1584 && (
’d
 - 
¡¬t
è< 
ıc
->
Œim_mšËn
)

1587 ià(
check_Úly
)

1588  
Œue
;

1590 ià(!
de
) {

1591 
de
 = 
	`f2fs_kmem_ÿche_®loc
(
disÿrd_’Œy_¦ab
,

1592 
GFP_F2FS_ZERO
);

1593 
de
->
¡¬t_blkaddr
 = 
	`START_BLOCK
(
sbi
, 
ıc
->
Œim_¡¬t
);

1594 
	`li¡_add_
(&
de
->
li¡
, 
h—d
);

1597 
i
 = 
¡¬t
; i < 
’d
; i++)

1598 
	`__£t_b™_Ë
(
i
, (*)
de
->
disÿrd_m­
);

1600 
	`SM_I
(
sbi
)->
dcc_šfo
->
Ä_disÿrds
 +ğ
’d
 - 
¡¬t
;

1602  
çl£
;

1603 
	}
}

1605 
	$»Ëa£_disÿrd_addr
(
disÿrd_’Œy
 *
’Œy
)

1607 
	`li¡_d–
(&
’Œy
->
li¡
);

1608 
	`kmem_ÿche_ä“
(
disÿrd_’Œy_¦ab
, 
’Œy
);

1609 
	}
}

1611 
	$f2fs_»Ëa£_disÿrd_addrs
(
f2fs_sb_šfo
 *
sbi
)

1613 
li¡_h—d
 *
h—d
 = &(
	`SM_I
(
sbi
)->
dcc_šfo
->
’Œy_li¡
);

1614 
disÿrd_’Œy
 *
’Œy
, *
this
;

1617 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
this
, 
h—d
, 
li¡
)

1618 
	`»Ëa£_disÿrd_addr
(
’Œy
);

1619 
	}
}

1624 
	$£t_´eä“_as_ä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

1626 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

1627 
£gno
;

1629 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

1630 
	`fÜ_—ch_£t_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
PRE
], 
	`MAIN_SEGS
(
sbi
))

1631 
	`__£t_‹¡_ªd_ä“
(
sbi
, 
£gno
);

1632 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

1633 
	}
}

1635 
	$f2fs_ş—r_´eä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
,

1636 
ı_cÚŒŞ
 *
ıc
)

1638 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1639 
li¡_h—d
 *
h—d
 = &
dcc
->
’Œy_li¡
;

1640 
disÿrd_’Œy
 *
’Œy
, *
this
;

1641 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

1642 *
´eä“_m­
 = 
dœty_i
->
dœty_£gm­
[
PRE
];

1643 
¡¬t
 = 0, 
’d
 = -1;

1644 
£úo
, 
¡¬t_£gno
;

1645 
boŞ
 
fÜû
 = (
ıc
->
»asÚ
 & 
CP_DISCARD
);

1647 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

1650 
i
;

1651 
¡¬t
 = 
	`fšd_Ãxt_b™
(
´eä“_m­
, 
	`MAIN_SEGS
(
sbi
), 
’d
 + 1);

1652 ià(
¡¬t
 >ğ
	`MAIN_SEGS
(
sbi
))

1654 
’d
 = 
	`fšd_Ãxt_z”o_b™
(
´eä“_m­
, 
	`MAIN_SEGS
(
sbi
),

1655 
¡¬t
 + 1);

1657 
i
 = 
¡¬t
; i < 
’d
; i++)

1658 
	`ş—r_b™
(
i
, 
´eä“_m­
);

1660 
dœty_i
->
Ä_dœty
[
PRE
] -ğ
’d
 - 
¡¬t
;

1662 ià(!
	`‹¡_İt
(
sbi
, 
DISCARD
))

1665 ià(
fÜû
 && 
¡¬t
 >ğ
ıc
->
Œim_¡¬t
 &&

1666 (
’d
 - 1è<ğ
ıc
->
Œim_’d
)

1669 ià(!
	`‹¡_İt
(
sbi
, 
LFS
è|| sbi->
£gs_³r_£c
 == 1) {

1670 
	`f2fs_issue_disÿrd
(
sbi
, 
	`START_BLOCK
(sbi, 
¡¬t
),

1671 (
’d
 - 
¡¬t
è<< 
sbi
->
log_blocks_³r_£g
);

1674 
Ãxt
:

1675 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
¡¬t
);

1676 
¡¬t_£gno
 = 
	`GET_SEG_FROM_SEC
(
sbi
, 
£úo
);

1677 ià(!
	`IS_CURSEC
(
sbi
, 
£úo
) &&

1678 !
	`g‘_v®id_blocks
(
sbi
, 
¡¬t
, 
Œue
))

1679 
	`f2fs_issue_disÿrd
(
sbi
, 
	`START_BLOCK
(sbi, 
¡¬t_£gno
),

1680 
sbi
->
£gs_³r_£c
 << sbi->
log_blocks_³r_£g
);

1682 
¡¬t
 = 
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
;

1683 ià(
¡¬t
 < 
’d
)

1684 
Ãxt
;

1686 
’d
 = 
¡¬t
 - 1;

1688 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

1691 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
this
, 
h—d
, 
li¡
) {

1692 
cur_pos
 = 0, 
Ãxt_pos
, 
Ën
, 
tÙ®_Ën
 = 0;

1693 
boŞ
 
is_v®id
 = 
	`‹¡_b™_Ë
(0, 
’Œy
->
disÿrd_m­
);

1695 
fšd_Ãxt
:

1696 ià(
is_v®id
) {

1697 
Ãxt_pos
 = 
	`fšd_Ãxt_z”o_b™_Ë
(
’Œy
->
disÿrd_m­
,

1698 
sbi
->
blocks_³r_£g
, 
cur_pos
);

1699 
Ën
 = 
Ãxt_pos
 - 
cur_pos
;

1701 ià(
	`f2fs_sb_has_blkzÚed
(
sbi
->
sb
) ||

1702 (
fÜû
 && 
Ën
 < 
ıc
->
Œim_mšËn
))

1703 
sk
;

1705 
	`f2fs_issue_disÿrd
(
sbi
, 
’Œy
->
¡¬t_blkaddr
 + 
cur_pos
,

1706 
Ën
);

1707 
tÙ®_Ën
 +ğ
Ën
;

1709 
Ãxt_pos
 = 
	`fšd_Ãxt_b™_Ë
(
’Œy
->
disÿrd_m­
,

1710 
sbi
->
blocks_³r_£g
, 
cur_pos
);

1712 
sk
:

1713 
cur_pos
 = 
Ãxt_pos
;

1714 
is_v®id
 = !is_valid;

1716 ià(
cur_pos
 < 
sbi
->
blocks_³r_£g
)

1717 
fšd_Ãxt
;

1719 
	`»Ëa£_disÿrd_addr
(
’Œy
);

1720 
dcc
->
Ä_disÿrds
 -ğ
tÙ®_Ën
;

1723 
	`wake_up_disÿrd_th»ad
(
sbi
, 
çl£
);

1724 
	}
}

1726 
	$ü—‹_disÿrd_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
)

1728 
dev_t
 
dev
 = 
sbi
->
sb
->
s_bdev
->
bd_dev
;

1729 
disÿrd_cmd_cÚŒŞ
 *
dcc
;

1730 
”r
 = 0, 
i
;

1732 ià(
	`SM_I
(
sbi
)->
dcc_šfo
) {

1733 
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1734 
š™_th»ad
;

1737 
dcc
 = 
	`f2fs_kz®loc
(
sbi
, (
disÿrd_cmd_cÚŒŞ
), 
GFP_KERNEL
);

1738 ià(!
dcc
)

1739  -
ENOMEM
;

1741 
dcc
->
disÿrd_g¿nuÏr™y
 = 
DEFAULT_DISCARD_GRANULARITY
;

1742 
	`INIT_LIST_HEAD
(&
dcc
->
’Œy_li¡
);

1743 
i
 = 0; i < 
MAX_PLIST_NUM
; i++)

1744 
	`INIT_LIST_HEAD
(&
dcc
->
³nd_li¡
[
i
]);

1745 
	`INIT_LIST_HEAD
(&
dcc
->
wa™_li¡
);

1746 
	`INIT_LIST_HEAD
(&
dcc
->
f¡rim_li¡
);

1747 
	`mu‹x_š™
(&
dcc
->
cmd_lock
);

1748 
	`©omic_£t
(&
dcc
->
issued_disÿrd
, 0);

1749 
	`©omic_£t
(&
dcc
->
issšg_disÿrd
, 0);

1750 
	`©omic_£t
(&
dcc
->
disÿrd_cmd_út
, 0);

1751 
dcc
->
Ä_disÿrds
 = 0;

1752 
dcc
->
max_disÿrds
 = 
	`MAIN_SEGS
(
sbi
è<< sbi->
log_blocks_³r_£g
;

1753 
dcc
->
undisÿrd_blks
 = 0;

1754 
dcc
->
roÙ
 = 
RB_ROOT
;

1756 
	`š™_wa™queue_h—d
(&
dcc
->
disÿrd_wa™_queue
);

1757 
	`SM_I
(
sbi
)->
dcc_šfo
 = 
dcc
;

1758 
š™_th»ad
:

1759 
dcc
->
f2fs_issue_disÿrd
 = 
	`kth»ad_run
(
issue_disÿrd_th»ad
, 
sbi
,

1760 "f2fs_disÿrd-%u:%u", 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

1761 ià(
	`IS_ERR
(
dcc
->
f2fs_issue_disÿrd
)) {

1762 
”r
 = 
	`PTR_ERR
(
dcc
->
f2fs_issue_disÿrd
);

1763 
	`kä“
(
dcc
);

1764 
	`SM_I
(
sbi
)->
dcc_šfo
 = 
NULL
;

1765  
”r
;

1768  
”r
;

1769 
	}
}

1771 
	$de¡roy_disÿrd_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
)

1773 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1775 ià(!
dcc
)

1778 
	`f2fs_¡İ_disÿrd_th»ad
(
sbi
);

1780 
	`kä“
(
dcc
);

1781 
	`SM_I
(
sbi
)->
dcc_šfo
 = 
NULL
;

1782 
	}
}

1784 
boŞ
 
	$__m¬k_s™_’Œy_dœty
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

1786 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

1788 ià(!
	`__‹¡_ªd_£t_b™
(
£gno
, 
s™_i
->
dœty_£Ár›s_b™m­
)) {

1789 
s™_i
->
dœty_£Ár›s
++;

1790  
çl£
;

1793  
Œue
;

1794 
	}
}

1796 
	$__£t_s™_’Œy_ty³
(
f2fs_sb_šfo
 *
sbi
, 
ty³
,

1797 
£gno
, 
modif›d
)

1799 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

1800 
£
->
ty³
 =ype;

1801 ià(
modif›d
)

1802 
	`__m¬k_s™_’Œy_dœty
(
sbi
, 
£gno
);

1803 
	}
}

1805 
	$upd©e_s™_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
, 
d–
)

1807 
£g_’Œy
 *
£
;

1808 
£gno
, 
off£t
;

1809 
Ãw_vblocks
;

1810 
boŞ
 
exi¡
;

1811 #ifdeà
CONFIG_F2FS_CHECK_FS


1812 
boŞ
 
mœ_exi¡
;

1815 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
blkaddr
);

1817 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

1818 
Ãw_vblocks
 = 
£
->
v®id_blocks
 + 
d–
;

1819 
off£t
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
blkaddr
);

1821 
	`f2fs_bug_Ú
(
sbi
, (
Ãw_vblocks
 >> (() << 3) ||

1822 (
Ãw_vblocks
 > 
sbi
->
blocks_³r_£g
)));

1824 
£
->
v®id_blocks
 = 
Ãw_vblocks
;

1825 
£
->
mtime
 = 
	`g‘_mtime
(
sbi
, 
çl£
);

1826 ià(
£
->
mtime
 > 
	`SIT_I
(
sbi
)->
max_mtime
)

1827 
	`SIT_I
(
sbi
)->
max_mtime
 = 
£
->
mtime
;

1830 ià(
d–
 > 0) {

1831 
exi¡
 = 
	`f2fs_‹¡_ªd_£t_b™
(
off£t
, 
£
->
cur_v®id_m­
);

1832 #ifdeà
CONFIG_F2FS_CHECK_FS


1833 
mœ_exi¡
 = 
	`f2fs_‹¡_ªd_£t_b™
(
off£t
,

1834 
£
->
cur_v®id_m­_mœ
);

1835 ià(
	`uÆik–y
(
exi¡
 !ğ
mœ_exi¡
)) {

1836 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
, "Inconsistentƒrror "

1838 
blkaddr
, 
exi¡
);

1839 
	`f2fs_bug_Ú
(
sbi
, 1);

1842 ià(
	`uÆik–y
(
exi¡
)) {

1843 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
,

1844 "B™m­ wa wrÚgly s‘, blk:%u", 
blkaddr
);

1845 
	`f2fs_bug_Ú
(
sbi
, 1);

1846 
£
->
v®id_blocks
--;

1847 
d–
 = 0;

1850 ià(
	`f2fs_disÿrd_’
(
sbi
) &&

1851 !
	`f2fs_‹¡_ªd_£t_b™
(
off£t
, 
£
->
disÿrd_m­
))

1852 
sbi
->
disÿrd_blks
--;

1855 ià(
	`IS_NODESEG
(
£
->
ty³
)) {

1856 ià(!
	`f2fs_‹¡_ªd_£t_b™
(
off£t
, 
£
->
ck±_v®id_m­
))

1857 
£
->
ck±_v®id_blocks
++;

1860 
exi¡
 = 
	`f2fs_‹¡_ªd_ş—r_b™
(
off£t
, 
£
->
cur_v®id_m­
);

1861 #ifdeà
CONFIG_F2FS_CHECK_FS


1862 
mœ_exi¡
 = 
	`f2fs_‹¡_ªd_ş—r_b™
(
off£t
,

1863 
£
->
cur_v®id_m­_mœ
);

1864 ià(
	`uÆik–y
(
exi¡
 !ğ
mœ_exi¡
)) {

1865 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
, "Inconsistentƒrror "

1867 
blkaddr
, 
exi¡
);

1868 
	`f2fs_bug_Ú
(
sbi
, 1);

1871 ià(
	`uÆik–y
(!
exi¡
)) {

1872 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
,

1873 "B™m­ wa wrÚgly cË¬ed, blk:%u", 
blkaddr
);

1874 
	`f2fs_bug_Ú
(
sbi
, 1);

1875 
£
->
v®id_blocks
++;

1876 
d–
 = 0;

1879 ià(
	`f2fs_disÿrd_’
(
sbi
) &&

1880 
	`f2fs_‹¡_ªd_ş—r_b™
(
off£t
, 
£
->
disÿrd_m­
))

1881 
sbi
->
disÿrd_blks
++;

1883 ià(!
	`f2fs_‹¡_b™
(
off£t
, 
£
->
ck±_v®id_m­
))

1884 
£
->
ck±_v®id_blocks
 +ğ
d–
;

1886 
	`__m¬k_s™_’Œy_dœty
(
sbi
, 
£gno
);

1889 
	`SIT_I
(
sbi
)->
wr™‹n_v®id_blocks
 +ğ
d–
;

1891 ià(
sbi
->
£gs_³r_£c
 > 1)

1892 
	`g‘_£c_’Œy
(
sbi
, 
£gno
)->
v®id_blocks
 +ğ
d–
;

1893 
	}
}

1895 
	$f2fs_šv®id©e_blocks
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
addr
)

1897 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
addr
);

1898 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

1900 
	`f2fs_bug_Ú
(
sbi
, 
addr
 =ğ
NULL_ADDR
);

1901 ià(
addr
 =ğ
NEW_ADDR
)

1905 
	`down_wr™e
(&
s™_i
->
£Áry_lock
);

1907 
	`upd©e_s™_’Œy
(
sbi
, 
addr
, -1);

1910 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
);

1912 
	`up_wr™e
(&
s™_i
->
£Áry_lock
);

1913 
	}
}

1915 
boŞ
 
	$f2fs_is_checkpoš‹d_d©a
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
)

1917 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

1918 
£gno
, 
off£t
;

1919 
£g_’Œy
 *
£
;

1920 
boŞ
 
is_ı
 = 
çl£
;

1922 ià(!
	`is_v®id_blkaddr
(
blkaddr
))

1923  
Œue
;

1925 
	`down_»ad
(&
s™_i
->
£Áry_lock
);

1927 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
blkaddr
);

1928 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

1929 
off£t
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
blkaddr
);

1931 ià(
	`f2fs_‹¡_b™
(
off£t
, 
£
->
ck±_v®id_m­
))

1932 
is_ı
 = 
Œue
;

1934 
	`up_»ad
(&
s™_i
->
£Áry_lock
);

1936  
is_ı
;

1937 
	}
}

1942 
	$__add_sum_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
ty³
,

1943 
f2fs_summ¬y
 *
sum
)

1945 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

1946 *
addr
 = 
cur£g
->
sum_blk
;

1947 
addr
 +ğ
cur£g
->
Ãxt_blkoff
 * (
f2fs_summ¬y
);

1948 
	`memıy
(
addr
, 
sum
, (
f2fs_summ¬y
));

1949 
	}
}

1954 
	$f2fs_Åages_fÜ_summ¬y_æush
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
fÜ_¿
)

1956 
v®id_sum_couÁ
 = 0;

1957 
i
, 
sum_š_·ge
;

1959 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

1960 ià(
sbi
->
ck±
->
®loc_ty³
[
i
] =ğ
SSR
)

1961 
v®id_sum_couÁ
 +ğ
sbi
->
blocks_³r_£g
;

1963 ià(
fÜ_¿
)

1964 
v®id_sum_couÁ
 +ğ
	`Ë16_to_ıu
(

1965 
	`F2FS_CKPT
(
sbi
)->
cur_d©a_blkoff
[
i
]);

1967 
v®id_sum_couÁ
 +ğ
	`cur£g_blkoff
(
sbi
, 
i
);

1971 
sum_š_·ge
 = (
PAGE_SIZE
 - 2 * 
SUM_JOURNAL_SIZE
 -

1972 
SUM_FOOTER_SIZE
è/ 
SUMMARY_SIZE
;

1973 ià(
v®id_sum_couÁ
 <ğ
sum_š_·ge
)

1975 ià((
v®id_sum_couÁ
 - 
sum_š_·ge
) <=

1976 (
PAGE_SIZE
 - 
SUM_FOOTER_SIZE
è/ 
SUMMARY_SIZE
)

1979 
	}
}

1984 
·ge
 *
	$f2fs_g‘_sum_·ge
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

1986  
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
	`GET_SUM_BLOCK
(sbi, 
£gno
));

1987 
	}
}

1989 
	$f2fs_upd©e_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
,

1990 *
¤c
, 
block_t
 
blk_addr
)

1992 
·ge
 *·gğ
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
blk_addr
);

1994 
	`memıy
(
	`·ge_add»ss
(
·ge
), 
¤c
, 
PAGE_SIZE
);

1995 
	`£t_·ge_dœty
(
·ge
);

1996 
	`f2fs_put_·ge
(
·ge
, 1);

1997 
	}
}

1999 
	$wr™e_sum_·ge
(
f2fs_sb_šfo
 *
sbi
,

2000 
f2fs_summ¬y_block
 *
sum_blk
, 
block_t
 
blk_addr
)

2002 
	`f2fs_upd©e_m‘a_·ge
(
sbi
, (*)
sum_blk
, 
blk_addr
);

2003 
	}
}

2005 
	$wr™e_cu¼’t_sum_·ge
(
f2fs_sb_šfo
 *
sbi
,

2006 
ty³
, 
block_t
 
blk_addr
)

2008 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2009 
·ge
 *·gğ
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
blk_addr
);

2010 
f2fs_summ¬y_block
 *
¤c
 = 
cur£g
->
sum_blk
;

2011 
f2fs_summ¬y_block
 *
d¡
;

2013 
d¡
 = (
f2fs_summ¬y_block
 *)
	`·ge_add»ss
(
·ge
);

2014 
	`mem£t
(
d¡
, 0, 
PAGE_SIZE
);

2016 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

2018 
	`down_»ad
(&
cur£g
->
jouº®_rw£m
);

2019 
	`memıy
(&
d¡
->
jouº®
, 
cur£g
->jouº®, 
SUM_JOURNAL_SIZE
);

2020 
	`up_»ad
(&
cur£g
->
jouº®_rw£m
);

2022 
	`memıy
(
d¡
->
’Œ›s
, 
¤c
->’Œ›s, 
SUM_ENTRY_SIZE
);

2023 
	`memıy
(&
d¡
->
foÙ”
, &
¤c
->foÙ”, 
SUM_FOOTER_SIZE
);

2025 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

2027 
	`£t_·ge_dœty
(
·ge
);

2028 
	`f2fs_put_·ge
(
·ge
, 1);

2029 
	}
}

2031 
	$is_Ãxt_£gm’t_ä“
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

2033 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2034 
£gno
 = 
cur£g
->segno + 1;

2035 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

2037 ià(
£gno
 < 
	`MAIN_SEGS
(
sbi
è&& segnØ% sbi->
£gs_³r_£c
)

2038  !
	`‹¡_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
);

2040 
	}
}

2046 
	$g‘_Ãw_£gm’t
(
f2fs_sb_šfo
 *
sbi
,

2047 *
Ãw£g
, 
boŞ
 
Ãw_£c
, 
dœ
)

2049 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

2050 
£gno
, 
£úo
, 
zÚ’o
;

2051 
tÙ®_zÚes
 = 
	`MAIN_SECS
(
sbi
è/ sbi->
£cs_³r_zÚe
;

2052 
hšt
 = 
	`GET_SEC_FROM_SEG
(
sbi
, *
Ãw£g
);

2053 
Şd_zÚ’o
 = 
	`GET_ZONE_FROM_SEG
(
sbi
, *
Ãw£g
);

2054 
Ëá_¡¬t
 = 
hšt
;

2055 
boŞ
 
š™
 = 
Œue
;

2056 
go_Ëá
 = 0;

2057 
i
;

2059 
	`¥š_lock
(&
ä“_i
->
£gm­_lock
);

2061 ià(!
Ãw_£c
 && ((*
Ãw£g
 + 1è% 
sbi
->
£gs_³r_£c
)) {

2062 
£gno
 = 
	`fšd_Ãxt_z”o_b™
(
ä“_i
->
ä“_£gm­
,

2063 
	`GET_SEG_FROM_SEC
(
sbi
, 
hšt
 + 1), *
Ãw£g
 + 1);

2064 ià(
£gno
 < 
	`GET_SEG_FROM_SEC
(
sbi
, 
hšt
 + 1))

2065 
gÙ_™
;

2067 
fšd_Ùh”_zÚe
:

2068 
£úo
 = 
	`fšd_Ãxt_z”o_b™
(
ä“_i
->
ä“_£cm­
, 
	`MAIN_SECS
(
sbi
), 
hšt
);

2069 ià(
£úo
 >ğ
	`MAIN_SECS
(
sbi
)) {

2070 ià(
dœ
 =ğ
ALLOC_RIGHT
) {

2071 
£úo
 = 
	`fšd_Ãxt_z”o_b™
(
ä“_i
->
ä“_£cm­
,

2072 
	`MAIN_SECS
(
sbi
), 0);

2073 
	`f2fs_bug_Ú
(
sbi
, 
£úo
 >ğ
	`MAIN_SECS
(sbi));

2075 
go_Ëá
 = 1;

2076 
Ëá_¡¬t
 = 
hšt
 - 1;

2079 ià(
go_Ëá
 == 0)

2080 
sk_Ëá
;

2082 
	`‹¡_b™
(
Ëá_¡¬t
, 
ä“_i
->
ä“_£cm­
)) {

2083 ià(
Ëá_¡¬t
 > 0) {

2084 
Ëá_¡¬t
--;

2087 
Ëá_¡¬t
 = 
	`fšd_Ãxt_z”o_b™
(
ä“_i
->
ä“_£cm­
,

2088 
	`MAIN_SECS
(
sbi
), 0);

2089 
	`f2fs_bug_Ú
(
sbi
, 
Ëá_¡¬t
 >ğ
	`MAIN_SECS
(sbi));

2092 
£úo
 = 
Ëá_¡¬t
;

2093 
sk_Ëá
:

2094 
£gno
 = 
	`GET_SEG_FROM_SEC
(
sbi
, 
£úo
);

2095 
zÚ’o
 = 
	`GET_ZONE_FROM_SEC
(
sbi
, 
£úo
);

2098 ià(!
š™
)

2099 
gÙ_™
;

2100 ià(
sbi
->
£cs_³r_zÚe
 == 1)

2101 
gÙ_™
;

2102 ià(
zÚ’o
 =ğ
Şd_zÚ’o
)

2103 
gÙ_™
;

2104 ià(
dœ
 =ğ
ALLOC_LEFT
) {

2105 ià(!
go_Ëá
 && 
zÚ’o
 + 1 >ğ
tÙ®_zÚes
)

2106 
gÙ_™
;

2107 ià(
go_Ëá
 && 
zÚ’o
 == 0)

2108 
gÙ_™
;

2110 
i
 = 0; i < 
NR_CURSEG_TYPE
; i++)

2111 ià(
	`CURSEG_I
(
sbi
, 
i
)->
zÚe
 =ğ
zÚ’o
)

2114 ià(
i
 < 
NR_CURSEG_TYPE
) {

2116 ià(
go_Ëá
)

2117 
hšt
 = 
zÚ’o
 * 
sbi
->
£cs_³r_zÚe
 - 1;

2118 ià(
zÚ’o
 + 1 >ğ
tÙ®_zÚes
)

2119 
hšt
 = 0;

2121 
hšt
 = (
zÚ’o
 + 1è* 
sbi
->
£cs_³r_zÚe
;

2122 
š™
 = 
çl£
;

2123 
fšd_Ùh”_zÚe
;

2125 
gÙ_™
:

2127 
	`f2fs_bug_Ú
(
sbi
, 
	`‹¡_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
));

2128 
	`__£t_šu£
(
sbi
, 
£gno
);

2129 *
Ãw£g
 = 
£gno
;

2130 
	`¥š_uÆock
(&
ä“_i
->
£gm­_lock
);

2131 
	}
}

2133 
	$»£t_cur£g
(
f2fs_sb_šfo
 *
sbi
, 
ty³
, 
modif›d
)

2135 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2136 
summ¬y_foÙ”
 *
sum_foÙ”
;

2138 
cur£g
->
£gno
 = cur£g->
Ãxt_£gno
;

2139 
cur£g
->
zÚe
 = 
	`GET_ZONE_FROM_SEG
(
sbi
, cur£g->
£gno
);

2140 
cur£g
->
Ãxt_blkoff
 = 0;

2141 
cur£g
->
Ãxt_£gno
 = 
NULL_SEGNO
;

2143 
sum_foÙ”
 = &(
cur£g
->
sum_blk
->
foÙ”
);

2144 
	`mem£t
(
sum_foÙ”
, 0, (
summ¬y_foÙ”
));

2145 ià(
	`IS_DATASEG
(
ty³
))

2146 
	`SET_SUM_TYPE
(
sum_foÙ”
, 
SUM_TYPE_DATA
);

2147 ià(
	`IS_NODESEG
(
ty³
))

2148 
	`SET_SUM_TYPE
(
sum_foÙ”
, 
SUM_TYPE_NODE
);

2149 
	`__£t_s™_’Œy_ty³
(
sbi
, 
ty³
, 
cur£g
->
£gno
, 
modif›d
);

2150 
	}
}

2152 
	$__g‘_Ãxt_£gno
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

2155 ià(
sbi
->
£gs_³r_£c
 != 1)

2156  
	`CURSEG_I
(
sbi
, 
ty³
)->
£gno
;

2158 ià(
	`‹¡_İt
(
sbi
, 
NOHEAP
) &&

2159 (
ty³
 =ğ
CURSEG_HOT_DATA
 || 
	`IS_NODESEG
(type)))

2162 ià(
	`SIT_I
(
sbi
)->
Ï¡_viùim
[
ALLOC_NEXT
])

2163  
	`SIT_I
(
sbi
)->
Ï¡_viùim
[
ALLOC_NEXT
];

2166 ià(
	`F2FS_OPTION
(
sbi
).
®loc_mode
 =ğ
ALLOC_MODE_REUSE
)

2169  
	`CURSEG_I
(
sbi
, 
ty³
)->
£gno
;

2170 
	}
}

2176 
	$Ãw_cur£g
(
f2fs_sb_šfo
 *
sbi
, 
ty³
, 
boŞ
 
Ãw_£c
)

2178 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2179 
£gno
 = 
cur£g
->segno;

2180 
dœ
 = 
ALLOC_LEFT
;

2182 
	`wr™e_sum_·ge
(
sbi
, 
cur£g
->
sum_blk
,

2183 
	`GET_SUM_BLOCK
(
sbi
, 
£gno
));

2184 ià(
ty³
 =ğ
CURSEG_WARM_DATA
 ||y³ =ğ
CURSEG_COLD_DATA
)

2185 
dœ
 = 
ALLOC_RIGHT
;

2187 ià(
	`‹¡_İt
(
sbi
, 
NOHEAP
))

2188 
dœ
 = 
ALLOC_RIGHT
;

2190 
£gno
 = 
	`__g‘_Ãxt_£gno
(
sbi
, 
ty³
);

2191 
	`g‘_Ãw_£gm’t
(
sbi
, &
£gno
, 
Ãw_£c
, 
dœ
);

2192 
cur£g
->
Ãxt_£gno
 = 
£gno
;

2193 
	`»£t_cur£g
(
sbi
, 
ty³
, 1);

2194 
cur£g
->
®loc_ty³
 = 
LFS
;

2195 
	}
}

2197 
	$__Ãxt_ä“_blkoff
(
f2fs_sb_šfo
 *
sbi
,

2198 
cur£g_šfo
 *
£g
, 
block_t
 
¡¬t
)

2200 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£g
->
£gno
);

2201 
’Œ›s
 = 
SIT_VBLOCK_MAP_SIZE
 / ();

2202 *
rg‘_m­
 = 
	`SIT_I
(
sbi
)->
tmp_m­
;

2203 *
ck±_m­
 = (*)
£
->
ck±_v®id_m­
;

2204 *
cur_m­
 = (*)
£
->
cur_v®id_m­
;

2205 
i
, 
pos
;

2207 
i
 = 0; i < 
’Œ›s
; i++)

2208 
rg‘_m­
[
i
] = 
ck±_m­
[i] | 
cur_m­
[i];

2210 
pos
 = 
	`__fšd_»v_Ãxt_z”o_b™
(
rg‘_m­
, 
sbi
->
blocks_³r_£g
, 
¡¬t
);

2212 
£g
->
Ãxt_blkoff
 = 
pos
;

2213 
	}
}

2220 
	$__»äesh_Ãxt_blkoff
(
f2fs_sb_šfo
 *
sbi
,

2221 
cur£g_šfo
 *
£g
)

2223 ià(
£g
->
®loc_ty³
 =ğ
SSR
)

2224 
	`__Ãxt_ä“_blkoff
(
sbi
, 
£g
, seg->
Ãxt_blkoff
 + 1);

2226 
£g
->
Ãxt_blkoff
++;

2227 
	}
}

2233 
	$chªge_cur£g
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

2235 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

2236 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2237 
Ãw_£gno
 = 
cur£g
->
Ãxt_£gno
;

2238 
f2fs_summ¬y_block
 *
sum_node
;

2239 
·ge
 *
sum_·ge
;

2241 
	`wr™e_sum_·ge
(
sbi
, 
cur£g
->
sum_blk
,

2242 
	`GET_SUM_BLOCK
(
sbi
, 
cur£g
->
£gno
));

2243 
	`__£t_‹¡_ªd_šu£
(
sbi
, 
Ãw_£gno
);

2245 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

2246 
	`__»move_dœty_£gm’t
(
sbi
, 
Ãw_£gno
, 
PRE
);

2247 
	`__»move_dœty_£gm’t
(
sbi
, 
Ãw_£gno
, 
DIRTY
);

2248 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

2250 
	`»£t_cur£g
(
sbi
, 
ty³
, 1);

2251 
cur£g
->
®loc_ty³
 = 
SSR
;

2252 
	`__Ãxt_ä“_blkoff
(
sbi
, 
cur£g
, 0);

2254 
sum_·ge
 = 
	`f2fs_g‘_sum_·ge
(
sbi
, 
Ãw_£gno
);

2255 
sum_node
 = (
f2fs_summ¬y_block
 *)
	`·ge_add»ss
(
sum_·ge
);

2256 
	`memıy
(
cur£g
->
sum_blk
, 
sum_node
, 
SUM_ENTRY_SIZE
);

2257 
	`f2fs_put_·ge
(
sum_·ge
, 1);

2258 
	}
}

2260 
	$g‘_s¤_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

2262 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2263 cÚ¡ 
viùim_£ËùiÚ
 *
v_İs
 = 
	`DIRTY_I
(
sbi
)->v_ops;

2264 
£gno
 = 
NULL_SEGNO
;

2265 
i
, 
út
;

2266 
boŞ
 
»v”£d
 = 
çl£
;

2269 ià(
v_İs
->
	`g‘_viùim
(
sbi
, &
£gno
, 
BG_GC
, 
ty³
, 
SSR
)) {

2270 
cur£g
->
Ãxt_£gno
 = 
£gno
;

2275 ià(
	`IS_NODESEG
(
ty³
)) {

2276 ià(
ty³
 >ğ
CURSEG_WARM_NODE
) {

2277 
»v”£d
 = 
Œue
;

2278 
i
 = 
CURSEG_COLD_NODE
;

2280 
i
 = 
CURSEG_HOT_NODE
;

2282 
út
 = 
NR_CURSEG_NODE_TYPE
;

2284 ià(
ty³
 >ğ
CURSEG_WARM_DATA
) {

2285 
»v”£d
 = 
Œue
;

2286 
i
 = 
CURSEG_COLD_DATA
;

2288 
i
 = 
CURSEG_HOT_DATA
;

2290 
út
 = 
NR_CURSEG_DATA_TYPE
;

2293 ; 
út
-- > 0; 
»v”£d
 ? 
i
-- : i++) {

2294 ià(
i
 =ğ
ty³
)

2296 ià(
v_İs
->
	`g‘_viùim
(
sbi
, &
£gno
, 
BG_GC
, 
i
, 
SSR
)) {

2297 
cur£g
->
Ãxt_£gno
 = 
£gno
;

2302 
	}
}

2308 
	$®loÿ‹_£gm’t_by_deçuÉ
(
f2fs_sb_šfo
 *
sbi
,

2309 
ty³
, 
boŞ
 
fÜû
)

2311 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2313 ià(
fÜû
)

2314 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
Œue
);

2315 ià(!
	`is_£t_ck±_æags
(
sbi
, 
CP_CRC_RECOVERY_FLAG
) &&

2316 
ty³
 =ğ
CURSEG_WARM_NODE
)

2317 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
çl£
);

2318 ià(
cur£g
->
®loc_ty³
 =ğ
LFS
 && 
	`is_Ãxt_£gm’t_ä“
(
sbi
, 
ty³
))

2319 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
çl£
);

2320 ià(
	`f2fs_Ãed_SSR
(
sbi
è&& 
	`g‘_s¤_£gm’t
(sbi, 
ty³
))

2321 
	`chªge_cur£g
(
sbi
, 
ty³
);

2323 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
çl£
);

2325 
	`¡©_šc_£g_ty³
(
sbi
, 
cur£g
);

2326 
	}
}

2328 
	$f2fs_®loÿ‹_Ãw_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

2330 
cur£g_šfo
 *
cur£g
;

2331 
Şd_£gno
;

2332 
i
;

2334 
	`down_wr™e
(&
	`SIT_I
(
sbi
)->
£Áry_lock
);

2336 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

2337 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
i
);

2338 
Şd_£gno
 = 
cur£g
->
£gno
;

2339 
	`SIT_I
(
sbi
)->
s_İs
->
	`®loÿ‹_£gm’t
(sbi, 
i
, 
Œue
);

2340 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
Şd_£gno
);

2343 
	`up_wr™e
(&
	`SIT_I
(
sbi
)->
£Áry_lock
);

2344 
	}
}

2346 cÚ¡ 
£gm’t_®loÿtiÚ
 
	gdeçuÉ_§Îoc_İs
 = {

2347 .
®loÿ‹_£gm’t
 = 
®loÿ‹_£gm’t_by_deçuÉ
,

2350 
boŞ
 
	$f2fs_exi¡_Œim_ÿndid©es
(
f2fs_sb_šfo
 *
sbi
,

2351 
ı_cÚŒŞ
 *
ıc
)

2353 
__u64
 
Œim_¡¬t
 = 
ıc
->trim_start;

2354 
boŞ
 
has_ÿndid©e
 = 
çl£
;

2356 
	`down_wr™e
(&
	`SIT_I
(
sbi
)->
£Áry_lock
);

2357 ; 
ıc
->
Œim_¡¬t
 <ğıc->
Œim_’d
; cpc->trim_start++) {

2358 ià(
	`add_disÿrd_addrs
(
sbi
, 
ıc
, 
Œue
)) {

2359 
has_ÿndid©e
 = 
Œue
;

2363 
	`up_wr™e
(&
	`SIT_I
(
sbi
)->
£Áry_lock
);

2365 
ıc
->
Œim_¡¬t
 =rim_start;

2366  
has_ÿndid©e
;

2367 
	}
}

2369 
	$__issue_disÿrd_cmd_¿nge
(
f2fs_sb_šfo
 *
sbi
,

2370 
disÿrd_pŞicy
 *
dpŞicy
,

2371 
¡¬t
, 
’d
)

2373 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

2374 
disÿrd_cmd
 *
´ev_dc
 = 
NULL
, *
Ãxt_dc
 = NULL;

2375 
rb_node
 **
š£¹_p
 = 
NULL
, *
š£¹_·»Á
 = NULL;

2376 
disÿrd_cmd
 *
dc
;

2377 
blk_¶ug
 
¶ug
;

2378 
issued
;

2380 
Ãxt
:

2381 
issued
 = 0;

2383 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

2384 
	`f2fs_bug_Ú
(
sbi
, !
	`f2fs_check_rb_Œ“_cÚsi¡’û
(sbi, &
dcc
->
roÙ
));

2386 
dc
 = (
disÿrd_cmd
 *)
	`f2fs_lookup_rb_Œ“_»t
(&
dcc
->
roÙ
,

2387 
NULL
, 
¡¬t
,

2388 (
rb_’Œy
 **)&
´ev_dc
,

2389 (
rb_’Œy
 **)&
Ãxt_dc
,

2390 &
š£¹_p
, &
š£¹_·»Á
, 
Œue
);

2391 ià(!
dc
)

2392 
dc
 = 
Ãxt_dc
;

2394 
	`blk_¡¬t_¶ug
(&
¶ug
);

2396 
dc
 && dc->
l¡¬t
 <ğ
’d
) {

2397 
rb_node
 *
node
;

2399 ià(
dc
->
Ën
 < 
dpŞicy
->
g¿nuÏr™y
)

2400 
sk
;

2402 ià(
dc
->
¡©e
 !ğ
D_PREP
) {

2403 
	`li¡_move_
(&
dc
->
li¡
, &
dcc
->
f¡rim_li¡
);

2404 
sk
;

2407 
	`__subm™_disÿrd_cmd
(
sbi
, 
dpŞicy
, 
dc
);

2409 ià(++
issued
 >ğ
dpŞicy
->
max_»que¡s
) {

2410 
¡¬t
 = 
dc
->
l¡¬t
 + dc->
Ën
;

2412 
	`blk_fšish_¶ug
(&
¶ug
);

2413 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

2414 
	`__wa™_®l_disÿrd_cmd
(
sbi
, 
NULL
);

2415 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

2416 
Ãxt
;

2418 
sk
:

2419 
node
 = 
	`rb_Ãxt
(&
dc
->
rb_node
);

2420 
dc
 = 
	`rb_’Œy_§ã
(
node
, 
disÿrd_cmd
, 
rb_node
);

2422 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

2426 
	`blk_fšish_¶ug
(&
¶ug
);

2427 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

2428 
	}
}

2430 
	$f2fs_Œim_fs
(
f2fs_sb_šfo
 *
sbi
, 
f¡rim_¿nge
 *
¿nge
)

2432 
__u64
 
¡¬t
 = 
	`F2FS_BYTES_TO_BLK
(
¿nge
->start);

2433 
__u64
 
’d
 = 
¡¬t
 + 
	`F2FS_BYTES_TO_BLK
(
¿nge
->
Ën
) - 1;

2434 
¡¬t_£gno
, 
’d_£gno
;

2435 
block_t
 
¡¬t_block
, 
’d_block
;

2436 
ı_cÚŒŞ
 
ıc
;

2437 
disÿrd_pŞicy
 
dpŞicy
;

2438 
Œimmed
 = 0;

2439 
”r
 = 0;

2441 ià(
¡¬t
 >ğ
	`MAX_BLKADDR
(
sbi
è|| 
¿nge
->
Ën
 < sbi->
blocksize
)

2442  -
EINVAL
;

2444 ià(
’d
 <ğ
	`MAIN_BLKADDR
(
sbi
))

2445  -
EINVAL
;

2447 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_FSCK
)) {

2448 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

2450  -
EIO
;

2454 
¡¬t_£gno
 = (
¡¬t
 <ğ
	`MAIN_BLKADDR
(
sbi
)è? 0 : 
	`GET_SEGNO
(sbi, start);

2455 
’d_£gno
 = (
’d
 >ğ
	`MAX_BLKADDR
(
sbi
)è? 
	`MAIN_SEGS
(sbi) - 1 :

2456 
	`GET_SEGNO
(
sbi
, 
’d
);

2458 
ıc
.
»asÚ
 = 
CP_DISCARD
;

2459 
ıc
.
Œim_mšËn
 = 
	`max_t
(
__u64
, 1, 
	`F2FS_BYTES_TO_BLK
(
¿nge
->
mšËn
));

2460 
ıc
.
Œim_¡¬t
 = 
¡¬t_£gno
;

2461 
ıc
.
Œim_’d
 = 
’d_£gno
;

2463 ià(
sbi
->
disÿrd_blks
 == 0)

2464 
out
;

2466 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

2467 
”r
 = 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

2468 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

2469 ià(
”r
)

2470 
out
;

2472 
¡¬t_block
 = 
	`START_BLOCK
(
sbi
, 
¡¬t_£gno
);

2473 
’d_block
 = 
	`START_BLOCK
(
sbi
, 
’d_£gno
 + 1);

2475 
	`__š™_disÿrd_pŞicy
(
sbi
, &
dpŞicy
, 
DPOLICY_FSTRIM
, 
ıc
.
Œim_mšËn
);

2476 
	`__issue_disÿrd_cmd_¿nge
(
sbi
, &
dpŞicy
, 
¡¬t_block
, 
’d_block
);

2484 ià(!
	`‹¡_İt
(
sbi
, 
DISCARD
)) {

2485 
Œimmed
 = 
	`__wa™_disÿrd_cmd_¿nge
(
sbi
, &
dpŞicy
,

2486 
¡¬t_block
, 
’d_block
);

2487 
¿nge
->
Ën
 = 
	`F2FS_BLK_TO_BYTES
(
Œimmed
);

2489 
out
:

2490  
”r
;

2491 
	}
}

2493 
boŞ
 
	$__has_cur£g_¥aû
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

2495 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2496 ià(
cur£g
->
Ãxt_blkoff
 < 
sbi
->
blocks_³r_£g
)

2497  
Œue
;

2498  
çl£
;

2499 
	}
}

2501 
	$f2fs_rw_hšt_to_£g_ty³
(
rw_hšt
 
hšt
)

2503 
hšt
) {

2504 
WRITE_LIFE_SHORT
:

2505  
CURSEG_HOT_DATA
;

2506 
WRITE_LIFE_EXTREME
:

2507  
CURSEG_COLD_DATA
;

2509  
CURSEG_WARM_DATA
;

2511 
	}
}

2574 
rw_hšt
 
	$f2fs_io_ty³_to_rw_hšt
(
f2fs_sb_šfo
 *
sbi
,

2575 
·ge_ty³
 
ty³
, 
‹mp_ty³
 
‹mp
)

2577 ià(
	`F2FS_OPTION
(
sbi
).
whšt_mode
 =ğ
WHINT_MODE_USER
) {

2578 ià(
ty³
 =ğ
DATA
) {

2579 ià(
‹mp
 =ğ
WARM
)

2580  
WRITE_LIFE_NOT_SET
;

2581 ià(
‹mp
 =ğ
HOT
)

2582  
WRITE_LIFE_SHORT
;

2583 ià(
‹mp
 =ğ
COLD
)

2584  
WRITE_LIFE_EXTREME
;

2586  
WRITE_LIFE_NOT_SET
;

2588 } ià(
	`F2FS_OPTION
(
sbi
).
whšt_mode
 =ğ
WHINT_MODE_FS
) {

2589 ià(
ty³
 =ğ
DATA
) {

2590 ià(
‹mp
 =ğ
WARM
)

2591  
WRITE_LIFE_LONG
;

2592 ià(
‹mp
 =ğ
HOT
)

2593  
WRITE_LIFE_SHORT
;

2594 ià(
‹mp
 =ğ
COLD
)

2595  
WRITE_LIFE_EXTREME
;

2596 } ià(
ty³
 =ğ
NODE
) {

2597 ià(
‹mp
 =ğ
WARM
 ||em°=ğ
HOT
)

2598  
WRITE_LIFE_NOT_SET
;

2599 ià(
‹mp
 =ğ
COLD
)

2600  
WRITE_LIFE_NONE
;

2601 } ià(
ty³
 =ğ
META
) {

2602  
WRITE_LIFE_MEDIUM
;

2605  
WRITE_LIFE_NOT_SET
;

2606 
	}
}

2608 
	$__g‘_£gm’t_ty³_2
(
f2fs_io_šfo
 *
fio
)

2610 ià(
fio
->
ty³
 =ğ
DATA
)

2611  
CURSEG_HOT_DATA
;

2613  
CURSEG_HOT_NODE
;

2614 
	}
}

2616 
	$__g‘_£gm’t_ty³_4
(
f2fs_io_šfo
 *
fio
)

2618 ià(
fio
->
ty³
 =ğ
DATA
) {

2619 
šode
 *šodğ
fio
->
·ge
->
m­pšg
->
ho¡
;

2621 ià(
	`S_ISDIR
(
šode
->
i_mode
))

2622  
CURSEG_HOT_DATA
;

2624  
CURSEG_COLD_DATA
;

2626 ià(
	`IS_DNODE
(
fio
->
·ge
è&& 
	`is_cŞd_node
(fio->page))

2627  
CURSEG_WARM_NODE
;

2629  
CURSEG_COLD_NODE
;

2631 
	}
}

2633 
	$__g‘_£gm’t_ty³_6
(
f2fs_io_šfo
 *
fio
)

2635 ià(
fio
->
ty³
 =ğ
DATA
) {

2636 
šode
 *šodğ
fio
->
·ge
->
m­pšg
->
ho¡
;

2638 ià(
	`is_cŞd_d©a
(
fio
->
·ge
è|| 
	`fe_is_cŞd
(
šode
))

2639  
CURSEG_COLD_DATA
;

2640 ià(
	`fe_is_hÙ
(
šode
) ||

2641 
	`is_šode_æag_£t
(
šode
, 
FI_HOT_DATA
) ||

2642 
	`is_šode_æag_£t
(
šode
, 
FI_ATOMIC_FILE
) ||

2643 
	`is_šode_æag_£t
(
šode
, 
FI_VOLATILE_FILE
))

2644  
CURSEG_HOT_DATA
;

2645  
	`f2fs_rw_hšt_to_£g_ty³
(
šode
->
i_wr™e_hšt
);

2647 ià(
	`IS_DNODE
(
fio
->
·ge
))

2648  
	`is_cŞd_node
(
fio
->
·ge
è? 
CURSEG_WARM_NODE
 :

2649 
CURSEG_HOT_NODE
;

2650  
CURSEG_COLD_NODE
;

2652 
	}
}

2654 
	$__g‘_£gm’t_ty³
(
f2fs_io_šfo
 *
fio
)

2656 
ty³
 = 0;

2658 
	`F2FS_OPTION
(
fio
->
sbi
).
aùive_logs
) {

2660 
ty³
 = 
	`__g‘_£gm’t_ty³_2
(
fio
);

2663 
ty³
 = 
	`__g‘_£gm’t_ty³_4
(
fio
);

2666 
ty³
 = 
	`__g‘_£gm’t_ty³_6
(
fio
);

2669 
	`f2fs_bug_Ú
(
fio
->
sbi
, 
Œue
);

2672 ià(
	`IS_HOT
(
ty³
))

2673 
fio
->
‹mp
 = 
HOT
;

2674 ià(
	`IS_WARM
(
ty³
))

2675 
fio
->
‹mp
 = 
WARM
;

2677 
fio
->
‹mp
 = 
COLD
;

2678  
ty³
;

2679 
	}
}

2681 
	$f2fs_®loÿ‹_d©a_block
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

2682 
block_t
 
Şd_blkaddr
, block_ˆ*
Ãw_blkaddr
,

2683 
f2fs_summ¬y
 *
sum
, 
ty³
,

2684 
f2fs_io_šfo
 *
fio
, 
boŞ
 
add_li¡
)

2686 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

2687 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2689 
	`down_»ad
(&
	`SM_I
(
sbi
)->
cur£g_lock
);

2691 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

2692 
	`down_wr™e
(&
s™_i
->
£Áry_lock
);

2694 *
Ãw_blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
);

2696 
	`f2fs_wa™_disÿrd_bio
(
sbi
, *
Ãw_blkaddr
);

2703 
	`__add_sum_’Œy
(
sbi
, 
ty³
, 
sum
);

2705 
	`__»äesh_Ãxt_blkoff
(
sbi
, 
cur£g
);

2707 
	`¡©_šc_block_couÁ
(
sbi
, 
cur£g
);

2713 
	`upd©e_s™_’Œy
(
sbi
, *
Ãw_blkaddr
, 1);

2714 ià(
	`GET_SEGNO
(
sbi
, 
Şd_blkaddr
è!ğ
NULL_SEGNO
)

2715 
	`upd©e_s™_’Œy
(
sbi
, 
Şd_blkaddr
, -1);

2717 ià(!
	`__has_cur£g_¥aû
(
sbi
, 
ty³
))

2718 
s™_i
->
s_İs
->
	`®loÿ‹_£gm’t
(
sbi
, 
ty³
, 
çl£
);

2725 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
	`GET_SEGNO
(sbi, 
Şd_blkaddr
));

2726 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
	`GET_SEGNO
(sbi, *
Ãw_blkaddr
));

2728 
	`up_wr™e
(&
s™_i
->
£Áry_lock
);

2730 ià(
·ge
 && 
	`IS_NODESEG
(
ty³
)) {

2731 
	`fl_node_foÙ”_blkaddr
(
·ge
, 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
));

2733 
	`f2fs_šode_chksum_£t
(
sbi
, 
·ge
);

2736 ià(
add_li¡
) {

2737 
f2fs_bio_šfo
 *
io
;

2739 
	`INIT_LIST_HEAD
(&
fio
->
li¡
);

2740 
fio
->
š_li¡
 = 
Œue
;

2741 
fio
->
»Œy
 = 
çl£
;

2742 
io
 = 
sbi
->
wr™e_io
[
fio
->
ty³
] + fio->
‹mp
;

2743 
	`¥š_lock
(&
io
->
io_lock
);

2744 
	`li¡_add_
(&
fio
->
li¡
, &
io
->
io_li¡
);

2745 
	`¥š_uÆock
(&
io
->
io_lock
);

2748 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

2750 
	`up_»ad
(&
	`SM_I
(
sbi
)->
cur£g_lock
);

2751 
	}
}

2753 
	$upd©e_deviû_¡©e
(
f2fs_io_šfo
 *
fio
)

2755 
f2fs_sb_šfo
 *
sbi
 = 
fio
->sbi;

2756 
devidx
;

2758 ià(!
sbi
->
s_ndevs
)

2761 
devidx
 = 
	`f2fs_rg‘_deviû_šdex
(
sbi
, 
fio
->
Ãw_blkaddr
);

2764 
	`f2fs_£t_dœty_deviû
(
sbi
, 
fio
->
šo
, 
devidx
, 
FLUSH_INO
);

2767 ià(!
	`f2fs_‹¡_b™
(
devidx
, (*)&
sbi
->
dœty_deviû
)) {

2768 
	`¥š_lock
(&
sbi
->
dev_lock
);

2769 
	`f2fs_£t_b™
(
devidx
, (*)&
sbi
->
dœty_deviû
);

2770 
	`¥š_uÆock
(&
sbi
->
dev_lock
);

2772 
	}
}

2774 
	$do_wr™e_·ge
(
f2fs_summ¬y
 *
sum
, 
f2fs_io_šfo
 *
fio
)

2776 
ty³
 = 
	`__g‘_£gm’t_ty³
(
fio
);

2777 
boŞ
 
k“p_Üd”
 = (
	`‹¡_İt
(
fio
->
sbi
, 
LFS
è&& 
ty³
 =ğ
CURSEG_COLD_DATA
);

2779 ià(
k“p_Üd”
)

2780 
	`down_»ad
(&
fio
->
sbi
->
io_Üd”_lock
);

2781 
»®loÿ‹
:

2782 
	`f2fs_®loÿ‹_d©a_block
(
fio
->
sbi
, fio->
·ge
, fio->
Şd_blkaddr
,

2783 &
fio
->
Ãw_blkaddr
, 
sum
, 
ty³
, fio, 
Œue
);

2786 
	`f2fs_subm™_·ge_wr™e
(
fio
);

2787 ià(
fio
->
»Œy
) {

2788 
fio
->
Şd_blkaddr
 = fio->
Ãw_blkaddr
;

2789 
»®loÿ‹
;

2792 
	`upd©e_deviû_¡©e
(
fio
);

2794 ià(
k“p_Üd”
)

2795 
	`up_»ad
(&
fio
->
sbi
->
io_Üd”_lock
);

2796 
	}
}

2798 
	$f2fs_do_wr™e_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

2799 
io¡©_ty³
 
io_ty³
)

2801 
f2fs_io_šfo
 
fio
 = {

2802 .
sbi
 = sbi,

2803 .
ty³
 = 
META
,

2804 .
‹mp
 = 
HOT
,

2805 .
İ
 = 
REQ_OP_WRITE
,

2806 .
İ_æags
 = 
REQ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
,

2807 .
Şd_blkaddr
 = 
·ge
->
šdex
,

2808 .
Ãw_blkaddr
 = 
·ge
->
šdex
,

2809 .
·ge
 =…age,

2810 .
’üy±ed_·ge
 = 
NULL
,

2811 .
š_li¡
 = 
çl£
,

2814 ià(
	`uÆik–y
(
·ge
->
šdex
 >ğ
	`MAIN_BLKADDR
(
sbi
)))

2815 
fio
.
İ_æags
 &ğ~
REQ_META
;

2817 
	`£t_·ge_wr™eback
(
·ge
);

2818 
	`CË¬PageE¼Ü
(
·ge
);

2819 
	`f2fs_subm™_·ge_wr™e
(&
fio
);

2821 
	`f2fs_upd©e_io¡©
(
sbi
, 
io_ty³
, 
F2FS_BLKSIZE
);

2822 
	}
}

2824 
	$f2fs_do_wr™e_node_·ge
(
nid
, 
f2fs_io_šfo
 *
fio
)

2826 
f2fs_summ¬y
 
sum
;

2828 
	`£t_summ¬y
(&
sum
, 
nid
, 0, 0);

2829 
	`do_wr™e_·ge
(&
sum
, 
fio
);

2831 
	`f2fs_upd©e_io¡©
(
fio
->
sbi
, fio->
io_ty³
, 
F2FS_BLKSIZE
);

2832 
	}
}

2834 
	$f2fs_ouÏû_wr™e_d©a
(
dnode_of_d©a
 *
dn
,

2835 
f2fs_io_šfo
 *
fio
)

2837 
f2fs_sb_šfo
 *
sbi
 = 
fio
->sbi;

2838 
f2fs_summ¬y
 
sum
;

2839 
node_šfo
 
ni
;

2841 
	`f2fs_bug_Ú
(
sbi
, 
dn
->
d©a_blkaddr
 =ğ
NULL_ADDR
);

2842 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
->
nid
, &
ni
);

2843 
	`£t_summ¬y
(&
sum
, 
dn
->
nid
, dn->
ofs_š_node
, 
ni
.
v”siÚ
);

2844 
	`do_wr™e_·ge
(&
sum
, 
fio
);

2845 
	`f2fs_upd©e_d©a_blkaddr
(
dn
, 
fio
->
Ãw_blkaddr
);

2847 
	`f2fs_upd©e_io¡©
(
sbi
, 
fio
->
io_ty³
, 
F2FS_BLKSIZE
);

2848 
	}
}

2850 
	$f2fs_š¶aû_wr™e_d©a
(
f2fs_io_šfo
 *
fio
)

2852 
”r
;

2853 
f2fs_sb_šfo
 *
sbi
 = 
fio
->sbi;

2855 
fio
->
Ãw_blkaddr
 = fio->
Şd_blkaddr
;

2857 
	`__g‘_£gm’t_ty³
(
fio
);

2859 
	`f2fs_bug_Ú
(
sbi
, !
	`IS_DATASEG
(
	`g‘_£g_’Œy
(sbi,

2860 
	`GET_SEGNO
(
sbi
, 
fio
->
Ãw_blkaddr
))->
ty³
));

2862 
	`¡©_šc_š¶aû_blocks
(
fio
->
sbi
);

2864 
”r
 = 
	`f2fs_subm™_·ge_bio
(
fio
);

2865 ià(!
”r
)

2866 
	`upd©e_deviû_¡©e
(
fio
);

2868 
	`f2fs_upd©e_io¡©
(
fio
->
sbi
, fio->
io_ty³
, 
F2FS_BLKSIZE
);

2870  
”r
;

2871 
	}
}

2873 
šlše
 
	$__f2fs_g‘_cur£g
(
f2fs_sb_šfo
 *
sbi
,

2874 
£gno
)

2876 
i
;

2878 
i
 = 
CURSEG_HOT_DATA
; i < 
NO_CHECK_TYPE
; i++) {

2879 ià(
	`CURSEG_I
(
sbi
, 
i
)->
£gno
 == segno)

2882  
i
;

2883 
	}
}

2885 
	$f2fs_do_»¶aû_block
(
f2fs_sb_šfo
 *
sbi
, 
f2fs_summ¬y
 *
sum
,

2886 
block_t
 
Şd_blkaddr
, block_ˆ
Ãw_blkaddr
,

2887 
boŞ
 
»cov”_cur£g
, boŞ 
»cov”_Ãwaddr
)

2889 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

2890 
cur£g_šfo
 *
cur£g
;

2891 
£gno
, 
Şd_cur£gno
;

2892 
£g_’Œy
 *
£
;

2893 
ty³
;

2894 
Şd_blkoff
;

2896 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
Ãw_blkaddr
);

2897 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

2898 
ty³
 = 
£
->type;

2900 
	`down_wr™e
(&
	`SM_I
(
sbi
)->
cur£g_lock
);

2902 ià(!
»cov”_cur£g
) {

2904 ià(
£
->
v®id_blocks
 =ğ0 && !
	`IS_CURSEG
(
sbi
, 
£gno
)) {

2905 ià(
Şd_blkaddr
 =ğ
NULL_ADDR
)

2906 
ty³
 = 
CURSEG_COLD_DATA
;

2908 
ty³
 = 
CURSEG_WARM_DATA
;

2911 ià(
	`IS_CURSEG
(
sbi
, 
£gno
)) {

2913 
ty³
 = 
	`__f2fs_g‘_cur£g
(
sbi
, 
£gno
);

2914 
	`f2fs_bug_Ú
(
sbi
, 
ty³
 =ğ
NO_CHECK_TYPE
);

2916 
ty³
 = 
CURSEG_WARM_DATA
;

2920 
	`f2fs_bug_Ú
(
sbi
, !
	`IS_DATASEG
(
ty³
));

2921 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2923 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

2924 
	`down_wr™e
(&
s™_i
->
£Áry_lock
);

2926 
Şd_cur£gno
 = 
cur£g
->
£gno
;

2927 
Şd_blkoff
 = 
cur£g
->
Ãxt_blkoff
;

2930 ià(
£gno
 !ğ
cur£g
->segno) {

2931 
cur£g
->
Ãxt_£gno
 = 
£gno
;

2932 
	`chªge_cur£g
(
sbi
, 
ty³
);

2935 
cur£g
->
Ãxt_blkoff
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
Ãw_blkaddr
);

2936 
	`__add_sum_’Œy
(
sbi
, 
ty³
, 
sum
);

2938 ià(!
»cov”_cur£g
 || 
»cov”_Ãwaddr
)

2939 
	`upd©e_s™_’Œy
(
sbi
, 
Ãw_blkaddr
, 1);

2940 ià(
	`GET_SEGNO
(
sbi
, 
Şd_blkaddr
è!ğ
NULL_SEGNO
)

2941 
	`upd©e_s™_’Œy
(
sbi
, 
Şd_blkaddr
, -1);

2943 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
	`GET_SEGNO
(sbi, 
Şd_blkaddr
));

2944 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
	`GET_SEGNO
(sbi, 
Ãw_blkaddr
));

2946 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
Şd_cur£gno
);

2948 ià(
»cov”_cur£g
) {

2949 ià(
Şd_cur£gno
 !ğ
cur£g
->
£gno
) {

2950 
cur£g
->
Ãxt_£gno
 = 
Şd_cur£gno
;

2951 
	`chªge_cur£g
(
sbi
, 
ty³
);

2953 
cur£g
->
Ãxt_blkoff
 = 
Şd_blkoff
;

2956 
	`up_wr™e
(&
s™_i
->
£Áry_lock
);

2957 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

2958 
	`up_wr™e
(&
	`SM_I
(
sbi
)->
cur£g_lock
);

2959 
	}
}

2961 
	$f2fs_»¶aû_block
(
f2fs_sb_šfo
 *
sbi
, 
dnode_of_d©a
 *
dn
,

2962 
block_t
 
Şd_addr
, block_ˆ
Ãw_addr
,

2963 
v”siÚ
, 
boŞ
 
»cov”_cur£g
,

2964 
boŞ
 
»cov”_Ãwaddr
)

2966 
f2fs_summ¬y
 
sum
;

2968 
	`£t_summ¬y
(&
sum
, 
dn
->
nid
, dn->
ofs_š_node
, 
v”siÚ
);

2970 
	`f2fs_do_»¶aû_block
(
sbi
, &
sum
, 
Şd_addr
, 
Ãw_addr
,

2971 
»cov”_cur£g
, 
»cov”_Ãwaddr
);

2973 
	`f2fs_upd©e_d©a_blkaddr
(
dn
, 
Ãw_addr
);

2974 
	}
}

2976 
	$f2fs_wa™_Ú_·ge_wr™eback
(
·ge
 *page,

2977 
·ge_ty³
 
ty³
, 
boŞ
 
Üd”ed
)

2979 ià(
	`PageWr™eback
(
·ge
)) {

2980 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

2982 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
sbi
, 
·ge
->
m­pšg
->
ho¡
,

2983 0, 
·ge
->
šdex
, 
ty³
);

2984 ià(
Üd”ed
)

2985 
	`wa™_Ú_·ge_wr™eback
(
·ge
);

2987 
	`wa™_fÜ_¡abË_·ge
(
·ge
);

2989 
	}
}

2991 
	$f2fs_wa™_Ú_block_wr™eback
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
)

2993 
·ge
 *
ıage
;

2995 ià(!
	`is_v®id_blkaddr
(
blkaddr
))

2998 
ıage
 = 
	`fšd_lock_·ge
(
	`META_MAPPING
(
sbi
), 
blkaddr
);

2999 ià(
ıage
) {

3000 
	`f2fs_wa™_Ú_·ge_wr™eback
(
ıage
, 
DATA
, 
Œue
);

3001 
	`f2fs_put_·ge
(
ıage
, 1);

3003 
	}
}

3005 
	$»ad_com·ùed_summ¬›s
(
f2fs_sb_šfo
 *
sbi
)

3007 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

3008 
cur£g_šfo
 *
£g_i
;

3009 *
kaddr
;

3010 
·ge
 *page;

3011 
block_t
 
¡¬t
;

3012 
i
, 
j
, 
off£t
;

3014 
¡¬t
 = 
	`¡¬t_sum_block
(
sbi
);

3016 
·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
¡¬t
++);

3017 
kaddr
 = (*)
	`·ge_add»ss
(
·ge
);

3020 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

3021 
	`memıy
(
£g_i
->
jouº®
, 
kaddr
, 
SUM_JOURNAL_SIZE
);

3024 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

3025 
	`memıy
(
£g_i
->
jouº®
, 
kaddr
 + 
SUM_JOURNAL_SIZE
, SUM_JOURNAL_SIZE);

3026 
off£t
 = 2 * 
SUM_JOURNAL_SIZE
;

3029 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

3030 
blk_off
;

3031 
£gno
;

3033 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
i
);

3034 
£gno
 = 
	`Ë32_to_ıu
(
ck±
->
cur_d©a_£gno
[
i
]);

3035 
blk_off
 = 
	`Ë16_to_ıu
(
ck±
->
cur_d©a_blkoff
[
i
]);

3036 
£g_i
->
Ãxt_£gno
 = 
£gno
;

3037 
	`»£t_cur£g
(
sbi
, 
i
, 0);

3038 
£g_i
->
®loc_ty³
 = 
ck±
->®loc_ty³[
i
];

3039 
£g_i
->
Ãxt_blkoff
 = 
blk_off
;

3041 ià(
£g_i
->
®loc_ty³
 =ğ
SSR
)

3042 
blk_off
 = 
sbi
->
blocks_³r_£g
;

3044 
j
 = 0; j < 
blk_off
; j++) {

3045 
f2fs_summ¬y
 *
s
;

3046 
s
 = (
f2fs_summ¬y
 *)(
kaddr
 + 
off£t
);

3047 
£g_i
->
sum_blk
->
’Œ›s
[
j
] = *
s
;

3048 
off£t
 +ğ
SUMMARY_SIZE
;

3049 ià(
off£t
 + 
SUMMARY_SIZE
 <ğ
PAGE_SIZE
 -

3050 
SUM_FOOTER_SIZE
)

3053 
	`f2fs_put_·ge
(
·ge
, 1);

3054 
·ge
 = 
NULL
;

3056 
·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
¡¬t
++);

3057 
kaddr
 = (*)
	`·ge_add»ss
(
·ge
);

3058 
off£t
 = 0;

3061 
	`f2fs_put_·ge
(
·ge
, 1);

3062 
	}
}

3064 
	$»ad_nÜm®_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

3066 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

3067 
f2fs_summ¬y_block
 *
sum
;

3068 
cur£g_šfo
 *
cur£g
;

3069 
·ge
 *
Ãw
;

3070 
blk_off
;

3071 
£gno
 = 0;

3072 
block_t
 
blk_addr
 = 0;

3075 ià(
	`IS_DATASEG
(
ty³
)) {

3076 
£gno
 = 
	`Ë32_to_ıu
(
ck±
->
cur_d©a_£gno
[
ty³
]);

3077 
blk_off
 = 
	`Ë16_to_ıu
(
ck±
->
cur_d©a_blkoff
[
ty³
 -

3078 
CURSEG_HOT_DATA
]);

3079 ià(
	`__exi¡_node_summ¬›s
(
sbi
))

3080 
blk_addr
 = 
	`sum_blk_addr
(
sbi
, 
NR_CURSEG_TYPE
, 
ty³
);

3082 
blk_addr
 = 
	`sum_blk_addr
(
sbi
, 
NR_CURSEG_DATA_TYPE
, 
ty³
);

3084 
£gno
 = 
	`Ë32_to_ıu
(
ck±
->
cur_node_£gno
[
ty³
 -

3085 
CURSEG_HOT_NODE
]);

3086 
blk_off
 = 
	`Ë16_to_ıu
(
ck±
->
cur_node_blkoff
[
ty³
 -

3087 
CURSEG_HOT_NODE
]);

3088 ià(
	`__exi¡_node_summ¬›s
(
sbi
))

3089 
blk_addr
 = 
	`sum_blk_addr
(
sbi
, 
NR_CURSEG_NODE_TYPE
,

3090 
ty³
 - 
CURSEG_HOT_NODE
);

3092 
blk_addr
 = 
	`GET_SUM_BLOCK
(
sbi
, 
£gno
);

3095 
Ãw
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
blk_addr
);

3096 
sum
 = (
f2fs_summ¬y_block
 *)
	`·ge_add»ss
(
Ãw
);

3098 ià(
	`IS_NODESEG
(
ty³
)) {

3099 ià(
	`__exi¡_node_summ¬›s
(
sbi
)) {

3100 
f2fs_summ¬y
 *
ns
 = &
sum
->
’Œ›s
[0];

3101 
i
;

3102 
i
 = 0; i < 
sbi
->
blocks_³r_£g
; i++, 
ns
++) {

3103 
ns
->
v”siÚ
 = 0;

3104 
ns
->
ofs_š_node
 = 0;

3107 
	`f2fs_»¡Üe_node_summ¬y
(
sbi
, 
£gno
, 
sum
);

3112 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

3113 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

3116 
	`down_wr™e
(&
cur£g
->
jouº®_rw£m
);

3117 
	`memıy
(
cur£g
->
jouº®
, &
sum
->jouº®, 
SUM_JOURNAL_SIZE
);

3118 
	`up_wr™e
(&
cur£g
->
jouº®_rw£m
);

3120 
	`memıy
(
cur£g
->
sum_blk
->
’Œ›s
, 
sum
->’Œ›s, 
SUM_ENTRY_SIZE
);

3121 
	`memıy
(&
cur£g
->
sum_blk
->
foÙ”
, &
sum
->foÙ”, 
SUM_FOOTER_SIZE
);

3122 
cur£g
->
Ãxt_£gno
 = 
£gno
;

3123 
	`»£t_cur£g
(
sbi
, 
ty³
, 0);

3124 
cur£g
->
®loc_ty³
 = 
ck±
->®loc_ty³[
ty³
];

3125 
cur£g
->
Ãxt_blkoff
 = 
blk_off
;

3126 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

3127 
	`f2fs_put_·ge
(
Ãw
, 1);

3129 
	}
}

3131 
	$»¡Üe_cur£g_summ¬›s
(
f2fs_sb_šfo
 *
sbi
)

3133 
f2fs_jouº®
 *
s™_j
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
)->
jouº®
;

3134 
f2fs_jouº®
 *
Çt_j
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
)->
jouº®
;

3135 
ty³
 = 
CURSEG_HOT_DATA
;

3136 
”r
;

3138 ià(
	`is_£t_ck±_æags
(
sbi
, 
CP_COMPACT_SUM_FLAG
)) {

3139 
Åages
 = 
	`f2fs_Åages_fÜ_summ¬y_æush
(
sbi
, 
Œue
);

3141 ià(
Åages
 >= 2)

3142 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`¡¬t_sum_block
(sbi), 
Åages
,

3143 
META_CP
, 
Œue
);

3146 
	`»ad_com·ùed_summ¬›s
(
sbi
);

3147 
ty³
 = 
CURSEG_HOT_NODE
;

3150 ià(
	`__exi¡_node_summ¬›s
(
sbi
))

3151 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`sum_blk_addr
(sbi, 
NR_CURSEG_TYPE
, 
ty³
),

3152 
NR_CURSEG_TYPE
 - 
ty³
, 
META_CP
, 
Œue
);

3154 ; 
ty³
 <ğ
CURSEG_COLD_NODE
;ype++) {

3155 
”r
 = 
	`»ad_nÜm®_summ¬›s
(
sbi
, 
ty³
);

3156 ià(
”r
)

3157  
”r
;

3161 ià(
	`Çts_š_cursum
(
Çt_j
è> 
NAT_JOURNAL_ENTRIES
 ||

3162 
	`s™s_š_cursum
(
s™_j
è> 
SIT_JOURNAL_ENTRIES
)

3163  -
EINVAL
;

3166 
	}
}

3168 
	$wr™e_com·ùed_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
)

3170 
·ge
 *page;

3171 *
kaddr
;

3172 
f2fs_summ¬y
 *
summ¬y
;

3173 
cur£g_šfo
 *
£g_i
;

3174 
wr™‹n_size
 = 0;

3175 
i
, 
j
;

3177 
·ge
 = 
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
blkaddr
++);

3178 
kaddr
 = (*)
	`·ge_add»ss
(
·ge
);

3179 
	`mem£t
(
kaddr
, 0, 
PAGE_SIZE
);

3182 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

3183 
	`memıy
(
kaddr
, 
£g_i
->
jouº®
, 
SUM_JOURNAL_SIZE
);

3184 
wr™‹n_size
 +ğ
SUM_JOURNAL_SIZE
;

3187 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

3188 
	`memıy
(
kaddr
 + 
wr™‹n_size
, 
£g_i
->
jouº®
, 
SUM_JOURNAL_SIZE
);

3189 
wr™‹n_size
 +ğ
SUM_JOURNAL_SIZE
;

3192 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

3193 
blkoff
;

3194 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
i
);

3195 ià(
sbi
->
ck±
->
®loc_ty³
[
i
] =ğ
SSR
)

3196 
blkoff
 = 
sbi
->
blocks_³r_£g
;

3198 
blkoff
 = 
	`cur£g_blkoff
(
sbi
, 
i
);

3200 
j
 = 0; j < 
blkoff
; j++) {

3201 ià(!
·ge
) {

3202 
·ge
 = 
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
blkaddr
++);

3203 
kaddr
 = (*)
	`·ge_add»ss
(
·ge
);

3204 
	`mem£t
(
kaddr
, 0, 
PAGE_SIZE
);

3205 
wr™‹n_size
 = 0;

3207 
summ¬y
 = (
f2fs_summ¬y
 *)(
kaddr
 + 
wr™‹n_size
);

3208 *
summ¬y
 = 
£g_i
->
sum_blk
->
’Œ›s
[
j
];

3209 
wr™‹n_size
 +ğ
SUMMARY_SIZE
;

3211 ià(
wr™‹n_size
 + 
SUMMARY_SIZE
 <ğ
PAGE_SIZE
 -

3212 
SUM_FOOTER_SIZE
)

3215 
	`£t_·ge_dœty
(
·ge
);

3216 
	`f2fs_put_·ge
(
·ge
, 1);

3217 
·ge
 = 
NULL
;

3220 ià(
·ge
) {

3221 
	`£t_·ge_dœty
(
·ge
);

3222 
	`f2fs_put_·ge
(
·ge
, 1);

3224 
	}
}

3226 
	$wr™e_nÜm®_summ¬›s
(
f2fs_sb_šfo
 *
sbi
,

3227 
block_t
 
blkaddr
, 
ty³
)

3229 
i
, 
’d
;

3230 ià(
	`IS_DATASEG
(
ty³
))

3231 
’d
 = 
ty³
 + 
NR_CURSEG_DATA_TYPE
;

3233 
’d
 = 
ty³
 + 
NR_CURSEG_NODE_TYPE
;

3235 
i
 = 
ty³
; i < 
’d
; i++)

3236 
	`wr™e_cu¼’t_sum_·ge
(
sbi
, 
i
, 
blkaddr
 + (˜- 
ty³
));

3237 
	}
}

3239 
	$f2fs_wr™e_d©a_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
)

3241 ià(
	`is_£t_ck±_æags
(
sbi
, 
CP_COMPACT_SUM_FLAG
))

3242 
	`wr™e_com·ùed_summ¬›s
(
sbi
, 
¡¬t_blk
);

3244 
	`wr™e_nÜm®_summ¬›s
(
sbi
, 
¡¬t_blk
, 
CURSEG_HOT_DATA
);

3245 
	}
}

3247 
	$f2fs_wr™e_node_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
)

3249 
	`wr™e_nÜm®_summ¬›s
(
sbi
, 
¡¬t_blk
, 
CURSEG_HOT_NODE
);

3250 
	}
}

3252 
	$f2fs_lookup_jouº®_š_cursum
(
f2fs_jouº®
 *
jouº®
, 
ty³
,

3253 
v®
, 
®loc
)

3255 
i
;

3257 ià(
ty³
 =ğ
NAT_JOURNAL
) {

3258 
i
 = 0; i < 
	`Çts_š_cursum
(
jouº®
); i++) {

3259 ià(
	`Ë32_to_ıu
(
	`nid_š_jouº®
(
jouº®
, 
i
)è=ğ
v®
)

3260  
i
;

3262 ià(
®loc
 && 
	`__has_cursum_¥aû
(
jouº®
, 1, 
NAT_JOURNAL
))

3263  
	`upd©e_Çts_š_cursum
(
jouº®
, 1);

3264 } ià(
ty³
 =ğ
SIT_JOURNAL
) {

3265 
i
 = 0; i < 
	`s™s_š_cursum
(
jouº®
); i++)

3266 ià(
	`Ë32_to_ıu
(
	`£gno_š_jouº®
(
jouº®
, 
i
)è=ğ
v®
)

3267  
i
;

3268 ià(
®loc
 && 
	`__has_cursum_¥aû
(
jouº®
, 1, 
SIT_JOURNAL
))

3269  
	`upd©e_s™s_š_cursum
(
jouº®
, 1);

3272 
	}
}

3274 
·ge
 *
	$g‘_cu¼’t_s™_·ge
(
f2fs_sb_šfo
 *
sbi
,

3275 
£gno
)

3277  
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
	`cu¼’t_s™_addr
(sbi, 
£gno
));

3278 
	}
}

3280 
·ge
 *
	$g‘_Ãxt_s™_·ge
(
f2fs_sb_šfo
 *
sbi
,

3281 
¡¬t
)

3283 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

3284 
·ge
 *page;

3285 
pgoff_t
 
¤c_off
, 
d¡_off
;

3287 
¤c_off
 = 
	`cu¼’t_s™_addr
(
sbi
, 
¡¬t
);

3288 
d¡_off
 = 
	`Ãxt_s™_addr
(
sbi
, 
¤c_off
);

3290 
·ge
 = 
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
d¡_off
);

3291 
	`£g_šfo_to_s™_·ge
(
sbi
, 
·ge
, 
¡¬t
);

3293 
	`£t_·ge_dœty
(
·ge
);

3294 
	`£t_to_Ãxt_s™
(
s™_i
, 
¡¬t
);

3296  
·ge
;

3297 
	}
}

3299 
s™_’Œy_£t
 *
	$g¿b_s™_’Œy_£t
()

3301 
s™_’Œy_£t
 *
£s
 =

3302 
	`f2fs_kmem_ÿche_®loc
(
s™_’Œy_£t_¦ab
, 
GFP_NOFS
);

3304 
£s
->
’Œy_út
 = 0;

3305 
	`INIT_LIST_HEAD
(&
£s
->
£t_li¡
);

3306  
£s
;

3307 
	}
}

3309 
	$»Ëa£_s™_’Œy_£t
(
s™_’Œy_£t
 *
£s
)

3311 
	`li¡_d–
(&
£s
->
£t_li¡
);

3312 
	`kmem_ÿche_ä“
(
s™_’Œy_£t_¦ab
, 
£s
);

3313 
	}
}

3315 
	$adju¡_s™_’Œy_£t
(
s™_’Œy_£t
 *
£s
,

3316 
li¡_h—d
 *
h—d
)

3318 
s™_’Œy_£t
 *
Ãxt
 = 
£s
;

3320 ià(
	`li¡_is_Ï¡
(&
£s
->
£t_li¡
, 
h—d
))

3323 
	`li¡_fÜ_—ch_’Œy_cÚtšue
(
Ãxt
, 
h—d
, 
£t_li¡
)

3324 ià(
£s
->
’Œy_út
 <ğ
Ãxt
->entry_cnt)

3327 
	`li¡_move_
(&
£s
->
£t_li¡
, &
Ãxt
->set_list);

3328 
	}
}

3330 
	$add_s™_’Œy
(
£gno
, 
li¡_h—d
 *
h—d
)

3332 
s™_’Œy_£t
 *
£s
;

3333 
¡¬t_£gno
 = 
	`START_SEGNO
(
£gno
);

3335 
	`li¡_fÜ_—ch_’Œy
(
£s
, 
h—d
, 
£t_li¡
) {

3336 ià(
£s
->
¡¬t_£gno
 == start_segno) {

3337 
£s
->
’Œy_út
++;

3338 
	`adju¡_s™_’Œy_£t
(
£s
, 
h—d
);

3343 
£s
 = 
	`g¿b_s™_’Œy_£t
();

3345 
£s
->
¡¬t_£gno
 = start_segno;

3346 
£s
->
’Œy_út
++;

3347 
	`li¡_add
(&
£s
->
£t_li¡
, 
h—d
);

3348 
	}
}

3350 
	$add_s™s_š_£t
(
f2fs_sb_šfo
 *
sbi
)

3352 
f2fs_sm_šfo
 *
sm_šfo
 = 
	`SM_I
(
sbi
);

3353 
li¡_h—d
 *
£t_li¡
 = &
sm_šfo
->
s™_’Œy_£t
;

3354 *
b™m­
 = 
	`SIT_I
(
sbi
)->
dœty_£Ár›s_b™m­
;

3355 
£gno
;

3357 
	`fÜ_—ch_£t_b™
(
£gno
, 
b™m­
, 
	`MAIN_SEGS
(
sbi
))

3358 
	`add_s™_’Œy
(
£gno
, 
£t_li¡
);

3359 
	}
}

3361 
	$»move_s™s_š_jouº®
(
f2fs_sb_šfo
 *
sbi
)

3363 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

3364 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

3365 
i
;

3367 
	`down_wr™e
(&
cur£g
->
jouº®_rw£m
);

3368 
i
 = 0; i < 
	`s™s_š_cursum
(
jouº®
); i++) {

3369 
£gno
;

3370 
boŞ
 
dœt›d
;

3372 
£gno
 = 
	`Ë32_to_ıu
(
	`£gno_š_jouº®
(
jouº®
, 
i
));

3373 
dœt›d
 = 
	`__m¬k_s™_’Œy_dœty
(
sbi
, 
£gno
);

3375 ià(!
dœt›d
)

3376 
	`add_s™_’Œy
(
£gno
, &
	`SM_I
(
sbi
)->
s™_’Œy_£t
);

3378 
	`upd©e_s™s_š_cursum
(
jouº®
, -
i
);

3379 
	`up_wr™e
(&
cur£g
->
jouº®_rw£m
);

3380 
	}
}

3386 
	$f2fs_æush_s™_’Œ›s
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

3388 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

3389 *
b™m­
 = 
s™_i
->
dœty_£Ár›s_b™m­
;

3390 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

3391 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

3392 
s™_’Œy_£t
 *
£s
, *
tmp
;

3393 
li¡_h—d
 *
h—d
 = &
	`SM_I
(
sbi
)->
s™_’Œy_£t
;

3394 
boŞ
 
to_jouº®
 = 
Œue
;

3395 
£g_’Œy
 *
£
;

3397 
	`down_wr™e
(&
s™_i
->
£Áry_lock
);

3399 ià(!
s™_i
->
dœty_£Ár›s
)

3400 
out
;

3406 
	`add_s™s_š_£t
(
sbi
);

3413 ià(!
	`__has_cursum_¥aû
(
jouº®
, 
s™_i
->
dœty_£Ár›s
, 
SIT_JOURNAL
))

3414 
	`»move_s™s_š_jouº®
(
sbi
);

3421 
	`li¡_fÜ_—ch_’Œy_§ã
(
£s
, 
tmp
, 
h—d
, 
£t_li¡
) {

3422 
·ge
 *·gğ
NULL
;

3423 
f2fs_s™_block
 *
¿w_s™
 = 
NULL
;

3424 
¡¬t_£gno
 = 
£s
->start_segno;

3425 
’d
 = 
	`mš
(
¡¬t_£gno
 + 
SIT_ENTRY_PER_BLOCK
,

3426 ()
	`MAIN_SEGS
(
sbi
));

3427 
£gno
 = 
¡¬t_£gno
;

3429 ià(
to_jouº®
 &&

3430 !
	`__has_cursum_¥aû
(
jouº®
, 
£s
->
’Œy_út
, 
SIT_JOURNAL
))

3431 
to_jouº®
 = 
çl£
;

3433 ià(
to_jouº®
) {

3434 
	`down_wr™e
(&
cur£g
->
jouº®_rw£m
);

3436 
·ge
 = 
	`g‘_Ãxt_s™_·ge
(
sbi
, 
¡¬t_£gno
);

3437 
¿w_s™
 = 
	`·ge_add»ss
(
·ge
);

3441 
	`fÜ_—ch_£t_b™_äom
(
£gno
, 
b™m­
, 
’d
) {

3442 
off£t
, 
s™_off£t
;

3444 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

3445 #ifdeà
CONFIG_F2FS_CHECK_FS


3446 ià(
	`memcmp
(
£
->
cur_v®id_m­
, se->
cur_v®id_m­_mœ
,

3447 
SIT_VBLOCK_MAP_SIZE
))

3448 
	`f2fs_bug_Ú
(
sbi
, 1);

3452 ià(!(
ıc
->
»asÚ
 & 
CP_DISCARD
)) {

3453 
ıc
->
Œim_¡¬t
 = 
£gno
;

3454 
	`add_disÿrd_addrs
(
sbi
, 
ıc
, 
çl£
);

3457 ià(
to_jouº®
) {

3458 
off£t
 = 
	`f2fs_lookup_jouº®_š_cursum
(
jouº®
,

3459 
SIT_JOURNAL
, 
£gno
, 1);

3460 
	`f2fs_bug_Ú
(
sbi
, 
off£t
 < 0);

3461 
	`£gno_š_jouº®
(
jouº®
, 
off£t
) =

3462 
	`ıu_to_Ë32
(
£gno
);

3463 
	`£g_šfo_to_¿w_s™
(
£
,

3464 &
	`s™_š_jouº®
(
jouº®
, 
off£t
));

3465 
	`check_block_couÁ
(
sbi
, 
£gno
,

3466 &
	`s™_š_jouº®
(
jouº®
, 
off£t
));

3468 
s™_off£t
 = 
	`SIT_ENTRY_OFFSET
(
s™_i
, 
£gno
);

3469 
	`£g_šfo_to_¿w_s™
(
£
,

3470 &
¿w_s™
->
’Œ›s
[
s™_off£t
]);

3471 
	`check_block_couÁ
(
sbi
, 
£gno
,

3472 &
¿w_s™
->
’Œ›s
[
s™_off£t
]);

3475 
	`__ş—r_b™
(
£gno
, 
b™m­
);

3476 
s™_i
->
dœty_£Ár›s
--;

3477 
£s
->
’Œy_út
--;

3480 ià(
to_jouº®
)

3481 
	`up_wr™e
(&
cur£g
->
jouº®_rw£m
);

3483 
	`f2fs_put_·ge
(
·ge
, 1);

3485 
	`f2fs_bug_Ú
(
sbi
, 
£s
->
’Œy_út
);

3486 
	`»Ëa£_s™_’Œy_£t
(
£s
);

3489 
	`f2fs_bug_Ú
(
sbi
, !
	`li¡_em±y
(
h—d
));

3490 
	`f2fs_bug_Ú
(
sbi
, 
s™_i
->
dœty_£Ár›s
);

3491 
out
:

3492 ià(
ıc
->
»asÚ
 & 
CP_DISCARD
) {

3493 
__u64
 
Œim_¡¬t
 = 
ıc
->trim_start;

3495 ; 
ıc
->
Œim_¡¬t
 <ğıc->
Œim_’d
; cpc->trim_start++)

3496 
	`add_disÿrd_addrs
(
sbi
, 
ıc
, 
çl£
);

3498 
ıc
->
Œim_¡¬t
 =rim_start;

3500 
	`up_wr™e
(&
s™_i
->
£Áry_lock
);

3502 
	`£t_´eä“_as_ä“_£gm’ts
(
sbi
);

3503 
	}
}

3505 
	$bud_s™_šfo
(
f2fs_sb_šfo
 *
sbi
)

3507 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

3508 
s™_šfo
 *
s™_i
;

3509 
s™_£gs
, 
¡¬t
;

3510 *
¤c_b™m­
;

3511 
b™m­_size
;

3514 
s™_i
 = 
	`f2fs_kz®loc
(
sbi
, (
s™_šfo
), 
GFP_KERNEL
);

3515 ià(!
s™_i
)

3516  -
ENOMEM
;

3518 
	`SM_I
(
sbi
)->
s™_šfo
 = 
s™_i
;

3520 
s™_i
->
£Ár›s
 =

3521 
	`f2fs_kvz®loc
(
sbi
, 
	`¬¿y_size
((
£g_’Œy
),

3522 
	`MAIN_SEGS
(
sbi
)),

3523 
GFP_KERNEL
);

3524 ià(!
s™_i
->
£Ár›s
)

3525  -
ENOMEM
;

3527 
b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

3528 
s™_i
->
dœty_£Ár›s_b™m­
 = 
	`f2fs_kvz®loc
(
sbi
, 
b™m­_size
,

3529 
GFP_KERNEL
);

3530 ià(!
s™_i
->
dœty_£Ár›s_b™m­
)

3531  -
ENOMEM
;

3533 
¡¬t
 = 0; s¹ < 
	`MAIN_SEGS
(
sbi
); start++) {

3534 
s™_i
->
£Ár›s
[
¡¬t
].
cur_v®id_m­


3535 ğ
	`f2fs_kz®loc
(
sbi
, 
SIT_VBLOCK_MAP_SIZE
, 
GFP_KERNEL
);

3536 
s™_i
->
£Ár›s
[
¡¬t
].
ck±_v®id_m­


3537 ğ
	`f2fs_kz®loc
(
sbi
, 
SIT_VBLOCK_MAP_SIZE
, 
GFP_KERNEL
);

3538 ià(!
s™_i
->
£Ár›s
[
¡¬t
].
cur_v®id_m­
 ||

3539 !
s™_i
->
£Ár›s
[
¡¬t
].
ck±_v®id_m­
)

3540  -
ENOMEM
;

3542 #ifdeà
CONFIG_F2FS_CHECK_FS


3543 
s™_i
->
£Ár›s
[
¡¬t
].
cur_v®id_m­_mœ


3544 ğ
	`f2fs_kz®loc
(
sbi
, 
SIT_VBLOCK_MAP_SIZE
, 
GFP_KERNEL
);

3545 ià(!
s™_i
->
£Ár›s
[
¡¬t
].
cur_v®id_m­_mœ
)

3546  -
ENOMEM
;

3549 ià(
	`f2fs_disÿrd_’
(
sbi
)) {

3550 
s™_i
->
£Ár›s
[
¡¬t
].
disÿrd_m­


3551 ğ
	`f2fs_kz®loc
(
sbi
, 
SIT_VBLOCK_MAP_SIZE
,

3552 
GFP_KERNEL
);

3553 ià(!
s™_i
->
£Ár›s
[
¡¬t
].
disÿrd_m­
)

3554  -
ENOMEM
;

3558 
s™_i
->
tmp_m­
 = 
	`f2fs_kz®loc
(
sbi
, 
SIT_VBLOCK_MAP_SIZE
, 
GFP_KERNEL
);

3559 ià(!
s™_i
->
tmp_m­
)

3560  -
ENOMEM
;

3562 ià(
sbi
->
£gs_³r_£c
 > 1) {

3563 
s™_i
->
£c_’Œ›s
 =

3564 
	`f2fs_kvz®loc
(
sbi
, 
	`¬¿y_size
((
£c_’Œy
),

3565 
	`MAIN_SECS
(
sbi
)),

3566 
GFP_KERNEL
);

3567 ià(!
s™_i
->
£c_’Œ›s
)

3568  -
ENOMEM
;

3572 
s™_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s™
) >> 1;

3575 
b™m­_size
 = 
	`__b™m­_size
(
sbi
, 
SIT_BITMAP
);

3576 
¤c_b™m­
 = 
	`__b™m­_±r
(
sbi
, 
SIT_BITMAP
);

3578 
s™_i
->
s™_b™m­
 = 
	`kmemdup
(
¤c_b™m­
, 
b™m­_size
, 
GFP_KERNEL
);

3579 ià(!
s™_i
->
s™_b™m­
)

3580  -
ENOMEM
;

3582 #ifdeà
CONFIG_F2FS_CHECK_FS


3583 
s™_i
->
s™_b™m­_mœ
 = 
	`kmemdup
(
¤c_b™m­
, 
b™m­_size
, 
GFP_KERNEL
);

3584 ià(!
s™_i
->
s™_b™m­_mœ
)

3585  -
ENOMEM
;

3589 
s™_i
->
s_İs
 = &
deçuÉ_§Îoc_İs
;

3591 
s™_i
->
s™_ba£_addr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
s™_blkaddr
);

3592 
s™_i
->
s™_blocks
 = 
s™_£gs
 << 
sbi
->
log_blocks_³r_£g
;

3593 
s™_i
->
wr™‹n_v®id_blocks
 = 0;

3594 
s™_i
->
b™m­_size
 = bitmap_size;

3595 
s™_i
->
dœty_£Ár›s
 = 0;

3596 
s™_i
->
£Ás_³r_block
 = 
SIT_ENTRY_PER_BLOCK
;

3597 
s™_i
->
–­£d_time
 = 
	`Ë64_to_ıu
(
sbi
->
ck±
->elapsed_time);

3598 
s™_i
->
mouÁed_time
 = 
	`ktime_g‘_»®_£cÚds
();

3599 
	`š™_rw£m
(&
s™_i
->
£Áry_lock
);

3601 
	}
}

3603 
	$bud_ä“_£gm­
(
f2fs_sb_šfo
 *
sbi
)

3605 
ä“_£gm­_šfo
 *
ä“_i
;

3606 
b™m­_size
, 
£c_b™m­_size
;

3609 
ä“_i
 = 
	`f2fs_kz®loc
(
sbi
, (
ä“_£gm­_šfo
), 
GFP_KERNEL
);

3610 ià(!
ä“_i
)

3611  -
ENOMEM
;

3613 
	`SM_I
(
sbi
)->
ä“_šfo
 = 
ä“_i
;

3615 
b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

3616 
ä“_i
->
ä“_£gm­
 = 
	`f2fs_kvm®loc
(
sbi
, 
b™m­_size
, 
GFP_KERNEL
);

3617 ià(!
ä“_i
->
ä“_£gm­
)

3618  -
ENOMEM
;

3620 
£c_b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SECS
(
sbi
));

3621 
ä“_i
->
ä“_£cm­
 = 
	`f2fs_kvm®loc
(
sbi
, 
£c_b™m­_size
, 
GFP_KERNEL
);

3622 ià(!
ä“_i
->
ä“_£cm­
)

3623  -
ENOMEM
;

3626 
	`mem£t
(
ä“_i
->
ä“_£gm­
, 0xff, 
b™m­_size
);

3627 
	`mem£t
(
ä“_i
->
ä“_£cm­
, 0xff, 
£c_b™m­_size
);

3630 
ä“_i
->
¡¬t_£gno
 = 
	`GET_SEGNO_FROM_SEG0
(
sbi
, 
	`MAIN_BLKADDR
(sbi));

3631 
ä“_i
->
ä“_£gm’ts
 = 0;

3632 
ä“_i
->
ä“_£ùiÚs
 = 0;

3633 
	`¥š_lock_š™
(&
ä“_i
->
£gm­_lock
);

3635 
	}
}

3637 
	$bud_cur£g
(
f2fs_sb_šfo
 *
sbi
)

3639 
cur£g_šfo
 *
¬¿y
;

3640 
i
;

3642 
¬¿y
 = 
	`f2fs_kz®loc
(
sbi
, 
	`¬¿y_size
(
NR_CURSEG_TYPE
, (*array)),

3643 
GFP_KERNEL
);

3644 ià(!
¬¿y
)

3645  -
ENOMEM
;

3647 
	`SM_I
(
sbi
)->
cur£g_¬¿y
 = 
¬¿y
;

3649 
i
 = 0; i < 
NR_CURSEG_TYPE
; i++) {

3650 
	`mu‹x_š™
(&
¬¿y
[
i
].
cur£g_mu‹x
);

3651 
¬¿y
[
i
].
sum_blk
 = 
	`f2fs_kz®loc
(
sbi
, 
PAGE_SIZE
, 
GFP_KERNEL
);

3652 ià(!
¬¿y
[
i
].
sum_blk
)

3653  -
ENOMEM
;

3654 
	`š™_rw£m
(&
¬¿y
[
i
].
jouº®_rw£m
);

3655 
¬¿y
[
i
].
jouº®
 = 
	`f2fs_kz®loc
(
sbi
,

3656 (
f2fs_jouº®
), 
GFP_KERNEL
);

3657 ià(!
¬¿y
[
i
].
jouº®
)

3658  -
ENOMEM
;

3659 
¬¿y
[
i
].
£gno
 = 
NULL_SEGNO
;

3660 
¬¿y
[
i
].
Ãxt_blkoff
 = 0;

3662  
	`»¡Üe_cur£g_summ¬›s
(
sbi
);

3663 
	}
}

3665 
	$bud_s™_’Œ›s
(
f2fs_sb_šfo
 *
sbi
)

3667 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

3668 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

3669 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

3670 
£g_’Œy
 *
£
;

3671 
f2fs_s™_’Œy
 
s™
;

3672 
s™_blk_út
 = 
	`SIT_BLK_CNT
(
sbi
);

3673 
i
, 
¡¬t
, 
’d
;

3674 
»aded
, 
¡¬t_blk
 = 0;

3675 
”r
 = 0;

3676 
block_t
 
tÙ®_node_blocks
 = 0;

3679 
»aded
 = 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
¡¬t_blk
, 
BIO_MAX_PAGES
,

3680 
META_SIT
, 
Œue
);

3682 
¡¬t
 = 
¡¬t_blk
 * 
s™_i
->
£Ás_³r_block
;

3683 
’d
 = (
¡¬t_blk
 + 
»aded
è* 
s™_i
->
£Ás_³r_block
;

3685 ; 
¡¬t
 < 
’d
 && s¹ < 
	`MAIN_SEGS
(
sbi
); start++) {

3686 
f2fs_s™_block
 *
s™_blk
;

3687 
·ge
 *page;

3689 
£
 = &
s™_i
->
£Ár›s
[
¡¬t
];

3690 
·ge
 = 
	`g‘_cu¼’t_s™_·ge
(
sbi
, 
¡¬t
);

3691 
s™_blk
 = (
f2fs_s™_block
 *)
	`·ge_add»ss
(
·ge
);

3692 
s™
 = 
s™_blk
->
’Œ›s
[
	`SIT_ENTRY_OFFSET
(
s™_i
, 
¡¬t
)];

3693 
	`f2fs_put_·ge
(
·ge
, 1);

3695 
”r
 = 
	`check_block_couÁ
(
sbi
, 
¡¬t
, &
s™
);

3696 ià(
”r
)

3697  
”r
;

3698 
	`£g_šfo_äom_¿w_s™
(
£
, &
s™
);

3699 ià(
	`IS_NODESEG
(
£
->
ty³
))

3700 
tÙ®_node_blocks
 +ğ
£
->
v®id_blocks
;

3703 ià(
	`f2fs_disÿrd_’
(
sbi
)) {

3704 ià(
	`is_£t_ck±_æags
(
sbi
, 
CP_TRIMMED_FLAG
)) {

3705 
	`mem£t
(
£
->
disÿrd_m­
, 0xff,

3706 
SIT_VBLOCK_MAP_SIZE
);

3708 
	`memıy
(
£
->
disÿrd_m­
,

3709 
£
->
cur_v®id_m­
,

3710 
SIT_VBLOCK_MAP_SIZE
);

3711 
sbi
->
disÿrd_blks
 +=

3712 
sbi
->
blocks_³r_£g
 -

3713 
£
->
v®id_blocks
;

3717 ià(
sbi
->
£gs_³r_£c
 > 1)

3718 
	`g‘_£c_’Œy
(
sbi
, 
¡¬t
)->
v®id_blocks
 +=

3719 
£
->
v®id_blocks
;

3721 
¡¬t_blk
 +ğ
»aded
;

3722 } 
¡¬t_blk
 < 
s™_blk_út
);

3724 
	`down_»ad
(&
cur£g
->
jouº®_rw£m
);

3725 
i
 = 0; i < 
	`s™s_š_cursum
(
jouº®
); i++) {

3726 
Şd_v®id_blocks
;

3728 
¡¬t
 = 
	`Ë32_to_ıu
(
	`£gno_š_jouº®
(
jouº®
, 
i
));

3729 ià(
¡¬t
 >ğ
	`MAIN_SEGS
(
sbi
)) {

3730 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
,

3732 
¡¬t
);

3733 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

3734 
”r
 = -
EINVAL
;

3738 
£
 = &
s™_i
->
£Ár›s
[
¡¬t
];

3739 
s™
 = 
	`s™_š_jouº®
(
jouº®
, 
i
);

3741 
Şd_v®id_blocks
 = 
£
->
v®id_blocks
;

3742 ià(
	`IS_NODESEG
(
£
->
ty³
))

3743 
tÙ®_node_blocks
 -ğ
Şd_v®id_blocks
;

3745 
”r
 = 
	`check_block_couÁ
(
sbi
, 
¡¬t
, &
s™
);

3746 ià(
”r
)

3748 
	`£g_šfo_äom_¿w_s™
(
£
, &
s™
);

3749 ià(
	`IS_NODESEG
(
£
->
ty³
))

3750 
tÙ®_node_blocks
 +ğ
£
->
v®id_blocks
;

3752 ià(
	`f2fs_disÿrd_’
(
sbi
)) {

3753 ià(
	`is_£t_ck±_æags
(
sbi
, 
CP_TRIMMED_FLAG
)) {

3754 
	`mem£t
(
£
->
disÿrd_m­
, 0xff,

3755 
SIT_VBLOCK_MAP_SIZE
);

3757 
	`memıy
(
£
->
disÿrd_m­
, se->
cur_v®id_m­
,

3758 
SIT_VBLOCK_MAP_SIZE
);

3759 
sbi
->
disÿrd_blks
 +ğ
Şd_v®id_blocks
;

3760 
sbi
->
disÿrd_blks
 -ğ
£
->
v®id_blocks
;

3764 ià(
sbi
->
£gs_³r_£c
 > 1) {

3765 
	`g‘_£c_’Œy
(
sbi
, 
¡¬t
)->
v®id_blocks
 +=

3766 
£
->
v®id_blocks
;

3767 
	`g‘_£c_’Œy
(
sbi
, 
¡¬t
)->
v®id_blocks
 -=

3768 
Şd_v®id_blocks
;

3771 
	`up_»ad
(&
cur£g
->
jouº®_rw£m
);

3773 ià(!
”r
 && 
tÙ®_node_blocks
 !ğ
	`v®id_node_couÁ
(
sbi
)) {

3774 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
,

3776 
tÙ®_node_blocks
, 
	`v®id_node_couÁ
(
sbi
));

3777 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

3778 
”r
 = -
EINVAL
;

3781  
”r
;

3782 
	}
}

3784 
	$š™_ä“_£gm­
(
f2fs_sb_šfo
 *
sbi
)

3786 
¡¬t
;

3787 
ty³
;

3789 
¡¬t
 = 0; s¹ < 
	`MAIN_SEGS
(
sbi
); start++) {

3790 
£g_’Œy
 *
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
¡¬t
);

3791 ià(!
£Áry
->
v®id_blocks
)

3792 
	`__£t_ä“
(
sbi
, 
¡¬t
);

3794 
	`SIT_I
(
sbi
)->
wr™‹n_v®id_blocks
 +=

3795 
£Áry
->
v®id_blocks
;

3799 
ty³
 = 
CURSEG_HOT_DATA
;y³ <ğ
CURSEG_COLD_NODE
;ype++) {

3800 
cur£g_šfo
 *
cur£g_t
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

3801 
	`__£t_‹¡_ªd_šu£
(
sbi
, 
cur£g_t
->
£gno
);

3803 
	}
}

3805 
	$š™_dœty_£gm­
(
f2fs_sb_šfo
 *
sbi
)

3807 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

3808 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

3809 
£gno
 = 0, 
off£t
 = 0;

3810 
v®id_blocks
;

3814 
£gno
 = 
	`fšd_Ãxt_šu£
(
ä“_i
, 
	`MAIN_SEGS
(
sbi
), 
off£t
);

3815 ià(
£gno
 >ğ
	`MAIN_SEGS
(
sbi
))

3817 
off£t
 = 
£gno
 + 1;

3818 
v®id_blocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
çl£
);

3819 ià(
v®id_blocks
 =ğ
sbi
->
blocks_³r_£g
 || !valid_blocks)

3821 ià(
v®id_blocks
 > 
sbi
->
blocks_³r_£g
) {

3822 
	`f2fs_bug_Ú
(
sbi
, 1);

3825 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

3826 
	`__loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

3827 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

3829 
	}
}

3831 
	$š™_viùim_£cm­
(
f2fs_sb_šfo
 *
sbi
)

3833 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

3834 
b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SECS
(
sbi
));

3836 
dœty_i
->
viùim_£cm­
 = 
	`f2fs_kvz®loc
(
sbi
, 
b™m­_size
, 
GFP_KERNEL
);

3837 ià(!
dœty_i
->
viùim_£cm­
)

3838  -
ENOMEM
;

3840 
	}
}

3842 
	$bud_dœty_£gm­
(
f2fs_sb_šfo
 *
sbi
)

3844 
dœty_£gli¡_šfo
 *
dœty_i
;

3845 
b™m­_size
, 
i
;

3848 
dœty_i
 = 
	`f2fs_kz®loc
(
sbi
, (
dœty_£gli¡_šfo
),

3849 
GFP_KERNEL
);

3850 ià(!
dœty_i
)

3851  -
ENOMEM
;

3853 
	`SM_I
(
sbi
)->
dœty_šfo
 = 
dœty_i
;

3854 
	`mu‹x_š™
(&
dœty_i
->
£gli¡_lock
);

3856 
b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

3858 
i
 = 0; i < 
NR_DIRTY_TYPE
; i++) {

3859 
dœty_i
->
dœty_£gm­
[
i
] = 
	`f2fs_kvz®loc
(
sbi
, 
b™m­_size
,

3860 
GFP_KERNEL
);

3861 ià(!
dœty_i
->
dœty_£gm­
[
i
])

3862  -
ENOMEM
;

3865 
	`š™_dœty_£gm­
(
sbi
);

3866  
	`š™_viùim_£cm­
(
sbi
);

3867 
	}
}

3872 
	$š™_mš_max_mtime
(
f2fs_sb_šfo
 *
sbi
)

3874 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

3875 
£gno
;

3877 
	`down_wr™e
(&
s™_i
->
£Áry_lock
);

3879 
s™_i
->
mš_mtime
 = 
ULLONG_MAX
;

3881 
£gno
 = 0; segnØ< 
	`MAIN_SEGS
(
sbi
); segnØ+ğsbi->
£gs_³r_£c
) {

3882 
i
;

3883 
mtime
 = 0;

3885 
i
 = 0; i < 
sbi
->
£gs_³r_£c
; i++)

3886 
mtime
 +ğ
	`g‘_£g_’Œy
(
sbi
, 
£gno
 + 
i
)->mtime;

3888 
mtime
 = 
	`div_u64
(mtime, 
sbi
->
£gs_³r_£c
);

3890 ià(
s™_i
->
mš_mtime
 > 
mtime
)

3891 
s™_i
->
mš_mtime
 = 
mtime
;

3893 
s™_i
->
max_mtime
 = 
	`g‘_mtime
(
sbi
, 
çl£
);

3894 
	`up_wr™e
(&
s™_i
->
£Áry_lock
);

3895 
	}
}

3897 
	$f2fs_bud_£gm’t_mªag”
(
f2fs_sb_šfo
 *
sbi
)

3899 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

3900 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

3901 
f2fs_sm_šfo
 *
sm_šfo
;

3902 
”r
;

3904 
sm_šfo
 = 
	`f2fs_kz®loc
(
sbi
, (
f2fs_sm_šfo
), 
GFP_KERNEL
);

3905 ià(!
sm_šfo
)

3906  -
ENOMEM
;

3909 
sbi
->
sm_šfo
 = sm_info;

3910 
sm_šfo
->
£g0_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t0_blkaddr
);

3911 
sm_šfo
->
maš_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->main_blkaddr);

3912 
sm_šfo
->
£gm’t_couÁ
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count);

3913 
sm_šfo
->
»£rved_£gm’ts
 = 
	`Ë32_to_ıu
(
ck±
->
rsvd_£gm’t_couÁ
);

3914 
sm_šfo
->
ovp_£gm’ts
 = 
	`Ë32_to_ıu
(
ck±
->
ov”´ov_£gm’t_couÁ
);

3915 
sm_šfo
->
maš_£gm’ts
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_maš
);

3916 
sm_šfo
->
s§_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->ssa_blkaddr);

3917 
sm_šfo
->
»c_´eä“_£gm’ts
 = sm_šfo->
maš_£gm’ts
 *

3918 
DEF_RECLAIM_PREFREE_SEGMENTS
 / 100;

3919 ià(
sm_šfo
->
»c_´eä“_£gm’ts
 > 
DEF_MAX_RECLAIM_PREFREE_SEGMENTS
)

3920 
sm_šfo
->
»c_´eä“_£gm’ts
 = 
DEF_MAX_RECLAIM_PREFREE_SEGMENTS
;

3922 ià(!
	`‹¡_İt
(
sbi
, 
LFS
))

3923 
sm_šfo
->
u_pŞicy
 = 1 << 
F2FS_IPU_FSYNC
;

3924 
sm_šfo
->
mš_u_ut
 = 
DEF_MIN_IPU_UTIL
;

3925 
sm_šfo
->
mš_fsync_blocks
 = 
DEF_MIN_FSYNC_BLOCKS
;

3926 
sm_šfo
->
mš_hÙ_blocks
 = 
DEF_MIN_HOT_BLOCKS
;

3927 
sm_šfo
->
mš_s¤_£ùiÚs
 = 
	`»£rved_£ùiÚs
(
sbi
);

3929 
	`INIT_LIST_HEAD
(&
sm_šfo
->
s™_’Œy_£t
);

3931 
	`š™_rw£m
(&
sm_šfo
->
cur£g_lock
);

3933 ià(!
	`f2fs_»adÚly
(
sbi
->
sb
)) {

3934 
”r
 = 
	`f2fs_ü—‹_æush_cmd_cÚŒŞ
(
sbi
);

3935 ià(
”r
)

3936  
”r
;

3939 
”r
 = 
	`ü—‹_disÿrd_cmd_cÚŒŞ
(
sbi
);

3940 ià(
”r
)

3941  
”r
;

3943 
”r
 = 
	`bud_s™_šfo
(
sbi
);

3944 ià(
”r
)

3945  
”r
;

3946 
”r
 = 
	`bud_ä“_£gm­
(
sbi
);

3947 ià(
”r
)

3948  
”r
;

3949 
”r
 = 
	`bud_cur£g
(
sbi
);

3950 ià(
”r
)

3951  
”r
;

3954 
”r
 = 
	`bud_s™_’Œ›s
(
sbi
);

3955 ià(
”r
)

3956  
”r
;

3958 
	`š™_ä“_£gm­
(
sbi
);

3959 
”r
 = 
	`bud_dœty_£gm­
(
sbi
);

3960 ià(
”r
)

3961  
”r
;

3963 
	`š™_mš_max_mtime
(
sbi
);

3965 
	}
}

3967 
	$disÿrd_dœty_£gm­
(
f2fs_sb_šfo
 *
sbi
,

3968 
dœty_ty³
 dirty_type)

3970 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

3972 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

3973 
	`kvä“
(
dœty_i
->
dœty_£gm­
[
dœty_ty³
]);

3974 
dœty_i
->
Ä_dœty
[
dœty_ty³
] = 0;

3975 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

3976 
	}
}

3978 
	$de¡roy_viùim_£cm­
(
f2fs_sb_šfo
 *
sbi
)

3980 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

3981 
	`kvä“
(
dœty_i
->
viùim_£cm­
);

3982 
	}
}

3984 
	$de¡roy_dœty_£gm­
(
f2fs_sb_šfo
 *
sbi
)

3986 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

3987 
i
;

3989 ià(!
dœty_i
)

3993 
i
 = 0; i < 
NR_DIRTY_TYPE
; i++)

3994 
	`disÿrd_dœty_£gm­
(
sbi
, 
i
);

3996 
	`de¡roy_viùim_£cm­
(
sbi
);

3997 
	`SM_I
(
sbi
)->
dœty_šfo
 = 
NULL
;

3998 
	`kä“
(
dœty_i
);

3999 
	}
}

4001 
	$de¡roy_cur£g
(
f2fs_sb_šfo
 *
sbi
)

4003 
cur£g_šfo
 *
¬¿y
 = 
	`SM_I
(
sbi
)->
cur£g_¬¿y
;

4004 
i
;

4006 ià(!
¬¿y
)

4008 
	`SM_I
(
sbi
)->
cur£g_¬¿y
 = 
NULL
;

4009 
i
 = 0; i < 
NR_CURSEG_TYPE
; i++) {

4010 
	`kä“
(
¬¿y
[
i
].
sum_blk
);

4011 
	`kä“
(
¬¿y
[
i
].
jouº®
);

4013 
	`kä“
(
¬¿y
);

4014 
	}
}

4016 
	$de¡roy_ä“_£gm­
(
f2fs_sb_šfo
 *
sbi
)

4018 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`SM_I
(
sbi
)->
ä“_šfo
;

4019 ià(!
ä“_i
)

4021 
	`SM_I
(
sbi
)->
ä“_šfo
 = 
NULL
;

4022 
	`kvä“
(
ä“_i
->
ä“_£gm­
);

4023 
	`kvä“
(
ä“_i
->
ä“_£cm­
);

4024 
	`kä“
(
ä“_i
);

4025 
	}
}

4027 
	$de¡roy_s™_šfo
(
f2fs_sb_šfo
 *
sbi
)

4029 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

4030 
¡¬t
;

4032 ià(!
s™_i
)

4035 ià(
s™_i
->
£Ár›s
) {

4036 
¡¬t
 = 0; s¹ < 
	`MAIN_SEGS
(
sbi
); start++) {

4037 
	`kä“
(
s™_i
->
£Ár›s
[
¡¬t
].
cur_v®id_m­
);

4038 #ifdeà
CONFIG_F2FS_CHECK_FS


4039 
	`kä“
(
s™_i
->
£Ár›s
[
¡¬t
].
cur_v®id_m­_mœ
);

4041 
	`kä“
(
s™_i
->
£Ár›s
[
¡¬t
].
ck±_v®id_m­
);

4042 
	`kä“
(
s™_i
->
£Ár›s
[
¡¬t
].
disÿrd_m­
);

4045 
	`kä“
(
s™_i
->
tmp_m­
);

4047 
	`kvä“
(
s™_i
->
£Ár›s
);

4048 
	`kvä“
(
s™_i
->
£c_’Œ›s
);

4049 
	`kvä“
(
s™_i
->
dœty_£Ár›s_b™m­
);

4051 
	`SM_I
(
sbi
)->
s™_šfo
 = 
NULL
;

4052 
	`kä“
(
s™_i
->
s™_b™m­
);

4053 #ifdeà
CONFIG_F2FS_CHECK_FS


4054 
	`kä“
(
s™_i
->
s™_b™m­_mœ
);

4056 
	`kä“
(
s™_i
);

4057 
	}
}

4059 
	$f2fs_de¡roy_£gm’t_mªag”
(
f2fs_sb_šfo
 *
sbi
)

4061 
f2fs_sm_šfo
 *
sm_šfo
 = 
	`SM_I
(
sbi
);

4063 ià(!
sm_šfo
)

4065 
	`f2fs_de¡roy_æush_cmd_cÚŒŞ
(
sbi
, 
Œue
);

4066 
	`de¡roy_disÿrd_cmd_cÚŒŞ
(
sbi
);

4067 
	`de¡roy_dœty_£gm­
(
sbi
);

4068 
	`de¡roy_cur£g
(
sbi
);

4069 
	`de¡roy_ä“_£gm­
(
sbi
);

4070 
	`de¡roy_s™_šfo
(
sbi
);

4071 
sbi
->
sm_šfo
 = 
NULL
;

4072 
	`kä“
(
sm_šfo
);

4073 
	}
}

4075 
__š™
 
	$f2fs_ü—‹_£gm’t_mªag”_ÿches
()

4077 
disÿrd_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("discard_entry",

4078 (
disÿrd_’Œy
));

4079 ià(!
disÿrd_’Œy_¦ab
)

4080 
ç
;

4082 
disÿrd_cmd_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("discard_cmd",

4083 (
disÿrd_cmd
));

4084 ià(!
disÿrd_cmd_¦ab
)

4085 
de¡roy_disÿrd_’Œy
;

4087 
s™_’Œy_£t_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("sit_entry_set",

4088 (
s™_’Œy_£t
));

4089 ià(!
s™_’Œy_£t_¦ab
)

4090 
de¡roy_disÿrd_cmd
;

4092 
šmem_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("inmem_page_entry",

4093 (
šmem_·ges
));

4094 ià(!
šmem_’Œy_¦ab
)

4095 
de¡roy_s™_’Œy_£t
;

4098 
de¡roy_s™_’Œy_£t
:

4099 
	`kmem_ÿche_de¡roy
(
s™_’Œy_£t_¦ab
);

4100 
de¡roy_disÿrd_cmd
:

4101 
	`kmem_ÿche_de¡roy
(
disÿrd_cmd_¦ab
);

4102 
de¡roy_disÿrd_’Œy
:

4103 
	`kmem_ÿche_de¡roy
(
disÿrd_’Œy_¦ab
);

4104 
ç
:

4105  -
ENOMEM
;

4106 
	}
}

4108 
	$f2fs_de¡roy_£gm’t_mªag”_ÿches
()

4110 
	`kmem_ÿche_de¡roy
(
s™_’Œy_£t_¦ab
);

4111 
	`kmem_ÿche_de¡roy
(
disÿrd_cmd_¦ab
);

4112 
	`kmem_ÿche_de¡roy
(
disÿrd_’Œy_¦ab
);

4113 
	`kmem_ÿche_de¡roy
(
šmem_’Œy_¦ab
);

4114 
	}
}

	@fs/f2fs/segment.h

11 
	~<lšux/blkdev.h
>

12 
	~<lšux/backšg-dev.h
>

15 
	#NULL_SEGNO
 (()(~0))

	)

16 
	#NULL_SECNO
 (()(~0))

	)

18 
	#DEF_RECLAIM_PREFREE_SEGMENTS
 5

	)

19 
	#DEF_MAX_RECLAIM_PREFREE_SEGMENTS
 4096

	)

21 
	#F2FS_MIN_SEGMENTS
 9

	)

24 
	#GET_L2R_SEGNO
(
ä“_i
, 
£gno
è((£gnoè- (ä“_i)->
¡¬t_£gno
)

	)

25 
	#GET_R2L_SEGNO
(
ä“_i
, 
£gno
è((£gnoè+ (ä“_i)->
¡¬t_£gno
)

	)

27 
	#IS_DATASEG
(
t
è(Ñè<ğ
CURSEG_COLD_DATA
)

	)

28 
	#IS_NODESEG
(
t
è(Ñè>ğ
CURSEG_HOT_NODE
)

	)

30 
	#IS_HOT
(
t
è(Ñè=ğ
CURSEG_HOT_NODE
 || (tè=ğ
CURSEG_HOT_DATA
)

	)

31 
	#IS_WARM
(
t
è(Ñè=ğ
CURSEG_WARM_NODE
 || (tè=ğ
CURSEG_WARM_DATA
)

	)

32 
	#IS_COLD
(
t
è(Ñè=ğ
CURSEG_COLD_NODE
 || (tè=ğ
CURSEG_COLD_DATA
)

	)

34 
	#IS_CURSEG
(
sbi
, 
£g
) \

35 (((
£g
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
)->
£gno
) || \

36 ((
£g
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_DATA
)->
£gno
) || \

37 ((
£g
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
)->
£gno
) || \

38 ((
£g
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_NODE
)->
£gno
) || \

39 ((
£g
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
)->
£gno
) || \

40 ((
£g
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_NODE
)->
£gno
))

	)

42 
	#IS_CURSEC
(
sbi
, 
£úo
) \

43 (((
£úo
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
)->
£gno
 / \

44 (
sbi
)->
£gs_³r_£c
) || \

45 ((
£úo
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_DATA
)->
£gno
 / \

46 (
sbi
)->
£gs_³r_£c
) || \

47 ((
£úo
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
)->
£gno
 / \

48 (
sbi
)->
£gs_³r_£c
) || \

49 ((
£úo
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_NODE
)->
£gno
 / \

50 (
sbi
)->
£gs_³r_£c
) || \

51 ((
£úo
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
)->
£gno
 / \

52 (
sbi
)->
£gs_³r_£c
) || \

53 ((
£úo
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_NODE
)->
£gno
 / \

54 (
sbi
)->
£gs_³r_£c
)) \

55 

	)

56 
	#MAIN_BLKADDR
(
sbi
) \

57 (
	`SM_I
(
sbi
è? SM_I(sbi)->
maš_blkaddr
 : \

58 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
maš_blkaddr
))

	)

59 
	#SEG0_BLKADDR
(
sbi
) \

60 (
	`SM_I
(
sbi
è? SM_I(sbi)->
£g0_blkaddr
 : \

61 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
£gm’t0_blkaddr
))

	)

63 
	#MAIN_SEGS
(
sbi
è(
	`SM_I
(sbi)->
maš_£gm’ts
)

	)

64 
	#MAIN_SECS
(
sbi
è((sbi)->
tÙ®_£ùiÚs
)

	)

66 
	#TOTAL_SEGS
(
sbi
) \

67 (
	`SM_I
(
sbi
è? SM_I(sbi)->
£gm’t_couÁ
 : \

68 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
£gm’t_couÁ
))

	)

69 
	#TOTAL_BLKS
(
sbi
è(
	`TOTAL_SEGS
(sbiè<< (sbi)->
log_blocks_³r_£g
)

	)

71 
	#MAX_BLKADDR
(
sbi
è(
	`SEG0_BLKADDR
(sbiè+ 
	`TOTAL_BLKS
(sbi))

	)

72 
	#SEGMENT_SIZE
(
sbi
è(1ULL << ((sbi)->
log_blocksize
 + \

73 (
sbi
)->
log_blocks_³r_£g
))

	)

75 
	#START_BLOCK
(
sbi
, 
£gno
è(
	`SEG0_BLKADDR
(sbi) + \

76 (
	`GET_R2L_SEGNO
(
	`FREE_I
(
sbi
), 
£gno
è<< (sbi)->
log_blocks_³r_£g
))

	)

78 
	#NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
) \

79 (
	`START_BLOCK
(
sbi
, (
cur£g
)->
£gno
è+ (cur£g)->
Ãxt_blkoff
)

	)

81 
	#GET_SEGOFF_FROM_SEG0
(
sbi
, 
blk_addr
è((blk_addrè- 
	`SEG0_BLKADDR
(sbi))

	)

82 
	#GET_SEGNO_FROM_SEG0
(
sbi
, 
blk_addr
) \

83 (
	`GET_SEGOFF_FROM_SEG0
(
sbi
, 
blk_addr
è>> (sbi)->
log_blocks_³r_£g
)

	)

84 
	#GET_BLKOFF_FROM_SEG0
(
sbi
, 
blk_addr
) \

85 (
	`GET_SEGOFF_FROM_SEG0
(
sbi
, 
blk_addr
è& ((sbi)->
blocks_³r_£g
 - 1))

	)

87 
	#GET_SEGNO
(
sbi
, 
blk_addr
) \

88 ((!
	`is_v®id_blkaddr
(
blk_addr
)) ? \

89 
NULL_SEGNO
 : 
	`GET_L2R_SEGNO
(
	`FREE_I
(
sbi
), \

90 
	`GET_SEGNO_FROM_SEG0
(
sbi
, 
blk_addr
)))

	)

91 
	#BLKS_PER_SEC
(
sbi
) \

92 ((
sbi
)->
£gs_³r_£c
 * (sbi)->
blocks_³r_£g
)

	)

93 
	#GET_SEC_FROM_SEG
(
sbi
, 
£gno
) \

94 ((
£gno
è/ (
sbi
)->
£gs_³r_£c
)

	)

95 
	#GET_SEG_FROM_SEC
(
sbi
, 
£úo
) \

96 ((
£úo
è* (
sbi
)->
£gs_³r_£c
)

	)

97 
	#GET_ZONE_FROM_SEC
(
sbi
, 
£úo
) \

98 ((
£úo
è/ (
sbi
)->
£cs_³r_zÚe
)

	)

99 
	#GET_ZONE_FROM_SEG
(
sbi
, 
£gno
) \

100 
	`GET_ZONE_FROM_SEC
(
sbi
, 
	`GET_SEC_FROM_SEG
(sbi, 
£gno
))

	)

102 
	#GET_SUM_BLOCK
(
sbi
, 
£gno
) \

103 ((
sbi
)->
sm_šfo
->
s§_blkaddr
 + (
£gno
))

	)

105 
	#GET_SUM_TYPE
(
foÙ”
è((foÙ”)->
’Œy_ty³
)

	)

106 
	#SET_SUM_TYPE
(
foÙ”
, 
ty³
è((foÙ”)->
’Œy_ty³
 = (ty³))

	)

108 
	#SIT_ENTRY_OFFSET
(
s™_i
, 
£gno
) \

109 ((
£gno
è% (
s™_i
)->
£Ás_³r_block
)

	)

110 
	#SIT_BLOCK_OFFSET
(
£gno
) \

111 ((
£gno
è/ 
SIT_ENTRY_PER_BLOCK
)

	)

112 
	#START_SEGNO
(
£gno
) \

113 (
	`SIT_BLOCK_OFFSET
(
£gno
è* 
SIT_ENTRY_PER_BLOCK
)

	)

114 
	#SIT_BLK_CNT
(
sbi
) \

115 ((
	`MAIN_SEGS
(
sbi
è+ 
SIT_ENTRY_PER_BLOCK
 - 1è/ SIT_ENTRY_PER_BLOCK)

	)

116 
	#f2fs_b™m­_size
(
Ä
) \

117 (
	`BITS_TO_LONGS
(
Ä
è* ())

	)

119 
	#SECTOR_FROM_BLOCK
(
blk_addr
) \

120 (((
£ùÜ_t
)
blk_addr
è<< 
F2FS_LOG_SECTORS_PER_BLOCK
)

	)

121 
	#SECTOR_TO_BLOCK
(
£ùÜs
) \

122 ((
£ùÜs
è>> 
F2FS_LOG_SECTORS_PER_BLOCK
)

	)

130 
	mALLOC_RIGHT
 = 0,

131 
	mALLOC_LEFT


140 
	mLFS
 = 0,

141 
	mSSR


150 
	mGC_CB
 = 0,

151 
	mGC_GREEDY
,

152 
	mALLOC_NEXT
,

153 
	mFLUSH_DEVICE
,

154 
	mMAX_GC_POLICY
,

163 
	mBG_GC
 = 0,

164 
	mFG_GC
,

165 
	mFORCE_FG_GC
,

169 
	sviùim_£l_pŞicy
 {

170 
	m®loc_mode
;

171 
	mgc_mode
;

172 *
	mdœty_£gm­
;

173 
	mmax_£¬ch
;

174 
	moff£t
;

175 
	mofs_un™
;

176 
	mmš_co¡
;

177 
	mmš_£gno
;

180 
	s£g_’Œy
 {

181 
	mty³
:6;

182 
	mv®id_blocks
:10;

183 
	mck±_v®id_blocks
:10;

184 
	m·ddšg
:6;

185 *
	mcur_v®id_m­
;

186 #ifdeà
CONFIG_F2FS_CHECK_FS


187 *
	mcur_v®id_m­_mœ
;

193 *
	mck±_v®id_m­
;

194 *
	mdisÿrd_m­
;

195 
	mmtime
;

198 
	s£c_’Œy
 {

199 
	mv®id_blocks
;

202 
	s£gm’t_®loÿtiÚ
 {

203 (*
	m®loÿ‹_£gm’t
)(
	mf2fs_sb_šfo
 *, , 
	mboŞ
);

210 
	#ATOMIC_WRITTEN_PAGE
 (()-1)

	)

211 
	#DUMMY_WRITTEN_PAGE
 (()-2)

	)

213 
	#IS_ATOMIC_WRITTEN_PAGE
(
·ge
) \

214 (
	`·ge_´iv©e
(
·ge
è=ğ()
ATOMIC_WRITTEN_PAGE
)

	)

215 
	#IS_DUMMY_WRITTEN_PAGE
(
·ge
) \

216 (
	`·ge_´iv©e
(
·ge
è=ğ()
DUMMY_WRITTEN_PAGE
)

	)

218 
	#MAX_SKIP_ATOMIC_COUNT
 16

	)

220 
	sšmem_·ges
 {

221 
li¡_h—d
 
	mli¡
;

222 
·ge
 *
	m·ge
;

223 
block_t
 
	mŞd_addr
;

226 
	ss™_šfo
 {

227 cÚ¡ 
£gm’t_®loÿtiÚ
 *
	ms_İs
;

229 
block_t
 
	ms™_ba£_addr
;

230 
block_t
 
	ms™_blocks
;

231 
block_t
 
	mwr™‹n_v®id_blocks
;

232 *
	ms™_b™m­
;

233 #ifdeà
CONFIG_F2FS_CHECK_FS


234 *
	ms™_b™m­_mœ
;

236 
	mb™m­_size
;

238 *
	mtmp_m­
;

239 *
	mdœty_£Ár›s_b™m­
;

240 
	mdœty_£Ár›s
;

241 
	m£Ás_³r_block
;

242 
rw_£m­hÜe
 
	m£Áry_lock
;

243 
£g_’Œy
 *
	m£Ár›s
;

244 
£c_’Œy
 *
	m£c_’Œ›s
;

247 
	m–­£d_time
;

248 
	mmouÁed_time
;

249 
	mmš_mtime
;

250 
	mmax_mtime
;

252 
	mÏ¡_viùim
[
MAX_GC_POLICY
];

255 
	sä“_£gm­_šfo
 {

256 
	m¡¬t_£gno
;

257 
	mä“_£gm’ts
;

258 
	mä“_£ùiÚs
;

259 
¥šlock_t
 
	m£gm­_lock
;

260 *
	mä“_£gm­
;

261 *
	mä“_£cm­
;

265 
	edœty_ty³
 {

266 
	mDIRTY_HOT_DATA
,

267 
	mDIRTY_WARM_DATA
,

268 
	mDIRTY_COLD_DATA
,

269 
	mDIRTY_HOT_NODE
,

270 
	mDIRTY_WARM_NODE
,

271 
	mDIRTY_COLD_NODE
,

272 
	mDIRTY
,

273 
	mPRE
,

274 
	mNR_DIRTY_TYPE


277 
	sdœty_£gli¡_šfo
 {

278 cÚ¡ 
viùim_£ËùiÚ
 *
	mv_İs
;

279 *
	mdœty_£gm­
[
NR_DIRTY_TYPE
];

280 
mu‹x
 
	m£gli¡_lock
;

281 
	mÄ_dœty
[
NR_DIRTY_TYPE
];

282 *
	mviùim_£cm­
;

286 
	sviùim_£ËùiÚ
 {

287 (*
	mg‘_viùim
)(
	mf2fs_sb_šfo
 *, *,

292 
	scur£g_šfo
 {

293 
mu‹x
 
	mcur£g_mu‹x
;

294 
f2fs_summ¬y_block
 *
	msum_blk
;

295 
rw_£m­hÜe
 
	mjouº®_rw£m
;

296 
f2fs_jouº®
 *
	mjouº®
;

297 
	m®loc_ty³
;

298 
	m£gno
;

299 
	mÃxt_blkoff
;

300 
	mzÚe
;

301 
	mÃxt_£gno
;

304 
	ss™_’Œy_£t
 {

305 
li¡_h—d
 
	m£t_li¡
;

306 
	m¡¬t_£gno
;

307 
	m’Œy_út
;

313 
šlše
 
cur£g_šfo
 *
	$CURSEG_I
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

315  (
cur£g_šfo
 *)(
	`SM_I
(
sbi
)->
cur£g_¬¿y
 + 
ty³
);

316 
	}
}

318 
šlše
 
£g_’Œy
 *
	$g‘_£g_’Œy
(
f2fs_sb_šfo
 *
sbi
,

319 
£gno
)

321 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

322  &
s™_i
->
£Ár›s
[
£gno
];

323 
	}
}

325 
šlše
 
£c_’Œy
 *
	$g‘_£c_’Œy
(
f2fs_sb_šfo
 *
sbi
,

326 
£gno
)

328 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

329  &
s™_i
->
£c_’Œ›s
[
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
)];

330 
	}
}

332 
šlše
 
	$g‘_v®id_blocks
(
f2fs_sb_šfo
 *
sbi
,

333 
£gno
, 
boŞ
 
u£_£ùiÚ
)

339 ià(
u£_£ùiÚ
 && 
sbi
->
£gs_³r_£c
 > 1)

340  
	`g‘_£c_’Œy
(
sbi
, 
£gno
)->
v®id_blocks
;

342  
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->
v®id_blocks
;

343 
	}
}

345 
šlše
 
	$£g_šfo_äom_¿w_s™
(
£g_’Œy
 *
£
,

346 
f2fs_s™_’Œy
 *
rs
)

348 
£
->
v®id_blocks
 = 
	`GET_SIT_VBLOCKS
(
rs
);

349 
£
->
ck±_v®id_blocks
 = 
	`GET_SIT_VBLOCKS
(
rs
);

350 
	`memıy
(
£
->
cur_v®id_m­
, 
rs
->
v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

351 
	`memıy
(
£
->
ck±_v®id_m­
, 
rs
->
v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

352 #ifdeà
CONFIG_F2FS_CHECK_FS


353 
	`memıy
(
£
->
cur_v®id_m­_mœ
, 
rs
->
v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

355 
£
->
ty³
 = 
	`GET_SIT_TYPE
(
rs
);

356 
£
->
mtime
 = 
	`Ë64_to_ıu
(
rs
->mtime);

357 
	}
}

359 
šlše
 
	$__£g_šfo_to_¿w_s™
(
£g_’Œy
 *
£
,

360 
f2fs_s™_’Œy
 *
rs
)

362 
¿w_vblocks
 = (
£
->
ty³
 << 
SIT_VBLOCKS_SHIFT
) |

363 
£
->
v®id_blocks
;

364 
rs
->
vblocks
 = 
	`ıu_to_Ë16
(
¿w_vblocks
);

365 
	`memıy
(
rs
->
v®id_m­
, 
£
->
cur_v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

366 
rs
->
mtime
 = 
	`ıu_to_Ë64
(
£
->mtime);

367 
	}
}

369 
šlše
 
	$£g_šfo_to_s™_·ge
(
f2fs_sb_šfo
 *
sbi
,

370 
·ge
 *·ge, 
¡¬t
)

372 
f2fs_s™_block
 *
¿w_s™
;

373 
£g_’Œy
 *
£
;

374 
f2fs_s™_’Œy
 *
rs
;

375 
’d
 = 
	`mš
(
¡¬t
 + 
SIT_ENTRY_PER_BLOCK
,

376 ()
	`MAIN_SEGS
(
sbi
));

377 
i
;

379 
¿w_s™
 = (
f2fs_s™_block
 *)
	`·ge_add»ss
(
·ge
);

380 
	`mem£t
(
¿w_s™
, 0, 
PAGE_SIZE
);

381 
i
 = 0; i < 
’d
 - 
¡¬t
; i++) {

382 
rs
 = &
¿w_s™
->
’Œ›s
[
i
];

383 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
¡¬t
 + 
i
);

384 
	`__£g_šfo_to_¿w_s™
(
£
, 
rs
);

386 
	}
}

388 
šlše
 
	$£g_šfo_to_¿w_s™
(
£g_’Œy
 *
£
,

389 
f2fs_s™_’Œy
 *
rs
)

391 
	`__£g_šfo_to_¿w_s™
(
£
, 
rs
);

393 
	`memıy
(
£
->
ck±_v®id_m­
, 
rs
->
v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

394 
£
->
ck±_v®id_blocks
 = se->
v®id_blocks
;

395 
	}
}

397 
šlše
 
	$fšd_Ãxt_šu£
(
ä“_£gm­_šfo
 *
ä“_i
,

398 
max
, 
£gno
)

400 
»t
;

401 
	`¥š_lock
(&
ä“_i
->
£gm­_lock
);

402 
»t
 = 
	`fšd_Ãxt_b™
(
ä“_i
->
ä“_£gm­
, 
max
, 
£gno
);

403 
	`¥š_uÆock
(&
ä“_i
->
£gm­_lock
);

404  
»t
;

405 
	}
}

407 
šlše
 
	$__£t_ä“
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

409 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

410 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
);

411 
¡¬t_£gno
 = 
	`GET_SEG_FROM_SEC
(
sbi
, 
£úo
);

412 
Ãxt
;

414 
	`¥š_lock
(&
ä“_i
->
£gm­_lock
);

415 
	`ş—r_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
);

416 
ä“_i
->
ä“_£gm’ts
++;

418 
Ãxt
 = 
	`fšd_Ãxt_b™
(
ä“_i
->
ä“_£gm­
,

419 
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
, start_segno);

420 ià(
Ãxt
 >ğ
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
) {

421 
	`ş—r_b™
(
£úo
, 
ä“_i
->
ä“_£cm­
);

422 
ä“_i
->
ä“_£ùiÚs
++;

424 
	`¥š_uÆock
(&
ä“_i
->
£gm­_lock
);

425 
	}
}

427 
šlše
 
	$__£t_šu£
(
f2fs_sb_šfo
 *
sbi
,

428 
£gno
)

430 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

431 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
);

433 
	`£t_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
);

434 
ä“_i
->
ä“_£gm’ts
--;

435 ià(!
	`‹¡_ªd_£t_b™
(
£úo
, 
ä“_i
->
ä“_£cm­
))

436 
ä“_i
->
ä“_£ùiÚs
--;

437 
	}
}

439 
šlše
 
	$__£t_‹¡_ªd_ä“
(
f2fs_sb_šfo
 *
sbi
,

440 
£gno
)

442 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

443 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
);

444 
¡¬t_£gno
 = 
	`GET_SEG_FROM_SEC
(
sbi
, 
£úo
);

445 
Ãxt
;

447 
	`¥š_lock
(&
ä“_i
->
£gm­_lock
);

448 ià(
	`‹¡_ªd_ş—r_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
)) {

449 
ä“_i
->
ä“_£gm’ts
++;

451 
Ãxt
 = 
	`fšd_Ãxt_b™
(
ä“_i
->
ä“_£gm­
,

452 
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
, start_segno);

453 ià(
Ãxt
 >ğ
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
) {

454 ià(
	`‹¡_ªd_ş—r_b™
(
£úo
, 
ä“_i
->
ä“_£cm­
))

455 
ä“_i
->
ä“_£ùiÚs
++;

458 
	`¥š_uÆock
(&
ä“_i
->
£gm­_lock
);

459 
	}
}

461 
šlše
 
	$__£t_‹¡_ªd_šu£
(
f2fs_sb_šfo
 *
sbi
,

462 
£gno
)

464 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

465 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
);

467 
	`¥š_lock
(&
ä“_i
->
£gm­_lock
);

468 ià(!
	`‹¡_ªd_£t_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
)) {

469 
ä“_i
->
ä“_£gm’ts
--;

470 ià(!
	`‹¡_ªd_£t_b™
(
£úo
, 
ä“_i
->
ä“_£cm­
))

471 
ä“_i
->
ä“_£ùiÚs
--;

473 
	`¥š_uÆock
(&
ä“_i
->
£gm­_lock
);

474 
	}
}

476 
šlše
 
	$g‘_s™_b™m­
(
f2fs_sb_šfo
 *
sbi
,

477 *
d¡_addr
)

479 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

481 #ifdeà
CONFIG_F2FS_CHECK_FS


482 ià(
	`memcmp
(
s™_i
->
s™_b™m­
, s™_i->
s™_b™m­_mœ
,

483 
s™_i
->
b™m­_size
))

484 
	`f2fs_bug_Ú
(
sbi
, 1);

486 
	`memıy
(
d¡_addr
, 
s™_i
->
s™_b™m­
, s™_i->
b™m­_size
);

487 
	}
}

489 
šlše
 
block_t
 
	$wr™‹n_block_couÁ
(
f2fs_sb_šfo
 *
sbi
)

491  
	`SIT_I
(
sbi
)->
wr™‹n_v®id_blocks
;

492 
	}
}

494 
šlše
 
	$ä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

496  
	`FREE_I
(
sbi
)->
ä“_£gm’ts
;

497 
	}
}

499 
šlše
 
	$»£rved_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

501  
	`SM_I
(
sbi
)->
»£rved_£gm’ts
;

502 
	}
}

504 
šlše
 
	$ä“_£ùiÚs
(
f2fs_sb_šfo
 *
sbi
)

506  
	`FREE_I
(
sbi
)->
ä“_£ùiÚs
;

507 
	}
}

509 
šlše
 
	$´eä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

511  
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
PRE
];

512 
	}
}

514 
šlše
 
	$dœty_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

516  
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_HOT_DATA
] +

517 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_WARM_DATA
] +

518 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_COLD_DATA
] +

519 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_HOT_NODE
] +

520 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_WARM_NODE
] +

521 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_COLD_NODE
];

522 
	}
}

524 
šlše
 
	$ov”´ovisiÚ_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

526  
	`SM_I
(
sbi
)->
ovp_£gm’ts
;

527 
	}
}

529 
šlše
 
	$»£rved_£ùiÚs
(
f2fs_sb_šfo
 *
sbi
)

531  
	`GET_SEC_FROM_SEG
(
sbi
, ()
	`»£rved_£gm’ts
(sbi));

532 
	}
}

534 
šlše
 
boŞ
 
	$has_cur£g_’ough_¥aû
(
f2fs_sb_šfo
 *
sbi
)

536 
node_blocks
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
) +

537 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
);

538 
d’t_blocks
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
);

539 
£gno
, 
Ëá_blocks
;

540 
i
;

543 
i
 = 
CURSEG_HOT_NODE
; i <ğ
CURSEG_COLD_NODE
; i++) {

544 
£gno
 = 
	`CURSEG_I
(
sbi
, 
i
)->segno;

545 
Ëá_blocks
 = 
sbi
->
blocks_³r_£g
 -

546 
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->
ck±_v®id_blocks
;

548 ià(
node_blocks
 > 
Ëá_blocks
)

549  
çl£
;

553 
£gno
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
)->segno;

554 
Ëá_blocks
 = 
sbi
->
blocks_³r_£g
 -

555 
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->
ck±_v®id_blocks
;

556 ià(
d’t_blocks
 > 
Ëá_blocks
)

557  
çl£
;

558  
Œue
;

559 
	}
}

561 
šlše
 
boŞ
 
	$has_nÙ_’ough_ä“_£cs
(
f2fs_sb_šfo
 *
sbi
,

562 
ä“d
, 
Ãeded
)

564 
node_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_NODES
);

565 
d’t_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_DENTS
);

566 
im‘a_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_IMETA
);

568 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

569  
çl£
;

571 ià(
	`ä“_£ùiÚs
(
sbi
è+ 
ä“d
 =ğ
	`»£rved_£ùiÚs
(sbiè+ 
Ãeded
 &&

572 
	`has_cur£g_’ough_¥aû
(
sbi
))

573  
çl£
;

574  (
	`ä“_£ùiÚs
(
sbi
è+ 
ä“d
) <=

575 (
node_£cs
 + 2 * 
d’t_£cs
 + 
im‘a_£cs
 +

576 
	`»£rved_£ùiÚs
(
sbi
è+ 
Ãeded
);

577 
	}
}

579 
šlše
 
boŞ
 
	$exûss_´eä“_£gs
(
f2fs_sb_šfo
 *
sbi
)

581  
	`´eä“_£gm’ts
(
sbi
è> 
	`SM_I
(sbi)->
»c_´eä“_£gm’ts
;

582 
	}
}

584 
šlše
 
	$utiz©iÚ
(
f2fs_sb_šfo
 *
sbi
)

586  
	`div_u64
((
u64
)
	`v®id_u£r_blocks
(
sbi
) * 100,

587 
sbi
->
u£r_block_couÁ
);

588 
	}
}

604 
	#DEF_MIN_IPU_UTIL
 70

	)

605 
	#DEF_MIN_FSYNC_BLOCKS
 8

	)

606 
	#DEF_MIN_HOT_BLOCKS
 16

	)

608 
	#SMALL_VOLUME_SEGMENTS
 (16 * 512è

	)

611 
	mF2FS_IPU_FORCE
,

612 
	mF2FS_IPU_SSR
,

613 
	mF2FS_IPU_UTIL
,

614 
	mF2FS_IPU_SSR_UTIL
,

615 
	mF2FS_IPU_FSYNC
,

616 
	mF2FS_IPU_ASYNC
,

619 
šlše
 
	$cur£g_£gno
(
f2fs_sb_šfo
 *
sbi
,

620 
ty³
)

622 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

623  
cur£g
->
£gno
;

624 
	}
}

626 
šlše
 
	$cur£g_®loc_ty³
(
f2fs_sb_šfo
 *
sbi
,

627 
ty³
)

629 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

630  
cur£g
->
®loc_ty³
;

631 
	}
}

633 
šlše
 
	$cur£g_blkoff
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

635 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

636  
cur£g
->
Ãxt_blkoff
;

637 
	}
}

639 
šlše
 
	$check_£g_¿nge
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

641 
	`f2fs_bug_Ú
(
sbi
, 
£gno
 > 
	`TOTAL_SEGS
(sbi) - 1);

642 
	}
}

644 
šlše
 
	$v”ify_block_addr
(
f2fs_io_šfo
 *
fio
, 
block_t
 
blk_addr
)

646 
f2fs_sb_šfo
 *
sbi
 = 
fio
->sbi;

648 ià(
	`PAGE_TYPE_OF_BIO
(
fio
->
ty³
è=ğ
META
 &&

649 (!
	`is_»ad_io
(
fio
->
İ
è|| fio->
is_m‘a
))

650 
	`BUG_ON
(
blk_addr
 < 
	`SEG0_BLKADDR
(
sbi
) ||

651 
blk_addr
 >ğ
	`MAIN_BLKADDR
(
sbi
));

653 
	`BUG_ON
(
blk_addr
 < 
	`MAIN_BLKADDR
(
sbi
) ||

654 
blk_addr
 >ğ
	`MAX_BLKADDR
(
sbi
));

655 
	}
}

660 
šlše
 
	$check_block_couÁ
(
f2fs_sb_šfo
 *
sbi
,

661 
£gno
, 
f2fs_s™_’Œy
 *
¿w_s™
)

663 #ifdeà
CONFIG_F2FS_CHECK_FS


664 
boŞ
 
is_v®id
 = 
	`‹¡_b™_Ë
(0, 
¿w_s™
->
v®id_m­
è? 
Œue
 : 
çl£
;

665 
v®id_blocks
 = 0;

666 
cur_pos
 = 0, 
Ãxt_pos
;

670 ià(
is_v®id
) {

671 
Ãxt_pos
 = 
	`fšd_Ãxt_z”o_b™_Ë
(&
¿w_s™
->
v®id_m­
,

672 
sbi
->
blocks_³r_£g
,

673 
cur_pos
);

674 
v®id_blocks
 +ğ
Ãxt_pos
 - 
cur_pos
;

676 
Ãxt_pos
 = 
	`fšd_Ãxt_b™_Ë
(&
¿w_s™
->
v®id_m­
,

677 
sbi
->
blocks_³r_£g
,

678 
cur_pos
);

679 
cur_pos
 = 
Ãxt_pos
;

680 
is_v®id
 = !is_valid;

681 } 
cur_pos
 < 
sbi
->
blocks_³r_£g
);

683 ià(
	`uÆik–y
(
	`GET_SIT_VBLOCKS
(
¿w_s™
è!ğ
v®id_blocks
)) {

684 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
,

686 
	`GET_SIT_VBLOCKS
(
¿w_s™
), 
v®id_blocks
);

687 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

688  -
EINVAL
;

692 ià(
	`uÆik–y
(
	`GET_SIT_VBLOCKS
(
¿w_s™
è> 
sbi
->
blocks_³r_£g


693 || 
£gno
 > 
	`TOTAL_SEGS
(
sbi
) - 1)) {

694 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
,

696 
	`GET_SIT_VBLOCKS
(
¿w_s™
), 
£gno
);

697 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

698  -
EINVAL
;

701 
	}
}

703 
šlše
 
pgoff_t
 
	$cu¼’t_s™_addr
(
f2fs_sb_šfo
 *
sbi
,

704 
¡¬t
)

706 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

707 
off£t
 = 
	`SIT_BLOCK_OFFSET
(
¡¬t
);

708 
block_t
 
blk_addr
 = 
s™_i
->
s™_ba£_addr
 + 
off£t
;

710 
	`check_£g_¿nge
(
sbi
, 
¡¬t
);

712 #ifdeà
CONFIG_F2FS_CHECK_FS


713 ià(
	`f2fs_‹¡_b™
(
off£t
, 
s™_i
->
s™_b™m­
) !=

714 
	`f2fs_‹¡_b™
(
off£t
, 
s™_i
->
s™_b™m­_mœ
))

715 
	`f2fs_bug_Ú
(
sbi
, 1);

719 ià(
	`f2fs_‹¡_b™
(
off£t
, 
s™_i
->
s™_b™m­
))

720 
blk_addr
 +ğ
s™_i
->
s™_blocks
;

722  
blk_addr
;

723 
	}
}

725 
šlše
 
pgoff_t
 
	$Ãxt_s™_addr
(
f2fs_sb_šfo
 *
sbi
,

726 
pgoff_t
 
block_addr
)

728 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

729 
block_addr
 -ğ
s™_i
->
s™_ba£_addr
;

730 ià(
block_addr
 < 
s™_i
->
s™_blocks
)

731 
block_addr
 +ğ
s™_i
->
s™_blocks
;

733 
block_addr
 -ğ
s™_i
->
s™_blocks
;

735  
block_addr
 + 
s™_i
->
s™_ba£_addr
;

736 
	}
}

738 
šlše
 
	$£t_to_Ãxt_s™
(
s™_šfo
 *
s™_i
, 
¡¬t
)

740 
block_off
 = 
	`SIT_BLOCK_OFFSET
(
¡¬t
);

742 
	`f2fs_chªge_b™
(
block_off
, 
s™_i
->
s™_b™m­
);

743 #ifdeà
CONFIG_F2FS_CHECK_FS


744 
	`f2fs_chªge_b™
(
block_off
, 
s™_i
->
s™_b™m­_mœ
);

746 
	}
}

748 
šlše
 
	$g‘_mtime
(
f2fs_sb_šfo
 *
sbi
,

749 
boŞ
 
ba£_time
)

751 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

752 
time64_t
 
diff
, 
now
 = 
	`ktime_g‘_»®_£cÚds
();

754 ià(
now
 >ğ
s™_i
->
mouÁed_time
)

755  
s™_i
->
–­£d_time
 + 
now
 - s™_i->
mouÁed_time
;

758 ià(!
ba£_time
) {

759 
diff
 = 
s™_i
->
mouÁed_time
 - 
now
;

760 ià(
s™_i
->
–­£d_time
 >ğ
diff
)

761  
s™_i
->
–­£d_time
 - 
diff
;

764  
s™_i
->
–­£d_time
;

765 
	}
}

767 
šlše
 
	$£t_summ¬y
(
f2fs_summ¬y
 *
sum
, 
nid_t
 
nid
,

768 
ofs_š_node
, 
v”siÚ
)

770 
sum
->
nid
 = 
	`ıu_to_Ë32
(nid);

771 
sum
->
ofs_š_node
 = 
	`ıu_to_Ë16
(ofs_in_node);

772 
sum
->
v”siÚ
 = version;

773 
	}
}

775 
šlše
 
block_t
 
	$¡¬t_sum_block
(
f2fs_sb_šfo
 *
sbi
)

777  
	`__¡¬t_ı_addr
(
sbi
) +

778 
	`Ë32_to_ıu
(
	`F2FS_CKPT
(
sbi
)->
ı_·ck_¡¬t_sum
);

779 
	}
}

781 
šlše
 
block_t
 
	$sum_blk_addr
(
f2fs_sb_šfo
 *
sbi
, 
ba£
, 
ty³
)

783  
	`__¡¬t_ı_addr
(
sbi
) +

784 
	`Ë32_to_ıu
(
	`F2FS_CKPT
(
sbi
)->
ı_·ck_tÙ®_block_couÁ
)

785 - (
ba£
 + 1è+ 
ty³
;

786 
	}
}

788 
šlše
 
boŞ
 
	$£c_u§ge_check
(
f2fs_sb_šfo
 *
sbi
, 
£úo
)

790 ià(
	`IS_CURSEC
(
sbi
, 
£úo
è|| (sbi->
cur_viùim_£c
 == secno))

791  
Œue
;

792  
çl£
;

793 
	}
}

802 
šlše
 
	$Ä_·ges_to_sk
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

804 ià(
sbi
->
sb
->
s_bdi
->
wb
.
dœty_exûeded
)

807 ià(
ty³
 =ğ
DATA
)

808  
sbi
->
blocks_³r_£g
;

809 ià(
ty³
 =ğ
NODE
)

810  8 * 
sbi
->
blocks_³r_£g
;

811 ià(
ty³
 =ğ
META
)

812  8 * 
BIO_MAX_PAGES
;

815 
	}
}

820 
šlše
 
	$Ä_·ges_to_wr™e
(
f2fs_sb_šfo
 *
sbi
, 
ty³
,

821 
wr™eback_cÚŒŞ
 *
wbc
)

823 
Ä_to_wr™e
, 
desœed
;

825 ià(
wbc
->
sync_mode
 !ğ
WB_SYNC_NONE
)

828 
Ä_to_wr™e
 = 
wbc
->nr_to_write;

829 
desœed
 = 
BIO_MAX_PAGES
;

830 ià(
ty³
 =ğ
NODE
)

831 
desœed
 <<= 1;

833 
wbc
->
Ä_to_wr™e
 = 
desœed
;

834  
desœed
 - 
Ä_to_wr™e
;

835 
	}
}

837 
šlše
 
	$wake_up_disÿrd_th»ad
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
fÜû
)

839 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

840 
boŞ
 
wakeup
 = 
çl£
;

841 
i
;

843 ià(
fÜû
)

844 
wake_up
;

846 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

847 
i
 = 
MAX_PLIST_NUM
 - 1; i >= 0; i--) {

848 ià(
i
 + 1 < 
dcc
->
disÿrd_g¿nuÏr™y
)

850 ià(!
	`li¡_em±y
(&
dcc
->
³nd_li¡
[
i
])) {

851 
wakeup
 = 
Œue
;

855 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

856 ià(!
wakeup
)

858 
wake_up
:

859 
dcc
->
disÿrd_wake
 = 1;

860 
	`wake_up_š‹¼u±ibË_®l
(&
dcc
->
disÿrd_wa™_queue
);

861 
	}
}

	@fs/f2fs/shrinker.c

12 
	~<lšux/fs.h
>

13 
	~<lšux/f2fs_fs.h
>

15 
	~"f2fs.h
"

16 
	~"node.h
"

18 
LIST_HEAD
(
f2fs_li¡
);

19 
DEFINE_SPINLOCK
(
f2fs_li¡_lock
);

20 
	gshršk”_run_no
;

22 
	$__couÁ_Çt_’Œ›s
(
f2fs_sb_šfo
 *
sbi
)

24 
couÁ
 = 
	`NM_I
(
sbi
)->
Çt_út
 - NM_I(sbi)->
dœty_Çt_út
;

26  
couÁ
 > 0 ? count : 0;

27 
	}
}

29 
	$__couÁ_ä“_nids
(
f2fs_sb_šfo
 *
sbi
)

31 
couÁ
 = 
	`NM_I
(
sbi
)->
nid_út
[
FREE_NID
] - 
MAX_FREE_NIDS
;

33  
couÁ
 > 0 ? count : 0;

34 
	}
}

36 
	$__couÁ_ex‹Á_ÿche
(
f2fs_sb_šfo
 *
sbi
)

38  
	`©omic_»ad
(&
sbi
->
tÙ®_zomb›_Œ“
) +

39 
	`©omic_»ad
(&
sbi
->
tÙ®_ext_node
);

40 
	}
}

42 
	$f2fs_shršk_couÁ
(
shršk”
 *
shršk
,

43 
shršk_cÚŒŞ
 *
sc
)

45 
f2fs_sb_šfo
 *
sbi
;

46 
li¡_h—d
 *
p
;

47 
couÁ
 = 0;

49 
	`¥š_lock
(&
f2fs_li¡_lock
);

50 
p
 = 
f2fs_li¡
.
Ãxt
;

51 
p
 !ğ&
f2fs_li¡
) {

52 
sbi
 = 
	`li¡_’Œy
(
p
, 
f2fs_sb_šfo
, 
s_li¡
);

55 ià(!
	`mu‹x_Œylock
(&
sbi
->
umouÁ_mu‹x
)) {

56 
p
 =…->
Ãxt
;

59 
	`¥š_uÆock
(&
f2fs_li¡_lock
);

62 
couÁ
 +ğ
	`__couÁ_ex‹Á_ÿche
(
sbi
);

65 
couÁ
 +ğ
	`__couÁ_Çt_’Œ›s
(
sbi
);

68 
couÁ
 +ğ
	`__couÁ_ä“_nids
(
sbi
);

70 
	`¥š_lock
(&
f2fs_li¡_lock
);

71 
p
 =…->
Ãxt
;

72 
	`mu‹x_uÆock
(&
sbi
->
umouÁ_mu‹x
);

74 
	`¥š_uÆock
(&
f2fs_li¡_lock
);

75  
couÁ
;

76 
	}
}

78 
	$f2fs_shršk_sÿn
(
shršk”
 *
shršk
,

79 
shršk_cÚŒŞ
 *
sc
)

81 
Ä
 = 
sc
->
Ä_to_sÿn
;

82 
f2fs_sb_šfo
 *
sbi
;

83 
li¡_h—d
 *
p
;

84 
run_no
;

85 
ä“d
 = 0;

87 
	`¥š_lock
(&
f2fs_li¡_lock
);

89 
run_no
 = ++
shršk”_run_no
;

90 } 
run_no
 == 0);

91 
p
 = 
f2fs_li¡
.
Ãxt
;

92 
p
 !ğ&
f2fs_li¡
) {

93 
sbi
 = 
	`li¡_’Œy
(
p
, 
f2fs_sb_šfo
, 
s_li¡
);

95 ià(
sbi
->
shršk”_run_no
 =ğ
run_no
)

99 ià(!
	`mu‹x_Œylock
(&
sbi
->
umouÁ_mu‹x
)) {

100 
p
 =…->
Ãxt
;

103 
	`¥š_uÆock
(&
f2fs_li¡_lock
);

105 
sbi
->
shršk”_run_no
 = 
run_no
;

108 
ä“d
 +ğ
	`f2fs_shršk_ex‹Á_Œ“
(
sbi
, 
Ä
 >> 1);

111 ià(
ä“d
 < 
Ä
)

112 
ä“d
 +ğ
	`f2fs_Œy_to_ä“_Çts
(
sbi
, 
Ä
 - freed);

115 ià(
ä“d
 < 
Ä
)

116 
ä“d
 +ğ
	`f2fs_Œy_to_ä“_nids
(
sbi
, 
Ä
 - freed);

118 
	`¥š_lock
(&
f2fs_li¡_lock
);

119 
p
 =…->
Ãxt
;

120 
	`li¡_move_
(&
sbi
->
s_li¡
, &
f2fs_li¡
);

121 
	`mu‹x_uÆock
(&
sbi
->
umouÁ_mu‹x
);

122 ià(
ä“d
 >ğ
Ä
)

125 
	`¥š_uÆock
(&
f2fs_li¡_lock
);

126  
ä“d
;

127 
	}
}

129 
	$f2fs_još_shršk”
(
f2fs_sb_šfo
 *
sbi
)

131 
	`¥š_lock
(&
f2fs_li¡_lock
);

132 
	`li¡_add_
(&
sbi
->
s_li¡
, &
f2fs_li¡
);

133 
	`¥š_uÆock
(&
f2fs_li¡_lock
);

134 
	}
}

136 
	$f2fs_Ëave_shršk”
(
f2fs_sb_šfo
 *
sbi
)

138 
	`f2fs_shršk_ex‹Á_Œ“
(
sbi
, 
	`__couÁ_ex‹Á_ÿche
(sbi));

140 
	`¥š_lock
(&
f2fs_li¡_lock
);

141 
	`li¡_d–
(&
sbi
->
s_li¡
);

142 
	`¥š_uÆock
(&
f2fs_li¡_lock
);

143 
	}
}

	@fs/f2fs/super.c

11 
	~<lšux/moduË.h
>

12 
	~<lšux/š™.h
>

13 
	~<lšux/fs.h
>

14 
	~<lšux/¡©fs.h
>

15 
	~<lšux/bufãr_h—d.h
>

16 
	~<lšux/backšg-dev.h
>

17 
	~<lšux/kth»ad.h
>

18 
	~<lšux/·r£r.h
>

19 
	~<lšux/mouÁ.h
>

20 
	~<lšux/£q_fe.h
>

21 
	~<lšux/´oc_fs.h
>

22 
	~<lšux/¿ndom.h
>

23 
	~<lšux/expÜtfs.h
>

24 
	~<lšux/blkdev.h
>

25 
	~<lšux/quÙaİs.h
>

26 
	~<lšux/f2fs_fs.h
>

27 
	~<lšux/sysfs.h
>

28 
	~<lšux/quÙa.h
>

30 
	~"f2fs.h
"

31 
	~"node.h
"

32 
	~"£gm’t.h
"

33 
	~"x©Œ.h
"

34 
	~"gc.h
"

35 
	~"Œaû.h
"

37 
	#CREATE_TRACE_POINTS


	)

38 
	~<Œaû/ev’ts/f2fs.h
>

40 
kmem_ÿche
 *
	gf2fs_šode_ÿch•
;

42 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


44 *
	gçuÉ_Çme
[
FAULT_MAX
] = {

45 [
FAULT_KMALLOC
] = "kmalloc",

46 [
FAULT_KVMALLOC
] = "kvmalloc",

47 [
FAULT_PAGE_ALLOC
] = "page‡lloc",

48 [
FAULT_PAGE_GET
] = "page get",

49 [
FAULT_ALLOC_BIO
] = "alloc bio",

50 [
FAULT_ALLOC_NID
] = "alloc‚id",

51 [
FAULT_ORPHAN
] = "orphan",

52 [
FAULT_BLOCK
] = "no more block",

53 [
FAULT_DIR_DEPTH
] = "too big dir depth",

54 [
FAULT_EVICT_INODE
] = "evict_inode fail",

55 [
FAULT_TRUNCATE
] = "truncate fail",

56 [
FAULT_IO
] = "IOƒrror",

57 [
FAULT_CHECKPOINT
] = "checkpointƒrror",

60 
	$f2fs_bud_çuÉ_©Œ
(
f2fs_sb_šfo
 *
sbi
,

61 
¿‹
)

63 
f2fs_çuÉ_šfo
 *
ffi
 = &
	`F2FS_OPTION
(
sbi
).
çuÉ_šfo
;

65 ià(
¿‹
) {

66 
	`©omic_£t
(&
ffi
->
šjeù_İs
, 0);

67 
ffi
->
šjeù_¿‹
 = 
¿‹
;

68 
ffi
->
šjeù_ty³
 = (1 << 
FAULT_MAX
) - 1;

70 
	`mem£t
(
ffi
, 0, (
f2fs_çuÉ_šfo
));

72 
	}
}

76 
shršk”
 
	gf2fs_shršk”_šfo
 = {

77 .
sÿn_objeùs
 = 
f2fs_shršk_sÿn
,

78 .
	gcouÁ_objeùs
 = 
f2fs_shršk_couÁ
,

79 .
	g£eks
 = 
DEFAULT_SEEKS
,

83 
	mO±_gc_background
,

84 
	mO±_di§bË_rŞl_fÜw¬d
,

85 
	mO±_nÜecov”y
,

86 
	mO±_disÿrd
,

87 
	mO±_nodisÿrd
,

88 
	mO±_noh—p
,

89 
	mO±_h—p
,

90 
	mO±_u£r_x©Œ
,

91 
	mO±_nou£r_x©Œ
,

92 
	mO±_aş
,

93 
	mO±_nßş
,

94 
	mO±_aùive_logs
,

95 
	mO±_di§bË_ext_id’tify
,

96 
	mO±_šlše_x©Œ
,

97 
	mO±_nošlše_x©Œ
,

98 
	mO±_šlše_x©Œ_size
,

99 
	mO±_šlše_d©a
,

100 
	mO±_šlše_d’Œy
,

101 
	mO±_nošlše_d’Œy
,

102 
	mO±_æush_m”ge
,

103 
	mO±_noæush_m”ge
,

104 
	mO±_nob¬r›r
,

105 
	mO±_ç¡boÙ
,

106 
	mO±_ex‹Á_ÿche
,

107 
	mO±_nÛx‹Á_ÿche
,

108 
	mO±_nošlše_d©a
,

109 
	mO±_d©a_æush
,

110 
	mO±_»£rve_roÙ
,

111 
	mO±_»sgid
,

112 
	mO±_»suid
,

113 
	mO±_mode
,

114 
	mO±_io_size_b™s
,

115 
	mO±_çuÉ_šjeùiÚ
,

116 
	mO±_Ïzytime
,

117 
	mO±_nŞazytime
,

118 
	mO±_quÙa
,

119 
	mO±_noquÙa
,

120 
	mO±_u¤quÙa
,

121 
	mO±_g½quÙa
,

122 
	mO±_´jquÙa
,

123 
	mO±_u¤jquÙa
,

124 
	mO±_g½jquÙa
,

125 
	mO±_´jjquÙa
,

126 
	mO±_offu¤jquÙa
,

127 
	mO±_offg½jquÙa
,

128 
	mO±_ofårjjquÙa
,

129 
	mO±_jqfmt_vfsŞd
,

130 
	mO±_jqfmt_vfsv0
,

131 
	mO±_jqfmt_vfsv1
,

132 
	mO±_whšt
,

133 
	mO±_®loc
,

134 
	mO±_fsync
,

135 
	mO±_‹¡_dummy_’üy±iÚ
,

136 
	mO±_”r
,

139 
m©ch_bË_t
 
	gf2fs_tok’s
 = {

140 {
O±_gc_background
, "background_gc=%s"},

141 {
O±_di§bË_rŞl_fÜw¬d
, "disable_roll_forward"},

142 {
O±_nÜecov”y
, "norecovery"},

143 {
O±_disÿrd
, "discard"},

144 {
O±_nodisÿrd
, "nodiscard"},

145 {
O±_noh—p
, "no_heap"},

146 {
O±_h—p
, "heap"},

147 {
O±_u£r_x©Œ
, "user_xattr"},

148 {
O±_nou£r_x©Œ
, "nouser_xattr"},

149 {
O±_aş
, "acl"},

150 {
O±_nßş
, "noacl"},

151 {
O±_aùive_logs
, "active_logs=%u"},

152 {
O±_di§bË_ext_id’tify
, "disable_ext_identify"},

153 {
O±_šlše_x©Œ
, "inline_xattr"},

154 {
O±_nošlše_x©Œ
, "noinline_xattr"},

155 {
O±_šlše_x©Œ_size
, "inline_xattr_size=%u"},

156 {
O±_šlše_d©a
, "inline_data"},

157 {
O±_šlše_d’Œy
, "inline_dentry"},

158 {
O±_nošlše_d’Œy
, "noinline_dentry"},

159 {
O±_æush_m”ge
, "flush_merge"},

160 {
O±_noæush_m”ge
, "noflush_merge"},

161 {
O±_nob¬r›r
, "nobarrier"},

162 {
O±_ç¡boÙ
, "fastboot"},

163 {
O±_ex‹Á_ÿche
, "extent_cache"},

164 {
O±_nÛx‹Á_ÿche
, "noextent_cache"},

165 {
O±_nošlše_d©a
, "noinline_data"},

166 {
O±_d©a_æush
, "data_flush"},

167 {
O±_»£rve_roÙ
, "reserve_root=%u"},

168 {
O±_»sgid
, "resgid=%u"},

169 {
O±_»suid
, "resuid=%u"},

170 {
O±_mode
, "mode=%s"},

171 {
O±_io_size_b™s
, "io_bits=%u"},

172 {
O±_çuÉ_šjeùiÚ
, "fault_injection=%u"},

173 {
O±_Ïzytime
, "lazytime"},

174 {
O±_nŞazytime
, "nolazytime"},

175 {
O±_quÙa
, "quota"},

176 {
O±_noquÙa
, "noquota"},

177 {
O±_u¤quÙa
, "usrquota"},

178 {
O±_g½quÙa
, "grpquota"},

179 {
O±_´jquÙa
, "prjquota"},

180 {
O±_u¤jquÙa
, "usrjquota=%s"},

181 {
O±_g½jquÙa
, "grpjquota=%s"},

182 {
O±_´jjquÙa
, "prjjquota=%s"},

183 {
O±_offu¤jquÙa
, "usrjquota="},

184 {
O±_offg½jquÙa
, "grpjquota="},

185 {
O±_ofårjjquÙa
, "prjjquota="},

186 {
O±_jqfmt_vfsŞd
, "jqfmt=vfsold"},

187 {
O±_jqfmt_vfsv0
, "jqfmt=vfsv0"},

188 {
O±_jqfmt_vfsv1
, "jqfmt=vfsv1"},

189 {
O±_whšt
, "whint_mode=%s"},

190 {
O±_®loc
, "alloc_mode=%s"},

191 {
O±_fsync
, "fsync_mode=%s"},

192 {
O±_‹¡_dummy_’üy±iÚ
, "test_dummy_encryption"},

193 {
O±_”r
, 
NULL
},

196 
	$f2fs_msg
(
su³r_block
 *
sb
, cÚ¡ *
Ëv–
, cÚ¡ *
fmt
, ...)

198 
va_fÜm©
 
vaf
;

199 
va_li¡
 
¬gs
;

201 
	`va_¡¬t
(
¬gs
, 
fmt
);

202 
vaf
.
fmt
 = fmt;

203 
vaf
.
va
 = &
¬gs
;

204 
	`´štk_¿‹lim™ed
("%sF2FS-f (%s): %pV\n", 
Ëv–
, 
sb
->
s_id
, &
vaf
);

205 
	`va_’d
(
¬gs
);

206 
	}
}

208 
šlše
 
	$lim™_»£rve_roÙ
(
f2fs_sb_šfo
 *
sbi
)

210 
block_t
 
lim™
 = (
sbi
->
u£r_block_couÁ
 << 1) / 1000;

213 ià(
	`‹¡_İt
(
sbi
, 
RESERVE_ROOT
) &&

214 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
 > 
lim™
) {

215 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
 = 
lim™
;

216 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
,

218 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
);

220 ià(!
	`‹¡_İt
(
sbi
, 
RESERVE_ROOT
) &&

221 (!
	`uid_eq
(
	`F2FS_OPTION
(
sbi
).
s_»suid
,

222 
	`make_kuid
(&
š™_u£r_ns
, 
F2FS_DEF_RESUID
)) ||

223 !
	`gid_eq
(
	`F2FS_OPTION
(
sbi
).
s_»sgid
,

224 
	`make_kgid
(&
š™_u£r_ns
, 
F2FS_DEF_RESGID
))))

225 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
,

227 
	`äom_kuid_munged
(&
š™_u£r_ns
,

228 
	`F2FS_OPTION
(
sbi
).
s_»suid
),

229 
	`äom_kgid_munged
(&
š™_u£r_ns
,

230 
	`F2FS_OPTION
(
sbi
).
s_»sgid
));

231 
	}
}

233 
	$š™_Úû
(*
foo
)

235 
f2fs_šode_šfo
 *
fi
 = (f2fs_šode_šfØ*è
foo
;

237 
	`šode_š™_Úû
(&
fi
->
vfs_šode
);

238 
	}
}

240 #ifdeà
CONFIG_QUOTA


241 cÚ¡ * cÚ¡ 
	gquÙ©y³s
[] = 
INITQFNAMES
;

242 
	#QTYPE2NAME
(
t
è(
quÙ©y³s
[t])

	)

243 
	$f2fs_£t_qf_Çme
(
su³r_block
 *
sb
, 
qty³
,

244 
sub¡ršg_t
 *
¬gs
)

246 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

247 *
qÇme
;

248 
»t
 = -
EINVAL
;

250 ià(
	`sb_ªy_quÙa_lßded
(
sb
è&& !
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
]) {

251 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

254  -
EINVAL
;

256 ià(
	`f2fs_sb_has_quÙa_šo
(
sb
)) {

257 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

262 
qÇme
 = 
	`m©ch_¡rdup
(
¬gs
);

263 ià(!
qÇme
) {

264 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

266  -
EINVAL
;

268 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
]) {

269 ià(
	`¡rcmp
(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
], 
qÇme
) == 0)

270 
»t
 = 0;

272 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

274 
	`QTYPE2NAME
(
qty³
));

275 
”rout
;

277 ià(
	`¡rchr
(
qÇme
, '/')) {

278 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

280 
”rout
;

282 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
] = 
qÇme
;

283 
	`£t_İt
(
sbi
, 
QUOTA
);

285 
”rout
:

286 
	`kä“
(
qÇme
);

287  
»t
;

288 
	}
}

290 
	$f2fs_ş—r_qf_Çme
(
su³r_block
 *
sb
, 
qty³
)

292 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

294 ià(
	`sb_ªy_quÙa_lßded
(
sb
è&& 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
]) {

295 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled quota options"

297  -
EINVAL
;

299 
	`kä“
(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
]);

300 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
] = 
NULL
;

302 
	}
}

304 
	$f2fs_check_quÙa_İtiÚs
(
f2fs_sb_šfo
 *
sbi
)

311 ià(
	`‹¡_İt
(
sbi
, 
PRJQUOTA
è&& !
	`f2fs_sb_has_´ojeù_quÙa
(sbi->
sb
)) {

312 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
, "Project quota feature‚otƒnabled. "

316 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
USRQUOTA
] ||

317 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
GRPQUOTA
] ||

318 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
PRJQUOTA
]) {

319 ià(
	`‹¡_İt
(
sbi
, 
USRQUOTA
) &&

320 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
USRQUOTA
])

321 
	`ş—r_İt
(
sbi
, 
USRQUOTA
);

323 ià(
	`‹¡_İt
(
sbi
, 
GRPQUOTA
) &&

324 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
GRPQUOTA
])

325 
	`ş—r_İt
(
sbi
, 
GRPQUOTA
);

327 ià(
	`‹¡_İt
(
sbi
, 
PRJQUOTA
) &&

328 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
PRJQUOTA
])

329 
	`ş—r_İt
(
sbi
, 
PRJQUOTA
);

331 ià(
	`‹¡_İt
(
sbi
, 
GRPQUOTA
è||e¡_İt(sbi, 
USRQUOTA
) ||

332 
	`‹¡_İt
(
sbi
, 
PRJQUOTA
)) {

333 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
, "old‡nd‚ew quota "

338 ià(!
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
) {

339 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
, "journaled quota format "

345 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
->
sb
è&& 
	`F2FS_OPTION
(sbi).
s_jquÙa_fmt
) {

346 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
,

348 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
 = 0;

350 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
->
sb
è&& 
	`f2fs_»adÚly
(sbi->sb)) {

351 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
,

357 
	}
}

360 
	$·r£_İtiÚs
(
su³r_block
 *
sb
, *
İtiÚs
)

362 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

363 
»que¡_queue
 *
q
;

364 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

365 *
p
, *
Çme
;

366 
¬g
 = 0;

367 
kuid_t
 
uid
;

368 
kgid_t
 
gid
;

369 #ifdeà
CONFIG_QUOTA


370 
»t
;

373 ià(!
İtiÚs
)

376 (
p
 = 
	`¡r£p
(&
İtiÚs
, ",")è!ğ
NULL
) {

377 
tok’
;

378 ià(!*
p
)

384 
¬gs
[0].
to
 =‡rgs[0].
äom
 = 
NULL
;

385 
tok’
 = 
	`m©ch_tok’
(
p
, 
f2fs_tok’s
, 
¬gs
);

387 
tok’
) {

388 
O±_gc_background
:

389 
Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

391 ià(!
Çme
)

392  -
ENOMEM
;

393 ià(
	`¡¾’
(
Çme
è=ğ2 && !
	`¡ºcmp
(name, "on", 2)) {

394 
	`£t_İt
(
sbi
, 
BG_GC
);

395 
	`ş—r_İt
(
sbi
, 
FORCE_FG_GC
);

396 } ià(
	`¡¾’
(
Çme
è=ğ3 && !
	`¡ºcmp
(name, "off", 3)) {

397 
	`ş—r_İt
(
sbi
, 
BG_GC
);

398 
	`ş—r_İt
(
sbi
, 
FORCE_FG_GC
);

399 } ià(
	`¡¾’
(
Çme
è=ğ4 && !
	`¡ºcmp
(name, "sync", 4)) {

400 
	`£t_İt
(
sbi
, 
BG_GC
);

401 
	`£t_İt
(
sbi
, 
FORCE_FG_GC
);

403 
	`kä“
(
Çme
);

404  -
EINVAL
;

406 
	`kä“
(
Çme
);

408 
O±_di§bË_rŞl_fÜw¬d
:

409 
	`£t_İt
(
sbi
, 
DISABLE_ROLL_FORWARD
);

411 
O±_nÜecov”y
:

413 
	`£t_İt
(
sbi
, 
DISABLE_ROLL_FORWARD
);

414 ià(!
	`f2fs_»adÚly
(
sb
))

415  -
EINVAL
;

417 
O±_disÿrd
:

418 
q
 = 
	`bdev_g‘_queue
(
sb
->
s_bdev
);

419 ià(
	`blk_queue_disÿrd
(
q
)) {

420 
	`£t_İt
(
sbi
, 
DISCARD
);

421 } ià(!
	`f2fs_sb_has_blkzÚed
(
sb
)) {

422 
	`f2fs_msg
(
sb
, 
KERN_WARNING
,

427 
O±_nodisÿrd
:

428 ià(
	`f2fs_sb_has_blkzÚed
(
sb
)) {

429 
	`f2fs_msg
(
sb
, 
KERN_WARNING
,

431  -
EINVAL
;

433 
	`ş—r_İt
(
sbi
, 
DISCARD
);

435 
O±_noh—p
:

436 
	`£t_İt
(
sbi
, 
NOHEAP
);

438 
O±_h—p
:

439 
	`ş—r_İt
(
sbi
, 
NOHEAP
);

441 #ifdeà
CONFIG_F2FS_FS_XATTR


442 
O±_u£r_x©Œ
:

443 
	`£t_İt
(
sbi
, 
XATTR_USER
);

445 
O±_nou£r_x©Œ
:

446 
	`ş—r_İt
(
sbi
, 
XATTR_USER
);

448 
O±_šlše_x©Œ
:

449 
	`£t_İt
(
sbi
, 
INLINE_XATTR
);

451 
O±_nošlše_x©Œ
:

452 
	`ş—r_İt
(
sbi
, 
INLINE_XATTR
);

454 
O±_šlše_x©Œ_size
:

455 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

456  -
EINVAL
;

457 
	`£t_İt
(
sbi
, 
INLINE_XATTR_SIZE
);

458 
	`F2FS_OPTION
(
sbi
).
šlše_x©Œ_size
 = 
¬g
;

461 
O±_u£r_x©Œ
:

462 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

465 
O±_nou£r_x©Œ
:

466 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

469 
O±_šlše_x©Œ
:

470 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

473 
O±_nošlše_x©Œ
:

474 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

478 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


479 
O±_aş
:

480 
	`£t_İt
(
sbi
, 
POSIX_ACL
);

482 
O±_nßş
:

483 
	`ş—r_İt
(
sbi
, 
POSIX_ACL
);

486 
O±_aş
:

487 
	`f2fs_msg
(
sb
, 
KERN_INFO
, "acl options‚ot supported");

489 
O±_nßş
:

490 
	`f2fs_msg
(
sb
, 
KERN_INFO
, "noacl options‚ot supported");

493 
O±_aùive_logs
:

494 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

495  -
EINVAL
;

496 ià(
¬g
 !ğ2 &&‡rg !ğ4 &&‡rg !ğ
NR_CURSEG_TYPE
)

497  -
EINVAL
;

498 
	`F2FS_OPTION
(
sbi
).
aùive_logs
 = 
¬g
;

500 
O±_di§bË_ext_id’tify
:

501 
	`£t_İt
(
sbi
, 
DISABLE_EXT_IDENTIFY
);

503 
O±_šlše_d©a
:

504 
	`£t_İt
(
sbi
, 
INLINE_DATA
);

506 
O±_šlše_d’Œy
:

507 
	`£t_İt
(
sbi
, 
INLINE_DENTRY
);

509 
O±_nošlše_d’Œy
:

510 
	`ş—r_İt
(
sbi
, 
INLINE_DENTRY
);

512 
O±_æush_m”ge
:

513 
	`£t_İt
(
sbi
, 
FLUSH_MERGE
);

515 
O±_noæush_m”ge
:

516 
	`ş—r_İt
(
sbi
, 
FLUSH_MERGE
);

518 
O±_nob¬r›r
:

519 
	`£t_İt
(
sbi
, 
NOBARRIER
);

521 
O±_ç¡boÙ
:

522 
	`£t_İt
(
sbi
, 
FASTBOOT
);

524 
O±_ex‹Á_ÿche
:

525 
	`£t_İt
(
sbi
, 
EXTENT_CACHE
);

527 
O±_nÛx‹Á_ÿche
:

528 
	`ş—r_İt
(
sbi
, 
EXTENT_CACHE
);

530 
O±_nošlše_d©a
:

531 
	`ş—r_İt
(
sbi
, 
INLINE_DATA
);

533 
O±_d©a_æush
:

534 
	`£t_İt
(
sbi
, 
DATA_FLUSH
);

536 
O±_»£rve_roÙ
:

537 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

538  -
EINVAL
;

539 ià(
	`‹¡_İt
(
sbi
, 
RESERVE_ROOT
)) {

540 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

542 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
);

544 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
 = 
¬g
;

545 
	`£t_İt
(
sbi
, 
RESERVE_ROOT
);

548 
O±_»suid
:

549 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

550  -
EINVAL
;

551 
uid
 = 
	`make_kuid
(
	`cu¼’t_u£r_ns
(), 
¬g
);

552 ià(!
	`uid_v®id
(
uid
)) {

553 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

554 "Inv®id uid v®u%d", 
¬g
);

555  -
EINVAL
;

557 
	`F2FS_OPTION
(
sbi
).
s_»suid
 = 
uid
;

559 
O±_»sgid
:

560 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

561  -
EINVAL
;

562 
gid
 = 
	`make_kgid
(
	`cu¼’t_u£r_ns
(), 
¬g
);

563 ià(!
	`gid_v®id
(
gid
)) {

564 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

565 "Inv®id gid v®u%d", 
¬g
);

566  -
EINVAL
;

568 
	`F2FS_OPTION
(
sbi
).
s_»sgid
 = 
gid
;

570 
O±_mode
:

571 
Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

573 ià(!
Çme
)

574  -
ENOMEM
;

575 ià(
	`¡¾’
(
Çme
) == 8 &&

576 !
	`¡ºcmp
(
Çme
, "adaptive", 8)) {

577 ià(
	`f2fs_sb_has_blkzÚed
(
sb
)) {

578 
	`f2fs_msg
(
sb
, 
KERN_WARNING
,

581 
	`kä“
(
Çme
);

582  -
EINVAL
;

584 
	`£t_İt_mode
(
sbi
, 
F2FS_MOUNT_ADAPTIVE
);

585 } ià(
	`¡¾’
(
Çme
) == 3 &&

586 !
	`¡ºcmp
(
Çme
, "lfs", 3)) {

587 
	`£t_İt_mode
(
sbi
, 
F2FS_MOUNT_LFS
);

589 
	`kä“
(
Çme
);

590  -
EINVAL
;

592 
	`kä“
(
Çme
);

594 
O±_io_size_b™s
:

595 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

596  -
EINVAL
;

597 ià(
¬g
 > 
	`__og2_u32
(
BIO_MAX_PAGES
)) {

598 
	`f2fs_msg
(
sb
, 
KERN_WARNING
,

600 1 << 
¬g
, 
BIO_MAX_PAGES
);

601  -
EINVAL
;

603 
	`F2FS_OPTION
(
sbi
).
wr™e_io_size_b™s
 = 
¬g
;

605 
O±_çuÉ_šjeùiÚ
:

606 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

607  -
EINVAL
;

608 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


609 
	`f2fs_bud_çuÉ_©Œ
(
sbi
, 
¬g
);

610 
	`£t_İt
(
sbi
, 
FAULT_INJECTION
);

612 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

616 
O±_Ïzytime
:

617 
sb
->
s_æags
 |ğ
SB_LAZYTIME
;

619 
O±_nŞazytime
:

620 
sb
->
s_æags
 &ğ~
SB_LAZYTIME
;

622 #ifdeà
CONFIG_QUOTA


623 
O±_quÙa
:

624 
O±_u¤quÙa
:

625 
	`£t_İt
(
sbi
, 
USRQUOTA
);

627 
O±_g½quÙa
:

628 
	`£t_İt
(
sbi
, 
GRPQUOTA
);

630 
O±_´jquÙa
:

631 
	`£t_İt
(
sbi
, 
PRJQUOTA
);

633 
O±_u¤jquÙa
:

634 
»t
 = 
	`f2fs_£t_qf_Çme
(
sb
, 
USRQUOTA
, &
¬gs
[0]);

635 ià(
»t
)

636  
»t
;

638 
O±_g½jquÙa
:

639 
»t
 = 
	`f2fs_£t_qf_Çme
(
sb
, 
GRPQUOTA
, &
¬gs
[0]);

640 ià(
»t
)

641  
»t
;

643 
O±_´jjquÙa
:

644 
»t
 = 
	`f2fs_£t_qf_Çme
(
sb
, 
PRJQUOTA
, &
¬gs
[0]);

645 ià(
»t
)

646  
»t
;

648 
O±_offu¤jquÙa
:

649 
»t
 = 
	`f2fs_ş—r_qf_Çme
(
sb
, 
USRQUOTA
);

650 ià(
»t
)

651  
»t
;

653 
O±_offg½jquÙa
:

654 
»t
 = 
	`f2fs_ş—r_qf_Çme
(
sb
, 
GRPQUOTA
);

655 ià(
»t
)

656  
»t
;

658 
O±_ofårjjquÙa
:

659 
»t
 = 
	`f2fs_ş—r_qf_Çme
(
sb
, 
PRJQUOTA
);

660 ià(
»t
)

661  
»t
;

663 
O±_jqfmt_vfsŞd
:

664 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
 = 
QFMT_VFS_OLD
;

666 
O±_jqfmt_vfsv0
:

667 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
 = 
QFMT_VFS_V0
;

669 
O±_jqfmt_vfsv1
:

670 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
 = 
QFMT_VFS_V1
;

672 
O±_noquÙa
:

673 
	`ş—r_İt
(
sbi
, 
QUOTA
);

674 
	`ş—r_İt
(
sbi
, 
USRQUOTA
);

675 
	`ş—r_İt
(
sbi
, 
GRPQUOTA
);

676 
	`ş—r_İt
(
sbi
, 
PRJQUOTA
);

679 
O±_quÙa
:

680 
O±_u¤quÙa
:

681 
O±_g½quÙa
:

682 
O±_´jquÙa
:

683 
O±_u¤jquÙa
:

684 
O±_g½jquÙa
:

685 
O±_´jjquÙa
:

686 
O±_offu¤jquÙa
:

687 
O±_offg½jquÙa
:

688 
O±_ofårjjquÙa
:

689 
O±_jqfmt_vfsŞd
:

690 
O±_jqfmt_vfsv0
:

691 
O±_jqfmt_vfsv1
:

692 
O±_noquÙa
:

693 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

697 
O±_whšt
:

698 
Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

699 ià(!
Çme
)

700  -
ENOMEM
;

701 ià(
	`¡¾’
(
Çme
) == 10 &&

702 !
	`¡ºcmp
(
Çme
, "user-based", 10)) {

703 
	`F2FS_OPTION
(
sbi
).
whšt_mode
 = 
WHINT_MODE_USER
;

704 } ià(
	`¡¾’
(
Çme
) == 3 &&

705 !
	`¡ºcmp
(
Çme
, "off", 3)) {

706 
	`F2FS_OPTION
(
sbi
).
whšt_mode
 = 
WHINT_MODE_OFF
;

707 } ià(
	`¡¾’
(
Çme
) == 8 &&

708 !
	`¡ºcmp
(
Çme
, "fs-based", 8)) {

709 
	`F2FS_OPTION
(
sbi
).
whšt_mode
 = 
WHINT_MODE_FS
;

711 
	`kä“
(
Çme
);

712  -
EINVAL
;

714 
	`kä“
(
Çme
);

716 
O±_®loc
:

717 
Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

718 ià(!
Çme
)

719  -
ENOMEM
;

721 ià(
	`¡¾’
(
Çme
) == 7 &&

722 !
	`¡ºcmp
(
Çme
, "default", 7)) {

723 
	`F2FS_OPTION
(
sbi
).
®loc_mode
 = 
ALLOC_MODE_DEFAULT
;

724 } ià(
	`¡¾’
(
Çme
) == 5 &&

725 !
	`¡ºcmp
(
Çme
, "reuse", 5)) {

726 
	`F2FS_OPTION
(
sbi
).
®loc_mode
 = 
ALLOC_MODE_REUSE
;

728 
	`kä“
(
Çme
);

729  -
EINVAL
;

731 
	`kä“
(
Çme
);

733 
O±_fsync
:

734 
Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

735 ià(!
Çme
)

736  -
ENOMEM
;

737 ià(
	`¡¾’
(
Çme
) == 5 &&

738 !
	`¡ºcmp
(
Çme
, "posix", 5)) {

739 
	`F2FS_OPTION
(
sbi
).
fsync_mode
 = 
FSYNC_MODE_POSIX
;

740 } ià(
	`¡¾’
(
Çme
) == 6 &&

741 !
	`¡ºcmp
(
Çme
, "strict", 6)) {

742 
	`F2FS_OPTION
(
sbi
).
fsync_mode
 = 
FSYNC_MODE_STRICT
;

743 } ià(
	`¡¾’
(
Çme
) == 9 &&

744 !
	`¡ºcmp
(
Çme
, "nobarrier", 9)) {

745 
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =

746 
FSYNC_MODE_NOBARRIER
;

748 
	`kä“
(
Çme
);

749  -
EINVAL
;

751 
	`kä“
(
Çme
);

753 
O±_‹¡_dummy_’üy±iÚ
:

754 #ifdeà
CONFIG_F2FS_FS_ENCRYPTION


755 ià(!
	`f2fs_sb_has_’üy±
(
sb
)) {

756 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Encrypt feature is off");

757  -
EINVAL
;

760 
	`F2FS_OPTION
(
sbi
).
‹¡_dummy_’üy±iÚ
 = 
Œue
;

761 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

764 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

769 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

771 
p
);

772  -
EINVAL
;

775 #ifdeà
CONFIG_QUOTA


776 ià(
	`f2fs_check_quÙa_İtiÚs
(
sbi
))

777  -
EINVAL
;

780 ià(
	`F2FS_IO_SIZE_BITS
(
sbi
è&& !
	`‹¡_İt
(sbi, 
LFS
)) {

781 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

783 
	`F2FS_IO_SIZE_KB
(
sbi
));

784  -
EINVAL
;

787 ià(
	`‹¡_İt
(
sbi
, 
INLINE_XATTR_SIZE
)) {

788 ià(!
	`f2fs_sb_has_exŒa_©Œ
(
sb
) ||

789 !
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sb
)) {

790 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

793  -
EINVAL
;

795 ià(!
	`‹¡_İt
(
sbi
, 
INLINE_XATTR
)) {

796 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

799  -
EINVAL
;

801 ià(!
	`F2FS_OPTION
(
sbi
).
šlše_x©Œ_size
 ||

802 
	`F2FS_OPTION
(
sbi
).
šlše_x©Œ_size
 >=

803 
DEF_ADDRS_PER_INODE
 -

804 
F2FS_TOTAL_EXTRA_ATTR_SIZE
 -

805 
DEF_INLINE_RESERVED_SIZE
 -

806 
DEF_MIN_INLINE_SIZE
) {

807 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

809  -
EINVAL
;

816 ià(
	`F2FS_OPTION
(
sbi
).
aùive_logs
 !ğ
NR_CURSEG_TYPE
)

817 
	`F2FS_OPTION
(
sbi
).
whšt_mode
 = 
WHINT_MODE_OFF
;

819 
	}
}

821 
šode
 *
	$f2fs_®loc_šode
(
su³r_block
 *
sb
)

823 
f2fs_šode_šfo
 *
fi
;

825 
fi
 = 
	`kmem_ÿche_®loc
(
f2fs_šode_ÿch•
, 
GFP_F2FS_ZERO
);

826 ià(!
fi
)

827  
NULL
;

829 
	`š™_Úû
((*è
fi
);

832 
	`©omic_£t
(&
fi
->
dœty_·ges
, 0);

833 
	`š™_rw£m
(&
fi
->
i_£m
);

834 
	`INIT_LIST_HEAD
(&
fi
->
dœty_li¡
);

835 
	`INIT_LIST_HEAD
(&
fi
->
gdœty_li¡
);

836 
	`INIT_LIST_HEAD
(&
fi
->
šmem_i¡
);

837 
	`INIT_LIST_HEAD
(&
fi
->
šmem_·ges
);

838 
	`mu‹x_š™
(&
fi
->
šmem_lock
);

839 
	`š™_rw£m
(&
fi
->
i_gc_rw£m
[
READ
]);

840 
	`š™_rw£m
(&
fi
->
i_gc_rw£m
[
WRITE
]);

841 
	`š™_rw£m
(&
fi
->
i_mm­_£m
);

842 
	`š™_rw£m
(&
fi
->
i_x©Œ_£m
);

845 
fi
->
i_dœ_Ëv–
 = 
	`F2FS_SB
(
sb
)->
dœ_Ëv–
;

847  &
fi
->
vfs_šode
;

848 
	}
}

850 
	$f2fs_drİ_šode
(
šode
 *inode)

852 
»t
;

860 ià((!
	`šode_unhashed
(
šode
è&& inode->
i_¡©e
 & 
I_SYNC
)) {

861 ià(!
šode
->
i_Æšk
 && !
	`is_bad_šode
(inode)) {

863 
	`©omic_šc
(&
šode
->
i_couÁ
);

864 
	`¥š_uÆock
(&
šode
->
i_lock
);

867 ià(
	`f2fs_is_©omic_fe
(
šode
))

868 
	`f2fs_drİ_šmem_·ges
(
šode
);

871 
	`f2fs_de¡roy_ex‹Á_node
(
šode
);

873 
	`sb_¡¬t_štwr™e
(
šode
->
i_sb
);

874 
	`f2fs_i_size_wr™e
(
šode
, 0);

876 ià(
	`F2FS_HAS_BLOCKS
(
šode
))

877 
	`f2fs_Œunÿ‹
(
šode
);

879 
	`sb_’d_štwr™e
(
šode
->
i_sb
);

881 
	`¥š_lock
(&
šode
->
i_lock
);

882 
	`©omic_dec
(&
šode
->
i_couÁ
);

884 
	`Œaû_f2fs_drİ_šode
(
šode
, 0);

887 
»t
 = 
	`g’”ic_drİ_šode
(
šode
);

888 
	`Œaû_f2fs_drİ_šode
(
šode
, 
»t
);

889  
»t
;

890 
	}
}

892 
	$f2fs_šode_dœt›d
(
šode
 *šode, 
boŞ
 
sync
)

894 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

895 
»t
 = 0;

897 
	`¥š_lock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

898 ià(
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
)) {

899 
»t
 = 1;

901 
	`£t_šode_æag
(
šode
, 
FI_DIRTY_INODE
);

902 
	`¡©_šc_dœty_šode
(
sbi
, 
DIRTY_META
);

904 ià(
sync
 && 
	`li¡_em±y
(&
	`F2FS_I
(
šode
)->
gdœty_li¡
)) {

905 
	`li¡_add_
(&
	`F2FS_I
(
šode
)->
gdœty_li¡
,

906 &
sbi
->
šode_li¡
[
DIRTY_META
]);

907 
	`šc_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_IMETA
);

909 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

910  
»t
;

911 
	}
}

913 
	$f2fs_šode_synûd
(
šode
 *inode)

915 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

917 
	`¥š_lock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

918 ià(!
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
)) {

919 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

922 ià(!
	`li¡_em±y
(&
	`F2FS_I
(
šode
)->
gdœty_li¡
)) {

923 
	`li¡_d–_š™
(&
	`F2FS_I
(
šode
)->
gdœty_li¡
);

924 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_IMETA
);

926 
	`ş—r_šode_æag
(
šode
, 
FI_DIRTY_INODE
);

927 
	`ş—r_šode_æag
(
šode
, 
FI_AUTO_RECOVER
);

928 
	`¡©_dec_dœty_šode
(
	`F2FS_I_SB
(
šode
), 
DIRTY_META
);

929 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

930 
	}
}

937 
	$f2fs_dœty_šode
(
šode
 *šode, 
æags
)

939 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

941 ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
) ||

942 
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
))

945 ià(
æags
 =ğ
I_DIRTY_TIME
)

948 ià(
	`is_šode_æag_£t
(
šode
, 
FI_AUTO_RECOVER
))

949 
	`ş—r_šode_æag
(
šode
, 
FI_AUTO_RECOVER
);

951 
	`f2fs_šode_dœt›d
(
šode
, 
çl£
);

952 
	}
}

954 
	$f2fs_i_ÿÎback
(
rcu_h—d
 *
h—d
)

956 
šode
 *šodğ
	`cÚš”_of
(
h—d
, šode, 
i_rcu
);

957 
	`kmem_ÿche_ä“
(
f2fs_šode_ÿch•
, 
	`F2FS_I
(
šode
));

958 
	}
}

960 
	$f2fs_de¡roy_šode
(
šode
 *inode)

962 
	`ÿÎ_rcu
(&
šode
->
i_rcu
, 
f2fs_i_ÿÎback
);

963 
	}
}

965 
	$de¡roy_³rıu_šfo
(
f2fs_sb_šfo
 *
sbi
)

967 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
®loc_v®id_block_couÁ
);

968 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
tÙ®_v®id_šode_couÁ
);

969 
	}
}

971 
	$de¡roy_deviû_li¡
(
f2fs_sb_šfo
 *
sbi
)

973 
i
;

975 
i
 = 0; i < 
sbi
->
s_ndevs
; i++) {

976 
	`blkdev_put
(
	`FDEV
(
i
).
bdev
, 
FMODE_EXCL
);

977 #ifdeà
CONFIG_BLK_DEV_ZONED


978 
	`kä“
(
	`FDEV
(
i
).
blkz_ty³
);

981 
	`kä“
(
sbi
->
devs
);

982 
	}
}

984 
	$f2fs_put_su³r
(
su³r_block
 *
sb
)

986 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

987 
i
;

988 
boŞ
 
drİ³d
;

990 
	`f2fs_quÙa_off_umouÁ
(
sb
);

993 
	`mu‹x_lock
(&
sbi
->
umouÁ_mu‹x
);

1000 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_DIRTY
) ||

1001 !
	`is_£t_ck±_æags
(
sbi
, 
CP_UMOUNT_FLAG
)) {

1002 
ı_cÚŒŞ
 
ıc
 = {

1003 .
»asÚ
 = 
CP_UMOUNT
,

1005 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

1009 
drİ³d
 = 
	`f2fs_wa™_disÿrd_bios
(
sbi
);

1011 ià(
	`f2fs_disÿrd_’
(
sbi
è&& !sbi->
disÿrd_blks
 && !
drİ³d
) {

1012 
ı_cÚŒŞ
 
ıc
 = {

1013 .
»asÚ
 = 
CP_UMOUNT
 | 
CP_TRIMMED
,

1015 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

1019 
	`f2fs_de¡roy_¡©s
(
sbi
);

1025 
	`f2fs_»Ëa£_šo_’Œy
(
sbi
, 
Œue
);

1027 
	`f2fs_Ëave_shršk”
(
sbi
);

1028 
	`mu‹x_uÆock
(&
sbi
->
umouÁ_mu‹x
);

1031 
	`f2fs_æush_m”ged_wr™es
(
sbi
);

1033 
	`ut
(
sbi
->
node_šode
);

1034 
	`ut
(
sbi
->
m‘a_šode
);

1037 
	`f2fs_de¡roy_node_mªag”
(
sbi
);

1038 
	`f2fs_de¡roy_£gm’t_mªag”
(
sbi
);

1040 
	`kä“
(
sbi
->
ck±
);

1042 
	`f2fs_uÄegi¡”_sysfs
(
sbi
);

1044 
sb
->
s_fs_šfo
 = 
NULL
;

1045 ià(
sbi
->
s_chksum_driv”
)

1046 
	`üy±o_ä“_shash
(
sbi
->
s_chksum_driv”
);

1047 
	`kä“
(
sbi
->
¿w_su³r
);

1049 
	`de¡roy_deviû_li¡
(
sbi
);

1050 
	`mempoŞ_de¡roy
(
sbi
->
wr™e_io_dummy
);

1051 #ifdeà
CONFIG_QUOTA


1052 
i
 = 0; i < 
MAXQUOTAS
; i++)

1053 
	`kä“
(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
]);

1055 
	`de¡roy_³rıu_šfo
(
sbi
);

1056 
i
 = 0; i < 
NR_PAGE_TYPE
; i++)

1057 
	`kä“
(
sbi
->
wr™e_io
[
i
]);

1058 
	`kä“
(
sbi
);

1059 
	}
}

1061 
	$f2fs_sync_fs
(
su³r_block
 *
sb
, 
sync
)

1063 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

1064 
”r
 = 0;

1066 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1069 
	`Œaû_f2fs_sync_fs
(
sb
, 
sync
);

1071 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

1072  -
EAGAIN
;

1074 ià(
sync
) {

1075 
ı_cÚŒŞ
 
ıc
;

1077 
ıc
.
»asÚ
 = 
	`__g‘_ı_»asÚ
(
sbi
);

1079 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

1080 
”r
 = 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

1081 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

1083 
	`f2fs_Œaû_ios
(
NULL
, 1);

1085  
”r
;

1086 
	}
}

1088 
	$f2fs_ä“ze
(
su³r_block
 *
sb
)

1090 ià(
	`f2fs_»adÚly
(
sb
))

1094 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_SB
(
sb
))))

1095  -
EIO
;

1098 ià(
	`is_sbi_æag_£t
(
	`F2FS_SB
(
sb
), 
SBI_IS_DIRTY
))

1099  -
EINVAL
;

1101 
	}
}

1103 
	$f2fs_unä“ze
(
su³r_block
 *
sb
)

1106 
	}
}

1108 #ifdeà
CONFIG_QUOTA


1109 
	$f2fs_¡©fs_´ojeù
(
su³r_block
 *
sb
,

1110 
k´ojid_t
 
´ojid
, 
k¡©fs
 *
buf
)

1112 
kqid
 
qid
;

1113 
dquÙ
 *dquot;

1114 
u64
 
lim™
;

1115 
u64
 
curblock
;

1117 
qid
 = 
	`make_kqid_´ojid
(
´ojid
);

1118 
dquÙ
 = 
	`dqg‘
(
sb
, 
qid
);

1119 ià(
	`IS_ERR
(
dquÙ
))

1120  
	`PTR_ERR
(
dquÙ
);

1121 
	`¥š_lock
(&
dq_d©a_lock
);

1123 
lim™
 = (
dquÙ
->
dq_dqb
.
dqb_bsoálim™
 ?

1124 
dquÙ
->
dq_dqb
.
dqb_bsoálim™
 :

1125 
dquÙ
->
dq_dqb
.
dqb_bh¬dlim™
è>> 
sb
->
s_blocksize_b™s
;

1126 ià(
lim™
 && 
buf
->
f_blocks
 >†imit) {

1127 
curblock
 = 
dquÙ
->
dq_dqb
.
dqb_cur¥aû
 >> 
sb
->
s_blocksize_b™s
;

1128 
buf
->
f_blocks
 = 
lim™
;

1129 
buf
->
f_bä“
 = buf->
f_bava
 =

1130 (
buf
->
f_blocks
 > 
curblock
) ?

1131 (
buf
->
f_blocks
 - 
curblock
) : 0;

1134 
lim™
 = 
dquÙ
->
dq_dqb
.
dqb_isoálim™
 ?

1135 
dquÙ
->
dq_dqb
.
dqb_isoálim™
 :

1136 
dquÙ
->
dq_dqb
.
dqb_ih¬dlim™
;

1137 ià(
lim™
 && 
buf
->
f_fes
 >†imit) {

1138 
buf
->
f_fes
 = 
lim™
;

1139 
buf
->
f_fä“
 =

1140 (
buf
->
f_fes
 > 
dquÙ
->
dq_dqb
.
dqb_curšodes
) ?

1141 (
buf
->
f_fes
 - 
dquÙ
->
dq_dqb
.
dqb_curšodes
) : 0;

1144 
	`¥š_uÆock
(&
dq_d©a_lock
);

1145 
	`dqput
(
dquÙ
);

1147 
	}
}

1150 
	$f2fs_¡©fs
(
d’Œy
 *d’Œy, 
k¡©fs
 *
buf
)

1152 
su³r_block
 *
sb
 = 
d’Œy
->
d_sb
;

1153 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

1154 
u64
 
id
 = 
	`huge_’code_dev
(
sb
->
s_bdev
->
bd_dev
);

1155 
block_t
 
tÙ®_couÁ
, 
u£r_block_couÁ
, 
¡¬t_couÁ
;

1156 
u64
 
ava_node_couÁ
;

1158 
tÙ®_couÁ
 = 
	`Ë64_to_ıu
(
sbi
->
¿w_su³r
->
block_couÁ
);

1159 
u£r_block_couÁ
 = 
sbi
->user_block_count;

1160 
¡¬t_couÁ
 = 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
£gm’t0_blkaddr
);

1161 
buf
->
f_ty³
 = 
F2FS_SUPER_MAGIC
;

1162 
buf
->
f_bsize
 = 
sbi
->
blocksize
;

1164 
buf
->
f_blocks
 = 
tÙ®_couÁ
 - 
¡¬t_couÁ
;

1165 
buf
->
f_bä“
 = 
u£r_block_couÁ
 - 
	`v®id_u£r_blocks
(
sbi
) -

1166 
sbi
->
cu¼’t_»£rved_blocks
;

1167 ià(
buf
->
f_bä“
 > 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
)

1168 
buf
->
f_bava
 = buf->
f_bä“
 -

1169 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
;

1171 
buf
->
f_bava
 = 0;

1173 
ava_node_couÁ
 = 
sbi
->
tÙ®_node_couÁ
 - sbi->
nquÙa_fes
 -

1174 
F2FS_RESERVED_NODE_NUM
;

1176 ià(
ava_node_couÁ
 > 
u£r_block_couÁ
) {

1177 
buf
->
f_fes
 = 
u£r_block_couÁ
;

1178 
buf
->
f_fä“
 = buf->
f_bava
;

1180 
buf
->
f_fes
 = 
ava_node_couÁ
;

1181 
buf
->
f_fä“
 = 
	`mš
(
ava_node_couÁ
 - 
	`v®id_node_couÁ
(
sbi
),

1182 
buf
->
f_bava
);

1185 
buf
->
f_Çm–’
 = 
F2FS_NAME_LEN
;

1186 
buf
->
f_fsid
.
v®
[0] = (
u32
)
id
;

1187 
buf
->
f_fsid
.
v®
[1] = (
u32
)(
id
 >> 32);

1189 #ifdeà
CONFIG_QUOTA


1190 ià(
	`is_šode_æag_£t
(
d’Œy
->
d_šode
, 
FI_PROJ_INHERIT
) &&

1191 
	`sb_has_quÙa_lim™s_’abËd
(
sb
, 
PRJQUOTA
)) {

1192 
	`f2fs_¡©fs_´ojeù
(
sb
, 
	`F2FS_I
(
d’Œy
->
d_šode
)->
i_´ojid
, 
buf
);

1196 
	}
}

1198 
šlše
 
	$f2fs_show_quÙa_İtiÚs
(
£q_fe
 *
£q
,

1199 
su³r_block
 *
sb
)

1201 #ifdeà
CONFIG_QUOTA


1202 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

1204 ià(
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
) {

1205 *
fmŠame
 = "";

1207 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
) {

1208 
QFMT_VFS_OLD
:

1209 
fmŠame
 = "vfsold";

1211 
QFMT_VFS_V0
:

1212 
fmŠame
 = "vfsv0";

1214 
QFMT_VFS_V1
:

1215 
fmŠame
 = "vfsv1";

1218 
	`£q_´štf
(
£q
, ",jqfmt=%s", 
fmŠame
);

1221 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
USRQUOTA
])

1222 
	`£q_show_İtiÚ
(
£q
, "usrjquota",

1223 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
USRQUOTA
]);

1225 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
GRPQUOTA
])

1226 
	`£q_show_İtiÚ
(
£q
, "grpjquota",

1227 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
GRPQUOTA
]);

1229 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
PRJQUOTA
])

1230 
	`£q_show_İtiÚ
(
£q
, "prjjquota",

1231 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
PRJQUOTA
]);

1233 
	}
}

1235 
	$f2fs_show_İtiÚs
(
£q_fe
 *
£q
, 
d’Œy
 *
roÙ
)

1237 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
roÙ
->
d_sb
);

1239 ià(!
	`f2fs_»adÚly
(
sbi
->
sb
è&& 
	`‹¡_İt
(sbi, 
BG_GC
)) {

1240 ià(
	`‹¡_İt
(
sbi
, 
FORCE_FG_GC
))

1241 
	`£q_´štf
(
£q
, ",background_gc=%s", "sync");

1243 
	`£q_´štf
(
£q
, ",background_gc=%s", "on");

1245 
	`£q_´štf
(
£q
, ",background_gc=%s", "off");

1247 ià(
	`‹¡_İt
(
sbi
, 
DISABLE_ROLL_FORWARD
))

1248 
	`£q_puts
(
£q
, ",disable_roll_forward");

1249 ià(
	`‹¡_İt
(
sbi
, 
DISCARD
))

1250 
	`£q_puts
(
£q
, ",discard");

1251 ià(
	`‹¡_İt
(
sbi
, 
NOHEAP
))

1252 
	`£q_puts
(
£q
, ",no_heap");

1254 
	`£q_puts
(
£q
, ",heap");

1255 #ifdeà
CONFIG_F2FS_FS_XATTR


1256 ià(
	`‹¡_İt
(
sbi
, 
XATTR_USER
))

1257 
	`£q_puts
(
£q
, ",user_xattr");

1259 
	`£q_puts
(
£q
, ",nouser_xattr");

1260 ià(
	`‹¡_İt
(
sbi
, 
INLINE_XATTR
))

1261 
	`£q_puts
(
£q
, ",inline_xattr");

1263 
	`£q_puts
(
£q
, ",noinline_xattr");

1264 ià(
	`‹¡_İt
(
sbi
, 
INLINE_XATTR_SIZE
))

1265 
	`£q_´štf
(
£q
, ",inline_xattr_size=%u",

1266 
	`F2FS_OPTION
(
sbi
).
šlše_x©Œ_size
);

1268 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


1269 ià(
	`‹¡_İt
(
sbi
, 
POSIX_ACL
))

1270 
	`£q_puts
(
£q
, ",acl");

1272 
	`£q_puts
(
£q
, ",noacl");

1274 ià(
	`‹¡_İt
(
sbi
, 
DISABLE_EXT_IDENTIFY
))

1275 
	`£q_puts
(
£q
, ",disable_ext_identify");

1276 ià(
	`‹¡_İt
(
sbi
, 
INLINE_DATA
))

1277 
	`£q_puts
(
£q
, ",inline_data");

1279 
	`£q_puts
(
£q
, ",noinline_data");

1280 ià(
	`‹¡_İt
(
sbi
, 
INLINE_DENTRY
))

1281 
	`£q_puts
(
£q
, ",inline_dentry");

1283 
	`£q_puts
(
£q
, ",noinline_dentry");

1284 ià(!
	`f2fs_»adÚly
(
sbi
->
sb
è&& 
	`‹¡_İt
(sbi, 
FLUSH_MERGE
))

1285 
	`£q_puts
(
£q
, ",flush_merge");

1286 ià(
	`‹¡_İt
(
sbi
, 
NOBARRIER
))

1287 
	`£q_puts
(
£q
, ",nobarrier");

1288 ià(
	`‹¡_İt
(
sbi
, 
FASTBOOT
))

1289 
	`£q_puts
(
£q
, ",fastboot");

1290 ià(
	`‹¡_İt
(
sbi
, 
EXTENT_CACHE
))

1291 
	`£q_puts
(
£q
, ",extent_cache");

1293 
	`£q_puts
(
£q
, ",noextent_cache");

1294 ià(
	`‹¡_İt
(
sbi
, 
DATA_FLUSH
))

1295 
	`£q_puts
(
£q
, ",data_flush");

1297 
	`£q_puts
(
£q
, ",mode=");

1298 ià(
	`‹¡_İt
(
sbi
, 
ADAPTIVE
))

1299 
	`£q_puts
(
£q
, "adaptive");

1300 ià(
	`‹¡_İt
(
sbi
, 
LFS
))

1301 
	`£q_puts
(
£q
, "lfs");

1302 
	`£q_´štf
(
£q
, ",aùive_logs=%u", 
	`F2FS_OPTION
(
sbi
).
aùive_logs
);

1303 ià(
	`‹¡_İt
(
sbi
, 
RESERVE_ROOT
))

1304 
	`£q_´štf
(
£q
, ",reserve_root=%u,resuid=%u,resgid=%u",

1305 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
,

1306 
	`äom_kuid_munged
(&
š™_u£r_ns
,

1307 
	`F2FS_OPTION
(
sbi
).
s_»suid
),

1308 
	`äom_kgid_munged
(&
š™_u£r_ns
,

1309 
	`F2FS_OPTION
(
sbi
).
s_»sgid
));

1310 ià(
	`F2FS_IO_SIZE_BITS
(
sbi
))

1311 
	`£q_´štf
(
£q
, ",io_size=%uKB", 
	`F2FS_IO_SIZE_KB
(
sbi
));

1312 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


1313 ià(
	`‹¡_İt
(
sbi
, 
FAULT_INJECTION
))

1314 
	`£q_´štf
(
£q
, ",fault_injection=%u",

1315 
	`F2FS_OPTION
(
sbi
).
çuÉ_šfo
.
šjeù_¿‹
);

1317 #ifdeà
CONFIG_QUOTA


1318 ià(
	`‹¡_İt
(
sbi
, 
QUOTA
))

1319 
	`£q_puts
(
£q
, ",quota");

1320 ià(
	`‹¡_İt
(
sbi
, 
USRQUOTA
))

1321 
	`£q_puts
(
£q
, ",usrquota");

1322 ià(
	`‹¡_İt
(
sbi
, 
GRPQUOTA
))

1323 
	`£q_puts
(
£q
, ",grpquota");

1324 ià(
	`‹¡_İt
(
sbi
, 
PRJQUOTA
))

1325 
	`£q_puts
(
£q
, ",prjquota");

1327 
	`f2fs_show_quÙa_İtiÚs
(
£q
, 
sbi
->
sb
);

1328 ià(
	`F2FS_OPTION
(
sbi
).
whšt_mode
 =ğ
WHINT_MODE_USER
)

1329 
	`£q_´štf
(
£q
, ",whint_mode=%s", "user-based");

1330 ià(
	`F2FS_OPTION
(
sbi
).
whšt_mode
 =ğ
WHINT_MODE_FS
)

1331 
	`£q_´štf
(
£q
, ",whint_mode=%s", "fs-based");

1332 #ifdeà
CONFIG_F2FS_FS_ENCRYPTION


1333 ià(
	`F2FS_OPTION
(
sbi
).
‹¡_dummy_’üy±iÚ
)

1334 
	`£q_puts
(
£q
, ",test_dummy_encryption");

1337 ià(
	`F2FS_OPTION
(
sbi
).
®loc_mode
 =ğ
ALLOC_MODE_DEFAULT
)

1338 
	`£q_´štf
(
£q
, ",alloc_mode=%s", "default");

1339 ià(
	`F2FS_OPTION
(
sbi
).
®loc_mode
 =ğ
ALLOC_MODE_REUSE
)

1340 
	`£q_´štf
(
£q
, ",alloc_mode=%s", "reuse");

1342 ià(
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =ğ
FSYNC_MODE_POSIX
)

1343 
	`£q_´štf
(
£q
, ",fsync_mode=%s", "posix");

1344 ià(
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =ğ
FSYNC_MODE_STRICT
)

1345 
	`£q_´štf
(
£q
, ",fsync_mode=%s", "strict");

1347 
	}
}

1349 
	$deçuÉ_İtiÚs
(
f2fs_sb_šfo
 *
sbi
)

1352 
	`F2FS_OPTION
(
sbi
).
aùive_logs
 = 
NR_CURSEG_TYPE
;

1353 
	`F2FS_OPTION
(
sbi
).
šlše_x©Œ_size
 = 
DEFAULT_INLINE_XATTR_ADDRS
;

1354 
	`F2FS_OPTION
(
sbi
).
whšt_mode
 = 
WHINT_MODE_OFF
;

1355 
	`F2FS_OPTION
(
sbi
).
®loc_mode
 = 
ALLOC_MODE_DEFAULT
;

1356 
	`F2FS_OPTION
(
sbi
).
fsync_mode
 = 
FSYNC_MODE_POSIX
;

1357 
	`F2FS_OPTION
(
sbi
).
‹¡_dummy_’üy±iÚ
 = 
çl£
;

1358 
sbi
->
»addœ_¿
 = 1;

1360 
	`£t_İt
(
sbi
, 
BG_GC
);

1361 
	`£t_İt
(
sbi
, 
INLINE_XATTR
);

1362 
	`£t_İt
(
sbi
, 
INLINE_DATA
);

1363 
	`£t_İt
(
sbi
, 
INLINE_DENTRY
);

1364 
	`£t_İt
(
sbi
, 
EXTENT_CACHE
);

1365 
	`£t_İt
(
sbi
, 
NOHEAP
);

1366 
sbi
->
sb
->
s_æags
 |ğ
SB_LAZYTIME
;

1367 
	`£t_İt
(
sbi
, 
FLUSH_MERGE
);

1368 ià(
	`f2fs_sb_has_blkzÚed
(
sbi
->
sb
)) {

1369 
	`£t_İt_mode
(
sbi
, 
F2FS_MOUNT_LFS
);

1370 
	`£t_İt
(
sbi
, 
DISCARD
);

1372 
	`£t_İt_mode
(
sbi
, 
F2FS_MOUNT_ADAPTIVE
);

1375 #ifdeà
CONFIG_F2FS_FS_XATTR


1376 
	`£t_İt
(
sbi
, 
XATTR_USER
);

1378 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


1379 
	`£t_İt
(
sbi
, 
POSIX_ACL
);

1382 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


1383 
	`f2fs_bud_çuÉ_©Œ
(
sbi
, 0);

1385 
	}
}

1387 #ifdeà
CONFIG_QUOTA


1388 
f2fs_’abË_quÙas
(
su³r_block
 *
sb
);

1390 
	$f2fs_»mouÁ
(
su³r_block
 *
sb
, *
æags
, *
d©a
)

1392 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

1393 
f2fs_mouÁ_šfo
 
Üg_mouÁ_İt
;

1394 
Şd_sb_æags
;

1395 
”r
;

1396 
boŞ
 
Ãed_»¡¬t_gc
 = 
çl£
;

1397 
boŞ
 
Ãed_¡İ_gc
 = 
çl£
;

1398 
boŞ
 
no_ex‹Á_ÿche
 = !
	`‹¡_İt
(
sbi
, 
EXTENT_CACHE
);

1399 #ifdeà
CONFIG_QUOTA


1400 
i
, 
j
;

1407 
Üg_mouÁ_İt
 = 
sbi
->
mouÁ_İt
;

1408 
Şd_sb_æags
 = 
sb
->
s_æags
;

1410 #ifdeà
CONFIG_QUOTA


1411 
Üg_mouÁ_İt
.
s_jquÙa_fmt
 = 
	`F2FS_OPTION
(
sbi
).s_jquota_fmt;

1412 
i
 = 0; i < 
MAXQUOTAS
; i++) {

1413 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
]) {

1414 
Üg_mouÁ_İt
.
s_qf_Çmes
[
i
] =

1415 
	`k¡rdup
(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
],

1416 
GFP_KERNEL
);

1417 ià(!
Üg_mouÁ_İt
.
s_qf_Çmes
[
i
]) {

1418 
j
 = 0; j < 
i
; j++)

1419 
	`kä“
(
Üg_mouÁ_İt
.
s_qf_Çmes
[
j
]);

1420  -
ENOMEM
;

1423 
Üg_mouÁ_İt
.
s_qf_Çmes
[
i
] = 
NULL
;

1429 ià(!(*
æags
 & 
SB_RDONLY
è&& 
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_SB_WRITE
)) {

1430 
”r
 = 
	`f2fs_comm™_su³r
(
sbi
, 
çl£
);

1431 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

1432 "TryØ»cov”‡Îhsu³rblocks,„‘: %d", 
”r
);

1433 ià(!
”r
)

1434 
	`ş—r_sbi_æag
(
sbi
, 
SBI_NEED_SB_WRITE
);

1437 
	`deçuÉ_İtiÚs
(
sbi
);

1440 
”r
 = 
	`·r£_İtiÚs
(
sb
, 
d©a
);

1441 ià(
”r
)

1442 
»¡Üe_İts
;

1448 ià(
	`f2fs_»adÚly
(
sb
è&& (*
æags
 & 
SB_RDONLY
))

1449 
sk
;

1451 #ifdeà
CONFIG_QUOTA


1452 ià(!
	`f2fs_»adÚly
(
sb
è&& (*
æags
 & 
SB_RDONLY
)) {

1453 
”r
 = 
	`dquÙ_su¥’d
(
sb
, -1);

1454 ià(
”r
 < 0)

1455 
»¡Üe_İts
;

1456 } ià(
	`f2fs_»adÚly
(
sb
è&& !(*
æags
 & 
MS_RDONLY
)) {

1458 
sb
->
s_æags
 &ğ~
SB_RDONLY
;

1459 ià(
	`sb_ªy_quÙa_su¥’ded
(
sb
)) {

1460 
	`dquÙ_»sume
(
sb
, -1);

1461 } ià(
	`f2fs_sb_has_quÙa_šo
(
sb
)) {

1462 
”r
 = 
	`f2fs_’abË_quÙas
(
sb
);

1463 ià(
”r
)

1464 
»¡Üe_İts
;

1469 ià(
no_ex‹Á_ÿche
 =ğ!!
	`‹¡_İt
(
sbi
, 
EXTENT_CACHE
)) {

1470 
”r
 = -
EINVAL
;

1471 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

1473 
»¡Üe_İts
;

1481 ià((*
æags
 & 
SB_RDONLY
è|| !
	`‹¡_İt
(
sbi
, 
BG_GC
)) {

1482 ià(
sbi
->
gc_th»ad
) {

1483 
	`f2fs_¡İ_gc_th»ad
(
sbi
);

1484 
Ãed_»¡¬t_gc
 = 
Œue
;

1486 } ià(!
sbi
->
gc_th»ad
) {

1487 
”r
 = 
	`f2fs_¡¬t_gc_th»ad
(
sbi
);

1488 ià(
”r
)

1489 
»¡Üe_İts
;

1490 
Ãed_¡İ_gc
 = 
Œue
;

1493 ià(*
æags
 & 
SB_RDONLY
 ||

1494 
	`F2FS_OPTION
(
sbi
).
whšt_mode
 !ğ
Üg_mouÁ_İt
.whint_mode) {

1495 
	`wr™eback_šodes_sb
(
sb
, 
WB_REASON_SYNC
);

1496 
	`sync_šodes_sb
(
sb
);

1498 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_DIRTY
);

1499 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_CLOSE
);

1500 
	`f2fs_sync_fs
(
sb
, 1);

1501 
	`ş—r_sbi_æag
(
sbi
, 
SBI_IS_CLOSE
);

1508 ià((*
æags
 & 
SB_RDONLY
è|| !
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
)) {

1509 
	`ş—r_İt
(
sbi
, 
FLUSH_MERGE
);

1510 
	`f2fs_de¡roy_æush_cmd_cÚŒŞ
(
sbi
, 
çl£
);

1512 
”r
 = 
	`f2fs_ü—‹_æush_cmd_cÚŒŞ
(
sbi
);

1513 ià(
”r
)

1514 
»¡Üe_gc
;

1516 
sk
:

1517 #ifdeà
CONFIG_QUOTA


1519 
i
 = 0; i < 
MAXQUOTAS
; i++)

1520 
	`kä“
(
Üg_mouÁ_İt
.
s_qf_Çmes
[
i
]);

1523 
sb
->
s_æags
 = (sb->s_æag & ~
SB_POSIXACL
) |

1524 (
	`‹¡_İt
(
sbi
, 
POSIX_ACL
è? 
SB_POSIXACL
 : 0);

1526 
	`lim™_»£rve_roÙ
(
sbi
);

1528 
»¡Üe_gc
:

1529 ià(
Ãed_»¡¬t_gc
) {

1530 ià(
	`f2fs_¡¬t_gc_th»ad
(
sbi
))

1531 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

1533 } ià(
Ãed_¡İ_gc
) {

1534 
	`f2fs_¡İ_gc_th»ad
(
sbi
);

1536 
»¡Üe_İts
:

1537 #ifdeà
CONFIG_QUOTA


1538 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
 = 
Üg_mouÁ_İt
.s_jquota_fmt;

1539 
i
 = 0; i < 
MAXQUOTAS
; i++) {

1540 
	`kä“
(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
]);

1541 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
] = 
Üg_mouÁ_İt
.s_qf_names[i];

1544 
sbi
->
mouÁ_İt
 = 
Üg_mouÁ_İt
;

1545 
sb
->
s_æags
 = 
Şd_sb_æags
;

1546  
”r
;

1547 
	}
}

1549 #ifdeà
CONFIG_QUOTA


1551 
ssize_t
 
	$f2fs_quÙa_»ad
(
su³r_block
 *
sb
, 
ty³
, *
d©a
,

1552 
size_t
 
Ën
, 
loff_t
 
off
)

1554 
šode
 *šodğ
	`sb_dqİt
(
sb
)->
fes
[
ty³
];

1555 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

1556 
block_t
 
blkidx
 = 
	`F2FS_BYTES_TO_BLK
(
off
);

1557 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

1558 
tocİy
;

1559 
size_t
 
tÜ—d
;

1560 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

1561 
·ge
 *page;

1562 *
kaddr
;

1564 ià(
off
 > 
i_size
)

1567 ià(
off
 + 
Ën
 > 
i_size
)

1568 
Ën
 = 
i_size
 - 
off
;

1569 
tÜ—d
 = 
Ën
;

1570 
tÜ—d
 > 0) {

1571 
tocİy
 = 
	`mš_t
(, 
sb
->
s_blocksize
 - 
off£t
, 
tÜ—d
);

1572 
»³©
:

1573 
·ge
 = 
	`»ad_ÿche_·ge_gå
(
m­pšg
, 
blkidx
, 
GFP_NOFS
);

1574 ià(
	`IS_ERR
(
·ge
)) {

1575 ià(
	`PTR_ERR
(
·ge
è=ğ-
ENOMEM
) {

1576 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

1577 
»³©
;

1579  
	`PTR_ERR
(
·ge
);

1582 
	`lock_·ge
(
·ge
);

1584 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

1585 
	`f2fs_put_·ge
(
·ge
, 1);

1586 
»³©
;

1588 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

1589 
	`f2fs_put_·ge
(
·ge
, 1);

1590  -
EIO
;

1593 
kaddr
 = 
	`km­_©omic
(
·ge
);

1594 
	`memıy
(
d©a
, 
kaddr
 + 
off£t
, 
tocİy
);

1595 
	`kunm­_©omic
(
kaddr
);

1596 
	`f2fs_put_·ge
(
·ge
, 1);

1598 
off£t
 = 0;

1599 
tÜ—d
 -ğ
tocİy
;

1600 
d©a
 +ğ
tocİy
;

1601 
blkidx
++;

1603  
Ën
;

1604 
	}
}

1607 
ssize_t
 
	$f2fs_quÙa_wr™e
(
su³r_block
 *
sb
, 
ty³
,

1608 cÚ¡ *
d©a
, 
size_t
 
Ën
, 
loff_t
 
off
)

1610 
šode
 *šodğ
	`sb_dqİt
(
sb
)->
fes
[
ty³
];

1611 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

1612 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 *
a_İs
 = 
m­pšg
->a_ops;

1613 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

1614 
size_t
 
towr™e
 = 
Ën
;

1615 
·ge
 *page;

1616 *
kaddr
;

1617 
”r
 = 0;

1618 
tocİy
;

1620 
towr™e
 > 0) {

1621 
tocİy
 = 
	`mš_t
(, 
sb
->
s_blocksize
 - 
off£t
,

1622 
towr™e
);

1623 
»Œy
:

1624 
”r
 = 
a_İs
->
	`wr™e_begš
(
NULL
, 
m­pšg
, 
off
, 
tocİy
, 0,

1625 &
·ge
, 
NULL
);

1626 ià(
	`uÆik–y
(
”r
)) {

1627 ià(
”r
 =ğ-
ENOMEM
) {

1628 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

1629 
»Œy
;

1634 
kaddr
 = 
	`km­_©omic
(
·ge
);

1635 
	`memıy
(
kaddr
 + 
off£t
, 
d©a
, 
tocİy
);

1636 
	`kunm­_©omic
(
kaddr
);

1637 
	`æush_dÿche_·ge
(
·ge
);

1639 
a_İs
->
	`wr™e_’d
(
NULL
, 
m­pšg
, 
off
, 
tocİy
,ocopy,

1640 
·ge
, 
NULL
);

1641 
off£t
 = 0;

1642 
towr™e
 -ğ
tocİy
;

1643 
off
 +ğ
tocİy
;

1644 
d©a
 +ğ
tocİy
;

1645 
	`cÚd_»sched
();

1648 ià(
Ën
 =ğ
towr™e
)

1649  
”r
;

1650 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

1651 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

1652  
Ën
 - 
towr™e
;

1653 
	}
}

1655 
dquÙ
 **
	$f2fs_g‘_dquÙs
(
šode
 *inode)

1657  
	`F2FS_I
(
šode
)->
i_dquÙ
;

1658 
	}
}

1660 
qsize_t
 *
	$f2fs_g‘_»£rved_¥aû
(
šode
 *inode)

1662  &
	`F2FS_I
(
šode
)->
i_»£rved_quÙa
;

1663 
	}
}

1665 
	$f2fs_quÙa_Ú_mouÁ
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1667  
	`dquÙ_quÙa_Ú_mouÁ
(
sbi
->
sb
, 
	`F2FS_OPTION
(sbi).
s_qf_Çmes
[
ty³
],

1668 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
, 
ty³
);

1669 
	}
}

1671 
	$f2fs_’abË_quÙa_fes
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
rdÚly
)

1673 
’abËd
 = 0;

1674 
i
, 
”r
;

1676 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
->
sb
è&& 
rdÚly
) {

1677 
”r
 = 
	`f2fs_’abË_quÙas
(
sbi
->
sb
);

1678 ià(
”r
) {

1679 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
,

1680 "CªnÙuº oÀquÙa_šo: %d", 
”r
);

1686 
i
 = 0; i < 
MAXQUOTAS
; i++) {

1687 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
]) {

1688 
”r
 = 
	`f2fs_quÙa_Ú_mouÁ
(
sbi
, 
i
);

1689 ià(!
”r
) {

1690 
’abËd
 = 1;

1693 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
,

1694 "CªnÙuº oÀquÙas: %d oÀ%d", 
”r
, 
i
);

1697  
’abËd
;

1698 
	}
}

1700 
	$f2fs_quÙa_’abË
(
su³r_block
 *
sb
, 
ty³
, 
fÜm©_id
,

1701 
æags
)

1703 
šode
 *
qf_šode
;

1704 
qf_šum
;

1705 
”r
;

1707 
	`BUG_ON
(!
	`f2fs_sb_has_quÙa_šo
(
sb
));

1709 
qf_šum
 = 
	`f2fs_qf_šo
(
sb
, 
ty³
);

1710 ià(!
qf_šum
)

1711  -
EPERM
;

1713 
qf_šode
 = 
	`f2fs_ig‘
(
sb
, 
qf_šum
);

1714 ià(
	`IS_ERR
(
qf_šode
)) {

1715 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

1716 "Bad quÙ¨šod%u:%lu", 
ty³
, 
qf_šum
);

1717  
	`PTR_ERR
(
qf_šode
);

1721 
qf_šode
->
i_æags
 |ğ
S_NOQUOTA
;

1722 
”r
 = 
	`dquÙ_’abË
(
qf_šode
, 
ty³
, 
fÜm©_id
, 
æags
);

1723 
	`ut
(
qf_šode
);

1724  
”r
;

1725 
	}
}

1727 
	$f2fs_’abË_quÙas
(
su³r_block
 *
sb
)

1729 
ty³
, 
”r
 = 0;

1730 
qf_šum
;

1731 
boŞ
 
quÙa_mİt
[
MAXQUOTAS
] = {

1732 
	`‹¡_İt
(
	`F2FS_SB
(
sb
), 
USRQUOTA
),

1733 
	`‹¡_İt
(
	`F2FS_SB
(
sb
), 
GRPQUOTA
),

1734 
	`‹¡_İt
(
	`F2FS_SB
(
sb
), 
PRJQUOTA
),

1737 
	`sb_dqİt
(
sb
)->
æags
 |ğ
DQUOT_QUOTA_SYS_FILE
 | 
DQUOT_NOLIST_DIRTY
;

1738 
ty³
 = 0;y³ < 
MAXQUOTAS
;ype++) {

1739 
qf_šum
 = 
	`f2fs_qf_šo
(
sb
, 
ty³
);

1740 ià(
qf_šum
) {

1741 
”r
 = 
	`f2fs_quÙa_’abË
(
sb
, 
ty³
, 
QFMT_VFS_V1
,

1742 
DQUOT_USAGE_ENABLED
 |

1743 (
quÙa_mİt
[
ty³
] ? 
DQUOT_LIMITS_ENABLED
 : 0));

1744 ià(
”r
) {

1745 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

1748 "fsckØfix.", 
ty³
, 
”r
);

1749 
ty³
--;ype >= 0;ype--)

1750 
	`dquÙ_quÙa_off
(
sb
, 
ty³
);

1751  
”r
;

1756 
	}
}

1758 
	$f2fs_quÙa_sync
(
su³r_block
 *
sb
, 
ty³
)

1760 
quÙa_šfo
 *
dqİt
 = 
	`sb_dqİt
(
sb
);

1761 
út
;

1762 
»t
;

1764 
»t
 = 
	`dquÙ_wr™eback_dquÙs
(
sb
, 
ty³
);

1765 ià(
»t
)

1766  
»t
;

1772 
út
 = 0; cÁ < 
MAXQUOTAS
; cnt++) {

1773 ià(
ty³
 !ğ-1 && 
út
 !=ype)

1775 ià(!
	`sb_has_quÙa_aùive
(
sb
, 
út
))

1778 
»t
 = 
	`fem­_wr™e_ªd_wa™
(
dqİt
->
fes
[
út
]->
i_m­pšg
);

1779 ià(
»t
)

1780  
»t
;

1782 
	`šode_lock
(
dqİt
->
fes
[
út
]);

1783 
	`Œunÿ‹_šode_·ges
(&
dqİt
->
fes
[
út
]->
i_d©a
, 0);

1784 
	`šode_uÆock
(
dqİt
->
fes
[
út
]);

1787 
	}
}

1789 
	$f2fs_quÙa_Ú
(
su³r_block
 *
sb
, 
ty³
, 
fÜm©_id
,

1790 cÚ¡ 
·th
 *path)

1792 
šode
 *inode;

1793 
”r
;

1795 
”r
 = 
	`f2fs_quÙa_sync
(
sb
, 
ty³
);

1796 ià(
”r
)

1797  
”r
;

1799 
”r
 = 
	`dquÙ_quÙa_Ú
(
sb
, 
ty³
, 
fÜm©_id
, 
·th
);

1800 ià(
”r
)

1801  
”r
;

1803 
šode
 = 
	`d_šode
(
·th
->
d’Œy
);

1805 
	`šode_lock
(
šode
);

1806 
	`F2FS_I
(
šode
)->
i_æags
 |ğ
F2FS_NOATIME_FL
 | 
F2FS_IMMUTABLE_FL
;

1807 
	`šode_£t_æags
(
šode
, 
S_NOATIME
 | 
S_IMMUTABLE
,

1808 
S_NOATIME
 | 
S_IMMUTABLE
);

1809 
	`šode_uÆock
(
šode
);

1810 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

1813 
	}
}

1815 
	$f2fs_quÙa_off
(
su³r_block
 *
sb
, 
ty³
)

1817 
šode
 *šodğ
	`sb_dqİt
(
sb
)->
fes
[
ty³
];

1818 
”r
;

1820 ià(!
šode
 || !
	`ig¿b
(inode))

1821  
	`dquÙ_quÙa_off
(
sb
, 
ty³
);

1823 
	`f2fs_quÙa_sync
(
sb
, 
ty³
);

1825 
”r
 = 
	`dquÙ_quÙa_off
(
sb
, 
ty³
);

1826 ià(
”r
 || 
	`f2fs_sb_has_quÙa_šo
(
sb
))

1827 
out_put
;

1829 
	`šode_lock
(
šode
);

1830 
	`F2FS_I
(
šode
)->
i_æags
 &ğ~(
F2FS_NOATIME_FL
 | 
F2FS_IMMUTABLE_FL
);

1831 
	`šode_£t_æags
(
šode
, 0, 
S_NOATIME
 | 
S_IMMUTABLE
);

1832 
	`šode_uÆock
(
šode
);

1833 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

1834 
out_put
:

1835 
	`ut
(
šode
);

1836  
”r
;

1837 
	}
}

1839 
	$f2fs_quÙa_off_umouÁ
(
su³r_block
 *
sb
)

1841 
ty³
;

1843 
ty³
 = 0;y³ < 
MAXQUOTAS
;ype++)

1844 
	`f2fs_quÙa_off
(
sb
, 
ty³
);

1845 
	}
}

1847 
	$f2fs_g‘_´ojid
(
šode
 *šode, 
k´ojid_t
 *
´ojid
)

1849 *
´ojid
 = 
	`F2FS_I
(
šode
)->
i_´ojid
;

1851 
	}
}

1853 cÚ¡ 
dquÙ_İ”©iÚs
 
	gf2fs_quÙa_İ”©iÚs
 = {

1854 .
g‘_»£rved_¥aû
 = 
f2fs_g‘_»£rved_¥aû
,

1855 .
	gwr™e_dquÙ
 = 
dquÙ_comm™
,

1856 .
	gacquœe_dquÙ
 = 
dquÙ_acquœe
,

1857 .
	g»Ëa£_dquÙ
 = 
dquÙ_»Ëa£
,

1858 .
	gm¬k_dœty
 = 
dquÙ_m¬k_dquÙ_dœty
,

1859 .
	gwr™e_šfo
 = 
dquÙ_comm™_šfo
,

1860 .
	g®loc_dquÙ
 = 
dquÙ_®loc
,

1861 .
	gde¡roy_dquÙ
 = 
dquÙ_de¡roy
,

1862 .
	gg‘_´ojid
 = 
f2fs_g‘_´ojid
,

1863 .
	gg‘_Ãxt_id
 = 
dquÙ_g‘_Ãxt_id
,

1866 cÚ¡ 
quÙaùl_İs
 
	gf2fs_quÙaùl_İs
 = {

1867 .
quÙa_Ú
 = 
f2fs_quÙa_Ú
,

1868 .
	gquÙa_off
 = 
f2fs_quÙa_off
,

1869 .
	gquÙa_sync
 = 
f2fs_quÙa_sync
,

1870 .
	gg‘_¡©e
 = 
dquÙ_g‘_¡©e
,

1871 .
	g£t_šfo
 = 
dquÙ_£t_dqšfo
,

1872 .
	gg‘_dqblk
 = 
dquÙ_g‘_dqblk
,

1873 .
	g£t_dqblk
 = 
dquÙ_£t_dqblk
,

1874 .
	gg‘_Ãxtdqblk
 = 
dquÙ_g‘_Ãxt_dqblk
,

1877 
	$f2fs_quÙa_off_umouÁ
(
su³r_block
 *
sb
)

1879 
	}
}

1882 cÚ¡ 
su³r_İ”©iÚs
 
	gf2fs_sİs
 = {

1883 .
®loc_šode
 = 
f2fs_®loc_šode
,

1884 .
	gdrİ_šode
 = 
f2fs_drİ_šode
,

1885 .
	gde¡roy_šode
 = 
f2fs_de¡roy_šode
,

1886 .
	gwr™e_šode
 = 
f2fs_wr™e_šode
,

1887 .
	gdœty_šode
 = 
f2fs_dœty_šode
,

1888 .
	gshow_İtiÚs
 = 
f2fs_show_İtiÚs
,

1889 #ifdeà
CONFIG_QUOTA


1890 .
	gquÙa_»ad
 = 
f2fs_quÙa_»ad
,

1891 .
	gquÙa_wr™e
 = 
f2fs_quÙa_wr™e
,

1892 .
	gg‘_dquÙs
 = 
f2fs_g‘_dquÙs
,

1894 .
	geviù_šode
 = 
f2fs_eviù_šode
,

1895 .
	gput_su³r
 = 
f2fs_put_su³r
,

1896 .
	gsync_fs
 = 
f2fs_sync_fs
,

1897 .
	gä“ze_fs
 = 
f2fs_ä“ze
,

1898 .
	gunä“ze_fs
 = 
f2fs_unä“ze
,

1899 .
	g¡©fs
 = 
f2fs_¡©fs
,

1900 .
	g»mouÁ_fs
 = 
f2fs_»mouÁ
,

1903 #ifdeà
CONFIG_F2FS_FS_ENCRYPTION


1904 
	$f2fs_g‘_cÚ‹xt
(
šode
 *šode, *
ùx
, 
size_t
 
Ën
)

1906  
	`f2fs_g‘x©Œ
(
šode
, 
F2FS_XATTR_INDEX_ENCRYPTION
,

1907 
F2FS_XATTR_NAME_ENCRYPTION_CONTEXT
,

1908 
ùx
, 
Ën
, 
NULL
);

1909 
	}
}

1911 
	$f2fs_£t_cÚ‹xt
(
šode
 *šode, cÚ¡ *
ùx
, 
size_t
 
Ën
,

1912 *
fs_d©a
)

1914 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1922 ià(
	`f2fs_sb_has_lo¡_found
(
sbi
->
sb
) &&

1923 
šode
->
i_šo
 =ğ
	`F2FS_ROOT_INO
(
sbi
))

1924  -
EPERM
;

1926  
	`f2fs_£tx©Œ
(
šode
, 
F2FS_XATTR_INDEX_ENCRYPTION
,

1927 
F2FS_XATTR_NAME_ENCRYPTION_CONTEXT
,

1928 
ùx
, 
Ën
, 
fs_d©a
, 
XATTR_CREATE
);

1929 
	}
}

1931 
boŞ
 
	$f2fs_dummy_cÚ‹xt
(
šode
 *inode)

1933  
	`DUMMY_ENCRYPTION_ENABLED
(
	`F2FS_I_SB
(
šode
));

1934 
	}
}

1936 cÚ¡ 
fsüy±_İ”©iÚs
 
	gf2fs_üy±İs
 = {

1937 .
key_´efix
 = "f2fs:",

1938 .
	gg‘_cÚ‹xt
 = 
f2fs_g‘_cÚ‹xt
,

1939 .
	g£t_cÚ‹xt
 = 
f2fs_£t_cÚ‹xt
,

1940 .
	gdummy_cÚ‹xt
 = 
f2fs_dummy_cÚ‹xt
,

1941 .
	gem±y_dœ
 = 
f2fs_em±y_dœ
,

1942 .
	gmax_Çm–’
 = 
F2FS_NAME_LEN
,

1946 
šode
 *
	$f2fs_nfs_g‘_šode
(
su³r_block
 *
sb
,

1947 
u64
 
šo
, 
u32
 
g’”©iÚ
)

1949 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

1950 
šode
 *inode;

1952 ià(
	`f2fs_check_nid_¿nge
(
sbi
, 
šo
))

1953  
	`ERR_PTR
(-
ESTALE
);

1960 
šode
 = 
	`f2fs_ig‘
(
sb
, 
šo
);

1961 ià(
	`IS_ERR
(
šode
))

1962  
	`ERR_CAST
(
šode
);

1963 ià(
	`uÆik–y
(
g’”©iÚ
 && 
šode
->
i_g’”©iÚ
 != generation)) {

1965 
	`ut
(
šode
);

1966  
	`ERR_PTR
(-
ESTALE
);

1968  
šode
;

1969 
	}
}

1971 
d’Œy
 *
	$f2fs_fh_to_d’Œy
(
su³r_block
 *
sb
, 
fid
 *fid,

1972 
fh_Ën
, 
fh_ty³
)

1974  
	`g’”ic_fh_to_d’Œy
(
sb
, 
fid
, 
fh_Ën
, 
fh_ty³
,

1975 
f2fs_nfs_g‘_šode
);

1976 
	}
}

1978 
d’Œy
 *
	$f2fs_fh_to_·»Á
(
su³r_block
 *
sb
, 
fid
 *fid,

1979 
fh_Ën
, 
fh_ty³
)

1981  
	`g’”ic_fh_to_·»Á
(
sb
, 
fid
, 
fh_Ën
, 
fh_ty³
,

1982 
f2fs_nfs_g‘_šode
);

1983 
	}
}

1985 cÚ¡ 
expÜt_İ”©iÚs
 
	gf2fs_expÜt_İs
 = {

1986 .
fh_to_d’Œy
 = 
f2fs_fh_to_d’Œy
,

1987 .
	gfh_to_·»Á
 = 
f2fs_fh_to_·»Á
,

1988 .
	gg‘_·»Á
 = 
f2fs_g‘_·»Á
,

1991 
loff_t
 
	$max_fe_blocks
()

1993 
loff_t
 
»suÉ
 = 0;

1994 
loff_t
 
Ëaf_couÁ
 = 
ADDRS_PER_BLOCK
;

2004 
»suÉ
 +ğ(
Ëaf_couÁ
 * 2);

2007 
Ëaf_couÁ
 *ğ
NIDS_PER_BLOCK
;

2008 
»suÉ
 +ğ(
Ëaf_couÁ
 * 2);

2011 
Ëaf_couÁ
 *ğ
NIDS_PER_BLOCK
;

2012 
»suÉ
 +ğ
Ëaf_couÁ
;

2014  
»suÉ
;

2015 
	}
}

2017 
	$__f2fs_comm™_su³r
(
bufãr_h—d
 *
bh
,

2018 
f2fs_su³r_block
 *
su³r
)

2020 
	`lock_bufãr
(
bh
);

2021 ià(
su³r
)

2022 
	`memıy
(
bh
->
b_d©a
 + 
F2FS_SUPER_OFFSET
, 
su³r
, (*super));

2023 
	`£t_bufãr_dœty
(
bh
);

2024 
	`uÆock_bufãr
(
bh
);

2027  
	`__sync_dœty_bufãr
(
bh
, 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
);

2028 
	}
}

2030 
šlše
 
boŞ
 
	$§n™y_check_¬—_bound¬y
(
f2fs_sb_šfo
 *
sbi
,

2031 
bufãr_h—d
 *
bh
)

2033 
f2fs_su³r_block
 *
¿w_su³r
 = (f2fs_super_block *)

2034 (
bh
->
b_d©a
 + 
F2FS_SUPER_OFFSET
);

2035 
su³r_block
 *
sb
 = 
sbi
->sb;

2036 
u32
 
£gm’t0_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment0_blkaddr);

2037 
u32
 
ı_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->cp_blkaddr);

2038 
u32
 
s™_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->sit_blkaddr);

2039 
u32
 
Çt_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->nat_blkaddr);

2040 
u32
 
s§_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->ssa_blkaddr);

2041 
u32
 
maš_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->main_blkaddr);

2042 
u32
 
£gm’t_couÁ_ck±
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count_ckpt);

2043 
u32
 
£gm’t_couÁ_s™
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count_sit);

2044 
u32
 
£gm’t_couÁ_Çt
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count_nat);

2045 
u32
 
£gm’t_couÁ_s§
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count_ssa);

2046 
u32
 
£gm’t_couÁ_maš
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count_main);

2047 
u32
 
£gm’t_couÁ
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count);

2048 
u32
 
log_blocks_³r_£g
 = 
	`Ë32_to_ıu
(
¿w_su³r
->log_blocks_per_seg);

2049 
u64
 
maš_’d_blkaddr
 = 
maš_blkaddr
 +

2050 (
£gm’t_couÁ_maš
 << 
log_blocks_³r_£g
);

2051 
u64
 
£g_’d_blkaddr
 = 
£gm’t0_blkaddr
 +

2052 (
£gm’t_couÁ
 << 
log_blocks_³r_£g
);

2054 ià(
£gm’t0_blkaddr
 !ğ
ı_blkaddr
) {

2055 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2057 
£gm’t0_blkaddr
, 
ı_blkaddr
);

2058  
Œue
;

2061 ià(
ı_blkaddr
 + (
£gm’t_couÁ_ck±
 << 
log_blocks_³r_£g
) !=

2062 
s™_blkaddr
) {

2063 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2065 
ı_blkaddr
, 
s™_blkaddr
,

2066 
£gm’t_couÁ_ck±
 << 
log_blocks_³r_£g
);

2067  
Œue
;

2070 ià(
s™_blkaddr
 + (
£gm’t_couÁ_s™
 << 
log_blocks_³r_£g
) !=

2071 
Çt_blkaddr
) {

2072 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2074 
s™_blkaddr
, 
Çt_blkaddr
,

2075 
£gm’t_couÁ_s™
 << 
log_blocks_³r_£g
);

2076  
Œue
;

2079 ià(
Çt_blkaddr
 + (
£gm’t_couÁ_Çt
 << 
log_blocks_³r_£g
) !=

2080 
s§_blkaddr
) {

2081 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2083 
Çt_blkaddr
, 
s§_blkaddr
,

2084 
£gm’t_couÁ_Çt
 << 
log_blocks_³r_£g
);

2085  
Œue
;

2088 ià(
s§_blkaddr
 + (
£gm’t_couÁ_s§
 << 
log_blocks_³r_£g
) !=

2089 
maš_blkaddr
) {

2090 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2092 
s§_blkaddr
, 
maš_blkaddr
,

2093 
£gm’t_couÁ_s§
 << 
log_blocks_³r_£g
);

2094  
Œue
;

2097 ià(
maš_’d_blkaddr
 > 
£g_’d_blkaddr
) {

2098 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2100 
maš_blkaddr
,

2101 
£gm’t0_blkaddr
 +

2102 (
£gm’t_couÁ
 << 
log_blocks_³r_£g
),

2103 
£gm’t_couÁ_maš
 << 
log_blocks_³r_£g
);

2104  
Œue
;

2105 } ià(
maš_’d_blkaddr
 < 
£g_’d_blkaddr
) {

2106 
”r
 = 0;

2107 *
»s
;

2110 
¿w_su³r
->
£gm’t_couÁ
 = 
	`ıu_to_Ë32
((
maš_’d_blkaddr
 -

2111 
£gm’t0_blkaddr
è>> 
log_blocks_³r_£g
);

2113 ià(
	`f2fs_»adÚly
(
sb
è|| 
	`bdev_»ad_Úly
(sb->
s_bdev
)) {

2114 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_SB_WRITE
);

2115 
»s
 = "internally";

2117 
”r
 = 
	`__f2fs_comm™_su³r
(
bh
, 
NULL
);

2118 
»s
 = 
”r
 ? "failed" : "done";

2120 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2122 
»s
, 
maš_blkaddr
,

2123 
£gm’t0_blkaddr
 +

2124 (
£gm’t_couÁ
 << 
log_blocks_³r_£g
),

2125 
£gm’t_couÁ_maš
 << 
log_blocks_³r_£g
);

2126 ià(
”r
)

2127  
Œue
;

2129  
çl£
;

2130 
	}
}

2132 
	$§n™y_check_¿w_su³r
(
f2fs_sb_šfo
 *
sbi
,

2133 
bufãr_h—d
 *
bh
)

2135 
block_t
 
£gm’t_couÁ
, 
£gs_³r_£c
, 
£cs_³r_zÚe
;

2136 
block_t
 
tÙ®_£ùiÚs
, 
blocks_³r_£g
;

2137 
f2fs_su³r_block
 *
¿w_su³r
 = (f2fs_super_block *)

2138 (
bh
->
b_d©a
 + 
F2FS_SUPER_OFFSET
);

2139 
su³r_block
 *
sb
 = 
sbi
->sb;

2140 
blocksize
;

2142 ià(
F2FS_SUPER_MAGIC
 !ğ
	`Ë32_to_ıu
(
¿w_su³r
->
magic
)) {

2143 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2145 
F2FS_SUPER_MAGIC
, 
	`Ë32_to_ıu
(
¿w_su³r
->
magic
));

2150 ià(
F2FS_BLKSIZE
 !ğ
PAGE_SIZE
) {

2151 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2153 
PAGE_SIZE
);

2158 
blocksize
 = 1 << 
	`Ë32_to_ıu
(
¿w_su³r
->
log_blocksize
);

2159 ià(
blocksize
 !ğ
F2FS_BLKSIZE
) {

2160 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2162 
blocksize
);

2167 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
log_blocks_³r_£g
) != 9) {

2168 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2170 
	`Ë32_to_ıu
(
¿w_su³r
->
log_blocks_³r_£g
));

2175 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
) >

2176 
F2FS_MAX_LOG_SECTOR_SIZE
 ||

2177 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
) <

2178 
F2FS_MIN_LOG_SECTOR_SIZE
) {

2179 
	`f2fs_msg
(
sb
, 
KERN_INFO
, "Invalid†og sectorsize (%u)",

2180 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
));

2183 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜs_³r_block
) +

2184 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
) !=

2185 
F2FS_MAX_LOG_SECTOR_SIZE
) {

2186 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2188 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜs_³r_block
),

2189 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
));

2193 
£gm’t_couÁ
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count);

2194 
£gs_³r_£c
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segs_per_sec);

2195 
£cs_³r_zÚe
 = 
	`Ë32_to_ıu
(
¿w_su³r
->secs_per_zone);

2196 
tÙ®_£ùiÚs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£ùiÚ_couÁ
);

2199 
blocks_³r_£g
 = 1 << 
	`Ë32_to_ıu
(
¿w_su³r
->
log_blocks_³r_£g
);

2201 ià(
£gm’t_couÁ
 > 
F2FS_MAX_SEGMENT
 ||

2202 
£gm’t_couÁ
 < 
F2FS_MIN_SEGMENTS
) {

2203 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2205 
£gm’t_couÁ
);

2209 ià(
tÙ®_£ùiÚs
 > 
£gm’t_couÁ
 ||

2210 
tÙ®_£ùiÚs
 < 
F2FS_MIN_SEGMENTS
 ||

2211 
£gs_³r_£c
 > 
£gm’t_couÁ
 || !segs_per_sec) {

2212 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2214 
£gm’t_couÁ
, 
tÙ®_£ùiÚs
, 
£gs_³r_£c
);

2218 ià((
£gm’t_couÁ
 / 
£gs_³r_£c
è< 
tÙ®_£ùiÚs
) {

2219 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2221 
£gm’t_couÁ
, 
£gs_³r_£c
, 
tÙ®_£ùiÚs
);

2225 ià(
£gm’t_couÁ
 > (
	`Ë32_to_ıu
(
¿w_su³r
->
block_couÁ
) >> 9)) {

2226 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2228 
£gm’t_couÁ
, 
	`Ë32_to_ıu
(
¿w_su³r
->
block_couÁ
));

2232 ià(
£cs_³r_zÚe
 > 
tÙ®_£ùiÚs
) {

2233 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2235 
£cs_³r_zÚe
, 
tÙ®_£ùiÚs
);

2238 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
ex‹nsiÚ_couÁ
è> 
F2FS_MAX_EXTENSION
 ||

2239 
¿w_su³r
->
hÙ_ext_couÁ
 > 
F2FS_MAX_EXTENSION
 ||

2240 (
	`Ë32_to_ıu
(
¿w_su³r
->
ex‹nsiÚ_couÁ
) +

2241 
¿w_su³r
->
hÙ_ext_couÁ
è> 
F2FS_MAX_EXTENSION
) {

2242 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2244 
	`Ë32_to_ıu
(
¿w_su³r
->
ex‹nsiÚ_couÁ
),

2245 
¿w_su³r
->
hÙ_ext_couÁ
,

2246 
F2FS_MAX_EXTENSION
);

2250 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
ı_·ylßd
) >

2251 (
blocks_³r_£g
 - 
F2FS_CP_PACKS
)) {

2252 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2254 
	`Ë32_to_ıu
(
¿w_su³r
->
ı_·ylßd
),

2255 
blocks_³r_£g
 - 
F2FS_CP_PACKS
);

2260 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
node_šo
) != 1 ||

2261 
	`Ë32_to_ıu
(
¿w_su³r
->
m‘a_šo
) != 2 ||

2262 
	`Ë32_to_ıu
(
¿w_su³r
->
roÙ_šo
) != 3) {

2263 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

2265 
	`Ë32_to_ıu
(
¿w_su³r
->
node_šo
),

2266 
	`Ë32_to_ıu
(
¿w_su³r
->
m‘a_šo
),

2267 
	`Ë32_to_ıu
(
¿w_su³r
->
roÙ_šo
));

2272 ià(
	`§n™y_check_¬—_bound¬y
(
sbi
, 
bh
))

2276 
	}
}

2278 
	$f2fs_§n™y_check_ck±
(
f2fs_sb_šfo
 *
sbi
)

2280 
tÙ®
, 
fsm‘a
;

2281 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

2282 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

2283 
ovp_£gm’ts
, 
»£rved_£gm’ts
;

2284 
maš_£gs
, 
blocks_³r_£g
;

2285 
i
;

2287 
tÙ®
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ
);

2288 
fsm‘a
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_ck±
);

2289 
fsm‘a
 +ğ
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s™
);

2290 
fsm‘a
 +ğ
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_Çt
);

2291 
fsm‘a
 +ğ
	`Ë32_to_ıu
(
ck±
->
rsvd_£gm’t_couÁ
);

2292 
fsm‘a
 +ğ
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s§
);

2294 ià(
	`uÆik–y
(
fsm‘a
 >ğ
tÙ®
))

2297 
ovp_£gm’ts
 = 
	`Ë32_to_ıu
(
ck±
->
ov”´ov_£gm’t_couÁ
);

2298 
»£rved_£gm’ts
 = 
	`Ë32_to_ıu
(
ck±
->
rsvd_£gm’t_couÁ
);

2300 ià(
	`uÆik–y
(
fsm‘a
 < 
F2FS_MIN_SEGMENTS
 ||

2301 
ovp_£gm’ts
 =ğ0 || 
»£rved_£gm’ts
 == 0)) {

2302 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
,

2307 
maš_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_maš
);

2308 
blocks_³r_£g
 = 
sbi
->blocks_per_seg;

2310 
i
 = 0; i < 
NR_CURSEG_NODE_TYPE
; i++) {

2311 ià(
	`Ë32_to_ıu
(
ck±
->
cur_node_£gno
[
i
]è>ğ
maš_£gs
 ||

2312 
	`Ë16_to_ıu
(
ck±
->
cur_node_blkoff
[
i
]è>ğ
blocks_³r_£g
)

2315 
i
 = 0; i < 
NR_CURSEG_DATA_TYPE
; i++) {

2316 ià(
	`Ë32_to_ıu
(
ck±
->
cur_d©a_£gno
[
i
]è>ğ
maš_£gs
 ||

2317 
	`Ë16_to_ıu
(
ck±
->
cur_d©a_blkoff
[
i
]è>ğ
blocks_³r_£g
)

2321 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

2322 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
, "A bug case:‚eedo„un fsck");

2326 
	}
}

2328 
	$š™_sb_šfo
(
f2fs_sb_šfo
 *
sbi
)

2330 
f2fs_su³r_block
 *
¿w_su³r
 = 
sbi
->raw_super;

2331 
i
, 
j
;

2333 
sbi
->
log_£ùÜs_³r_block
 =

2334 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜs_³r_block
);

2335 
sbi
->
log_blocksize
 = 
	`Ë32_to_ıu
(
¿w_su³r
->log_blocksize);

2336 
sbi
->
blocksize
 = 1 << sbi->
log_blocksize
;

2337 
sbi
->
log_blocks_³r_£g
 = 
	`Ë32_to_ıu
(
¿w_su³r
->log_blocks_per_seg);

2338 
sbi
->
blocks_³r_£g
 = 1 << sbi->
log_blocks_³r_£g
;

2339 
sbi
->
£gs_³r_£c
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segs_per_sec);

2340 
sbi
->
£cs_³r_zÚe
 = 
	`Ë32_to_ıu
(
¿w_su³r
->secs_per_zone);

2341 
sbi
->
tÙ®_£ùiÚs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£ùiÚ_couÁ
);

2342 
sbi
->
tÙ®_node_couÁ
 =

2343 (
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_Çt
) / 2)

2344 * 
sbi
->
blocks_³r_£g
 * 
NAT_ENTRY_PER_BLOCK
;

2345 
sbi
->
roÙ_šo_num
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
roÙ_šo
);

2346 
sbi
->
node_šo_num
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
node_šo
);

2347 
sbi
->
m‘a_šo_num
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
m‘a_šo
);

2348 
sbi
->
cur_viùim_£c
 = 
NULL_SECNO
;

2349 
sbi
->
max_viùim_£¬ch
 = 
DEF_MAX_VICTIM_SEARCH
;

2351 
sbi
->
dœ_Ëv–
 = 
DEF_DIR_LEVEL
;

2352 
sbi
->
š‹rv®_time
[
CP_TIME
] = 
DEF_CP_INTERVAL
;

2353 
sbi
->
š‹rv®_time
[
REQ_TIME
] = 
DEF_IDLE_INTERVAL
;

2354 
	`ş—r_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

2356 
i
 = 0; i < 
NR_COUNT_TYPE
; i++)

2357 
	`©omic_£t
(&
sbi
->
Ä_·ges
[
i
], 0);

2359 
i
 = 0; i < 
META
; i++)

2360 
	`©omic_£t
(&
sbi
->
wb_sync_»q
[
i
], 0);

2362 
	`INIT_LIST_HEAD
(&
sbi
->
s_li¡
);

2363 
	`mu‹x_š™
(&
sbi
->
umouÁ_mu‹x
);

2364 
i
 = 0; i < 
NR_PAGE_TYPE
 - 1; i++)

2365 
j
 = 
HOT
; j < 
NR_TEMP_TYPE
; j++)

2366 
	`mu‹x_š™
(&
sbi
->
wio_mu‹x
[
i
][
j
]);

2367 
	`š™_rw£m
(&
sbi
->
io_Üd”_lock
);

2368 
	`¥š_lock_š™
(&
sbi
->
ı_lock
);

2370 
sbi
->
dœty_deviû
 = 0;

2371 
	`¥š_lock_š™
(&
sbi
->
dev_lock
);

2373 
	`š™_rw£m
(&
sbi
->
sb_lock
);

2374 
	}
}

2376 
	$š™_³rıu_šfo
(
f2fs_sb_šfo
 *
sbi
)

2378 
”r
;

2380 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
®loc_v®id_block_couÁ
, 0, 
GFP_KERNEL
);

2381 ià(
”r
)

2382  
”r
;

2384  
	`³rıu_couÁ”_š™
(&
sbi
->
tÙ®_v®id_šode_couÁ
, 0,

2385 
GFP_KERNEL
);

2386 
	}
}

2388 #ifdeà
CONFIG_BLK_DEV_ZONED


2389 
	$š™_blkz_šfo
(
f2fs_sb_šfo
 *
sbi
, 
devi
)

2391 
block_deviû
 *
bdev
 = 
	`FDEV
(
devi
).bdev;

2392 
£ùÜ_t
 
Ä_£ùÜs
 = 
bdev
->
bd_·¹
->
Ä_£ùs
;

2393 
£ùÜ_t
 
£ùÜ
 = 0;

2394 
blk_zÚe
 *
zÚes
;

2395 
i
, 
Ä_zÚes
;

2396 
n
 = 0;

2397 
”r
 = -
EIO
;

2399 ià(!
	`f2fs_sb_has_blkzÚed
(
sbi
->
sb
))

2402 ià(
sbi
->
blocks_³r_blkz
 && sbi->blocks_per_blkz !=

2403 
	`SECTOR_TO_BLOCK
(
	`bdev_zÚe_£ùÜs
(
bdev
)))

2404  -
EINVAL
;

2405 
sbi
->
blocks_³r_blkz
 = 
	`SECTOR_TO_BLOCK
(
	`bdev_zÚe_£ùÜs
(
bdev
));

2406 ià(
sbi
->
log_blocks_³r_blkz
 && sbi->log_blocks_per_blkz !=

2407 
	`__og2_u32
(
sbi
->
blocks_³r_blkz
))

2408  -
EINVAL
;

2409 
sbi
->
log_blocks_³r_blkz
 = 
	`__og2_u32
(sbi->
blocks_³r_blkz
);

2410 
	`FDEV
(
devi
).
Ä_blkz
 = 
	`SECTOR_TO_BLOCK
(
Ä_£ùÜs
) >>

2411 
sbi
->
log_blocks_³r_blkz
;

2412 ià(
Ä_£ùÜs
 & (
	`bdev_zÚe_£ùÜs
(
bdev
) - 1))

2413 
	`FDEV
(
devi
).
Ä_blkz
++;

2415 
	`FDEV
(
devi
).
blkz_ty³
 = 
	`f2fs_km®loc
(
sbi
, FDEV(devi).
Ä_blkz
,

2416 
GFP_KERNEL
);

2417 ià(!
	`FDEV
(
devi
).
blkz_ty³
)

2418  -
ENOMEM
;

2420 
	#F2FS_REPORT_NR_ZONES
 4096

	)

2422 
zÚes
 = 
	`f2fs_kz®loc
(
sbi
,

2423 
	`¬¿y_size
(
F2FS_REPORT_NR_ZONES
,

2424 (
blk_zÚe
)),

2425 
GFP_KERNEL
);

2426 ià(!
zÚes
)

2427  -
ENOMEM
;

2430 
zÚes
 && 
£ùÜ
 < 
Ä_£ùÜs
) {

2432 
Ä_zÚes
 = 
F2FS_REPORT_NR_ZONES
;

2433 
”r
 = 
	`blkdev_»pÜt_zÚes
(
bdev
, 
£ùÜ
,

2434 
zÚes
, &
Ä_zÚes
,

2435 
GFP_KERNEL
);

2436 ià(
”r
)

2438 ià(!
Ä_zÚes
) {

2439 
”r
 = -
EIO
;

2443 
i
 = 0; i < 
Ä_zÚes
; i++) {

2444 
	`FDEV
(
devi
).
blkz_ty³
[
n
] = 
zÚes
[
i
].
ty³
;

2445 
£ùÜ
 +ğ
zÚes
[
i
].
Ën
;

2446 
n
++;

2450 
	`kä“
(
zÚes
);

2452  
”r
;

2453 
	}
}

2462 
	$»ad_¿w_su³r_block
(
f2fs_sb_šfo
 *
sbi
,

2463 
f2fs_su³r_block
 **
¿w_su³r
,

2464 *
v®id_su³r_block
, *
»cov”y
)

2466 
su³r_block
 *
sb
 = 
sbi
->sb;

2467 
block
;

2468 
bufãr_h—d
 *
bh
;

2469 
f2fs_su³r_block
 *
su³r
;

2470 
”r
 = 0;

2472 
su³r
 = 
	`kz®loc
((
f2fs_su³r_block
), 
GFP_KERNEL
);

2473 ià(!
su³r
)

2474  -
ENOMEM
;

2476 
block
 = 0; block < 2; block++) {

2477 
bh
 = 
	`sb_b»ad
(
sb
, 
block
);

2478 ià(!
bh
) {

2479 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Unableo„ead %dth superblock",

2480 
block
 + 1);

2481 
”r
 = -
EIO
;

2486 ià(
	`§n™y_check_¿w_su³r
(
sbi
, 
bh
)) {

2487 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

2489 
block
 + 1);

2490 
”r
 = -
EINVAL
;

2491 
	`b»l£
(
bh
);

2495 ià(!*
¿w_su³r
) {

2496 
	`memıy
(
su³r
, 
bh
->
b_d©a
 + 
F2FS_SUPER_OFFSET
,

2497 (*
su³r
));

2498 *
v®id_su³r_block
 = 
block
;

2499 *
¿w_su³r
 = 
su³r
;

2501 
	`b»l£
(
bh
);

2505 ià(
”r
 < 0)

2506 *
»cov”y
 = 1;

2509 ià(!*
¿w_su³r
)

2510 
	`kä“
(
su³r
);

2512 
”r
 = 0;

2514  
”r
;

2515 
	}
}

2517 
	$f2fs_comm™_su³r
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
»cov”
)

2519 
bufãr_h—d
 *
bh
;

2520 
”r
;

2522 ià((
»cov”
 && 
	`f2fs_»adÚly
(
sbi
->
sb
)) ||

2523 
	`bdev_»ad_Úly
(
sbi
->
sb
->
s_bdev
)) {

2524 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_SB_WRITE
);

2525  -
EROFS
;

2529 
bh
 = 
	`sb_b»ad
(
sbi
->
sb
, sbi->
v®id_su³r_block
 ? 0 : 1);

2530 ià(!
bh
)

2531  -
EIO
;

2532 
”r
 = 
	`__f2fs_comm™_su³r
(
bh
, 
	`F2FS_RAW_SUPER
(
sbi
));

2533 
	`b»l£
(
bh
);

2536 ià(
»cov”
 || 
”r
)

2537  
”r
;

2540 
bh
 = 
	`sb_b»ad
(
sbi
->
sb
, sbi->
v®id_su³r_block
);

2541 ià(!
bh
)

2542  -
EIO
;

2543 
”r
 = 
	`__f2fs_comm™_su³r
(
bh
, 
	`F2FS_RAW_SUPER
(
sbi
));

2544 
	`b»l£
(
bh
);

2545  
”r
;

2546 
	}
}

2548 
	$f2fs_sÿn_deviûs
(
f2fs_sb_šfo
 *
sbi
)

2550 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

2551 
max_deviûs
 = 
MAX_DEVICES
;

2552 
i
;

2555 ià(!
	`RDEV
(0).
·th
[0]) {

2556 ià(!
	`bdev_is_zÚed
(
sbi
->
sb
->
s_bdev
))

2558 
max_deviûs
 = 1;

2565 
sbi
->
devs
 = 
	`f2fs_kz®loc
(sbi,

2566 
	`¬¿y_size
(
max_deviûs
,

2567 (
f2fs_dev_šfo
)),

2568 
GFP_KERNEL
);

2569 ià(!
sbi
->
devs
)

2570  -
ENOMEM
;

2572 
i
 = 0; i < 
max_deviûs
; i++) {

2574 ià(
i
 > 0 && !
	`RDEV
(i).
·th
[0])

2577 ià(
max_deviûs
 == 1) {

2579 
	`FDEV
(0).
bdev
 =

2580 
	`blkdev_g‘_by_dev
(
sbi
->
sb
->
s_bdev
->
bd_dev
,

2581 
sbi
->
sb
->
s_mode
, sbi->sb->
s_ty³
);

2584 
	`memıy
(
	`FDEV
(
i
).
·th
, 
	`RDEV
(i).·th, 
MAX_PATH_LEN
);

2585 
	`FDEV
(
i
).
tÙ®_£gm’ts
 =

2586 
	`Ë32_to_ıu
(
	`RDEV
(
i
).
tÙ®_£gm’ts
);

2587 ià(
i
 == 0) {

2588 
	`FDEV
(
i
).
¡¬t_blk
 = 0;

2589 
	`FDEV
(
i
).
’d_blk
 = FDEV(i).
¡¬t_blk
 +

2590 (
	`FDEV
(
i
).
tÙ®_£gm’ts
 <<

2591 
sbi
->
log_blocks_³r_£g
) - 1 +

2592 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t0_blkaddr
);

2594 
	`FDEV
(
i
).
¡¬t_blk
 = FDEV(˜- 1).
’d_blk
 + 1;

2595 
	`FDEV
(
i
).
’d_blk
 = FDEV(i).
¡¬t_blk
 +

2596 (
	`FDEV
(
i
).
tÙ®_£gm’ts
 <<

2597 
sbi
->
log_blocks_³r_£g
) - 1;

2599 
	`FDEV
(
i
).
bdev
 = 
	`blkdev_g‘_by_·th
(FDEV(i).
·th
,

2600 
sbi
->
sb
->
s_mode
, sbi->sb->
s_ty³
);

2602 ià(
	`IS_ERR
(
	`FDEV
(
i
).
bdev
))

2603  
	`PTR_ERR
(
	`FDEV
(
i
).
bdev
);

2606 
sbi
->
s_ndevs
 = 
i
 + 1;

2608 #ifdeà
CONFIG_BLK_DEV_ZONED


2609 ià(
	`bdev_zÚed_mod–
(
	`FDEV
(
i
).
bdev
è=ğ
BLK_ZONED_HM
 &&

2610 !
	`f2fs_sb_has_blkzÚed
(
sbi
->
sb
)) {

2611 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
,

2613  -
EINVAL
;

2615 ià(
	`bdev_zÚed_mod–
(
	`FDEV
(
i
).
bdev
è!ğ
BLK_ZONED_NONE
) {

2616 ià(
	`š™_blkz_šfo
(
sbi
, 
i
)) {

2617 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
,

2619  -
EINVAL
;

2621 ià(
max_deviûs
 == 1)

2623 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
,

2625 
i
, 
	`FDEV
(i).
·th
,

2626 
	`FDEV
(
i
).
tÙ®_£gm’ts
,

2627 
	`FDEV
(
i
).
¡¬t_blk
, FDEV(i).
’d_blk
,

2628 
	`bdev_zÚed_mod–
(
	`FDEV
(
i
).
bdev
è=ğ
BLK_ZONED_HA
 ?

2633 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
,

2635 
i
, 
	`FDEV
(i).
·th
,

2636 
	`FDEV
(
i
).
tÙ®_£gm’ts
,

2637 
	`FDEV
(
i
).
¡¬t_blk
, FDEV(i).
’d_blk
);

2639 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_INFO
,

2640 "IO Block Size: %8d KB", 
	`F2FS_IO_SIZE_KB
(
sbi
));

2642 
	}
}

2644 
	$f2fs_tunšg_·¿m‘”s
(
f2fs_sb_šfo
 *
sbi
)

2646 
f2fs_sm_šfo
 *
sm_i
 = 
	`SM_I
(
sbi
);

2649 ià(
sm_i
->
maš_£gm’ts
 <ğ
SMALL_VOLUME_SEGMENTS
) {

2650 
	`F2FS_OPTION
(
sbi
).
®loc_mode
 = 
ALLOC_MODE_REUSE
;

2651 
sm_i
->
dcc_šfo
->
disÿrd_g¿nuÏr™y
 = 1;

2652 
sm_i
->
u_pŞicy
 = 1 << 
F2FS_IPU_FORCE
;

2654 
	}
}

2656 
	$f2fs_fl_su³r
(
su³r_block
 *
sb
, *
d©a
, 
s’t
)

2658 
f2fs_sb_šfo
 *
sbi
;

2659 
f2fs_su³r_block
 *
¿w_su³r
;

2660 
šode
 *
roÙ
;

2661 
”r
;

2662 
boŞ
 
»Œy
 = 
Œue
, 
Ãed_fsck
 = 
çl£
;

2663 *
İtiÚs
 = 
NULL
;

2664 
»cov”y
, 
i
, 
v®id_su³r_block
;

2665 
cur£g_šfo
 *
£g_i
;

2667 
Œy_ÚemÜe
:

2668 
”r
 = -
EINVAL
;

2669 
¿w_su³r
 = 
NULL
;

2670 
v®id_su³r_block
 = -1;

2671 
»cov”y
 = 0;

2674 
sbi
 = 
	`kz®loc
((
f2fs_sb_šfo
), 
GFP_KERNEL
);

2675 ià(!
sbi
)

2676  -
ENOMEM
;

2678 
sbi
->
sb
 = sb;

2681 
sbi
->
s_chksum_driv”
 = 
	`üy±o_®loc_shash
("crc32", 0, 0);

2682 ià(
	`IS_ERR
(
sbi
->
s_chksum_driv”
)) {

2683 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Cannot†oad crc32 driver.");

2684 
”r
 = 
	`PTR_ERR
(
sbi
->
s_chksum_driv”
);

2685 
sbi
->
s_chksum_driv”
 = 
NULL
;

2686 
ä“_sbi
;

2690 ià(
	`uÆik–y
(!
	`sb_£t_blocksize
(
sb
, 
F2FS_BLKSIZE
))) {

2691 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "unableo set blocksize");

2692 
ä“_sbi
;

2695 
”r
 = 
	`»ad_¿w_su³r_block
(
sbi
, &
¿w_su³r
, &
v®id_su³r_block
,

2696 &
»cov”y
);

2697 ià(
”r
)

2698 
ä“_sbi
;

2700 
sb
->
s_fs_šfo
 = 
sbi
;

2701 
sbi
->
¿w_su³r
 =„aw_super;

2703 
	`F2FS_OPTION
(
sbi
).
s_»suid
 = 
	`make_kuid
(&
š™_u£r_ns
, 
F2FS_DEF_RESUID
);

2704 
	`F2FS_OPTION
(
sbi
).
s_»sgid
 = 
	`make_kgid
(&
š™_u£r_ns
, 
F2FS_DEF_RESGID
);

2707 ià(
	`f2fs_sb_has_šode_chksum
(
sb
))

2708 
sbi
->
s_chksum_£ed
 = 
	`f2fs_chksum
(sbi, ~0, 
¿w_su³r
->
uuid
,

2709 (
¿w_su³r
->
uuid
));

2716 #iâdeà
CONFIG_BLK_DEV_ZONED


2717 ià(
	`f2fs_sb_has_blkzÚed
(
sb
)) {

2718 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

2720 
”r
 = -
EOPNOTSUPP
;

2721 
ä“_sb_buf
;

2724 
	`deçuÉ_İtiÚs
(
sbi
);

2726 
İtiÚs
 = 
	`k¡rdup
((cÚ¡ *)
d©a
, 
GFP_KERNEL
);

2727 ià(
d©a
 && !
İtiÚs
) {

2728 
”r
 = -
ENOMEM
;

2729 
ä“_sb_buf
;

2732 
”r
 = 
	`·r£_İtiÚs
(
sb
, 
İtiÚs
);

2733 ià(
”r
)

2734 
ä“_İtiÚs
;

2736 
sbi
->
max_fe_blocks
 = 
	`max_fe_blocks
();

2737 
sb
->
s_maxby‹s
 = 
sbi
->
max_fe_blocks
 <<

2738 
	`Ë32_to_ıu
(
¿w_su³r
->
log_blocksize
);

2739 
sb
->
s_max_lšks
 = 
F2FS_LINK_MAX
;

2740 
	`g‘_¿ndom_by‹s
(&
sbi
->
s_Ãxt_g’”©iÚ
, (
u32
));

2742 #ifdeà
CONFIG_QUOTA


2743 
sb
->
dq_İ
 = &
f2fs_quÙa_İ”©iÚs
;

2744 ià(
	`f2fs_sb_has_quÙa_šo
(
sb
))

2745 
sb
->
s_qcİ
 = &
dquÙ_quÙaùl_sysfe_İs
;

2747 
sb
->
s_qcİ
 = &
f2fs_quÙaùl_İs
;

2748 
sb
->
s_quÙa_ty³s
 = 
QTYPE_MASK_USR
 | 
QTYPE_MASK_GRP
 | 
QTYPE_MASK_PRJ
;

2750 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
->
sb
)) {

2751 
i
 = 0; i < 
MAXQUOTAS
; i++) {

2752 ià(
	`f2fs_qf_šo
(
sbi
->
sb
, 
i
))

2753 
sbi
->
nquÙa_fes
++;

2758 
sb
->
s_İ
 = &
f2fs_sİs
;

2759 #ifdeà
CONFIG_F2FS_FS_ENCRYPTION


2760 
sb
->
s_cİ
 = &
f2fs_üy±İs
;

2762 
sb
->
s_x©Œ
 = 
f2fs_x©Œ_hªdËrs
;

2763 
sb
->
s_expÜt_İ
 = &
f2fs_expÜt_İs
;

2764 
sb
->
s_magic
 = 
F2FS_SUPER_MAGIC
;

2765 
sb
->
s_time_g¿n
 = 1;

2766 
sb
->
s_æags
 = (sb->s_æag & ~
SB_POSIXACL
) |

2767 (
	`‹¡_İt
(
sbi
, 
POSIX_ACL
è? 
SB_POSIXACL
 : 0);

2768 
	`memıy
(&
sb
->
s_uuid
, 
¿w_su³r
->
uuid
, (raw_super->uuid));

2769 
sb
->
s_iæags
 |ğ
SB_I_CGROUPWB
;

2772 
sbi
->
v®id_su³r_block
 = valid_super_block;

2773 
	`mu‹x_š™
(&
sbi
->
gc_mu‹x
);

2774 
	`mu‹x_š™
(&
sbi
->
ı_mu‹x
);

2775 
	`š™_rw£m
(&
sbi
->
node_wr™e
);

2776 
	`š™_rw£m
(&
sbi
->
node_chªge
);

2779 
	`£t_sbi_æag
(
sbi
, 
SBI_POR_DOING
);

2780 
	`¥š_lock_š™
(&
sbi
->
¡©_lock
);

2783 
	`¥š_lock_š™
(&
sbi
->
io¡©_lock
);

2784 
sbi
->
io¡©_’abË
 = 
çl£
;

2786 
i
 = 0; i < 
NR_PAGE_TYPE
; i++) {

2787 
n
 = (
i
 =ğ
META
è? 1: 
NR_TEMP_TYPE
;

2788 
j
;

2790 
sbi
->
wr™e_io
[
i
] =

2791 
	`f2fs_km®loc
(
sbi
,

2792 
	`¬¿y_size
(
n
,

2793 (
f2fs_bio_šfo
)),

2794 
GFP_KERNEL
);

2795 ià(!
sbi
->
wr™e_io
[
i
]) {

2796 
”r
 = -
ENOMEM
;

2797 
ä“_İtiÚs
;

2800 
j
 = 
HOT
; j < 
n
; j++) {

2801 
	`š™_rw£m
(&
sbi
->
wr™e_io
[
i
][
j
].
io_rw£m
);

2802 
sbi
->
wr™e_io
[
i
][
j
].sbi = sbi;

2803 
sbi
->
wr™e_io
[
i
][
j
].
bio
 = 
NULL
;

2804 
	`¥š_lock_š™
(&
sbi
->
wr™e_io
[
i
][
j
].
io_lock
);

2805 
	`INIT_LIST_HEAD
(&
sbi
->
wr™e_io
[
i
][
j
].
io_li¡
);

2809 
	`š™_rw£m
(&
sbi
->
ı_rw£m
);

2810 
	`š™_wa™queue_h—d
(&
sbi
->
ı_wa™
);

2811 
	`š™_sb_šfo
(
sbi
);

2813 
”r
 = 
	`š™_³rıu_šfo
(
sbi
);

2814 ià(
”r
)

2815 
ä“_bio_šfo
;

2817 ià(
	`F2FS_IO_SIZE
(
sbi
) > 1) {

2818 
sbi
->
wr™e_io_dummy
 =

2819 
	`mempoŞ_ü—‹_·ge_poŞ
(2 * (
	`F2FS_IO_SIZE
(
sbi
) - 1), 0);

2820 ià(!
sbi
->
wr™e_io_dummy
) {

2821 
”r
 = -
ENOMEM
;

2822 
ä“_³rıu
;

2827 
sbi
->
m‘a_šode
 = 
	`f2fs_ig‘
(
sb
, 
	`F2FS_META_INO
(sbi));

2828 ià(
	`IS_ERR
(
sbi
->
m‘a_šode
)) {

2829 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Failedo„ead F2FS meta data inode");

2830 
”r
 = 
	`PTR_ERR
(
sbi
->
m‘a_šode
);

2831 
ä“_io_dummy
;

2834 
”r
 = 
	`f2fs_g‘_v®id_checkpošt
(
sbi
);

2835 ià(
”r
) {

2836 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Failedo get valid F2FS checkpoint");

2837 
ä“_m‘a_šode
;

2841 
”r
 = 
	`f2fs_sÿn_deviûs
(
sbi
);

2842 ià(
”r
) {

2843 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Failedo find devices");

2844 
ä“_deviûs
;

2847 
sbi
->
tÙ®_v®id_node_couÁ
 =

2848 
	`Ë32_to_ıu
(
sbi
->
ck±
->
v®id_node_couÁ
);

2849 
	`³rıu_couÁ”_£t
(&
sbi
->
tÙ®_v®id_šode_couÁ
,

2850 
	`Ë32_to_ıu
(
sbi
->
ck±
->
v®id_šode_couÁ
));

2851 
sbi
->
u£r_block_couÁ
 = 
	`Ë64_to_ıu
(sbi->
ck±
->user_block_count);

2852 
sbi
->
tÙ®_v®id_block_couÁ
 =

2853 
	`Ë64_to_ıu
(
sbi
->
ck±
->
v®id_block_couÁ
);

2854 
sbi
->
Ï¡_v®id_block_couÁ
 = sbi->
tÙ®_v®id_block_couÁ
;

2855 
sbi
->
»£rved_blocks
 = 0;

2856 
sbi
->
cu¼’t_»£rved_blocks
 = 0;

2857 
	`lim™_»£rve_roÙ
(
sbi
);

2859 
i
 = 0; i < 
NR_INODE_TYPE
; i++) {

2860 
	`INIT_LIST_HEAD
(&
sbi
->
šode_li¡
[
i
]);

2861 
	`¥š_lock_š™
(&
sbi
->
šode_lock
[
i
]);

2864 
	`f2fs_š™_ex‹Á_ÿche_šfo
(
sbi
);

2866 
	`f2fs_š™_šo_’Œy_šfo
(
sbi
);

2869 
”r
 = 
	`f2fs_bud_£gm’t_mªag”
(
sbi
);

2870 ià(
”r
) {

2871 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

2873 
ä“_sm
;

2875 
”r
 = 
	`f2fs_bud_node_mªag”
(
sbi
);

2876 ià(
”r
) {

2877 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

2879 
ä“_nm
;

2883 ià(
sb
->
s_bdev
->
bd_·¹
)

2884 
sbi
->
£ùÜs_wr™‹n_¡¬t
 =

2885 (
u64
)
	`·¹_¡©_»ad
(
sb
->
s_bdev
->
bd_·¹
, 
£ùÜs
[1]);

2888 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_NODE
);

2889 ià(
	`__exi¡_node_summ¬›s
(
sbi
))

2890 
sbi
->
kby‹s_wr™‹n
 =

2891 
	`Ë64_to_ıu
(
£g_i
->
jouº®
->
šfo
.
kby‹s_wr™‹n
);

2893 
	`f2fs_bud_gc_mªag”
(
sbi
);

2896 
sbi
->
node_šode
 = 
	`f2fs_ig‘
(
sb
, 
	`F2FS_NODE_INO
(sbi));

2897 ià(
	`IS_ERR
(
sbi
->
node_šode
)) {

2898 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Failedo„ead‚ode inode");

2899 
”r
 = 
	`PTR_ERR
(
sbi
->
node_šode
);

2900 
ä“_nm
;

2903 
”r
 = 
	`f2fs_bud_¡©s
(
sbi
);

2904 ià(
”r
)

2905 
ä“_node_šode
;

2908 
roÙ
 = 
	`f2fs_ig‘
(
sb
, 
	`F2FS_ROOT_INO
(
sbi
));

2909 ià(
	`IS_ERR
(
roÙ
)) {

2910 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Failedo„ead„oot inode");

2911 
”r
 = 
	`PTR_ERR
(
roÙ
);

2912 
ä“_¡©s
;

2914 ià(!
	`S_ISDIR
(
roÙ
->
i_mode
è|| !roÙ->
i_blocks
 || !roÙ->
i_size
) {

2915 
	`ut
(
roÙ
);

2916 
”r
 = -
EINVAL
;

2917 
ä“_node_šode
;

2920 
sb
->
s_roÙ
 = 
	`d_make_roÙ
(
roÙ
);

2921 ià(!
sb
->
s_roÙ
) {

2922 
”r
 = -
ENOMEM
;

2923 
ä“_roÙ_šode
;

2926 
”r
 = 
	`f2fs_»gi¡”_sysfs
(
sbi
);

2927 ià(
”r
)

2928 
ä“_roÙ_šode
;

2930 #ifdeà
CONFIG_QUOTA


2935 ià(
	`f2fs_sb_has_quÙa_šo
(
sb
è&& !
	`f2fs_»adÚly
(sb)) {

2936 
”r
 = 
	`f2fs_’abË_quÙas
(
sb
);

2937 ià(
”r
) {

2938 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

2939 "CªnÙuº oÀquÙas:ƒ¼Ü %d", 
”r
);

2940 
ä“_sysfs
;

2945 
”r
 = 
	`f2fs_»cov”_Üphª_šodes
(
sbi
);

2946 ià(
”r
)

2947 
ä“_m‘a
;

2950 ià(!
	`‹¡_İt
(
sbi
, 
DISABLE_ROLL_FORWARD
)) {

2955 ià(
	`bdev_»ad_Úly
(
sb
->
s_bdev
) &&

2956 !
	`is_£t_ck±_æags
(
sbi
, 
CP_UMOUNT_FLAG
)) {

2957 
”r
 = -
EROFS
;

2958 
ä“_m‘a
;

2961 ià(
Ãed_fsck
)

2962 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

2964 ià(!
»Œy
)

2965 
sk_»cov”y
;

2967 
”r
 = 
	`f2fs_»cov”_fsync_d©a
(
sbi
, 
çl£
);

2968 ià(
”r
 < 0) {

2969 
Ãed_fsck
 = 
Œue
;

2970 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

2971 "CªnÙ„ecov”‡Î fsynød©¨”ºo=%d", 
”r
);

2972 
ä“_m‘a
;

2975 
”r
 = 
	`f2fs_»cov”_fsync_d©a
(
sbi
, 
Œue
);

2977 ià(!
	`f2fs_»adÚly
(
sb
è&& 
”r
 > 0) {

2978 
”r
 = -
EINVAL
;

2979 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

2981 
ä“_m‘a
;

2984 
sk_»cov”y
:

2986 
	`ş—r_sbi_æag
(
sbi
, 
SBI_POR_DOING
);

2992 ià(
	`‹¡_İt
(
sbi
, 
BG_GC
è&& !
	`f2fs_»adÚly
(
sb
)) {

2994 
”r
 = 
	`f2fs_¡¬t_gc_th»ad
(
sbi
);

2995 ià(
”r
)

2996 
ä“_m‘a
;

2998 
	`kä“
(
İtiÚs
);

3001 ià(
»cov”y
) {

3002 
”r
 = 
	`f2fs_comm™_su³r
(
sbi
, 
Œue
);

3003 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

3005 
sbi
->
v®id_su³r_block
 ? 1 : 2, 
”r
);

3008 
	`f2fs_još_shršk”
(
sbi
);

3010 
	`f2fs_tunšg_·¿m‘”s
(
sbi
);

3012 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_NOTICE
, "Mounted with checkpoint version = %llx",

3013 
	`cur_ı_v”siÚ
(
	`F2FS_CKPT
(
sbi
)));

3014 
	`f2fs_upd©e_time
(
sbi
, 
CP_TIME
);

3015 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

3018 
ä“_m‘a
:

3019 #ifdeà
CONFIG_QUOTA


3020 ià(
	`f2fs_sb_has_quÙa_šo
(
sb
è&& !
	`f2fs_»adÚly
(sb))

3021 
	`f2fs_quÙa_off_umouÁ
(
sbi
->
sb
);

3023 
	`f2fs_sync_šode_m‘a
(
sbi
);

3030 
	`Œunÿ‹_šode_·ges_fš®
(
	`META_MAPPING
(
sbi
));

3031 #ifdeà
CONFIG_QUOTA


3032 
ä“_sysfs
:

3034 
	`f2fs_uÄegi¡”_sysfs
(
sbi
);

3035 
ä“_roÙ_šode
:

3036 
	`dput
(
sb
->
s_roÙ
);

3037 
sb
->
s_roÙ
 = 
NULL
;

3038 
ä“_¡©s
:

3039 
	`f2fs_de¡roy_¡©s
(
sbi
);

3040 
ä“_node_šode
:

3041 
	`f2fs_»Ëa£_šo_’Œy
(
sbi
, 
Œue
);

3042 
	`Œunÿ‹_šode_·ges_fš®
(
	`NODE_MAPPING
(
sbi
));

3043 
	`ut
(
sbi
->
node_šode
);

3044 
ä“_nm
:

3045 
	`f2fs_de¡roy_node_mªag”
(
sbi
);

3046 
ä“_sm
:

3047 
	`f2fs_de¡roy_£gm’t_mªag”
(
sbi
);

3048 
ä“_deviûs
:

3049 
	`de¡roy_deviû_li¡
(
sbi
);

3050 
	`kä“
(
sbi
->
ck±
);

3051 
ä“_m‘a_šode
:

3052 
	`make_bad_šode
(
sbi
->
m‘a_šode
);

3053 
	`ut
(
sbi
->
m‘a_šode
);

3054 
ä“_io_dummy
:

3055 
	`mempoŞ_de¡roy
(
sbi
->
wr™e_io_dummy
);

3056 
ä“_³rıu
:

3057 
	`de¡roy_³rıu_šfo
(
sbi
);

3058 
ä“_bio_šfo
:

3059 
i
 = 0; i < 
NR_PAGE_TYPE
; i++)

3060 
	`kä“
(
sbi
->
wr™e_io
[
i
]);

3061 
ä“_İtiÚs
:

3062 #ifdeà
CONFIG_QUOTA


3063 
i
 = 0; i < 
MAXQUOTAS
; i++)

3064 
	`kä“
(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
]);

3066 
	`kä“
(
İtiÚs
);

3067 
ä“_sb_buf
:

3068 
	`kä“
(
¿w_su³r
);

3069 
ä“_sbi
:

3070 ià(
sbi
->
s_chksum_driv”
)

3071 
	`üy±o_ä“_shash
(
sbi
->
s_chksum_driv”
);

3072 
	`kä“
(
sbi
);

3075 ià(
»Œy
) {

3076 
»Œy
 = 
çl£
;

3077 
	`shršk_dÿche_sb
(
sb
);

3078 
Œy_ÚemÜe
;

3080  
”r
;

3081 
	}
}

3083 
d’Œy
 *
	$f2fs_mouÁ
(
fe_sy¡em_ty³
 *
fs_ty³
, 
æags
,

3084 cÚ¡ *
dev_Çme
, *
d©a
)

3086  
	`mouÁ_bdev
(
fs_ty³
, 
æags
, 
dev_Çme
, 
d©a
, 
f2fs_fl_su³r
);

3087 
	}
}

3089 
	$kl_f2fs_su³r
(
su³r_block
 *
sb
)

3091 ià(
sb
->
s_roÙ
) {

3092 
	`£t_sbi_æag
(
	`F2FS_SB
(
sb
), 
SBI_IS_CLOSE
);

3093 
	`f2fs_¡İ_gc_th»ad
(
	`F2FS_SB
(
sb
));

3094 
	`f2fs_¡İ_disÿrd_th»ad
(
	`F2FS_SB
(
sb
));

3096 
	`kl_block_su³r
(
sb
);

3097 
	}
}

3099 
fe_sy¡em_ty³
 
	gf2fs_fs_ty³
 = {

3100 .
owÃr
 = 
THIS_MODULE
,

3101 .
	gÇme
 = "f2fs",

3102 .
	gmouÁ
 = 
f2fs_mouÁ
,

3103 .
	gkl_sb
 = 
kl_f2fs_su³r
,

3104 .
	gfs_æags
 = 
FS_REQUIRES_DEV
,

3106 
MODULE_ALIAS_FS
("f2fs");

3108 
__š™
 
	$š™_šodeÿche
()

3110 
f2fs_šode_ÿch•
 = 
	`kmem_ÿche_ü—‹
("f2fs_inode_cache",

3111 (
f2fs_šode_šfo
), 0,

3112 
SLAB_RECLAIM_ACCOUNT
|
SLAB_ACCOUNT
, 
NULL
);

3113 ià(!
f2fs_šode_ÿch•
)

3114  -
ENOMEM
;

3116 
	}
}

3118 
	$de¡roy_šodeÿche
()

3124 
	`rcu_b¬r›r
();

3125 
	`kmem_ÿche_de¡roy
(
f2fs_šode_ÿch•
);

3126 
	}
}

3128 
__š™
 
	$š™_f2fs_fs
()

3130 
”r
;

3132 ià(
PAGE_SIZE
 !ğ
F2FS_BLKSIZE
) {

3133 
	`´štk
("F2FS‚ot supported on PAGE_SIZE(%lu) != %d\n",

3134 
PAGE_SIZE
, 
F2FS_BLKSIZE
);

3135  -
EINVAL
;

3138 
	`f2fs_bud_Œaû_ios
();

3140 
”r
 = 
	`š™_šodeÿche
();

3141 ià(
”r
)

3142 
ç
;

3143 
”r
 = 
	`f2fs_ü—‹_node_mªag”_ÿches
();

3144 ià(
”r
)

3145 
ä“_šodeÿche
;

3146 
”r
 = 
	`f2fs_ü—‹_£gm’t_mªag”_ÿches
();

3147 ià(
”r
)

3148 
ä“_node_mªag”_ÿches
;

3149 
”r
 = 
	`f2fs_ü—‹_checkpošt_ÿches
();

3150 ià(
”r
)

3151 
ä“_£gm’t_mªag”_ÿches
;

3152 
”r
 = 
	`f2fs_ü—‹_ex‹Á_ÿche
();

3153 ià(
”r
)

3154 
ä“_checkpošt_ÿches
;

3155 
”r
 = 
	`f2fs_š™_sysfs
();

3156 ià(
”r
)

3157 
ä“_ex‹Á_ÿche
;

3158 
”r
 = 
	`»gi¡”_shršk”
(&
f2fs_shršk”_šfo
);

3159 ià(
”r
)

3160 
ä“_sysfs
;

3161 
”r
 = 
	`»gi¡”_fesy¡em
(&
f2fs_fs_ty³
);

3162 ià(
”r
)

3163 
ä“_shršk”
;

3164 
”r
 = 
	`f2fs_ü—‹_roÙ_¡©s
();

3165 ià(
”r
)

3166 
ä“_fesy¡em
;

3167 
”r
 = 
	`f2fs_š™_po¡_»ad_´oûssšg
();

3168 ià(
”r
)

3169 
ä“_roÙ_¡©s
;

3172 
ä“_roÙ_¡©s
:

3173 
	`f2fs_de¡roy_roÙ_¡©s
();

3174 
ä“_fesy¡em
:

3175 
	`uÄegi¡”_fesy¡em
(&
f2fs_fs_ty³
);

3176 
ä“_shršk”
:

3177 
	`uÄegi¡”_shršk”
(&
f2fs_shršk”_šfo
);

3178 
ä“_sysfs
:

3179 
	`f2fs_ex™_sysfs
();

3180 
ä“_ex‹Á_ÿche
:

3181 
	`f2fs_de¡roy_ex‹Á_ÿche
();

3182 
ä“_checkpošt_ÿches
:

3183 
	`f2fs_de¡roy_checkpošt_ÿches
();

3184 
ä“_£gm’t_mªag”_ÿches
:

3185 
	`f2fs_de¡roy_£gm’t_mªag”_ÿches
();

3186 
ä“_node_mªag”_ÿches
:

3187 
	`f2fs_de¡roy_node_mªag”_ÿches
();

3188 
ä“_šodeÿche
:

3189 
	`de¡roy_šodeÿche
();

3190 
ç
:

3191  
”r
;

3192 
	}
}

3194 
__ex™
 
	$ex™_f2fs_fs
()

3196 
	`f2fs_de¡roy_po¡_»ad_´oûssšg
();

3197 
	`f2fs_de¡roy_roÙ_¡©s
();

3198 
	`uÄegi¡”_fesy¡em
(&
f2fs_fs_ty³
);

3199 
	`uÄegi¡”_shršk”
(&
f2fs_shršk”_šfo
);

3200 
	`f2fs_ex™_sysfs
();

3201 
	`f2fs_de¡roy_ex‹Á_ÿche
();

3202 
	`f2fs_de¡roy_checkpošt_ÿches
();

3203 
	`f2fs_de¡roy_£gm’t_mªag”_ÿches
();

3204 
	`f2fs_de¡roy_node_mªag”_ÿches
();

3205 
	`de¡roy_šodeÿche
();

3206 
	`f2fs_de¡roy_Œaû_ios
();

3207 
	}
}

3209 
	$moduË_š™
(
š™_f2fs_fs
)

3210 
	$moduË_ex™
(
ex™_f2fs_fs
)

3212 
	`MODULE_AUTHOR
("Samsung Electronics's Praesto Team");

3213 
	`MODULE_DESCRIPTION
("Flash Friendly File System");

3214 
	`MODULE_LICENSE
("GPL");

	@fs/f2fs/sysfs.c

12 
	~<lšux/´oc_fs.h
>

13 
	~<lšux/f2fs_fs.h
>

14 
	~<lšux/£q_fe.h
>

16 
	~"f2fs.h
"

17 
	~"£gm’t.h
"

18 
	~"gc.h
"

20 
´oc_dœ_’Œy
 *
	gf2fs_´oc_roÙ
;

24 
	mGC_THREAD
,

25 
	mSM_INFO
,

26 
	mDCC_INFO
,

27 
	mNM_INFO
,

28 
	mF2FS_SBI
,

29 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


30 
	mFAULT_INFO_RATE
,

31 
	mFAULT_INFO_TYPE
,

33 
	mRESERVED_BLOCKS
,

36 
	sf2fs_©Œ
 {

37 
©Œibu‹
 
	m©Œ
;

38 
ssize_t
 (*
show
)(
	mf2fs_©Œ
 *, 
	mf2fs_sb_šfo
 *, *);

39 
ssize_t
 (*
¡Üe
)(
	mf2fs_©Œ
 *, 
	mf2fs_sb_šfo
 *,

40 cÚ¡ *, 
	msize_t
);

41 
	m¡ruù_ty³
;

42 
	moff£t
;

43 
	mid
;

46 *
	$__¡ruù_±r
(
f2fs_sb_šfo
 *
sbi
, 
¡ruù_ty³
)

48 ià(
¡ruù_ty³
 =ğ
GC_THREAD
)

49  (*)
sbi
->
gc_th»ad
;

50 ià(
¡ruù_ty³
 =ğ
SM_INFO
)

51  (*)
	`SM_I
(
sbi
);

52 ià(
¡ruù_ty³
 =ğ
DCC_INFO
)

53  (*)
	`SM_I
(
sbi
)->
dcc_šfo
;

54 ià(
¡ruù_ty³
 =ğ
NM_INFO
)

55  (*)
	`NM_I
(
sbi
);

56 ià(
¡ruù_ty³
 =ğ
F2FS_SBI
 || sŒuù_ty³ =ğ
RESERVED_BLOCKS
)

57  (*)
sbi
;

58 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


59 ià(
¡ruù_ty³
 =ğ
FAULT_INFO_RATE
 ||

60 
¡ruù_ty³
 =ğ
FAULT_INFO_TYPE
)

61  (*)&
	`F2FS_OPTION
(
sbi
).
çuÉ_šfo
;

63  
NULL
;

64 
	}
}

66 
ssize_t
 
	$dœty_£gm’ts_show
(
f2fs_©Œ
 *
a
,

67 
f2fs_sb_šfo
 *
sbi
, *
buf
)

69  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%llu\n",

70 ()(
	`dœty_£gm’ts
(
sbi
)));

71 
	}
}

73 
ssize_t
 
	$liãtime_wr™e_kby‹s_show
(
f2fs_©Œ
 *
a
,

74 
f2fs_sb_šfo
 *
sbi
, *
buf
)

76 
su³r_block
 *
sb
 = 
sbi
->sb;

78 ià(!
sb
->
s_bdev
->
bd_·¹
)

79  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "0\n");

81  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%llu\n",

82 ()(
sbi
->
kby‹s_wr™‹n
 +

83 
	`BD_PART_WRITTEN
(
sbi
)));

84 
	}
}

86 
ssize_t
 
	$ã©u»s_show
(
f2fs_©Œ
 *
a
,

87 
f2fs_sb_šfo
 *
sbi
, *
buf
)

89 
su³r_block
 *
sb
 = 
sbi
->sb;

90 
Ën
 = 0;

92 ià(!
sb
->
s_bdev
->
bd_·¹
)

93  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "0\n");

95 ià(
	`f2fs_sb_has_’üy±
(
sb
))

96 
Ën
 +ğ
	`¢´štf
(
buf
, 
PAGE_SIZE
 -†en, "%s",

98 ià(
	`f2fs_sb_has_blkzÚed
(
sb
))

99 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

100 
Ën
 ? ", " : "", "blkzoned");

101 ià(
	`f2fs_sb_has_exŒa_©Œ
(
sb
))

102 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

103 
Ën
 ? ", " : "", "extra_attr");

104 ià(
	`f2fs_sb_has_´ojeù_quÙa
(
sb
))

105 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

106 
Ën
 ? ", " : "", "projquota");

107 ià(
	`f2fs_sb_has_šode_chksum
(
sb
))

108 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

109 
Ën
 ? ", " : "", "inode_checksum");

110 ià(
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sb
))

111 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

112 
Ën
 ? ", " : "", "flexible_inline_xattr");

113 ià(
	`f2fs_sb_has_quÙa_šo
(
sb
))

114 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

115 
Ën
 ? ", " : "", "quota_ino");

116 ià(
	`f2fs_sb_has_šode_ütime
(
sb
))

117 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

118 
Ën
 ? ", " : "", "inode_crtime");

119 ià(
	`f2fs_sb_has_lo¡_found
(
sb
))

120 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

121 
Ën
 ? ", " : "", "lost_found");

122 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "\n");

123  
Ën
;

124 
	}
}

126 
ssize_t
 
	$cu¼’t_»£rved_blocks_show
(
f2fs_©Œ
 *
a
,

127 
f2fs_sb_šfo
 *
sbi
, *
buf
)

129  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%u\n", 
sbi
->
cu¼’t_»£rved_blocks
);

130 
	}
}

132 
ssize_t
 
	$f2fs_sbi_show
(
f2fs_©Œ
 *
a
,

133 
f2fs_sb_šfo
 *
sbi
, *
buf
)

135 *
±r
 = 
NULL
;

136 *
ui
;

138 
±r
 = 
	`__¡ruù_±r
(
sbi
, 
a
->
¡ruù_ty³
);

139 ià(!
±r
)

140  -
EINVAL
;

142 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "extension_list")) {

143 
	`__u8
 (*
exi¡
)[
F2FS_EXTENSION_LEN
] =

144 
sbi
->
¿w_su³r
->
ex‹nsiÚ_li¡
;

145 
cŞd_couÁ
 = 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
ex‹nsiÚ_couÁ
);

146 
hÙ_couÁ
 = 
sbi
->
¿w_su³r
->
hÙ_ext_couÁ
;

147 
Ën
 = 0, 
i
;

149 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en,

151 
i
 = 0; i < 
cŞd_couÁ
; i++)

152 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s\n",

153 
exi¡
[
i
]);

155 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en,

157 
i
 = 
cŞd_couÁ
; i < cŞd_couÁ + 
hÙ_couÁ
; i++)

158 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s\n",

159 
exi¡
[
i
]);

160  
Ën
;

163 
ui
 = (*)(
±r
 + 
a
->
off£t
);

165  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%u\n", *
ui
);

166 
	}
}

168 
ssize_t
 
	$__sbi_¡Üe
(
f2fs_©Œ
 *
a
,

169 
f2fs_sb_šfo
 *
sbi
,

170 cÚ¡ *
buf
, 
size_t
 
couÁ
)

172 *
±r
;

173 
t
;

174 *
ui
;

175 
ssize_t
 
»t
;

177 
±r
 = 
	`__¡ruù_±r
(
sbi
, 
a
->
¡ruù_ty³
);

178 ià(!
±r
)

179  -
EINVAL
;

181 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "extension_list")) {

182 cÚ¡ *
Çme
 = 
	`¡rim
((*)
buf
);

183 
boŞ
 
£t
 = 
Œue
, 
hÙ
;

185 ià(!
	`¡ºcmp
(
Çme
, "[h]", 3))

186 
hÙ
 = 
Œue
;

187 ià(!
	`¡ºcmp
(
Çme
, "[c]", 3))

188 
hÙ
 = 
çl£
;

190  -
EINVAL
;

192 
Çme
 += 3;

194 ià(*
Çme
 == '!') {

195 
Çme
++;

196 
£t
 = 
çl£
;

199 ià(
	`¡¾’
(
Çme
è>ğ
F2FS_EXTENSION_LEN
)

200  -
EINVAL
;

202 
	`down_wr™e
(&
sbi
->
sb_lock
);

204 
»t
 = 
	`f2fs_upd©e_ex‹nsiÚ_li¡
(
sbi
, 
Çme
, 
hÙ
, 
£t
);

205 ià(
»t
)

206 
out
;

208 
»t
 = 
	`f2fs_comm™_su³r
(
sbi
, 
çl£
);

209 ià(
»t
)

210 
	`f2fs_upd©e_ex‹nsiÚ_li¡
(
sbi
, 
Çme
, 
hÙ
, !
£t
);

211 
out
:

212 
	`up_wr™e
(&
sbi
->
sb_lock
);

213  
»t
 ?„‘ : 
couÁ
;

216 
ui
 = (*)(
±r
 + 
a
->
off£t
);

218 
»t
 = 
	`k¡¹oul
(
	`sk_¥aûs
(
buf
), 0, &
t
);

219 ià(
»t
 < 0)

220  
»t
;

221 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


222 ià(
a
->
¡ruù_ty³
 =ğ
FAULT_INFO_TYPE
 && 
t
 >ğ(1 << 
FAULT_MAX
))

223  -
EINVAL
;

225 ià(
a
->
¡ruù_ty³
 =ğ
RESERVED_BLOCKS
) {

226 
	`¥š_lock
(&
sbi
->
¡©_lock
);

227 ià(
t
 > ()(
sbi
->
u£r_block_couÁ
 -

228 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
)) {

229 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

230  -
EINVAL
;

232 *
ui
 = 
t
;

233 
sbi
->
cu¼’t_»£rved_blocks
 = 
	`mš
(sbi->
»£rved_blocks
,

234 
sbi
->
u£r_block_couÁ
 - 
	`v®id_u£r_blocks
(sbi));

235 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

236  
couÁ
;

239 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "discard_granularity")) {

240 ià(
t
 =ğ0 || > 
MAX_PLIST_NUM
)

241  -
EINVAL
;

242 ià(
t
 =ğ*
ui
)

243  
couÁ
;

244 *
ui
 = 
t
;

245  
couÁ
;

248 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "trim_sections"))

249  -
EINVAL
;

251 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "gc_urgent")) {

252 ià(
t
 >= 1) {

253 
sbi
->
gc_mode
 = 
GC_URGENT
;

254 ià(
sbi
->
gc_th»ad
) {

255 
	`wake_up_š‹¼u±ibË_®l
(

256 &
sbi
->
gc_th»ad
->
gc_wa™_queue_h—d
);

257 
	`wake_up_disÿrd_th»ad
(
sbi
, 
Œue
);

260 
sbi
->
gc_mode
 = 
GC_NORMAL
;

262  
couÁ
;

264 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "gc_idle")) {

265 ià(
t
 =ğ
GC_IDLE_CB
)

266 
sbi
->
gc_mode
 = 
GC_IDLE_CB
;

267 ià(
t
 =ğ
GC_IDLE_GREEDY
)

268 
sbi
->
gc_mode
 = 
GC_IDLE_GREEDY
;

270 
sbi
->
gc_mode
 = 
GC_NORMAL
;

271  
couÁ
;

274 *
ui
 = 
t
;

276 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "io¡©_’abË"è&& *
ui
 == 0)

277 
	`f2fs_»£t_io¡©
(
sbi
);

278  
couÁ
;

279 
	}
}

281 
ssize_t
 
	$f2fs_sbi_¡Üe
(
f2fs_©Œ
 *
a
,

282 
f2fs_sb_šfo
 *
sbi
,

283 cÚ¡ *
buf
, 
size_t
 
couÁ
)

285 
ssize_t
 
»t
;

286 
boŞ
 
gc_’Œy
 = (!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "gc_urgent") ||

287 
a
->
¡ruù_ty³
 =ğ
GC_THREAD
);

289 ià(
gc_’Œy
)

290 
	`down_»ad
(&
sbi
->
sb
->
s_umouÁ
);

291 
»t
 = 
	`__sbi_¡Üe
(
a
, 
sbi
, 
buf
, 
couÁ
);

292 ià(
gc_’Œy
)

293 
	`up_»ad
(&
sbi
->
sb
->
s_umouÁ
);

295  
»t
;

296 
	}
}

298 
ssize_t
 
	$f2fs_©Œ_show
(
kobjeù
 *
kobj
,

299 
©Œibu‹
 *
©Œ
, *
buf
)

301 
f2fs_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, f2fs_sb_info,

302 
s_kobj
);

303 
f2fs_©Œ
 *
a
 = 
	`cÚš”_of
(
©Œ
, f2fs_attr,‡ttr);

305  
a
->
show
 ?‡->
	`show
×, 
sbi
, 
buf
) : 0;

306 
	}
}

308 
ssize_t
 
	$f2fs_©Œ_¡Üe
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

309 cÚ¡ *
buf
, 
size_t
 
Ën
)

311 
f2fs_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, f2fs_sb_info,

312 
s_kobj
);

313 
f2fs_©Œ
 *
a
 = 
	`cÚš”_of
(
©Œ
, f2fs_attr,‡ttr);

315  
a
->
¡Üe
 ?‡->
	`¡Üe
×, 
sbi
, 
buf
, 
Ën
) : 0;

316 
	}
}

318 
	$f2fs_sb_»Ëa£
(
kobjeù
 *
kobj
)

320 
f2fs_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, f2fs_sb_info,

321 
s_kobj
);

322 
	`com¶‘e
(&
sbi
->
s_kobj_uÄegi¡”
);

323 
	}
}

325 
	eã©_id
 {

326 
	mFEAT_CRYPTO
 = 0,

327 
	mFEAT_BLKZONED
,

328 
	mFEAT_ATOMIC_WRITE
,

329 
	mFEAT_EXTRA_ATTR
,

330 
	mFEAT_PROJECT_QUOTA
,

331 
	mFEAT_INODE_CHECKSUM
,

332 
	mFEAT_FLEXIBLE_INLINE_XATTR
,

333 
	mFEAT_QUOTA_INO
,

334 
	mFEAT_INODE_CRTIME
,

335 
	mFEAT_LOST_FOUND
,

338 
ssize_t
 
	$f2fs_ã©u»_show
(
f2fs_©Œ
 *
a
,

339 
f2fs_sb_šfo
 *
sbi
, *
buf
)

341 
a
->
id
) {

342 
FEAT_CRYPTO
:

343 
FEAT_BLKZONED
:

344 
FEAT_ATOMIC_WRITE
:

345 
FEAT_EXTRA_ATTR
:

346 
FEAT_PROJECT_QUOTA
:

347 
FEAT_INODE_CHECKSUM
:

348 
FEAT_FLEXIBLE_INLINE_XATTR
:

349 
FEAT_QUOTA_INO
:

350 
FEAT_INODE_CRTIME
:

351 
FEAT_LOST_FOUND
:

352  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "supported\n");

355 
	}
}

357 
	#F2FS_ATTR_OFFSET
(
_¡ruù_ty³
, 
_Çme
, 
_mode
, 
_show
, 
_¡Üe
, 
_off£t
) \

358 
f2fs_©Œ
 
f2fs_©Œ_
##
_Çme
 = { \

359 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

360 .
show
 = 
_show
, \

361 .
¡Üe
 = 
_¡Üe
, \

362 .
¡ruù_ty³
 = 
_¡ruù_ty³
, \

363 .
off£t
 = 
_off£t
 \

364 }

	)

366 
	#F2FS_RW_ATTR
(
¡ruù_ty³
, 
¡ruù_Çme
, 
Çme
, 
–Çme
) \

367 
	`F2FS_ATTR_OFFSET
(
¡ruù_ty³
, 
Çme
, 0644, \

368 
f2fs_sbi_show
, 
f2fs_sbi_¡Üe
, \

369 
	`off£tof
(
¡ruù_Çme
, 
–Çme
))

	)

371 
	#F2FS_GENERAL_RO_ATTR
(
Çme
) \

372 
f2fs_©Œ
 
f2fs_©Œ_
##
Çme
 = 
	`__ATTR
Òame, 0444,‚ame##
_show
, 
NULL
)

	)

374 
	#F2FS_FEATURE_RO_ATTR
(
_Çme
, 
_id
) \

375 
f2fs_©Œ
 
f2fs_©Œ_
##
_Çme
 = { \

376 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 0444 }, \

377 .
show
 = 
f2fs_ã©u»_show
, \

378 .
id
 = 
_id
, \

379 }

	)

381 
F2FS_RW_ATTR
(
GC_THREAD
, 
f2fs_gc_kth»ad
, 
gc_urg’t_¦“p_time
,

382 
urg’t_¦“p_time
);

383 
F2FS_RW_ATTR
(
GC_THREAD
, 
f2fs_gc_kth»ad
, 
gc_mš_¦“p_time
, 
mš_¦“p_time
);

384 
F2FS_RW_ATTR
(
GC_THREAD
, 
f2fs_gc_kth»ad
, 
gc_max_¦“p_time
, 
max_¦“p_time
);

385 
F2FS_RW_ATTR
(
GC_THREAD
, 
f2fs_gc_kth»ad
, 
gc_no_gc_¦“p_time
, 
no_gc_¦“p_time
);

386 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
gc_idË
, 
gc_mode
);

387 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
gc_urg’t
, 
gc_mode
);

388 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
»şaim_£gm’ts
, 
»c_´eä“_£gm’ts
);

389 
F2FS_RW_ATTR
(
DCC_INFO
, 
disÿrd_cmd_cÚŒŞ
, 
max_sm®l_disÿrds
, 
max_disÿrds
);

390 
F2FS_RW_ATTR
(
DCC_INFO
, 
disÿrd_cmd_cÚŒŞ
, 
disÿrd_g¿nuÏr™y
, discard_granularity);

391 
F2FS_RW_ATTR
(
RESERVED_BLOCKS
, 
f2fs_sb_šfo
, 
»£rved_blocks
,„eserved_blocks);

392 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
b©ched_Œim_£ùiÚs
, 
Œim_£ùiÚs
);

393 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
u_pŞicy
, ipu_policy);

394 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
mš_u_ut
, min_ipu_util);

395 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
mš_fsync_blocks
, min_fsync_blocks);

396 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
mš_hÙ_blocks
, min_hot_blocks);

397 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
mš_s¤_£ùiÚs
, min_ssr_sections);

398 
F2FS_RW_ATTR
(
NM_INFO
, 
f2fs_nm_šfo
, 
¿m_th»sh
,„am_thresh);

399 
F2FS_RW_ATTR
(
NM_INFO
, 
f2fs_nm_šfo
, 
¿_nid_·ges
,„a_nid_pages);

400 
F2FS_RW_ATTR
(
NM_INFO
, 
f2fs_nm_šfo
, 
dœty_Çts_¿tio
, dirty_nats_ratio);

401 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
max_viùim_£¬ch
, max_victim_search);

402 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
dœ_Ëv–
, dir_level);

403 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
ı_š‹rv®
, 
š‹rv®_time
[
CP_TIME
]);

404 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
idË_š‹rv®
, 
š‹rv®_time
[
REQ_TIME
]);

405 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
io¡©_’abË
, iostat_enable);

406 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
»addœ_¿
,„eaddir_ra);

407 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
gc_pš_fe_th»sh
, 
gc_pš_fe_th»shŞd
);

408 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_su³r_block
, 
ex‹nsiÚ_li¡
,ƒxtension_list);

409 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


410 
F2FS_RW_ATTR
(
FAULT_INFO_RATE
, 
f2fs_çuÉ_šfo
, 
šjeù_¿‹
, inject_rate);

411 
F2FS_RW_ATTR
(
FAULT_INFO_TYPE
, 
f2fs_çuÉ_šfo
, 
šjeù_ty³
, inject_type);

413 
F2FS_GENERAL_RO_ATTR
(
dœty_£gm’ts
);

414 
F2FS_GENERAL_RO_ATTR
(
liãtime_wr™e_kby‹s
);

415 
F2FS_GENERAL_RO_ATTR
(
ã©u»s
);

416 
F2FS_GENERAL_RO_ATTR
(
cu¼’t_»£rved_blocks
);

418 #ifdeà
CONFIG_F2FS_FS_ENCRYPTION


419 
F2FS_FEATURE_RO_ATTR
(
’üy±iÚ
, 
FEAT_CRYPTO
);

421 #ifdeà
CONFIG_BLK_DEV_ZONED


422 
F2FS_FEATURE_RO_ATTR
(
block_zÚed
, 
FEAT_BLKZONED
);

424 
F2FS_FEATURE_RO_ATTR
(
©omic_wr™e
, 
FEAT_ATOMIC_WRITE
);

425 
F2FS_FEATURE_RO_ATTR
(
exŒa_©Œ
, 
FEAT_EXTRA_ATTR
);

426 
F2FS_FEATURE_RO_ATTR
(
´ojeù_quÙa
, 
FEAT_PROJECT_QUOTA
);

427 
F2FS_FEATURE_RO_ATTR
(
šode_checksum
, 
FEAT_INODE_CHECKSUM
);

428 
F2FS_FEATURE_RO_ATTR
(
æexibË_šlše_x©Œ
, 
FEAT_FLEXIBLE_INLINE_XATTR
);

429 
F2FS_FEATURE_RO_ATTR
(
quÙa_šo
, 
FEAT_QUOTA_INO
);

430 
F2FS_FEATURE_RO_ATTR
(
šode_ütime
, 
FEAT_INODE_CRTIME
);

431 
F2FS_FEATURE_RO_ATTR
(
lo¡_found
, 
FEAT_LOST_FOUND
);

433 
	#ATTR_LIST
(
Çme
è(&
f2fs_©Œ_
##Çme.
©Œ
)

	)

434 
©Œibu‹
 *
	gf2fs_©Œs
[] = {

435 
ATTR_LIST
(
gc_urg’t_¦“p_time
),

436 
ATTR_LIST
(
gc_mš_¦“p_time
),

437 
ATTR_LIST
(
gc_max_¦“p_time
),

438 
ATTR_LIST
(
gc_no_gc_¦“p_time
),

439 
ATTR_LIST
(
gc_idË
),

440 
ATTR_LIST
(
gc_urg’t
),

441 
ATTR_LIST
(
»şaim_£gm’ts
),

442 
ATTR_LIST
(
max_sm®l_disÿrds
),

443 
ATTR_LIST
(
disÿrd_g¿nuÏr™y
),

444 
ATTR_LIST
(
b©ched_Œim_£ùiÚs
),

445 
ATTR_LIST
(
u_pŞicy
),

446 
ATTR_LIST
(
mš_u_ut
),

447 
ATTR_LIST
(
mš_fsync_blocks
),

448 
ATTR_LIST
(
mš_hÙ_blocks
),

449 
ATTR_LIST
(
mš_s¤_£ùiÚs
),

450 
ATTR_LIST
(
max_viùim_£¬ch
),

451 
ATTR_LIST
(
dœ_Ëv–
),

452 
ATTR_LIST
(
¿m_th»sh
),

453 
ATTR_LIST
(
¿_nid_·ges
),

454 
ATTR_LIST
(
dœty_Çts_¿tio
),

455 
ATTR_LIST
(
ı_š‹rv®
),

456 
ATTR_LIST
(
idË_š‹rv®
),

457 
ATTR_LIST
(
io¡©_’abË
),

458 
ATTR_LIST
(
»addœ_¿
),

459 
ATTR_LIST
(
gc_pš_fe_th»sh
),

460 
ATTR_LIST
(
ex‹nsiÚ_li¡
),

461 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


462 
ATTR_LIST
(
šjeù_¿‹
),

463 
ATTR_LIST
(
šjeù_ty³
),

465 
ATTR_LIST
(
dœty_£gm’ts
),

466 
ATTR_LIST
(
liãtime_wr™e_kby‹s
),

467 
ATTR_LIST
(
ã©u»s
),

468 
ATTR_LIST
(
»£rved_blocks
),

469 
ATTR_LIST
(
cu¼’t_»£rved_blocks
),

470 
NULL
,

473 
©Œibu‹
 *
	gf2fs_ã©_©Œs
[] = {

474 #ifdeà
CONFIG_F2FS_FS_ENCRYPTION


475 
ATTR_LIST
(
’üy±iÚ
),

477 #ifdeà
CONFIG_BLK_DEV_ZONED


478 
ATTR_LIST
(
block_zÚed
),

480 
ATTR_LIST
(
©omic_wr™e
),

481 
ATTR_LIST
(
exŒa_©Œ
),

482 
ATTR_LIST
(
´ojeù_quÙa
),

483 
ATTR_LIST
(
šode_checksum
),

484 
ATTR_LIST
(
æexibË_šlše_x©Œ
),

485 
ATTR_LIST
(
quÙa_šo
),

486 
ATTR_LIST
(
šode_ütime
),

487 
ATTR_LIST
(
lo¡_found
),

488 
NULL
,

491 cÚ¡ 
sysfs_İs
 
	gf2fs_©Œ_İs
 = {

492 .
show
 = 
f2fs_©Œ_show
,

493 .
	g¡Üe
 = 
f2fs_©Œ_¡Üe
,

496 
kobj_ty³
 
	gf2fs_sb_kty³
 = {

497 .
deçuÉ_©Œs
 = 
f2fs_©Œs
,

498 .
	gsysfs_İs
 = &
f2fs_©Œ_İs
,

499 .
	g»Ëa£
 = 
f2fs_sb_»Ëa£
,

502 
kobj_ty³
 
	gf2fs_kty³
 = {

503 .
sysfs_İs
 = &
f2fs_©Œ_İs
,

506 
k£t
 
	gf2fs_k£t
 = {

507 .
kobj
 = {.
kty³
 = &
f2fs_kty³
},

510 
kobj_ty³
 
	gf2fs_ã©_kty³
 = {

511 .
deçuÉ_©Œs
 = 
f2fs_ã©_©Œs
,

512 .
	gsysfs_İs
 = &
f2fs_©Œ_İs
,

515 
kobjeù
 
	gf2fs_ã©
 = {

516 .
k£t
 = &
f2fs_k£t
,

519 
	$£gm’t_šfo_£q_show
(
£q_fe
 *
£q
, *
off£t
)

521 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

522 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

523 
tÙ®_£gs
 =

524 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
£gm’t_couÁ_maš
);

525 
i
;

527 
	`£q_puts
(
£q
, "format: segment_type|valid_blocks\n"

530 
i
 = 0; i < 
tÙ®_£gs
; i++) {

531 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
i
);

533 ià((
i
 % 10) == 0)

534 
	`£q_´štf
(
£q
, "%-10d", 
i
);

535 
	`£q_´štf
(
£q
, "%d|%-3u", 
£
->
ty³
,

536 
	`g‘_v®id_blocks
(
sbi
, 
i
, 
çl£
));

537 ià((
i
 % 10è=ğ9 || i =ğ(
tÙ®_£gs
 - 1))

538 
	`£q_putc
(
£q
, '\n');

540 
	`£q_putc
(
£q
, ' ');

544 
	}
}

546 
	$£gm’t_b™s_£q_show
(
£q_fe
 *
£q
, *
off£t
)

548 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

549 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

550 
tÙ®_£gs
 =

551 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
£gm’t_couÁ_maš
);

552 
i
, 
j
;

554 
	`£q_puts
(
£q
, "format: segment_type|valid_blocks|bitmaps\n"

557 
i
 = 0; i < 
tÙ®_£gs
; i++) {

558 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
i
);

560 
	`£q_´štf
(
£q
, "%-10d", 
i
);

561 
	`£q_´štf
(
£q
, "%d|%-3u|", 
£
->
ty³
,

562 
	`g‘_v®id_blocks
(
sbi
, 
i
, 
çl£
));

563 
j
 = 0; j < 
SIT_VBLOCK_MAP_SIZE
; j++)

564 
	`£q_´štf
(
£q
, " %.2x", 
£
->
cur_v®id_m­
[
j
]);

565 
	`£q_putc
(
£q
, '\n');

568 
	}
}

570 
	$io¡©_šfo_£q_show
(
£q_fe
 *
£q
, *
off£t
)

572 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

573 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

574 
time64_t
 
now
 = 
	`ktime_g‘_»®_£cÚds
();

576 ià(!
sbi
->
io¡©_’abË
)

579 
	`£q_´štf
(
£q
, "time: %-16Îu\n", 
now
);

582 
	`£q_´štf
(
£q
, "app buffered: %-16llu\n",

583 
sbi
->
wr™e_io¡©
[
APP_BUFFERED_IO
]);

584 
	`£q_´štf
(
£q
, "app direct: %-16llu\n",

585 
sbi
->
wr™e_io¡©
[
APP_DIRECT_IO
]);

586 
	`£q_´štf
(
£q
, "app mapped: %-16llu\n",

587 
sbi
->
wr™e_io¡©
[
APP_MAPPED_IO
]);

590 
	`£q_´štf
(
£q
, "fs data: %-16llu\n",

591 
sbi
->
wr™e_io¡©
[
FS_DATA_IO
]);

592 
	`£q_´štf
(
£q
, "fs‚ode: %-16llu\n",

593 
sbi
->
wr™e_io¡©
[
FS_NODE_IO
]);

594 
	`£q_´štf
(
£q
, "fs meta: %-16llu\n",

595 
sbi
->
wr™e_io¡©
[
FS_META_IO
]);

596 
	`£q_´štf
(
£q
, "fs gc data: %-16llu\n",

597 
sbi
->
wr™e_io¡©
[
FS_GC_DATA_IO
]);

598 
	`£q_´štf
(
£q
, "fs gc‚ode: %-16llu\n",

599 
sbi
->
wr™e_io¡©
[
FS_GC_NODE_IO
]);

600 
	`£q_´štf
(
£q
, "fs cp data: %-16llu\n",

601 
sbi
->
wr™e_io¡©
[
FS_CP_DATA_IO
]);

602 
	`£q_´štf
(
£q
, "fs cp‚ode: %-16llu\n",

603 
sbi
->
wr™e_io¡©
[
FS_CP_NODE_IO
]);

604 
	`£q_´štf
(
£q
, "fs cp meta: %-16llu\n",

605 
sbi
->
wr™e_io¡©
[
FS_CP_META_IO
]);

606 
	`£q_´štf
(
£q
, "fs discard: %-16llu\n",

607 
sbi
->
wr™e_io¡©
[
FS_DISCARD
]);

610 
	}
}

612 
__š™
 
	$f2fs_š™_sysfs
()

614 
»t
;

616 
	`kobjeù_£t_Çme
(&
f2fs_k£t
.
kobj
, "f2fs");

617 
f2fs_k£t
.
kobj
.
·»Á
 = 
fs_kobj
;

618 
»t
 = 
	`k£t_»gi¡”
(&
f2fs_k£t
);

619 ià(
»t
)

620  
»t
;

622 
»t
 = 
	`kobjeù_š™_ªd_add
(&
f2fs_ã©
, &
f2fs_ã©_kty³
,

623 
NULL
, "features");

624 ià(
»t
)

625 
	`k£t_uÄegi¡”
(&
f2fs_k£t
);

627 
f2fs_´oc_roÙ
 = 
	`´oc_mkdœ
("fs/f2fs", 
NULL
);

628  
»t
;

629 
	}
}

631 
	$f2fs_ex™_sysfs
()

633 
	`kobjeù_put
(&
f2fs_ã©
);

634 
	`k£t_uÄegi¡”
(&
f2fs_k£t
);

635 
	`»move_´oc_’Œy
("fs/f2fs", 
NULL
);

636 
f2fs_´oc_roÙ
 = 
NULL
;

637 
	}
}

639 
	$f2fs_»gi¡”_sysfs
(
f2fs_sb_šfo
 *
sbi
)

641 
su³r_block
 *
sb
 = 
sbi
->sb;

642 
”r
;

644 
sbi
->
s_kobj
.
k£t
 = &
f2fs_k£t
;

645 
	`š™_com¶‘iÚ
(&
sbi
->
s_kobj_uÄegi¡”
);

646 
”r
 = 
	`kobjeù_š™_ªd_add
(&
sbi
->
s_kobj
, &
f2fs_sb_kty³
, 
NULL
,

647 "%s", 
sb
->
s_id
);

648 ià(
”r
)

649  
”r
;

651 ià(
f2fs_´oc_roÙ
)

652 
sbi
->
s_´oc
 = 
	`´oc_mkdœ
(
sb
->
s_id
, 
f2fs_´oc_roÙ
);

654 ià(
sbi
->
s_´oc
) {

655 
	`´oc_ü—‹_sšgË_d©a
("£gm’t_šfo", 
S_IRUGO
, 
sbi
->
s_´oc
,

656 
£gm’t_šfo_£q_show
, 
sb
);

657 
	`´oc_ü—‹_sšgË_d©a
("£gm’t_b™s", 
S_IRUGO
, 
sbi
->
s_´oc
,

658 
£gm’t_b™s_£q_show
, 
sb
);

659 
	`´oc_ü—‹_sšgË_d©a
("io¡©_šfo", 
S_IRUGO
, 
sbi
->
s_´oc
,

660 
io¡©_šfo_£q_show
, 
sb
);

663 
	}
}

665 
	$f2fs_uÄegi¡”_sysfs
(
f2fs_sb_šfo
 *
sbi
)

667 ià(
sbi
->
s_´oc
) {

668 
	`»move_´oc_’Œy
("io¡©_šfo", 
sbi
->
s_´oc
);

669 
	`»move_´oc_’Œy
("£gm’t_šfo", 
sbi
->
s_´oc
);

670 
	`»move_´oc_’Œy
("£gm’t_b™s", 
sbi
->
s_´oc
);

671 
	`»move_´oc_’Œy
(
sbi
->
sb
->
s_id
, 
f2fs_´oc_roÙ
);

673 
	`kobjeù_d–
(&
sbi
->
s_kobj
);

674 
	}
}

	@fs/f2fs/trace.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/sched.h
>

14 
	~<lšux/¿dix-Œ“.h
>

16 
	~"f2fs.h
"

17 
	~"Œaû.h
"

19 
RADIX_TREE
(
pids
, 
GFP_ATOMIC
);

20 
mu‹x
 
	gpids_lock
;

21 
Ï¡_io_šfo
 
	gÏ¡_io
;

23 
šlše
 
	$__´št_Ï¡_io
()

25 ià(!
Ï¡_io
.
Ën
)

28 
	`Œaû_´štk
("%3x:%3x %4x %-16s %2x %5x %5x %12x %4x\n",

29 
Ï¡_io
.
majÜ
,†a¡_io.
mšÜ
,

30 
Ï¡_io
.
pid
, "----------------",

31 
Ï¡_io
.
ty³
,

32 
Ï¡_io
.
fio
.
İ
,†a¡_io.fio.
İ_æags
,

33 
Ï¡_io
.
fio
.
Ãw_blkaddr
,

34 
Ï¡_io
.
Ën
);

35 
	`mem£t
(&
Ï¡_io
, 0, (last_io));

36 
	}
}

38 
	$__fe_ty³
(
šode
 *šode, 
pid_t
 
pid
)

40 ià(
	`f2fs_is_©omic_fe
(
šode
))

41  
__ATOMIC_FILE
;

42 ià(
	`f2fs_is_vŞ©e_fe
(
šode
))

43  
__VOLATILE_FILE
;

44 ià(
	`S_ISDIR
(
šode
->
i_mode
))

45  
__DIR_FILE
;

46 ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
	`F2FS_I_SB
(inode)))

47  
__NODE_FILE
;

48 ià(
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
	`F2FS_I_SB
(inode)))

49  
__META_FILE
;

50 ià(
pid
)

51  
__NORMAL_FILE
;

53  
__MISC_FILE
;

54 
	}
}

56 
	$f2fs_Œaû_pid
(
·ge
 *page)

58 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

59 
pid_t
 
pid
 = 
	`sk_pid_Ä
(
cu¼’t
);

60 *
p
;

62 
	`£t_·ge_´iv©e
(
·ge
, ()
pid
);

64 ià(
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
))

67 
	`mu‹x_lock
(&
pids_lock
);

68 
p
 = 
	`¿dix_Œ“_lookup
(&
pids
, 
pid
);

69 ià(
p
 =ğ
cu¼’t
)

70 
out
;

71 ià(
p
)

72 
	`¿dix_Œ“_d–‘e
(&
pids
, 
pid
);

74 
	`f2fs_¿dix_Œ“_š£¹
(&
pids
, 
pid
, 
cu¼’t
);

76 
	`Œaû_´štk
("%3x:%3x %4x %-16s\n",

77 
	`MAJOR
(
šode
->
i_sb
->
s_dev
), 
	`MINOR
(inode->i_sb->s_dev),

78 
pid
, 
cu¼’t
->
comm
);

79 
out
:

80 
	`mu‹x_uÆock
(&
pids_lock
);

81 
	`¿dix_Œ“_´–ßd_’d
();

82 
	}
}

84 
	$f2fs_Œaû_ios
(
f2fs_io_šfo
 *
fio
, 
æush
)

86 
šode
 *inode;

87 
pid_t
 
pid
;

88 
majÜ
, 
mšÜ
;

90 ià(
æush
) {

91 
	`__´št_Ï¡_io
();

95 
šode
 = 
fio
->
·ge
->
m­pšg
->
ho¡
;

96 
pid
 = 
	`·ge_´iv©e
(
fio
->
·ge
);

98 
majÜ
 = 
	`MAJOR
(
šode
->
i_sb
->
s_dev
);

99 
mšÜ
 = 
	`MINOR
(
šode
->
i_sb
->
s_dev
);

101 ià(
Ï¡_io
.
majÜ
 =ğmajÜ &&†a¡_io.
mšÜ
 == minor &&

102 
Ï¡_io
.
pid
 ==…id &&

103 
Ï¡_io
.
ty³
 =ğ
	`__fe_ty³
(
šode
, 
pid
) &&

104 
Ï¡_io
.
fio
.
İ
 == fio->op &&

105 
Ï¡_io
.
fio
.
İ_æags
 == fio->op_flags &&

106 
Ï¡_io
.
fio
.
Ãw_blkaddr
 +†a¡_io.
Ën
 ==

107 
fio
->
Ãw_blkaddr
) {

108 
Ï¡_io
.
Ën
++;

112 
	`__´št_Ï¡_io
();

114 
Ï¡_io
.
majÜ
 = major;

115 
Ï¡_io
.
mšÜ
 = minor;

116 
Ï¡_io
.
pid
 =…id;

117 
Ï¡_io
.
ty³
 = 
	`__fe_ty³
(
šode
, 
pid
);

118 
Ï¡_io
.
fio
 = *fio;

119 
Ï¡_io
.
Ën
 = 1;

121 
	}
}

123 
	$f2fs_bud_Œaû_ios
()

125 
	`mu‹x_š™
(&
pids_lock
);

126 
	}
}

128 
	#PIDVEC_SIZE
 128

	)

129 
	$gªg_lookup_pids
(
pid_t
 *
»suÉs
, 
fœ¡_šdex
,

130 
max_™ems
)

132 
¿dix_Œ“_™”
 
™”
;

133 **
¦Ù
;

134 
»t
 = 0;

136 ià(
	`uÆik–y
(!
max_™ems
))

139 
	`¿dix_Œ“_fÜ_—ch_¦Ù
(
¦Ù
, &
pids
, &
™”
, 
fœ¡_šdex
) {

140 
»suÉs
[
»t
] = 
™”
.
šdex
;

141 ià(++
»t
 =ğ
max_™ems
)

144  
»t
;

145 
	}
}

147 
	$f2fs_de¡roy_Œaû_ios
()

149 
pid_t
 
pid
[
PIDVEC_SIZE
];

150 
pid_t
 
Ãxt_pid
 = 0;

151 
found
;

153 
	`mu‹x_lock
(&
pids_lock
);

154 (
found
 = 
	`gªg_lookup_pids
(
pid
, 
Ãxt_pid
, 
PIDVEC_SIZE
))) {

155 
idx
;

157 
Ãxt_pid
 = 
pid
[
found
 - 1] + 1;

158 
idx
 = 0; idx < 
found
; idx++)

159 
	`¿dix_Œ“_d–‘e
(&
pids
, 
pid
[
idx
]);

161 
	`mu‹x_uÆock
(&
pids_lock
);

162 
	}
}

	@fs/f2fs/trace.h

11 #iâdeà
__F2FS_TRACE_H__


12 
	#__F2FS_TRACE_H__


	)

14 #ifdeà
CONFIG_F2FS_IO_TRACE


15 
	~<Œaû/ev’ts/f2fs.h
>

17 
	efe_ty³
 {

18 
	m__NORMAL_FILE
,

19 
	m__DIR_FILE
,

20 
	m__NODE_FILE
,

21 
	m__META_FILE
,

22 
	m__ATOMIC_FILE
,

23 
	m__VOLATILE_FILE
,

24 
	m__MISC_FILE
,

27 
	sÏ¡_io_šfo
 {

28 
	mmajÜ
, 
	mmšÜ
;

29 
pid_t
 
	mpid
;

30 
fe_ty³
 
	mty³
;

31 
f2fs_io_šfo
 
	mfio
;

32 
block_t
 
	mËn
;

35 
f2fs_Œaû_pid
(
·ge
 *);

36 
f2fs_Œaû_ios
(
f2fs_io_šfo
 *, );

37 
f2fs_bud_Œaû_ios
();

38 
f2fs_de¡roy_Œaû_ios
();

40 
	#f2fs_Œaû_pid
(
p
)

	)

41 
	#f2fs_Œaû_ios
(
i
, 
n
)

	)

42 
	#f2fs_bud_Œaû_ios
()

	)

43 
	#f2fs_de¡roy_Œaû_ios
()

	)

	@fs/f2fs/xattr.c

21 
	~<lšux/rw£m.h
>

22 
	~<lšux/f2fs_fs.h
>

23 
	~<lšux/£cur™y.h
>

24 
	~<lšux/posix_aş_x©Œ.h
>

25 
	~"f2fs.h
"

26 
	~"x©Œ.h
"

28 
	$f2fs_x©Œ_g’”ic_g‘
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

29 
d’Œy
 *
unu£d
, 
šode
 *inode,

30 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
size
)

32 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
šode
->
i_sb
);

34 
hªdËr
->
æags
) {

35 
F2FS_XATTR_INDEX_USER
:

36 ià(!
	`‹¡_İt
(
sbi
, 
XATTR_USER
))

37  -
EOPNOTSUPP
;

39 
F2FS_XATTR_INDEX_TRUSTED
:

40 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

41  -
EPERM
;

43 
F2FS_XATTR_INDEX_SECURITY
:

46  -
EINVAL
;

48  
	`f2fs_g‘x©Œ
(
šode
, 
hªdËr
->
æags
, 
Çme
,

49 
bufãr
, 
size
, 
NULL
);

50 
	}
}

52 
	$f2fs_x©Œ_g’”ic_£t
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

53 
d’Œy
 *
unu£d
, 
šode
 *inode,

54 cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

55 
size_t
 
size
, 
æags
)

57 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
šode
->
i_sb
);

59 
hªdËr
->
æags
) {

60 
F2FS_XATTR_INDEX_USER
:

61 ià(!
	`‹¡_İt
(
sbi
, 
XATTR_USER
))

62  -
EOPNOTSUPP
;

64 
F2FS_XATTR_INDEX_TRUSTED
:

65 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

66  -
EPERM
;

68 
F2FS_XATTR_INDEX_SECURITY
:

71  -
EINVAL
;

73  
	`f2fs_£tx©Œ
(
šode
, 
hªdËr
->
æags
, 
Çme
,

74 
v®ue
, 
size
, 
NULL
, 
æags
);

75 
	}
}

77 
boŞ
 
	$f2fs_x©Œ_u£r_li¡
(
d’Œy
 *dentry)

79 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
d’Œy
->
d_sb
);

81  
	`‹¡_İt
(
sbi
, 
XATTR_USER
);

82 
	}
}

84 
boŞ
 
	$f2fs_x©Œ_Œu¡ed_li¡
(
d’Œy
 *dentry)

86  
	`ÿ·bË
(
CAP_SYS_ADMIN
);

87 
	}
}

89 
	$f2fs_x©Œ_advi£_g‘
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

90 
d’Œy
 *
unu£d
, 
šode
 *inode,

91 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
size
)

93 ià(
bufãr
)

94 *((*)
bufãr
èğ
	`F2FS_I
(
šode
)->
i_advi£
;

96 
	}
}

98 
	$f2fs_x©Œ_advi£_£t
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

99 
d’Œy
 *
unu£d
, 
šode
 *inode,

100 cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

101 
size_t
 
size
, 
æags
)

103 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

104  -
EPERM
;

105 ià(
v®ue
 =ğ
NULL
)

106  -
EINVAL
;

108 
	`F2FS_I
(
šode
)->
i_advi£
 |ğ*(*)
v®ue
;

109 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

111 
	}
}

113 #ifdeà
CONFIG_F2FS_FS_SECURITY


114 
	$f2fs_š™x©Œs
(
šode
 *šode, cÚ¡ 
x©Œ
 *
x©Œ_¬¿y
,

115 *
·ge
)

117 cÚ¡ 
x©Œ
 *xattr;

118 
”r
 = 0;

120 
x©Œ
 = 
x©Œ_¬¿y
; x©Œ->
Çme
 !ğ
NULL
; xattr++) {

121 
”r
 = 
	`f2fs_£tx©Œ
(
šode
, 
F2FS_XATTR_INDEX_SECURITY
,

122 
x©Œ
->
Çme
, x©Œ->
v®ue
,

123 
x©Œ
->
v®ue_Ën
, (
·ge
 *)page, 0);

124 ià(
”r
 < 0)

127  
”r
;

128 
	}
}

130 
	$f2fs_š™_£cur™y
(
šode
 *šode, šod*
dœ
,

131 cÚ¡ 
q¡r
 *q¡r, 
·ge
 *
age
)

133  
	`£cur™y_šode_š™_£cur™y
(
šode
, 
dœ
, 
q¡r
,

134 &
f2fs_š™x©Œs
, 
age
);

135 
	}
}

138 cÚ¡ 
x©Œ_hªdËr
 
	gf2fs_x©Œ_u£r_hªdËr
 = {

139 .
´efix
 = 
XATTR_USER_PREFIX
,

140 .
	gæags
 = 
F2FS_XATTR_INDEX_USER
,

141 .
	gli¡
 = 
f2fs_x©Œ_u£r_li¡
,

142 .
	gg‘
 = 
f2fs_x©Œ_g’”ic_g‘
,

143 .
	g£t
 = 
f2fs_x©Œ_g’”ic_£t
,

146 cÚ¡ 
x©Œ_hªdËr
 
	gf2fs_x©Œ_Œu¡ed_hªdËr
 = {

147 .
´efix
 = 
XATTR_TRUSTED_PREFIX
,

148 .
	gæags
 = 
F2FS_XATTR_INDEX_TRUSTED
,

149 .
	gli¡
 = 
f2fs_x©Œ_Œu¡ed_li¡
,

150 .
	gg‘
 = 
f2fs_x©Œ_g’”ic_g‘
,

151 .
	g£t
 = 
f2fs_x©Œ_g’”ic_£t
,

154 cÚ¡ 
x©Œ_hªdËr
 
	gf2fs_x©Œ_advi£_hªdËr
 = {

155 .
Çme
 = 
F2FS_SYSTEM_ADVISE_NAME
,

156 .
	gæags
 = 
F2FS_XATTR_INDEX_ADVISE
,

157 .
	gg‘
 = 
f2fs_x©Œ_advi£_g‘
,

158 .
	g£t
 = 
f2fs_x©Œ_advi£_£t
,

161 cÚ¡ 
x©Œ_hªdËr
 
	gf2fs_x©Œ_£cur™y_hªdËr
 = {

162 .
´efix
 = 
XATTR_SECURITY_PREFIX
,

163 .
	gæags
 = 
F2FS_XATTR_INDEX_SECURITY
,

164 .
	gg‘
 = 
f2fs_x©Œ_g’”ic_g‘
,

165 .
	g£t
 = 
f2fs_x©Œ_g’”ic_£t
,

168 cÚ¡ 
x©Œ_hªdËr
 *
	gf2fs_x©Œ_hªdËr_m­
[] = {

169 [
F2FS_XATTR_INDEX_USER
] = &
f2fs_x©Œ_u£r_hªdËr
,

170 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


171 [
F2FS_XATTR_INDEX_POSIX_ACL_ACCESS
] = &
posix_aş_acûss_x©Œ_hªdËr
,

172 [
F2FS_XATTR_INDEX_POSIX_ACL_DEFAULT
] = &
posix_aş_deçuÉ_x©Œ_hªdËr
,

174 [
F2FS_XATTR_INDEX_TRUSTED
] = &
f2fs_x©Œ_Œu¡ed_hªdËr
,

175 #ifdeà
CONFIG_F2FS_FS_SECURITY


176 [
F2FS_XATTR_INDEX_SECURITY
] = &
f2fs_x©Œ_£cur™y_hªdËr
,

178 [
F2FS_XATTR_INDEX_ADVISE
] = &
f2fs_x©Œ_advi£_hªdËr
,

181 cÚ¡ 
x©Œ_hªdËr
 *
	gf2fs_x©Œ_hªdËrs
[] = {

182 &
f2fs_x©Œ_u£r_hªdËr
,

183 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


184 &
posix_aş_acûss_x©Œ_hªdËr
,

185 &
posix_aş_deçuÉ_x©Œ_hªdËr
,

187 &
f2fs_x©Œ_Œu¡ed_hªdËr
,

188 #ifdeà
CONFIG_F2FS_FS_SECURITY


189 &
f2fs_x©Œ_£cur™y_hªdËr
,

191 &
f2fs_x©Œ_advi£_hªdËr
,

192 
NULL
,

195 
šlše
 cÚ¡ 
x©Œ_hªdËr
 *
	$f2fs_x©Œ_hªdËr
(
šdex
)

197 cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
 = 
NULL
;

199 ià(
šdex
 > 0 && index < 
	`ARRAY_SIZE
(
f2fs_x©Œ_hªdËr_m­
))

200 
hªdËr
 = 
f2fs_x©Œ_hªdËr_m­
[
šdex
];

201  
hªdËr
;

202 
	}
}

204 
f2fs_x©Œ_’Œy
 *
	$__fšd_x©Œ
(*
ba£_addr
, 
šdex
,

205 
size_t
 
Ën
, cÚ¡ *
Çme
)

207 
f2fs_x©Œ_’Œy
 *
’Œy
;

209 
	`li¡_fÜ_—ch_x©Œ
(
’Œy
, 
ba£_addr
) {

210 ià(
’Œy
->
e_Çme_šdex
 !ğ
šdex
)

212 ià(
’Œy
->
e_Çme_Ën
 !ğ
Ën
)

214 ià(!
	`memcmp
(
’Œy
->
e_Çme
, 
Çme
, 
Ën
))

217  
’Œy
;

218 
	}
}

220 
f2fs_x©Œ_’Œy
 *
	$__fšd_šlše_x©Œ
(
šode
 *inode,

221 *
ba£_addr
, **
Ï¡_addr
, 
šdex
,

222 
size_t
 
Ën
, cÚ¡ *
Çme
)

224 
f2fs_x©Œ_’Œy
 *
’Œy
;

225 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

227 
	`li¡_fÜ_—ch_x©Œ
(
’Œy
, 
ba£_addr
) {

228 ià((*)
’Œy
 + (
__u32
è> 
ba£_addr
 + 
šlše_size
 ||

229 (*)
	`XATTR_NEXT_ENTRY
(
’Œy
è+ (
__u32
) >

230 
ba£_addr
 + 
šlše_size
) {

231 *
Ï¡_addr
 = 
’Œy
;

232  
NULL
;

234 ià(
’Œy
->
e_Çme_šdex
 !ğ
šdex
)

236 ià(
’Œy
->
e_Çme_Ën
 !ğ
Ën
)

238 ià(!
	`memcmp
(
’Œy
->
e_Çme
, 
Çme
, 
Ën
))

241  
’Œy
;

242 
	}
}

244 
	$»ad_šlše_x©Œ
(
šode
 *šode, 
·ge
 *
age
,

245 *
tx©Œ_addr
)

247 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

248 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

249 
·ge
 *·gğ
NULL
;

250 *
šlše_addr
;

252 ià(
age
) {

253 
šlše_addr
 = 
	`šlše_x©Œ_addr
(
šode
, 
age
);

255 
·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

256 ià(
	`IS_ERR
(
·ge
))

257  
	`PTR_ERR
(
·ge
);

259 
šlše_addr
 = 
	`šlše_x©Œ_addr
(
šode
, 
·ge
);

261 
	`memıy
(
tx©Œ_addr
, 
šlše_addr
, 
šlše_size
);

262 
	`f2fs_put_·ge
(
·ge
, 1);

265 
	}
}

267 
	$»ad_x©Œ_block
(
šode
 *šode, *
tx©Œ_addr
)

269 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

270 
nid_t
 
xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

271 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

272 
·ge
 *
x·ge
;

273 *
x©Œ_addr
;

276 
x·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
xnid
);

277 ià(
	`IS_ERR
(
x·ge
))

278  
	`PTR_ERR
(
x·ge
);

280 
x©Œ_addr
 = 
	`·ge_add»ss
(
x·ge
);

281 
	`memıy
(
tx©Œ_addr
 + 
šlše_size
, 
x©Œ_addr
, 
VALID_XATTR_BLOCK_SIZE
);

282 
	`f2fs_put_·ge
(
x·ge
, 1);

285 
	}
}

287 
	$lookup_®l_x©Œs
(
šode
 *šode, 
·ge
 *
age
,

288 
šdex
, 
Ën
,

289 cÚ¡ *
Çme
, 
f2fs_x©Œ_’Œy
 **
xe
,

290 **
ba£_addr
)

292 *
cur_addr
, *
tx©Œ_addr
, *
Ï¡_addr
 = 
NULL
;

293 
nid_t
 
xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

294 
size
 = 
xnid
 ? 
VALID_XATTR_BLOCK_SIZE
 : 0;

295 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

296 
”r
 = 0;

298 ià(!
size
 && !
šlše_size
)

299  -
ENODATA
;

301 
tx©Œ_addr
 = 
	`f2fs_kz®loc
(
	`F2FS_I_SB
(
šode
),

302 
šlše_size
 + 
size
 + 
XATTR_PADDING_SIZE
, 
GFP_NOFS
);

303 ià(!
tx©Œ_addr
)

304  -
ENOMEM
;

307 ià(
šlše_size
) {

308 
”r
 = 
	`»ad_šlše_x©Œ
(
šode
, 
age
, 
tx©Œ_addr
);

309 ià(
”r
)

310 
out
;

312 *
xe
 = 
	`__fšd_šlše_x©Œ
(
šode
, 
tx©Œ_addr
, &
Ï¡_addr
,

313 
šdex
, 
Ën
, 
Çme
);

314 ià(*
xe
)

315 
check
;

319 ià(
xnid
) {

320 
”r
 = 
	`»ad_x©Œ_block
(
šode
, 
tx©Œ_addr
);

321 ià(
”r
)

322 
out
;

325 ià(
Ï¡_addr
)

326 
cur_addr
 = 
	`XATTR_HDR
(
Ï¡_addr
) - 1;

328 
cur_addr
 = 
tx©Œ_addr
;

330 *
xe
 = 
	`__fšd_x©Œ
(
cur_addr
, 
šdex
, 
Ën
, 
Çme
);

331 
check
:

332 ià(
	`IS_XATTR_LAST_ENTRY
(*
xe
)) {

333 
”r
 = -
ENODATA
;

334 
out
;

337 *
ba£_addr
 = 
tx©Œ_addr
;

339 
out
:

340 
	`kzä“
(
tx©Œ_addr
);

341  
”r
;

342 
	}
}

344 
	$»ad_®l_x©Œs
(
šode
 *šode, 
·ge
 *
age
,

345 **
ba£_addr
)

347 
f2fs_x©Œ_h—d”
 *
h—d”
;

348 
nid_t
 
xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

349 
size
 = 
VALID_XATTR_BLOCK_SIZE
;

350 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

351 *
tx©Œ_addr
;

352 
”r
;

354 
tx©Œ_addr
 = 
	`f2fs_kz®loc
(
	`F2FS_I_SB
(
šode
),

355 
šlše_size
 + 
size
 + 
XATTR_PADDING_SIZE
, 
GFP_NOFS
);

356 ià(!
tx©Œ_addr
)

357  -
ENOMEM
;

360 ià(
šlše_size
) {

361 
”r
 = 
	`»ad_šlše_x©Œ
(
šode
, 
age
, 
tx©Œ_addr
);

362 ià(
”r
)

363 
ç
;

367 ià(
xnid
) {

368 
”r
 = 
	`»ad_x©Œ_block
(
šode
, 
tx©Œ_addr
);

369 ià(
”r
)

370 
ç
;

373 
h—d”
 = 
	`XATTR_HDR
(
tx©Œ_addr
);

376 ià(
	`Ë32_to_ıu
(
h—d”
->
h_magic
è!ğ
F2FS_XATTR_MAGIC
) {

377 
h—d”
->
h_magic
 = 
	`ıu_to_Ë32
(
F2FS_XATTR_MAGIC
);

378 
h—d”
->
h_»fcouÁ
 = 
	`ıu_to_Ë32
(1);

380 *
ba£_addr
 = 
tx©Œ_addr
;

382 
ç
:

383 
	`kzä“
(
tx©Œ_addr
);

384  
”r
;

385 
	}
}

387 
šlše
 
	$wr™e_®l_x©Œs
(
šode
 *šode, 
__u32
 
hsize
,

388 *
tx©Œ_addr
, 
·ge
 *
age
)

390 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

391 
size_t
 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

392 
·ge
 *
š_·ge
 = 
NULL
;

393 *
x©Œ_addr
;

394 *
šlše_addr
 = 
NULL
;

395 
·ge
 *
x·ge
;

396 
nid_t
 
Ãw_nid
 = 0;

397 
”r
 = 0;

399 ià(
hsize
 > 
šlše_size
 && !
	`F2FS_I
(
šode
)->
i_x©Œ_nid
)

400 ià(!
	`f2fs_®loc_nid
(
sbi
, &
Ãw_nid
))

401  -
ENOSPC
;

404 ià(
šlše_size
) {

405 ià(
age
) {

406 
šlše_addr
 = 
	`šlše_x©Œ_addr
(
šode
, 
age
);

408 
š_·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

409 ià(
	`IS_ERR
(
š_·ge
)) {

410 
	`f2fs_®loc_nid_çed
(
sbi
, 
Ãw_nid
);

411  
	`PTR_ERR
(
š_·ge
);

413 
šlše_addr
 = 
	`šlše_x©Œ_addr
(
šode
, 
š_·ge
);

416 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
 ? i·g: 
š_·ge
,

417 
NODE
, 
Œue
);

419 ià(
hsize
 <ğ
šlše_size
) {

420 
”r
 = 
	`f2fs_Œunÿ‹_x©Œ_node
(
šode
);

421 
	`f2fs_®loc_nid_çed
(
sbi
, 
Ãw_nid
);

422 ià(
”r
) {

423 
	`f2fs_put_·ge
(
š_·ge
, 1);

424  
”r
;

426 
	`memıy
(
šlše_addr
, 
tx©Œ_addr
, 
šlše_size
);

427 
	`£t_·ge_dœty
(
age
 ? i·g: 
š_·ge
);

428 
š_·ge_out
;

433 ià(
	`F2FS_I
(
šode
)->
i_x©Œ_nid
) {

434 
x·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
);

435 ià(
	`IS_ERR
(
x·ge
)) {

436 
”r
 = 
	`PTR_ERR
(
x·ge
);

437 
	`f2fs_®loc_nid_çed
(
sbi
, 
Ãw_nid
);

438 
š_·ge_out
;

440 
	`f2fs_bug_Ú
(
sbi
, 
Ãw_nid
);

441 
	`f2fs_wa™_Ú_·ge_wr™eback
(
x·ge
, 
NODE
, 
Œue
);

443 
dnode_of_d©a
 
dn
;

444 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 
Ãw_nid
);

445 
x·ge
 = 
	`f2fs_Ãw_node_·ge
(&
dn
, 
XATTR_NODE_OFFSET
);

446 ià(
	`IS_ERR
(
x·ge
)) {

447 
”r
 = 
	`PTR_ERR
(
x·ge
);

448 
	`f2fs_®loc_nid_çed
(
sbi
, 
Ãw_nid
);

449 
š_·ge_out
;

451 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
Ãw_nid
);

453 
x©Œ_addr
 = 
	`·ge_add»ss
(
x·ge
);

455 ià(
šlše_size
)

456 
	`memıy
(
šlše_addr
, 
tx©Œ_addr
, 
šlše_size
);

457 
	`memıy
(
x©Œ_addr
, 
tx©Œ_addr
 + 
šlše_size
, 
VALID_XATTR_BLOCK_SIZE
);

459 ià(
šlše_size
)

460 
	`£t_·ge_dœty
(
age
 ? i·g: 
š_·ge
);

461 
	`£t_·ge_dœty
(
x·ge
);

463 
	`f2fs_put_·ge
(
x·ge
, 1);

464 
š_·ge_out
:

465 
	`f2fs_put_·ge
(
š_·ge
, 1);

466  
”r
;

467 
	}
}

469 
	$f2fs_g‘x©Œ
(
šode
 *šode, 
šdex
, cÚ¡ *
Çme
,

470 *
bufãr
, 
size_t
 
bufãr_size
, 
·ge
 *
age
)

472 
f2fs_x©Œ_’Œy
 *
’Œy
 = 
NULL
;

473 
”rÜ
 = 0;

474 
size
, 
Ën
;

475 *
ba£_addr
 = 
NULL
;

477 ià(
Çme
 =ğ
NULL
)

478  -
EINVAL
;

480 
Ën
 = 
	`¡¾’
(
Çme
);

481 ià(
Ën
 > 
F2FS_NAME_LEN
)

482  -
ERANGE
;

484 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_x©Œ_£m
);

485 
”rÜ
 = 
	`lookup_®l_x©Œs
(
šode
, 
age
, 
šdex
, 
Ën
, 
Çme
,

486 &
’Œy
, &
ba£_addr
);

487 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_x©Œ_£m
);

488 ià(
”rÜ
)

489  
”rÜ
;

491 
size
 = 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_size
);

493 ià(
bufãr
 && 
size
 > 
bufãr_size
) {

494 
”rÜ
 = -
ERANGE
;

495 
out
;

498 ià(
bufãr
) {

499 *
pv®
 = 
’Œy
->
e_Çme
 +ƒÁry->
e_Çme_Ën
;

500 
	`memıy
(
bufãr
, 
pv®
, 
size
);

502 
”rÜ
 = 
size
;

503 
out
:

504 
	`kzä“
(
ba£_addr
);

505  
”rÜ
;

506 
	}
}

508 
ssize_t
 
	$f2fs_li¡x©Œ
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
bufãr_size
)

510 
šode
 *šodğ
	`d_šode
(
d’Œy
);

511 
f2fs_x©Œ_’Œy
 *
’Œy
;

512 *
ba£_addr
;

513 
”rÜ
 = 0;

514 
size_t
 
»¡
 = 
bufãr_size
;

516 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_x©Œ_£m
);

517 
”rÜ
 = 
	`»ad_®l_x©Œs
(
šode
, 
NULL
, &
ba£_addr
);

518 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_x©Œ_£m
);

519 ià(
”rÜ
)

520  
”rÜ
;

522 
	`li¡_fÜ_—ch_x©Œ
(
’Œy
, 
ba£_addr
) {

523 cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
 =

524 
	`f2fs_x©Œ_hªdËr
(
’Œy
->
e_Çme_šdex
);

525 cÚ¡ *
´efix
;

526 
size_t
 
´efix_Ën
;

527 
size_t
 
size
;

529 ià(!
hªdËr
 || (hªdËr->
li¡
 && !hªdËr->
	`li¡
(
d’Œy
)))

532 
´efix
 = 
hªdËr
->´efix ?: hªdËr->
Çme
;

533 
´efix_Ën
 = 
	`¡¾’
(
´efix
);

534 
size
 = 
´efix_Ën
 + 
’Œy
->
e_Çme_Ën
 + 1;

535 ià(
bufãr
) {

536 ià(
size
 > 
»¡
) {

537 
”rÜ
 = -
ERANGE
;

538 
ş—nup
;

540 
	`memıy
(
bufãr
, 
´efix
, 
´efix_Ën
);

541 
bufãr
 +ğ
´efix_Ën
;

542 
	`memıy
(
bufãr
, 
’Œy
->
e_Çme
,ƒÁry->
e_Çme_Ën
);

543 
bufãr
 +ğ
’Œy
->
e_Çme_Ën
;

544 *
bufãr
++ = 0;

546 
»¡
 -ğ
size
;

548 
”rÜ
 = 
bufãr_size
 - 
»¡
;

549 
ş—nup
:

550 
	`kzä“
(
ba£_addr
);

551  
”rÜ
;

552 
	}
}

554 
boŞ
 
	$f2fs_x©Œ_v®ue_§me
(
f2fs_x©Œ_’Œy
 *
’Œy
,

555 cÚ¡ *
v®ue
, 
size_t
 
size
)

557 *
pv®
 = 
’Œy
->
e_Çme
 +ƒÁry->
e_Çme_Ën
;

559  (
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_size
è=ğ
size
) &&

560 !
	`memcmp
(
pv®
, 
v®ue
, 
size
);

561 
	}
}

563 
	$__f2fs_£tx©Œ
(
šode
 *šode, 
šdex
,

564 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
size_t
 
size
,

565 
·ge
 *
age
, 
æags
)

567 
f2fs_x©Œ_’Œy
 *
h”e
, *
Ï¡
;

568 *
ba£_addr
;

569 
found
, 
Ãwsize
;

570 
size_t
 
Ën
;

571 
__u32
 
Ãw_hsize
;

572 
”rÜ
 = 0;

574 ià(
Çme
 =ğ
NULL
)

575  -
EINVAL
;

577 ià(
v®ue
 =ğ
NULL
)

578 
size
 = 0;

580 
Ën
 = 
	`¡¾’
(
Çme
);

582 ià(
Ën
 > 
F2FS_NAME_LEN
)

583  -
ERANGE
;

585 ià(
size
 > 
	`MAX_VALUE_LEN
(
šode
))

586  -
E2BIG
;

588 
”rÜ
 = 
	`»ad_®l_x©Œs
(
šode
, 
age
, &
ba£_addr
);

589 ià(
”rÜ
)

590  
”rÜ
;

593 
h”e
 = 
	`__fšd_x©Œ
(
ba£_addr
, 
šdex
, 
Ën
, 
Çme
);

595 
found
 = 
	`IS_XATTR_LAST_ENTRY
(
h”e
) ? 0 : 1;

597 ià(
found
) {

598 ià((
æags
 & 
XATTR_CREATE
)) {

599 
”rÜ
 = -
EEXIST
;

600 
ex™
;

603 ià(
v®ue
 && 
	`f2fs_x©Œ_v®ue_§me
(
h”e
, v®ue, 
size
))

604 
ex™
;

605 } ià((
æags
 & 
XATTR_REPLACE
)) {

606 
”rÜ
 = -
ENODATA
;

607 
ex™
;

610 
Ï¡
 = 
h”e
;

611 !
	`IS_XATTR_LAST_ENTRY
(
Ï¡
))

612 
Ï¡
 = 
	`XATTR_NEXT_ENTRY
(last);

614 
Ãwsize
 = 
	`XATTR_ALIGN
((
f2fs_x©Œ_’Œy
è+ 
Ën
 + 
size
);

617 ià(
v®ue
) {

618 
ä“
;

623 
ä“
 = 
	`MIN_OFFSET
(
šode
è- ((*)
Ï¡
 - (*)
ba£_addr
);

624 ià(
found
)

625 
ä“
 = f»+ 
	`ENTRY_SIZE
(
h”e
);

627 ià(
	`uÆik–y
(
ä“
 < 
Ãwsize
)) {

628 
”rÜ
 = -
E2BIG
;

629 
ex™
;

634 ià(
found
) {

639 
f2fs_x©Œ_’Œy
 *
Ãxt
 = 
	`XATTR_NEXT_ENTRY
(
h”e
);

640 
Şdsize
 = 
	`ENTRY_SIZE
(
h”e
);

642 
	`memmove
(
h”e
, 
Ãxt
, (*)
Ï¡
 - (*)next);

643 
Ï¡
 = (
f2fs_x©Œ_’Œy
 *)((*îa¡ - 
Şdsize
);

644 
	`mem£t
(
Ï¡
, 0, 
Şdsize
);

647 
Ãw_hsize
 = (*)
Ï¡
 - (*)
ba£_addr
;

650 ià(
v®ue
) {

651 *
pv®
;

656 
Ï¡
->
e_Çme_šdex
 = 
šdex
;

657 
Ï¡
->
e_Çme_Ën
 = 
Ën
;

658 
	`memıy
(
Ï¡
->
e_Çme
, 
Çme
, 
Ën
);

659 
pv®
 = 
Ï¡
->
e_Çme
 + 
Ën
;

660 
	`memıy
(
pv®
, 
v®ue
, 
size
);

661 
Ï¡
->
e_v®ue_size
 = 
	`ıu_to_Ë16
(
size
);

662 
Ãw_hsize
 +ğ
Ãwsize
;

665 
”rÜ
 = 
	`wr™e_®l_x©Œs
(
šode
, 
Ãw_hsize
, 
ba£_addr
, 
age
);

666 ià(
”rÜ
)

667 
ex™
;

669 ià(
	`is_šode_æag_£t
(
šode
, 
FI_ACL_MODE
)) {

670 
šode
->
i_mode
 = 
	`F2FS_I
(šode)->
i_aş_mode
;

671 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

672 
	`ş—r_šode_æag
(
šode
, 
FI_ACL_MODE
);

674 ià(
šdex
 =ğ
F2FS_XATTR_INDEX_ENCRYPTION
 &&

675 !
	`¡rcmp
(
Çme
, 
F2FS_XATTR_NAME_ENCRYPTION_CONTEXT
))

676 
	`f2fs_£t_’üy±ed_šode
(
šode
);

677 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

678 ià(!
”rÜ
 && 
	`S_ISDIR
(
šode
->
i_mode
))

679 
	`£t_sbi_æag
(
	`F2FS_I_SB
(
šode
), 
SBI_NEED_CP
);

680 
ex™
:

681 
	`kzä“
(
ba£_addr
);

682  
”rÜ
;

683 
	}
}

685 
	$f2fs_£tx©Œ
(
šode
 *šode, 
šdex
, cÚ¡ *
Çme
,

686 cÚ¡ *
v®ue
, 
size_t
 
size
,

687 
·ge
 *
age
, 
æags
)

689 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

690 
”r
;

692 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

693 ià(
”r
)

694  
”r
;

697 ià(
age
)

698  
	`__f2fs_£tx©Œ
(
šode
, 
šdex
, 
Çme
, 
v®ue
,

699 
size
, 
age
, 
æags
);

700 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

702 
	`f2fs_lock_İ
(
sbi
);

704 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

705 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_x©Œ_£m
);

706 
”r
 = 
	`__f2fs_£tx©Œ
(
šode
, 
šdex
, 
Çme
, 
v®ue
, 
size
, 
age
, 
æags
);

707 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_x©Œ_£m
);

708 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

709 
	`f2fs_uÆock_İ
(
sbi
);

711 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

712  
”r
;

713 
	}
}

	@fs/f2fs/xattr.h

17 #iâdeà
__F2FS_XATTR_H__


18 
	#__F2FS_XATTR_H__


	)

20 
	~<lšux/š™.h
>

21 
	~<lšux/x©Œ.h
>

24 
	#F2FS_XATTR_MAGIC
 0xF2F52011

	)

27 
	#F2FS_XATTR_REFCOUNT_MAX
 1024

	)

30 
	#F2FS_SYSTEM_ADVISE_NAME
 "sy¡em.advi£"

	)

31 
	#F2FS_XATTR_INDEX_USER
 1

	)

32 
	#F2FS_XATTR_INDEX_POSIX_ACL_ACCESS
 2

	)

33 
	#F2FS_XATTR_INDEX_POSIX_ACL_DEFAULT
 3

	)

34 
	#F2FS_XATTR_INDEX_TRUSTED
 4

	)

35 
	#F2FS_XATTR_INDEX_LUSTRE
 5

	)

36 
	#F2FS_XATTR_INDEX_SECURITY
 6

	)

37 
	#F2FS_XATTR_INDEX_ADVISE
 7

	)

39 
	#F2FS_XATTR_INDEX_ENCRYPTION
 9

	)

41 
	#F2FS_XATTR_NAME_ENCRYPTION_CONTEXT
 "c"

	)

43 
	sf2fs_x©Œ_h—d”
 {

44 
__Ë32
 
	mh_magic
;

45 
__Ë32
 
	mh_»fcouÁ
;

46 
__u32
 
	mh_»£rved
[4];

49 
	sf2fs_x©Œ_’Œy
 {

50 
__u8
 
	me_Çme_šdex
;

51 
__u8
 
	me_Çme_Ën
;

52 
__Ë16
 
	me_v®ue_size
;

53 
	me_Çme
[0];

56 
	#XATTR_HDR
(
±r
è((
f2fs_x©Œ_h—d”
 *)ÕŒ))

	)

57 
	#XATTR_ENTRY
(
±r
è((
f2fs_x©Œ_’Œy
 *)ÕŒ))

	)

58 
	#XATTR_FIRST_ENTRY
(
±r
è(
	`XATTR_ENTRY
(
	`XATTR_HDR
ÕŒè+ 1))

	)

59 
	#XATTR_ROUND
 (3)

	)

61 
	#XATTR_ALIGN
(
size
è(((sizeè+ 
XATTR_ROUND
è& ~XATTR_ROUND)

	)

63 
	#ENTRY_SIZE
(
’Œy
è(
	`XATTR_ALIGN
((
f2fs_x©Œ_’Œy
) + \

64 (
’Œy
)->
e_Çme_Ën
 + 
	`Ë16_to_ıu
(ÓÁry)->
e_v®ue_size
)))

	)

66 
	#XATTR_NEXT_ENTRY
(
’Œy
è((
f2fs_x©Œ_’Œy
 *)((*)(entry) +\

67 
	`ENTRY_SIZE
(
’Œy
)))

	)

69 
	#IS_XATTR_LAST_ENTRY
(
’Œy
è(*(
__u32
 *)ÓÁryè=ğ0)

	)

71 
	#li¡_fÜ_—ch_x©Œ
(
’Œy
, 
addr
) \

72 
’Œy
 = 
	`XATTR_FIRST_ENTRY
(
addr
);\

73 !
	`IS_XATTR_LAST_ENTRY
(
’Œy
);\

74 
’Œy
 = 
	`XATTR_NEXT_ENTRY
ÓÁry))

	)

75 
	#VALID_XATTR_BLOCK_SIZE
 (
PAGE_SIZE
 - (
node_foÙ”
))

	)

76 
	#XATTR_PADDING_SIZE
 ((
__u32
))

	)

77 
	#MIN_OFFSET
(
i
è
	`XATTR_ALIGN
(
	`šlše_x©Œ_size
(i) + \

78 
VALID_XATTR_BLOCK_SIZE
)

	)

80 
	#MAX_VALUE_LEN
(
i
è(
	`MIN_OFFSET
(i) - \

81 (
f2fs_x©Œ_h—d”
) - \

82 (
f2fs_x©Œ_’Œy
))

	)

113 #ifdeà
CONFIG_F2FS_FS_XATTR


114 cÚ¡ 
x©Œ_hªdËr
 
f2fs_x©Œ_u£r_hªdËr
;

115 cÚ¡ 
x©Œ_hªdËr
 
f2fs_x©Œ_Œu¡ed_hªdËr
;

116 cÚ¡ 
x©Œ_hªdËr
 
f2fs_x©Œ_advi£_hªdËr
;

117 cÚ¡ 
x©Œ_hªdËr
 
f2fs_x©Œ_£cur™y_hªdËr
;

119 cÚ¡ 
x©Œ_hªdËr
 *
f2fs_x©Œ_hªdËrs
[];

121 
f2fs_£tx©Œ
(
šode
 *, , const *,

122 cÚ¡ *, 
size_t
, 
·ge
 *, );

123 
f2fs_g‘x©Œ
(
šode
 *, , const *, *,

124 
size_t
, 
·ge
 *);

125 
ssize_t
 
f2fs_li¡x©Œ
(
d’Œy
 *, *, 
size_t
);

128 
	#f2fs_x©Œ_hªdËrs
 
NULL


	)

129 
šlše
 
	$f2fs_£tx©Œ
(
šode
 *šode, 
šdex
,

130 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
size_t
 
size
,

131 
·ge
 *·ge, 
æags
)

133  -
EOPNOTSUPP
;

134 
	}
}

135 
šlše
 
	$f2fs_g‘x©Œ
(
šode
 *šode, 
šdex
,

136 cÚ¡ *
Çme
, *
bufãr
,

137 
size_t
 
bufãr_size
, 
·ge
 *
d·ge
)

139  -
EOPNOTSUPP
;

140 
	}
}

141 
šlše
 
ssize_t
 
	$f2fs_li¡x©Œ
(
d’Œy
 *d’Œy, *
bufãr
,

142 
size_t
 
bufãr_size
)

144  -
EOPNOTSUPP
;

145 
	}
}

148 #ifdeà
CONFIG_F2FS_FS_SECURITY


149 
f2fs_š™_£cur™y
(
šode
 *, inode *,

150 cÚ¡ 
q¡r
 *, 
·ge
 *);

152 
šlše
 
	$f2fs_š™_£cur™y
(
šode
 *šode, šod*
dœ
,

153 cÚ¡ 
q¡r
 *q¡r, 
·ge
 *
age
)

156 
	}
}

	@include/linux/f2fs_fs.h

11 #iâdeà
_LINUX_F2FS_FS_H


12 
	#_LINUX_F2FS_FS_H


	)

14 
	~<lšux/·gem­.h
>

15 
	~<lšux/ty³s.h
>

17 
	#F2FS_SUPER_OFFSET
 1024

	)

18 
	#F2FS_MIN_LOG_SECTOR_SIZE
 9

	)

19 
	#F2FS_MAX_LOG_SECTOR_SIZE
 12

	)

20 
	#F2FS_LOG_SECTORS_PER_BLOCK
 3

	)

21 
	#F2FS_BLKSIZE
 4096

	)

22 
	#F2FS_BLKSIZE_BITS
 12

	)

23 
	#F2FS_MAX_EXTENSION
 64

	)

24 
	#F2FS_EXTENSION_LEN
 8

	)

25 
	#F2FS_BLK_ALIGN
(
x
è(((xè+ 
F2FS_BLKSIZE
 - 1è>> 
F2FS_BLKSIZE_BITS
)

	)

27 
	#NULL_ADDR
 ((
block_t
)0è

	)

28 
	#NEW_ADDR
 ((
block_t
)-1è

	)

30 
	#F2FS_BYTES_TO_BLK
(
by‹s
è((by‹sè>> 
F2FS_BLKSIZE_BITS
)

	)

31 
	#F2FS_BLK_TO_BYTES
(
blk
è((blkè<< 
F2FS_BLKSIZE_BITS
)

	)

34 
	#F2FS_RESERVED_NODE_NUM
 3

	)

36 
	#F2FS_ROOT_INO
(
sbi
è((sbi)->
roÙ_šo_num
)

	)

37 
	#F2FS_NODE_INO
(
sbi
è((sbi)->
node_šo_num
)

	)

38 
	#F2FS_META_INO
(
sbi
è((sbi)->
m‘a_šo_num
)

	)

40 
	#F2FS_MAX_QUOTAS
 3

	)

42 
	#F2FS_IO_SIZE
(
sbi
è(1 << 
	`F2FS_OPTION
(sbi).
wr™e_io_size_b™s
è

	)

43 
	#F2FS_IO_SIZE_KB
(
sbi
è(1 << (
	`F2FS_OPTION
(sbi).
wr™e_io_size_b™s
 + 2)è

	)

44 
	#F2FS_IO_SIZE_BYTES
(
sbi
è(1 << (
	`F2FS_OPTION
(sbi).
wr™e_io_size_b™s
 + 12)è

	)

45 
	#F2FS_IO_SIZE_BITS
(
sbi
è(
	`F2FS_OPTION
(sbi).
wr™e_io_size_b™s
è

	)

46 
	#F2FS_IO_SIZE_MASK
(
sbi
è(
	`F2FS_IO_SIZE
(sbiè- 1)

	)

49 
	#GFP_F2FS_ZERO
 (
GFP_NOFS
 | 
__GFP_ZERO
)

	)

57 
	#MAX_ACTIVE_LOGS
 16

	)

58 
	#MAX_ACTIVE_NODE_LOGS
 8

	)

59 
	#MAX_ACTIVE_DATA_LOGS
 8

	)

61 
	#VERSION_LEN
 256

	)

62 
	#MAX_VOLUME_NAME
 512

	)

63 
	#MAX_PATH_LEN
 64

	)

64 
	#MAX_DEVICES
 8

	)

69 
	sf2fs_deviû
 {

70 
__u8
 
	m·th
[
MAX_PATH_LEN
];

71 
__Ë32
 
	mtÙ®_£gm’ts
;

72 } 
	g__·cked
;

74 
	sf2fs_su³r_block
 {

75 
__Ë32
 
	mmagic
;

76 
__Ë16
 
	mmajÜ_v”
;

77 
__Ë16
 
	mmšÜ_v”
;

78 
__Ë32
 
	mlog_£ùÜsize
;

79 
__Ë32
 
	mlog_£ùÜs_³r_block
;

80 
__Ë32
 
	mlog_blocksize
;

81 
__Ë32
 
	mlog_blocks_³r_£g
;

82 
__Ë32
 
	m£gs_³r_£c
;

83 
__Ë32
 
	m£cs_³r_zÚe
;

84 
__Ë32
 
	mchecksum_off£t
;

85 
__Ë64
 
	mblock_couÁ
;

86 
__Ë32
 
	m£ùiÚ_couÁ
;

87 
__Ë32
 
	m£gm’t_couÁ
;

88 
__Ë32
 
	m£gm’t_couÁ_ck±
;

89 
__Ë32
 
	m£gm’t_couÁ_s™
;

90 
__Ë32
 
	m£gm’t_couÁ_Çt
;

91 
__Ë32
 
	m£gm’t_couÁ_s§
;

92 
__Ë32
 
	m£gm’t_couÁ_maš
;

93 
__Ë32
 
	m£gm’t0_blkaddr
;

94 
__Ë32
 
	mı_blkaddr
;

95 
__Ë32
 
	ms™_blkaddr
;

96 
__Ë32
 
	mÇt_blkaddr
;

97 
__Ë32
 
	ms§_blkaddr
;

98 
__Ë32
 
	mmaš_blkaddr
;

99 
__Ë32
 
	mroÙ_šo
;

100 
__Ë32
 
	mnode_šo
;

101 
__Ë32
 
	mm‘a_šo
;

102 
__u8
 
	muuid
[16];

103 
__Ë16
 
	mvŞume_Çme
[
MAX_VOLUME_NAME
];

104 
__Ë32
 
	mex‹nsiÚ_couÁ
;

105 
__u8
 
	mex‹nsiÚ_li¡
[
F2FS_MAX_EXTENSION
][
F2FS_EXTENSION_LEN
];

106 
__Ë32
 
	mı_·ylßd
;

107 
__u8
 
	mv”siÚ
[
VERSION_LEN
];

108 
__u8
 
	mš™_v”siÚ
[
VERSION_LEN
];

109 
__Ë32
 
	mã©u»
;

110 
__u8
 
	m’üy±iÚ_Ëv–
;

111 
__u8
 
	m’üy±_pw_§É
[16];

112 
f2fs_deviû
 
	mdevs
[
MAX_DEVICES
];

113 
__Ë32
 
	mqf_šo
[
F2FS_MAX_QUOTAS
];

114 
__u8
 
	mhÙ_ext_couÁ
;

115 
__u8
 
	m»£rved
[314];

116 } 
	g__·cked
;

121 
	#CP_LARGE_NAT_BITMAP_FLAG
 0x00000400

	)

122 
	#CP_NOCRC_RECOVERY_FLAG
 0x00000200

	)

123 
	#CP_TRIMMED_FLAG
 0x00000100

	)

124 
	#CP_NAT_BITS_FLAG
 0x00000080

	)

125 
	#CP_CRC_RECOVERY_FLAG
 0x00000040

	)

126 
	#CP_FASTBOOT_FLAG
 0x00000020

	)

127 
	#CP_FSCK_FLAG
 0x00000010

	)

128 
	#CP_ERROR_FLAG
 0x00000008

	)

129 
	#CP_COMPACT_SUM_FLAG
 0x00000004

	)

130 
	#CP_ORPHAN_PRESENT_FLAG
 0x00000002

	)

131 
	#CP_UMOUNT_FLAG
 0x00000001

	)

133 
	#F2FS_CP_PACKS
 2

	)

135 
	sf2fs_checkpošt
 {

136 
__Ë64
 
	mcheckpošt_v”
;

137 
__Ë64
 
	mu£r_block_couÁ
;

138 
__Ë64
 
	mv®id_block_couÁ
;

139 
__Ë32
 
	mrsvd_£gm’t_couÁ
;

140 
__Ë32
 
	mov”´ov_£gm’t_couÁ
;

141 
__Ë32
 
	mä“_£gm’t_couÁ
;

144 
__Ë32
 
	mcur_node_£gno
[
MAX_ACTIVE_NODE_LOGS
];

145 
__Ë16
 
	mcur_node_blkoff
[
MAX_ACTIVE_NODE_LOGS
];

147 
__Ë32
 
	mcur_d©a_£gno
[
MAX_ACTIVE_DATA_LOGS
];

148 
__Ë16
 
	mcur_d©a_blkoff
[
MAX_ACTIVE_DATA_LOGS
];

149 
__Ë32
 
	mck±_æags
;

150 
__Ë32
 
	mı_·ck_tÙ®_block_couÁ
;

151 
__Ë32
 
	mı_·ck_¡¬t_sum
;

152 
__Ë32
 
	mv®id_node_couÁ
;

153 
__Ë32
 
	mv®id_šode_couÁ
;

154 
__Ë32
 
	mÃxt_ä“_nid
;

155 
__Ë32
 
	ms™_v”_b™m­_by‹size
;

156 
__Ë32
 
	mÇt_v”_b™m­_by‹size
;

157 
__Ë32
 
	mchecksum_off£t
;

158 
__Ë64
 
	m–­£d_time
;

160 
	m®loc_ty³
[
MAX_ACTIVE_LOGS
];

163 
	ms™_Çt_v”siÚ_b™m­
[1];

164 } 
	g__·cked
;

169 
	#F2FS_ORPHANS_PER_BLOCK
 1020

	)

171 
	#GET_ORPHAN_BLOCKS
(
n
è((Òè+ 
F2FS_ORPHANS_PER_BLOCK
 - 1) / \

172 
F2FS_ORPHANS_PER_BLOCK
)

	)

174 
	sf2fs_Üphª_block
 {

175 
__Ë32
 
	mšo
[
F2FS_ORPHANS_PER_BLOCK
];

176 
__Ë32
 
	m»£rved
;

177 
__Ë16
 
	mblk_addr
;

178 
__Ë16
 
	mblk_couÁ
;

179 
__Ë32
 
	m’Œy_couÁ
;

180 
__Ë32
 
	mcheck_sum
;

181 } 
	g__·cked
;

186 
	sf2fs_ex‹Á
 {

187 
__Ë32
 
	mfofs
;

188 
__Ë32
 
	mblk
;

189 
__Ë32
 
	mËn
;

190 } 
	g__·cked
;

192 
	#F2FS_NAME_LEN
 255

	)

194 
	#DEFAULT_INLINE_XATTR_ADDRS
 50

	)

195 
	#DEF_ADDRS_PER_INODE
 923

	)

196 
	#CUR_ADDRS_PER_INODE
(
šode
è(
DEF_ADDRS_PER_INODE
 - \

197 
	`g‘_exŒa_isize
(
šode
))

	)

198 
	#DEF_NIDS_PER_INODE
 5

	)

199 
	#ADDRS_PER_INODE
(
šode
è
	`addrs_³r_šode
(šode)

	)

200 
	#ADDRS_PER_BLOCK
 1018

	)

201 
	#NIDS_PER_BLOCK
 1018

	)

203 
	#ADDRS_PER_PAGE
(
·ge
, 
šode
) \

204 (
	`IS_INODE
(
·ge
è? 
	`ADDRS_PER_INODE
(
šode
è: 
ADDRS_PER_BLOCK
)

	)

206 
	#NODE_DIR1_BLOCK
 (
DEF_ADDRS_PER_INODE
 + 1)

	)

207 
	#NODE_DIR2_BLOCK
 (
DEF_ADDRS_PER_INODE
 + 2)

	)

208 
	#NODE_IND1_BLOCK
 (
DEF_ADDRS_PER_INODE
 + 3)

	)

209 
	#NODE_IND2_BLOCK
 (
DEF_ADDRS_PER_INODE
 + 4)

	)

210 
	#NODE_DIND_BLOCK
 (
DEF_ADDRS_PER_INODE
 + 5)

	)

212 
	#F2FS_INLINE_XATTR
 0x01

	)

213 
	#F2FS_INLINE_DATA
 0x02

	)

214 
	#F2FS_INLINE_DENTRY
 0x04

	)

215 
	#F2FS_DATA_EXIST
 0x08

	)

216 
	#F2FS_INLINE_DOTS
 0x10

	)

217 
	#F2FS_EXTRA_ATTR
 0x20

	)

218 
	#F2FS_PIN_FILE
 0x40

	)

220 
	sf2fs_šode
 {

221 
__Ë16
 
	mi_mode
;

222 
__u8
 
	mi_advi£
;

223 
__u8
 
	mi_šlše
;

224 
__Ë32
 
	mi_uid
;

225 
__Ë32
 
	mi_gid
;

226 
__Ë32
 
	mi_lšks
;

227 
__Ë64
 
	mi_size
;

228 
__Ë64
 
	mi_blocks
;

229 
__Ë64
 
	mi_©ime
;

230 
__Ë64
 
	mi_ùime
;

231 
__Ë64
 
	mi_mtime
;

232 
__Ë32
 
	mi_©ime_n£c
;

233 
__Ë32
 
	mi_ùime_n£c
;

234 
__Ë32
 
	mi_mtime_n£c
;

235 
__Ë32
 
	mi_g’”©iÚ
;

237 
__Ë32
 
	mi_cu¼’t_d•th
;

238 
__Ë16
 
	mi_gc_çu»s
;

243 
__Ë32
 
	mi_x©Œ_nid
;

244 
__Ë32
 
	mi_æags
;

245 
__Ë32
 
	mi_pšo
;

246 
__Ë32
 
	mi_Çm–’
;

247 
__u8
 
	mi_Çme
[
F2FS_NAME_LEN
];

248 
__u8
 
	mi_dœ_Ëv–
;

250 
f2fs_ex‹Á
 
	mi_ext
;

254 
__Ë16
 
	mi_exŒa_isize
;

255 
__Ë16
 
	mi_šlše_x©Œ_size
;

256 
__Ë32
 
	mi_´ojid
;

257 
__Ë32
 
	mi_šode_checksum
;

258 
__Ë64
 
	mi_ütime
;

259 
__Ë32
 
	mi_ütime_n£c
;

260 
__Ë32
 
	mi_exŒa_’d
[0];

261 } 
	m__·cked
;

262 
__Ë32
 
	mi_addr
[
DEF_ADDRS_PER_INODE
];

264 
__Ë32
 
	mi_nid
[
DEF_NIDS_PER_INODE
];

266 } 
	g__·cked
;

268 
	sdœeù_node
 {

269 
__Ë32
 
	maddr
[
ADDRS_PER_BLOCK
];

270 } 
	g__·cked
;

272 
	sšdœeù_node
 {

273 
__Ë32
 
	mnid
[
NIDS_PER_BLOCK
];

274 } 
	g__·cked
;

277 
	mCOLD_BIT_SHIFT
 = 0,

278 
	mFSYNC_BIT_SHIFT
,

279 
	mDENT_BIT_SHIFT
,

280 
	mOFFSET_BIT_SHIFT


283 
	#OFFSET_BIT_MASK
 (0x07è

	)

285 
	snode_foÙ”
 {

286 
__Ë32
 
	mnid
;

287 
__Ë32
 
	mšo
;

288 
__Ë32
 
	mæag
;

289 
__Ë64
 
	mı_v”
;

290 
__Ë32
 
	mÃxt_blkaddr
;

291 } 
	g__·cked
;

293 
	sf2fs_node
 {

296 
f2fs_šode
 
	mi
;

297 
dœeù_node
 
	mdn
;

298 
šdœeù_node
 
	mš
;

300 
node_foÙ”
 
	mfoÙ”
;

301 } 
	g__·cked
;

306 
	#NAT_ENTRY_PER_BLOCK
 (
PAGE_SIZE
 / (
f2fs_Çt_’Œy
))

	)

307 
	#NAT_ENTRY_BITMAP_SIZE
 ((
NAT_ENTRY_PER_BLOCK
 + 7è/ 8)

	)

308 
	#NAT_ENTRY_BITMAP_SIZE_ALIGNED
 \

309 ((
NAT_ENTRY_BITMAP_SIZE
 + 
BITS_PER_LONG
 - 1) / \

310 
BITS_PER_LONG
 * BITS_PER_LONG)

	)

313 
	sf2fs_Çt_’Œy
 {

314 
__u8
 
	mv”siÚ
;

315 
__Ë32
 
	mšo
;

316 
__Ë32
 
	mblock_addr
;

317 } 
	g__·cked
;

319 
	sf2fs_Çt_block
 {

320 
f2fs_Çt_’Œy
 
	m’Œ›s
[
NAT_ENTRY_PER_BLOCK
];

321 } 
	g__·cked
;

330 
	#SIT_VBLOCK_MAP_SIZE
 64

	)

331 
	#SIT_ENTRY_PER_BLOCK
 (
PAGE_SIZE
 / (
f2fs_s™_’Œy
))

	)

337 
	#F2FS_MAX_SEGMENT
 ((16 * 1024 * 1024è/ 2)

	)

344 
	#SIT_VBLOCKS_SHIFT
 10

	)

345 
	#SIT_VBLOCKS_MASK
 ((1 << 
SIT_VBLOCKS_SHIFT
è- 1)

	)

346 
	#GET_SIT_VBLOCKS
(
¿w_s™
) \

347 (
	`Ë16_to_ıu
((
¿w_s™
)->
vblocks
è& 
SIT_VBLOCKS_MASK
)

	)

348 
	#GET_SIT_TYPE
(
¿w_s™
) \

349 ((
	`Ë16_to_ıu
((
¿w_s™
)->
vblocks
è& ~
SIT_VBLOCKS_MASK
) \

350 >> 
SIT_VBLOCKS_SHIFT
)

	)

352 
	sf2fs_s™_’Œy
 {

353 
__Ë16
 
	mvblocks
;

354 
__u8
 
	mv®id_m­
[
SIT_VBLOCK_MAP_SIZE
];

355 
__Ë64
 
	mmtime
;

356 } 
	g__·cked
;

358 
	sf2fs_s™_block
 {

359 
f2fs_s™_’Œy
 
	m’Œ›s
[
SIT_ENTRY_PER_BLOCK
];

360 } 
	g__·cked
;

377 
	#ENTRIES_IN_SUM
 512

	)

378 
	#SUMMARY_SIZE
 (7è

	)

379 
	#SUM_FOOTER_SIZE
 (5è

	)

380 
	#SUM_ENTRY_SIZE
 (
SUMMARY_SIZE
 * 
ENTRIES_IN_SUM
)

	)

383 
	sf2fs_summ¬y
 {

384 
__Ë32
 
	mnid
;

386 
__u8
 
	m»£rved
[3];

388 
__u8
 
	mv”siÚ
;

389 
__Ë16
 
	mofs_š_node
;

390 } 
	m__·cked
;

392 } 
	g__·cked
;

395 
	#SUM_TYPE_NODE
 (1)

	)

396 
	#SUM_TYPE_DATA
 (0)

	)

398 
	ssumm¬y_foÙ”
 {

399 
	m’Œy_ty³
;

400 
__Ë32
 
	mcheck_sum
;

401 } 
	g__·cked
;

403 
	#SUM_JOURNAL_SIZE
 (
F2FS_BLKSIZE
 - 
SUM_FOOTER_SIZE
 -\

404 
SUM_ENTRY_SIZE
)

	)

405 
	#NAT_JOURNAL_ENTRIES
 ((
SUM_JOURNAL_SIZE
 - 2) /\

406 (
Çt_jouº®_’Œy
))

	)

407 
	#NAT_JOURNAL_RESERVED
 ((
SUM_JOURNAL_SIZE
 - 2) %\

408 (
Çt_jouº®_’Œy
))

	)

409 
	#SIT_JOURNAL_ENTRIES
 ((
SUM_JOURNAL_SIZE
 - 2) /\

410 (
s™_jouº®_’Œy
))

	)

411 
	#SIT_JOURNAL_RESERVED
 ((
SUM_JOURNAL_SIZE
 - 2) %\

412 (
s™_jouº®_’Œy
))

	)

417 
	#EXTRA_INFO_RESERVED
 (
SUM_JOURNAL_SIZE
 - 2 - 8)

	)

424 
	mNAT_JOURNAL
 = 0,

425 
	mSIT_JOURNAL


428 
	sÇt_jouº®_’Œy
 {

429 
__Ë32
 
	mnid
;

430 
f2fs_Çt_’Œy
 
	mÃ
;

431 } 
	g__·cked
;

433 
	sÇt_jouº®
 {

434 
Çt_jouº®_’Œy
 
	m’Œ›s
[
NAT_JOURNAL_ENTRIES
];

435 
__u8
 
	m»£rved
[
NAT_JOURNAL_RESERVED
];

436 } 
	g__·cked
;

438 
	ss™_jouº®_’Œy
 {

439 
__Ë32
 
	m£gno
;

440 
f2fs_s™_’Œy
 
	m£
;

441 } 
	g__·cked
;

443 
	ss™_jouº®
 {

444 
s™_jouº®_’Œy
 
	m’Œ›s
[
SIT_JOURNAL_ENTRIES
];

445 
__u8
 
	m»£rved
[
SIT_JOURNAL_RESERVED
];

446 } 
	g__·cked
;

448 
	sf2fs_exŒa_šfo
 {

449 
__Ë64
 
	mkby‹s_wr™‹n
;

450 
__u8
 
	m»£rved
[
EXTRA_INFO_RESERVED
];

451 } 
	g__·cked
;

453 
	sf2fs_jouº®
 {

455 
__Ë16
 
	mn_Çts
;

456 
__Ë16
 
	mn_s™s
;

460 
Çt_jouº®
 
	mÇt_j
;

461 
s™_jouº®
 
	ms™_j
;

462 
f2fs_exŒa_šfo
 
	mšfo
;

464 } 
	g__·cked
;

467 
	sf2fs_summ¬y_block
 {

468 
f2fs_summ¬y
 
	m’Œ›s
[
ENTRIES_IN_SUM
];

469 
f2fs_jouº®
 
	mjouº®
;

470 
summ¬y_foÙ”
 
	mfoÙ”
;

471 } 
	g__·cked
;

476 
	#F2FS_DOT_HASH
 0

	)

477 
	#F2FS_DDOT_HASH
 
F2FS_DOT_HASH


	)

478 
	#F2FS_MAX_HASH
 (~((0x3ULLè<< 62))

	)

479 
	#F2FS_HASH_COL_BIT
 ((0x1ULLè<< 63)

	)

481 
__Ë32
 
	tf2fs_hash_t
;

484 
	#F2FS_SLOT_LEN
 8

	)

485 
	#F2FS_SLOT_LEN_BITS
 3

	)

487 
	#GET_DENTRY_SLOTS
(
x
è(((xè+ 
F2FS_SLOT_LEN
 - 1è>> 
F2FS_SLOT_LEN_BITS
)

	)

490 
	#MAX_DIR_HASH_DEPTH
 63

	)

493 
	#MAX_DIR_BUCKETS
 (1 << ((
MAX_DIR_HASH_DEPTH
 / 2è- 1))

	)

507 
	#NR_DENTRY_IN_BLOCK
 214

	)

508 
	#SIZE_OF_DIR_ENTRY
 11

	)

509 
	#SIZE_OF_DENTRY_BITMAP
 ((
NR_DENTRY_IN_BLOCK
 + 
BITS_PER_BYTE
 - 1) / \

510 
BITS_PER_BYTE
)

	)

511 
	#SIZE_OF_RESERVED
 (
PAGE_SIZE
 - ((
SIZE_OF_DIR_ENTRY
 + \

512 
F2FS_SLOT_LEN
) * \

513 
NR_DENTRY_IN_BLOCK
 + 
SIZE_OF_DENTRY_BITMAP
))

	)

516 
	sf2fs_dœ_’Œy
 {

517 
__Ë32
 
	mhash_code
;

518 
__Ë32
 
	mšo
;

519 
__Ë16
 
	mÇme_Ën
;

520 
__u8
 
	mfe_ty³
;

521 } 
	g__·cked
;

524 
	sf2fs_d’Œy_block
 {

526 
__u8
 
	md’Œy_b™m­
[
SIZE_OF_DENTRY_BITMAP
];

527 
__u8
 
	m»£rved
[
SIZE_OF_RESERVED
];

528 
f2fs_dœ_’Œy
 
	md’Œy
[
NR_DENTRY_IN_BLOCK
];

529 
__u8
 
	mf’ame
[
NR_DENTRY_IN_BLOCK
][
F2FS_SLOT_LEN
];

530 } 
	g__·cked
;

534 
	mF2FS_FT_UNKNOWN
,

535 
	mF2FS_FT_REG_FILE
,

536 
	mF2FS_FT_DIR
,

537 
	mF2FS_FT_CHRDEV
,

538 
	mF2FS_FT_BLKDEV
,

539 
	mF2FS_FT_FIFO
,

540 
	mF2FS_FT_SOCK
,

541 
	mF2FS_FT_SYMLINK
,

542 
	mF2FS_FT_MAX


545 
	#S_SHIFT
 12

	)

547 
	#F2FS_DEF_PROJID
 0

	)

	@
1
.
0
28
461
fs/f2fs/acl.c
fs/f2fs/acl.h
fs/f2fs/checkpoint.c
fs/f2fs/data.c
fs/f2fs/debug.c
fs/f2fs/dir.c
fs/f2fs/extent_cache.c
fs/f2fs/f2fs.h
fs/f2fs/file.c
fs/f2fs/gc.c
fs/f2fs/gc.h
fs/f2fs/hash.c
fs/f2fs/inline.c
fs/f2fs/inode.c
fs/f2fs/namei.c
fs/f2fs/node.c
fs/f2fs/node.h
fs/f2fs/recovery.c
fs/f2fs/segment.c
fs/f2fs/segment.h
fs/f2fs/shrinker.c
fs/f2fs/super.c
fs/f2fs/sysfs.c
fs/f2fs/trace.c
fs/f2fs/trace.h
fs/f2fs/xattr.c
fs/f2fs/xattr.h
include/linux/f2fs_fs.h
